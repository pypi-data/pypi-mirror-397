"use strict";(globalThis.webpackChunksuperset=globalThis.webpackChunksuperset||[]).push([[5926],{832:(e,t,o)=>{o.d(t,{c:()=>x,y:()=>S});var a=o(2404),n=o.n(a),i=o(2445),r=o(96540),s=o(67413),l=o(35942),c=o(14503),p=o(28027),d=o(50871),u=o(98456),g=o(48238),h=o(92123),f=o(51316),m=o(99894);const{getScale:v}=c;function y(e,t){const o=e.color_picker||{r:0,g:0,b:0,a:1},a=[o.r,o.g,o.b,255*o.a],n=e.color_scheme,i=v(n);let r={};return e.color_scheme_type===h.wP.color_breakpoints?r=(0,f.BK)(e.color_breakpoints):t.forEach((t=>{if(null!=t.cat_color&&!r.hasOwnProperty(t.cat_color)){let n;n=e.dimension?(0,d.hexToRGB)(i(t.cat_color,e.sliceId),255*o.a):a,r[t.cat_color]={color:n,enabled:!0}}})),r}const b=e=>{const t=(0,r.useRef)(null),o=(0,r.useCallback)((()=>{let t={...e.viewport};return e.formData.autozoom&&(t=(0,g.A)(t,{width:e.width,height:e.height,points:e.getPoints(e.payload.data.features||[])})),t.zoom<0&&(t.zoom=0),t}),[e]),[a,n]=(0,r.useState)(y(e.formData,e.payload.data.features||[])),[s,c]=(0,r.useState)(e.payload.form_data),[f,b]=(0,r.useState)(o());(0,r.useEffect)((()=>{if(e.payload.form_data!==s){const t=e.payload.data.features||[],a=y(e.formData,t);b(o()),c(e.payload.form_data),n(a)}}),[o,e,s]);const C=(0,r.useCallback)((e=>{const{current:o}=t;o&&o.setTooltip(e)}),[]),S=(0,r.useCallback)(((e,t,o)=>{const a=t.color_scheme,n=v(a);let i;switch(o){case h.wP.fixed_color:{i=t.color_picker||{r:0,g:0,b:0,a:100};const o=[i.r,i.g,i.b,255*i.a];return e.map((e=>({...e,color:o})))}case h.wP.categorical_palette:if(!t.dimension){const o=t.color_picker||{r:0,g:0,b:0,a:100},a=[o.r,o.g,o.b,255*o.a];return e.map((e=>({...e,color:a})))}return e.map((e=>({...e,color:(0,d.hexToRGB)(n(e.cat_color,t.slice_id))})));case h.wP.color_breakpoints:{const o=t.default_breakpoint_color?[t.default_breakpoint_color.r,t.default_breakpoint_color.g,t.default_breakpoint_color.b,255*t.default_breakpoint_color.a]:[m.DL.r,m.DL.g,m.DL.b,255*m.DL.a];return e.map((e=>{var a;const n=null==(a=t.color_breakpoints)?void 0:a.find((t=>e.metric>=t.minValue&&e.metric<=t.maxValue));if(n){const t=[n.color.r,n.color.g,n.color.b,255*n.color.a];return{...e,color:t}}return{...e,color:o}}))}default:return[]}}),[]),x=(0,r.useCallback)((()=>{const{getLayer:t,getHighlightLayer:o,payload:n,formData:i,onAddFilter:r,onContextMenu:s,filterState:l,setDataMask:c,emitCrossFilters:p}=e;let d=n.data.features?[...n.data.features]:[];const g=i.color_scheme_type;d=S(d,i,g),i.js_data_mutator&&(d=(0,u.A)(i.js_data_mutator)(d)),i.dimension&&(d=d.filter((e=>{var t;return null==(t=a[e.cat_color])?void 0:t.enabled})));const h={formData:i,payload:{...n,data:{...n.data,features:d}},onAddFilter:r,setTooltip:C,datasource:e.datasource,onContextMenu:s,filterState:l,setDataMask:c,emitCrossFilters:p},f=t(h);return p&&null!=l&&l.value&&o?[f,o(h)]:[f]}),[S,a,e,C]),_=(0,r.useCallback)((e=>{const t=a[e],o={...a,[e]:{...t,enabled:!t.enabled}};Object.values(o).every((e=>!e.enabled))&&Object.values(o).forEach((e=>{e.enabled=!0})),n(o)}),[a]),w=(0,r.useCallback)((e=>{const t={...a};Object.values(t).forEach((e=>{e.enabled=!1})),t[e].enabled=!0,n(t)}),[a]);return(0,i.FD)("div",{style:{position:"relative"},children:[(0,i.Y)(l.S,{ref:t,viewport:f,layers:x(),setControlValue:e.setControlValue,mapStyle:e.formData.mapbox_style,mapboxApiAccessToken:e.mapboxApiKey,width:e.width,height:e.height}),(0,i.Y)(p.A,{forceCategorical:!0,categories:a,format:e.formData.legend_format,position:e.formData.legend_position,showSingleCategory:w,toggleCategory:_})]})},C=(0,r.memo)(b);function S(e,t,o){return(0,r.memo)((a=>{const c=(0,r.useRef)(),d=(0,s.Z)(a.formData),u=(0,s.Z)(a.filterState),h=(0,s.Z)(a.payload),[m,v]=(0,r.useState)((0,f.BK)(a.formData.color_breakpoints)||[]),[y,b]=(0,r.useState)((()=>{const{width:e,height:o,formData:n}=a;return n.autozoom?(0,g.A)(a.viewport,{width:e,height:o,points:t(a.payload.data.features)}):a.viewport})()),C=(0,r.useCallback)((e=>{const{current:t}=c;t&&(null==t||t.setTooltip(e))}),[]),S=(0,r.useCallback)((t=>{const{formData:a,payload:n,onAddFilter:i,filterState:r,setDataMask:s,onContextMenu:l,emitCrossFilters:c}=t,p={formData:a,payload:n,onAddFilter:i,setTooltip:C,setDataMask:s,onContextMenu:l,filterState:r,emitCrossFilters:c},d=e(p);return c&&null!=r&&r.value&&o?[d,o(p)]:[d]}),[C]);(0,r.useEffect)((()=>{const e=(0,f.BK)(a.formData.color_breakpoints);v(e)}),[a]);const[x,_]=(0,r.useState)(S(a));(0,r.useEffect)((()=>{const e={...d,...u,viewport:null},t={...a.formData,...a.filterState,viewport:null};n()(e,t)&&h===a.payload||_(S(a))}),[S,d,u,h,a]);const{formData:w,payload:D,setControlValue:k,height:P,width:z}=a;return(0,i.FD)("div",{style:{position:"relative"},children:[(0,i.Y)(l.S,{ref:c,mapboxApiAccessToken:D.data.mapboxApiKey,viewport:y,layers:x,mapStyle:w.mapbox_style,setControlValue:k,width:z,height:P,onViewportChange:b}),(0,i.Y)(p.A,{forceCategorical:!0,categories:m,format:a.formData.legend_format,position:a.formData.legend_position})]})}))}function x(e,t,o){return function(a){const{datasource:n,formData:r,height:s,payload:l,setControlValue:c,viewport:p,width:d,setDataMask:u,filterState:g,onContextMenu:h,emitCrossFilters:f}=a;return(0,i.Y)(C,{datasource:n,formData:r,mapboxApiKey:l.data.mapboxApiKey,setControlValue:c,viewport:p,getLayer:e,getHighlightLayer:o,payload:l,getPoints:t,width:d,height:s,setDataMask:u,onContextMenu:h,filterState:g,emitCrossFilters:f})}}},28027:(e,t,o)=>{o.d(t,{A:()=>p});var a=o(2445),n=o(96540),i=o(50290),r=o(29898);const s=i.I4.div`
  ${({theme:e})=>`\n    font-size: ${e.fontSizeSM}px;\n    position: absolute;\n    background: ${e.colorBgElevated};\n    box-shadow: 0 0 ${e.sizeUnit}px ${e.colorBorderSecondary};\n    margin: ${6*e.sizeUnit}px;\n    padding: ${3*e.sizeUnit}px ${5*e.sizeUnit}px;\n    outline: none;\n    overflow-y: scroll;\n    max-height: 200px;\n\n    & ul {\n      list-style: none;\n      padding-left: 0;\n      margin: 0;\n\n      & li a {\n        display: flex;\n        color: ${e.colorText};\n        text-decoration: none;\n        padding: ${e.sizeUnit}px 0;\n\n        & span {\n          margin-right: ${e.sizeUnit}px;\n        }\n      }\n    }\n  `}
`,l=" - ",c=({format:e=null,forceCategorical:t=!1,position:o="tr",categories:n={},toggleCategory:i=()=>{},showSingleCategory:c=()=>{}})=>{const p=o=>{if(!e||t)return o;const a=parseFloat(o);return(0,r.ZV)(e,a)},d=t=>{if(!e)return t;if(t.includes(l)){const e=t.split(l);return p(e[0])+l+p(e[1])}return p(t)};if(0===Object.keys(n).length||null===o)return null;const u=Object.entries(n).map((([e,t])=>{var o;const n={color:`rgba(${null==(o=t.color)?void 0:o.join(", ")})`},r=t.enabled?"◼":"◻";return(0,a.Y)("li",{children:(0,a.FD)("a",{href:"#",role:"button",onClick:()=>i(e),onDoubleClick:()=>c(e),children:[(0,a.Y)("span",{style:n,children:r})," ",d(e)]})},e)})),g="t"===(null==o?void 0:o.charAt(0))?"top":"bottom",h="r"===(null==o?void 0:o.charAt(1))?"right":"left",f={position:"absolute",[g]:"0px",[h]:"10px"};return(0,a.Y)(s,{className:"dupa",style:f,children:(0,a.Y)("ul",{children:u})})},p=(0,n.memo)(c)},78579:(e,t,o)=>{o.d(t,{Pu:()=>r,QO:()=>a,Y5:()=>n,cp:()=>s});const a=[[255,255,178],[254,217,118],[254,178,76],[253,141,60],[240,59,32],[189,0,38]];function n(e,t=!1,o=Float32Array){let a;if(Number.isFinite(e[0]))a=new o(e);else{a=new o(4*e.length);let t=0;for(let o=0;o<e.length;o++){const n=e[o];a[t++]=n[0],a[t++]=n[1],a[t++]=n[2],a[t++]=Number.isFinite(n[3])?n[3]:255}}if(t)for(let e=0;e<a.length;e++)a[e]/=255;return a}const i={linear:"linear",quantile:"nearest",quantize:"nearest",ordinal:"nearest"};function r(e,t){e.setSampler({minFilter:i[t],magFilter:i[t]})}function s(e,t,o="linear"){const a=n(t,!1,Uint8Array);return e.createTexture({format:"rgba8unorm",mipmaps:!1,sampler:{minFilter:i[o],magFilter:i[o],addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"},data:a,width:a.length/4,height:1})}},85926:(e,t,o)=>{o.r(t),o.d(t,{default:()=>T,getLayer:()=>M,getPoints:()=>z});var a=o(2445),n=o(38706),i=o(23612),r=o(5855),s=o(53112),l=o(98413),c=o(25140),p=o(15473),d=o(82849),u=o(78579);const g={name:"screenGrid",vs:"uniform screenGridUniforms {\n  vec2 cellSizeClipspace;\n  vec2 gridSizeClipspace;\n  vec2 colorDomain;\n} screenGrid;\n",uniformTypes:{cellSizeClipspace:"vec2<f32>",gridSizeClipspace:"vec2<f32>",colorDomain:"vec2<f32>"}};class h extends p.A{getShaders(){return super.getShaders({vs:"#version 300 es\n#define SHADER_NAME screen-grid-layer-vertex-shader\n#define RANGE_COUNT 6\nin vec2 positions;\nin vec2 instancePositions;\nin float instanceWeights;\nin vec3 instancePickingColors;\nuniform sampler2D colorRange;\nout vec4 vColor;\nvec4 interp(float value, vec2 domain, sampler2D range) {\nfloat r = (value - domain.x) / (domain.y - domain.x);\nreturn texture(range, vec2(r, 0.5));\n}\nvoid main(void) {\nif (isnan(instanceWeights)) {\ngl_Position = vec4(0.);\nreturn;\n}\nvec2 pos = instancePositions * screenGrid.gridSizeClipspace + positions * screenGrid.cellSizeClipspace;\npos.x = pos.x - 1.0;\npos.y = 1.0 - pos.y;\ngl_Position = vec4(pos, 0., 1.);\nvColor = interp(instanceWeights, screenGrid.colorDomain, colorRange);\nvColor.a *= layer.opacity;\npicking_setPickingColor(instancePickingColors);\n}\n",fs:"#version 300 es\n#define SHADER_NAME screen-grid-layer-fragment-shader\nprecision highp float;\nin vec4 vColor;\nout vec4 fragColor;\nvoid main(void) {\nfragColor = vColor;\nDECKGL_FILTER_COLOR(fragColor, geometry);\n}\n",modules:[d.A,g]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:2,type:"float32",accessor:"getBin"},instanceWeights:{size:1,type:"float32",accessor:"getWeight"}}),this.state.model=this._getModel()}updateState(e){super.updateState(e);const{props:t,oldProps:o,changeFlags:a}=e,n=this.state.model;if(o.colorRange!==t.colorRange){var i;null==(i=this.state.colorTexture)||i.destroy(),this.state.colorTexture=(0,u.cp)(this.context.device,t.colorRange,t.colorScaleType);const e={colorRange:this.state.colorTexture};n.shaderInputs.setProps({screenGrid:e})}else o.colorScaleType!==t.colorScaleType&&(0,u.Pu)(this.state.colorTexture,t.colorScaleType);if(o.cellMarginPixels!==t.cellMarginPixels||o.cellSizePixels!==t.cellSizePixels||a.viewportChanged){const{width:e,height:t}=this.context.viewport,{cellSizePixels:o,cellMarginPixels:a}=this.props,i=Math.max(o-a,0),r={gridSizeClipspace:[o/e*2,o/t*2],cellSizeClipspace:[i/e*2,i/t*2]};n.shaderInputs.setProps({screenGrid:r})}}finalizeState(e){var t;super.finalizeState(e),null==(t=this.state.colorTexture)||t.destroy()}draw({uniforms:e}){const t=this.props.colorDomain(),o=this.state.model,a={colorDomain:t};o.shaderInputs.setProps({screenGrid:a}),o.draw(this.context.renderPass)}_getModel(){return new l.K(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new c.V({topology:"triangle-strip",attributes:{positions:{value:new Float32Array([0,0,1,0,0,1,1,1]),size:2}}}),isInstanced:!0})}}h.layerName="ScreenGridCellLayer";const f=h,m={name:"binOptions",vs:"uniform binOptionsUniforms {\n  float cellSizePixels;\n} binOptions;\n",uniformTypes:{cellSizePixels:"f32"}},v={cellSizePixels:{type:"number",value:100,min:1},cellMarginPixels:{type:"number",value:2,min:0},colorRange:u.QO,colorScaleType:"linear",getPosition:{type:"accessor",value:e=>e.position},getWeight:{type:"accessor",value:1},gpuAggregation:!0,aggregation:"SUM"};class y extends s.A{getAggregatorType(){return this.props.gpuAggregation&&i.V.isSupported(this.context.device)?"gpu":"cpu"}createAggregator(e){return"cpu"!==e&&i.V.isSupported(this.context.device)?new i.V(this.context.device,{dimensions:2,channelCount:1,bufferLayout:this.getAttributeManager().getBufferLayouts({isInstanced:!1}),...super.getShaders({modules:[n.A,m],vs:"\n  in vec3 positions;\n  in vec3 positions64Low;\n  in float counts;\n  \n  void getBin(out ivec2 binId) {\n    vec4 pos = project_position_to_clipspace(positions, positions64Low, vec3(0.0));\n    vec2 screenCoords = vec2(pos.x / pos.w + 1.0, 1.0 - pos.y / pos.w) / 2.0 * project.viewportSize / project.devicePixelRatio;\n    vec2 gridCoords = floor(screenCoords / binOptions.cellSizePixels);\n    binId = ivec2(gridCoords);\n  }\n  void getValue(out float weight) {\n    weight = counts;\n  }\n  "})}):new r.M({dimensions:2,getBin:{sources:["positions"],getValue:({positions:e},t,o)=>{const a=this.context.viewport,n=a.project(e),i=o.cellSizePixels;return n[0]<0||n[0]>=a.width||n[1]<0||n[1]>=a.height?null:[Math.floor(n[0]/i),Math.floor(n[1]/i)]}},getValue:[{sources:["counts"],getValue:({counts:e})=>e}]})}initializeState(){super.initializeState(),this.getAttributeManager().add({positions:{size:3,accessor:"getPosition",type:"float64",fp64:this.use64bitPositions()},counts:{size:1,accessor:"getWeight"}})}shouldUpdateState({changeFlags:e}){return e.somethingChanged}updateState(e){const t=super.updateState(e),{props:o,oldProps:a,changeFlags:n}=e,{cellSizePixels:r,aggregation:s}=o;if(t||n.dataChanged||n.updateTriggersChanged||n.viewportChanged||s!==a.aggregation||r!==a.cellSizePixels){const{width:e,height:t}=this.context.viewport,{aggregator:o}=this.state;o instanceof i.V&&o.setProps({binIdRange:[[0,Math.ceil(e/r)],[0,Math.ceil(t/r)]]}),o.setProps({pointCount:this.getNumInstances(),operations:[s],binOptions:{cellSizePixels:r}})}return n.viewportChanged&&this.state.aggregator.setNeedsUpdate(),t}onAttributeChange(e){const{aggregator:t}=this.state;switch(e){case"positions":t.setNeedsUpdate();break;case"counts":t.setNeedsUpdate(0)}}renderLayers(){const{aggregator:e}=this.state,t=this.getSubLayerClass("cells",f),o=e.getBins(),a=e.getResult(0);return new t(this.props,this.getSubLayerProps({id:"cell-layer"}),{data:{length:e.binCount,attributes:{getBin:o,getWeight:a}},dataComparator:(e,t)=>e.length===t.length,updateTriggers:{getBin:[o],getWeight:[a]},parameters:{depthWriteEnabled:!1,...this.props.parameters},colorDomain:()=>this.props.colorDomain||e.getResultDomain(0),extensions:[]})}getPickingInfo(e){const t=e.info,{index:o}=t;if(o>=0){const e=this.state.aggregator.getBin(o);let a;e&&(a={col:e.id[0],row:e.id[1],value:e.value[0],count:e.count},e.pointIndices&&(a.pointIndices=e.pointIndices,a.points=Array.isArray(this.props.data)?e.pointIndices.map((e=>this.props.data[e])):[])),t.object=a}return t}}y.layerName="ScreenGridLayer",y.defaultProps=v;const b=y;var C=o(74098),S=o(14503),x=o(92123),_=o(98456),w=o(83860),D=o(52480),k=o(832),P=o(51316);function z(e){return e.map((e=>e.position))}function A(e){var t,o,n;return(0,a.FD)("div",{className:"deckgl-tooltip",children:[(0,a.Y)(D.A,{label:(0,C.t)("Longitude and Latitude")+": ",value:`${null==e||null==(t=e.coordinate)?void 0:t[0]}, ${null==e||null==(o=e.coordinate)?void 0:o[1]}`}),(0,a.Y)(D.A,{label:(0,C.t)("Weight")+": ",value:`${null==(n=e.object)?void 0:n.value}`})]})}const M=function({formData:e,setDataMask:t,filterState:o,onContextMenu:a,payload:n,setTooltip:i,emitCrossFilters:r}){const s=e,l=s.color_scheme,c=S.getScale(l);let p=n.data.features;s.js_data_mutator&&(p=(0,_.A)(s.js_data_mutator)(p));const d=s.color_scheme_type,u=(0,w.XC)({defaultBreakpointsColor:s.deafult_breakpoint_color,colorBreakpoints:s.color_breakpoints,fixedColor:s.color_picker,colorSchemeType:d,colorScale:c});return new b({id:`screengrid-layer-${s.slice_id}`,data:p,cellSizePixels:s.grid_size,colorDomain:d===x.wP.color_breakpoints&&u?[0,u.length]:void 0,colorRange:"default"===d?[[255,255,178],[254,217,118],[254,178,76],[253,141,60],[240,59,32],[189,0,38]]:u,outline:!1,...(0,w.T$)({formData:s,setDataMask:t,setTooltip:i,setTooltipContent:A,filterState:o,onContextMenu:a,emitCrossFilters:r}),getWeight:e=>e.weight||0,colorScaleType:"default"===d?"linear":"quantize",opacity:null!=o&&o.value?.3:1})},T=(0,k.y)(M,z,(function({formData:e,filterState:t,payload:o}){const a=e;let n=o.data.features;a.js_data_mutator&&(n=(0,_.A)(a.js_data_mutator)(n));const i=n.filter((e=>(0,x.st)(e.position,null==t?void 0:t.value)));return new b({id:`screengrid-highlight-layer-${e.slice_id}`,data:i,cellSizePixels:e.grid_size,colorDomain:[0,1],colorRange:[P.LC,P.Fe],outline:!1,getWeight:e=>e.weight||0,colorScaleType:"quantize"})}))}}]);
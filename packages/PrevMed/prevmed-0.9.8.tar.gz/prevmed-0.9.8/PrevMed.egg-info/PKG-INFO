Metadata-Version: 2.4
Name: PrevMed
Version: 0.9.8
Summary: G√©n√©rateur dynamique de questionnaires cliniques avec interface Gradio et scoring automatis√© en R ou Python
Home-page: https://github.com/PrevMedOrg/PrevMed/
Keywords: prevention,preventive,medical,care,health,formulaires,surveys,clinical,clinique,APHP,AP-HP,hopital,hospital,healthcare,patients
Classifier: Programming Language :: Python :: 3
Classifier: Operating System :: OS Independent
Requires-Python: ==3.13
Description-Content-Type: text/markdown
License-File: LICENSE
Requires-Dist: reportlab==4.4.4
Requires-Dist: gradio==5.49.1
Requires-Dist: loguru==0.7.3
Requires-Dist: pyr2==2.0.0
Requires-Dist: pyyaml==6.0.3
Requires-Dist: rpy2[all]==3.6.4
Requires-Dist: filelock==3.20.0
Dynamic: classifier
Dynamic: description
Dynamic: description-content-type
Dynamic: home-page
Dynamic: keywords
Dynamic: license-file
Dynamic: requires-dist
Dynamic: requires-python
Dynamic: summary

# PrevMed (Pr√©vention M√©dicale)

**Plateforme minimaliste permettant √† des personnes non techniques de produire des questionnaires cliniques ne stockant aucune information personnelle.**

> üìñ **English version available:** See [README_english.md](https://github.com/PrevMedOrg/PrevMed/blob/main/README_english.md) for the English documentation.

## Table des mati√®res

- [Objectif Principal](#objectif-principal)
- [Description Technique](#description-technique)
- [Installation](#installation)
  - [Pr√©requis](#pr√©requis)
  - [Installation des d√©pendances](#installation-des-d√©pendances)
  - [D√©ploiement avec Docker](#d√©ploiement-avec-docker)
- [Utilisation](#utilisation)
  - [Lancement basique](#lancement-basique)
  - [Exemple avec PREMM5](#exemple-avec-premm5)
  - [Options de ligne de commande](#options-de-ligne-de-commande)
- [Analytics (Optionnel)](#analytics-optionnel)
  - [Configuration](#configuration)
- [Configuration du questionnaire (YAML)](#configuration-du-questionnaire-yaml)
  - [Types de widgets disponibles](#types-de-widgets-disponibles)
  - [Logique conditionnelle](#logique-conditionnelle)
- [Scripts de scoring](#scripts-de-scoring)
  - [Script R](#script-r)
  - [Script Python](#script-python)
- [G√©n√©ration de rapports PDF](#g√©n√©ration-de-rapports-pdf)
  - [Gestion des fichiers temporaires](#gestion-des-fichiers-temporaires)
- [Stockage des donn√©es structur√©es (si activ√©)](#stockage-des-donn√©es-structur√©es-si-activ√©)
  - [Fichiers JSON compress√©s (si `--save-user-data` activ√©)](#fichiers-json-compress√©s-si---save-user-data-activ√©)
  - [Logs CSV (si `--save-user-data` activ√©)](#logs-csv-si---save-user-data-activ√©)
- [Structure du projet](#structure-du-projet)
- [Logs](#logs)
- [Exemple PREMM5](#exemple-premm5)
- [D√©veloppement](#d√©veloppement)
  - [Conventions de code](#conventions-de-code)
  - [Contributions](#contributions)
- [Licence](#licence)
- [R√©f√©rences](#r√©f√©rences)

## Objectif Principal

PrevMed est con√ßu pour **simplifier le workflow clinique** en permettant aux professionnels de sant√© de cr√©er facilement des questionnaires d'aide √† la d√©cision clinique avec des comp√©tences courantes en programmation : un script en langage [R](https://en.wikipedia.org/wiki/R_%28programming_language%29) (ou [Python](https://en.wikipedia.org/wiki/Python_(programming_language))) et un fichier `.yaml`.

**Fonctionnement :**
1. Le patient remplit le questionnaire sur l'interface web
2. Un PDF avec les r√©ponses et r√©sultats est g√©n√©r√© instantan√©ment
3. Le patient vient en consultation avec ce PDF
4. **Aucune donn√©e personnelle n'est stock√©e** sur le serveur

Ce syst√®me fait **gagner du temps √† tout le monde** : le patient pr√©pare ses r√©ponses en amont, et le clinicien dispose imm√©diatement d'informations structur√©es et de scores calcul√©s automatiquement.

## Description Technique

PrevMed permet de cr√©er des questionnaires cliniques interactifs √† partir de fichiers de configuration YAML. Le syst√®me g√©n√®re automatiquement une interface web avec Gradio, g√®re la logique conditionnelle des questions, ex√©cute des scripts de scoring (R ou Python), et produit des rapports PDF.

**Caract√©ristiques principales :**

- ‚ú® Configuration d√©clarative via YAML
- üîÄ Questions conditionnelles (affichage dynamique bas√© sur les r√©ponses pr√©c√©dentes)
- üìä Support de scripts de scoring en R (via rpy2) ou Python
- üñ•Ô∏è Interface web intuitive avec Gradio
- üìÑ G√©n√©ration automatique de rapports PDF
- üìù Logging d√©taill√© avec loguru
- üéØ Type hints et documentation NumPy style

## Installation

### Pr√©requis

- Python, arbitrairement fix√© √† 3.13.5 pour sa vitesse sans √™tre aussi r√©cent que 3.14.
- R et rpy2 si vous utilisez des scripts de scoring en R. Sur ubuntu il suffit de `sudo apt install r-base`.
- Sur ubuntu 22.04, vous pouvez avoir besoin de `sudo apt-get install libtirpc-dev` ([source](https://github.com/rpy2/rpy2/issues/1106#issuecomment-2118710471))

### Installation des d√©pendances

Apr√®s avoir t√©l√©charg√© le repo, commencez par cr√©er un venv:

```bash
uv venv
source .venv/bin/activate
```

```bash
uv pip install .
```

**Note :** Sur certains syst√®mes, vous devrez peut-√™tre installer R s√©par√©ment avant d'installer rpy2.

### D√©ploiement avec Docker

PrevMed peut √™tre d√©ploy√© avec Docker pour une installation simplifi√©e et isol√©e :

```bash
# Cloner le repository
git clone https://github.com/PrevMedOrg/PrevMed
cd PrevMed

# Acc√©der au r√©pertoire docker
cd docker

# Modifier docker-compose.yml pour sp√©cifier les arguments souhait√©s dans la section 'command'
# Par exemple: --survey-yaml, --scoring-script, --save-user-data, etc.

# Lancer le conteneur en arri√®re-plan
sudo docker compose up --build -d
```

**Gestion des volumes :**
- Les dossiers `logs/` et `survey_data/` sont **mont√©s comme volumes** pour persister les donn√©es entre red√©marrages
- Le dossier `temp_pdfs/` n'est **pas mont√©** pour garantir qu'il reste non-persistant et respecte la vie priv√©e

Cette configuration permet de b√©n√©ficier de l'isolation Docker tout en conservant les logs et donn√©es importantes, sans compromettre la nature temporaire des PDFs.

## Utilisation

### Lancement basique

```bash
prevmed --survey-yaml <chemin_yaml> --scoring-script <chemin_script>
```

### Exemple avec PREMM5

Le projet inclut un exemple complet du questionnaire PREMM5 (√©valuation du risque de syndrome de Lynch) :

```bash
prevmed --survey-yaml examples/PREMM5/premm5.yaml --scoring-script examples/PREMM5/premm5.R
```

Ceci lancera une interface Gradio accessible via votre navigateur web.

### Options de ligne de commande

PrevMed supporte plusieurs options pour personnaliser le comportement de l'application :

#### Sauvegarde des donn√©es utilisateur

Par d√©faut, **aucune donn√©e utilisateur n'est sauvegard√©e**. Les rapports PDF g√©n√©r√©s sont cr√©√©s comme **fichiers temporaires** uniquement pour le t√©l√©chargement par le patient, sans logging des r√©ponses ou des r√©sultats.

Pour **sauvegarder les donn√©es utilisateur de mani√®re permanente** (dans le r√©pertoire `survey_data/`), utilisez l'option `--save-user-data` :

```bash
prevmed --survey-yaml examples/PREMM5/premm5.yaml \
              --scoring-script examples/PREMM5/premm5.R \
              --save-user-data
```

**Avec `--save-user-data` activ√©, les donn√©es suivantes sont sauvegard√©es :**
- Fichiers JSON compress√©s (`.json.gz`) contenant toutes les r√©ponses et r√©sultats
- Logs CSV centralis√©s pour analyse rapide
- Rapports PDF stock√©s de mani√®re permanente

**Sans cette option (comportement par d√©faut) :**
- Seuls des PDFs temporaires sont cr√©√©s pour le t√©l√©chargement
- Aucune donn√©e n'est logg√©e dans les fichiers CSV
- Aucun fichier JSON n'est sauvegard√©
- Respect maximal de la vie priv√©e des patients

#### Autres options utiles

```bash
# Ouvrir automatiquement le navigateur au d√©marrage
prevmed --survey-yaml <yaml> --scoring-script <script> --open-browser

# Utiliser un port personnalis√© (par d√©faut: 7860)
prevmed --survey-yaml <yaml> --scoring-script <script> --port 8080

# Activer le logging de niveau debug dans la console
prevmed --survey-yaml <yaml> --scoring-script <script> --debug

# Sp√©cifier l'URL r√©elle o√π le questionnaire est h√©berg√© (appara√Ætra dans les PDFs)
prevmed --survey-yaml <yaml> --scoring-script <script> --actual-url "https://survey.hopital.fr/premm5"
```

#### Arguments suppl√©mentaires pour demo.launch()

PrevMed permet de passer **n'importe quel argument support√© par Gradio** directement √† `demo.launch()`. Tous les arguments non reconnus par PrevMed sont automatiquement transmis √† Gradio.

**Formats support√©s :**

```bash
# Arguments avec valeur (cha√Æne, int, float)
prevmed --survey-yaml <yaml> --scoring-script <script> --gradio-option value

# Drapeaux bool√©ens (True)
prevmed --survey-yaml <yaml> --scoring-script <script> --enable-feature

# Drapeaux bool√©ens (False)
prevmed --survey-yaml <yaml> --scoring-script <script> --no-disable-feature
```

**Exemples pratiques :**

```bash
# D√©sactiver la fermeture automatique du serveur apr√®s inactivit√©
prevmed --survey-yaml <yaml> --scoring-script <script> --prevent-thread-lock

# Activer le mode favicon personnalis√©
prevmed --survey-yaml <yaml> --scoring-script <script> --favicon-path /path/to/favicon.ico

# Combiner plusieurs arguments
prevmed --survey-yaml <yaml> --scoring-script <script> \
    --max-file-size 10000000 \
    --allowed-paths /data /images \
    --no-show-error
```

**Note :** Consultez la [documentation Gradio Blocks](https://www.gradio.app/docs/gradio/blocks) pour la liste compl√®te des arguments support√©s par `demo.launch()`.

#### Options de performance

PrevMed inclut des options pour optimiser les performances sous charge importante :

```bash
# Augmenter le nombre maximum de threads (par d√©faut: 40)
prevmed --survey-yaml <yaml> --scoring-script <script> --max-threads 100

# D√©sactiver la file d'attente des requ√™tes (activ√©e par d√©faut)
prevmed --survey-yaml <yaml> --scoring-script <script> --no-queue
```

**Note :** La file d'attente (`queue`) est **activ√©e par d√©faut** car elle am√©liore les performances sous charge. Pour plus d'informations sur l'optimisation des performances de Gradio, consultez le guide officiel : [Setting Up a Demo for Maximum Performance](https://www.gradio.app/guides/setting-up-a-demo-for-maximum-performance).

## Analytics (Optionnel)

PrevMed supporte l'int√©gration de [Umami](https://umami.is/), une solution d'analytics respectueuse de la vie priv√©e, self-hostable, open-source, respectant le RGPD et avec une option gratuite.

### Configuration

Pour activer l'analytics, utilisez les arguments de ligne de commande `--umami-website-id` et optionnellement `--umami-url` :

```bash
# Option 1: Utiliser le service cloud gratuit Umami (cloud.umami.is)
prevmed --survey-yaml examples/PREMM5/premm5.yaml \
              --scoring-script examples/PREMM5/premm5.R \
              --umami-website-id "votre-website-id"

# Option 2: Utiliser votre propre instance Umami auto-h√©berg√©e
prevmed --survey-yaml examples/PREMM5/premm5.yaml \
              --scoring-script examples/PREMM5/premm5.R \
              --umami-url "https://votre-instance.example.com" \
              --umami-website-id "votre-website-id"
```

**Exemple complet :**

```bash
# Avec cloud.umami.is (gratuit)
prevmed --survey-yaml examples/PREMM5/premm5.yaml \
              --scoring-script examples/PREMM5/premm5.R \
              --umami-website-id "70991a3f-4cc9-49ae-a848-867bc75a1fd1"

# Avec instance auto-h√©berg√©e
prevmed --survey-yaml examples/PREMM5/premm5.yaml \
              --scoring-script examples/PREMM5/premm5.R \
              --umami-url "https://analytics.monhopital.fr" \
              --umami-website-id "70991a3f-4cc9-49ae-a848-867bc75a1fd1"
```

**Note :** Si aucun argument analytics n'est fourni, l'application fonctionne sans analytics.

## Configuration du questionnaire (YAML)

Les questionnaires sont d√©finis dans des fichiers YAML avec la structure suivante :

```yaml
survey_name: Nom du questionnaire

# Uniquement pour √™tre mentionn√©e dans les logs etc:
survey_version: 1.0.0
PrevMed_version: 1.0.0

# Optionnel: texte d'en-t√™te affich√© en haut du questionnaire (format Markdown)
header: |
  ## √Ä propos de ce questionnaire

  Description du questionnaire...

questions:
  - variable: nom_variable
    order: 1
    widget: Radio|Number|Checkbox|Textbox
    widget_args:
      # Arguments sp√©cifiques au widget
      choices: ["Option1", "Option2"]  # Pour Radio
      precision: 0  # Pour Number
      step: 1  # Pour Slider
      label: "Texte du widget"          # Optionnel: par d√©faut utilise question
    question: "Texte de la question"
    skip_if: "(nom_variable == 2) and (nom_variable > autre_variable)"  # Si l'expression vaut True alors la question n'est pas pos√©e (l'expression doit √™tre en Python et a acc√®s aux variables du reste du script.)
```


### Types de widgets disponibles

Par principe, PrevMed devrait marcher avec n'importe quel widget Gradio. La liste des widgets Gradio est disponible [ici](https://www.gradio.app/docs/gradio). Les widgets suivants sont les plus utilis√©s:

- **Radio** : Boutons radio pour choix unique
  - `choices` : Liste des options (requis)
- **Number** : Champ num√©rique avec contr√¥les
- **Checkbox** : Case √† cocher bool√©enne
- **Textbox** : Champ texte libre

### Logique conditionnelle

PrevMed supporte deux types de logique conditionnelle :

#### 1. Affichage conditionnel des questions (`skip_if`)

Les questions peuvent √™tre affich√©es ou masqu√©es dynamiquement via le champ `skip_if`. Les conditions sont des expressions Python √©valu√©es avec les valeurs des variables pr√©c√©dentes :

```yaml
- variable: age_diagnostic
  skip_if: "not (diagnostic_positif == True)"
  # Cette question ne s'affiche que si diagnostic_positif n'est pas True

- variable: age_crc_proband
  skip_if: "personal_crc_count == 0"
  # Cette question est ignor√©e si le patient n'a aucun cancer colorectal
```

**Points importants :**
- L'expression retourne `True` ‚Üí la question est **ignor√©e**
- L'expression retourne `False` ‚Üí la question est **affich√©e**
- Les expressions peuvent utiliser toutes les variables des questions pr√©c√©dentes
- Les op√©rateurs Python standards sont support√©s (`==`, `!=`, `>`, `<`, `and`, `or`, `not`, etc.)

#### 2. Validation des r√©ponses (`valid_if`)

Les r√©ponses peuvent √™tre valid√©es avant de passer √† la question suivante via le champ `valid_if`. Si la validation √©choue, un message d'erreur est affich√© et l'utilisateur doit corriger sa r√©ponse :

```yaml
- variable: current_age
  widget: Number
  question: "√Çge actuel du patient (en ann√©es)"
  valid_if: "current_age >= 15 and current_age <= 120"
  invalid_message: "L'√¢ge doit √™tre compris entre 15 et 120 ans."

- variable: personal_crc_count
  widget: Number
  question: "Combien de cancers colorectaux ?"
  valid_if: "personal_crc_count >= 0"
  invalid_message: "Le nombre de cancers ne peut pas √™tre n√©gatif."
```

**Points importants :**
- L'expression retourne `True` ‚Üí la r√©ponse est **valide**, on peut continuer
- L'expression retourne `False` ‚Üí la r√©ponse est **invalide**, un avertissement est affich√©
- Le champ `invalid_message` (optionnel) permet de personnaliser le message d'erreur
- Si `invalid_message` n'est pas fourni, un message par d√©faut est utilis√©
- La validation s'ex√©cute avant de passer √† la question suivante

## Scripts de scoring

### Script R

Le script R doit d√©finir une fonction `scoring()` qui prend les variables du questionnaire comme arguments nomm√©s et retourne une liste avec **3 √©l√©ments** :

1. Une cha√Æne de caract√®res contenant du **markdown** √† afficher au patient
2. Une liste de listes repr√©sentant une **table** (premi√®re liste = headers, suivantes = lignes de donn√©es)
3. Une liste nomm√©e avec les **options PDF** (`include_md_in_pdf` et `include_data_in_pdf`)

```r
scoring <- function(variable1, variable2 = NULL, ...) {
  # Logique de calcul
  score_total <- 0.40
  
  # G√©n√©rer le texte markdown √† afficher
  markdown_result <- sprintf("## R√©sultats\n\nVotre score total est: %.1f%%", score_total * 100)
  
  # Cr√©er la table de donn√©es (format: liste de listes)
  # Premi√®re liste = headers, suivantes = lignes de donn√©es
  table_data <- list(
    c("Cat√©gorie", "Probabilit√©"),  # Headers
    c("Cat√©gorie 1", sprintf("%.2f%%", 0.15 * 100)),
    c("Cat√©gorie 2", sprintf("%.2f%%", 0.25 * 100)),
    c("Total", sprintf("%.2f%%", 0.40 * 100))
  )
  
  # Options de g√©n√©ration PDF
  pdf_options <- list(
    include_md_in_pdf = TRUE,    # Inclure le markdown dans le PDF
    include_data_in_pdf = TRUE   # Inclure la table de donn√©es dans le PDF
  )
  
  # Retourner une liste avec 3 √©l√©ments
  list(
    markdown_result,  # √âl√©ment 1: texte markdown
    table_data,       # √âl√©ment 2: table de donn√©es
    pdf_options       # √âl√©ment 3: options PDF
  )
}
```

**Points importants :**
- Les param√®tres conditionnels doivent avoir `= NULL` comme valeur par d√©faut
- Retourner une **liste avec 3 √©l√©ments** : markdown, table_data, pdf_options
- Le **premier √©l√©ment** est une cha√Æne markdown affich√©e au patient
- Le **deuxi√®me √©l√©ment** est une liste de listes o√π la premi√®re liste contient les headers et les suivantes les lignes de donn√©es
- Le **troisi√®me √©l√©ment** contr√¥le ce qui est inclus dans le PDF (markdown et/ou table)
- Les noms de param√®tres doivent correspondre aux noms de variables du YAML

### Script Python

Le script Python doit d√©finir une fonction `scoring()` qui retourne un **tuple avec 3 √©l√©ments** :

1. Une cha√Æne contenant du **markdown** √† afficher au patient
2. Une liste de listes repr√©sentant une **table** (premi√®re liste = headers, suivantes = lignes de donn√©es)
3. Un dictionnaire avec les **options PDF** (`include_md_in_pdf` et `include_data_in_pdf`)

```python
def scoring(variable1: str, variable2: int = None, **kwargs) -> tuple[str, list[list[str]], dict[str, bool]]:
    """Calcul du score."""
    # Logique de calcul
    score_total = 0.40
    
    # G√©n√©rer le texte markdown √† afficher
    markdown_result = f"## R√©sultats\n\nVotre score total est: {score_total * 100:.1f}%"
    
    # Cr√©er la table de donn√©es (format: liste de listes)
    # Premi√®re liste = headers, suivantes = lignes de donn√©es
    table_data = [
        ["Cat√©gorie", "Probabilit√©"],  # Headers
        ["Cat√©gorie 1", f"{0.15 * 100:.2f}%"],
        ["Cat√©gorie 2", f"{0.25 * 100:.2f}%"],
        ["Total", f"{0.40 * 100:.2f}%"]
    ]
    
    # Options de g√©n√©ration PDF
    pdf_options = {
        "include_md_in_pdf": True,    # Inclure le markdown dans le PDF
        "include_data_in_pdf": True   # Inclure la table de donn√©es dans le PDF
    }
    
    # Retourner un tuple avec 3 √©l√©ments
    return (markdown_result, table_data, pdf_options)
```

**Points importants :**
- Retourner un **tuple avec 3 √©l√©ments** : markdown, table_data, pdf_options
- Le **premier √©l√©ment** est une cha√Æne markdown affich√©e au patient
- Le **deuxi√®me √©l√©ment** est une liste de listes o√π la premi√®re liste contient les headers et les suivantes les lignes de donn√©es
- Le **troisi√®me √©l√©ment** contr√¥le ce qui est inclus dans le PDF (markdown et/ou table)
- Les valeurs de la table peuvent √™tre de n'importe quel type (elles seront converties en cha√Ænes automatiquement)
- Les noms de param√®tres doivent correspondre aux noms de variables du YAML

## G√©n√©ration de rapports PDF

Les rapports PDF sont g√©n√©r√©s automatiquement √† la fin du questionnaire et incluent :

- Nom et version du questionnaire
- Code de r√©f√©rence unique (format XXX-YYY, facile √† m√©moriser)
- Horodatage de g√©n√©ration
- R√©sultats du scoring (texte format√© + tableau structur√©)
- Toutes les r√©ponses aux questions

### Gestion des fichiers temporaires

**Stockage des PDFs :**
- **Par d√©faut** : fichiers temporaires stock√©s dans `temp_pdfs/` uniquement pour t√©l√©chargement (non sauvegard√©s de mani√®re permanente)
- **Avec `--save-user-data`** : sauvegarde permanente dans `survey_data/` en plus du PDF temporaire

**Nettoyage automatique :**

Pour √©viter l'accumulation de fichiers temporaires, PrevMed impl√©mente un syst√®me de nettoyage automatique multi-niveaux :

- **Au d√©marrage de l'application** : le r√©pertoire `temp_pdfs/` est int√©gralement supprim√© s'il existe
- **Avant chaque g√©n√©ration de PDF** : tous les fichiers du r√©pertoire `temp_pdfs/` **plus anciens qu'1 heure** sont automatiquement supprim√©s
- **√Ä l'arr√™t de l'application** : le r√©pertoire `temp_pdfs/` est int√©gralement supprim√©
- Ce nettoyage multi-niveaux garantit qu'aucun fichier temporaire ne reste ind√©finiment sur le serveur
- Le r√©pertoire `temp_pdfs/` est cr√©√© automatiquement au premier besoin
- M√™me sous charge √©lev√©e, le syst√®me maintient un r√©pertoire propre et performant

**Exemple de cycle de vie d'un PDF temporaire :**

1. Patient compl√®te le questionnaire √† 14h00
2. PDF g√©n√©r√© dans `temp_pdfs/survey_ABC-XYZ_1729500000.pdf`
3. Patient t√©l√©charge le PDF imm√©diatement
4. √Ä 15h30, un autre patient g√©n√®re son PDF
5. Le syst√®me nettoie automatiquement tous les PDFs cr√©√©s avant 14h30 (plus d'1h)
6. Le PDF de 14h00 est supprim√© automatiquement, lib√©rant l'espace disque

Cette approche assure **z√©ro maintenance manuelle** tout en respectant la vie priv√©e des patients.

## Stockage des donn√©es structur√©es (si activ√©)

Lorsque l'option `--save-user-data` est activ√©e, PrevMed sauvegarde toutes les donn√©es sous deux formats compl√©mentaires :

### Fichiers JSON compress√©s (si `--save-user-data` activ√©)

Avec `--save-user-data`, chaque soumission est sauvegard√©e en JSON compress√© (`.json.gz`) dans `survey_data/` avec :
- Nom du questionnaire et versions
- R√©ponses compl√®tes
- R√©sultats de scoring
- Code de r√©f√©rence unique
- Timestamp Unix
- Hashes de client (pour d√©tection de doublons anonyme)

**Format du nom de fichier :** `{timestamp}_{reference_code}.json.gz`

**Exemple :** `1729500000_A2B-3C4.json.gz`

### Logs CSV (si `--save-user-data` activ√©)

Avec `--save-user-data`, un **fichier CSV centralis√©** enregistre toutes les soumissions pour analyse rapide :

**Emplacement :** `survey_data/csv/{PrevMed_version}/{survey_name}_{survey_version}/survey_submissions.csv`

**Exemple :** `survey_data/csv/0.8.0/PREMM5_2.0/survey_submissions.csv`

#### Caract√©ristiques du syst√®me CSV

**Structure des colonnes :**
- Colonnes fixes : `reference_code`, `row_number`, `timestamp_unix`, `datetime`
- Colonnes de scoring : une par r√©sultat (ex: `p_MLH1`, `p_MSH2`, format√©es en pourcentages)
- Colonnes de hashes : `answers_hash` + hashes individuels par attribut client (ex: `user_agent_hash`, `ip_address_hash`)

**Gestion de la concurrence :**
- Utilise `filelock` pour garantir l'atomicit√© des √©critures
- Supporte l'acc√®s concurrent depuis plusieurs processus/serveurs
- Timeout de 10 secondes sur le verrou

**Rotation automatique :**
- Le CSV est automatiquement archiv√© apr√®s 1000 lignes
- Fichier archiv√© : `survey_submissions_{timestamp}.csv` (sauvegarde permanente)
- Nouveau CSV cr√©√© automatiquement pour continuer l'enregistrement
- **Objectif :** maintenir des performances √©lev√©es m√™me avec acc√®s concurrent intensif

**Gestion des erreurs :**
- En cas de timeout du verrou (charge tr√®s √©lev√©e), les donn√©es sont sauvegard√©es dans un fichier de secours
- Format : `survey_submissions_fallback_{timestamp}_{random}.csv`
- **Garantie :** aucune perte de donn√©es m√™me sous charge extr√™me

**D√©tection de doublons :**
- `answers_hash` : hash court (12 caract√®res) des r√©ponses uniquement
- Hashes individuels de client : chaque attribut (user-agent, IP, etc.) hach√© s√©par√©ment avec le code de r√©f√©rence comme sel
- Permet l'analyse de doublons tout en pr√©servant la vie priv√©e

**Exemple de contenu CSV :**

```csv
reference_code,row_number,timestamp_unix,datetime,p_MLH1,p_MSH2,p_MSH6,p_PMS2,p_total,answers_hash,user_agent_hash,ip_address_hash,session_hash_hash
A2B-3C4,1,1729500000,2024-10-21 14:20:00,15.23,25.47,8.92,10.38,60.00,a1b2c3d4e5f6,x9y8z7w6v5u4,q1w2e3r4t5y6,m1n2b3v4c5x6
D5E-6F7,2,1729500120,2024-10-21 14:22:00,2.15,3.28,1.45,1.12,8.00,f6e5d4c3b2a1,u4v5w6z7y8x9,y6t5r4e3w2q1,x6c5v4b3n2m1
```

**Avantages de cette architecture :**
- **Performance** : rotation limite la taille des fichiers pour maintenir vitesse d'acc√®s
- **Fiabilit√©** : syst√®me de fallback garantit z√©ro perte de donn√©es
- **Tra√ßabilit√©** : archivage automatique avec timestamps
- **Analyse** : format CSV facilite l'analyse statistique rapide
- **Scalabilit√©** : gestion de concurrence permet d√©ploiement multi-processus/multi-serveurs
- **Vie priv√©e** : hashes sal√©s permettent d√©tection de doublons sans stocker donn√©es personnelles brutes

## Structure du projet

```
PrevMed/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py          # Setup du logging
‚îÇ   ‚îú‚îÄ‚îÄ __main__.py          # Point d'entr√©e CLI
‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ       ‚îú‚îÄ‚îÄ gui.py           # Interface Gradio
‚îÇ       ‚îú‚îÄ‚îÄ css.py           # Le CSS utilis√© dans Gradio
‚îÇ       ‚îú‚îÄ‚îÄ js.py            # Le js utilis√© dans Gradio
‚îÇ       ‚îú‚îÄ‚îÄ io.py            # Chargement YAML et scripts
‚îÇ       ‚îú‚îÄ‚îÄ logic.py         # Logique conditionnelle
‚îÇ       ‚îú‚îÄ‚îÄ pdf.py           # G√©n√©ration PDF
‚îÇ       ‚îú‚îÄ‚îÄ scoring.py       # Ex√©cution scripts R/Python
‚îÇ       ‚îî‚îÄ‚îÄ settings.py      # Stocke des variables disponibles dans tout le script
‚îú‚îÄ‚îÄ examples/
‚îÇ   ‚îî‚îÄ‚îÄ PREMM5/
‚îÇ       ‚îú‚îÄ‚îÄ premm5.yaml      # Configuration PREMM5
‚îÇ       ‚îî‚îÄ‚îÄ premm5.R         # Script de scoring PREMM5
‚îú‚îÄ‚îÄ logs/                    # Logs rotatifs (cr√©√© automatiquement)
‚îú‚îÄ‚îÄ survey_pdfs/             # Rapports PDF (cr√©√© automatiquement)
‚îú‚îÄ‚îÄ requirements.txt
‚îî‚îÄ‚îÄ setup.py
```

## Logs

Les logs sont automatiquement sauvegard√©s dans `./logs/` avec rotation journali√®re et r√©tention de 365 jours. Le format inclut :

- Horodatage avec millisecondes
- Niveau de log
- Fichier, fonction et ligne
- Message

## Exemple PREMM5

Le questionnaire PREMM5 √©value le risque de mutations dans les g√®nes MLH1, MSH2, MSH6 et PMS2 (syndrome de Lynch) bas√© sur :

- L'histoire personnelle de cancers (colorectal, endom√®tre, autres)
- Les √¢ges au diagnostic
- L'histoire familiale (apparent√©s du 1er et 2√®me degr√©)

Le scoring utilise un mod√®le de r√©gression logistique multinomiale avec transformation softmax pour calculer les probabilit√©s de mutation pour chaque g√®ne.

## D√©veloppement

### Conventions de code

- Type hints et docstrings NumPy style partout
- Commentaires explicites pour les d√©cisions de design
- Utilisation de `loguru` pour le logging
- Code simple et robuste privil√©gi√©
- Utilisation de [Ruff](https://astral.sh/ruff) comme linter pour assurer la qualit√© du code

### Contributions

Ce projet a √©t√© d√©velopp√© avec l'assistance de [aider.chat](https://github.com/Aider-AI/aider/).

**Nous accueillons volontiers :**
- üêõ Les signalements de bugs via les [Issues](https://github.com/PrevMedOrg/PrevMed/issues)
- ‚ú® Les demandes de fonctionnalit√©s
- üîß Les Pull Requests pour am√©liorer le projet

N'h√©sitez pas √† contribuer !

## Licence

Actuellement sous licence AGPL-v3. Cependant, nous sommes flexibles et ouverts √† des arrangements de licence alternatifs - n'h√©sitez pas √† nous contacter si vous avez besoin d'une licence diff√©rente pour votre cas d'usage.

## R√©f√©rences

Pour PREMM5 :
- Kastrinos F, et al. "Development and Validation of the PREMM5 Model for Comprehensive Risk Assessment of Lynch Syndrome." J Clin Oncol. 2017.

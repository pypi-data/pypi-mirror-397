"""phase11 fields

Revision ID: 2a6413d60daa
Revises: ef8829faa761
Create Date: 2025-11-29 16:19:12.413723

"""

from collections.abc import Sequence

import sqlalchemy as sa
from alembic import op
from sqlalchemy.dialects import sqlite

# revision identifiers, used by Alembic.
revision: str = "2a6413d60daa"
down_revision: str | Sequence[str] | None = "ef8829faa761"
branch_labels: str | Sequence[str] | None = None
depends_on: str | Sequence[str] | None = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table("admin_actions", schema=None) as batch_op:
        batch_op.alter_column(
            "success",
            existing_type=sa.BOOLEAN(),
            type_=sa.Integer(),
            existing_nullable=False,
            existing_server_default=sa.text("'1'"),
        )
        batch_op.drop_index("ix_admin_actions_admin_id")

    with op.batch_alter_table("areas", schema=None) as batch_op:
        batch_op.alter_column(
            "time_phases", existing_type=sqlite.JSON(), nullable=False
        )
        batch_op.alter_column(
            "entry_points", existing_type=sqlite.JSON(), nullable=False
        )

    with op.batch_alter_table("clan_members", schema=None) as batch_op:
        batch_op.add_column(sa.Column("extra_data", sa.JSON(), nullable=True))
        batch_op.drop_constraint("uq_clan_members_clan_player", type_="unique")

    with op.batch_alter_table("clans", schema=None) as batch_op:
        batch_op.drop_constraint("uq_clans_name", type_="unique")

    with op.batch_alter_table("factions", schema=None) as batch_op:
        batch_op.drop_constraint("uq_factions_name", type_="unique")

    with op.batch_alter_table("item_instances", schema=None) as batch_op:
        batch_op.drop_column("dropped_at")
        batch_op.drop_column("decay_minutes")

    with op.batch_alter_table("item_templates", schema=None) as batch_op:
        batch_op.alter_column(
            "provides_light",
            existing_type=sa.BOOLEAN(),
            type_=sa.Integer(),
            existing_nullable=False,
            existing_server_default=sa.text("'0'"),
        )

    with op.batch_alter_table("npc_state", schema=None) as batch_op:
        batch_op.alter_column(
            "is_alive",
            existing_type=sa.BOOLEAN(),
            type_=sa.Integer(),
            existing_nullable=False,
            existing_server_default=sa.text("'1'"),
        )
        batch_op.alter_column(
            "instance_data", existing_type=sqlite.JSON(), nullable=False
        )

    with op.batch_alter_table("npc_templates", schema=None) as batch_op:
        batch_op.drop_column("persist_state")

    with op.batch_alter_table("players", schema=None) as batch_op:
        batch_op.alter_column(
            "player_flags",
            existing_type=sqlite.JSON(),
            nullable=False,
            existing_server_default=sa.text("'{}'"),
        )
        batch_op.alter_column(
            "quest_progress",
            existing_type=sqlite.JSON(),
            nullable=False,
            existing_server_default=sa.text("'{}'"),
        )
        batch_op.alter_column(
            "completed_quests",
            existing_type=sqlite.JSON(),
            nullable=False,
            existing_server_default=sa.text("'[]'"),
        )

    with op.batch_alter_table("refresh_tokens", schema=None) as batch_op:
        batch_op.alter_column(
            "expires_at",
            existing_type=sa.DATETIME(),
            type_=sa.Float(),
            existing_nullable=False,
        )
        batch_op.alter_column(
            "created_at",
            existing_type=sa.DATETIME(),
            type_=sa.Float(),
            nullable=True,
            existing_server_default=sa.text("(CURRENT_TIMESTAMP)"),
        )
        batch_op.alter_column(
            "revoked",
            existing_type=sa.BOOLEAN(),
            type_=sa.Integer(),
            existing_nullable=False,
            existing_server_default=sa.text("'0'"),
        )
        batch_op.drop_index("ix_refresh_tokens_account_id")

    with op.batch_alter_table("room_state", schema=None) as batch_op:
        batch_op.alter_column(
            "room_flags",
            existing_type=sqlite.JSON(),
            nullable=False,
            existing_server_default=sa.text("'{}'"),
        )
        batch_op.alter_column(
            "dynamic_exits",
            existing_type=sqlite.JSON(),
            nullable=False,
            existing_server_default=sa.text("'{}'"),
        )

    with op.batch_alter_table("rooms", schema=None) as batch_op:
        batch_op.drop_constraint("fk_rooms_on_exit_effect_rooms", type_="foreignkey")

    with op.batch_alter_table("security_events", schema=None) as batch_op:
        batch_op.alter_column(
            "timestamp",
            existing_type=sa.DATETIME(),
            type_=sa.Float(),
            existing_nullable=False,
            existing_server_default=sa.text("(CURRENT_TIMESTAMP)"),
        )
        batch_op.drop_index("ix_security_events_account_id")

    with op.batch_alter_table("server_metrics", schema=None) as batch_op:
        batch_op.drop_index("ix_server_metrics_type_time")
        batch_op.drop_column("extra_data")

    with op.batch_alter_table("user_accounts", schema=None) as batch_op:
        batch_op.alter_column(
            "is_active",
            existing_type=sa.BOOLEAN(),
            type_=sa.Integer(),
            existing_nullable=False,
            existing_server_default=sa.text("'1'"),
        )
        batch_op.alter_column(
            "created_at",
            existing_type=sa.DATETIME(),
            type_=sa.Float(),
            nullable=True,
            existing_server_default=sa.text("(CURRENT_TIMESTAMP)"),
        )
        batch_op.alter_column(
            "last_login",
            existing_type=sa.DATETIME(),
            type_=sa.Float(),
            existing_nullable=True,
        )

    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table("user_accounts", schema=None) as batch_op:
        batch_op.alter_column(
            "last_login",
            existing_type=sa.Float(),
            type_=sa.DATETIME(),
            existing_nullable=True,
        )
        batch_op.alter_column(
            "created_at",
            existing_type=sa.Float(),
            type_=sa.DATETIME(),
            nullable=False,
            existing_server_default=sa.text("(CURRENT_TIMESTAMP)"),
        )
        batch_op.alter_column(
            "is_active",
            existing_type=sa.Integer(),
            type_=sa.BOOLEAN(),
            existing_nullable=False,
            existing_server_default=sa.text("'1'"),
        )

    with op.batch_alter_table("server_metrics", schema=None) as batch_op:
        batch_op.add_column(sa.Column("extra_data", sqlite.JSON(), nullable=True))
        batch_op.create_index(
            "ix_server_metrics_type_time", ["metric_type", "timestamp"], unique=False
        )

    with op.batch_alter_table("security_events", schema=None) as batch_op:
        batch_op.create_index(
            "ix_security_events_account_id", ["account_id"], unique=False
        )
        batch_op.alter_column(
            "timestamp",
            existing_type=sa.Float(),
            type_=sa.DATETIME(),
            existing_nullable=False,
            existing_server_default=sa.text("(CURRENT_TIMESTAMP)"),
        )

    with op.batch_alter_table("rooms", schema=None) as batch_op:
        batch_op.create_foreign_key(
            "fk_rooms_on_exit_effect_rooms", "rooms", ["on_exit_effect"], ["id"]
        )

    with op.batch_alter_table("room_state", schema=None) as batch_op:
        batch_op.alter_column(
            "dynamic_exits",
            existing_type=sqlite.JSON(),
            nullable=True,
            existing_server_default=sa.text("'{}'"),
        )
        batch_op.alter_column(
            "room_flags",
            existing_type=sqlite.JSON(),
            nullable=True,
            existing_server_default=sa.text("'{}'"),
        )

    with op.batch_alter_table("refresh_tokens", schema=None) as batch_op:
        batch_op.create_index(
            "ix_refresh_tokens_account_id", ["account_id"], unique=False
        )
        batch_op.alter_column(
            "revoked",
            existing_type=sa.Integer(),
            type_=sa.BOOLEAN(),
            existing_nullable=False,
            existing_server_default=sa.text("'0'"),
        )
        batch_op.alter_column(
            "created_at",
            existing_type=sa.Float(),
            type_=sa.DATETIME(),
            nullable=False,
            existing_server_default=sa.text("(CURRENT_TIMESTAMP)"),
        )
        batch_op.alter_column(
            "expires_at",
            existing_type=sa.Float(),
            type_=sa.DATETIME(),
            existing_nullable=False,
        )

    with op.batch_alter_table("players", schema=None) as batch_op:
        batch_op.alter_column(
            "completed_quests",
            existing_type=sqlite.JSON(),
            nullable=True,
            existing_server_default=sa.text("'[]'"),
        )
        batch_op.alter_column(
            "quest_progress",
            existing_type=sqlite.JSON(),
            nullable=True,
            existing_server_default=sa.text("'{}'"),
        )
        batch_op.alter_column(
            "player_flags",
            existing_type=sqlite.JSON(),
            nullable=True,
            existing_server_default=sa.text("'{}'"),
        )

    with op.batch_alter_table("npc_templates", schema=None) as batch_op:
        batch_op.add_column(
            sa.Column(
                "persist_state",
                sa.BOOLEAN(),
                server_default=sa.text("'0'"),
                nullable=True,
            )
        )

    with op.batch_alter_table("npc_state", schema=None) as batch_op:
        batch_op.alter_column(
            "instance_data", existing_type=sqlite.JSON(), nullable=True
        )
        batch_op.alter_column(
            "is_alive",
            existing_type=sa.Integer(),
            type_=sa.BOOLEAN(),
            existing_nullable=False,
            existing_server_default=sa.text("'1'"),
        )

    with op.batch_alter_table("item_templates", schema=None) as batch_op:
        batch_op.alter_column(
            "provides_light",
            existing_type=sa.Integer(),
            type_=sa.BOOLEAN(),
            existing_nullable=False,
            existing_server_default=sa.text("'0'"),
        )

    with op.batch_alter_table("item_instances", schema=None) as batch_op:
        batch_op.add_column(
            sa.Column(
                "decay_minutes",
                sa.INTEGER(),
                server_default=sa.text("'60'"),
                nullable=True,
            )
        )
        batch_op.add_column(sa.Column("dropped_at", sa.FLOAT(), nullable=True))

    with op.batch_alter_table("factions", schema=None) as batch_op:
        batch_op.create_unique_constraint("uq_factions_name", ["name"])

    with op.batch_alter_table("clans", schema=None) as batch_op:
        batch_op.create_unique_constraint("uq_clans_name", ["name"])

    with op.batch_alter_table("clan_members", schema=None) as batch_op:
        batch_op.create_unique_constraint(
            "uq_clan_members_clan_player", ["clan_id", "player_id"]
        )
        batch_op.drop_column("extra_data")

    with op.batch_alter_table("areas", schema=None) as batch_op:
        batch_op.alter_column(
            "entry_points", existing_type=sqlite.JSON(), nullable=True
        )
        batch_op.alter_column("time_phases", existing_type=sqlite.JSON(), nullable=True)

    with op.batch_alter_table("admin_actions", schema=None) as batch_op:
        batch_op.create_index("ix_admin_actions_admin_id", ["admin_id"], unique=False)
        batch_op.alter_column(
            "success",
            existing_type=sa.Integer(),
            type_=sa.BOOLEAN(),
            existing_nullable=False,
            existing_server_default=sa.text("'1'"),
        )

    # ### end Alembic commands ###

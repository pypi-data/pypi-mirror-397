pages:
  artifacts:
    paths:
      - public
  image: sphinxdoc/sphinx
  rules:
    - if: $CI_COMMIT_TAG =~ /^v.*/    
  script:
    - apt update
    - apt --yes install pandoc # needed for jupyter notebook
    - apt-get install -y git # needed for setuptools-scm version handling
    - apt-get install -y gcc
    - bash ./scripts/build_documentation.sh
  stage: doc
  tags: &id001
  - ci.inria.fr
  - linux
  - small

test:
  image: $PYTHON_IMAGE
  only:
  - main
  - test-ci
  parallel:
    matrix:
    - PYTHON_IMAGE: python:3.9
    - PYTHON_IMAGE: python:3.13  # Skip 3.14 for now - qdldl build broken
  script:
  - bash scripts/test.sh
  stage: test
  tags: *id001

coverage:
  image: python:3.13 # Use latest stable for coverage
  only:
  - main
  script:
  - bash scripts/test.sh
  stage: test
  tags: *id001
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
  coverage: '/TOTAL.*\s+(\d+%)$/' 

publish:
  stage: deploy
  tags: *id001
  image: python:latest
  script:
    - pip install build twine
    - python -m build
    - twine upload dist/*
  rules:
    - if: $CI_COMMIT_TAG =~ /^v.*/

stages:
  - test
  - doc
  - deploy
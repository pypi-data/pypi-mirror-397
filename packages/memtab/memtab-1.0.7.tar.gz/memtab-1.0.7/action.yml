name: memtab
description: "Composite action to generate and publish memory usage table/report"

inputs:
  elf:
    required: false
    description: The ELF file to tabulate
  config:
    required: false
    description: the YAML file to configure tabulation (categories and subcategories)
  sdk_path:
    required: false
    description: Where on your System the SDK / toolchain resides
  source_directory:
    required: false
    description: The source directory relative to the workspace where memtab should run
  project:
    required: false
    description: The memtab project name to use (overrides the memtab.yml setting, if present)
  artifact_name:
    required: false
    description: The name to use when publishing the memtab results as an artifact
    default: Memory Tabulator Results

runs:
  using: composite
  steps:
    # Workaround when working in container, https://github.com/actions/runner/issues/2058
    # Use ${{ env.WORKSPACE }} in succeeding steps to access github workspace path
    - name: Set environment variables
      run: |
        if [[ -n "${{ job.container.id }}" ]]; then
          echo "WORKSPACE=$GITHUB_WORKSPACE" >> $GITHUB_ENV
          # In containers, action_path context may not be available
          if [ -n "$GITHUB_ACTION_PATH" ]; then
            echo "ACTION_PATH=$GITHUB_ACTION_PATH" >> $GITHUB_ENV
          else
            ACTION_REF="${{ github.action_ref }}"
            if [ -z "$ACTION_REF" ]; then
              ACTION_REF="main"
            fi
            echo "ACTION_PATH=/__w/_actions/etn-corp/memtab/$ACTION_REF" >> $GITHUB_ENV
          fi
        else
          echo "WORKSPACE=${{ github.workspace }}" >> $GITHUB_ENV
          echo "ACTION_PATH=${{ github.action_path }}" >> $GITHUB_ENV
        fi
      shell: bash

    - name: Install uv
      uses: astral-sh/setup-uv@v7
      with:
        working-directory: ${{ env.ACTION_PATH }}

    - name: Install Orca (The image generation tool used by memtab)
      if: runner.os == 'Windows'
      run: |
        npm install -g electron@6.1.4 orca
      shell: pwsh

    - name: Tabulate Memory (Windows)
      if: runner.os == 'Windows'
      run: |
        if ("${{ inputs.sdk_path }}" -ne '') {
          $env:PATH += ";${{ inputs.sdk_path }}"
        }
        if ("${{ inputs.project }}" -ne '') {
          $env:MEMTAB_PROJECT = "${{ inputs.project }}"
        }
        uv run --project ${{ env.ACTION_PATH }} memtab --report markdown:memtab.md
      working-directory: ${{ env.WORKSPACE }}\${{ inputs.source_directory }}
      shell: pwsh
      env:
        MEMTAB_ELF: ${{ inputs.elf }}
        MEMTAB_YML: ${{ inputs.config }}

    - name: Tabulate Memory (Linux)
      if: runner.os == 'Linux'
      run: |
        if [[ -n "${{ inputs.sdk_path }}" ]]; then
          export PATH=$PATH:${{ inputs.sdk_path }}
        fi
        if [[ -n "${{ inputs.project }}" ]]; then
          export MEMTAB_PROJECT="${{ inputs.project }}"
        fi
        uv run --project ${{ env.ACTION_PATH }} memtab --report markdown:memtab.md
      working-directory: ${{ env.WORKSPACE }}/${{ inputs.source_directory }}
      shell: bash
      env:
        MEMTAB_ELF: ${{ inputs.elf }}
        MEMTAB_YML: ${{ inputs.config }}

    - name: Publish Memory Tabulator Results (Windows)
      if: runner.os == 'Windows'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.artifact_name }}
        path: ${{ env.WORKSPACE }}\${{ inputs.source_directory }}\memtab.json

    - name: Publish Memory Tabulator Results (Linux)
      if: runner.os == 'Linux'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.artifact_name }}
        path: ${{ env.WORKSPACE }}/${{ inputs.source_directory }}/memtab.json

    - name: Publish Memory Summary (Windows)
      if: runner.os == 'Windows'
      run: |
        $summary_content = Get-Content -Raw -Path memtab.md
        Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value $summary_content
      working-directory: ${{ env.WORKSPACE }}\${{ inputs.source_directory }}
      shell: pwsh

    - name: Publish Memory Summary (Linux)
      if: runner.os == 'Linux'
      run: |
        cat memtab.md >> $GITHUB_STEP_SUMMARY
      working-directory: ${{ env.WORKSPACE }}/${{ inputs.source_directory }}
      shell: bash

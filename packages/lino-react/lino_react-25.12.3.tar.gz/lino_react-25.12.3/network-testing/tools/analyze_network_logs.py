#!/usr/bin/env python3
"""
Simple script to analyze network logs generated by Jest tests.

Usage:
    python network-testing/tools/analyze_network_logs.py network-testing/logs/network-log-noi.json
"""

import json
import sys
from pathlib import Path
from collections import Counter


def analyze_log(log_file):
    """Analyze a single network log file."""
    with open(log_file) as f:
        data = json.load(f)
    
    metadata = data['metadata']
    requests = data['requests']
    
    print(f"\n{'='*80}")
    print(f"Log File: {log_file}")
    print(f"{'='*80}")
    print(f"Test Site: {metadata['testSite']}")
    print(f"Timestamp: {metadata['timestamp']}")
    print(f"Total Requests: {metadata['totalRequests']}")
    print(f"Duration: {metadata['duration']}ms ({metadata['duration']/1000:.2f}s)")
    print()
    
    # Analyze by method
    methods = Counter(req['request']['method'] for req in requests)
    print("Requests by Method:")
    for method, count in methods.most_common():
        print(f"  {method}: {count}")
    print()
    
    # Analyze by resource type
    types = Counter(req['request']['resourceType'] for req in requests)
    print("Requests by Resource Type:")
    for rtype, count in types.most_common():
        print(f"  {rtype}: {count}")
    print()
    
    # Analyze response codes
    status_codes = Counter(
        req['response']['status'] if req['response'] else 'no-response'
        for req in requests
    )
    print("Response Status Codes:")
    for code, count in status_codes.most_common():
        print(f"  {code}: {count}")
    print()
    
    # API endpoints (filter for /api/ URLs)
    api_requests = [req for req in requests if '/api/' in req['request']['url']]
    if api_requests:
        print(f"API Requests ({len(api_requests)} total):")
        for req in api_requests[:10]:  # Show first 10
            method = req['request']['method']
            url = req['request']['url']
            status = req['response']['status'] if req['response'] else 'N/A'
            # Extract just the path after /api/
            path = url.split('/api/')[-1].split('?')[0]
            print(f"  {method:6} /{path:50} -> {status}")
        if len(api_requests) > 10:
            print(f"  ... and {len(api_requests) - 10} more")
        print()
    
    # Find slow requests (> 1 second)
    slow_requests = []
    for req in requests:
        if req['response']:
            duration = req['response']['timestamp'] - req['request']['timestamp']
            if duration > 1000:
                slow_requests.append((req, duration))
    
    if slow_requests:
        print("Slow Requests (>1s):")
        for req, duration in sorted(slow_requests, key=lambda x: x[1], reverse=True)[:5]:
            url = req['request']['url'].split('?')[0]
            print(f"  {duration:>6}ms - {url}")
        print()
    
    # Find failed requests
    failed = [req for req in requests if req['response'] and req['response']['status'] >= 400]
    if failed:
        print(f"Failed Requests ({len(failed)} total):")
        for req in failed:
            method = req['request']['method']
            url = req['request']['url']
            status = req['response']['status']
            print(f"  {method} {url} -> {status}")
        print()


def main():
    if len(sys.argv) < 2:
        print("Usage: python network-testing/tools/analyze_network_logs.py <log-file.json> [...]")
        print("\nExample:")
        print("  python network-testing/tools/analyze_network_logs.py network-testing/logs/network-log-noi.json")
        sys.exit(1)
    
    log_files = []
    for pattern in sys.argv[1:]:
        if '*' in pattern or '?' in pattern:
            # Handle glob patterns
            path = Path(pattern)
            log_files.extend(path.parent.glob(path.name))
        else:
            log_files.append(Path(pattern))
    
    if not log_files:
        print("No log files found!")
        sys.exit(1)
    
    for log_file in sorted(log_files):
        if log_file.exists():
            analyze_log(log_file)
        else:
            print(f"Warning: File not found: {log_file}")


if __name__ == '__main__':
    main()

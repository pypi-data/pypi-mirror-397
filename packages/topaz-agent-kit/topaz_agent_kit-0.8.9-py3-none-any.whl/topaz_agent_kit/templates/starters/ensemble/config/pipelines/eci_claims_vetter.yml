# =============================================================================
# PIPELINE CONFIGURATION
# =============================================================================
#
# ECI Claims Vetting Pipeline
# Multi-agent system to vet insurance claims by extracting and validating data from uploaded documents,
# assessing buyer legitimacy, verifying shipment details, and making risk-based decisions.
#
# =============================================================================

name: "ECI Claims Vetter"
description: "Automated insurance claims vetting with document extraction, validation, buyer verification, shipment validation, and risk-based decision making"

# =============================================================================
# NODES REGISTRY
# =============================================================================
nodes:
  - id: eci_pending_claims_scanner
    config_file: "agents/eci_pending_claims_scanner.yml"
  - id: eci_claims_extractor
    config_file: "agents/eci_claims_extractor.yml"
  - id: eci_claim_validator
    config_file: "agents/eci_claim_validator.yml"
  - id: eci_buyer_checker
    config_file: "agents/eci_buyer_checker.yml"
  - id: eci_shipment_validator
    config_file: "agents/eci_shipment_validator.yml"
  - id: eci_policy_coverage_validator
    config_file: "agents/eci_policy_coverage_validator.yml"
  - id: eci_claim_history_lookup
    config_file: "agents/eci_claim_history_lookup.yml"
  - id: eci_decision_recommender
    config_file: "agents/eci_decision_recommender.yml"
  - id: eci_results_recorder
    config_file: "agents/eci_results_recorder.yml"
  - id: eci_summary_reporter
    config_file: "agents/eci_summary_reporter.yml"

# =============================================================================
# PATTERN CONFIGURATION
# =============================================================================
# Execution pattern: Sequential â†’ Loop (with parallel validators) â†’ Sequential
pattern:
  type: sequential
  name: "ECI Claims Vetting Workflow"
  description: |
    ## ECI Claims Vetting Workflow
    
    This sequential workflow orchestrates the end-to-end claims vetting process:
    1. **Scan** database for pending claims
    2. **Process** each claim through extraction, validation, and decision-making
    3. **Report** summary of all processed claims
    
    The pipeline ensures thorough validation while maintaining efficiency through parallel processing of validation checks.
  steps:
    # Step 1: Scan database for pending claims
    - node: eci_pending_claims_scanner
    
    # Step 2: Loop through all pending claims
    - type: loop
      name: "Claims Processing Loop"
      description: |
        ## Iterative Claim Processing
        
        Processes each pending claim through the complete vetting workflow:
        - Document extraction from claim form, invoice, and bill of lading
        - Parallel validation across multiple dimensions
        - Risk assessment and decision recommendation
        - Human review and approval
        - Results recording
        
        Continues until all pending claims are processed or safety limit is reached.
      condition: "eci_pending_claims_scanner.total_pending_count > 0"
      iterate_over: "eci_pending_claims_scanner.pending_claims_list"
      loop_item_key: "current_claim"
      termination:
        max_iterations: 100  # Safety limit to prevent infinite loops
      body:
        type: sequential
        name: "Single Claim Processing Flow"
        description: |
          ## Individual Claim Vetting Process
          
          Complete workflow for processing a single claim:
          1. Extract structured data from all submitted documents
          2. Run parallel validations for speed and efficiency
          3. Generate risk-based decision recommendation
          4. Present findings for human review
          5. Record final decision and results
        steps:
          # Extract data from all 3 PDF documents (current_claim is automatically available from loop)
          - node: eci_claims_extractor
          
          # Parallel validation (for speed)
          - type: parallel
            name: "Parallel Validation Checks"
            description: |
              ## Concurrent Validation Assessment
              
              Runs all validation checks simultaneously for maximum efficiency:
              - **Claim Validator**: Cross-document consistency checks
              - **Buyer Checker**: Legitimacy and risk assessment
              - **Shipment Validator**: Voyage and date verification
              - **Policy Coverage Validator**: Coverage limits and eligibility
              - **Claim History Lookup**: Historical claim pattern analysis
              
              All validators execute in parallel to minimize processing time.
            steps:
              - node: eci_claim_validator           # Validate cross-document consistency
              - node: eci_buyer_checker             # Check buyer legitimacy
              - node: eci_shipment_validator        # Validate shipment details
              - node: eci_policy_coverage_validator  # Validate policy coverage
              - node: eci_claim_history_lookup      # Validate claim history limits
          
          # Aggregate findings and recommend decision
          - node: eci_decision_recommender
          
          # Human review and approval
          - gate: eci_decision_gate
          
          # Record all results to database
          - node: eci_results_recorder
    
    # Step 3: Generate summary report (after all claims processed)
    - node: eci_summary_reporter

# =============================================================================
# HITL SECTION - Human-in-the-loop gates
# =============================================================================
#
# Human-in-the-Loop gates configuration (optional)
# Parameters:
# - gates (list[object], optional): human-in-the-loop pause points
#   - gates[].id (str, required): unique gate id
#   - gates[].type (str, required): "approval" | "input" | "selection"
#   - gates[].title (str, optional): UI title
#   - gates[].description (str, optional): UI description
#   - gates[].options (list[object], optional): selection options for selection gates
#   - gates[].context_key (str, optional): key to store data in context
#   - gates[].timeout_ms (int, optional): wait timeout; default 300000
#   - gates[].on_timeout (str, optional): "approve" | "reject" | "skip" | "default"
#
# =============================================================================

gates:
  - id: eci_decision_gate
    type: selection
    title: "ECI Claim Decision Review"
    description: |
      **Claim ID:** {{ current_claim.claim_id }}
      
      
      ## Claim Details
      
      | Field | Value |
      |-------|-------|
      | Claim ID | {{ current_claim.claim_id }} |
      | Policy Number | {{ eci_claims_extractor.extracted_data.policy_number }} |
      | Claimant Name | {{ eci_claims_extractor.extracted_data.claimant_name }} |
      | Claimant Email | {{ eci_claims_extractor.extracted_data.claimant_email }} |
      | Buyer | {{ eci_claims_extractor.extracted_data.buyer_name }} |
      | Seller | {{ eci_claims_extractor.extracted_data.seller_name }} |
      | Claim Amount | ${{ eci_claims_extractor.extracted_data.claim_amount | round(2) }} |
      | Claim Reason Category | {{ eci_claims_extractor.extracted_data.claim_reason_category }} |
      | Claim Reason Description | {{ eci_claims_extractor.extracted_data.claim_reason_description }} |
      
      
      ## Invoice Details
      
      | Field | Value |
      |-------|-------|
      | Invoice Number | {{ eci_claims_extractor.extracted_data.invoice_number }} |
      | Invoice Date | {{ eci_claims_extractor.extracted_data.invoice_date }} |
      | Invoice Amount | ${{ eci_claims_extractor.extracted_data.invoice_amount | round(2) }} |
      
      
      ## Bill of Lading Details
      
      | Field | Value |
      |-------|-------|
      | Vessel | {{ eci_claims_extractor.extracted_data.vessel_name }} |
      | Origin Port | {{ eci_claims_extractor.extracted_data.origin_port }} |
      | Destination Port | {{ eci_claims_extractor.extracted_data.destination_port }} |
      | BOL Date | {{ eci_claims_extractor.extracted_data.bol_date }} |
      
      
      ## Policy Information
      
      | Field | Value |
      |-------|-------|
      | Policy Number | {{ eci_claims_extractor.extracted_data.policy_number }} |
      | Claim Reason Category | {{ eci_claims_extractor.extracted_data.claim_reason_category }} |
      {% if eci_policy_coverage_validator.coverage_details %} | Coverage Limit | ${{ eci_policy_coverage_validator.coverage_details.coverage_limit | round(2) }} |
      | Deductible | ${{ eci_policy_coverage_validator.coverage_details.deductible | round(2) }} |
      | Coverage Percentage | {{ (eci_policy_coverage_validator.coverage_details.coverage_percentage * 100) | round(1) }}% |
      | Covered Amount | ${{ eci_policy_coverage_validator.coverage_details.covered_amount | round(2) }} |
      {% endif %}
      
      
      ## Claim History
      
      {% if eci_claim_history_lookup.history_summary %}
      | Field | Value |
      |-------|-------|
      | Total Claims in Term | {{ eci_claim_history_lookup.history_summary.total_claims_in_term }} / {{ eci_claim_history_lookup.history_summary.max_claims_per_term }} |
      | Total Claims in Year | {{ eci_claim_history_lookup.history_summary.total_claims_in_year }} / {{ eci_claim_history_lookup.history_summary.max_claims_per_year }} |
      | Average Claim Amount | ${{ eci_claim_history_lookup.history_summary.average_claim_amount | round(2) }} |
      | Average Days Between Claims | {{ eci_claim_history_lookup.history_summary.average_days_between_claims }} days |
      | High Risk Claims Count | {{ eci_claim_history_lookup.history_summary.high_risk_claims_count }} |
      {% else %}
      **Claim History:** Not available
      {% endif %}
      
      
      ## Recommended Decision
      **Decision:** {% if gate_options %}{% for opt in gate_options %}{% if opt.value == eci_decision_recommender.recommended_decision %}{{ opt.label }}{% endif %}{% endfor %}{% else %}{{ eci_decision_recommender.recommended_decision | upper }}{% endif %}
      **Risk Score:** {{ eci_decision_recommender.risk_score }}/100
      
      
      **Red Flags:**
      {% if eci_decision_recommender.red_flags and eci_decision_recommender.red_flags | length > 0 %}
      {% for flag in eci_decision_recommender.red_flags %}
      - {{ flag }}
      {% endfor %}
      {% else %}
      None
      {% endif %}
      
      
      **Rationale:**
      {{ eci_decision_recommender.rationale }}
      
      
      ## Validation Summary

      <details>
      <summary><strong>ðŸ“‹ Claim Validator - Detailed Checks</strong> ({% if eci_claim_validator.validation_passed %}<span style="color: #28a745;">âœ“ PASSED</span>{% else %}<span style="color: #dc3545;">âœ— FAILED</span>{% endif %})</summary>
      
      {% if eci_claim_validator.checks_table %}
      {{ eci_claim_validator.checks_table }}
      {% else %}
      **Summary:** {{ eci_claim_validator.details }}
      {% endif %}
      
      </details>
      
      
      <details>
      <summary><strong>ðŸ‘¤ Buyer Checker - Detailed Checks</strong> ({% if eci_buyer_checker.buyer_status == "legitimate" %}<span style="color: #28a745;">âœ“ Legitimate</span>{% elif eci_buyer_checker.buyer_status == "medium_risk" %}<span style="color: #ffa500;">âš  Medium Risk</span>{% elif eci_buyer_checker.buyer_status == "high_risk" %}<span style="color: #dc3545;">âœ— High Risk</span>{% else %}<span style="color: #6c757d;">? Unknown</span>{% endif %})</summary>
      
      {% if eci_buyer_checker.checks_table %}
      {{ eci_buyer_checker.checks_table }}
      {% else %}
      **Buyer Status:** {{ eci_buyer_checker.buyer_status }}
      **Risk Flags:** {{ eci_buyer_checker.risk_flags }}
      {% endif %}
      
      </details>
      
      
      <details>
      <summary><strong>ðŸš¢ Shipment Validator - Detailed Checks</strong> ({% if eci_shipment_validator.shipment_valid %}<span style="color: #28a745;">âœ“ VALID</span>{% else %}<span style="color: #dc3545;">âœ— INVALID</span>{% endif %})</summary>
      
      {% if eci_shipment_validator.checks_table %}
      {{ eci_shipment_validator.checks_table }}
      {% else %}
      **Voyage Found:** {{ "Yes" if eci_shipment_validator.voyage_found else "No" }}
      **Date Within Window:** {{ "Yes" if eci_shipment_validator.date_within_window else "No" }}
      {% if eci_shipment_validator.issues %}
      **Issues:**
      {% for issue in eci_shipment_validator.issues %}
      - {{ issue }}
      {% endfor %}
      {% endif %}
      {% endif %}
      
      </details>
      
      
      <details>
      <summary><strong>ðŸ“„ Policy Coverage Validator - Detailed Checks</strong> ({% if eci_policy_coverage_validator.coverage_valid %}<span style="color: #28a745;">âœ“ COVERED</span>{% else %}<span style="color: #dc3545;">âœ— NOT COVERED</span>{% endif %})</summary>
      
      {% if eci_policy_coverage_validator.checks_table %}
      {{ eci_policy_coverage_validator.checks_table }}
      {% else %}
      **Policy Found:** {{ "Yes" if eci_policy_coverage_validator.policy_found else "No" }}
      {% if eci_policy_coverage_validator.coverage_details %}
      **Coverage Details:**
      - Coverage Limit: ${{ eci_policy_coverage_validator.coverage_details.coverage_limit | round(2) }}
      - Deductible: ${{ eci_policy_coverage_validator.coverage_details.deductible | round(2) }}
      - Covered Amount: ${{ eci_policy_coverage_validator.coverage_details.covered_amount | round(2) }}
      {% endif %}
      {% endif %}
      
      </details>
      
      
      <details>
      <summary><strong>ðŸ“Š Claim History Lookup - Detailed Checks</strong> ({% if eci_claim_history_lookup.history_valid %}<span style="color: #28a745;">âœ“ VALID</span>{% else %}<span style="color: #dc3545;">âœ— INVALID</span>{% endif %})</summary>
      
      {% if eci_claim_history_lookup.checks_table %}
      {{ eci_claim_history_lookup.checks_table }}
      {% else %}
      **Policy Found:** {{ "Yes" if eci_claim_history_lookup.policy_found else "No" }}
      {% if eci_claim_history_lookup.history_summary %}
      **History Summary:**
      - Claims in Term: {{ eci_claim_history_lookup.history_summary.total_claims_in_term }} / {{ eci_claim_history_lookup.history_summary.max_claims_per_term }}
      - Claims in Year: {{ eci_claim_history_lookup.history_summary.total_claims_in_year }} / {{ eci_claim_history_lookup.history_summary.max_claims_per_year }}
      {% endif %}
      {% endif %}
      
      </details>
      
      
      Review all findings above and approve or override the recommended decision.
    
    options:
      - value: "approve"
        label: "Approve Claim"
        description: "Accept the claim as valid and proceed with payment"
        color: "green"
        badge: "Recommended"
      
      - value: "request_docs"
        label: "Request Missing Documents"
        description: "Additional documentation is needed before making a decision"
        color: "amber"
        badge: "Recommended"
      
      - value: "escalate"
        label: "Escalate to SIU"
        description: "Send to Special Investigations Unit for detailed review"
        color: "red"
        badge: "Recommended"
      
      - value: "reject"
        label: "Reject Claim"
        description: "Deny the claim due to validation failures or fraud concerns"
        color: "red"
        badge: "Recommended"
    
    default: "{{ eci_decision_recommender.recommended_decision }}"
    context_key: "final_decision"
    timeout_ms: 30000
    on_timeout: default

# =============================================================================
# OUTPUTS SECTION - Intermediate and Final Outputs
# =============================================================================
#
# Output configuration for pipeline results
# Parameters:
# - intermediate (list[object], optional): intermediate outputs during execution
#   - intermediate[].node (str, required): which node's output to capture
#   - intermediate[].selectors (list[str], required): JSON keys/paths to extract
#   - intermediate[].transform (str, optional): Jinja2 expression for transformation
# - final (object, required): final pipeline output
#   - final.node (str, required): which node's output to use as final result
#   - final.selectors (list[str], required): JSON keys/paths to extract
#   - final.transform (str, optional): Jinja2 expression for transformation
#
# =============================================================================

outputs:
  final:
    node: eci_summary_reporter
    selectors:
      - summary_report
      - total_processed
      - decisions_breakdown
      - average_risk_score
    transform: "{{ summary_report if summary_report else 'No claims were processed in this run.' }}"


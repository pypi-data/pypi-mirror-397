**Application ID:** {{ current_application.application_id }}

## Application Details

| Field | Value |
|-------|-------|
| Application ID | {{ current_application.application_id }} |
| **Seller Information** | |
| Seller Name | {{ current_application.seller_name }} |
| Seller Email | {{ current_application.seller_email }} |
| Seller Address | {% set seller_addr = current_application.seller_address if current_application.seller_address else (tci_document_extractor.extracted_data.application_form.applicant_details.address if tci_document_extractor.extracted_data and tci_document_extractor.extracted_data.application_form and tci_document_extractor.extracted_data.application_form.applicant_details and tci_document_extractor.extracted_data.application_form.applicant_details.address else '') %}{% set seller_post = current_application.seller_postcode if current_application.seller_postcode else (tci_document_extractor.extracted_data.application_form.applicant_details.postcode if tci_document_extractor.extracted_data and tci_document_extractor.extracted_data.application_form and tci_document_extractor.extracted_data.application_form.applicant_details and tci_document_extractor.extracted_data.application_form.applicant_details.postcode else '') %}{% if seller_addr %}{{ seller_addr }}{% if seller_post %}, {{ seller_post }}{% endif %}{% else %}N/A{% endif %} |
| Seller Contact | {% set seller_contact = current_application.seller_contact_name if current_application.seller_contact_name else (tci_document_extractor.extracted_data.application_form.applicant_details.contact_name if tci_document_extractor.extracted_data and tci_document_extractor.extracted_data.application_form and tci_document_extractor.extracted_data.application_form.applicant_details and tci_document_extractor.extracted_data.application_form.applicant_details.contact_name else '') %}{% set seller_pos = current_application.seller_position if current_application.seller_position else (tci_document_extractor.extracted_data.application_form.applicant_details.position if tci_document_extractor.extracted_data and tci_document_extractor.extracted_data.application_form and tci_document_extractor.extracted_data.application_form.applicant_details and tci_document_extractor.extracted_data.application_form.applicant_details.position else '') %}{% if seller_contact %}{{ seller_contact }}{% if seller_pos %} ({{ seller_pos }}){% endif %}{% else %}N/A{% endif %} |
| **Buyer Information** | |
| Buyer Name | {{ current_application.buyer_name }} |
| Buyer Address | {% set buyer_addr = current_application.buyer_address if current_application.buyer_address else (tci_document_extractor.extracted_data.application_form.buyer_details.buyer_address if tci_document_extractor.extracted_data and tci_document_extractor.extracted_data.application_form and tci_document_extractor.extracted_data.application_form.buyer_details and tci_document_extractor.extracted_data.application_form.buyer_details.buyer_address else '') %}{% if buyer_addr %}{{ buyer_addr }}{% else %}N/A{% endif %} |
| Buyer Registered Number | {% set buyer_reg = current_application.buyer_registered_number if current_application.buyer_registered_number else (tci_document_extractor.extracted_data.application_form.buyer_details.registered_number if tci_document_extractor.extracted_data and tci_document_extractor.extracted_data.application_form and tci_document_extractor.extracted_data.application_form.buyer_details and tci_document_extractor.extracted_data.application_form.buyer_details.registered_number else '') %}{% if buyer_reg %}{{ buyer_reg }}{% else %}N/A{% endif %} |
| **Contract Details** | |
| Requested Amount | {% if current_application.requested_amount %}{% set currency_symbol = tci_document_extractor.extracted_data.application_form.contract_details.currency_symbol if tci_document_extractor.extracted_data and tci_document_extractor.extracted_data.application_form and tci_document_extractor.extracted_data.application_form.contract_details and tci_document_extractor.extracted_data.application_form.contract_details.currency_symbol else (tci_document_extractor.extracted_data.financial_statements.currency_symbol if tci_document_extractor.extracted_data and tci_document_extractor.extracted_data.financial_statements and tci_document_extractor.extracted_data.financial_statements.currency_symbol else '') %}{% set currency = tci_document_extractor.extracted_data.application_form.contract_details.currency if tci_document_extractor.extracted_data and tci_document_extractor.extracted_data.application_form and tci_document_extractor.extracted_data.application_form.contract_details and tci_document_extractor.extracted_data.application_form.contract_details.currency else (tci_document_extractor.extracted_data.financial_statements.currency if tci_document_extractor.extracted_data and tci_document_extractor.extracted_data.financial_statements and tci_document_extractor.extracted_data.financial_statements.currency else '') %}{% if currency_symbol %}{{ currency_symbol }}{% endif %}{{ "{:,.0f}".format(current_application.requested_amount) }}{% if currency %} ({{ currency }}){% endif %}{% else %}N/A{% endif %} |
| Requested Term | {{ current_application.requested_term_days }} days |

## Risk Factor Scores

{% if tci_risk_score_calculator.risk_factors_table %}
{{ tci_risk_score_calculator.risk_factors_table }}
{% else %}
| Risk Factor | Score | Weight | Weighted Score |
|-------------|-------|--------|----------------|
| Financial Health | {{ tci_financial_health_assessor.score if tci_financial_health_assessor else 'N/A' }} | 0.22 | {{ (tci_financial_health_assessor.score * 0.22) | round(2) if tci_financial_health_assessor and tci_financial_health_assessor.score else 'N/A' }} |
| Payment Behavior | {{ tci_payment_behavior_assessor.score if tci_payment_behavior_assessor else 'N/A' }} | 0.18 | {{ (tci_payment_behavior_assessor.score * 0.18) | round(2) if tci_payment_behavior_assessor and tci_payment_behavior_assessor.score else 'N/A' }} |
| Credit Rating | {{ tci_credit_rating_assessor.score if tci_credit_rating_assessor else 'N/A' }} | 0.13 | {{ (tci_credit_rating_assessor.score * 0.13) | round(2) if tci_credit_rating_assessor and tci_credit_rating_assessor.score else 'N/A' }} |
| Contract Terms | {{ tci_contract_terms_assessor.score if tci_contract_terms_assessor else 'N/A' }} | 0.09 | {{ (tci_contract_terms_assessor.score * 0.09) | round(2) if tci_contract_terms_assessor and tci_contract_terms_assessor.score else 'N/A' }} |
| Sanctions & Compliance | {{ tci_sanctions_compliance_assessor.score if tci_sanctions_compliance_assessor else 'N/A' }} | 0.04 | {{ (tci_sanctions_compliance_assessor.score * 0.04) | round(2) if tci_sanctions_compliance_assessor and tci_sanctions_compliance_assessor.score else 'N/A' }} |
| Industry & External Factors | {{ tci_industry_factors_assessor.score if tci_industry_factors_assessor else 'N/A' }} | 0.08 | {{ (tci_industry_factors_assessor.score * 0.08) | round(2) if tci_industry_factors_assessor and tci_industry_factors_assessor.score else 'N/A' }} |
| Credit Bureau Report | {{ tci_credit_bureau_assessor.score if tci_credit_bureau_assessor else 'N/A' }} | 0.08 | {{ (tci_credit_bureau_assessor.score * 0.08) | round(2) if tci_credit_bureau_assessor and tci_credit_bureau_assessor.score else 'N/A' }} |
| Bank Reference Letter | {{ tci_bank_reference_assessor.score if tci_bank_reference_assessor else 'N/A' }} | 0.04 | {{ (tci_bank_reference_assessor.score * 0.04) | round(2) if tci_bank_reference_assessor and tci_bank_reference_assessor.score else 'N/A' }} |
| External News & Media | {{ tci_news_sentiment_assessor.score if tci_news_sentiment_assessor else 'N/A' }} | 0.10 | {{ (tci_news_sentiment_assessor.score * 0.10) | round(2) if tci_news_sentiment_assessor and tci_news_sentiment_assessor.score else 'N/A' }} |
{% endif %}

## Total Risk Score

**Total Risk Score:** {{ tci_risk_score_calculator.total_risk_score | round(2) if tci_risk_score_calculator else 'N/A' }} / 100
**Risk Level:** {{ tci_risk_score_calculator.risk_level if tci_risk_score_calculator else 'N/A' }}

## Final Creditworthiness & Underwriting Recommendation

{% if tci_recommendation_generator %}
{# Use risk_score_calculator's total_risk_score directly (recommender should pass it through) #}
{% set final_score = tci_risk_score_calculator.total_risk_score | round(2) if tci_risk_score_calculator and tci_risk_score_calculator.total_risk_score else (tci_recommendation_generator.final_risk_score | round(2) if tci_recommendation_generator.final_risk_score else None) %}
{% set score_color = "#6b7280" %}
{% set credit_color = "#6b7280" %}

{# Determine color based on underwriting manual risk categories #}
{% if final_score is not none %}
  {% set matched = false %}
  {# Try to use underwriting manual if available - check same way as other variables in template #}
  {% if tci_underwriting_manual_reviewer and tci_underwriting_manual_reviewer.guidelines and tci_underwriting_manual_reviewer.guidelines.risk_categories %}
    {% set categories = tci_underwriting_manual_reviewer.guidelines.risk_categories %}
    {# Iterate through risk categories to find matching range #}
    {% for category in categories %}
      {% if not matched %}
        {% set score_range = category.score_range if category.score_range else '' %}
        {# Parse score_range: "85-100", "70-84", "50-69", "<50" #}
        {% if "-" in score_range %}
          {# Range format: "85-100" #}
          {% set range_parts = score_range.split("-") %}
          {% set min_score = range_parts[0] | int %}
          {% set max_score = range_parts[1] | int %}
          {% if final_score >= min_score and final_score <= max_score %}
            {# Determine color based on position in categories array (highest to lowest) #}
            {% set category_index = loop.index0 %}
            {% if category_index == 0 %}
              {% set score_color = "#22c55e" %} {# Green: Highest/Lowest Risk #}
            {% elif category_index == 1 %}
              {% set score_color = "#f59e0b" %} {# Amber: Second #}
            {% elif category_index == 2 %}
              {% set score_color = "#ef4444" %} {# Red: Third #}
            {% else %}
              {% set score_color = "#dc2626" %} {# Dark Red: Lowest/Decline #}
            {% endif %}
            {% set matched = true %}
          {% endif %}
        {% elif score_range and score_range.startswith("<") %}
          {# Less than format: "<50" #}
          {% set threshold = score_range[1:] | int %}
          {% if final_score < threshold %}
            {% set score_color = "#dc2626" %} {# Dark Red: Decline #}
            {% set matched = true %}
          {% endif %}
        {% endif %}
      {% endif %}
    {% endfor %}
  {% endif %}
  
  {# Fallback to hardcoded ranges if underwriting manual not available or no match found #}
  {% if not matched %}
    {% if final_score >= 85 %}
      {% set score_color = "#22c55e" %}
    {% elif final_score >= 70 %}
      {% set score_color = "#f59e0b" %}
    {% elif final_score >= 50 %}
      {% set score_color = "#ef4444" %}
    {% else %}
      {% set score_color = "#dc2626" %}
    {% endif %}
  {% endif %}
  
  {# Use same color for creditworthiness #}
  {% set credit_color = score_color %}
{% endif %}

**Final Risk Score:** <span style="color: {{ score_color }}; font-weight: bold;">{{ final_score if final_score is not none else 'N/A' }}</span> / 100

{# Use risk_score_calculator's risk_level as creditworthiness (recommender should align with this) #}
{% set creditworthiness_text = tci_risk_score_calculator.risk_level if tci_risk_score_calculator and tci_risk_score_calculator.risk_level else (tci_recommendation_generator.creditworthiness if tci_recommendation_generator.creditworthiness else '') %}
**Creditworthiness:** <span style="color: {{ credit_color }}; font-weight: bold;">{{ creditworthiness_text if creditworthiness_text else 'N/A' }}</span>

**Recommended Credit Limit:** {% if tci_recommendation_generator.recommended_credit_limit and current_application.requested_amount %}{% set currency_symbol = tci_document_extractor.extracted_data.application_form.contract_details.currency_symbol if tci_document_extractor.extracted_data and tci_document_extractor.extracted_data.application_form and tci_document_extractor.extracted_data.application_form.contract_details and tci_document_extractor.extracted_data.application_form.contract_details.currency_symbol else (tci_document_extractor.extracted_data.financial_statements.currency_symbol if tci_document_extractor.extracted_data and tci_document_extractor.extracted_data.financial_statements and tci_document_extractor.extracted_data.financial_statements.currency_symbol else '') %}{% set currency = tci_document_extractor.extracted_data.application_form.contract_details.currency if tci_document_extractor.extracted_data and tci_document_extractor.extracted_data.application_form and tci_document_extractor.extracted_data.application_form.contract_details and tci_document_extractor.extracted_data.application_form.contract_details.currency else (tci_document_extractor.extracted_data.financial_statements.currency if tci_document_extractor.extracted_data and tci_document_extractor.extracted_data.financial_statements and tci_document_extractor.extracted_data.financial_statements.currency else '') %}{% set req_amt = current_application.requested_amount %}{% set rec_limit = tci_recommendation_generator.recommended_credit_limit %}{% if currency_symbol %}{{ currency_symbol }}{% endif %}{{ "{:,.0f}".format(rec_limit) }}{% if currency %} ({{ currency }}){% endif %}{% if rec_limit < req_amt %} - slightly below requested {% if currency_symbol %}{{ currency_symbol }}{% endif %}{{ "{:,.0f}".format(req_amt) }}{% if currency %} ({{ currency }}){% endif %} to mitigate observed risk factors{% endif %}{% else %}N/A{% endif %}

**Underwriting Recommendation:** {{ tci_recommendation_generator.underwriting_recommendation if tci_recommendation_generator.underwriting_recommendation else 'N/A' }}

{% set confidence_score = tci_recommendation_generator.confidence_score if tci_recommendation_generator and tci_recommendation_generator.confidence_score else None %}
{% if confidence_score is not none %}
  {% if confidence_score >= 80 %}
    {% set confidence_color = "#22c55e" %} {# Green: High Confidence #}
  {% elif confidence_score >= 60 %}
    {% set confidence_color = "#84cc16" %} {# Light Green: Medium-High Confidence #}
  {% elif confidence_score >= 40 %}
    {% set confidence_color = "#f59e0b" %} {# Amber: Medium Confidence #}
  {% elif confidence_score >= 20 %}
    {% set confidence_color = "#f97316" %} {# Orange: Low Confidence #}
  {% else %}
    {% set confidence_color = "#ef4444" %} {# Red: Very Low Confidence #}
  {% endif %}
{% else %}
  {% set confidence_color = "#6b7280" %} {# Gray: N/A #}
{% endif %}
**Confidence Score:** <span style="color: {{ confidence_color }}; font-weight: bold;">{{ confidence_score if confidence_score is not none else 'N/A' }}{% if confidence_score is not none %}%{% endif %}</span>
{% else %}
Recommendation is being generated...
{% endif %}

## Risk Factor Assessment Details

<details>
<summary><strong>üí∞ Financial Health Assessor - Detailed Checks</strong> (Score: {{ tci_financial_health_assessor.score if tci_financial_health_assessor else 'N/A' }}/100, Weight: 22%)</summary>

{% if tci_financial_health_assessor.checks_table %}
{{ tci_financial_health_assessor.checks_table }}
{% else %}
**Assessment:** {{ tci_financial_health_assessor.assessment if tci_financial_health_assessor else 'N/A' }}
{% endif %}

</details>


<details>
<summary><strong>üí≥ Payment Behavior Assessor - Detailed Checks</strong> (Score: {{ tci_payment_behavior_assessor.score if tci_payment_behavior_assessor else 'N/A' }}/100, Weight: 18%)</summary>

{% if tci_payment_behavior_assessor.checks_table %}
{{ tci_payment_behavior_assessor.checks_table }}
{% else %}
**Assessment:** {{ tci_payment_behavior_assessor.assessment if tci_payment_behavior_assessor else 'N/A' }}
{% endif %}

</details>


<details>
<summary><strong>‚≠ê Credit Rating Assessor - Detailed Checks</strong> (Score: {{ tci_credit_rating_assessor.score if tci_credit_rating_assessor else 'N/A' }}/100, Weight: 13%)</summary>

{% if tci_credit_rating_assessor.checks_table %}
{{ tci_credit_rating_assessor.checks_table }}
{% else %}
**Assessment:** {{ tci_credit_rating_assessor.assessment if tci_credit_rating_assessor else 'N/A' }}
{% endif %}

</details>


<details>
<summary><strong>üìÑ Contract Terms Assessor - Detailed Checks</strong> (Score: {{ tci_contract_terms_assessor.score if tci_contract_terms_assessor else 'N/A' }}/100, Weight: 9%)</summary>

{% if tci_contract_terms_assessor.checks_table %}
{{ tci_contract_terms_assessor.checks_table }}
{% else %}
**Assessment:** {{ tci_contract_terms_assessor.assessment if tci_contract_terms_assessor else 'N/A' }}
{% endif %}

</details>


<details>
<summary><strong>üõ°Ô∏è Sanctions & Compliance Assessor - Detailed Checks</strong> (Score: {{ tci_sanctions_compliance_assessor.score if tci_sanctions_compliance_assessor else 'N/A' }}/100, Weight: 4%)</summary>

{% if tci_sanctions_compliance_assessor.checks_table %}
{{ tci_sanctions_compliance_assessor.checks_table }}
{% else %}
**Assessment:** {{ tci_sanctions_compliance_assessor.assessment if tci_sanctions_compliance_assessor else 'N/A' }}
{% endif %}

</details>


<details>
<summary><strong>üè≠ Industry & External Factors Assessor - Detailed Checks</strong> (Score: {{ tci_industry_factors_assessor.score if tci_industry_factors_assessor else 'N/A' }}/100, Weight: 8%)</summary>

{% if tci_industry_factors_assessor.checks_table %}
{{ tci_industry_factors_assessor.checks_table }}
{% else %}
**Assessment:** {{ tci_industry_factors_assessor.assessment if tci_industry_factors_assessor else 'N/A' }}
{% endif %}

</details>


<details>
<summary><strong>üìä Credit Bureau Assessor - Detailed Checks</strong> (Score: {{ tci_credit_bureau_assessor.score if tci_credit_bureau_assessor else 'N/A' }}/100, Weight: 8%)</summary>

{% if tci_credit_bureau_assessor.checks_table %}
{{ tci_credit_bureau_assessor.checks_table }}
{% else %}
**Assessment:** {{ tci_credit_bureau_assessor.assessment if tci_credit_bureau_assessor else 'N/A' }}
{% endif %}

</details>


<details>
<summary><strong>üè¶ Bank Reference Assessor - Detailed Checks</strong> (Score: {{ tci_bank_reference_assessor.score if tci_bank_reference_assessor else 'N/A' }}/100, Weight: 4%)</summary>

{% if tci_bank_reference_assessor.checks_table %}
{{ tci_bank_reference_assessor.checks_table }}
{% else %}
**Assessment:** {{ tci_bank_reference_assessor.assessment if tci_bank_reference_assessor else 'N/A' }}
{% endif %}

</details>


<details>
<summary><strong>üì∞ News Sentiment Assessor - Detailed Checks</strong> (Score: {{ tci_news_sentiment_assessor.score if tci_news_sentiment_assessor else 'N/A' }}/100, Weight: 10%)</summary>

{% if tci_news_sentiment_assessor.checks_table %}
{{ tci_news_sentiment_assessor.checks_table }}
{% else %}
**Assessment:** {{ tci_news_sentiment_assessor.assessment if tci_news_sentiment_assessor else 'N/A' }}
{% endif %}

</details>

Review all risk factor assessments and total risk score above, then select your decision.


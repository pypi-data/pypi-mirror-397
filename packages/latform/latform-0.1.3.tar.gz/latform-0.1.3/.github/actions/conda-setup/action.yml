name: "conda setup"
description: "Prepare a conda environment"
inputs:
  filename:
    description: "Conda environment specification filename"
    required: true
    default: "environment.yml"
  env_name:
    description: "Conda environment name to create"
    required: true
    default: "latform"
  env_var:
    description: "Top level directory environment variable to set"
    required: false
    default: "LATFORM"
  extra_packages:
    description: "Extra packages to install"
    required: false
    default: ""
runs:
  using: "composite"
  steps:
    - name: Setup miniconda
      uses: conda-incubator/setup-miniconda@v3
      with:
        miniforge-version: latest
        activate-environment: ${{ inputs.env_name }}
        use-mamba: true
        channels: conda-forge
        conda-remove-defaults: true

    - name: Update environment
      shell: bash -l {0}
      run: |
        if [ -f "${{ inputs.filename }}" ]; then
          mamba env update -n ${{ inputs.env_name }} -f ${{ inputs.filename }}
        else
          echo "No conda environment file found; skipping. Path: ${{ inputs.filename }}"
        fi

    - name: Install additional packages
      shell: bash -l {0}
      run: |
        if [ -n "${{ inputs.extra_packages }}" ]; then
          mamba install -n ${{ inputs.env_name }} ${{ inputs.extra_packages }}
        fi

    - name: Setup the environment
      shell: bash -l {0}
      run: |
        # Export as environment variable for convenience
        echo "${{ inputs.env_var }}=${{ github.workspace }}" >> "${GITHUB_ENV}"
        # Conda has our main requirements; install testing requirements from pip
        pip install --no-deps .[test,doc]

"""
Tests for metadata forensic analyzer.

Tests the Phase 0 metadata-only analysis that catches
obvious fakes without any ML.
"""

import pytest
from wu.dimensions.metadata import MetadataAnalyzer
from wu.state import DimensionState, Confidence


class TestMetadataAnalyzer:
    """Test MetadataAnalyzer class."""

    @pytest.fixture
    def analyzer(self):
        return MetadataAnalyzer()

    def test_editing_software_list(self, analyzer):
        """Known editing software is tracked."""
        assert "adobe photoshop" in analyzer.EDITING_SOFTWARE
        assert "ffmpeg" in analyzer.EDITING_SOFTWARE
        assert "gimp" in analyzer.EDITING_SOFTWARE

    def test_ai_signatures_list(self, analyzer):
        """AI generation signatures are tracked."""
        assert "dall-e" in analyzer.AI_SIGNATURES
        assert "midjourney" in analyzer.AI_SIGNATURES
        assert "stable diffusion" in analyzer.AI_SIGNATURES
        assert "sora" in analyzer.AI_SIGNATURES

    def test_analyze_nonexistent_file(self, analyzer):
        """Nonexistent file returns UNCERTAIN state."""
        result = analyzer.analyze("/nonexistent/file.jpg")
        assert result.state == DimensionState.UNCERTAIN
        assert result.confidence == Confidence.NA
        assert "not found" in result.evidence[0].finding.lower()


class TestSoftwareDetection:
    """Test editing software detection."""

    @pytest.fixture
    def analyzer(self):
        return MetadataAnalyzer()

    def test_detect_photoshop(self, analyzer):
        """Photoshop signature is detected."""
        metadata = {"Software": "Adobe Photoshop CC 2023"}
        result = analyzer._check_software_signatures(metadata)
        assert result is not None
        assert "photoshop" in result.finding.lower()

    def test_detect_ffmpeg(self, analyzer):
        """FFmpeg signature is detected."""
        metadata = {"Software": "Lavf59.27.100 (ffmpeg)"}
        result = analyzer._check_software_signatures(metadata)
        assert result is not None
        assert "ffmpeg" in result.finding.lower()

    def test_no_software_signature(self, analyzer):
        """Clean file returns None."""
        metadata = {"Software": "Canon EOS Utility"}
        result = analyzer._check_software_signatures(metadata)
        assert result is None


class TestAISignatureDetection:
    """Test AI generation signature detection."""

    @pytest.fixture
    def analyzer(self):
        return MetadataAnalyzer()

    def test_detect_midjourney(self, analyzer):
        """Midjourney signature is detected."""
        metadata = {"Software": "Midjourney v5"}
        result = analyzer._check_ai_signatures(metadata)
        assert result is not None
        assert "midjourney" in result.finding.lower()

    def test_detect_stable_diffusion_params(self, analyzer):
        """Stable Diffusion parameters are detected."""
        metadata = {
            "parameters": "Steps: 20, Sampler: DPM++ 2M, CFG Scale: 7"
        }
        result = analyzer._check_ai_signatures(metadata)
        assert result is not None
        assert "stable diffusion" in result.finding.lower()

    def test_detect_dalle(self, analyzer):
        """DALL-E signature is detected."""
        metadata = {"Comment": "Generated by DALL-E 3"}
        result = analyzer._check_ai_signatures(metadata)
        assert result is not None

    def test_no_ai_signature(self, analyzer):
        """Clean camera file returns None."""
        metadata = {"Software": "Ver.1.0.1", "Make": "Canon"}
        result = analyzer._check_ai_signatures(metadata)
        assert result is None


class TestDeviceResolutionCheck:
    """Test device vs resolution consistency checking."""

    @pytest.fixture
    def analyzer(self):
        return MetadataAnalyzer()

    def test_iphone_6_claiming_8k_is_impossible(self, analyzer):
        """iPhone 6 claiming 8K resolution is caught."""
        metadata = {
            "Make": "Apple",
            "Model": "iPhone 6",
            "_image_width": 7680,
            "_image_height": 4320,
        }
        result = analyzer._check_device_resolution(metadata)
        assert result is not None
        assert "impossible" in result.explanation.lower()

    def test_iphone_6_with_valid_resolution(self, analyzer):
        """iPhone 6 with valid resolution passes."""
        metadata = {
            "Make": "Apple",
            "Model": "iPhone 6",
            "_image_width": 3264,
            "_image_height": 2448,
        }
        result = analyzer._check_device_resolution(metadata)
        assert result is None

    def test_iphone_15_pro_with_4k(self, analyzer):
        """iPhone 15 Pro can do 4K."""
        metadata = {
            "Make": "Apple",
            "Model": "iPhone 15 Pro Max",
            "_image_width": 3840,
            "_image_height": 2160,
        }
        result = analyzer._check_device_resolution(metadata)
        assert result is None

    def test_unknown_device_skipped(self, analyzer):
        """Unknown device is not flagged."""
        metadata = {
            "Make": "UnknownBrand",
            "Model": "UnknownPhone",
            "_image_width": 8000,
            "_image_height": 6000,
        }
        result = analyzer._check_device_resolution(metadata)
        assert result is None


class TestTimestampChecks:
    """Test timestamp consistency checking."""

    @pytest.fixture
    def analyzer(self):
        return MetadataAnalyzer()

    def test_future_timestamp_flagged(self, analyzer):
        """Future timestamp is caught."""
        metadata = {
            "DateTimeOriginal": "2099:12:31 23:59:59"
        }
        result = analyzer._check_timestamps(metadata)
        assert result is not None
        assert "future" in result.finding.lower()

    def test_modification_before_original_flagged(self, analyzer):
        """Modification before original is caught."""
        metadata = {
            "DateTimeOriginal": "2023:06:15 10:30:00",
            "DateTime": "2023:06:14 10:30:00",  # Day before
        }
        result = analyzer._check_timestamps(metadata)
        assert result is not None
        assert "inconsisten" in result.explanation.lower()

    def test_valid_timestamps_pass(self, analyzer):
        """Valid timestamp ordering passes."""
        metadata = {
            "DateTimeOriginal": "2023:06:15 10:30:00",
            "DateTime": "2023:06:16 10:30:00",  # Day after
        }
        result = analyzer._check_timestamps(metadata)
        assert result is None


class TestMetadataStripping:
    """Test detection of stripped metadata."""

    @pytest.fixture
    def analyzer(self):
        return MetadataAnalyzer()

    def test_minimal_metadata_flagged(self, analyzer):
        """Minimal metadata is flagged as stripped."""
        metadata = {
            "_image_width": 1920,
            "_image_height": 1080,
            "ColorSpace": "sRGB",
        }
        assert analyzer._is_metadata_stripped(metadata) is True

    def test_rich_metadata_not_flagged(self, analyzer):
        """Rich metadata is not flagged."""
        metadata = {
            "Make": "Apple",
            "Model": "iPhone 15",
            "DateTimeOriginal": "2023:06:15 10:30:00",
            "Software": "iOS 17",
            "GPSLatitude": "40.7128",
            "GPSLongitude": "-74.0060",
            "ExposureTime": "1/100",
        }
        assert analyzer._is_metadata_stripped(metadata) is False


class TestResolutionNaming:
    """Test resolution name helper."""

    @pytest.fixture
    def analyzer(self):
        return MetadataAnalyzer()

    def test_4k_name(self, analyzer):
        """4K resolution is named correctly."""
        assert analyzer._resolution_name(3840, 2160) == "4K UHD"

    def test_1080p_name(self, analyzer):
        """1080p resolution is named correctly."""
        assert analyzer._resolution_name(1920, 1080) == "1080p"

    def test_720p_name(self, analyzer):
        """720p resolution is named correctly."""
        assert analyzer._resolution_name(1280, 720) == "720p"

    def test_8k_name(self, analyzer):
        """8K resolution is named correctly."""
        assert analyzer._resolution_name(7680, 4320) == "8K"

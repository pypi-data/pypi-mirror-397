"""
Tests for AI generation indicators analysis.

Tests the detection of statistical indicators that may suggest
an image was generated by AI rather than captured by a camera.
"""

import pytest
import tempfile
from pathlib import Path

try:
    import numpy as np
    HAS_NUMPY = True
except ImportError:
    HAS_NUMPY = False

try:
    from PIL import Image
    HAS_PIL = True
except ImportError:
    HAS_PIL = False

try:
    from scipy import fftpack
    HAS_SCIPY = True
except ImportError:
    HAS_SCIPY = False

from wu.dimensions.aigen import (
    AIGenerationAnalyzer,
    AIGenAnalysis,
    FrequencyAnalysis,
    CheckerboardAnalysis,
    NoiseAnalysis,
    ColorAnalysis,
)
from wu.state import DimensionState, Confidence


pytestmark = pytest.mark.skipif(
    not HAS_NUMPY or not HAS_PIL,
    reason="numpy and PIL required for AI generation tests"
)


class TestAIGenerationAnalyzerBasic:
    """Test basic AIGenerationAnalyzer functionality."""

    @pytest.fixture
    def analyzer(self):
        return AIGenerationAnalyzer()

    def test_analyzer_creation(self, analyzer):
        """Analyzer can be created."""
        assert analyzer is not None
        assert analyzer.enable_frequency is True
        assert analyzer.enable_checkerboard is True
        assert analyzer.enable_noise is True
        assert analyzer.enable_color is True

    def test_analyzer_creation_selective(self):
        """Analyzer can be created with selective features."""
        analyzer = AIGenerationAnalyzer(
            enable_frequency=True,
            enable_checkerboard=False,
            enable_noise=True,
            enable_color=False,
        )
        assert analyzer.enable_frequency is True
        assert analyzer.enable_checkerboard is False

    def test_analyze_nonexistent_file(self, analyzer):
        """Analyzing nonexistent file returns uncertain result."""
        result = analyzer.analyze("/nonexistent/file.jpg")
        assert result.dimension == "aigen"
        assert result.state == DimensionState.UNCERTAIN

    def test_analyze_returns_dimension_result(self, analyzer, tmp_path):
        """Analyzer returns DimensionResult."""
        # Create a simple test image
        img = Image.new('RGB', (128, 128), color=(100, 150, 200))
        img_path = tmp_path / "test.jpg"
        img.save(img_path, "JPEG")

        result = analyzer.analyze(str(img_path))
        assert result.dimension == "aigen"
        assert result.state in [
            DimensionState.CONSISTENT,
            DimensionState.SUSPICIOUS,
            DimensionState.UNCERTAIN,
        ]
        assert result.confidence in [
            Confidence.HIGH,
            Confidence.MEDIUM,
            Confidence.LOW,
            Confidence.NA,
        ]

    def test_analyze_has_methodology(self, analyzer, tmp_path):
        """Result includes methodology description."""
        img = Image.new('RGB', (128, 128), color=(100, 150, 200))
        img_path = tmp_path / "test.jpg"
        img.save(img_path, "JPEG")

        result = analyzer.analyze(str(img_path))
        assert result.methodology is not None
        assert "AI generation" in result.methodology


class TestFrequencyAnalysis:
    """Test frequency spectrum analysis."""

    @pytest.fixture
    def analyzer(self):
        return AIGenerationAnalyzer()

    @pytest.mark.skipif(not HAS_SCIPY, reason="scipy required")
    def test_natural_image_frequency(self, analyzer, tmp_path):
        """Natural-like image should have reasonable frequency distribution."""
        # Create image with varied content (more natural-like)
        np.random.seed(42)
        arr = np.random.randint(0, 256, (256, 256, 3), dtype=np.uint8)
        img = Image.fromarray(arr, 'RGB')
        img_path = tmp_path / "noise.jpg"
        img.save(img_path, "JPEG", quality=95)

        result = analyzer.analyze(str(img_path))
        # Random noise should have high frequency content
        assert result.raw_data is not None
        assert "frequency_ratio" in result.raw_data

    @pytest.mark.skipif(not HAS_SCIPY, reason="scipy required")
    def test_smooth_image_frequency(self, analyzer, tmp_path):
        """Very smooth image should have low high-frequency ratio."""
        # Create very smooth gradient
        arr = np.zeros((256, 256, 3), dtype=np.uint8)
        for i in range(256):
            arr[:, i, :] = i
        img = Image.fromarray(arr, 'RGB')
        img_path = tmp_path / "gradient.png"
        img.save(img_path, "PNG")

        result = analyzer.analyze(str(img_path))
        # Smooth gradient has low high-frequency content
        assert result.raw_data is not None
        assert "frequency_ratio" in result.raw_data
        assert result.raw_data["frequency_ratio"] < 0.3


class TestCheckerboardDetection:
    """Test GAN checkerboard artifact detection."""

    @pytest.fixture
    def analyzer(self):
        return AIGenerationAnalyzer()

    @pytest.mark.skipif(not HAS_SCIPY, reason="scipy required")
    def test_no_checkerboard_in_natural_image(self, analyzer, tmp_path):
        """Natural image should not have checkerboard artifacts."""
        np.random.seed(42)
        arr = np.random.randint(0, 256, (256, 256, 3), dtype=np.uint8)
        img = Image.fromarray(arr, 'RGB')
        img_path = tmp_path / "natural.jpg"
        img.save(img_path, "JPEG", quality=95)

        result = analyzer.analyze(str(img_path))
        # Check that no strong checkerboard patterns detected
        if result.raw_data and "checkerboard_periods" in result.raw_data:
            periods = result.raw_data["checkerboard_periods"]
            # May detect weak patterns, but shouldn't dominate findings
            assert periods is None or len(periods) <= 1

    @pytest.mark.skipif(not HAS_SCIPY, reason="scipy required")
    def test_checkerboard_pattern_detection(self, analyzer, tmp_path):
        """Explicit checkerboard pattern should be detected."""
        # Create a checkerboard pattern at period 8
        arr = np.zeros((256, 256, 3), dtype=np.uint8)
        period = 8
        for y in range(256):
            for x in range(256):
                if ((x // period) + (y // period)) % 2 == 0:
                    arr[y, x] = [200, 200, 200]
                else:
                    arr[y, x] = [50, 50, 50]
        img = Image.fromarray(arr, 'RGB')
        img_path = tmp_path / "checkerboard.png"
        img.save(img_path, "PNG")

        result = analyzer.analyze(str(img_path))
        # Strong checkerboard should be detected
        assert result.raw_data is not None


class TestNoiseAnalysis:
    """Test noise pattern analysis."""

    @pytest.fixture
    def analyzer(self):
        return AIGenerationAnalyzer()

    def test_noisy_image_has_variance(self, analyzer, tmp_path):
        """Image with noise should have measurable noise variance."""
        np.random.seed(42)
        # Create noisy image
        base = np.ones((256, 256, 3), dtype=np.float32) * 128
        noise = np.random.normal(0, 20, (256, 256, 3))
        arr = np.clip(base + noise, 0, 255).astype(np.uint8)
        img = Image.fromarray(arr, 'RGB')
        img_path = tmp_path / "noisy.png"
        img.save(img_path, "PNG")

        result = analyzer.analyze(str(img_path))
        assert result.raw_data is not None
        assert "noise_variance" in result.raw_data
        # Should have detectable noise
        if result.raw_data["noise_variance"] is not None:
            assert result.raw_data["noise_variance"] > 0

    def test_clean_image_low_noise(self, analyzer, tmp_path):
        """Very clean image should have low noise variance."""
        # Solid colour image has minimal noise
        img = Image.new('RGB', (256, 256), color=(128, 128, 128))
        img_path = tmp_path / "solid.png"
        img.save(img_path, "PNG")

        result = analyzer.analyze(str(img_path))
        # Solid image has very low noise
        if result.raw_data and result.raw_data.get("noise_variance") is not None:
            assert result.raw_data["noise_variance"] < 10


class TestColorAnalysis:
    """Test colour distribution analysis."""

    @pytest.fixture
    def analyzer(self):
        return AIGenerationAnalyzer()

    def test_varied_color_image(self, analyzer, tmp_path):
        """Image with varied colours should have multiple modes."""
        np.random.seed(42)
        arr = np.random.randint(0, 256, (256, 256, 3), dtype=np.uint8)
        img = Image.fromarray(arr, 'RGB')
        img_path = tmp_path / "varied.png"
        img.save(img_path, "PNG")

        result = analyzer.analyze(str(img_path))
        # Random image should pass colour analysis
        assert result.state in [
            DimensionState.CONSISTENT,
            DimensionState.SUSPICIOUS,
        ]

    def test_grayscale_image_handling(self, analyzer, tmp_path):
        """Grayscale image should be handled correctly."""
        img = Image.new('L', (128, 128), color=128)
        img_path = tmp_path / "gray.png"
        img.save(img_path, "PNG")

        result = analyzer.analyze(str(img_path))
        # Should handle grayscale without error
        assert result.dimension == "aigen"


class TestIndicatorCounting:
    """Test that multiple indicators are counted correctly."""

    @pytest.fixture
    def analyzer(self):
        return AIGenerationAnalyzer()

    def test_num_indicators_in_raw_data(self, analyzer, tmp_path):
        """Number of indicators should be in raw_data."""
        np.random.seed(42)
        arr = np.random.randint(0, 256, (256, 256, 3), dtype=np.uint8)
        img = Image.fromarray(arr, 'RGB')
        img_path = tmp_path / "test.png"
        img.save(img_path, "PNG")

        result = analyzer.analyze(str(img_path))
        assert result.raw_data is not None
        assert "num_indicators" in result.raw_data
        assert "indicators" in result.raw_data
        assert isinstance(result.raw_data["num_indicators"], int)

    def test_suspicious_with_multiple_indicators(self, analyzer, tmp_path):
        """Multiple indicators should result in suspicious state."""
        # Create an image that might trigger multiple indicators
        # Very smooth, uniform noise, smooth histogram
        arr = np.zeros((256, 256, 3), dtype=np.uint8)
        # Smooth gradient
        for i in range(256):
            arr[:, i, :] = i // 2 + 64
        img = Image.fromarray(arr, 'RGB')
        img_path = tmp_path / "smooth.png"
        img.save(img_path, "PNG")

        result = analyzer.analyze(str(img_path))
        # Smooth gradient image should trigger at least one indicator
        # (low noise variance or smooth histogram)
        assert result.raw_data["num_indicators"] >= 1
        assert isinstance(result.raw_data["indicators"], list)


class TestEdgeCases:
    """Test edge cases and error handling."""

    @pytest.fixture
    def analyzer(self):
        return AIGenerationAnalyzer()

    def test_small_image(self, analyzer, tmp_path):
        """Very small image should return uncertain."""
        img = Image.new('RGB', (32, 32), color=(100, 100, 100))
        img_path = tmp_path / "small.png"
        img.save(img_path, "PNG")

        result = analyzer.analyze(str(img_path))
        assert result.state == DimensionState.UNCERTAIN
        assert "too small" in result.evidence[0].finding.lower()

    def test_rgba_image(self, analyzer, tmp_path):
        """RGBA image should be converted and analyzed."""
        img = Image.new('RGBA', (128, 128), color=(100, 150, 200, 255))
        img_path = tmp_path / "rgba.png"
        img.save(img_path, "PNG")

        result = analyzer.analyze(str(img_path))
        assert result.dimension == "aigen"
        # Should not fail
        assert result.state in [
            DimensionState.CONSISTENT,
            DimensionState.SUSPICIOUS,
            DimensionState.UNCERTAIN,
        ]

    def test_corrupted_file(self, analyzer, tmp_path):
        """Corrupted file should return uncertain."""
        img_path = tmp_path / "corrupted.jpg"
        img_path.write_bytes(b"not an image")

        result = analyzer.analyze(str(img_path))
        assert result.state == DimensionState.UNCERTAIN


class TestIntegrationWithAnalyzer:
    """Test integration with main WuAnalyzer."""

    def test_analyzer_with_aigen_enabled(self, tmp_path):
        """WuAnalyzer should include aigen results when enabled."""
        from wu.analyzer import WuAnalyzer

        analyzer = WuAnalyzer(
            enable_metadata=False,
            enable_c2pa=False,
            enable_visual=False,
            enable_aigen=True,
        )

        # Create test image
        img = Image.new('RGB', (128, 128), color=(100, 150, 200))
        img_path = tmp_path / "test.jpg"
        img.save(img_path, "JPEG")

        result = analyzer.analyze(str(img_path))
        assert result.aigen is not None
        assert result.aigen.dimension == "aigen"

    def test_analyzer_aigen_disabled_by_default(self):
        """AI generation analysis should be disabled by default."""
        from wu.analyzer import WuAnalyzer

        analyzer = WuAnalyzer()
        assert analyzer.enable_aigen is False

        result = analyzer.analyze("/nonexistent/file.jpg")
        assert result.aigen is None


class TestDataclasses:
    """Test dataclass structures."""

    def test_frequency_analysis_dataclass(self):
        """FrequencyAnalysis dataclass works correctly."""
        fa = FrequencyAnalysis(
            high_freq_ratio=0.15,
            spectral_rolloff=0.7,
            spectral_centroid=0.4,
            has_unusual_spectrum=False,
            details="Test details",
        )
        assert fa.high_freq_ratio == 0.15
        assert fa.has_unusual_spectrum is False

    def test_checkerboard_analysis_dataclass(self):
        """CheckerboardAnalysis dataclass works correctly."""
        ca = CheckerboardAnalysis(
            detected_periods=[4, 8],
            peak_strengths={4: 2.5, 8: 3.0},
            has_checkerboard=True,
            details="Checkerboard detected",
        )
        assert len(ca.detected_periods) == 2
        assert ca.has_checkerboard is True

    def test_noise_analysis_dataclass(self):
        """NoiseAnalysis dataclass works correctly."""
        na = NoiseAnalysis(
            estimated_variance=5.0,
            uniformity_score=0.3,
            has_natural_noise=True,
            details="Natural noise",
        )
        assert na.estimated_variance == 5.0
        assert na.has_natural_noise is True

    def test_color_analysis_dataclass(self):
        """ColorAnalysis dataclass works correctly."""
        ca = ColorAnalysis(
            histogram_smoothness=0.6,
            num_color_modes=8,
            saturation_distribution="moderate",
            has_natural_colors=True,
            details="Natural colours",
        )
        assert ca.num_color_modes == 8
        assert ca.has_natural_colors is True

    def test_aigen_analysis_dataclass(self):
        """AIGenAnalysis dataclass works correctly."""
        analysis = AIGenAnalysis(
            num_indicators=2,
            indicator_summary=["unusual spectrum", "low noise"],
        )
        assert analysis.num_indicators == 2
        assert len(analysis.indicator_summary) == 2

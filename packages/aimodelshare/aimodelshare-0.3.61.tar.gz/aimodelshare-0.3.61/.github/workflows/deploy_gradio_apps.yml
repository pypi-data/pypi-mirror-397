name: Deploy Moral Compass Apps to Production

on:
  workflow_dispatch:

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: us-central1
  REPO_NAME: moral-compass-apps

jobs:
  # ------------------------------------------------------------
  # Build the universal image ONCE
  # ------------------------------------------------------------
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - id: auth
        name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker Auth
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Build and Push Docker Image
        run: |
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/gradio-universal:${{ github.sha }}"
          echo "Building image: $IMAGE"
          docker build --pull -t "$IMAGE" .
          docker push "$IMAGE"
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV

  # ------------------------------------------------------------
  # Parallel deploy jobs (each exposes its URL as an output)
  # ------------------------------------------------------------
  deploy-tutorial:
    runs-on: ubuntu-latest
    needs: build-and-push
    outputs:
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - name: Auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - name: Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      - name: Deploy tutorial
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: tutorial
          image: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/gradio-universal:${{ github.sha }}
          region: ${{ env.REGION }}
          flags: >-
            --allow-unauthenticated
            --memory=2Gi
            --cpu=2
            --session-affinity
            --concurrency=40
            --min-instances=0
            --max-instances=50
            --timeout=3000
            --set-env-vars=APP_NAME=tutorial,GRADIO_SERVER_NAME=0.0.0.0,GRADIO_ANALYTICS_ENABLED=False,GRADIO_NUM_PORTS=1

  deploy-judge:
    runs-on: ubuntu-latest
    needs: build-and-push
    outputs:
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v2
      - name: Deploy judge
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: judge
          image: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/gradio-universal:${{ github.sha }}
          region: ${{ env.REGION }}
          flags: >-
            --allow-unauthenticated
            --memory=2Gi
            --cpu=2
            --session-affinity
            --concurrency=40
            --min-instances=0
            --max-instances=50
            --timeout=3000
            --set-env-vars=APP_NAME=judge,GRADIO_SERVER_NAME=0.0.0.0,GRADIO_ANALYTICS_ENABLED=False,GRADIO_NUM_PORTS=1

  deploy-ai-consequences:
    runs-on: ubuntu-latest
    needs: build-and-push
    outputs:
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v2
      - name: Deploy ai-consequences
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ai-consequences
          image: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/gradio-universal:${{ github.sha }}
          region: ${{ env.REGION }}
          flags: >-
            --allow-unauthenticated
            --memory=2Gi
            --cpu=2
            --session-affinity
            --concurrency=40
            --min-instances=0
            --max-instances=50
            --timeout=3000
            --set-env-vars=APP_NAME=ai-consequences,GRADIO_SERVER_NAME=0.0.0.0,GRADIO_ANALYTICS_ENABLED=False,GRADIO_NUM_PORTS=1

  deploy-what-is-ai:
    runs-on: ubuntu-latest
    needs: build-and-push
    outputs:
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v2
      - name: Deploy what-is-ai
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: what-is-ai
          image: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/gradio-universal:${{ github.sha }}
          region: ${{ env.REGION }}
          flags: >-
            --allow-unauthenticated
            --memory=2Gi
            --cpu=2
            --session-affinity
            --concurrency=40
            --min-instances=0
            --max-instances=50
            --timeout=3000
            --set-env-vars=APP_NAME=what-is-ai,GRADIO_SERVER_NAME=0.0.0.0,GRADIO_ANALYTICS_ENABLED=False,GRADIO_NUM_PORTS=1

  # Language-specific model building game deployments
  deploy-model-building-game-en:
    runs-on: ubuntu-latest
    needs: build-and-push
    outputs:
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v2
      - name: Deploy model-building-game-en
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: model-building-game-en
          image: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/gradio-universal:${{ github.sha }}
          region: ${{ env.REGION }}
          flags: >-
            --allow-unauthenticated
            --memory=2Gi
            --cpu=2
            --session-affinity
            --concurrency=20
            --min-instances=0
            --max-instances=50
            --timeout=3000
            --set-env-vars=APP_NAME=model-building-game-en,GRADIO_SERVER_NAME=0.0.0.0,GRADIO_ANALYTICS_ENABLED=False,GRADIO_NUM_PORTS=1

  deploy-model-building-game-ca:
    runs-on: ubuntu-latest
    needs: build-and-push
    outputs:
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v2
      - name: Deploy model-building-game-ca
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: model-building-game-ca
          image: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/gradio-universal:${{ github.sha }}
          region: ${{ env.REGION }}
          flags: >-
            --allow-unauthenticated
            --memory=2Gi
            --cpu=2
            --session-affinity
            --concurrency=20
            --min-instances=0
            --max-instances=50
            --timeout=3000
            --set-env-vars=APP_NAME=model-building-game-ca,GRADIO_SERVER_NAME=0.0.0.0,GRADIO_ANALYTICS_ENABLED=False,GRADIO_NUM_PORTS=1

  deploy-model-building-game-es:
    runs-on: ubuntu-latest
    needs: build-and-push
    outputs:
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v2
      - name: Deploy model-building-game-es
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: model-building-game-es
          image: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/gradio-universal:${{ github.sha }}
          region: ${{ env.REGION }}
          flags: >-
            --allow-unauthenticated
            --memory=2Gi
            --cpu=2
            --session-affinity
            --concurrency=20
            --min-instances=0
            --max-instances=50
            --timeout=3000
            --set-env-vars=APP_NAME=model-building-game-es,GRADIO_SERVER_NAME=0.0.0.0,GRADIO_ANALYTICS_ENABLED=False,GRADIO_NUM_PORTS=1

  deploy-ethical-revelation:
    runs-on: ubuntu-latest
    needs: build-and-push
    outputs:
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v2
      - name: Deploy ethical-revelation
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ethical-revelation
          image: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/gradio-universal:${{ github.sha }}
          region: ${{ env.REGION }}
          flags: >-
            --allow-unauthenticated
            --memory=2Gi
            --cpu=2
            --session-affinity
            --concurrency=40
            --min-instances=0
            --max-instances=50
            --timeout=3000
            --set-env-vars=APP_NAME=ethical-revelation,GRADIO_SERVER_NAME=0.0.0.0,GRADIO_ANALYTICS_ENABLED=False,GRADIO_NUM_PORTS=1

  deploy-moral-compass-challenge:
    runs-on: ubuntu-latest
    needs: build-and-push
    outputs:
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v2
      - name: Deploy moral-compass-challenge
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: moral-compass-challenge
          image: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/gradio-universal:${{ github.sha }}
          region: ${{ env.REGION }}
          flags: >-
            --allow-unauthenticated
            --memory=2Gi
            --cpu=2
            --session-affinity
            --concurrency=40
            --min-instances=0
            --max-instances=50
            --timeout=3000
            --set-env-vars=APP_NAME=moral-compass-challenge,GRADIO_SERVER_NAME=0.0.0.0,GRADIO_ANALYTICS_ENABLED=False,GRADIO_NUM_PORTS=1

  # Renamed existing bias-detective deploy job to explicitly deploy part1
  deploy-bias-detective-part1:
    runs-on: ubuntu-latest
    needs: build-and-push
    outputs:
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v2
      - name: Deploy bias-detective (part1)
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: bias-detective-part1
          image: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/gradio-universal:${{ github.sha }}
          region: ${{ env.REGION }}
          flags: >-
            --allow-unauthenticated
            --memory=2Gi
            --cpu=2
            --session-affinity
            --concurrency=20
            --min-instances=0
            --max-instances=50
            --timeout=3000
            --set-env-vars=APP_NAME=bias-detective-part1,GRADIO_SERVER_NAME=0.0.0.0,GRADIO_ANALYTICS_ENABLED=False,GRADIO_NUM_PORTS=1

  # New deploy job for bias-detective part2 (temporary placeholder app)
  deploy-bias-detective-part2:
    runs-on: ubuntu-latest
    needs: build-and-push
    outputs:
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v2
      - name: Deploy bias-detective (part2)
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: bias-detective-part2
          image: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/gradio-universal:${{ github.sha }}
          region: ${{ env.REGION }}
          flags: >-
            --allow-unauthenticated
            --memory=2Gi
            --cpu=2
            --session-affinity
            --concurrency=20
            --min-instances=0
            --max-instances=50
            --timeout=3000
            --set-env-vars=APP_NAME=bias-detective-part2,GRADIO_SERVER_NAME=0.0.0.0,GRADIO_ANALYTICS_ENABLED=False,GRADIO_NUM_PORTS=1

  deploy-fairness-fixer:
    runs-on: ubuntu-latest
    needs: build-and-push
    outputs:
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v2
      - name: Deploy fairness-fixer
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: fairness-fixer
          image: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/gradio-universal:${{ github.sha }}
          region: ${{ env.REGION }}
          flags: >-
            --allow-unauthenticated
            --memory=2Gi
            --cpu=2
            --session-affinity
            --concurrency=20
            --min-instances=0
            --max-instances=50
            --timeout=3000
            --set-env-vars=APP_NAME=fairness-fixer,GRADIO_SERVER_NAME=0.0.0.0,GRADIO_ANALYTICS_ENABLED=False,GRADIO_NUM_PORTS=1

  deploy-justice-equity-upgrade:
    runs-on: ubuntu-latest
    needs: build-and-push
    outputs:
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v2
      - name: Deploy justice-equity-upgrade
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: justice-equity-upgrade
          image: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/gradio-universal:${{ github.sha }}
          region: ${{ env.REGION }}
          flags: >-
            --allow-unauthenticated
            --memory=2Gi
            --cpu=2
            --session-affinity
            --concurrency=20
            --min-instances=0
            --max-instances=50
            --timeout=3000
            --set-env-vars=APP_NAME=justice-equity-upgrade,GRADIO_SERVER_NAME=0.0.0.0,GRADIO_ANALYTICS_ENABLED=False,GRADIO_NUM_PORTS=1

  # ------------------------------------------------------------
  # Collect and publish all deployed service URLs
  # ------------------------------------------------------------
  collect-urls:
    runs-on: ubuntu-latest
    needs:
      - deploy-tutorial
      - deploy-judge
      - deploy-ai-consequences
      - deploy-what-is-ai
      - deploy-model-building-game-en
      - deploy-model-building-game-ca
      - deploy-model-building-game-es
      - deploy-ethical-revelation
      - deploy-moral-compass-challenge
      - deploy-bias-detective-part1
      - deploy-bias-detective-part2
      - deploy-fairness-fixer
      - deploy-justice-equity-upgrade
    steps:
      - name: Generate JSON of deployed URLs
        run: |
          cat > deployed_urls.json <<'EOF'
          {
            "tutorial": "${{ needs.deploy-tutorial.outputs.url }}",
            "judge": "${{ needs.deploy-judge.outputs.url }}",
            "ai-consequences": "${{ needs.deploy-ai-consequences.outputs.url }}",
            "what-is-ai": "${{ needs.deploy-what-is-ai.outputs.url }}",
            "model-building-game-en": "${{ needs.deploy-model-building-game-en.outputs.url }}",
            "model-building-game-ca": "${{ needs.deploy-model-building-game-ca.outputs.url }}",
            "model-building-game-es": "${{ needs.deploy-model-building-game-es.outputs.url }}",
            "ethical-revelation": "${{ needs.deploy-ethical-revelation.outputs.url }}",
            "moral-compass-challenge": "${{ needs.deploy-moral-compass-challenge.outputs.url }}",
            "bias-detective-part1": "${{ needs.deploy-bias-detective-part1.outputs.url }}",
            "bias-detective-part2": "${{ needs.deploy-bias-detective-part2.outputs.url }}",
            "fairness-fixer": "${{ needs.deploy-fairness-fixer.outputs.url }}",
            "justice-equity-upgrade": "${{ needs.deploy-justice-equity-upgrade.outputs.url }}"
          }
          EOF
          echo "Deployed service URLs JSON:"
          cat deployed_urls.json
      - name: Upload deployed_urls.json artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployed-urls
          path: deployed_urls.json
      - name: Append URLs to summary
        run: |
          {
            echo "### Deployed Cloud Run Service URLs"
            echo ""
            echo '```json'
            cat deployed_urls.json
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"

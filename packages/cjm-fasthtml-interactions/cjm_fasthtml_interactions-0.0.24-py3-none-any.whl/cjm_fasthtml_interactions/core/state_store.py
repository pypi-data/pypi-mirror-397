"""Server-side workflow state storage implementations"""

# AUTOGENERATED! DO NOT EDIT! File to edit: ../../nbs/core/state_store.ipynb.

# %% auto 0
__all__ = ['WorkflowStateStore', 'get_session_id', 'InMemoryWorkflowStateStore']

# %% ../../nbs/core/state_store.ipynb 3
import uuid
from typing import Dict, Any, Optional, Protocol, runtime_checkable

# %% ../../nbs/core/state_store.ipynb 5
@runtime_checkable
class WorkflowStateStore(Protocol):
    """Protocol for workflow state storage backends."""
    
    def get_current_step(self,
                         flow_id: str,  # Workflow identifier
                         sess: Any  # FastHTML session object
                        ) -> Optional[str]:  # Current step ID or None
        """Get current step ID for a workflow."""
        ...
    
    def set_current_step(self,
                         flow_id: str,  # Workflow identifier
                         sess: Any,  # FastHTML session object
                         step_id: str  # Step ID to set as current
                        ) -> None:
        """Set current step ID for a workflow."""
        ...
    
    def get_state(self,
                  flow_id: str,  # Workflow identifier
                  sess: Any  # FastHTML session object
                 ) -> Dict[str, Any]:  # Workflow state dictionary
        """Get all workflow state."""
        ...
    
    def update_state(self,
                     flow_id: str,  # Workflow identifier
                     sess: Any,  # FastHTML session object
                     updates: Dict[str, Any]  # State updates to apply
                    ) -> None:
        """Update workflow state with new values."""
        ...
    
    def clear_state(self,
                    flow_id: str,  # Workflow identifier
                    sess: Any  # FastHTML session object
                   ) -> None:
        """Clear all workflow state."""
        ...

# %% ../../nbs/core/state_store.ipynb 7
def get_session_id(
    sess: Any,  # FastHTML session object
    key: str = "_workflow_session_id"  # Session key for storing the ID
) -> str:  # Stable session identifier
    """Get or create a stable session identifier."""
    if key not in sess:
        sess[key] = str(uuid.uuid4())
    return sess[key]

# %% ../../nbs/core/state_store.ipynb 9
class InMemoryWorkflowStateStore:
    """In-memory workflow state storage for development and testing."""
    
    def __init__(self):
        """Initialize empty state storage."""
        self._current_steps: Dict[str, str] = {}  # {flow_id:session_id -> step_id}
        self._states: Dict[str, Dict[str, Any]] = {}  # {flow_id:session_id -> state}
    
    def _make_key(self,
                  flow_id: str,  # Workflow identifier
                  sess: Any  # FastHTML session object
                 ) -> str:  # Composite key for storage
        """Create composite key from flow_id and session."""
        session_id = get_session_id(sess)
        return f"{flow_id}:{session_id}"
    
    def get_current_step(self,
                         flow_id: str,  # Workflow identifier
                         sess: Any  # FastHTML session object
                        ) -> Optional[str]:  # Current step ID or None
        """Get current step ID for a workflow."""
        key = self._make_key(flow_id, sess)
        return self._current_steps.get(key)
    
    def set_current_step(self,
                         flow_id: str,  # Workflow identifier
                         sess: Any,  # FastHTML session object
                         step_id: str  # Step ID to set as current
                        ) -> None:
        """Set current step ID for a workflow."""
        key = self._make_key(flow_id, sess)
        self._current_steps[key] = step_id
    
    def get_state(self,
                  flow_id: str,  # Workflow identifier
                  sess: Any  # FastHTML session object
                 ) -> Dict[str, Any]:  # Workflow state dictionary
        """Get all workflow state."""
        key = self._make_key(flow_id, sess)
        return self._states.get(key, {}).copy()
    
    def update_state(self,
                     flow_id: str,  # Workflow identifier
                     sess: Any,  # FastHTML session object
                     updates: Dict[str, Any]  # State updates to apply
                    ) -> None:
        """Update workflow state with new values."""
        key = self._make_key(flow_id, sess)
        if key not in self._states:
            self._states[key] = {}
        self._states[key].update(updates)
    
    def clear_state(self,
                    flow_id: str,  # Workflow identifier
                    sess: Any  # FastHTML session object
                   ) -> None:
        """Clear all workflow state."""
        key = self._make_key(flow_id, sess)
        self._current_steps.pop(key, None)
        self._states.pop(key, None)

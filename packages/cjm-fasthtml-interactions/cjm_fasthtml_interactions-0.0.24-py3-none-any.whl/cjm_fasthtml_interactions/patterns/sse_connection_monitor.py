"""Pattern for monitoring Server-Sent Events (SSE) connections with visual status indicators and automatic reconnection"""

# AUTOGENERATED! DO NOT EDIT! File to edit: ../../nbs/patterns/sse_connection_monitor.ipynb.

# %% auto 0
__all__ = ['SSEConnectionConfig', 'create_connection_status_indicators', 'SSEConnectionMonitorScript', 'SSEConnectionMonitor']

# %% ../../nbs/patterns/sse_connection_monitor.ipynb 3
from typing import Optional, Dict, Any
from dataclasses import dataclass
from fasthtml.common import *

from ..core.html_ids import InteractionHtmlIds
from cjm_fasthtml_daisyui.components.data_display.status import status, status_colors, status_sizes
from cjm_fasthtml_daisyui.utilities.semantic_colors import text_dui
from cjm_fasthtml_tailwind.utilities.spacing import m
from cjm_fasthtml_tailwind.utilities.typography import font_size
from cjm_fasthtml_tailwind.utilities.layout import display_tw
from cjm_fasthtml_tailwind.core.base import combine_classes

# %% ../../nbs/patterns/sse_connection_monitor.ipynb 5
@dataclass
class SSEConnectionConfig:
    """Configuration for SSE connection monitoring."""
    
    max_reconnect_attempts: int = 10  # Maximum number of reconnection attempts
    reconnect_delay: int = 1000  # Initial reconnect delay in milliseconds
    max_backoff_multiplier: int = 5  # Maximum backoff multiplier for reconnect delay
    monitor_visibility: bool = True  # Monitor tab visibility and reconnect when visible
    log_to_console: bool = True  # Enable console logging for debugging

# %% ../../nbs/patterns/sse_connection_monitor.ipynb 7
def create_connection_status_indicators(
    status_size: str = "sm",  # Size of status indicator dot (xs, sm, md, lg)
    show_text: bool = True,  # Whether to show status text
    text_size: str = "text-sm",  # Text size class
    hide_text_on_mobile: bool = True  # Hide text on small screens
) -> Dict[str, FT]:  # Dictionary of status state to indicator element
    """Create status indicator elements for different connection states."""
    # Map size string to size class
    size_map = {
        "xs": status_sizes.xs,
        "sm": status_sizes.sm,
        "md": status_sizes.md,
        "lg": status_sizes.lg,
    }
    size_cls = size_map.get(status_size, status_sizes.sm)
    
    # Build text classes
    text_classes = [text_size] if text_size else [str(font_size.sm)]
    if hide_text_on_mobile:
        text_classes.extend([display_tw.hidden, display_tw.inline.sm])
    
    def _create_indicator(color_cls, text_cls, label: str) -> FT:
        """Helper to create a status indicator."""
        parts = [
            Span(cls=combine_classes(
                status,
                color_cls,
                size_cls,
                m.r(1),
                m.r(2).sm
            ))
        ]
        
        if show_text:
            parts.append(
                Span(label, cls=combine_classes(text_cls, *text_classes))
            )
        
        return Span(*parts)
    
    return {
        'active': _create_indicator(status_colors.success, text_dui.success, "Live"),
        'disconnected': _create_indicator(status_colors.warning, text_dui.warning, "Disconnected"),
        'error': _create_indicator(status_colors.error, text_dui.error, "Error"),
        'reconnecting': _create_indicator(status_colors.info, text_dui.info, "Reconnecting..."),
    }

# %% ../../nbs/patterns/sse_connection_monitor.ipynb 9
def SSEConnectionMonitorScript(
    connection_id: str,  # Unique identifier for this SSE connection
    status_indicators: Dict[str, FT],  # Status indicator elements for each state
    config: Optional[SSEConnectionConfig] = None  # Configuration options
) -> FT:  # Script element with monitoring code
    """Create a script that monitors SSE connection status and manages reconnection."""
    if config is None:
        config = SSEConnectionConfig()
    
    # Generate HTML IDs
    status_id = InteractionHtmlIds.sse_status(connection_id)
    element_id = InteractionHtmlIds.sse_element(connection_id)
    
    # Convert indicators to HTML strings for JavaScript
    status_html = {
        key: str(indicator)
        for key, indicator in status_indicators.items()
    }
    
    # Build monitoring script
    log_prefix = f"[SSE Monitor: {connection_id}]"
    
    def log(message: str) -> str:
        """Generate console.log statement if logging is enabled."""
        if config.log_to_console:
            return f"console.log('{log_prefix} {message}');"
        return ""
    
    # For log messages with JavaScript variables, build them differently
    def log_with_var(message_template: str) -> str:
        """Generate console.log with JavaScript variable interpolation."""
        if config.log_to_console:
            return f"console.log('{log_prefix} ' + {message_template});"
        return ""
    
    monitor_script = f"""
    (function() {{
        let reconnectAttempts = 0;
        const maxReconnectAttempts = {config.max_reconnect_attempts};
        const reconnectDelay = {config.reconnect_delay};
        const maxBackoffMultiplier = {config.max_backoff_multiplier};
        let isShuttingDown = false;
        const statusElement = document.getElementById('{status_id}');
        const sseElement = document.getElementById('{element_id}');

        const statusIndicators = {{
            active: `{status_html['active']}`,
            disconnected: `{status_html['disconnected']}`,
            error: `{status_html['error']}`,
            reconnecting: `{status_html['reconnecting']}`
        }};

        function updateStatus(state) {{
            if (statusElement && statusIndicators[state]) {{
                statusElement.innerHTML = statusIndicators[state];
            }}
        }}

        // Monitor HTMX SSE events
        document.body.addEventListener('htmx:sseOpen', function(evt) {{
            if (evt.detail.elt === sseElement) {{
                {log('Connection opened')};
                updateStatus('active');
                reconnectAttempts = 0;
            }}
        }});

        document.body.addEventListener('htmx:sseError', function(evt) {{
            if (evt.detail.elt === sseElement) {{
                {log('Connection error')};

                if (isShuttingDown) {{
                    {log('Server is shutting down, not attempting reconnection')};
                    updateStatus('disconnected');
                    return;
                }}

                updateStatus('error');

                if (reconnectAttempts < maxReconnectAttempts) {{
                    const backoff = Math.min(reconnectAttempts + 1, maxBackoffMultiplier);
                    const delay = reconnectDelay * backoff;
                    setTimeout(function() {{
                        reconnectAttempts++;
                        {log_with_var("'Attempting to reconnect... (attempt ' + reconnectAttempts + ')'")};
                        updateStatus('reconnecting');
                        htmx.trigger(sseElement, 'htmx:sseReconnect');
                    }}, delay);
                }} else {{
                    {log('Max reconnection attempts reached')};
                    updateStatus('disconnected');
                }}
            }}
        }});

        document.body.addEventListener('htmx:sseClose', function(evt) {{
            if (evt.detail.elt === sseElement) {{
                {log('Connection closed')};
                updateStatus('disconnected');
            }}
        }});

        document.body.addEventListener('htmx:sseMessage', function(evt) {{
            if (evt.detail.elt === sseElement && evt.detail.event === 'close') {{
                {log_with_var("'Server requested connection close: ' + evt.detail.data")};
                isShuttingDown = true;
                updateStatus('disconnected');
                reconnectAttempts = maxReconnectAttempts;
                if (sseElement._sseEventSource) {{
                    sseElement._sseEventSource.close();
                    delete sseElement._sseEventSource;
                }}
            }}
        }});

        document.body.addEventListener('htmx:oobAfterSwap', function(evt) {{
            if (evt.detail.target && evt.detail.target.id === '{element_id}') {{
                {log('SSE element removed via OOB swap - server shutting down')};
                isShuttingDown = true;
                updateStatus('disconnected');
            }}
        }});

        {'document.addEventListener("visibilitychange", function() {' if config.monitor_visibility else ''}
            {'''if (!document.hidden && sseElement && !isShuttingDown) {''' if config.monitor_visibility else ''}
                {'''const evtSource = sseElement._sseEventSource;''' if config.monitor_visibility else ''}
                {'''if (!evtSource || evtSource.readyState === EventSource.CLOSED) {''' if config.monitor_visibility else ''}
                    {log('Page became visible, reconnecting SSE...') if config.monitor_visibility else ''};
                    {'''updateStatus('reconnecting');''' if config.monitor_visibility else ''}
                    {'''htmx.trigger(sseElement, 'htmx:sseReconnect');''' if config.monitor_visibility else ''}
                {'''}''' if config.monitor_visibility else ''}
            {'''}''' if config.monitor_visibility else ''}
        {'''});''' if config.monitor_visibility else ''}

        // Initial status
        updateStatus('reconnecting');
    }})();
    """
    
    return Script(monitor_script)

# %% ../../nbs/patterns/sse_connection_monitor.ipynb 11
def SSEConnectionMonitor(
    connection_id: str,  # Unique identifier for this SSE connection
    status_size: str = "sm",  # Size of status indicator
    show_text: bool = True,  # Whether to show status text
    hide_text_on_mobile: bool = True,  # Hide text on small screens
    config: Optional[SSEConnectionConfig] = None,  # Configuration options
    container_cls: Optional[str] = None  # Additional CSS classes for status container
) -> tuple[FT, FT]:  # Tuple of (status_container, monitor_script)
    """Create a complete SSE connection monitoring system."""
    # Create status indicators
    indicators = create_connection_status_indicators(
        status_size=status_size,
        show_text=show_text,
        hide_text_on_mobile=hide_text_on_mobile
    )
    
    # Create status container
    status_id = InteractionHtmlIds.sse_status(connection_id)
    status_container = Div(
        # Initial state - will be updated by script
        indicators['reconnecting'],
        id=status_id,
        cls=container_cls
    )
    
    # Create monitor script
    monitor_script = SSEConnectionMonitorScript(
        connection_id=connection_id,
        status_indicators=indicators,
        config=config
    )
    
    return status_container, monitor_script

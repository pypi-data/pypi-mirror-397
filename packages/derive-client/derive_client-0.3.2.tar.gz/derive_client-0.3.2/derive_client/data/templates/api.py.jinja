"""Auto-generated API classes from OpenAPI spec"""

import msgspec

from typing import Callable, Any, List

from derive_client._clients.rest{% if is_async %}.async_http{% else %}.http{% endif %}.session import {% if is_async %}AsyncHTTPSession{% else %}HTTPSession{% endif %}
from derive_client.config import PUBLIC_HEADERS
from derive_client.data_types import EnvConfig
from derive_client._clients.utils import decode_envelope, decode_result, AuthContext, encode_json_exclude_none
from derive_client._clients.rest.endpoints import PublicEndpoints, PrivateEndpoints
from derive_client.data_types.generated_models import (
{% for schema in schema_imports -%}
    {{ schema }},
{% endfor %}
)

class {{ api_prefix }}PublicAPI:
    """{{ api_prefix }} public API methods"""

    def __init__(self, session: {% if is_async %}AsyncHTTPSession{% else %}HTTPSession{% endif %}, config: EnvConfig):
        self._session = session
        self._config = config
        self._endpoints = PublicEndpoints(config.base_url)

    @property
    def headers(self) -> dict:
        return PUBLIC_HEADERS

{% for method in public_methods %}
    {% if is_async %}async {% endif %}def {{ method.name }}(self, params: {{ method.request_type }},) -> {{ method.result_type }}:
        {% if method.description %}
        """
        {{ method.description | format_docstring }}
        """
        {% endif %}

        url = self._endpoints.{{ method.name }}
        data = encode_json_exclude_none(params)
        message = {% if is_async %}await {% endif %}self._session._send_request(url, data, headers=self.headers)
        envelope = decode_envelope(message)
        result = decode_result(envelope, {{ method.result_type | replace('List[', 'list[') }})
        return result
{% endfor %}


class {{ api_prefix }}PrivateAPI:
    """{{ api_prefix }} private API methods"""
    
    def __init__(self, session: {% if is_async %}AsyncHTTPSession{% else %}HTTPSession{% endif %}, config: EnvConfig, auth: AuthContext):
        self._session = session
        self._config = config
        self._auth = auth
        self._endpoints = PrivateEndpoints(config.base_url)

    @property
    def headers(self) -> dict:
        return {**PUBLIC_HEADERS, **self._auth.signed_headers}

{% for method in private_methods %}
    {% if is_async %}async {% endif %}def {{ method.name }}(self, params: {{ method.request_type }},) -> {{ method.result_type }}:
        {% if method.description %}
        """
        {{ method.description | format_docstring }}
        """
        {% endif %}

        url = self._endpoints.{{ method.name }}
        data = encode_json_exclude_none(params)
        message = {% if is_async %}await {% endif %}self._session._send_request(url, data, headers=self.headers)
        envelope = decode_envelope(message)
        result = decode_result(envelope, {{ method.result_type | replace('List[', 'list[') }})
        return result
{% endfor %}
import importlib.resources as resources
import os
import re
import secrets
from pathlib import Path

from django.conf import settings
from django.contrib.auth import get_user_model
from django.contrib.sites.models import Site
from django.core.management import BaseCommand, call_command

from core.models import Board, SiteProfile
from djangochan import sample as sample_cfg


class Command(BaseCommand):
    help = "Bootstrap djangochan: create env, migrate, create admin, optional sample data."

    def add_arguments(self, parser):
        parser.add_argument(
            "--admin-password",
            dest="admin_password",
            help="Password for admin user (default: autogenerated).",
        )
        parser.add_argument(
            "--sample-data",
            action="store_true",
            dest="sample_data",
            help="Load sample site/boards defined in djangochan/sample.py.",
        )
        parser.add_argument(
            "--skip-collectstatic",
            action="store_true",
            dest="skip_collectstatic",
            help="Skip running collectstatic.",
        )

    def handle(self, *args, **options):
        workdir = Path.cwd()
        env_path = workdir / ".env"

        admin_password = options.get("admin_password") or secrets.token_urlsafe(10)
        secret_key = os.environ.get("SECRET_KEY") or secrets.token_urlsafe(50)

        self._ensure_env(env_path, admin_password, secret_key)

        # Ensure media/static directories exist.
        for path in (settings.MEDIA_ROOT, settings.STATIC_ROOT):
            if path:
                Path(path).mkdir(parents=True, exist_ok=True)

        self.stdout.write("Applying migrations...")
        call_command("migrate", interactive=False)

        User = get_user_model()
        admin_user, created = User.objects.get_or_create(
            username="admin", defaults={"email": "", "is_superuser": True, "is_staff": True}
        )
        if created:
            admin_user.set_password(admin_password)
            admin_user.save()
            self.stdout.write(
                self.style.SUCCESS(f"Created admin user 'admin' with password: {admin_password}")
            )
        else:
            self.stdout.write("Admin user already exists; skipping creation.")

        if not options.get("skip_collectstatic"):
            self.stdout.write("Collecting static files...")
            call_command("collectstatic", interactive=False, verbosity=0)

        if options.get("sample_data"):
            self._load_sample_data()

        self.stdout.write(self.style.SUCCESS("Bootstrap complete."))

    def _ensure_env(self, env_path: Path, admin_password: str, secret_key: str):
        if env_path.exists():
            return

        try:
            template = resources.files("djangochan").joinpath(".env.dist").read_text()
        except (FileNotFoundError, IsADirectoryError):
            template = (
                "SECRET_KEY=''\n"
                "DEBUG=True\n"
                "ADMIN_PASS=''\n"
                "CAPTCHA=False\n"
                "API_ON=True\n"
                "WWW_ON=True\n"
                'ALLOWED_HOSTS="127.0.0.1 localhost"\n'
            )

        replacements = {
            "SECRET_KEY": secret_key,
            "ADMIN_PASS": admin_password,
        }
        for key, value in replacements.items():
            template = re.sub(
                rf"^{key}=.*$",
                f"{key}='{value}'",
                template,
                flags=re.MULTILINE,
            )

        env_path.write_text(template)
        self.stdout.write(self.style.SUCCESS(f"Created {env_path}"))

    def _load_sample_data(self):
        site_id = getattr(settings, "SITE_ID", 1)
        site_obj, _ = Site.objects.get_or_create(
            id=site_id,
            defaults={"domain": sample_cfg.SITE_DOMAIN, "name": sample_cfg.SITE_TITLE},
        )
        SiteProfile.objects.update_or_create(
            site=site_obj,
            defaults={
                "title": sample_cfg.SITE_TITLE,
                "description": sample_cfg.SITE_DESCRIPTION,
                "issue": sample_cfg.SITE_ISSUE,
            },
        )

        created, existing = 0, 0
        for slug, name in sample_cfg.BOARDS.items():
            board, was_created = Board.objects.get_or_create(
                ln=slug, defaults={"name": name, "description": sample_cfg.BOARD_DESCRIPTIONS.get(slug, "")}
            )
            created += 1 if was_created else 0
            existing += 0 if was_created else 1

        self.stdout.write(
            self.style.SUCCESS(
                f"Sample data loaded: {created} boards created ({existing} already existed), site profile updated."
            )
        )

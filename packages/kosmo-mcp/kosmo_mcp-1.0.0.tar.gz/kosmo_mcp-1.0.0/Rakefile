desc "Full Audit and Push to Production"
task :pushtoprod do
  puts "ğŸ¦‰ Athena: Initiating ZOO Audit..."
  
  # 1. Pincer Verification
  puts "ğŸ”’ Verifying SYSTEM_LOCK..."
  if File.read("KOSMO.md").include?("SYSTEM_LOCK = UNLOCKED")
    abort "âŒ FAILURE: SYSTEM_LOCK is set to UNLOCKED. Cannot push to production."
  end
  puts "âœ… SYSTEM_LOCK is LOCKED."

  # 2. Pipeline Audit
  puts "ğŸ•µï¸ Running Pipeline Audit..."
  sh "bash .agent/workflows/auditpipelines.sh" rescue nil # Assuming script exists or we simulate
  
  # 3. Sync Secrets (Optional - only if Supabase CLI is available)
  puts "ğŸ”‘ Checking for Supabase CLI..."
  if system("which supabase > /dev/null 2>&1")
    puts "ğŸ“¦ Supabase CLI found. Syncing secrets..."
    sh "supabase secrets set --env-file .env --project-ref $SUPABASE_PROJECT_ID"
    
    # 4. Deploy to Supabase
    puts "ğŸš€ Deploying to Supabase..."
    sh "supabase functions deploy agency-filter --project-ref $SUPABASE_PROJECT_ID"
  else
    puts "âš ï¸  Supabase CLI not found. Skipping cloud deployment."
    puts "ğŸ“ Using local Docker deployment instead."
    sh "docker-compose up -d"
  end
  
  puts "âœ… Deployment Complete. The Fiber is lit."
end

desc "Local Simulation"
task :localtest do
  puts "ğŸ§ª Starting Local Simulation..."
  sh "docker-compose up -d"
  puts "âœ… Backend UP."
  puts "ğŸ”Œ Registering Gatekeeper (Localhost)..."
  sh "export HERMIOS_API=http://localhost:8000 && bash launch_hermios.sh"
end

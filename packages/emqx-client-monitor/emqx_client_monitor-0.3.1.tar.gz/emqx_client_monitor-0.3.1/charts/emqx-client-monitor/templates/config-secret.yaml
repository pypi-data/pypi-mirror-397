{{- if not .Values.config.existingSecret }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "emqx-client-monitor.configSecretName" . }}
  labels:
    {{- include "emqx-client-monitor.labels" . | nindent 4 }}
type: Opaque
stringData:
  config.yaml: |
    emqx:
      api_key: {{ required "config.targetEmqx.apiKey is required" .Values.config.targetEmqx.api_key | quote }}
      api_secret: {{ required "config.targetEmqx.apiSecret is required" .Values.config.targetEmqx.api_secret | quote }}
      api_url: {{ .Values.config.targetEmqx.api_url | quote }}
      ssl: {{- if kindIs "string" .Values.config.targetEmqx.ssl }} {{ .Values.config.targetEmqx.ssl | quote }} {{- else }} {{ .Values.config.targetEmqx.ssl }} {{- end }}
      alias: {{ .Values.config.targetEmqx.alias | quote }}
{{- with .Values.config.targetEmqx.extraOptions }}
{{ toYaml . | indent 6 }}
{{- end }}
    monitored_clients:{{- if .Values.config.monitoredClients }}
{{- range .Values.config.monitoredClients }}
      - alias: {{ required "monitored client alias required" .alias | quote }}
        client_id: {{ required "monitored client client_id required" .client_id | quote }}
{{- end }}
{{- else }} []
{{- end }}
    prometheus:
      port: {{ if not .Values.config.prometheusExporter.port }}{{ .Values.service.port }}{{ else }}{{ .Values.config.prometheusExporter.port }}{{ end }}
      address: {{ .Values.config.prometheusExporter.address | quote }}
{{- with .Values.config.prometheusExporter.extraOptions }}
{{ toYaml . | indent 6 }}
{{- end }}
{{- end }}

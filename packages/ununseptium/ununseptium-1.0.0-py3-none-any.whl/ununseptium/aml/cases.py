"""Case management for AML.

Provides alert and case management functionality for
investigating and tracking suspicious activity.
"""

from __future__ import annotations

from datetime import UTC, datetime
from enum import Enum
from typing import Any
from uuid import uuid4

from pydantic import BaseModel, Field


class AlertSeverity(str, Enum):
    """Severity levels for alerts."""

    LOW = "low"
    MEDIUM = "medium"
    HIGH = "high"
    CRITICAL = "critical"


class AlertStatus(str, Enum):
    """Status of an alert."""

    NEW = "new"
    UNDER_REVIEW = "under_review"
    ESCALATED = "escalated"
    DISMISSED = "dismissed"
    CONVERTED = "converted"  # Converted to case


class CaseStatus(str, Enum):
    """Status of a case."""

    OPEN = "open"
    UNDER_INVESTIGATION = "under_investigation"
    PENDING_REVIEW = "pending_review"
    ESCALATED = "escalated"
    CLOSED_NO_ACTION = "closed_no_action"
    CLOSED_SAR_FILED = "closed_sar_filed"
    CLOSED_OTHER = "closed_other"


class CasePriority(str, Enum):
    """Priority levels for cases."""

    LOW = "low"
    MEDIUM = "medium"
    HIGH = "high"
    URGENT = "urgent"


class Alert(BaseModel):
    """An alert generated by monitoring.

    Attributes:
        id: Alert identifier.
        alert_type: Type of alert.
        severity: Severity level.
        status: Current status.
        title: Alert title.
        description: Detailed description.
        entity_id: Related entity ID.
        transaction_ids: Related transaction IDs.
        typology_match_id: Related typology match ID.
        score: Alert score (0.0 to 1.0).
        reason_codes: Contributing factors.
        created_at: Creation timestamp.
        updated_at: Last update timestamp.
        assigned_to: Assigned analyst.
        case_id: Linked case ID.
        metadata: Additional data.
    """

    id: str = Field(default_factory=lambda: f"ALT-{uuid4().hex[:8].upper()}")
    alert_type: str
    severity: AlertSeverity = AlertSeverity.MEDIUM
    status: AlertStatus = AlertStatus.NEW
    title: str
    description: str = ""
    entity_id: str | None = None
    transaction_ids: list[str] = Field(default_factory=list)
    typology_match_id: str | None = None
    score: float = Field(default=0.5, ge=0.0, le=1.0)
    reason_codes: list[dict[str, Any]] = Field(default_factory=list)
    created_at: datetime = Field(default_factory=datetime.utcnow)
    updated_at: datetime = Field(default_factory=datetime.utcnow)
    assigned_to: str | None = None
    case_id: str | None = None
    metadata: dict[str, Any] = Field(default_factory=dict)

    def escalate(self) -> None:
        """Escalate the alert."""
        self.status = AlertStatus.ESCALATED
        self.updated_at = datetime.now(UTC)

    def dismiss(self, reason: str | None = None) -> None:
        """Dismiss the alert.

        Args:
            reason: Dismissal reason.
        """
        self.status = AlertStatus.DISMISSED
        self.updated_at = datetime.now(UTC)
        if reason:
            self.metadata["dismissal_reason"] = reason

    def convert_to_case(self, case_id: str) -> None:
        """Mark alert as converted to case.

        Args:
            case_id: ID of the created case.
        """
        self.status = AlertStatus.CONVERTED
        self.case_id = case_id
        self.updated_at = datetime.now(UTC)


class CaseNote(BaseModel):
    """A note on a case.

    Attributes:
        id: Note identifier.
        content: Note content.
        author: Note author.
        created_at: Creation timestamp.
        note_type: Type of note.
    """

    id: str = Field(default_factory=lambda: f"NOTE-{uuid4().hex[:8].upper()}")
    content: str
    author: str
    created_at: datetime = Field(default_factory=datetime.utcnow)
    note_type: str = "general"


class CaseAction(BaseModel):
    """An action taken on a case.

    Attributes:
        id: Action identifier.
        action_type: Type of action.
        description: Action description.
        performed_by: Who performed the action.
        performed_at: When action was performed.
        metadata: Additional action data.
    """

    id: str = Field(default_factory=lambda: f"ACT-{uuid4().hex[:8].upper()}")
    action_type: str
    description: str
    performed_by: str
    performed_at: datetime = Field(default_factory=datetime.utcnow)
    metadata: dict[str, Any] = Field(default_factory=dict)


class Case(BaseModel):
    """An investigation case.

    Attributes:
        id: Case identifier.
        title: Case title.
        description: Case description.
        status: Current status.
        priority: Case priority.
        entity_ids: Related entity IDs.
        alert_ids: Source alert IDs.
        transaction_ids: Related transaction IDs.
        assigned_to: Assigned investigator.
        created_at: Creation timestamp.
        updated_at: Last update timestamp.
        due_date: Investigation due date.
        notes: Case notes.
        actions: Actions taken.
        evidence: Evidence references.
        findings: Investigation findings.
        recommendation: Final recommendation.
        metadata: Additional data.
    """

    id: str = Field(default_factory=lambda: f"CASE-{uuid4().hex[:8].upper()}")
    title: str
    description: str = ""
    status: CaseStatus = CaseStatus.OPEN
    priority: CasePriority = CasePriority.MEDIUM
    entity_ids: list[str] = Field(default_factory=list)
    alert_ids: list[str] = Field(default_factory=list)
    transaction_ids: list[str] = Field(default_factory=list)
    assigned_to: str | None = None
    created_at: datetime = Field(default_factory=datetime.utcnow)
    updated_at: datetime = Field(default_factory=datetime.utcnow)
    due_date: datetime | None = None
    notes: list[CaseNote] = Field(default_factory=list)
    actions: list[CaseAction] = Field(default_factory=list)
    evidence: list[str] = Field(default_factory=list)
    findings: str | None = None
    recommendation: str | None = None
    metadata: dict[str, Any] = Field(default_factory=dict)

    def add_note(self, content: str, author: str, note_type: str = "general") -> CaseNote:
        """Add a note to the case.

        Args:
            content: Note content.
            author: Note author.
            note_type: Type of note.

        Returns:
            Created CaseNote.
        """
        note = CaseNote(content=content, author=author, note_type=note_type)
        self.notes.append(note)
        self.updated_at = datetime.now(UTC)
        return note

    def add_action(
        self,
        action_type: str,
        description: str,
        performed_by: str,
    ) -> CaseAction:
        """Record an action on the case.

        Args:
            action_type: Type of action.
            description: Action description.
            performed_by: Who performed it.

        Returns:
            Created CaseAction.
        """
        action = CaseAction(
            action_type=action_type,
            description=description,
            performed_by=performed_by,
        )
        self.actions.append(action)
        self.updated_at = datetime.now(UTC)
        return action

    def assign(self, assignee: str) -> None:
        """Assign the case to an investigator.

        Args:
            assignee: Assignee identifier.
        """
        self.assigned_to = assignee
        self.status = CaseStatus.UNDER_INVESTIGATION
        self.updated_at = datetime.now(UTC)

    def close(
        self,
        status: CaseStatus,
        findings: str,
        recommendation: str,
    ) -> None:
        """Close the case.

        Args:
            status: Closing status.
            findings: Investigation findings.
            recommendation: Final recommendation.
        """
        self.status = status
        self.findings = findings
        self.recommendation = recommendation
        self.updated_at = datetime.now(UTC)


class CaseManager:
    """Manage alerts and cases.

    Provides functionality for creating and managing alerts
    and cases throughout the investigation lifecycle.

    Example:
        ```python
        from ununseptium.aml import CaseManager, Alert, AlertSeverity

        manager = CaseManager()

        # Create an alert
        alert = Alert(
            alert_type="high_value_transaction",
            severity=AlertSeverity.HIGH,
            title="Unusual large transaction",
            transaction_ids=["TXN-001"]
        )
        manager.add_alert(alert)

        # Convert to case
        case = manager.create_case_from_alerts([alert.id])
        case.assign("analyst@example.com")
        ```
    """

    def __init__(self) -> None:
        """Initialize the case manager."""
        self._alerts: dict[str, Alert] = {}
        self._cases: dict[str, Case] = {}

    def add_alert(self, alert: Alert) -> None:
        """Add an alert to the system.

        Args:
            alert: Alert to add.
        """
        self._alerts[alert.id] = alert

    def get_alert(self, alert_id: str) -> Alert | None:
        """Get an alert by ID.

        Args:
            alert_id: Alert identifier.

        Returns:
            Alert if found, None otherwise.
        """
        return self._alerts.get(alert_id)

    def list_alerts(
        self,
        *,
        status: AlertStatus | None = None,
        severity: AlertSeverity | None = None,
    ) -> list[Alert]:
        """List alerts with optional filtering.

        Args:
            status: Filter by status.
            severity: Filter by severity.

        Returns:
            List of matching alerts.
        """
        alerts = list(self._alerts.values())

        if status:
            alerts = [a for a in alerts if a.status == status]
        if severity:
            alerts = [a for a in alerts if a.severity == severity]

        return sorted(alerts, key=lambda a: a.created_at, reverse=True)

    def create_case_from_alerts(
        self,
        alert_ids: list[str],
        *,
        title: str | None = None,
        priority: CasePriority | None = None,
    ) -> Case:
        """Create a case from one or more alerts.

        Args:
            alert_ids: IDs of alerts to include.
            title: Case title (auto-generated if not provided).
            priority: Case priority.

        Returns:
            Created Case.
        """
        alerts = [self._alerts[aid] for aid in alert_ids if aid in self._alerts]

        if not alerts:
            msg = "No valid alerts found"
            raise ValueError(msg)

        # Aggregate data from alerts
        entity_ids: set[str] = set()
        transaction_ids: set[str] = set()
        max_severity = AlertSeverity.LOW

        for alert in alerts:
            if alert.entity_id:
                entity_ids.add(alert.entity_id)
            transaction_ids.update(alert.transaction_ids)

            if self._severity_rank(alert.severity) > self._severity_rank(max_severity):
                max_severity = alert.severity

        # Determine priority from severity
        if priority is None:
            priority = self._severity_to_priority(max_severity)

        # Generate title if not provided
        if title is None:
            title = f"Case from {len(alerts)} alert(s)"

        case = Case(
            title=title,
            priority=priority,
            entity_ids=list(entity_ids),
            alert_ids=[a.id for a in alerts],
            transaction_ids=list(transaction_ids),
        )

        # Update alerts
        for alert in alerts:
            alert.convert_to_case(case.id)

        self._cases[case.id] = case
        return case

    def get_case(self, case_id: str) -> Case | None:
        """Get a case by ID.

        Args:
            case_id: Case identifier.

        Returns:
            Case if found, None otherwise.
        """
        return self._cases.get(case_id)

    def list_cases(
        self,
        *,
        status: CaseStatus | None = None,
        priority: CasePriority | None = None,
        assigned_to: str | None = None,
    ) -> list[Case]:
        """List cases with optional filtering.

        Args:
            status: Filter by status.
            priority: Filter by priority.
            assigned_to: Filter by assignee.

        Returns:
            List of matching cases.
        """
        cases = list(self._cases.values())

        if status:
            cases = [c for c in cases if c.status == status]
        if priority:
            cases = [c for c in cases if c.priority == priority]
        if assigned_to:
            cases = [c for c in cases if c.assigned_to == assigned_to]

        return sorted(cases, key=lambda c: c.created_at, reverse=True)

    def _severity_rank(self, severity: AlertSeverity) -> int:
        """Get numeric rank for severity."""
        return {
            AlertSeverity.LOW: 1,
            AlertSeverity.MEDIUM: 2,
            AlertSeverity.HIGH: 3,
            AlertSeverity.CRITICAL: 4,
        }.get(severity, 0)

    def _severity_to_priority(self, severity: AlertSeverity) -> CasePriority:
        """Convert alert severity to case priority."""
        return {
            AlertSeverity.LOW: CasePriority.LOW,
            AlertSeverity.MEDIUM: CasePriority.MEDIUM,
            AlertSeverity.HIGH: CasePriority.HIGH,
            AlertSeverity.CRITICAL: CasePriority.URGENT,
        }.get(severity, CasePriority.MEDIUM)

name: Test platform

on:
  workflow_call:
    inputs:
      python-versions:
        required: true
        type: string
      runner:
        required: true
        type: string
      os:
        required: true
        type: string
      target:
        required: true
        type: string
      features:
        required: false
        type: string
        default: ""

jobs:
  test:
    runs-on: ${{ inputs.runner }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        python-version: ${{ fromJson(inputs.python-versions) }}
    defaults:
      run:
        working-directory: .
    steps:
      - uses: actions/checkout@v4

      - name: Install just
        uses: taiki-e/install-action@64adfd9e935fa438859b9e080fd026720b2ba070

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ matrix.python-version }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@f13886b937689c021905a6b90929199931d60db1
        with:
          workspaces: .
          key: ${{ inputs.os }}-${{ inputs.target }}-${{ matrix.python-version }}

      - name: Create venv and install dependencies
        run: uv sync --group test

      - name: Build and install extension
        run: uv run --no-sync --frozen maturin develop --release ${{ inputs.features }}

      - name: Run tests
        run: uv run --no-sync --frozen pytest -s -v

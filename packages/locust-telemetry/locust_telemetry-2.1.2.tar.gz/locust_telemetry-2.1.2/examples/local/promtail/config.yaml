server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  - job_name: locust
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s

    relabel_configs:
      # Only keep locust master and worker containers
      - source_labels: [ __meta_docker_container_name ]
        regex: "/(locust-master|locust-worker.*)"
        action: keep

      # Normalize worker names to "locust-worker"
      - source_labels: [ __meta_docker_container_name ]
        regex: "/locust-worker[0-9]+"
        replacement: "locust-worker"
        target_label: container

      # Keep master as "locust-master"
      - source_labels: [ __meta_docker_container_name ]
        regex: "/locust-master"
        replacement: "locust-master"
        target_label: container

      # Optional: add image label
      - source_labels: [ __meta_docker_image ]
        target_label: image

    pipeline_stages:
      - json:
          expressions:
            run_id: telemetry.run_id
            recorder: telemetry.recorder
            testplan: telemetry.testplan
            telemetry_type: telemetry.telemetry_type
            telemetry_name: telemetry.telemetry_name
            level: telemetry.level
            message: telemetry.message
            ts: telemetry.time

      # Add labels for indexing (only low-cardinality fields)
      - labels:
          run_id: run_id
          testplan: testplan
          recorder: recorder
          telemetry_type: telemetry_type
          telemetry_name: telemetry_name

      # Drop any logs that do not have run_id (i.e., non-metric logs)
      - match:
          selector: '{run_id=""}'
          action: drop

      # Set the log timestamp for Grafana
      - timestamp:
          source: ts
          format: RFC3339

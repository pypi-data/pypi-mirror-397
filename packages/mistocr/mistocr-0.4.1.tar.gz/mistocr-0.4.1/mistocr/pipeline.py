"""End-to-End Pipeline: PDF OCR, Markdown Heading Correction, and AI Image Descriptions"""

# AUTOGENERATED! DO NOT EDIT! File to edit: ../nbs/02_pipeline.ipynb.

# %% auto 0
__all__ = ['logger', 'pdf_to_md']

# %% ../nbs/02_pipeline.ipynb 3
from fastcore.all import *
from .core import read_pgs, ocr_pdf
from .refine import add_img_descs, fix_hdgs
from pathlib import Path
from asyncio import Semaphore, gather, sleep
import tempfile
import os, json, shutil
import logging

# %% ../nbs/02_pipeline.ipynb 4
logger = logging.getLogger(__name__)
logging.basicConfig(level=logging.WARNING, format='%(name)s - %(levelname)s - %(message)s')
logger.setLevel(logging.INFO)

# %% ../nbs/02_pipeline.ipynb 5
@delegates(add_img_descs)
async def pdf_to_md(
    pdf_path:str,                   # Path to input PDF file
    dst:str,                        # Destination directory for output markdown
    ocr_dst:str=None,               # Optional OCR output directory
    model:str='claude-sonnet-4-5',  # Model to use for heading fixes and image descriptions
    add_img_desc:bool=True,         # Whether to add image descriptions
    progress:bool=True,             # Whether to show progress messages
    **kwargs
    ):
    "Convert PDF to markdown with OCR, fixed heading hierarchy, and optional image descriptions"
    "Convert PDF to markdown with OCR, fixed heading hierarchy, and optional image descriptions"
    cleanup = ocr_dst is None
    if cleanup: ocr_dst = tempfile.mkdtemp()
    n_steps = 3 if add_img_desc else 2
    if progress: logger.info(f"Step 1/{n_steps}: Running OCR on {pdf_path}...")
    ocr_dir = ocr_pdf(pdf_path, ocr_dst)[0]
    if progress: logger.info(f"Step 2/{n_steps}: Fixing heading hierarchy...")
    fix_hdgs(ocr_dir, model=model)
    if add_img_desc:
        if progress: logger.info(f"Step 3/{n_steps}: Adding image descriptions...")
        await add_img_descs(ocr_dir, dst=dst, model=model, progress=progress, **kwargs)
    elif dst != str(ocr_dir): shutil.copytree(ocr_dir, dst, dirs_exist_ok=True)
    if cleanup: shutil.rmtree(ocr_dst)
    if progress: logger.info("Done!")

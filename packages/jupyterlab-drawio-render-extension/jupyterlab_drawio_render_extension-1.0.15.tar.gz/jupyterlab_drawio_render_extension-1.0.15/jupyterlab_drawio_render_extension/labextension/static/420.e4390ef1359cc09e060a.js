"use strict";(self.webpackChunkjupyterlab_drawio_render_extension=self.webpackChunkjupyterlab_drawio_render_extension||[]).push([[420],{420(e,t,i){i.r(t),i.d(t,{default:()=>E});var o=i(223),n=i(409),a=i(176),r=i(262),s=i(247),d=i(292);let c=null,l="default",h="#ffffff",g=300,w="white";const m=new Set;function p(e){return new Promise((t,i)=>{const o=document.createElement("script");o.onload=()=>t(),o.onerror=()=>i(new Error(`Failed to load script: ${e}`)),o.src=e,document.head.appendChild(o)})}class u extends s.Widget{constructor(e){super(),this._ready=new r.PromiseDelegate,this._context=e,this.addClass("jp-DrawioWidget"),this.title.label=e.localPath,this._container=document.createElement("div"),this._container.className="jp-DrawioWidget-container",this._errorDiv=document.createElement("div"),this._errorDiv.className="jp-DrawioWidget-error",this._errorDiv.style.display="none",this.node.appendChild(this._errorDiv),this.node.appendChild(this._container),m.add(this),this.updateBackground(l,h),this._loadDiagram(),e.ready.then(()=>{e.model.contentChanged.connect(this._onContentChanged,this)})}get ready(){return this._ready.promise}updateBackground(e,t){this.node.classList.remove("jp-DrawioWidget-bg-default","jp-DrawioWidget-bg-black","jp-DrawioWidget-bg-white","jp-DrawioWidget-bg-custom"),"custom"===e&&t?(this.node.style.setProperty("--jp-drawio-custom-bg",t),this.node.classList.add("jp-DrawioWidget-bg-custom")):(this.node.style.removeProperty("--jp-drawio-custom-bg"),this.node.classList.add(`jp-DrawioWidget-bg-${e}`))}async _loadDiagram(){try{this._container.innerHTML='\n        <div class="jp-DrawioWidget-loading">\n          <div>Loading Draw.io diagram...</div>\n        </div>\n      ',await this._context.ready;const e=this._context.model.toString();if(!e||""===e.trim())throw new Error("Empty diagram file");await this._renderDiagram(e),this._ready.resolve()}catch(e){this._showError(e),this._ready.reject(e)}}async _renderDiagram(e){if(await(c||(c=(async()=>{if(window.GraphViewer)return;window.mxLoadResources=!1,window.mxLoadStylesheets=!1,window.mxBasePath="",window.mxImageBasePath="",window.STENCIL_PATH="",window.SHAPES_PATH="",window.STYLE_PATH="",window.PROXY_URL="",window.DRAW_MATH_URL="",window.GRAPH_IMAGE_PATH="";const e=`${d.PageConfig.getBaseUrl()}jupyterlab-drawio-render-extension/static`;await p(`${e}/viewer-static.min.js`),await new Promise(e=>setTimeout(e,100)),await p(`${e}/shapes.min.js`),await p(`${e}/stencils.min.js`),await new Promise(e=>setTimeout(e,100))})(),c)),!window.GraphViewer)throw new Error("GraphViewer not available - viewer library failed to load");this._container.innerHTML="",this._errorDiv.style.display="none",this._container.style.display="block";const t=document.createElement("div");t.className="jp-DrawioWidget-viewer",t.style.width="100%",t.style.height="100%",t.style.overflow="auto",this._container.appendChild(t);const i=document.createElement("div");i.className="mxgraph",i.style.width="100%",i.style.height="100%";const o={highlight:"#0000ff",nav:!0,resize:!0,toolbar:"zoom layers lightbox",edit:null,xml:e};i.setAttribute("data-mxgraph",JSON.stringify(o)),t.appendChild(i);try{window.GraphViewer.createViewerForElement?window.GraphViewer.createViewerForElement(i):window.GraphViewer.processElements(t)}catch(e){throw new Error("GraphViewer failed to render: "+e.message)}}_onContentChanged(){this._loadDiagram()}_showError(e){this._container.style.display="none",this._errorDiv.style.display="block";const t=(null==e?void 0:e.message)||String(e);this._errorDiv.innerHTML=`\n      <div class="jp-DrawioWidget-errorContent">\n        <h3>Failed to load Draw.io diagram</h3>\n        <p><strong>Error:</strong> ${this._escapeHtml(t)}</p>\n        <div class="jp-DrawioWidget-troubleshooting">\n          <strong>Troubleshooting:</strong>\n          <ul>\n            <li>Verify the file is a valid Draw.io/diagrams.net XML file</li>\n            <li>Check that the file is not corrupted</li>\n            <li>Try opening the file in Draw.io to verify it works</li>\n          </ul>\n        </div>\n      </div>\n    `}_escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}getDocumentPath(){return this._context.localPath}getSvgElement(){return this._container.querySelector("svg")}async exportAsPng(){const e=this.getSvgElement();if(!e)return null;return async function(e,t,i,o){const n=e.getBBox(),a=n.x-10,r=n.y-10,s=n.width+20,d=n.height+20,c=t/96,l=document.createElement("canvas");l.width=Math.ceil(s*c),l.height=Math.ceil(d*c);const h=l.getContext("2d");if(!h)throw new Error("Failed to get canvas context");if("transparent"!==i){let e;switch(i){case"white":default:e="#ffffff";break;case"black":e="#000000";break;case"custom":e=o}h.fillStyle=e,h.fillRect(0,0,l.width,l.height)}h.imageSmoothingEnabled=!0,h.imageSmoothingQuality="high";const g=e.cloneNode(!0);g.setAttribute("viewBox",`${a} ${r} ${s} ${d}`),g.setAttribute("width",String(s)),g.setAttribute("height",String(d)),g.style.width="",g.style.height="";const w=(new XMLSerializer).serializeToString(g),m=`data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(w)))}`;return new Promise((e,t)=>{const i=new Image;i.onload=()=>{h.drawImage(i,0,0,l.width,l.height),l.toBlob(i=>{i?e(i):t(new Error("Failed to create PNG blob"))},"image/png",1)},i.onerror=()=>t(new Error("Failed to load SVG as image")),i.src=m})}(e,g,w,h)}async copyAsPng(){const e=await this.exportAsPng();if(!e)throw new Error("No diagram to export");await async function(e){const t=new ClipboardItem({"image/png":e});await navigator.clipboard.write([t])}(e)}async downloadAsPng(){const e=await this.exportAsPng();if(!e)throw new Error("No diagram to export");!function(e,t){const i=URL.createObjectURL(e),o=document.createElement("a");o.href=i,o.download=t,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(i)}(e,`${this.getDocumentPath().replace(/\.[^/.]+$/,"").split("/").pop()||"diagram"}.png`)}dispose(){this.isDisposed||(m.delete(this),this._context.model.contentChanged.disconnect(this._onContentChanged,this),super.dispose())}}class y extends a.ABCWidgetFactory{createNewWidget(e){const t=new u(e);return new a.DocumentWidget({content:t,context:e})}}const f=[".drawio",".dio"],_="drawio",v=new n.LabIcon({name:"drawio:icon",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 161.6 161.6">\n  <path fill="#D07005" d="M161.6,154.7c0,3.9-3.2,6.9-6.9,6.9H6.9c-3.9,0-6.9-3.2-6.9-6.9V6.9C0,3,3.2,0,6.9,0h147.8c3.9,0,6.9,3.2,6.9,6.9L161.6,154.7z"/>\n  <path fill="#B85A0A" d="M161.6,154.7c0,3.9-3.2,6.9-6.9,6.9H55.3l-32.2-32.7l20-32.7l59.4-73.8l58.9,60.7L161.6,154.7z"/>\n  <path fill="#e0e0e0" d="M132.7,90.3h-17l-18-30.6c4-0.8,7-4.4,7-8.6V28c0-4.9-3.9-8.8-8.8-8.8h-30c-4.9,0-8.8,3.9-8.8,8.8v23.1c0,4.3,3,7.8,6.9,8.6L46,90.4H29c-4.9,0-8.8,3.9-8.8,8.8v23.1c0,4.9,3.9,8.8,8.8,8.8h30c4.9,0,8.8-3.9,8.8-8.8V99.2c0-4.9-3.9-8.8-8.8-8.8h-2.9L73.9,60h13.9l17.9,30.4h-3c-4.9,0-8.8,3.9-8.8,8.8v23.1c0,4.9,3.9,8.8,8.8,8.8h30c4.9,0,8.8-3.9,8.8-8.8V99.2C141.5,94.3,137.6,90.3,132.7,90.3z"/>\n</svg>'}),b="jupyterlab_drawio_render_extension:plugin",D="drawio:copy-as-png",x="drawio:download-as-png";function P(e){const t=e.shell.currentWidget;if(t instanceof a.DocumentWidget){const e=t.content;if(e instanceof u)return e}return null}const E={id:b,description:"JupyterLab extension to render Draw.io diagrams (read-only viewer)",autoStart:!0,optional:[o.ISettingRegistry],activate:(e,t)=>{console.log("JupyterLab extension jupyterlab_drawio_render_extension is activated!");const{docRegistry:i,commands:o}=e;i.addFileType({name:_,displayName:"Draw.io Diagram",extensions:f,mimeTypes:["application/vnd.jgraph.mxfile"],fileFormat:"text",contentType:"file",icon:v});const n=new y({name:"Draw.io Viewer",modelName:"text",fileTypes:[_],defaultFor:[_],readOnly:!0});i.addWidgetFactory(n),o.addCommand(D,{label:"Copy Diagram as PNG",caption:"Copy diagram to clipboard as PNG image",isEnabled:()=>null!==P(e),execute:async()=>{const t=P(e);if(t)try{await t.copyAsPng(),console.log("Diagram copied to clipboard as PNG")}catch(e){console.error("Failed to copy diagram as PNG:",e)}}}),o.addCommand(x,{label:"Download Diagram as PNG",caption:"Download diagram as PNG image file",isEnabled:()=>null!==P(e),execute:async()=>{const t=P(e);if(t)try{await t.downloadAsPng(),console.log("Diagram downloaded as PNG")}catch(e){console.error("Failed to download diagram as PNG:",e)}}}),e.contextMenu.addItem({command:D,selector:".jp-DrawioWidget",rank:1}),e.contextMenu.addItem({command:x,selector:".jp-DrawioWidget",rank:2}),t&&t.load(b).then(e=>{const t=()=>{const t=e.get("background").composite,i=e.get("customBackgroundColor").composite;h=i,"custom"===l&&m.forEach(e=>e.updateBackground("custom",h)),function(e){l=e,m.forEach(t=>t.updateBackground(e,h))}(t);const o=e.get("exportDPI").composite,n=e.get("exportBackground").composite;!function(e){g=e}(o),function(e){w=e}(n)};t(),e.changed.connect(t)}).catch(()=>{})}}}}]);
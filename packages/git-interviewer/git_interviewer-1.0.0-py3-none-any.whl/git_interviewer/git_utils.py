# git utilities file.....
import subprocess
import os
import sys

def get_staged_diff() -> str: 
    """
    gets staged changes in the current git repo
    """
    try: 
        # run git diff --cached
        result = subprocess.run(["git", "diff", "--cached"], 
                                capture_output=True, text=True, check=True)
        return result.stdout.strip()
    
    except subprocess.CalledProcessError as e: 
        print(f"Error getting staged diff: {e}", file=sys.stderr)
        return None
    
    
def install_hook() -> bool: 
    """ Installs pre commit hook """
    hook_path = ".git/hooks/pre-commit"
    
    if not os.path.exists(".git"): 
        print("This is not a git repo yet! ")
        return False
    
    # We bind the hook to the current Python executable to avoid environment mismatches
    # (e.g. running from a global install instead of the active virtualenv)
    python_exe = sys.executable
    
    hook_script = f"""#!/bin/sh
# Git Interviewer Hook
# Generated by git-interviewer
exec "{python_exe}" -m git_interviewer.main interview
"""
    with open(hook_path, "w") as f:
        f.write(hook_script)
        
    os.chmod(hook_path, 0o755) # owner rwx, groups read and execute, others read and execute
    print(f"Pre-commit hook installed at {hook_path}")
    return True
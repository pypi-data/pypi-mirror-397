# Copyright 2017 Miguel Angel Rivera Notararigo. All rights reserved.
# This source code was released under the MIT license.
"""
ntDocutils writer.

Provides:

- ``Writer``: basic writer.

- ``dict2args``: dictionary to arguments list converter.

- ``apply_template``: overwriting for
  ``docutils.writers._html_base.Writer.apply_template``.
"""

__docformat__ = 'reStructuredText'

import re

from docutils.core import publish_cmdline
from docutils.writers._html_base import Writer as DocutilsWriter

from ntdocutils.exceptions import OfflineUnsupported


class Writer:
    """Creates a basic structure for themes writers."""

    docutils_argv = {
        'strip-comments': True,
        'pep-references': True,
        'rfc-references': True,
        'syntax-highlight': 'short',
        'tab-width': 4,
        'xml-declaration': True
    }
    """Options passed to Docutils."""

    def __init__(self, server: bool = False):
        """
        ``server`` (string)
          Server from where assets will be downloaded.
        """

        self.server = server

    def assets(self):
        """
        Generates assets for the template. Returns a dictionary with the assets
        to add to the template.

        See ``ntdocutils.writer.apply_template``.
        """

        return {}

    def offline_mode(self, destination: str):
        """
        Creates offline assets in ``destination`` parent folder.

        ``destination`` (string)
          File generated by Docutils.

        Example
        =======

        .. code:: python

            obj.offline_mode('index.html')
        """

        raise OfflineUnsupported(self.theme)

    def write(self, source: str, destination: str, extra_argv=[]):
        """
        Generates the destination file.

        ``source`` (string)
          File processed by Doctuils.

        ``destination`` (string)
          File generated by Doctuils.

        ``extra_argv`` (list)
          Docutils additional arguments.

        Examples
        ========

        .. code:: python

            obj.write('test.rst', 'index.html')

        .. code:: python

            obj.write('test.rst', 'index.html', ['--syntax-highlight=long'])
        """

        extra_argv.extend((source, destination))

        if self.server == 'local':
            self.offline_mode(destination)

        DocutilsWriter.apply_template = apply_template(self.assets())

        publish_cmdline(writer_name='html5',
                        argv=dict2args(self.docutils_argv) + extra_argv)


def apply_template(assets):
    """
    Processes the template.

    Used for overwrite ``docutils.writers._html_base.Writer.apply_template``
    method.

    ``assets`` (dictionary)
      Assets to add at the template, see ``ntdocutils.writer.Writer.assets``.

    Example
    =======

    .. code:: python

        apply_template({
            'before_styles': '<link rel="stylesheet" href="styles.css" />',
            'scripts': '<script src="script.js"></script>'
                       '<script src="other_script.js"></script>'
        })
    """

    def apply_template(self):
        template = ''

        with open(self.document.settings.template, 'rb') as template_file:
            template = str(template_file.read(), 'utf-8')

        # Escape ``%`` that don't are special fields
        pattern = r'%(?!\((' + '|'.join(self.visitor_attributes) + r')\)s)'
        template = re.subn(pattern, '%%', template)[0]

        subs = self.interpolation_dict()
        return template.format(**assets) % subs

    return apply_template


def dict2args(dictionary):
    """
    Generates an arguments list from a dictionary.

    ``dictionary`` (dictionary)
      Dictionary to process.

    Examples
    ========

    .. code:: python

        docutils_argv = {
            'report': 'info',
            'strip-comments': True,
            'pep-references': True,
            'rfc-references': True,
            'syntax-highlight': 'short',
            'tab-width': 4,
            'xml-declaration': True
        }

        dict2args(docutils_argv)
    """

    args = []

    for key, value in dictionary.items():
        arg = '-'

        if len(key) > 1:
            arg += '-'

        arg += key

        if not isinstance(value, bool):
            arg += '=' + str(value)

        args.append(arg)

    return args

; /etc/asterisk/extensions.conf  (minimal)

[general]
static=yes
writeprotect=no
clearglobalvars=no

[globals]
; MUST be a Twilio-owned/verified number you control:
OUTCALLERID=+18722858684
; Tabby caller ID for UAE numbers:
TABBYCALLERID=+971558976298

[from-internal]
; UAE numbers (+971) via Tabby trunk (UDP) - remove + from destination
exten => _+971.,1,NoOp(Outbound to ${EXTEN} via Tabby UDP)
 same => n,Set(CALLERID(num)=${TABBYCALLERID})
 same => n,Set(DEST=${EXTEN:1})
 same => n,Dial(PJSIP/${DEST}@tabby_trunk,60)
 same => n,Hangup()

; Saudi Arabia numbers (+966) via Tabby trunk (UDP) - remove + from destination
exten => _+966.,1,NoOp(Outbound to ${EXTEN} via Tabby UDP)
 same => n,Set(CALLERID(num)=${TABBYCALLERID})
 same => n,Set(DEST=${EXTEN:1})
 same => n,Set(MIXMON_DIR=/tmp)
 same => n,MixMonitor(${STRFTIME(${EPOCH},,%Y%m%d-%H%M%S)}-${DEST}.wav)
 same => n,Dial(PJSIP/${DEST}@tabby_trunk,60)
 same => n,Hangup()

; All other E.164 numbers via Twilio
exten => _+X.,1,NoOp(Outbound to ${EXTEN} via Twilio)
 same => n,Set(CALLERID(num)=${OUTCALLERID})
 same => n,Dial(PJSIP/${EXTEN}@twilio_trunk,60)
 same => n,Hangup()

; 10/11-digit convenience (US/CA). Comment out if not needed.
exten => _NXXNXXXXXX,1,Goto(from-internal,+1${EXTEN},1)
exten => _1NXXNXXXXXX,1,Goto(from-internal,+${EXTEN},1)

; Local echo test
exten => 600,1,Answer()
 same => n,Echo()
 same => n,Hangup()

exten => 700,1,Answer()
 same => n,NoOp(TEST -> ARI bot)
 same => n,Set(MIXMON_FILE=/var/spool/asterisk/monitor/test-${UNIQUEID}-${STRFTIME(${EPOCH},,%Y%m%d-%H%M%S)}.wav)
 same => n,MixMonitor(${MIXMON_FILE},b)
 same => n,Stasis(pipecat, test-${UNIQUEID})
 same => n,Hangup()

[from-pstn]
; If you later allow inbound from Twilio, send to a test/app here
exten => s,1,NoOp(Inbound from PSTN)
 same => n,Answer()
 same => n,Playback(demo-congrats)
 same => n,Hangup()

; Keep public/default empty to avoid surprises
[public]
exten => _.,1,Hangup()

[default]
include => from-internal

[from-external]
exten => s,1,NoOp(INBOUND -> ARI bot)
 same => n,Answer()
 same => n,Stasis(pipecat, inbound-${UNIQUEID})
 same => n,Hangup()


[Ubona_RINGG]
; Inbound calls from Ubona - route to Pipecat
exten => _X.,1,NoOp(Inbound call from Ubona - From: ${CALLERID(num)}, To: ${EXTEN})
 same => n,Answer()
 same => n,Set(__INBOUND_DID=${EXTEN})
 same => n,Set(__INBOUND_FROM=${CALLERID(num)})
 same => n,Set(__INBOUND_PROVIDER=ubona)
 same => n,Set(__SIP_CONTEXT=Ubona_RINGG)
 same => n,Set(MIXMON_FILE=/var/spool/asterisk/monitor/inbound-${CONTEXT}-${UNIQUEID}-${STRFTIME(${EPOCH},,%Y%m%d-%H%M%S)}.wav)
 same => n,MixMonitor(${MIXMON_FILE},b)
 same => n,Set(CALL_UUID=${SHELL(uuidgen)})
 same => n,Stasis(pipecat,${CALL_UUID})
 same => n,Hangup()

; Specific handler for the assigned DID 08045034002
exten => +918045034002,1,NoOp(Inbound call from Ubona DID +918045034002 - From: ${CALLERID(num)})
 same => n,Answer()
 same => n,Set(__INBOUND_DID=+918045034002)
 same => n,Set(__INBOUND_FROM=${CALLERID(num)})
 same => n,Set(__INBOUND_PROVIDER=ubona)
 same => n,Set(__SIP_CONTEXT=Ubona_RINGG)
 same => n,Set(MIXMON_FILE=/var/spool/asterisk/monitor/inbound-${CONTEXT}-${UNIQUEID}-${STRFTIME(${EPOCH},,%Y%m%d-%H%M%S)}.wav)
 same => n,MixMonitor(${MIXMON_FILE},b)
 same => n,Set(CALL_UUID=${SHELL(uuidgen)})
 same => n,Stasis(pipecat,${CALL_UUID})
 same => n,Hangup()

[PB_Fintech_RINGG]
; Inbound calls from PB_Fintech - route to Pipecat
; Supports agent_id via X-Agent-ID SIP header (REQUIRED for PB Fintech)
; Supports custom call_id via X-Call-ID SIP header (optional, falls back to UUID in bridge)
; Supports custom_vars via X-Custom-Vars SIP header (optional, format: key1=val1&key2=val2)
; To/From numbers are optional - agent_id is used for routing
exten => _.,1,NoOp(Inbound call from PB_Fintech - From: ${CALLERID(num)}, To: ${EXTEN})
 same => n,Answer()
 same => n,Set(__INBOUND_DID=${EXTEN})
 same => n,Set(__INBOUND_FROM=${CALLERID(num)})
 same => n,Set(__INBOUND_PROVIDER=pb_fintech)
 same => n,Set(__SIP_CONTEXT=PB_Fintech_RINGG)
 same => n,Set(__AGENT_ID=${PJSIP_HEADER(read,X-Agent-ID)})
 same => n,Set(__CUSTOM_CALL_ID=${PJSIP_HEADER(read,X-Call-ID)})
 same => n,Set(__CUSTOM_VARS=${PJSIP_HEADER(read,X-Custom-Vars)})
 same => n,Set(__DST=${PJSIP_HEADER(read,X-ORIG-CHANNEL)})
 same => n,Set(MIXMON_FILE=/var/spool/asterisk/monitor/inbound-${CONTEXT}-${UNIQUEID}-${STRFTIME(${EPOCH},,%Y%m%d-%H%M%S)}.wav)
 same => n,MixMonitor(${MIXMON_FILE},b)
 same => n,Stasis(pipecat)
 same => n,Hangup()


 ; Generic transfer context used by Ringg bots
[ringg-transfer-generic]
; Mandatory: XFER_TARGET (set by bot via ARI) - the destination number/SIP URI
; Optional:  XFER_METHOD: native | dial | native_then_dial (default native)
;            XFER_DOMAIN: SIP domain for routing
;            XFER_TRUNK: PJSIP trunk name for outbound Dial
;            XFER_TIMEOUT: seconds (default 60)
;            XFER_CALLERID: override caller id on outbound
;
exten => s,1,NoOp(RINGG generic transfer: target=${XFER_TARGET} method=${XFER_METHOD} domain=${XFER_DOMAIN} trunk=${XFER_TRUNK})
 same => n,GotoIf($[${LEN(${XFER_TARGET})}=0]?missing)
 ; Defaults
 same => n,Set(METHOD=${IF($[${LEN(${XFER_METHOD})}>0]?${XFER_METHOD}:native)})
 same => n,Set(TIMEOUT=${IF($[${LEN(${XFER_TIMEOUT})}>0]?${XFER_TIMEOUT}:60)})
 same => n,Set(CALLERID(num)=${IF($[${LEN(${XFER_CALLERID})}>0]?${XFER_CALLERID}:${CALLERID(num)})})

 ; Try native transfer first if requested
 same => n,GotoIf($["${METHOD}"="native"]?do_native)
 same => n,GotoIf($["${METHOD}"="native_then_dial"]?do_native:do_dial)

 same => n(do_native),NoOp(Native transfer (REFER) to ${XFER_TARGET})
 ; Format as sip:target@domain if domain is provided
 same => n,GotoIf($[${LEN(${XFER_DOMAIN})}>0]?use_domain)
 same => n,GotoIf($[${LEN(${XFER_TRUNK})}>0]?use_trunk)
 same => n,Set(REFER_TARGET=${XFER_TARGET})
 same => n,Goto(do_transfer)
 same => n(use_domain),Set(REFER_TARGET=sip:${XFER_TARGET}@${XFER_DOMAIN})
 same => n,Goto(do_transfer)
 same => n(use_trunk),Set(REFER_TARGET=sip:${XFER_TARGET}@${XFER_TRUNK})
 same => n(do_transfer),NoOp(Formatted REFER target: ${REFER_TARGET})
 same => n,Transfer(${REFER_TARGET})
 same => n,NoOp(Native transfer returned; fallback if configured)
 same => n,GotoIf($["${METHOD}"="native"]?done:do_dial)

 ; Build endpoint and Dial fallback
 same => n(do_dial),NoOp(Outbound Dial to ${XFER_TARGET})
 same => n,Set(ENDPOINT=${IF($["${XFER_TARGET:0:4}"="sip:"]?PJSIP/${XFER_TARGET}:${IF($[${LEN(${XFER_TRUNK})}>0]?PJSIP/${XFER_TARGET}@${XFER_TRUNK}:${IF($[${LEN(${XFER_DOMAIN})}>0]?PJSIP/${XFER_TARGET}@${XFER_DOMAIN}:PJSIP/${XFER_TARGET})})})
 same => n,NoOp(Dial endpoint=${ENDPOINT} timeout=${TIMEOUT})
 same => n,Dial(${ENDPOINT},${TIMEOUT})
 same => n(done),Hangup()
 same => n(missing),NoOp(ERROR: XFER_TARGET missing)
 same => n,Hangup(88)

[ringg-transfer]
exten => _X.,1,Goto(s,1)
exten => _+X.,1,Goto(s,1)

exten => s,1,NoOp(RINGG transfer - escalate to human agent)
; same => n,Set(PJSIP_HEADER(add,Reason)=Q.850\;cause=21\;text=\"Escalate to human agent\")
; same => n,Set(PJSIP_HEADER(add,X-RINGG-TRANSFER)=YES)
; same => n,SendDTMF(*2)
; same => n,Hangup(21)
 same => n,Hangup(21)

[pb-fintech-transfer]
exten => _X.,1,Goto(s,1)
exten => _+X.,1,Goto(s,1)

exten => s,1,NoOp(PB Fintech transfer handover)
 same => n,Set(__PB_DST=${IF($[${LEN(${DST})}>0]?${DST}:${XFER_TARGET})})
 same => n,Set(MESSAGE(body)={"event":"transfer","callid":"${UNIQUEID}","channel":"${CHANNEL}","dst":"${__PB_DST}"})
 same => n,Set(__PB_TRUNK=${IF($[${LEN(${XFER_TRUNK})}>0]?${XFER_TRUNK}:PB_Fintech_RINGG)})
 same => n,NoOp(Sending PB Fintech transfer message to ${__PB_TRUNK})
 same => n,MessageSend(sip:${__PB_TRUNK},"Transfer the call")
 same => n,Hangup()

import{_ as $,I as A,r,c as v,T as x,o as D,d as c,e as u,i as F,f as a,t as m,n as N,x as U,y as V,D as j,B as z,p as E,q as H}from"./_plugin-vue_export-helper-DBJ1JH0N.js";const K={class:"app-shell"},O={key:0,class:"global-status",style:{display:"block"}},q={class:"view-root"},J={class:"surface surface--tight",style:{"max-width":"560px",margin:"0 auto",width:"100%"}},L={class:"view-header",style:{"text-align":"center"}},W={class:"view-lede"},Y={key:0,class:"section-block"},G={key:1,class:"section-block"},Q={class:"section-body center"},X={key:2,class:"section-block"},Z={class:"section-body"},ee={class:"name-edit"},se=["disabled"],te=["disabled"],ae={__name:"ResetApp",setup(oe){const o=A({show:!1,message:"",type:"info"}),d=r(!0),n=r(!1),l=r(""),P=r(null),f=r(null),p=r(""),h=r("");let g=null;const R=v(()=>f.value?.session_type||"your enrollment"),T=v(()=>d.value?"Preparing your secure enrollmentâ€¦":_.value?`Finish up ${R.value}. You may edit the name below if needed, and it will be saved to your passkey.`:"This reset link is no longer valid.");v(()=>x());const _=v(()=>!!(l.value&&f.value));function i(e,s="info",t=3e3){o.show=!0,o.message=e,o.type=s,g&&clearTimeout(g),t>0&&(g=setTimeout(()=>{o.show=!1},t))}async function S(){try{const e=await z();P.value=e,e?.rp_name&&(document.title=`${e.rp_name} Â· Passkey Setup`)}catch(e){console.warn("Unable to load settings",e)}}async function B(){if(l.value)try{const e=await fetch(`/auth/api/user-info?reset=${encodeURIComponent(l.value)}`,{method:"POST"});if(!e.ok){const t=(await b(e))?.detail||"Reset link is invalid or expired.";h.value=t,i(t,"error",0);return}f.value=await e.json(),p.value=f.value?.user?.user_name||""}catch(e){console.error("Failed to load user info",e);const s="We could not load your reset details. Try refreshing the page.";h.value=s,i(s,"error",0)}}async function w(){if(!_.value||n.value)return;n.value=!0,i("Starting passkey registrationâ€¦","info");let e;try{const s=p.value.trim()||null;e=await E.register(l.value,s)}catch(s){n.value=!1;const t=s?.message||"Passkey registration cancelled",y=t==="Passkey registration cancelled";i(y?t:`Registration failed: ${t}`,y?"info":"error",4e3);return}try{await C(e.session_token)}catch(s){n.value=!1;const t=s?.message||"Failed to establish session";i(t,"error",4e3);return}i("Passkey registered successfully!","success",2e3),setTimeout(()=>{n.value=!1,k()},800)}async function C(e){const s=await fetch("/auth/api/set-session",{method:"POST",headers:{Authorization:`Bearer ${e}`}}),t=await b(s);if(!s.ok||t?.detail){const y=t?.detail||"Session could not be established.";throw new Error(y)}return t}function k(){const e=x.value||"/auth/";window.location.pathname!==e&&history.replaceState(null,"",e),window.location.reload()}function I(){k()}function M(){const e=window.location.pathname.split("/").filter(Boolean);if(!e.length)return"";const s=e[e.length-1],t=e.slice(0,-1);return t.length>1||t.length===1&&t[0]!=="auth"||!s.includes(".")?"":s}async function b(e){try{return await e.json()}catch{return null}}return D(async()=>{if(l.value=M(),await S(),!l.value){const e="Reset link is missing or malformed.";h.value=e,i(e,"error",0),d.value=!1;return}await B(),d.value=!1}),(e,s)=>(u(),c("div",K,[o.show?(u(),c("div",O,[a("div",{class:N(["status",o.type])},m(o.message),3)])):F("",!0),a("main",q,[a("div",J,[a("header",L,[s[1]||(s[1]=a("h1",null,"ðŸ”‘ Registration",-1)),a("p",W,m(T.value),1)]),d.value?(u(),c("section",Y,[...s[2]||(s[2]=[a("div",{class:"section-body center"},[a("p",null,"Loading reset detailsâ€¦")],-1)])])):_.value?(u(),c("section",X,[a("div",Z,[a("label",ee,[s[3]||(s[3]=a("span",null,"ðŸ‘¤ Name",-1)),U(a("input",{type:"text","onUpdate:modelValue":s[0]||(s[0]=t=>p.value=t),disabled:n.value,maxlength:"64",onKeyup:j(w,["enter"])},null,40,se),[[V,p.value]])]),a("button",{class:"btn-primary",disabled:n.value,onClick:w},m(n.value?"Registeringâ€¦":"Register Passkey"),9,te)])])):(u(),c("section",G,[a("div",Q,[a("p",null,m(h.value),1),a("div",{class:"button-row center",style:{"justify-content":"center"}},[a("button",{class:"btn-secondary",onClick:I},"Return to sign-in")])])]))])])]))}},ne=$(ae,[["__scopeId","data-v-b30c1727"]]);H(ne).mount("#app");

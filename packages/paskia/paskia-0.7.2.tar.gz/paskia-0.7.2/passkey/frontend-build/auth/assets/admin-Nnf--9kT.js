import{_ as F,c as M,d as l,e as r,f as i,i as R,t as k,F as w,s as T,v as re,k as le,r as $,h as A,g as B,w as H,j as _e,l as S,x as V,y as z,u as ie,z as ne,o as oe,A as Me,B as Ie,a as Le,m as qe,b as Ve,q as ze}from"./_plugin-vue_export-helper-DBJ1JH0N.js";import{u as de,U as Be,_ as Fe,c as Je}from"./UserBasicInfo-Cs5YqwNh.js";import{_ as xe,a as Ge,R as He,N as G,M as We,L as Ye,A as Ze,B as Ke}from"./AccessDenied-CEEhbiIE.js";import"./helpers-CU0-cyzg.js";const Qe={class:"permissions-section"},Xe={class:"actions"},ea={class:"org-table"},aa={key:0},ta=["onClick"],sa=["onClick"],ia={class:"role-names"},na={class:"center"},oa={key:0,class:"center"},ra=["onClick"],la={key:0,class:"permissions-section"},da={class:"matrix-wrapper"},ua={class:"matrix-scroll"},ma=["title"],ca=["title"],ga={class:"display-text"},ha=["checked","onChange"],fa={class:"actions"},ya={class:"org-table"},pa={class:"perm-name-cell"},va={class:"perm-title"},wa={class:"display-text"},ba=["onClick"],$a={class:"perm-id-info"},ka={class:"id-text"},Da={class:"perm-members center"},Oa={class:"perm-actions center"},Ra=["onClick"],Ea={__name:"AdminOverview",props:{info:Object,orgs:Array,permissions:Array,permissionSummary:Object},emits:["createOrg","openOrg","updateOrg","deleteOrg","toggleOrgPermission","openDialog","deletePermission","renamePermissionDisplay"],setup(a,{emit:U}){const b=a,O=M(()=>[...b.orgs].sort((h,t)=>{const n=h.display_name.localeCompare(t.display_name);return n!==0?n:h.uuid.localeCompare(t.uuid)})),D=M(()=>[...b.permissions].sort((h,t)=>h.id.localeCompare(t.id)));function E(h){return h.roles.slice().sort((t,n)=>t.display_name.localeCompare(n.display_name)).map(t=>t.display_name).join(", ")}return(h,t)=>(r(),l(w,null,[i("div",Qe,[i("h2",null,k(a.info.is_global_admin?"Organizations":"Your Organizations"),1),i("div",Xe,[a.info.is_global_admin?(r(),l("button",{key:0,onClick:t[0]||(t[0]=n=>h.$emit("createOrg"))},"+ Create Org")):R("",!0)]),i("table",ea,[i("thead",null,[i("tr",null,[t[2]||(t[2]=i("th",null,"Name",-1)),t[3]||(t[3]=i("th",null,"Roles",-1)),t[4]||(t[4]=i("th",null,"Members",-1)),a.info.is_global_admin?(r(),l("th",aa,"Actions")):R("",!0)])]),i("tbody",null,[(r(!0),l(w,null,T(O.value,n=>(r(),l("tr",{key:n.uuid},[i("td",null,[i("a",{href:"#org/{{o.uuid}}",onClick:le(d=>h.$emit("openOrg",n),["prevent"])},k(n.display_name),9,ta),a.info.is_global_admin||a.info.is_org_admin?(r(),l("button",{key:0,onClick:d=>h.$emit("updateOrg",n),class:"icon-btn edit-org-btn","aria-label":"Rename organization",title:"Rename organization"},"✏️",8,sa)):R("",!0)]),i("td",ia,k(E(n)),1),i("td",na,k(n.roles.reduce((d,u)=>d+u.users.length,0)),1),a.info.is_global_admin?(r(),l("td",oa,[i("button",{onClick:d=>h.$emit("deleteOrg",n),class:"icon-btn delete-icon","aria-label":"Delete organization",title:"Delete organization"},"❌",8,ra)])):R("",!0)]))),128))])])]),a.info.is_global_admin?(r(),l("div",la,[t[8]||(t[8]=i("h2",null,"Permissions",-1)),i("div",da,[i("div",ua,[i("div",{class:"perm-matrix-grid",style:re({gridTemplateColumns:"minmax(180px, 1fr) "+O.value.map(()=>"2.2rem").join(" ")})},[t[5]||(t[5]=i("div",{class:"grid-head perm-head"},"Permission",-1)),(r(!0),l(w,null,T(O.value,n=>(r(),l("div",{key:"head-"+n.uuid,class:"grid-head org-head",title:n.display_name},[i("span",null,k(n.display_name),1)],8,ma))),128)),(r(!0),l(w,null,T(D.value,n=>(r(),l(w,{key:n.id},[i("div",{class:"perm-name",title:n.id},[i("span",ga,k(n.display_name),1)],8,ca),(r(!0),l(w,null,T(O.value,d=>(r(),l("div",{key:d.uuid+"-"+n.id,class:"matrix-cell"},[i("input",{type:"checkbox",checked:d.permissions.includes(n.id),onChange:u=>h.$emit("toggleOrgPermission",d,n.id,u.target.checked)},null,40,ha)]))),128))],64))),128))],4)]),t[6]||(t[6]=i("p",{class:"matrix-hint muted"},"Toggle which permissions each organization can grant to its members.",-1))]),i("div",fa,[a.info.is_global_admin?(r(),l("button",{key:0,onClick:t[1]||(t[1]=n=>h.$emit("openDialog","perm-create",{display_name:"",id:""}))},"+ Create Permission")):R("",!0)]),i("table",ya,[t[7]||(t[7]=i("thead",null,[i("tr",null,[i("th",{scope:"col"},"Permission"),i("th",{scope:"col",class:"center"},"Members"),i("th",{scope:"col",class:"center"},"Actions")])],-1)),i("tbody",null,[(r(!0),l(w,null,T(D.value,n=>(r(),l("tr",{key:n.id},[i("td",pa,[i("div",va,[i("span",wa,k(n.display_name),1),i("button",{onClick:d=>h.$emit("renamePermissionDisplay",n),class:"icon-btn edit-display-btn","aria-label":"Edit display name",title:"Edit display name"},"✏️",8,ba)]),i("div",$a,[i("span",ka,k(n.id),1)])]),i("td",Da,k(a.permissionSummary[n.id]?.userCount||0),1),i("td",Oa,[i("button",{onClick:d=>h.$emit("deletePermission",n),class:"icon-btn delete-icon","aria-label":"Delete permission",title:"Delete permission"},"❌",8,Ra)])]))),128))])])])):R("",!0)],64))}},Ua=F(Ea,[["__scopeId","data-v-3b9e6d03"]]),Ca=["title"],Sa={class:"org-name"},Pa={class:"matrix-wrapper"},Na={class:"matrix-scroll"},Aa=["title"],Ta=["title"],ja=["checked","onChange"],_a={class:"roles-grid"},Ma=["onDrop"],Ia={class:"role-header"},La=["title"],qa=["onClick"],Va={class:"role-actions"},za=["onClick"],Ba={key:0,class:"user-list"},Fa=["onDragstart","onClick","title"],Ja={class:"name"},xa={class:"meta"},Ga={key:1,class:"empty-role"},Ha=["onClick"],Wa={__name:"AdminOrgDetail",props:{selectedOrg:Object,permissions:Array},emits:["updateOrg","createRole","updateRole","deleteRole","createUserInRole","openUser","toggleRolePermission","onRoleDragOver","onRoleDrop","onUserDragStart"],setup(a,{emit:U}){const b=a,O=U,D=M(()=>[...b.selectedOrg.roles].sort((t,n)=>{const d=t.display_name.toLowerCase(),u=n.display_name.toLowerCase();return d!==u?d.localeCompare(u):t.uuid.localeCompare(n.uuid)}));function E(t){return b.permissions.find(n=>n.id===t)?.display_name||t}function h(t,n,d){O("toggleRolePermission",t,n,d)}return(t,n)=>(r(),l(w,null,[i("h2",{class:"org-title",title:a.selectedOrg.uuid},[i("span",Sa,k(a.selectedOrg.display_name),1),i("button",{onClick:n[0]||(n[0]=d=>t.$emit("updateOrg",a.selectedOrg)),class:"icon-btn","aria-label":"Rename organization",title:"Rename organization"},"✏️")],8,Ca),i("div",Pa,[i("div",Na,[i("div",{class:"perm-matrix-grid",style:re({gridTemplateColumns:"minmax(180px, 1fr) "+D.value.map(()=>"2.2rem").join(" ")+" 2.2rem"})},[n[4]||(n[4]=i("div",{class:"grid-head perm-head"},"Permission",-1)),(r(!0),l(w,null,T(D.value,d=>(r(),l("div",{key:"head-"+d.uuid,class:"grid-head role-head",title:d.display_name},[i("span",null,k(d.display_name),1)],8,Aa))),128)),i("div",{class:"grid-head role-head add-role-head",title:"Add role",onClick:n[1]||(n[1]=d=>t.$emit("createRole",a.selectedOrg)),role:"button"},"➕"),(r(!0),l(w,null,T(a.selectedOrg.permissions,d=>(r(),l(w,{key:d},[i("div",{class:"perm-name",title:d},k(E(d)),9,Ta),(r(!0),l(w,null,T(D.value,u=>(r(),l("div",{key:u.uuid+"-"+d,class:"matrix-cell"},[i("input",{type:"checkbox",checked:u.permissions.includes(d),onChange:c=>h(u,d,c.target.checked)},null,40,ja)]))),128)),n[3]||(n[3]=i("div",{class:"matrix-cell add-role-cell"},null,-1))],64))),128))],4)]),n[5]||(n[5]=i("p",{class:"matrix-hint muted"},"Toggle which permissions each role grants.",-1))]),i("div",_a,[(r(!0),l(w,null,T(D.value,d=>(r(),l("div",{key:d.uuid,class:"role-column",onDragover:n[2]||(n[2]=u=>t.$emit("onRoleDragOver",u)),onDrop:u=>t.$emit("onRoleDrop",u,a.selectedOrg,d)},[i("div",Ia,[i("strong",{class:"role-name",title:d.uuid},[i("span",null,k(d.display_name),1),i("button",{onClick:u=>t.$emit("updateRole",d),class:"icon-btn","aria-label":"Edit role",title:"Edit role"},"✏️",8,qa)],8,La),i("div",Va,[i("button",{onClick:u=>t.$emit("createUserInRole",a.selectedOrg,d),class:"plus-btn","aria-label":"Add user",title:"Add user"},"➕",8,za)])]),d.users.length>0?(r(),l("ul",Ba,[(r(!0),l(w,null,T(d.users.slice().sort((u,c)=>{const y=u.display_name.toLowerCase(),j=c.display_name.toLowerCase();return y!==j?y.localeCompare(j):u.uuid.localeCompare(c.uuid)}),u=>(r(),l("li",{key:u.uuid,class:"user-chip",draggable:"true",onDragstart:c=>t.$emit("onUserDragStart",c,u,a.selectedOrg.uuid),onClick:c=>t.$emit("openUser",u),title:u.uuid},[i("span",Ja,k(u.display_name),1),i("span",xa,k(u.last_seen?new Date(u.last_seen).toLocaleDateString():"—"),1)],40,Fa))),128))])):(r(),l("div",Ga,[n[6]||(n[6]=i("p",{class:"empty-text muted"},"No members",-1)),i("button",{onClick:u=>t.$emit("deleteRole",d),class:"icon-btn delete-icon","aria-label":"Delete empty role",title:"Delete role"},"❌",8,Ha)]))],40,Ma))),128))])],64))}},Ya=F(Wa,[["__scopeId","data-v-b8b4bfbc"]]),Za={class:"user-detail"},Ka={key:1,class:"error small"},Qa={class:"registration-actions"},Xa=["disabled"],et={class:"section-block","data-section":"registered-passkeys"},at={class:"section-body"},tt={class:"actions ancillary-actions"},st={__name:"AdminUserDetail",props:{selectedUser:Object,userDetail:Object,selectedOrg:Object,loading:Boolean,showRegModal:Boolean},emits:["generateUserRegistrationLink","goOverview","openOrg","onUserNameSaved","closeRegModal","editUserName","refreshUserDetail"],setup(a,{emit:U}){const b=a,O=U,D=de(),E=$({});function h(){D.showMessage("Link copied to clipboard!")}function t(){O("editUserName",b.selectedUser)}function n(u){fetch(`/auth/api/admin/orgs/${b.selectedUser.org_uuid}/users/${b.selectedUser.uuid}/credentials/${u.credential_uuid}`,{method:"DELETE"}).then(c=>c.json()).then(c=>{c.status==="ok"?O("onUserNameSaved"):console.error("Failed to delete credential",c)}).catch(c=>console.error("Delete credential error",c))}async function d(u){const c=u?.id;if(c){E.value={...E.value,[c]:!0};try{const j=await(await fetch(`/auth/api/admin/orgs/${b.selectedUser.org_uuid}/users/${b.selectedUser.uuid}/sessions/${c}`,{method:"DELETE"})).json();if(j.status==="ok"){if(j.current_session_terminated){sessionStorage.clear(),location.reload();return}O("refreshUserDetail"),D.showMessage("Session terminated","success",2500)}else D.showMessage(j.detail||"Failed to terminate session","error")}catch(y){console.error("Terminate session error",y),D.showMessage("Failed to terminate session","error")}finally{const y={...E.value};delete y[c],E.value=y}}}return(u,c)=>(r(),l("div",Za,[a.userDetail&&!a.userDetail.error?(r(),A(Be,{key:0,name:a.userDetail.display_name||a.selectedUser.display_name,visits:a.userDetail.visits,"created-at":a.userDetail.created_at,"last-seen":a.userDetail.last_seen,loading:a.loading,"org-display-name":a.userDetail.org.display_name,"role-name":a.userDetail.role,"update-endpoint":`/auth/api/admin/orgs/${a.selectedUser.org_uuid}/users/${a.selectedUser.uuid}/display-name`,onSaved:c[0]||(c[0]=y=>u.$emit("onUserNameSaved")),onEditName:t},null,8,["name","visits","created-at","last-seen","loading","org-display-name","role-name","update-endpoint"])):a.userDetail?.error?(r(),l("div",Ka,k(a.userDetail.error),1)):R("",!0),a.userDetail&&!a.userDetail.error?(r(),l(w,{key:2},[i("div",Qa,[i("button",{class:"btn-secondary reg-token-btn",onClick:c[1]||(c[1]=y=>u.$emit("generateUserRegistrationLink",a.selectedUser)),disabled:a.loading},"Generate Registration Token",8,Xa),c[4]||(c[4]=i("p",{class:"matrix-hint muted"}," Generate a one-time registration link so this user can register or add another passkey. Copy the link from the dialog and send it to the user, or have the user scan the QR code on their device. ",-1))]),i("section",et,[c[5]||(c[5]=i("div",{class:"section-header"},[i("h2",null,"Registered Passkeys")],-1)),i("div",at,[B(xe,{credentials:a.userDetail.credentials,"aaguid-info":a.userDetail.aaguid_info,"allow-delete":!0,onDelete:n},null,8,["credentials","aaguid-info"])])]),B(Ge,{sessions:a.userDetail.sessions||[],"terminating-sessions":E.value,"empty-message":"This user has no active sessions.","section-description":"View and manage the active sessions for this user.",onTerminate:d},null,8,["sessions","terminating-sessions"])],64)):R("",!0),i("div",tt,[a.selectedOrg?(r(),l("button",{key:0,onClick:c[2]||(c[2]=y=>u.$emit("openOrg",a.selectedOrg)),class:"icon-btn",title:"Back to Org"},"↩️")):R("",!0)]),a.showRegModal?(r(),A(He,{key:3,endpoint:`/auth/api/admin/orgs/${a.selectedUser.org_uuid}/users/${a.selectedUser.uuid}/create-link`,"auto-copy":!1,"user-name":a.userDetail?.display_name||a.selectedUser.display_name,onClose:c[3]||(c[3]=y=>u.$emit("closeRegModal")),onCopied:h},null,8,["endpoint","user-name"])):R("",!0)]))}},it=F(st,[["__scopeId","data-v-998d5c6d"]]),nt={class:"modal-title"},ot={key:0},rt={key:2},lt={class:"small muted"},dt=["placeholder","pattern"],ut={key:7},mt={key:8,class:"error small"},ct={key:9,class:"modal-actions"},gt=["disabled"],ht=["disabled"],ft={__name:"AdminDialogs",props:{dialog:Object,PERMISSION_ID_PATTERN:String},emits:["submitDialog","closeDialog"],setup(a,{emit:U}){const b=a,O=$(null),D=$(null),E=new Set(["org-update","role-update","user-update-name"]);return H(()=>b.dialog.type,h=>{h==="org-create"?ne(()=>{O.value?.focus()}):(h==="perm-display"||h==="perm-create")&&ne(()=>{D.value?.focus(),h==="perm-display"&&D.value?.select()})}),(h,t)=>a.dialog.type?(r(),A(We,{key:0,onClose:t[13]||(t[13]=n=>h.$emit("closeDialog"))},{default:_e(()=>[i("h3",nt,[a.dialog.type==="org-create"?(r(),l(w,{key:0},[S("Create Organization")],64)):a.dialog.type==="org-update"?(r(),l(w,{key:1},[S("Rename Organization")],64)):a.dialog.type==="role-create"?(r(),l(w,{key:2},[S("Create Role")],64)):a.dialog.type==="role-update"?(r(),l(w,{key:3},[S("Edit Role")],64)):a.dialog.type==="user-create"?(r(),l(w,{key:4},[S("Add User To Role")],64)):a.dialog.type==="user-update-name"?(r(),l(w,{key:5},[S("Edit User Name")],64)):a.dialog.type==="perm-create"||a.dialog.type==="perm-display"?(r(),l(w,{key:6},[S(k(a.dialog.type==="perm-create"?"Create Permission":"Edit Permission Display"),1)],64)):a.dialog.type==="confirm"?(r(),l(w,{key:7},[S("Confirm")],64)):R("",!0)]),i("form",{onSubmit:t[12]||(t[12]=le(n=>h.$emit("submitDialog"),["prevent"])),class:"modal-form"},[a.dialog.type==="org-create"?(r(),l("label",ot,[t[14]||(t[14]=S("Name ",-1)),V(i("input",{ref_key:"nameInput",ref:O,"onUpdate:modelValue":t[0]||(t[0]=n=>a.dialog.data.name=n),required:""},null,512),[[z,a.dialog.data.name]])])):a.dialog.type==="org-update"?(r(),A(G,{key:1,label:"Organization Name",modelValue:a.dialog.data.name,"onUpdate:modelValue":t[1]||(t[1]=n=>a.dialog.data.name=n),busy:a.dialog.busy,error:a.dialog.error,onCancel:t[2]||(t[2]=n=>h.$emit("closeDialog"))},null,8,["modelValue","busy","error"])):a.dialog.type==="role-create"?(r(),l("label",rt,[t[15]||(t[15]=S("Role Name ",-1)),V(i("input",{"onUpdate:modelValue":t[3]||(t[3]=n=>a.dialog.data.name=n),placeholder:"Role name",required:""},null,512),[[z,a.dialog.data.name]])])):a.dialog.type==="role-update"?(r(),A(G,{key:3,label:"Role Name",modelValue:a.dialog.data.name,"onUpdate:modelValue":t[4]||(t[4]=n=>a.dialog.data.name=n),busy:a.dialog.busy,error:a.dialog.error,onCancel:t[5]||(t[5]=n=>h.$emit("closeDialog"))},null,8,["modelValue","busy","error"])):a.dialog.type==="user-create"?(r(),l(w,{key:4},[i("p",lt,"Role: "+k(a.dialog.data.role.display_name),1),i("label",null,[t[16]||(t[16]=S("Display Name ",-1)),V(i("input",{"onUpdate:modelValue":t[6]||(t[6]=n=>a.dialog.data.name=n),placeholder:"User display name",required:""},null,512),[[z,a.dialog.data.name]])])],64)):a.dialog.type==="user-update-name"?(r(),A(G,{key:5,label:"Display Name",modelValue:a.dialog.data.name,"onUpdate:modelValue":t[7]||(t[7]=n=>a.dialog.data.name=n),busy:a.dialog.busy,error:a.dialog.error,onCancel:t[8]||(t[8]=n=>h.$emit("closeDialog"))},null,8,["modelValue","busy","error"])):a.dialog.type==="perm-create"||a.dialog.type==="perm-display"?(r(),l(w,{key:6},[i("label",null,[t[17]||(t[17]=S("Display Name ",-1)),V(i("input",{ref_key:"displayNameInput",ref:D,"onUpdate:modelValue":t[9]||(t[9]=n=>a.dialog.data.display_name=n),required:""},null,512),[[z,a.dialog.data.display_name]])]),i("label",null,[t[18]||(t[18]=S("Permission ID ",-1)),V(i("input",{"onUpdate:modelValue":t[10]||(t[10]=n=>a.dialog.data.id=n),placeholder:a.dialog.type==="perm-create"?"yourapp:login":a.dialog.data.permission.id,required:"",pattern:a.PERMISSION_ID_PATTERN,title:"Allowed: A-Za-z0-9:._~-"},null,8,dt),[[z,a.dialog.data.id]])]),t[19]||(t[19]=i("p",{class:"small muted"},"The permission ID is used for permission checks in the application. Changing it may break deployed applications that reference this permission.",-1))],64)):a.dialog.type==="confirm"?(r(),l("p",ut,k(a.dialog.data.message),1)):R("",!0),a.dialog.error&&!ie(E).has(a.dialog.type)?(r(),l("div",mt,k(a.dialog.error),1)):R("",!0),ie(E).has(a.dialog.type)?R("",!0):(r(),l("div",ct,[i("button",{type:"button",class:"btn-secondary",onClick:t[11]||(t[11]=n=>h.$emit("closeDialog")),disabled:a.dialog.busy}," Cancel ",8,gt),i("button",{type:"submit",class:"btn-primary",disabled:a.dialog.busy},k(a.dialog.type==="confirm"?"OK":"Save"),9,ht)]))],32)]),_:1})):R("",!0)}},yt=F(ft,[["__scopeId","data-v-42b70397"]]),pt={class:"app-shell admin-shell"},vt={class:"app-main"},wt={key:2,class:"view-root view-root--wide view-admin"},bt={class:"view-header"},$t={class:"section-block admin-section"},kt={class:"section-body admin-section-body"},Dt={key:0,class:"surface surface--tight error"},Ot={key:1,class:"admin-panels"},Rt="^[A-Za-z0-9:._~-]+$",Et={__name:"AdminApp",setup(a){const U=$(null),b=$(!0),O=$("Loading..."),D=$(!1),E=$(!1),h=$(null),t=$([]),n=$([]),d=$(null),u=$(null),c=$(null);$(null),$(null);const y=de(),j=$(null);$(null),$(""),$(null),$("");const p=$({type:null,data:null,busy:!1,error:""});let _=null;H(()=>y.authRequired,e=>{e&&(D.value=!1,b.value=!0,K(),y.clearAuthRequired())});function W(e){if(!j.value)return;const s=e.target.closest(".org-add-menu"),o=e.target.closest(".add-org-btn");!s&&!o&&(j.value=null)}oe(()=>{document.addEventListener("click",W)}),Me(()=>{document.removeEventListener("click",W)});const me=M(()=>{const e={};for(const o of t.value){const m={uuid:o.uuid,display_name:o.display_name},f=new Set(o.permissions||[]);for(const g of o.permissions||[])e[g]||(e[g]={orgs:[],orgSet:new Set,userCount:0}),e[g].orgSet.has(o.uuid)||(e[g].orgs.push(m),e[g].orgSet.add(o.uuid));for(const g of o.roles)for(const v of g.permissions)f.has(v)&&(e[v]||(e[v]={orgs:[],orgSet:new Set,userCount:0}),e[v].orgSet.has(o.uuid)||(e[v].orgs.push(m),e[v].orgSet.add(o.uuid)),e[v].userCount+=g.users.length)}const s={};for(const[o,m]of Object.entries(e))s[o]={orgs:m.orgs.sort((f,g)=>f.display_name.localeCompare(g.display_name)),userCount:m.userCount};return s});function ce(e){N("perm-display",{permission:e,id:e.id,display_name:e.display_name})}function J(){const e=window.location.hash||"";d.value=null,u.value=null,e.startsWith("#org/")?d.value=e.slice(5):e.startsWith("#user/")&&(u.value=e.slice(6))}async function P(){const e=await fetch("/auth/api/admin/orgs");if(e.status===401)throw y.authRequired=!0,new Error("Authentication required");const s=await e.json();if(s.detail)throw new Error(s.detail);t.value=s.map(o=>{const m=o.roles.map(g=>({...g,org_uuid:o.uuid,users:[]})),f=Object.fromEntries(m.map(g=>[g.display_name,g]));for(const g of o.users||[])f[g.role]&&f[g.role].users.push(g);return{...o,roles:m}})}async function I(){const e=await fetch("/auth/api/admin/permissions");if(e.status===401)throw y.authRequired=!0,new Error("Authentication required");const s=await e.json();if(s.detail)throw new Error(s.detail);n.value=s}async function Y(){b.value=!0,O.value="Loading...",h.value=null;try{const e=await fetch("/auth/api/user-info",{method:"POST"});if(e.status===401){y.authRequired=!0,b.value=!0;return}const s=await e.json();if(s.detail)throw new Error(s.detail);if(U.value=s,D.value=!0,s.authenticated&&!(s.is_global_admin||s.is_org_admin)){y.authRequired=!0,b.value=!0;return}s.authenticated&&(s.is_global_admin||s.is_org_admin)&&await Promise.all([P(),I()]),!s.is_global_admin&&s.is_org_admin&&t.value.length===1&&(!window.location.hash||window.location.hash==="#overview")?(d.value=t.value[0].uuid,window.location.hash=`#org/${d.value}`,y.showMessage(`Navigating to ${t.value[0].display_name} Administration`,"info",3e3)):J()}catch(e){h.value=e.message}finally{b.value=!1}}function ge(){N("org-create",{})}function Z(e){N("org-update",{org:e,name:e.display_name})}function he(e){N("user-update-name",{user:e,name:e.display_name})}function fe(e){if(!U.value?.is_global_admin){y.showMessage("Global admin only");return}N("confirm",{message:`Delete organization ${e.display_name}?`,action:async()=>{const o=await(await fetch(`/auth/api/admin/orgs/${e.uuid}`,{method:"DELETE"})).json();if(o.detail)throw new Error(o.detail);await Promise.all([P(),I()])}})}function ye(e,s){N("user-create",{org:e,role:s})}async function pe(e,s,o){if(s.role===o)return;const f=await(await fetch(`/auth/api/admin/orgs/${e.uuid}/users/${s.uuid}/role`,{method:"PUT",headers:{"content-type":"application/json"},body:JSON.stringify({role:o})})).json();if(f.detail){y.showMessage(f.detail);return}await P()}function ve(e,s,o){e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",JSON.stringify({user_uuid:s.uuid,org_uuid:o}))}function we(e){e.preventDefault(),e.dataTransfer.dropEffect="move"}function be(e,s,o){e.preventDefault();try{const m=JSON.parse(e.dataTransfer.getData("text/plain"));if(m.org_uuid!==s.uuid)return;const f=s.roles.flatMap(g=>g.users).find(g=>g.uuid===m.user_uuid);f&&pe(s,f,o.display_name)}catch{}}function $e(e){N("role-create",{org:e})}function ke(e){N("role-update",{role:e,name:e.display_name})}function De(e){N("confirm",{message:`Delete role ${e.display_name}?`,action:async()=>{const o=await(await fetch(`/auth/api/admin/orgs/${e.org_uuid}/roles/${e.uuid}`,{method:"DELETE"})).json();if(o.detail)throw new Error(o.detail);await P()}})}async function Oe(e,s,o){const m=o?[...e.permissions,s]:e.permissions.filter(g=>g!==s),f=[...e.permissions];e.permissions=m;try{const v=await(await fetch(`/auth/api/admin/orgs/${e.org_uuid}/roles/${e.uuid}`,{method:"PUT",headers:{"content-type":"application/json"},body:JSON.stringify({display_name:e.display_name,permissions:m})})).json();if(v.detail)throw new Error(v.detail);await P()}catch(g){y.showMessage(g.message||"Failed to update role permission"),e.permissions=f}}function Re(e){N("confirm",{message:`Delete permission ${e.id}?`,action:async()=>{const s=new URLSearchParams({permission_id:e.id}),m=await(await fetch(`/auth/api/admin/permission?${s.toString()}`,{method:"DELETE"})).json();if(m.detail)throw new Error(m.detail);await I()}})}function K(){q(),_=document.createElement("iframe"),_.id="auth-iframe",_.title="Authentication",_.src="/auth/restricted/?mode=login",document.body.appendChild(_),O.value="Authentication required..."}function q(){_&&(_.remove(),_=null)}function Ee(){window.location.reload()}function Q(e){const s=e.data;if(s?.type)switch(s.type){case"auth-success":q(),b.value=!0,O.value="Loading admin panel...",y.clearAuthRequired(),Y();break;case"auth-error":s.cancelled||y.showMessage(s.message||"Authentication failed","error",5e3);break;case"auth-back":q(),b.value=!1,E.value=!0,y.showMessage("Authentication cancelled","info",3e3);break;case"auth-close-request":q();break}}oe(async()=>{window.addEventListener("message",Q),window.addEventListener("hashchange",J);const e=await Ie();e?.rp_name&&(document.title=e.rp_name+" Admin"),await Y(),y.authRequired&&K()}),Le(()=>{window.removeEventListener("message",Q),q()});const L=M(()=>t.value.find(e=>e.uuid===d.value)||null);function X(e){window.location.hash=`#org/${e.uuid}`}function Ue(){window.location.hash="#overview"}function Ce(e){window.location.hash=`#user/${e.uuid}`}const C=M(()=>{if(!u.value)return null;for(const e of t.value)for(const s of e.roles){const o=s.users.find(m=>m.uuid===u.value);if(o)return{...o,org_uuid:e.uuid,role_display_name:s.display_name}}return null}),Se=M(()=>C.value?"Admin: User":L.value?"Admin: Org":(y.settings?.rp_name||"Master")+" Admin"),Pe=M(()=>{const e=[{label:"Auth",href:qe()},{label:"Admin",href:Ve()}];let s=null;C.value&&(s=t.value.find(m=>m.uuid===C.value.org_uuid)||null);const o=L.value||s;return o&&e.push({label:o.display_name,href:`#org/${o.uuid}`}),C.value&&e.push({label:C.value.display_name||"User",href:`#user/${C.value.uuid}`}),e});H(C,async e=>{if(!e){c.value=null;return}try{const o=await(await fetch(`/auth/api/admin/orgs/${e.org_uuid}/users/${e.uuid}`)).json();if(o.detail)throw new Error(o.detail);c.value=o}catch(s){c.value={error:s.message}}});const x=$(!1);function Ne(e){x.value=!0}async function Ae(e,s,o){const m=e.permissions.includes(s);if(o&&m||!o&&!m)return;const f=o?[...e.permissions,s]:e.permissions.filter(v=>v!==s),g=[...e.permissions];e.permissions=f;try{const v=new URLSearchParams({permission_id:s}),se=await(await fetch(`/auth/api/admin/orgs/${e.uuid}/permission?${v.toString()}`,{method:o?"POST":"DELETE"})).json();if(se.detail)throw new Error(se.detail);await P()}catch(v){y.showMessage(v.message||"Failed to update organization permission"),e.permissions=g}}function N(e,s){p.value={type:e,data:s,busy:!1,error:""}}function ee(){p.value={type:null,data:null,busy:!1,error:""}}async function ae(){if(await P(),C.value)try{const e=await fetch(`/auth/api/admin/orgs/${C.value.org_uuid}/users/${C.value.uuid}`),s=await e.json();if(!e.ok||s.detail)throw new Error(s.detail||"Reload failed");c.value=s}catch(e){y.showMessage(e.message||"Failed to reload user","error")}}async function te(){await ae(),y.showMessage("User renamed","success",1500)}async function Te(){if(!(!p.value.type||p.value.busy)){p.value.busy=!0,p.value.error="";try{const e=p.value.type;if(e==="org-create"){const s=p.value.data.name?.trim();if(!s)throw new Error("Name required");const m=await(await fetch("/auth/api/admin/orgs",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({display_name:s,permissions:[]})})).json();if(m.detail)throw new Error(m.detail);await Promise.all([P(),I()])}else if(e==="org-update"){const{org:s}=p.value.data,o=p.value.data.name?.trim();if(!o)throw new Error("Name required");const f=await(await fetch(`/auth/api/admin/orgs/${s.uuid}`,{method:"PUT",headers:{"content-type":"application/json"},body:JSON.stringify({display_name:o,permissions:s.permissions})})).json();if(f.detail)throw new Error(f.detail);await P()}else if(e==="role-create"){const{org:s}=p.value.data,o=p.value.data.name?.trim();if(!o)throw new Error("Name required");const f=await(await fetch(`/auth/api/admin/orgs/${s.uuid}/roles`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({display_name:o,permissions:[]})})).json();if(f.detail)throw new Error(f.detail);await P()}else if(e==="role-update"){const{role:s}=p.value.data,o=p.value.data.name?.trim();if(!o)throw new Error("Name required");const f=await(await fetch(`/auth/api/admin/orgs/${s.org_uuid}/roles/${s.uuid}`,{method:"PUT",headers:{"content-type":"application/json"},body:JSON.stringify({display_name:o,permissions:s.permissions})})).json();if(f.detail)throw new Error(f.detail);await P()}else if(e==="user-create"){const{org:s,role:o}=p.value.data,m=p.value.data.name?.trim();if(!m)throw new Error("Name required");const g=await(await fetch(`/auth/api/admin/orgs/${s.uuid}/users`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({display_name:m,role:o.display_name})})).json();if(g.detail)throw new Error(g.detail);await P()}else if(e==="user-update-name"){const{user:s}=p.value.data,o=p.value.data.name?.trim();if(!o)throw new Error("Name required");const f=await(await fetch(`/auth/api/admin/orgs/${s.org_uuid}/users/${s.uuid}/display-name`,{method:"PUT",headers:{"content-type":"application/json"},body:JSON.stringify({display_name:o})})).json();if(f.detail)throw new Error(f.detail);await te()}else if(e==="perm-display"){const{permission:s}=p.value.data,o=p.value.data.id?.trim(),m=p.value.data.display_name?.trim();if(!m)throw new Error("Display name required");if(!o)throw new Error("ID required");if(o!==s.id){const f={old_id:s.id,new_id:o,display_name:m},g=await fetch("/auth/api/admin/permission/rename",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(f)});let v;try{v=await g.json()}catch{v={}}if(!g.ok||v.detail)throw new Error(v.detail||v.error||`Failed (${g.status})`)}else if(m!==s.display_name){const f=new URLSearchParams({permission_id:s.id,display_name:m}),v=await(await fetch(`/auth/api/admin/permission?${f.toString()}`,{method:"PUT"})).json();if(v.detail)throw new Error(v.detail)}await I()}else if(e==="perm-create"){const s=p.value.data.id?.trim();if(!s)throw new Error("ID required");const o=p.value.data.display_name?.trim();if(!o)throw new Error("Display name required");const f=await(await fetch("/auth/api/admin/permissions",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({id:s,display_name:o})})).json();if(f.detail)throw new Error(f.detail);await I(),p.value.data.display_name="",p.value.data.id=""}else if(e==="confirm"){const s=p.value.data.action;s&&await s()}ee()}catch(e){p.value.error=e.message||"Error"}finally{p.value.busy=!1}}}return(e,s)=>(r(),l("div",pt,[B(Fe),i("main",vt,[b.value?(r(),A(Ye,{key:0,message:O.value},null,8,["message"])):E.value?(r(),A(Ze,{key:1,onReload:Ee})):D.value&&(U.value?.is_global_admin||U.value?.is_org_admin)?(r(),l("section",wt,[i("header",bt,[i("h1",null,k(Se.value),1),B(Ke,{entries:Pe.value},null,8,["entries"])]),i("section",$t,[i("div",kt,[h.value?(r(),l("div",Dt,k(h.value),1)):(r(),l("div",Ot,[!C.value&&!L.value&&(U.value.is_global_admin||U.value.is_org_admin)?(r(),A(Ua,{key:0,info:U.value,orgs:t.value,permissions:n.value,"permission-summary":me.value,onCreateOrg:ge,onOpenOrg:X,onUpdateOrg:Z,onDeleteOrg:fe,onToggleOrgPermission:Ae,onOpenDialog:N,onDeletePermission:Re,onRenamePermissionDisplay:ce},null,8,["info","orgs","permissions","permission-summary"])):C.value?(r(),A(it,{key:1,"selected-user":C.value,"user-detail":c.value,"selected-org":L.value,loading:b.value,"show-reg-modal":x.value,onGenerateUserRegistrationLink:Ne,onGoOverview:Ue,onOpenOrg:X,onOnUserNameSaved:te,onRefreshUserDetail:ae,onEditUserName:he,onCloseRegModal:s[0]||(s[0]=o=>x.value=!1)},null,8,["selected-user","user-detail","selected-org","loading","show-reg-modal"])):L.value?(r(),A(Ya,{key:2,"selected-org":L.value,permissions:n.value,onUpdateOrg:Z,onCreateRole:$e,onUpdateRole:ke,onDeleteRole:De,onCreateUserInRole:ye,onOpenUser:Ce,onToggleRolePermission:Oe,onOnRoleDragOver:we,onOnRoleDrop:be,onOnUserDragStart:ve},null,8,["selected-org","permissions"])):R("",!0)]))])])])):R("",!0)]),B(yt,{dialog:p.value,"permission-id-pattern":Rt,onSubmitDialog:Te,onCloseDialog:ee},null,8,["dialog"])]))}},Ut=F(Et,[["__scopeId","data-v-658f846c"]]),ue=ze(Ut);ue.use(Je());ue.mount("#admin-app");

import{_ as T,r as c,w as E,o as q,a as B,c as w,m as j,b as z,d as b,e as i,f as a,g as I,h as k,i as N,u as o,j as H,k as O,n as Y,F as J,l as U,t as $,p as K,q as W}from"./_plugin-vue_export-helper-DBJ1JH0N.js";import{u as P,U as G,_ as Q,c as X}from"./UserBasicInfo-Cs5YqwNh.js";import{B as Z,_ as ee,a as se,N as ae,M as te,R as ne,L as oe,A as ie}from"./AccessDenied-CEEhbiIE.js";import{g as V}from"./helpers-CU0-cyzg.js";const re={class:"view-root","data-view":"profile"},le={class:"view-header"},ue={class:"section-block"},de={class:"section-block"},ce={class:"section-body"},fe={class:"button-row"},me={class:"section-block"},ge=["disabled"],ve=["disabled"],pe=["disabled"],he={key:0,class:"logout-note"},ye={key:1,class:"logout-note"},we={__name:"ProfileView",setup(x){const e=P(),l=c(null),u=c(!1),f=c(!1),g=c(""),v=c(!1);E(u,n=>{n&&(g.value=e.userInfo?.user?.user_name||"")}),q(()=>{l.value=setInterval(()=>{e.userInfo&&(e.userInfo={...e.userInfo})},6e4)}),B(()=>{l.value&&clearInterval(l.value)});const d=async()=>{try{e.isLoading=!0,e.showMessage("Adding new passkey...","info"),await K.register(),await e.loadUserInfo(),e.showMessage("New passkey added successfully!","success",3e3)}catch(n){console.error("Failed to add new passkey:",n),e.showMessage(n.message,"error")}finally{e.isLoading=!1}},A=async n=>{const s=n?.credential_uuid;if(s&&confirm("Are you sure you want to delete this passkey?"))try{await e.deleteCredential(s),e.showMessage("Passkey deleted successfully!","success",3e3)}catch(t){e.showMessage(`Failed to delete passkey: ${t.message}`,"error")}},_=w(()=>e.settings?.rp_name||"this service"),m=w(()=>e.userInfo?.sessions||[]),M=w(()=>m.value.find(s=>s.is_current)?.host||"this host"),p=c({}),S=async n=>{const s=n?.id;if(s){p.value={...p.value,[s]:!0};try{await e.terminateSession(s)}catch(t){e.showMessage(t.message||"Failed to terminate session","error",5e3)}finally{const t={...p.value};delete t[s],p.value=t}}},L=async()=>{await e.logoutEverywhere()},y=async()=>{await e.logout()},r=()=>{g.value=e.userInfo?.user?.user_name||"",u.value=!0},h=w(()=>!!(e.userInfo?.is_global_admin||e.userInfo?.is_org_admin)),C=w(()=>m.value.length>1),D=w(()=>{const n=[{label:"Auth",href:j()}];return h.value&&n.push({label:"Admin",href:z()}),n}),F=async()=>{const n=g.value.trim();if(!n){e.showMessage("Name cannot be empty","error");return}try{v.value=!0;const s=await fetch("/auth/api/user/display-name",{method:"PUT",headers:{"content-type":"application/json"},body:JSON.stringify({display_name:n})});if(s.status===401){e.authRequired=!0,e.showMessage("Authentication required","error");return}const t=await s.json();if(!s.ok||t.detail)throw new Error(t.detail||"Update failed");u.value=!1,await e.loadUserInfo(),e.showMessage("Name updated successfully!","success",3e3)}catch(s){e.showMessage(s.message||"Failed to update name","error")}finally{v.value=!1}};return(n,s)=>(i(),b("section",re,[a("header",le,[s[8]||(s[8]=a("h1",null,"ðŸ‘‹ Welcome!",-1)),I(Z,{entries:D.value},null,8,["entries"]),s[9]||(s[9]=a("p",{class:"view-lede"},"Manage your account details and passkeys.",-1))]),a("section",ue,[o(e).userInfo?.user?(i(),k(G,{key:0,name:o(e).userInfo.user.user_name,visits:o(e).userInfo.user.visits||0,"created-at":o(e).userInfo.user.created_at,"last-seen":o(e).userInfo.user.last_seen,loading:o(e).isLoading,"update-endpoint":"/auth/api/user/display-name",onSaved:s[0]||(s[0]=t=>o(e).loadUserInfo()),onEditName:r},null,8,["name","visits","created-at","last-seen","loading"])):N("",!0)]),a("section",de,[s[10]||(s[10]=a("div",{class:"section-header"},[a("h2",null,"Your Passkeys"),a("p",{class:"section-description"},"Keep at least one trusted passkey so you can always sign in.")],-1)),a("div",ce,[I(ee,{credentials:o(e).userInfo?.credentials||[],"aaguid-info":o(e).userInfo?.aaguid_info||{},loading:o(e).isLoading,"allow-delete":"",onDelete:A},null,8,["credentials","aaguid-info","loading"]),a("div",fe,[a("button",{onClick:d,class:"btn-primary"},"Add New Passkey"),a("button",{onClick:s[1]||(s[1]=t=>f.value=!0),class:"btn-secondary"},"Add Another Device")])])]),I(se,{sessions:m.value,"terminating-sessions":p.value,onTerminate:S,"section-description":"Review where you're signed in and end any sessions you no longer recognize."},null,8,["sessions","terminating-sessions"]),u.value?(i(),k(te,{key:0,onClose:s[4]||(s[4]=t=>u.value=!1)},{default:H(()=>[s[11]||(s[11]=a("h3",null,"Edit Display Name",-1)),a("form",{onSubmit:O(F,["prevent"]),class:"modal-form"},[I(ae,{label:"Display Name",modelValue:g.value,"onUpdate:modelValue":s[2]||(s[2]=t=>g.value=t),busy:v.value,onCancel:s[3]||(s[3]=t=>u.value=!1)},null,8,["modelValue","busy"])],32)]),_:1})):N("",!0),a("section",me,[a("div",{class:Y(["button-row logout-row",{single:!C.value}])},[a("button",{type:"button",class:"btn-secondary",onClick:s[5]||(s[5]=(...t)=>o(V)&&o(V)(...t))}," Back "),C.value?(i(),b(J,{key:1},[a("button",{onClick:y,class:"btn-danger logout-button",disabled:o(e).isLoading},"Logout",8,ve),a("button",{onClick:L,class:"btn-danger logout-button",disabled:o(e).isLoading},"All",8,pe)],64)):(i(),b("button",{key:0,onClick:L,class:"btn-danger logout-button",disabled:o(e).isLoading},"Logout",8,ge))],2),C.value?(i(),b("p",ye,[s[13]||(s[13]=a("strong",null,"Logout",-1)),U(" this session on "+$(M.value)+", or ",1),s[14]||(s[14]=a("strong",null,"All",-1)),U(" sessions across all sites and devices for "+$(_.value)+". You'll need to log in again with your passkey afterwards.",1)])):(i(),b("p",he,[s[12]||(s[12]=a("strong",null,"Logout",-1)),U(" from "+$(M.value)+".",1)]))]),f.value?(i(),k(ne,{key:1,endpoint:"/auth/api/user/create-link","auto-copy":!1,"prefix-copy-with-user-name":!1,onClose:s[6]||(s[6]=t=>f.value=!1),onCopied:s[7]||(s[7]=t=>{f.value=!1,o(e).showMessage("Link copied to clipboard!","success",2500)})})):N("",!0)]))}},be=T(we,[["__scopeId","data-v-04f571b6"]]),ke={class:"app-shell"},_e={class:"app-main"},Ie={__name:"App",setup(x){const e=P(),l=c(!0),u=c("Loading..."),f=c(!1),g=c(!1);let v=null,d=null;E(()=>e.authRequired,r=>{r&&(f.value=!1,l.value=!0,y(),_(),e.clearAuthRequired())});async function A(){try{return await e.loadUserInfo(),f.value=!0,l.value=!1,L(),!0}catch{return!1}}function _(){m(),d=document.createElement("iframe"),d.id="auth-iframe",d.title="Authentication",d.src="/auth/restricted/?mode=login",document.body.appendChild(d),u.value="Authentication required..."}function m(){d&&(d.remove(),d=null)}function M(){window.location.reload()}function p(r){const h=r.data;if(h?.type)switch(h.type){case"auth-success":m(),l.value=!0,u.value="Loading user profile...",e.clearAuthRequired(),A();break;case"auth-error":h.cancelled?console.log("Authentication cancelled by user"):e.showMessage(h.message||"Authentication failed","error",5e3);break;case"auth-cancelled":console.log("Authentication cancelled");break;case"auth-back":m(),l.value=!1,g.value=!0,e.showMessage("Authentication cancelled","info",3e3);break;case"auth-close-request":m();break}}async function S(){try{(await fetch("/auth/api/validate",{method:"POST",credentials:"include"})).status===401&&(console.log("Session expired, requiring re-authentication"),f.value=!1,l.value=!0,y(),_())}catch(r){console.error("Session validation error:",r)}}function L(){y(),v=setInterval(S,120*1e3)}function y(){v&&(clearInterval(v),v=null)}return q(async()=>{window.addEventListener("message",p),await e.loadSettings(),e.settings?.rp_name&&(document.title=e.settings.rp_name),await A()||_()}),B(()=>{window.removeEventListener("message",p),y(),m()}),(r,h)=>(i(),b("div",ke,[I(Q),a("main",_e,[f.value?(i(),k(be,{key:0})):l.value?(i(),k(oe,{key:1,message:u.value},null,8,["message"])):g.value?(i(),k(ie,{key:2,onReload:M})):N("",!0)])]))}},R=W(Ie);R.use(X());R.mount("#app");

import{_ as z,I as L,r as g,c as y,o as M,d,e as f,i as h,f as o,t as b,n as N,C as O,B as j,p as q}from"./_plugin-vue_export-helper-DBJ1JH0N.js";const D={class:"app-shell"},E={key:0,class:"global-status",style:{display:"block"}},Y={class:"view-root"},J={key:0,class:"surface surface--tight"},W={class:"view-header center"},G={key:0,class:"user-line"},H={class:"view-lede"},K={class:"section-block"},Q={class:"section-body center"},X={class:"button-row center"},Z=["disabled"],ee=["disabled"],te=["disabled"],ae=["disabled"],se={__name:"RestrictedAuth",props:{mode:{type:String,default:"login",validator:n=>["login","reauth","forbidden"].includes(n)}},emits:["authenticated","forbidden","logout","back","home","auth-error"],setup(n,{expose:C,emit:T}){const i=n,v=T,l=L({show:!1,message:"",type:"info"}),w=g(!0),t=g(!1),k=g(null),u=g(null),r=g("initial");let _=null;const c=y(()=>!!u.value?.authenticated),p=y(()=>w.value?!1:i.mode==="reauth"?!0:!(i.mode==="forbidden"||r.value==="forbidden")),V=y(()=>i.mode==="reauth"?"ðŸ” Additional Verification Required":i.mode==="forbidden"||r.value==="forbidden"?"ðŸš« Forbidden":`ðŸ” ${k.value?.rp_name||location.origin}`),$=y(()=>i.mode==="reauth"?"Please verify your identity to continue with this action.":i.mode==="forbidden"||r.value==="forbidden"?"You lack the required permissions.":"Please sign in with your passkey."),B=y(()=>u.value?.user?.user_name||"User");function m(e,a="info",s=3e3){l.show=!0,l.message=e,l.type=a,_&&clearTimeout(_),s>0&&(_=setTimeout(()=>{l.show=!1},s))}async function I(){try{const e=await j();if(k.value=e,e?.rp_name){const a=i.mode==="reauth"?"Verify Identity":c.value?"Forbidden":"Sign In";document.title=`${e.rp_name} Â· ${a}`}}catch(e){console.warn("Unable to load settings",e)}}async function U(){try{const e=await fetch("/auth/api/user-info",{method:"POST"});if(!e.ok){u.value=null,r.value="login";return}u.value=await e.json(),c.value&&i.mode!=="reauth"?(r.value="forbidden",v("forbidden",u.value)):r.value="login"}catch(e){console.error("Failed to load user info",e),r.value="login"}}async function S(){if(!p.value||t.value)return;t.value=!0,m("Starting authenticationâ€¦","info");let e;try{e=await q.authenticate()}catch(a){t.value=!1;const s=a?.message||"Passkey authentication cancelled",A=s==="Passkey authentication cancelled";m(s,A?"info":"error",4e3),v("auth-error",{message:s,cancelled:A});return}try{await R(e.session_token)}catch(a){t.value=!1;const s=a?.message||"Failed to establish session";m(s,"error",4e3),v("auth-error",{message:s,cancelled:!1});return}t.value=!1,v("authenticated",e)}async function P(){if(!t.value){t.value=!0;try{await fetch("/auth/api/logout",{method:"POST"}),u.value=null,r.value="login",m("Logged out. You can sign in with a different account.","info",3e3)}catch{}finally{t.value=!1}v("logout")}}function F(){const e=window.open("/auth/","passkey_auth_profile");e&&e.focus()}async function R(e){const a=await fetch("/auth/api/set-session",{method:"POST",headers:{Authorization:`Bearer ${e}`}}),s=await x(a);if(!a.ok||s?.detail)throw new Error(s?.detail||"Session could not be established.");return s}async function x(e){try{return await e.json()}catch{return null}}return M(async()=>{await I(),await U(),w.value=!1}),C({showMessage:m,isAuthenticated:c,userInfo:u}),(e,a)=>(f(),d("div",D,[l.show?(f(),d("div",E,[o("div",{class:N(["status",l.type])},b(l.message),3)])):h("",!0),o("main",Y,[w.value?h("",!0):(f(),d("div",J,[o("header",W,[o("h1",null,b(V.value),1),c.value?(f(),d("p",G,"ðŸ‘¤ "+b(B.value),1)):h("",!0),o("p",H,b($.value),1)]),o("section",K,[o("div",Q,[o("div",X,[O(e.$slots,"actions",{loading:t.value,canAuthenticate:p.value,isAuthenticated:c.value,authenticate:S,logout:P,mode:n.mode},()=>[o("button",{class:"btn-secondary",disabled:t.value,onClick:a[0]||(a[0]=s=>e.$emit("back"))},"Back",8,Z),p.value?(f(),d("button",{key:0,class:"btn-primary",disabled:t.value,onClick:S},b(t.value?n.mode==="reauth"?"Verifyingâ€¦":"Signing inâ€¦":n.mode==="reauth"?"Verify":"Login"),9,ee)):h("",!0),c.value&&n.mode!=="reauth"&&n.mode!=="forbidden"?(f(),d("button",{key:1,class:"btn-danger",disabled:t.value,onClick:P},"Logout",8,te)):h("",!0),c.value&&n.mode!=="reauth"&&n.mode!=="forbidden"?(f(),d("button",{key:2,class:"btn-primary",disabled:t.value,onClick:F},"Profile",8,ae)):h("",!0)])])])])]))])]))}},oe=z(se,[["__scopeId","data-v-87fd28cb"]]);export{oe as R};

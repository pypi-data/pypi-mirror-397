#!/usr/bin/env python3
"""
FastAPI Metrics Setup Helper CLI
Interactive setup with customized documentation export
"""

import sys
import json
import argparse
from datetime import datetime


def print_header():
    """Print CLI header."""
    print("\n" + "=" * 70)
    print("  FastAPI Metrics - Interactive Setup Wizard")
    print("  Version 0.3.0")
    print("=" * 70 + "\n")


def ask_question(question, options=None, default=None):
    """Ask a question and return the answer."""
    if options:
        print(f"\n{question}")
        for i, opt in enumerate(options, 1):
            print(f"  {i}. {opt}")
        if default:
            prompt = f"Choice (default: {default}): "
        else:
            prompt = "Choice: "

        while True:
            answer = input(prompt).strip()
            if not answer and default:
                return default
            try:
                choice = int(answer)
                if 1 <= choice <= len(options):
                    return choice
            except ValueError:
                pass
            print("Invalid choice. Try again.")
    else:
        if default:
            prompt = f"{question} (default: {default}): "
        else:
            prompt = f"{question}: "
        answer = input(prompt).strip()
        return answer if answer else default


def ask_yes_no(question, default="n"):
    """Ask a yes/no question."""
    answer = ask_question(question + " (y/n)", default=default)
    return answer.lower() in ["y", "yes"]


def generate_setup_code(config):
    """Generate setup code based on configuration."""

    storage_map = {
        1: 'storage="sqlite://metrics.db"',
        2: 'storage="memory://"',
        3: 'storage=os.getenv("REDIS_URL", "redis://localhost:6379/0")',
    }

    imports = ["from fastapi import FastAPI", "from fastapi_metrics import Metrics"]

    if config["storage"] == 3:
        imports.append("import os")

    if config["enable_alerts"]:
        imports.append("from fastapi_metrics.alerting import Alert")

    params = [
        "app",
        storage_map[config["storage"]],
        f"retention_hours={config['retention']}",
    ]

    if config["enable_health"]:
        params.append("enable_health_checks=True")

    if config["enable_system"]:
        params.append("enable_system_metrics=True")

    if config["enable_alerts"]:
        params.append('alert_webhook_url="https://your-webhook-url.com"')

    code = f"""# {config["app_name"]}.py
# Generated by fastapi-metrics setup wizard
# Date: {datetime.now().strftime("%Y-%m-%d %H:%M")}

{chr(10).join(imports)}

app = FastAPI()

# Initialize FastAPI Metrics
metrics = Metrics(
    {("," + chr(10) + "    ").join(params)},
)
"""

    if config["track_llm"]:
        code += """
# Track LLM API costs
@app.post("/api/chat")
async def chat(prompt: str):
    # Your OpenAI/Anthropic call here...
    
    # Track OpenAI costs
    await metrics.llm_costs.track_openai_call(
        model="gpt-4o",
        input_tokens=100,
        output_tokens=200,
        user_id=123,
    )
    
    # Or track Anthropic costs
    await metrics.llm_costs.track_anthropic_call(
        model="claude-3-5-sonnet-20241022",
        input_tokens=150,
        output_tokens=300,
        user_id=123,
    )
    
    return {"response": "AI response"}
"""

    code += """
# Track custom business metrics
@app.post("/payment")
async def payment(amount: float, user_id: int):
    # Your payment logic...
    
    # Track metrics
    await metrics.track("revenue", amount, user_id=user_id)
    await metrics.track("payment_count", 1)
    
    return {"status": "success"}
"""

    if config["enable_alerts"]:
        code += """
# Configure alerts
if metrics.alert_manager:
    # Alert on high error rate
    metrics.alert_manager.add_alert(Alert(
        name="high_error_rate",
        metric_name="error_rate",
        threshold=0.05,
        comparison=">",
        window_minutes=5,
    ))
    
    # Alert on high LLM costs
    metrics.alert_manager.add_alert(Alert(
        name="high_llm_costs",
        metric_name="llm_cost",
        threshold=10.0,
        comparison=">",
        window_minutes=60,
    ))
"""

    return code


def generate_documentation(config):
    """Generate customized documentation."""
    # pylint: disable=duplicate-code
    # This function intentionally builds documentation strings with repeated
    # patterns for conditional feature sections. The duplication is a natural
    # consequence of generating markdown documentation blocks.

    doc = f"""# FastAPI Metrics - Your Custom Setup Guide

Generated: {datetime.now().strftime("%Y-%m-%d %H:%M")}

## Your Configuration

- **Deployment**: {
    ["Single Server (SQLite)", "Development (Memory)", "Kubernetes (Redis)"]
    [config["storage"]-1]
    }
- **Data Retention**: {config["retention"]} hours
- **Health Checks**: {"‚úì Enabled" if config["enable_health"] else "‚úó Disabled"}
- **System Metrics**: {"‚úì Enabled" if config["enable_system"] else "‚úó Disabled"}
- **LLM Cost Tracking**: {"‚úì Enabled" if config["track_llm"] else "‚úó Disabled"}
- **Alerting**: {"‚úì Enabled" if config["enable_alerts"] else "‚úó Disabled"}

## Installation

```bash
"""

    # Installation command
    install_cmd = "pip install fastapi-metrics"
    extras = []
    if config["storage"] == 3:
        extras.append("redis")
    if config["enable_alerts"]:
        extras.append("alerts")

    if extras:
        install_cmd += f"[{','.join(extras)}]"

    doc += f"{install_cmd}\n```\n\n"

    doc += """## Quick Start

1. Copy the generated code to your FastAPI app
2. Run your app: `uvicorn your_app:app --reload`
3. Access metrics at: `http://localhost:8000/metrics`

## Available Endpoints

### Core Endpoints
- `GET /metrics` - Current metrics snapshot
- `GET /metrics/query` - Query time-series data
- `GET /metrics/endpoints` - Per-endpoint statistics
- `POST /metrics/cleanup` - Manual cleanup

"""

    if config["enable_health"]:
        doc += """### Health Check Endpoints (Kubernetes)
- `GET /health` - Overall health status
- `GET /health/live` - Liveness probe
- `GET /health/ready` - Readiness probe

"""

    if config["track_llm"]:
        doc += """### LLM Cost Tracking
- `GET /metrics/costs?hours=24` - LLM API cost breakdown
  - Total costs by provider (OpenAI, Anthropic)
  - Costs by model
  - Token usage statistics

"""

    if config["enable_system"]:
        doc += """### System Metrics
- `GET /metrics/system` - Current system resources
  - CPU usage percentage
  - Memory stats (used, available, total)
  - Disk stats (free, used, total)

"""

    doc += """### Export Formats
- `GET /metrics/export/prometheus` - Prometheus format export

"""

    doc += """## Example Queries

```bash
# Get all HTTP metrics from last 24 hours
curl "http://localhost:8000/metrics/query?metric_type=http&from_hours=24"

# Get custom metrics grouped by hour
curl "http://localhost:8000/metrics/query?metric_type=custom&name=revenue&group_by=hour"

# Get per-endpoint statistics
curl http://localhost:8000/metrics/endpoints
"""

    if config["track_llm"]:
        doc += """
# Get LLM costs breakdown
curl "http://localhost:8000/metrics/costs?hours=24"
"""

    if config["enable_system"]:
        doc += """
# Get current system metrics
curl http://localhost:8000/metrics/system
"""

    doc += """
# Export to Prometheus format
curl "http://localhost:8000/metrics/export/prometheus?hours=1"
```

"""

    if config["storage"] == 3:
        doc += """## Kubernetes Deployment

Your app uses Redis for distributed metrics. Example deployment:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: fastapi-app
spec:
  replicas: 3
  template:
    spec:
      containers:
      - name: app
        image: your-app:latest
        env:
        - name: REDIS_URL
          value: "redis://redis-service:6379/0"
        livenessProbe:
          httpGet:
            path: /health/live
            port: 8000
        readinessProbe:
          httpGet:
            path: /health/ready
            port: 8000
```

"""

    if config["enable_alerts"]:
        doc += """## Alerting Setup

Configure your webhook URL in the code:
- Slack: Create incoming webhook in Slack settings
- Discord: Create webhook in channel settings
- Custom: Any endpoint that accepts POST requests

Alert payload format:
```json
{
  "alert": "high_error_rate",
  "metric": "error_rate",
  "value": 0.08,
  "threshold": 0.05,
  "comparison": ">",
  "timestamp": "2024-12-11T12:00:00"
}
```

"""

    doc += """## Tracking Custom Metrics

Track any business metric:

```python
# Revenue
await metrics.track("revenue", 99.99, user_id=123, plan="pro")

# User signups
await metrics.track("signups", 1, source="organic")

# Feature usage
await metrics.track("feature_export", 1, format="csv")

# API calls
await metrics.track("api_calls", 1, endpoint="/search")
```

"""

    if config["track_llm"]:
        doc += """## LLM Cost Tracking

### OpenAI
```python
await metrics.llm_costs.track_openai_call(
    model="gpt-4o",           # or gpt-4, gpt-3.5-turbo, o1, etc.
    input_tokens=100,
    output_tokens=200,
    user_id=123,              # optional labels
)
```

### Anthropic
```python
await metrics.llm_costs.track_anthropic_call(
    model="claude-3-5-sonnet-20241022",
    input_tokens=150,
    output_tokens=300,
    endpoint="/chat",         # optional labels
)
```

Supported Models:
- **OpenAI**: GPT-4, GPT-4 Turbo, GPT-4o, GPT-4o Mini, GPT-3.5 Turbo, o1, o1-mini
- **Anthropic**: Claude 3.5 Sonnet, Claude 3.5 Haiku, Claude 3 Opus, Claude 3 Sonnet, Claude 3 Haiku

"""

    doc += """## Next Steps

1. ‚úì Installation complete
2. ‚úì Code generated
3. ‚ñ¢ Test endpoints with curl
4. ‚ñ¢ Integrate into your app
5. ‚ñ¢ Set up monitoring dashboard (Grafana, Retool, etc.)
6. ‚ñ¢ Configure production settings

## Support

- GitHub: https://github.com/arpit0515/fastapi-metrics
- Issues: https://github.com/arpit0515/fastapi-metrics/issues
- Docs: Check USAGE_GUIDE.md in the repo

---
Generated by FastAPI Metrics v0.3.0
"""

    return doc


def main():
    """Main CLI flow."""
    print_header()

    print("This wizard will help you set up FastAPI Metrics with the features you need.\n")

    config = {}

    # Question 1: Deployment type
    config["storage"] = ask_question(
        "What type of deployment?",
        options=[
            "Single server (VPS, EC2) - Use SQLite",
            "Development/Testing - Use in-memory storage",
            "Kubernetes/Multi-instance - Use Redis",
        ],
        default=1,
    )

    # Question 2: Data retention
    config["retention"] = int(ask_question("How many hours of data should be kept?", default=24))

    # Question 3: Health checks
    if config["storage"] == 3:
        config["enable_health"] = True
        print("‚úì Kubernetes health checks will be enabled automatically")
    else:
        config["enable_health"] = ask_yes_no("Enable Kubernetes health checks?", "n")

    # Question 4: System metrics
    config["enable_system"] = ask_yes_no("Track system metrics (CPU, Memory, Disk)?", "n")

    # Question 5: LLM cost tracking
    config["track_llm"] = ask_yes_no("Track LLM API costs (OpenAI/Anthropic)?", "n")

    # Question 6: Alerting
    config["enable_alerts"] = ask_yes_no("Enable alerting with webhooks?", "n")

    # Question 7: App name
    config["app_name"] = ask_question("What's your main app file name?", default="main")

    # Generate code
    print("\n" + "=" * 70)
    print("  Generated Setup Code")
    print("=" * 70)

    setup_code = generate_setup_code(config)
    print(setup_code)

    # Save code
    print("\n" + "=" * 70)
    save_code = ask_yes_no("Save code to file?", "y")

    code_file = None
    if save_code:
        filename = ask_question("Code filename", default=f"{config['app_name']}_metrics.py")
        with open(filename, "w", encoding="utf8") as f:
            f.write(setup_code)
        code_file = filename
        print(f"\n‚úì Code saved to {filename}")

    # Generate documentation
    print("\n" + "=" * 70)
    save_docs = ask_yes_no("Generate customized documentation?", "y")

    doc_file = None
    if save_docs:
        doc = generate_documentation(config)
        doc_filename = ask_question("Documentation filename", default="METRICS_SETUP.md")
        with open(doc_filename, "w", encoding="utf8") as f:
            f.write(doc)
        doc_file = doc_filename
        print(f"\n‚úì Documentation saved to {doc_filename}")

    # Generate config JSON
    config_data = {
        "generated_at": datetime.now().isoformat(),
        "version": "0.3.0",
        "config": config,
        "files": {
            "code": code_file,
            "docs": doc_file,
        },
    }

    with open("metrics_config.json", "w", encoding="utf8") as f:
        json.dump(config_data, f, indent=2)

    # Summary
    print("\n" + "=" * 70)
    print("  Setup Complete!")
    print("=" * 70)
    print(
        f"""
Files created:
  {f'‚úì {code_file} - Your metrics setup code' if code_file else ''}
  {f'‚úì {doc_file} - Customized documentation' if doc_file else ''}
  ‚úì metrics_config.json - Configuration backup

Next steps:
  1. Install: {
      f"""pip install fastapi-metrics{'[redis,alerts]'
    if config['storage'] == 3 or config['enable_alerts'] else ''}"""
      if config['storage'] == 3 or config['enable_alerts'] else "pip install fastapi-metrics"}
  2. Copy generated code to your app
  3. Run: uvicorn {config['app_name']}:app --reload
  4. Test: curl http://localhost:8000/metrics

View your customized docs: {doc_file if doc_file else 'METRICS_SETUP.md'}

Happy tracking! üöÄ
"""
    )


def run_cli():
    """CLI entry point with argument parsing."""
    parser = argparse.ArgumentParser(
        prog="fastapi-metrics",
        description="FastAPI Metrics - Zero-config metrics for FastAPI apps",
        epilog="For more information, visit: https://github.com/arpit0515/fastapi-metrics",
    )

    parser.add_argument(
        "-cli",
        "--cli",
        action="store_true",
        help="Run the interactive setup wizard",
    )

    parser.add_argument(
        "-v",
        "--version",
        action="version",
        version="%(prog)s 0.3.3",
    )

    args = parser.parse_args()

    # If no arguments or -cli flag, run interactive setup
    if args.cli or len(sys.argv) == 1:
        try:
            main()
        except KeyboardInterrupt:
            print("\n\nSetup cancelled.")
            sys.exit(0)
        except Exception as e:  # pylint: disable=broad-except
            print(f"\n\n‚ùå Error: {e}")
            sys.exit(1)


if __name__ == "__main__":
    run_cli()

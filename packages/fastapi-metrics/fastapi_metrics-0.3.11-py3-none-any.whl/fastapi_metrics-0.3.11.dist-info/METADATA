Metadata-Version: 2.4
Name: fastapi-metrics
Version: 0.3.11
Summary: Zero-config metrics for FastAPI apps - perfect for solo devs and MVPs
Author-email: Arpit <arpit.thukral@gmail.com>
License: MIT
Project-URL: Homepage, https://github.com/arpit0515/fastapi-metrics
Project-URL: Repository, https://github.com/arpit0515/fastapi-metrics
Project-URL: Issues, https://github.com/arpit0515/fastapi-metrics/issues
Keywords: fastapi,metrics,observability,sqlite,monitoring,redis,prometheus,kubernetes
Classifier: Development Status :: 3 - Alpha
Classifier: Intended Audience :: Developers
Classifier: License :: OSI Approved :: MIT License
Classifier: Programming Language :: Python :: 3
Classifier: Programming Language :: Python :: 3.8
Classifier: Programming Language :: Python :: 3.9
Classifier: Programming Language :: Python :: 3.10
Classifier: Programming Language :: Python :: 3.11
Classifier: Framework :: FastAPI
Requires-Python: >=3.8
Description-Content-Type: text/markdown
License-File: LICENSE
Requires-Dist: aioboto3>=11.0.0
Requires-Dist: asyncpg>=0.27.0
Requires-Dist: rich>=13.0.0
Requires-Dist: uvicorn>=0.22.0
Requires-Dist: fastapi>=0.100.0
Requires-Dist: pydantic>=2.0.0
Requires-Dist: aiosqlite>=0.19.0
Requires-Dist: psutil>=5.9.0
Provides-Extra: dev
Requires-Dist: aioboto3>=11.0.0; extra == "dev"
Requires-Dist: asyncpg>=0.27.0; extra == "dev"
Requires-Dist: rich>=13.0.0; extra == "dev"
Requires-Dist: uvicorn>=0.22.0; extra == "dev"
Requires-Dist: pytest>=7.4.0; extra == "dev"
Requires-Dist: pytest-asyncio>=0.21.0; extra == "dev"
Requires-Dist: httpx>=0.24.0; extra == "dev"
Requires-Dist: black>=23.0.0; extra == "dev"
Requires-Dist: ruff>=0.0.280; extra == "dev"
Dynamic: license-file

# FastAPI Metrics - Project Specification

## Project Vision
Zero-config metrics and observability for FastAPI apps targeting indie devs, startups, and no-code platforms. No Prometheus/Grafana infrastructure required.

## Core Value Proposition
- **5-minute setup**: One import, one line of code
- **No infrastructure**: SQLite/memory storage, no containers
- **Business metrics**: Track revenue, users, features - not just HTTP metrics
- **Query API**: JSON endpoints for custom dashboards
- **Cost tracking**: Auto-detect OpenAI/Anthropic API costs
- **No-code ready**: Retool/Bubble can consume the API directly

---

## Target Users
1. Indie developers building MVPs
2. Early-stage startups (pre-Series A)
3. No-code platform backends (Bubble, Retool, Make.com)
4. Developers prototyping without DevOps resources

---

## Technical Architecture

### Package Structure
```
fastapi-metrics/
â”œâ”€â”€ fastapi_metrics/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ core.py              # Main Metrics class
â”‚   â”œâ”€â”€ middleware.py        # Request tracking middleware
â”‚   â”œâ”€â”€ storage/
â”‚   â”‚   â”œâ”€â”€ base.py          # Storage interface
â”‚   â”‚   â”œâ”€â”€ memory.py        # In-memory storage
â”‚   â”‚   â”œâ”€â”€ sqlite.py        # SQLite storage
â”‚   â”‚   â””â”€â”€ redis.py         # Redis storage (optional)
â”‚   â”œâ”€â”€ collectors/
â”‚   â”‚   â”œâ”€â”€ http.py          # HTTP request metrics
â”‚   â”‚   â”œâ”€â”€ system.py        # CPU, memory, disk
â”‚   â”‚   â”œâ”€â”€ business.py      # Custom business metrics
â”‚   â”‚   â””â”€â”€ cost.py          # LLM API cost tracking
â”‚   â”œâ”€â”€ health/
â”‚   â”‚   â”œâ”€â”€ checks.py        # Health check implementations
â”‚   â”‚   â””â”€â”€ endpoints.py     # Health endpoints
â”‚   â”œâ”€â”€ query.py             # Metrics query engine
â”‚   â””â”€â”€ exporters/
â”‚       â”œâ”€â”€ json.py          # JSON export
â”‚       â”œâ”€â”€ prometheus.py    # Prometheus format
â”‚       â””â”€â”€ csv.py           # CSV export
â”œâ”€â”€ tests/
â”œâ”€â”€ examples/
â”œâ”€â”€ docs/
â””â”€â”€ pyproject.toml
```

---

## Phase 1: Core Functionality â³

### 1.1 Basic Setup & Middleware
- âœ… Main `Metrics` class initialization
- âœ… FastAPI app integration
- âœ… Request tracking middleware
- âœ… Response time calculation
- âœ… Status code tracking

### 1.2 Storage Backends
- âœ… Abstract storage interface
- âœ… In-memory storage (dict-based)
- âœ… SQLite storage with tables:
  - `http_requests` (timestamp, endpoint, method, status, latency_ms)
  - `custom_metrics` (timestamp, metric_name, value, labels)
  - `system_metrics` (timestamp, cpu, memory, disk)

### 1.3 HTTP Metrics Collection
- âœ… Requests per endpoint
- âœ… Requests per status code
- âœ… Requests per method
- âœ… Latency percentiles (p50, p95, p99)
- âœ… Error rate calculation
- âœ… Active requests counter

### 1.4 Query API Endpoints
- âœ… `GET /metrics` - Current snapshot (JSON)
- âœ… `GET /metrics/query` - Time-series queries
  - Query params: `from`, `to`, `metric`, `group_by`, `endpoint`
- âœ… `GET /metrics/endpoints` - Per-endpoint stats
- âœ… `GET /metrics/export?format=csv|prometheus`

---

## Phase 2: Health Checks & System Metrics â³

### 2.1 Health Check System
- âœ… Health check base class
- âœ… Built-in checks:
  - âœ… Database connectivity
  - âœ… Redis connectivity
  - âœ… Disk space
  - âœ… Memory usage
  - âœ… Custom check support
- âœ… Health endpoints:
  - âœ… `GET /health` - Simple status
  - âœ… `GET /health/live` - Liveness probe
  - âœ… `GET /health/ready` - Readiness probe with checks

### 2.2 System Metrics
- âœ… CPU usage tracking
- âœ… Memory usage tracking
- âœ… Disk usage tracking
- âœ… Uptime tracking
- âœ… System metrics endpoint

### 2.3 Additional
- âœ…Make Redis storage first-class (not optional)
- âœ… Add proper K8s health checks (Phase 2 should be Phase 1)
- âœ… Add deployment examples for multi-instance setups
- âœ… Position as "lightweight alternative to Prometheus that scales"

---

## Phase 3: Business Metrics & Cost Tracking â³

### 3.1 Custom Business Metrics
- âœ… `metrics.track(name, value, **labels)` API
- âœ… Counter metrics
- âœ… Gauge metrics
- âœ… Histogram metrics
- âœ… Label/tag support for segmentation

### 3.2 LLM Cost Tracking
- âœ… Auto-detect OpenAI API calls
- âœ… Auto-detect Anthropic API calls
- âœ… Token usage tracking
- âœ… Cost calculation (using current pricing)
- âœ… Cost by model/endpoint
- âœ… `GET /metrics/costs` endpoint

---

## Phase 4: Advanced Features â³

### 4.1 Retention & Cleanup
- [ ] Configurable retention period
- [ ] Automatic data cleanup job
- [ ] Aggregation for old data (hourly â†’ daily)

### 4.2 Alerting (Simple)
- [ ] Threshold-based alerts
- [ ] Webhook notifications
- [ ] Email notifications (optional)

### 4.3 Export Formats
- [ ] Prometheus format
- [ ] CSV export
- [ ] JSON export with timestamps


---

## Phase 5: Documentation & Examples â³

### 5.1 Documentation
- [ ] README with quick start
- [ ] Full API documentation
- [ ] Configuration guide
- [ ] Storage backend comparison
- [ ] Kubernetes deployment guide

### 5.2 Examples
- [ ] Basic FastAPI app
- [ ] With database health checks
- [ ] Custom business metrics
- [ ] LLM cost tracking
- [ ] Retool integration example
- [ ] No-code tool integration guide

### 5.3 Testing
- [ ] Unit tests (80%+ coverage)
- [ ] Integration tests
- [ ] Performance benchmarks

---

## API Design (MVP)

### Basic Usage
```python
from fastapi import FastAPI
from fastapi_metrics import Metrics

app = FastAPI()

# Minimal setup
metrics = Metrics(
    app,
    storage="sqlite://metrics.db",  # or "memory://"
    retention_hours=24,
)

# Track custom metrics anywhere
@app.post("/payment")
def payment(amount: float, user_id: int):
    metrics.track("revenue", amount, user_id=user_id)
    metrics.track("payment_count", 1)
    return {"status": "ok"}
```

### Query Examples
```
GET /metrics
GET /metrics/query?metric=revenue&from=24h&group_by=hour
GET /metrics/endpoints
GET /metrics/costs
GET /health/ready
```

---

## Key Decisions

### Storage Strategy
- **Default**: SQLite (single file, no setup)
- **Optional**: Redis (for distributed systems)
- **Fallback**: In-memory (testing/development)

### Data Model
- Store raw events initially
- Aggregate on query (Phase 1)
- Pre-aggregate for performance (Phase 4)

### Performance
- Async middleware (non-blocking)
- Background workers for aggregation
- Configurable batch writes
- Query result caching

---

## Success Metrics
- [ ] < 5 lines of code to set up
- [ ] < 1ms overhead per request
- [ ] Works with SQLite (no external deps)
- [ ] Query API returns in < 100ms
- [ ] Retool/Bubble integration works out-of-box

---

## Non-Goals (v1)
- âŒ Replace Prometheus/Grafana for large scale
- âŒ Distributed tracing
- âŒ Log aggregation
- âŒ APM-level profiling
- âŒ Built-in UI (JSON API only)

---

## Dependencies (Keep Minimal)
```toml
[dependencies]
fastapi = ">=0.100.0"
pydantic = ">=2.0.0"
aiosqlite = ">=0.19.0"  # Async SQLite
psutil = ">=5.9.0"      # System metrics
httpx = ">=0.24.0"      # For health checks (optional)
```

---

## Progress Tracker

### âœ… Completed
- Phase 1: Core functionality
- Phase 2: Health checks
- Phase 3: Business metrics
- Phase 4: Advanced features


### ğŸš§ In Progress
- Phase 5: Documentation

### â³ Todo
- Phase 6: Additional Features 
---

## Quick Start Command (Future)
```bash
pip install fastapi-metrics
```

## Development Setup (Future)
```bash
git clone https://github.com/yourusername/fastapi-metrics
cd fastapi-metrics
poetry install
poetry run pytest
```

---

## Notes & Decisions Log
- 2025-12-10: Initial spec created
- Target: Indie devs who want metrics without infrastructure
- Focus: Simplicity over enterprise features
- SQLite as default storage for zero-config experience

---

![Check errors in terminal](image.png)

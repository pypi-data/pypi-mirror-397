# DISA/DoD XCCDF Export Mapping Configuration
# Maps CIS Benchmark data to DISA STIG-compatible XCCDF format
# Version: 1.0.0
# XCCDF Target: 1.2 (backward compatible with 1.1.4 STIG tools)

# Inherit common configuration (namespaces, transformations, etc.)
extends: base_style.yaml

metadata:
  style_name: "disa"
  description: "DISA/DoD STIG-compatible XCCDF export"
  xccdf_version: "1.1.4"  # STIGs use 1.1.4, not 1.2
  xccdf_namespace: "http://checklists.nist.gov/xccdf/1.1"
  target_tools:
    - "DISA SCAP Compliance Checker (SCC)"
    - "OpenSCAP (DoD configurations)"
    - "DISA STIG Viewer"
    - "Nessus (Government)"
  conventions: "Follows DISA STIG XML structure and element naming (conventions v1.10.0)"

# Benchmark-level mappings
benchmark:
  # ID generation
  id_template: "xccdf_org.cisecurity_benchmark_{platform}{benchmark_id}"

  # Namespaces inherited from base_style.yaml (common + controls/enhanced)
  # Can override here if needed for DISA-specific requirements

  # Core elements (with XCCDF type specifications)
  title:
    source: "title"
    transform: "none"
    xccdf_type: "TextType"  # Benchmark.title uses TextType (with 'value'), not TextWithSubType

  description:
    source: "title"
    transform: "none"
    prepend_text: "CIS Benchmark exported to DISA STIG format. "
    xccdf_type: "HtmlTextWithSubType"

  version:
    source: "version"
    transform: "none"
    xccdf_type: "VersionType"

  # STIG-required elements (with types)
  notice:
    element: "notice"
    xccdf_type: "NoticeType"
    attributes:
      id: "terms-of-use"
      xml:lang: "en"
    content: ""

  front_matter:
    element: "front-matter"
    xccdf_type: "HtmlTextWithSubType"  # XCCDF 1.1.4 schema requires WithSubType
    attributes:
      xml:lang: "en"
    content: ""

  rear_matter:
    element: "rear-matter"
    xccdf_type: "HtmlTextWithSubType"  # XCCDF 1.1.4 schema requires WithSubType
    attributes:
      xml:lang: "en"
    content: ""

  # Dublin Core reference (STIG requirement)
  reference:
    element: "reference"
    attributes:
      href: "{benchmark.url}"
    dc_elements:
      - element: "dc:publisher"
        content: "CIS Security"
      - element: "dc:source"
        content: "https://workbench.cisecurity.org"

  # Plain-text metadata (STIG convention)
  plain_text:
    - id: "release-info"
      content: "Release: 1 Benchmark Date: {download_date}"
    - id: "generator"
      content: "cis-benchmark-cli 1.0.0"
    - id: "conventionsVersion"
      content: "1.10.0"

# Rule-level default attributes
rule_defaults:
  severity: "medium"  # CIS has no severity → default CAT II equivalent
  weight: "10.0"      # DISA standard
  selected: "true"
  role: "full"

# Rule ID generation
rule_id:
  template: "xccdf_cis_{platform}_rule_{ref_normalized}"
  ref_normalized: "replace('.', '_')"  # 3.1.1 → 3_1_1

# Field mappings - Order matters for composite fields!
field_mappings:

  # === CORE IDENTIFICATION ===
  version:
    target_element: "version"
    source_field: "ref"
    transform: "none"
    description: "CIS ref becomes STIG-style version (human-readable ID)"

  title:
    target_element: "title"
    source_field: "title"
    transform: "strip_html"

  # === DESCRIPTION (Complex - Embedded XML Tags) ===
  description:
    target_element: "description"
    structure: "embedded_xml_tags"
    components:
      - tag: "VulnDiscussion"
        sources:
          - field: "description"
            transform: "strip_html"
            separator: "\n\n"
          - field: "rationale"
            transform: "strip_html"
        combine: "join"  # Join both sources into one VulnDiscussion

      - tag: "FalsePositives"
        content: ""  # Empty - legacy VMS

      - tag: "FalseNegatives"
        content: ""  # Empty - legacy VMS

      - tag: "Documentable"
        content: "false"  # Static

      - tag: "Mitigations"
        sources:
          - field: "additional_info"
            transform: "strip_html"
        optional: true  # Only if field present

      - tag: "SeverityOverrideGuidance"
        content: ""  # Empty - legacy VMS

      - tag: "PotentialImpacts"
        sources:
          - field: "impact"
            transform: "strip_html"
        optional: true

      - tag: "ThirdPartyTools"
        content: ""  # Empty - legacy VMS

      - tag: "MitigationControl"
        content: ""  # Empty - legacy VMS

      - tag: "Responsibility"
        content: ""  # Empty - legacy VMS

      - tag: "IAControls"
        content: ""  # Empty - legacy VMS

  # === CCI IDENTIFIERS (DoD Standard for NIST Mapping) ===
  ident:
    target_element: "ident"
    multiple: true
    source_logic: "cci_lookup_with_deduplication"
    cci_lookup:
      enabled: true
      mapping_file: "data/cis-cci-mapping.json"
      source_field: "cis_controls"
      extract: "primary"  # primary only (key compliance mapping) - use "all" for primary + supporting
      deduplicate_nist: true
    attributes:
      system: "http://cyber.mil/cci"

  # === NIST REFERENCES (Extras Not Covered by CCIs) ===
  reference:
    target_element: "reference"
    multiple: true
    source_logic: "nist_after_cci_deduplication"
    source_field: "nist_controls"
    structure: "dublin_core"
    dc_elements:
      - element: "dc:identifier"
        content: "{nist_control_id}"
    attributes:
      href: "https://csrc.nist.gov/Projects/risk-management/sp800-53-controls"

  # === REMEDIATION ===
  fixtext:
    target_element: "fixtext"
    source_field: "remediation"
    transform: "strip_html_keep_code"
    attributes:
      fixref: "F-{ref_normalized}"

  fix:
    target_element: "fix"
    content: ""  # Empty element
    attributes:
      id: "F-{ref_normalized}"

  # === AUDIT/CHECK ===
  check:
    target_element: "check"
    structure: "nested"
    attributes:
      system: "C-{ref_normalized}"
    children:
      - element: "check-content"
        source_field: "audit"
        transform: "strip_html_keep_code"

  # === CIS CONTROLS (Triggers official structure creation for post-processing) ===
  cis_controls_metadata:
    structure: "official_cis_controls"
    description: "Build CIS Controls objects for metadata injection (handled in post-processing)"

  # === ENHANCED METADATA (MITRE, Profiles) ===
  enhanced_metadata:
    structure: "custom_namespace"
    description: "Store enhanced metadata for post-processing injection"
    components:
      - element: "cis-control"
        source_field: "cis_controls"
        multiple: true
        attributes:
          version: "{control.version}"
          id: "{control.control}"
          ig1: "{control.ig1}"
          ig2: "{control.ig2}"
          ig3: "{control.ig3}"
        content: "{control.title}"

      - element: "profile"
        source_field: "profiles"
        multiple: true
        content: "{profile}"

      - element: "mitre-technique"
        source_field: "mitre_mapping.techniques"
        multiple: true
        content: "{technique}"

      - element: "mitre-tactic"
        source_field: "mitre_mapping.tactics"
        multiple: true
        content: "{tactic}"

      - element: "mitre-mitigation"
        source_field: "mitre_mapping.mitigations"
        multiple: true
        content: "{mitigation}"

      - element: "assessment-status"
        source_field: "assessment_status"
        content: "{assessment_status}"

# Transformation definitions
# Transformations inherited from base_style.yaml
# Add DISA-specific transformations here if needed

# CCI Deduplication Configuration
cci_deduplication:
  enabled: true
  algorithm:
    description: "Use CCIs where available, NIST references for extras"
    steps:
      - "Extract all CIS Controls from recommendation"
      - "Look up CCIs for each CIS Control (primary + supporting)"
      - "Determine which NIST controls are covered by those CCIs"
      - "Add CCIs as <ident> elements"
      - "Add uncovered NIST controls as <reference> elements"

  matching_rules:
    description: "How to determine if CCI covers a NIST citation"
    hierarchical: true  # CM-7.1 covers CM-7
    examples:
      - cci_maps_to: "CM-7.1"
        cis_cites: "CM-7"
        result: "covered"  # CCI is more specific
      - cci_maps_to: "CM-7"
        cis_cites: "CM-7.1"
        result: "not_covered"  # CCI too broad
      - cci_maps_to: "CM-7(5)"
        cis_cites: "CM-7"
        result: "covered"  # Enhancement covers base

# Legacy VMS tags (keep for compatibility)
legacy_vms_tags:
  include: true
  tags:
    - "FalsePositives"
    - "FalseNegatives"
    - "Documentable"
    - "SeverityOverrideGuidance"
    - "ThirdPartyTools"
    - "MitigationControl"
    - "Responsibility"
    - "IAControls"
  default_content: ""
  documentable_value: "false"

# Validation rules
validation:
  require_cci_for_cis_controls: false  # Warn if missing, don't fail
  require_nist_controls: false
  max_cci_per_rule: 50  # Sanity check

# Rule element specifications (xsdata types for each Rule element)
# Note: A Rule is a security control/recommendation
# Each Rule has elements (title, description, etc.) with specific xsdata types
rule_elements:
  version:
    xccdf_type: "VersionType"
    source: "ref"

  title:
    xccdf_type: "TextWithSubType"
    source: "title"

  description:
    xccdf_type: "HtmlTextWithSubType"
    source: "vuln_discussion"  # Created by engine

  ident:
    xccdf_type: "IdentType"
    multiple: true

  fixtext:
    xccdf_type: "FixTextType"
    source: "remediation"

  check:
    xccdf_type: "CheckType"
    source: "audit"

  cis_controls_metadata:
    xccdf_type: "MetadataType"
    description: "CIS Controls metadata (injected in post-processing)"

  enhanced_metadata:
    xccdf_type: "MetadataType"
    description: "Enhanced metadata: MITRE ATT&CK, profiles (injected in post-processing)"

# Group element specifications (xsdata types for each Group element)
# Note: Groups are DISA wrappers - one Group per Rule (STIG convention)
# Each Group has elements (title, description) with specific xsdata types
group_elements:
  title:
    xccdf_type: "TextWithSubType"  # XCCDF 1.1.4 schema requires WithSubType

  description:
    xccdf_type: "HtmlTextWithSubType"

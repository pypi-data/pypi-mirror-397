#
# Copyright (c) 2025 CESNET z.s.p.o.
#
# This file is a part of oarepo-ui (see https://github.com/oarepo/oarepo-ui).
#
# oarepo-ui is free software; you can redistribute it and/or modify it
# under the terms of the MIT License; see LICENSE file for more details.
#
"""OARepo UI webpack integration module.

This module provides webpack bundle project integration for OARepo UI,
including support for UI component overrides and dynamic bundle generation
for React components with configurable properties.
"""

from __future__ import annotations

import re
from pathlib import Path
from typing import TYPE_CHECKING, Any, cast, override

from flask import current_app
from flask_webpackext import WebpackBundleProject
from pywebpack import bundles_from_entry_point
from pywebpack.helpers import cached

from oarepo_ui.less import COMPONENT_LIST_RE, COMPONENT_RE, enumerate_assets

from .proxies import current_oarepo_ui, current_ui_overrides

if TYPE_CHECKING:
    from flask_webpackext.bundle import WebpackBundle


overrides_js_template = """
import { overrideStore, parametrize } from 'react-overridable';

{% for componentOverride in overrides -%}
{{ componentOverride.component.import_statement | safe }}
{% endfor %}

{%- for componentOverride in overrides -%}
{%- if componentOverride.component.props -%}{{ componentOverride.component.parametrize_statement | safe }}{%- endif -%}
{%- endfor %}

{% for componentOverride in overrides -%}
overrideStore.add('{{ componentOverride.overridable_id }}', {{ componentOverride.component.name }});
{% endfor %}
"""


class OverridableBundleProject(WebpackBundleProject):
    """A WebpackBundleProject that supports UI overrides and dynamic bundle generation."""

    @override
    def __init__(
        self,
        import_name: str,
        project_folder: str | None = None,
        bundles: list[WebpackBundle] | None = None,
        config: dict[str, Any] | None = None,
        config_path: str | None = None,
        overrides_bundle_path: str = "_overrides",
        **kwargs: Any,
    ) -> None:
        """Initialize templated folder.

        :param import_name: Name of the module where the WebpackBundleProject
            class is instantiated. It is used to determine the absolute path
            to the ``project_folder``.
        :param project_folder: Relative path to the Webpack project which is
            going to aggregate all the ``bundles``.
        :param bundles: List of
            :class:`flask_webpackext.bundle.WebpackBundle`. This list can be
            statically defined if the bundles are known before hand, or
            dinamically generated using
            :func:`pywebpack.helpers.bundles_from_entry_point` so the bundles
            are discovered from the defined Webpack entrypoints exposed by
            other modules.
        :param config: Dictionary which overrides the ``config.json`` file
            generated by Flask-WebpackExt. Use carefuly and only if you know
            what you are doing since ``config.json`` is the file that holds the
            key information to integrate Flask with Webpack.
        :param config_path: Path where Flask-WebpackExt is going to write the
            ``config.json``, this file is generated by
            :func:`flask_webpackext.project.flask_config`.
        :param overrides_bundle_path: Path where special bundle for UI overrides
            if going to be generated.
        """
        # Following is needed to correctly resolve paths to etc. source package.json from invenio_assets
        _import_name = "invenio_assets.webpack"
        super().__init__(
            _import_name,
            project_folder=project_folder,
            bundles=bundles,
            config=config,
            config_path=config_path,
            **kwargs,
        )
        self._overrides_bundle_path = Path(overrides_bundle_path)
        self._generated_paths: list[str] = []

    @property
    def overrides_bundle_asset_path(self) -> str:
        """Path to the overrides bundle asset directory within the project path."""
        return str(Path("js") / self._overrides_bundle_path)

    @property
    def overrides_bundle_path(self) -> str:
        """Path to the overrides bundle asset directory with project path."""
        return str(Path(self.project_path).joinpath(self.overrides_bundle_asset_path))

    @property
    def generated_paths(self) -> list[str]:
        """Get paths that are generated by this bundle project."""
        # Mark everything under overrides_bundle_path as generated & managed by this bundle project
        return [self.overrides_bundle_path]

    @property
    @cached
    def entry(self) -> dict[str, str]:
        """Get webpack entry points."""
        bundle_entries = cast("dict[str, str]", super().entry)

        for component_override in current_ui_overrides:
            bundle_entries[f"overrides-{component_override.endpoint}"] = (
                f"./{self.overrides_bundle_asset_path}/{component_override.endpoint}.js"
            )
        return bundle_entries

    @override
    def create(self, force: bool | None = None) -> None:
        """Create webpack project from a template.

        This command collects all asset files from the bundles.
        It generates a new package.json by merging the package.json
        dependencies of each bundle. Additionally, it generates a special
        bundle for any UI overrides.
        """
        super().create(force)
        # Collect and register LESS components
        self.collect_and_register_less_components()

        # Generate special bundle for configured UI overrides
        if not Path(self.overrides_bundle_path).exists():
            Path(self.overrides_bundle_path).mkdir(parents=True, exist_ok=True)

        for (
            endpoint,
            component_overrides,
        ) in current_oarepo_ui.ui_overrides_by_endpoint.items():
            template = current_app.jinja_env.from_string(overrides_js_template)
            overrides_js_content = template.render({"overrides": component_overrides})
            overrides_js_path = Path(self.overrides_bundle_path) / f"{endpoint}.js"

            with overrides_js_path.open("w+") as f:
                f.write(overrides_js_content)

    def clean(self) -> None:
        """Clean created webpack project."""
        super().clean()
        self.generated_paths.clear()

    def collect_less_components(self) -> set[str]:
        """Collect LESS components from asset directories."""
        _, asset_dirs = enumerate_assets()
        less_component_files: list[Path] = []

        for asset_dir in asset_dirs:
            less_dir = asset_dir / "less"
            if less_dir.exists():
                less_component_files.extend(less_dir.glob("**/custom-components.less"))

        components = set()
        for cmp_file in less_component_files:
            for component_list in COMPONENT_LIST_RE.findall(cmp_file.read_text()):
                for s in COMPONENT_RE.findall(component_list[0]):
                    components.add(Path(s).stem)

        return components

    def register_less_components(self, components: set[str], theme_config_file: Path) -> None:
        """Register LESS components in the theme configuration file."""
        if not theme_config_file.exists():
            raise FileNotFoundError(f"Theme configuration file {theme_config_file} does not exist.")

        theme_data = theme_config_file.read_text()
        for c in components:
            match = re.search(f"^@{c}", theme_data, re.MULTILINE)
            if not match:
                autoregistration_position = theme_data.index("/* --- autoregistration point, do not remove --- */")
                theme_data = (
                    theme_data[:autoregistration_position]
                    + f"\n@{c}: 'default';\n"
                    + theme_data[autoregistration_position:]
                )

        theme_config_file.write_text(theme_data)

    def collect_and_register_less_components(self, theme_config_file: Path | None = None) -> None:
        """Collect and register LESS components directly."""
        components = self.collect_less_components()
        if theme_config_file is None:
            theme_config_file = Path(current_app.instance_path) / "assets" / "less" / "theme.config"
        self.register_less_components(components, theme_config_file)


project = OverridableBundleProject(
    __name__,
    project_folder="assets",
    config_path="build/config.json",
    bundles=cast("list[WebpackBundle]", list(bundles_from_entry_point("invenio_assets.webpack"))),
    package_json_source_path="rspack-package.json",
)

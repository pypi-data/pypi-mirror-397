# Nexus Evaluation Environment - Docker Compose
# Complete stack for MCP evaluation testing with semantic search enabled
# Based on docker-compose.demo.yml with config.evaluation.yaml
#
# Usage:
#   docker compose -f docker-compose.evaluation.yml up          # Start all services
#   docker compose -f docker-compose.evaluation.yml up -d       # Start in background
#   docker compose -f docker-compose.evaluation.yml down        # Stop all services
#   docker compose -f docker-compose.evaluation.yml logs -f     # View logs
#
# Services:
#   - postgres:    PostgreSQL database (port 5432)
#   - nexus:       Nexus RPC server (port 8080) [semantic_search: enabled]
#   - mcp-server:  Nexus MCP server (port 8081)
#   - langgraph:   LangGraph agent server (port 2024)
#   - frontend:    React web UI (port 5173)

version: '3.8'

services:
  # ============================================
  # PostgreSQL Database with pgvector extension
  # ============================================
  postgres:
    image: pgvector/pgvector:pg16
    container_name: nexus-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-nexus}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-nexus}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres-data:/var/lib/postgresql/data
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-nexus}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - nexus-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================
  # Nexus RPC Server
  # ============================================
  nexus:
    build:
      context: .
      dockerfile: Dockerfile
    image: nexus-server:latest
    container_name: nexus-server
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # Server configuration
      NEXUS_HOST: 0.0.0.0
      NEXUS_PORT: 8080
      NEXUS_DATA_DIR: /app/data

      # Database configuration (PostgreSQL)
      NEXUS_DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-nexus}@postgres:5432/${POSTGRES_DB:-nexus}

      # Authentication
      # Admin user for initialization (default: admin)
      NEXUS_ADMIN_USER: ${NEXUS_ADMIN_USER:-admin}

      # Optional: Pre-set API key (otherwise auto-generated on first run)
      # Leave empty to auto-generate - check logs with: docker logs nexus-server
      NEXUS_API_KEY: ${NEXUS_API_KEY:-}

      # Backend storage (local by default, can be 'gcs' for production)
      NEXUS_BACKEND: ${NEXUS_BACKEND:-local}
      NEXUS_GCS_BUCKET: ${NEXUS_GCS_BUCKET:-}
      NEXUS_GCS_PROJECT: ${NEXUS_GCS_PROJECT:-}

      # GCS credentials (automatically mounted at /app/gcs-credentials.json)
      # Override with environment variable if using a different path
      GOOGLE_APPLICATION_CREDENTIALS: ${GOOGLE_APPLICATION_CREDENTIALS:-/app/gcs-credentials.json}

      # AWS credentials for S3 connector
      AWS_SHARED_CREDENTIALS_FILE: ${AWS_SHARED_CREDENTIALS_FILE:-/app/aws-credentials}
      AWS_CONFIG_FILE: ${AWS_CONFIG_FILE:-/app/aws-config}
      AWS_DEFAULT_REGION: ${AWS_DEFAULT_REGION:-us-east-1}

      # OAuth encryption key (for secure token storage)
      # Generate with: python3 -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"
      NEXUS_OAUTH_ENCRYPTION_KEY: ${NEXUS_OAUTH_ENCRYPTION_KEY:-}

      # Google OAuth credentials (for Google Drive connector)
      NEXUS_OAUTH_GOOGLE_CLIENT_ID: ${NEXUS_OAUTH_GOOGLE_CLIENT_ID:-}
      NEXUS_OAUTH_GOOGLE_CLIENT_SECRET: ${NEXUS_OAUTH_GOOGLE_CLIENT_SECRET:-}

      # Sandbox configuration
      # URL that sandboxes should use to connect back to Nexus server
      # Use Docker service name for container-to-container communication
      NEXUS_SERVER_URL: http://nexus:8080
      # Docker network for sandboxes to join
      NEXUS_DOCKER_NETWORK: nexus_nexus-network

      # Permission setup (optional)
      # Set to 'true' to skip entity registry and permission setup during init
      NEXUS_SKIP_PERMISSIONS: ${NEXUS_SKIP_PERMISSIONS:-false}

      # Runtime permission enforcement
      # Set to 'false' to disable permission checks at runtime
      NEXUS_ENFORCE_PERMISSIONS: ${NEXUS_ENFORCE_PERMISSIONS:-true}

      # Configuration file path (evaluation config with semantic_search enabled)
      NEXUS_CONFIG_FILE: ${NEXUS_CONFIG_FILE:-/app/configs/config.evaluation.yaml}

      # Semantic search mode (explicitly enable OpenAI embeddings for evaluation)
      # Options: 'keyword' (default, FTS only) or 'semantic' (OpenAI embeddings - experimental)
      NEXUS_SEMANTIC_MODE: semantic

      # OpenAI API key for semantic search embeddings
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
    volumes:
      # Persistent data directory (local backend)
      - nexus-data:/app/data
      # Configuration files (includes config.evaluation.yaml)
      - ./configs:/app/configs:ro
      # Evaluation test data (mount local eval_workspace for testing)
      - ./tests/evaluation/eval_workspace:/app/eval_data:ro
      # GCS credentials (auto-detected - see docker-gcs-setup.sh)
      # Automatically finds credentials from: gcloud, ./gcs-credentials.json, or GCS_CREDENTIALS_PATH
      - ${GCS_CREDENTIALS_PATH:-./gcs-credentials.json}:/app/gcs-credentials.json:ro
      # AWS credentials (auto-detected - see docker-demo.sh)
      # Automatically finds credentials from: ~/.aws/credentials or AWS_CREDENTIALS_PATH
      - ${AWS_CREDENTIALS_PATH:-./aws-credentials}:/app/aws-credentials:ro
      - ${AWS_CONFIG_PATH:-./aws-config}:/app/aws-config:ro
      # Docker socket for sandbox provider
      - /var/run/docker.sock:/var/run/docker.sock
    # Run as root to access Docker socket (required for sandbox provider)
    # The nexus user inside the container doesn't have socket permissions
    user: root
    ports:
      - "${NEXUS_PORT:-8080}:8080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 10s
      retries: 20
      start_period: 120s
    networks:
      - nexus-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================
  # Nexus MCP Server
  # ============================================
  mcp-server:
    image: nexus-server:latest
    container_name: nexus-mcp-server
    restart: unless-stopped
    depends_on:
      nexus:
        condition: service_healthy
    entrypoint: []  # Override the docker-entrypoint.sh
    environment:
      # Nexus server URL (internal Docker network)
      NEXUS_URL: http://nexus:8080

      # API Key for authentication (auto-generated by nexus-server)
      NEXUS_API_KEY: ${NEXUS_API_KEY:-}

      # MCP configuration
      MCP_HOST: 0.0.0.0
      MCP_PORT: 8081
    ports:
      - "${MCP_PORT:-8081}:8081"
    command: >
      sh -c '
        echo "ðŸ”„ Waiting for Nexus server to be ready..."
        sleep 5
        echo "ðŸš€ Starting Nexus MCP server on port 8081..."
        echo "   NEXUS_URL: $${NEXUS_URL}"
        exec nexus mcp serve --transport http --port 8081 --host 0.0.0.0
      '
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8081/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    networks:
      - nexus-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================
  # LangGraph Agent Server
  # ============================================
  langgraph:
    build:
      context: ./examples/langgraph
      dockerfile: Dockerfile
    image: nexus-langgraph:latest
    container_name: nexus-langgraph
    restart: unless-stopped
    depends_on:
      nexus:
        condition: service_healthy
    environment:
      # LangGraph configuration
      LANGGRAPH_PORT: 2024
      LANGGRAPH_HOST: 0.0.0.0

      # Nexus server URL (internal Docker network)
      NEXUS_SERVER_URL: http://nexus:8080

      # API Keys for LLM providers (required)
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}

      # Optional: Additional tool API keys
      TAVILY_API_KEY: ${TAVILY_API_KEY:-}
      E2B_API_KEY: ${E2B_API_KEY:-}
      FIRECRAWL_API_KEY: ${FIRECRAWL_API_KEY:-}

      # LangSmith tracing (optional)
      LANGCHAIN_TRACING_V2: ${LANGCHAIN_TRACING_V2:-false}
      LANGCHAIN_ENDPOINT: ${LANGCHAIN_ENDPOINT:-}
      LANGCHAIN_PROJECT: ${LANGCHAIN_PROJECT:-}
      LANGSMITH_API_KEY: ${LANGSMITH_API_KEY:-}
    ports:
      - "${LANGGRAPH_PORT:-2024}:2024"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:2024/ok"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    networks:
      - nexus-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================
  # Frontend (React + Vite)
  # ============================================
  frontend:
    build:
      context: ../nexus-frontend
      dockerfile: Dockerfile
      args:
        # Browser URLs - use localhost for browser to access services
        VITE_NEXUS_API_URL: ${VITE_NEXUS_API_URL:-http://localhost:8080}
        VITE_LANGGRAPH_API_URL: ${VITE_LANGGRAPH_API_URL:-http://localhost:2024}
        # LangGraph server URL - use Docker service name for container-to-container
        VITE_NEXUS_SERVER_URL: ${VITE_NEXUS_SERVER_URL:-http://nexus:8080}
    image: nexus-frontend:latest
    container_name: nexus-frontend
    restart: unless-stopped
    depends_on:
      nexus:
        condition: service_healthy
    environment:
      # Frontend configuration
      VITE_NEXUS_API_URL: ${VITE_NEXUS_API_URL:-http://localhost:8080}
      VITE_LANGGRAPH_API_URL: ${VITE_LANGGRAPH_API_URL:-http://localhost:2024}
    ports:
      - "${FRONTEND_PORT:-5173}:80"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - nexus-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# ============================================
# Volumes
# ============================================
volumes:
  postgres-data:
    driver: local
  nexus-data:
    driver: local

# ============================================
# Networks
# ============================================
networks:
  nexus-network:
    driver: bridge

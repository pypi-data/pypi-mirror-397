"""Mounts media directories as static files for serving through the web server"""

# AUTOGENERATED! DO NOT EDIT! File to edit: ../../nbs/media/mounter.ipynb.

# %% auto 0
__all__ = ['MediaMounter']

# %% ../../nbs/media/mounter.ipynb 3
import hashlib
from pathlib import Path
from typing import Dict, List, Optional
from fastcore.basics import patch

from starlette.staticfiles import StaticFiles
from starlette.routing import Mount

# %% ../../nbs/media/mounter.ipynb 5
class MediaMounter:
    """Mounts directories for static file serving with instance-level state."""

    # Prefix pattern for this mounter's routes
    ROUTE_PREFIX_PATTERN = "sf_media_"

    def __init__(self):
        """Initialize the mounter with empty state."""
        self._mounted: Dict[str, str] = {}  # directory -> route_prefix
        self._app = None

# %% ../../nbs/media/mounter.ipynb 6
@patch
def mount(
    self: MediaMounter,
    app,  # FastHTML/Starlette application instance
    directories: List[str]  # List of directory paths to mount
) -> None:
    """Mount directories to app for static file serving."""
    self._app = app
    self._mounted.clear()

    # Remove any existing mounts from this instance
    self._remove_existing_mounts(app)

    for directory in directories:
        self._mount_directory(app, directory)

# %% ../../nbs/media/mounter.ipynb 7
@patch
def get_url(
    self: MediaMounter,
    file_path: str  # Full path to the media file
) -> Optional[str]:  # URL to access the file, or None if not in a mounted directory
    """Get URL for a file based on mounted directories."""
    file_path_resolved = Path(file_path).resolve()

    for directory, prefix in self._mounted.items():
        dir_path = Path(directory).resolve()
        try:
            relative_path = file_path_resolved.relative_to(dir_path)
            return f"/{prefix}/{relative_path.as_posix()}"
        except ValueError:
            # File is not in this directory
            continue

    return None

# %% ../../nbs/media/mounter.ipynb 8
@patch
def is_mounted(
    self: MediaMounter,
    directory: str  # Directory path to check
) -> bool:  # True if the directory is mounted
    """Check if a directory is currently mounted."""
    return directory in self._mounted

# %% ../../nbs/media/mounter.ipynb 9
@patch
def get_mounted_directories(
    self: MediaMounter
) -> List[str]:  # List of mounted directory paths
    """Get list of currently mounted directories."""
    return list(self._mounted.keys())

# %% ../../nbs/media/mounter.ipynb 10
@patch
def unmount_all(
    self: MediaMounter
) -> None:
    """Remove all mounts from this instance."""
    if self._app:
        self._remove_existing_mounts(self._app)
    self._mounted.clear()

# %% ../../nbs/media/mounter.ipynb 11
@patch
def _mount_directory(
    self: MediaMounter, 
    app,  # FastHTML/Starlette application instance
    directory: str  # Directory path to mount
) -> None:
    """Mount a single directory."""
    dir_path = Path(directory)

    if not dir_path.exists():
        print(f"[MediaMounter] Warning: Directory does not exist: {directory}")
        return

    if not dir_path.is_dir():
        print(f"[MediaMounter] Warning: Path is not a directory: {directory}")
        return

    prefix = self._generate_prefix(directory)

    try:
        mount = Mount(
            f"/{prefix}",
            app=StaticFiles(directory=str(dir_path)),
            name=prefix
        )

        # Insert at the beginning of routes (before other routes)
        app.routes.insert(0, mount)

        # Store the mapping
        self._mounted[directory] = prefix

    except Exception as e:
        print(f"[MediaMounter] Error mounting {directory}: {e}")

# %% ../../nbs/media/mounter.ipynb 12
@patch
def _generate_prefix(
    self: MediaMounter, 
    directory: str  # Directory path
) -> str:  # Route prefix string (e.g., "sf_media_abc12345")
    """Generate a unique route prefix for a directory using MD5 hash."""
    dir_hash = hashlib.md5(directory.encode()).hexdigest()[:8]
    return f"{self.ROUTE_PREFIX_PATTERN}{dir_hash}"

# %% ../../nbs/media/mounter.ipynb 13
@patch
def _remove_existing_mounts(
    self: MediaMounter, 
    app  # FastHTML/Starlette application instance
) -> None:
    """Remove existing mounts matching this mounter's prefix pattern."""
    # Filter out mounts with our prefix pattern
    app.routes[:] = [
        route for route in app.routes
        if not (
            isinstance(route, Mount) and
            route.path.startswith(f"/{self.ROUTE_PREFIX_PATTERN}")
        )
    ]

services:
  airflow-web:
    container_name: airflow-web
    image: apache/airflow:2.7.3
    depends_on:
      - airflow-postgresql
      - airflow-redis
    environment:
      - AIRFLOW__CORE__EXECUTOR=CeleryExecutor
      - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=postgresql+psycopg2://airflow:airflow@airflow-postgresql/airflow
      - AIRFLOW__CELERY__RESULT_BACKEND=db+postgresql://airflow:airflow@airflow-postgresql/airflow
      - AIRFLOW__CELERY__BROKER_URL=redis://:@airflow-redis:6379/0
      - AIRFLOW__CORE__FERNET_KEY=9RKp_98pGjbj3ynZN3JHwRRHk3R1mpGn_iZoaX5v3IY=
      - AIRFLOW__CORE__DAGS_ARE_PAUSED_AT_CREATION=True
      - AIRFLOW__CORE__LOAD_EXAMPLES=False
      - AIRFLOW_API_AUTH_BACKEND=airflow.api.auth.backend.basic_auth
      - AIRFLOW__API__AUTH_BACKENDS=airflow.api.auth.backend.basic_auth
      - AIRFLOW__API__AUTH_BACKEND=airflow.api.auth.backend.basic_auth
      - _AIRFLOW_DB_UPGRADE=True
      - _AIRFLOW_WWW_USER_CREATE=True
      - _AIRFLOW_WWW_USER_USERNAME=airflow
      - _AIRFLOW_WWW_USER_PASSWORD=airflow
    volumes:
      - ../src:/opt/airflow/dags
      - ../plugins:/opt/airflow/plugins
    ports:
      - "8080:8080"
    command: webserver
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 5

  airflow-scheduler:
    container_name: airflow-scheduler
    image: apache/airflow:2.7.3
    depends_on:
      - airflow-web
    environment:
      - AIRFLOW__CORE__EXECUTOR=CeleryExecutor
      - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=postgresql+psycopg2://airflow:airflow@airflow-postgresql/airflow
      - AIRFLOW__CELERY__RESULT_BACKEND=db+postgresql://airflow:airflow@airflow-postgresql/airflow
      - AIRFLOW__CELERY__BROKER_URL=redis://:@airflow-redis:6379/0
      - AIRFLOW__CORE__FERNET_KEY=9RKp_98pGjbj3ynZN3JHwRRHk3R1mpGn_iZoaX5v3IY=
      - AIRFLOW__CORE__DAGS_ARE_PAUSED_AT_CREATION=True
      - AIRFLOW__CORE__LOAD_EXAMPLES=False
    volumes:
      - ../src:/opt/airflow/dags
      - ../plugins:/opt/airflow/plugins
    command: scheduler

  airflow-worker:
    container_name: airflow-worker
    image: apache/airflow:2.7.3
    depends_on:
      - airflow-scheduler
    environment:
      - AIRFLOW__CORE__EXECUTOR=CeleryExecutor
      - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=postgresql+psycopg2://airflow:airflow@airflow-postgresql/airflow
      - AIRFLOW__CELERY__RESULT_BACKEND=db+postgresql://airflow:airflow@airflow-postgresql/airflow
      - AIRFLOW__CELERY__BROKER_URL=redis://:@airflow-redis:6379/0
      - AIRFLOW__CORE__FERNET_KEY=9RKp_98pGjbj3ynZN3JHwRRHk3R1mpGn_iZoaX5v3IY=
    volumes:
      - ../src:/opt/airflow/dags
      - ../plugins:/opt/airflow/plugins
    command: celery worker

  airflow-postgresql:
    container_name: airflow-postgresql
    image: postgres:13
    environment:
      - POSTGRES_USER=airflow
      - POSTGRES_PASSWORD=airflow
      - POSTGRES_DB=airflow
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "airflow"]
      interval: 5s
      retries: 5

  airflow-redis:
    container_name: airflow-redis
    image: redis:latest
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      retries: 5

  test-runner:
    container_name: test-runner
    image: apache/airflow:2.7.3
    depends_on:
      - airflow-web
    volumes:
      - ../src:/opt/airflow/dags
      - ../plugins:/opt/airflow/plugins
      - ../tests:/opt/airflow/test
      - ./scripts:/opt/airflow/scripts
      - ../requirements.txt:/opt/airflow/requirements-dev.txt
    environment:
      - PYTHONPATH=/opt/airflow/dags:/opt/airflow/plugins:/opt/airflow/test:/home/airflow/.local/lib/python3.8/site-packages
      - AIRFLOW__CORE__LAZY_LOAD_PROVIDERS=false
      - AIRFLOW_HOME=/opt/airflow
      - AIRFLOW__CORE__EXECUTOR=CeleryExecutor
      - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=postgresql+psycopg2://airflow:airflow@airflow-postgresql/airflow
      - AIRFLOW__CELERY__RESULT_BACKEND=db+postgresql://airflow:airflow@airflow-postgresql/airflow
      - AIRFLOW__CELERY__BROKER_URL=redis://:@airflow-redis:6379/0
      - AIRFLOW__CORE__FERNET_KEY=9RKp_98pGjbj3ynZN3JHwRRHk3R1mpGn_iZoaX5v3IY=
      - AIRFLOW__CORE__DAGS_ARE_PAUSED_AT_CREATION=True
      - AIRFLOW__CORE__LOAD_EXAMPLES=False
      - AIRFLOW__CORE__DAGS_FOLDER=/opt/airflow/dags
      - AIRFLOW__CORE__PLUGINS_FOLDER=/opt/airflow/plugins
      - AIRFLOW_ADMIN_USERNAME=airflow
      - AIRFLOW_ADMIN_PASSWORD=airflow
#    command: >
#      bash -c "
#        pip install -r /opt/airflow/requirements-dev.txt &&
#        tail -f /dev/null
#      "
    command: >
      bash -c "
        airflow db init &&
        pip install -r /opt/airflow/requirements-dev.txt &&
        bash /opt/airflow/scripts/wait_for_airflow_web.sh &&
        pytest -vvv -s --log-cli-level=DEBUG /opt/airflow/test/integration
      "
[project]
name = "cattle_grid"
description = "Middleware for the Fediverse"
readme = "README.md"
requires-python = ">=3.11"
dependencies = [
    "alembic>=1.17.2",
    "argon2-cffi>=23.1.0",
    "bovine>=0.5.13",
    "dynaconf>=3.2.6",
    "fastapi[standard]>=0.121.2",
    "faststream[cli,rabbit]>=0.6.3",
    "jinja2>=3.1.6",
    "pydantic==2.12.2",
    "sqlalchemy-utils>=0.41.2",
    "sqlalchemy[asyncio]>=2.0.36",
    "tomli-w>=1.0.0",
    "uuid6>=2025.0.1",
]

dynamic = ["version"]

[project.optional-dependencies]
cache = ["redis>=5.2.1", "fakeredis>=2.26.2"]
uvicorn = ["uvicorn>=0.37.0"]
postgres = ["asyncpg>=0.30.0"]
aiosqlite = ["aiosqlite>=0.21.0"]

[dependency-groups]
dev = [
    "muck-out>=0.3.8",
    "almabtrieb>=0.2.9",
    "behave>=1.3.0",
    # "devtools>=0.12.2",
    "hatch>=1.13.0",
    "pytest>=9.0.0",
    "pytest-asyncio>=1.3.0",
    # "datamodel-code-generator>=0.26.1",
    "muck-out>=0.3.0",
    "ruff>=0.14.0",
    # "pytest-cov>=6.0.0",
    # "ptpython>=3.0.29",
    "fediverse-features>=0.1.0",
    "jsonschema>=4.23.0",
    "pytest-watcher>=0.4.3",
    "pyright[nodejs]>=1.1.407",
    "aiosqlite>=0.21.0",
    "behave-auto-docstring>=0.1.2",
    "pytest-cov>=7.0.0",
]
docs = [
    "mkdocs-click>=0.8.1",
    "mkdocs-material==9.6.20",
    "mkdocstrings-python>=1.11.1",
    "griffe-fieldz>=0.2.1",
    "mkdocs-awesome-nav>=3.2.0",
    "mkdocs-material-codeberg-source-facts>=0.1.2",
]

[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"

[tool.hatch.version]
path = "cattle_grid/version.py"

[tool.pytest.ini_options]
addopts = "--doctest-modules -s"
# For the -s see https://github.com/pallets/click/issues/824

asyncio_mode = "auto"
log_cli = true
log_cli_level = "INFO"
doctest_optionflags = "NORMALIZE_WHITESPACE IGNORE_EXCEPTION_DETAIL ELLIPSIS"
testpaths = ["cattle_grid/**/*.py"]
asyncio_default_fixture_loop_scope = "function"
norecursedirs = "alembic"

filterwarnings = """
    ignore:.*invalid escape sequence*:SyntaxWarning
"""

[tool.behave]
show_skipped = false

[tool.pyright]
include = ["cattle_grid"]
exclude = ["cattle_grid/testing/features", "cattle_grid/alembic"]
reportAttributeAccessIssue = false

[tool.pytest-watcher]
now = true
runner_args = ["--lf"]

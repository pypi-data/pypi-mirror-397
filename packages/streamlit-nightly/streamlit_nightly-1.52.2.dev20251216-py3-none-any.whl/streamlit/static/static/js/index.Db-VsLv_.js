import{r,E as B,_ as $,g as X,i as L,Q,O as Z,b9 as z,ba as M,bb as K,bc as Y,n as j,bd as k,V as P,W as q,f as ee,b4 as te,be as ne,j as R,l as se,aZ as re}from"./index.CQ-Kx4vm.js";import{w as oe,E as ae}from"./withFullScreenWrapper.wHM5JCNq.js";import{a as _,S as H,T as ie}from"./Toolbar.DWRGEUbO.js";import{R as ce}from"./index.DlXKpMxP.js";import{a as W,c as le,b as ue,e as fe,t as de,S as me,d as he}from"./embed.DsLO4l2l.js";import{u as pe}from"./FormClearHelper.BmlA5tFH.js";import{T as ge}from"./TableChart.esm.BQEo-8Sl.js";import"./moment.C7qA8nIE.js";import"./pandasStylerUtils.incP-kRb.js";import"./numbro.B9_PXfzp.js";import"./_baseIndexOf.BTknn6Gb.js";import"./index.8HslT92O.js";import"./main.CvAHtqNJ.js";import"./throttle.Bwfi-yJs.js";import"./formatNumber.BX_kK_kt.js";import"./sprintf.DpPCfzXw.js";import"./checkbox.DoK9B1yM.js";import"./createDownloadLinkElement.Bt8WFdVt.js";import"./toConsumableArray.CfEmDY2n.js";import"./FileDownload.esm.ChUL_4L5.js";import"./_arrayIncludes.B19Iyn2B.js";import"./threshold.CUNQbqMA.js";import"./value.DaKxGC7O.js";import"./timer.BZio6gjG.js";var U=r.forwardRef(function(n,t){var o={fill:"currentColor",xmlns:"http://www.w3.org/2000/svg"};return r.createElement(B,$({iconAttrs:o,iconVerticalAlign:"middle",iconViewBox:"0 0 24 24"},n,{ref:t}),r.createElement("path",{fill:"none",d:"M0 0h24v24H0V0z"}),r.createElement("path",{d:"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14zM7 10h2v7H7zm4-3h2v10h-2zm4 6h2v4h-2z"}))});U.displayName="InsertChart";const Se=20;function be(n){"params"in n&&"encoding"in n&&n.params.forEach(t=>{"select"in t&&(["interval","point"].includes(t.select)&&(t.select={type:t.select}),"type"in t.select&&t.select.type==="point"&&!("encodings"in t.select)&&L(t.select.encodings)&&(t.select.encodings=Object.keys(n.encoding)))})}const ye=(n,t,o,s,u,c,l,h)=>{const e=JSON.parse(n);if(s==="streamlit"?e.config=W(e.config,c):e.usermeta?.embedOptions?.theme==="streamlit"?(e.config=W(e.config,c),e.usermeta.embedOptions.theme=void 0):e.config=le(e.config,c),e.title&&(typeof e.title=="string"&&(e.title={text:e.title}),e.title.limit=e.title.limit??Math.max(l-40,0)),o&&(e.height=h),t&&(e.width=l,"vconcat"in e&&e.vconcat.forEach(f=>{f.width=l})),e.padding||(e.padding={}),L(e.padding.bottom)&&(e.padding.bottom=Se),e.datasets)throw new Error("Datasets should not be passed as part of the spec");return u.length>0&&be(e),e},we=(n,t,o,s,u)=>{const c=X(),{id:l,formId:h,spec:e,data:f,datasets:a,vegaLiteTheme:d,selectionMode:i}=n,p=r.useMemo(()=>i,[JSON.stringify(i)]),S=r.useMemo(()=>ye(e,s,u,d,p,c,t,o),[e,s,u,d,p,c,t,o]);return{id:l,formId:h,vegaLiteTheme:d,spec:S,selectionMode:p,data:f,datasets:a,useContainerWidth:s}},Ce={DATAFRAME_INDEX:"(index)"};function Ee(n){return!n||n.dimensions.numDataRows===0?null:F(n)}function Ve(n){const t=I(n);if(L(t))return null;const o={};for(const[s,u]of Object.entries(t))o[s]=F(u);return o}function I(n){if(n?.length===0)return null;const t={};return n.forEach(o=>{if(!o)return;const s=o.hasName?o.name:null;t[s]=o.data}),t}function F(n,t=0){if(n.dimensions.numDataRows===0)return[];const o=[],{numDataRows:s,numDataColumns:u,numIndexColumns:c}=n.dimensions,l=n.columnTypes[0]??void 0,h=l&&l.type===Q.INDEX&&(Z(l)||z(l)||M(l));for(let e=t;e<s;e++){const f={};if(h){const{content:a}=n.getCell(e,0);f[Ce.DATAFRAME_INDEX]=typeof a=="bigint"?Number(a):a}for(let a=0;a<u;a++){const d=a+c,{content:i,contentType:p}=n.getCell(e,d);if((i instanceof Date||typeof i=="number"&&Number.isFinite(i))&&(z(p)||M(p))&&!K(p)){const S=new Date(i).getTimezoneOffset()*60*1e3;f[n.columnNames[0][d]]=i.valueOf()+S}else f[n.columnNames[0][d]]=typeof i=="bigint"?Number(i):i}o.push(f)}return o}const De=150,Oe=P.getLogger("useVegaLiteSelections"),Te=(n,t,o)=>{const{id:s,formId:u,selectionMode:c}=n,l=r.useCallback(e=>{c.forEach(a=>{e.addSignalListener(a,Y(De,(d,i)=>{const p=e.getState({data:(C,A)=>c.some(g=>`${g}_store`===C),recurse:!1});j(p)&&t.setElementState(s,"viewState",p);let S=i;"vlPoint"in i&&"or"in i.vlPoint&&(S=i.vlPoint.or);const O={id:s,formId:u},V=JSON.parse(t.getStringValue(O)||"{}"),D={selection:{...V?.selection||{},[d]:S||{}}};k(V,D)||t.setStringValue(O,JSON.stringify(D),{fromUi:!0},o)}))});const f=t.getElementState(s,"viewState");if(j(f))try{return e.setState(f)}catch(a){Oe.warn("Failed to restore view state",a)}return e},[s,c,t,u,o]),h=r.useCallback(()=>{const e={selection:{}};c.forEach(i=>{e.selection[i]={}});const f={id:s,formId:u},a=t.getStringValue(f),d=a?JSON.parse(a):e;k(d,e)||t.setStringValue(f,JSON.stringify(e),{fromUi:!0},o)},[s,u,o,c,t]);return{maybeConfigureSelections:l,onFormCleared:h}},J="source",Ne=P.getLogger("useVegaEmbed");function Ae(n,t,o){const s=r.useRef(null),u=r.useRef(null),c=r.useRef(J),l=r.useRef(null),h=r.useRef([]),e=r.useRef(null),f=r.useRef([]),[a,d]=r.useState(!1),{maybeConfigureSelections:i,onFormCleared:p}=Te(n,t,o);pe({widgetMgr:t,element:n,onFormCleared:p});const{data:S,datasets:O}=n;r.useEffect(()=>{e.current=S,f.current=O,s.current===null&&(l.current=S,h.current=O)},[S,O]);const V=r.useCallback(()=>{u.current&&u.current(),u.current=null,s.current=null},[]),D=r.useCallback(async(g,b)=>{if(g.current===null)throw new Error("Element missing.");d(!0);try{V();const y={ast:!0,expr:ue,tooltip:{disableDefaultStyle:!0},defaultStyle:!1,forceActionsMenu:!0},{vgSpec:w,view:N,finalize:E}=await fe(g.current,b,y);s.current=i(N),u.current=E;const m=Ve(f.current),T=m?Object.keys(m):[];if(T.length===1){const[x]=T;c.current=x}else T.length===0&&w.data&&(c.current=J);const v=Ee(e.current);if(v&&s.current.insert(c.current,v),m)for(const[x,G]of Object.entries(m))s.current.insert(x,G);return await s.current.runAsync(),await s.current.resize().runAsync(),l.current=e.current,h.current=f.current,s.current}finally{d(!1)}},[V,i]),C=r.useCallback((g,b,y,w)=>{if(!w||w.dimensions.numDataRows===0){try{g.remove(b,de)}catch{}return}if(!y||y.dimensions.numDataRows===0){g.insert(b,F(w));return}w.hash!==y.hash&&(g.data(b,F(w)),Ne.info(`Had to clear the ${b} dataset before inserting data through Vega view.`))},[]),A=r.useCallback(async(g,b)=>{if(s.current===null||a)return null;const y=l.current,w=h.current;(y||g)&&C(s.current,c.current,y,g);const N=I(w)??{},E=I(b)??{};for(const[m,T]of Object.entries(E)){const v=m||c.current,x=N[v];C(s.current,v,x,T)}for(const m of Object.keys(N))!Object.hasOwn(E,m)&&m!==c.current&&C(s.current,m,null,null);return await s.current?.resize().runAsync(),l.current=g,h.current=b,s.current},[C,a]);return{createView:D,updateView:A,finalizeView:V}}function Re(n){try{const t=typeof n=="string"?JSON.parse(n):n;return!!(t.facet||t.encoding?.row||t.encoding?.column||t.encoding?.facet)}catch{return!1}}const ve=({disableFullscreenMode:n,element:t,fragmentId:o,widgetMgr:s,widthConfig:u,heightConfig:c})=>{const[l,h]=r.useState(!1),[e,f]=r.useState(!1),{expanded:a,height:d,width:i,expand:p,collapse:S}=q(ae),{width:O,height:V,elementRef:D}=ee([l],0),C=te(u)||t.useContainerWidth,A=ne(c),g=Re(t.spec),b=we(t,g?i??0:O,(a?d:V)??0,a?!0:C,a?!0:A),{createView:y,updateView:w,finalizeView:N}=Ae(b,s,o),{data:E,datasets:m,spec:T}=b;return r.useLayoutEffect(()=>(D.current!==null&&y(D,T),N),[y,N,T,i,d,l,D]),r.useEffect(()=>{w(E,m)},[E,m]),r.useEffect(()=>{E||m?.[0]?.data?f(!0):f(!1)},[E,m]),l?R(ce,{data:E??m[0]?.data,height:d??V??void 0,width:u??void 0,customToolbarActions:[R(_,{label:"Show chart",icon:U,onClick:()=>{h(!1)}},"show-chart")]}):se(H,{height:A?a?d:"100%":d,useContainerWidth:a?!0:C,children:[R(ie,{target:H,isFullScreen:a,onExpand:p,onCollapse:S,disableFullscreenMode:n,children:e&&R(_,{label:"Show data",icon:ge,onClick:()=>{h(!0)}})}),R(re,{styles:[me]}),R(he,{"data-testid":"stVegaLiteChart",className:"stVegaLiteChart",useContainerWidth:C,useContainerHeight:A,ref:D})]})},xe=oe(ve),nt=r.memo(xe);export{me as StyledVegaLiteChartTooltips,W as applyStreamlitTheme,nt as default};

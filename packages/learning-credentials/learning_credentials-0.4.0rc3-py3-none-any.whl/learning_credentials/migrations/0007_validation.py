# Generated by Django 4.2.25 on 2025-10-31 17:43

from django.db import migrations, models
import uuid


def backfill_credential_fields(apps, schema_editor):
    """Generate verification UUIDs and backfill learning_context_name for all existing credentials."""
    from learning_credentials.compat import get_learning_context_name

    Credential = apps.get_model("learning_credentials", "Credential")
    for credential in Credential.objects.all():
        credential.verify_uuid = uuid.uuid4()
        credential.learning_context_name = get_learning_context_name(credential.learning_context_key)
        credential.save(update_fields=["verify_uuid", "learning_context_name"])


class Migration(migrations.Migration):
    dependencies = [
        ("learning_credentials", "0006_cleanup_openedx_certificates_tables"),
    ]

    operations = [
        migrations.AlterUniqueTogether(
            name="credential",
            unique_together=set(),
        ),
        migrations.AlterField(
            model_name="credential",
            name="user_full_name",
            field=models.CharField(
                editable=False,
                help_text="User receiving the credential. This field is used for validation purposes.",
                max_length=255,
            ),
        ),
        migrations.AddField(
            model_name="credential",
            name="invalidated_at",
            field=models.DateTimeField(
                editable=False,
                help_text="Timestamp when the credential was invalidated",
                null=True,
            ),
        ),
        migrations.AddField(
            model_name="credential",
            name="invalidation_reason",
            field=models.CharField(
                blank=True,
                help_text="Reason for invalidating the credential",
                max_length=255,
            ),
        ),
        migrations.AddField(
            model_name="credential",
            name="learning_context_name",
            field=models.CharField(
                editable=False,
                help_text="Name of the learning context for which the credential was issued. This field is used for validation purposes.",
                max_length=255,
                null=True,
            ),
        ),
        migrations.AddField(
            model_name="credential",
            name="verify_uuid",
            field=models.UUIDField(
                default=uuid.uuid4,
                editable=False,
                help_text="UUID used for verifying the credential",
                null=True,
            ),
        ),
        migrations.RunPython(backfill_credential_fields, reverse_code=migrations.RunPython.noop),
        migrations.AlterField(
            model_name="credential",
            name="learning_context_name",
            field=models.CharField(
                editable=False,
                help_text="Name of the learning context for which the credential was issued. This field is used for validation purposes.",
                max_length=255,
            ),
        ),
        migrations.AlterField(
            model_name="credential",
            name="verify_uuid",
            field=models.UUIDField(
                default=uuid.uuid4,
                editable=False,
                help_text="UUID used for verifying the credential",
            ),
        ),
    ]

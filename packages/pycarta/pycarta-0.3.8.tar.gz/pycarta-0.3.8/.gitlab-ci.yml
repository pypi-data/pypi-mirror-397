stages:
  - test
  - build
  - publish

test:
  stage: test
  image: python:3.12
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_TAG
      allow_failure: true
  script:
    - pip install -e ".[testing]"
    # Skip tests that require external services or interactive login
    - pytest --cov pycarta --cov-report term-missing --ignore=tests/auth/ --ignore=tests/admin/test_user_coverage.py --ignore=tests/test_mqtt.py

build:
  stage: build
  image: python:3.12
  rules:
    - if: $CI_COMMIT_TAG
      when: always
  script:
    - git fetch --tags
    - pip install --upgrade build
    - python -m build
  artifacts:
    paths:
      - dist/

publish:
  stage: publish
  image: python:3.12
  dependencies:
    - build
  rules:
    - if: $CI_COMMIT_TAG
      when: manual
      allow_failure: false
  id_tokens:
    PYPI_ID_TOKEN:
      aud: pypi
  script:
    - pip install --upgrade twine
    - twine upload dist/*

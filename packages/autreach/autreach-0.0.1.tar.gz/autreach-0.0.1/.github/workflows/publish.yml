name: Publish to PyPI

on:
    push:
        tags:
            - "v*"
        branches:
            - issue-2
    workflow_dispatch:
        inputs:
            version:
                description: "Version tag (e.g., v0.1.0)"
                required: true
                type: string

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Install pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 9

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "pnpm"
                  cache-dependency-path: studio-ui/pnpm-lock.yaml

            - name: Install frontend dependencies
              run: |
                  cd studio-ui
                  pnpm install --frozen-lockfile

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Install uv
              uses: astral-sh/setup-uv@v5
              with:
                  version: "latest"

            - name: Install build dependencies
              run: |
                  uv pip install --system build hatchling

            - name: Build package
              run: |
                  uv build

            - name: Upload artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: dist
                  path: dist/

    publish-pypi:
        runs-on: ubuntu-latest
        needs: build
        if: startsWith(github.ref, 'refs/tags/v')
        permissions:
            id-token: write
        environment:
            name: pypi
            url: https://pypi.org/p/autreach
        steps:
            - name: Download artifacts
              uses: actions/download-artifact@v4
              with:
                  name: dist
                  path: dist/

            - name: Publish to PyPI
              uses: pypa/gh-action-pypi-publish@release/v1
              with:
                  print-hash: true

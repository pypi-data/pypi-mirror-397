from __future__ import annotations

from typing import ClassVar, Iterable, overload

# count: int, total_count: int, data_count: int
BlockSpec = tuple[int, int, int]


# fmt: off
RS_POLY_LUT = {
    7:  bytes((1, 127, 122, 154, 164, 11, 68, 117)),
    10: bytes((1, 216, 194, 159, 111, 199, 94, 95, 113, 157, 193)),
    13: bytes((1, 137, 73, 227, 17, 177, 17, 52, 13, 46, 43, 83, 132, 120)),
    15: bytes((1, 29, 196, 111, 163, 112, 74, 10, 105, 105, 139, 132, 151, 32, 134, 26)),
    16: bytes((1, 59, 13, 104, 189, 68, 209, 30, 8, 163, 65, 41, 229, 98, 50, 36, 59)),
    17: bytes((1, 119, 66, 83, 120, 119, 22, 197, 83, 249, 41, 143, 134, 85, 53, 125, 99, 79)),
    18: bytes((1, 239, 251, 183, 113, 149, 175, 199, 215, 240, 220, 73, 82, 173, 75, 32, 67, 217, 146)),
    20: bytes((1, 152, 185, 240, 5, 111, 99, 6, 220, 112, 150, 69, 36, 187, 22, 228, 198, 121, 121, 165, 174)),
    22: bytes((1, 89, 179, 131, 176, 182, 244, 19, 189, 69, 40, 28, 137, 29, 123, 67, 253, 86, 218, 230, 26, 145, 245)),
    24: bytes((1, 122, 118, 169, 70, 178, 237, 216, 102, 115, 150, 229, 73, 130, 72, 61, 43, 206, 1, 237, 247, 127, 217, 144, 117)),
    26: bytes((1, 246, 51, 183, 4, 136, 98, 199, 152, 77, 56, 206, 24, 145, 40, 209, 117, 233, 42, 135, 68, 70, 144, 146, 77, 43, 94)),
    28: bytes((1, 252, 9, 28, 13, 18, 251, 208, 150, 103, 174, 100, 41, 167, 12, 247, 56, 117, 119, 233, 127, 181, 100, 121, 147, 176, 74, 58, 197)),
    30: bytes((1, 212, 246, 77, 73, 195, 192, 75, 98, 5, 70, 103, 177, 22, 217, 138, 51, 181, 246, 72, 25, 18, 46, 228, 74, 216, 195, 11, 106, 130, 150)),
}
# fmt: on

# fmt: off
EXP_TABLE = bytes((1, 2, 4, 8, 16, 32, 64, 128, 29, 58, 116, 232, 205, 135, 19, 38, 76, 152, 45, 90, 180, 117, 234, 201, 143, 3, 6, 12, 24, 48, 96, 192, 157, 39, 78, 156, 37, 74, 148, 53, 106, 212, 181, 119, 238, 193, 159, 35, 70, 140, 5, 10, 20, 40, 80, 160, 93, 186, 105, 210, 185, 111, 222, 161, 95, 190, 97, 194, 153, 47, 94, 188, 101, 202, 137, 15, 30, 60, 120, 240, 253, 231, 211, 187, 107, 214, 177, 127, 254, 225, 223, 163, 91, 182, 113, 226, 217, 175, 67, 134, 17, 34, 68, 136, 13, 26, 52, 104, 208, 189, 103, 206, 129, 31, 62, 124, 248, 237, 199, 147, 59, 118, 236, 197, 151, 51, 102, 204, 133, 23, 46, 92, 184, 109, 218, 169, 79, 158, 33, 66, 132, 21, 42, 84, 168, 77, 154, 41, 82, 164, 85, 170, 73, 146, 57, 114, 228, 213, 183, 115, 230, 209, 191, 99, 198, 145, 63, 126, 252, 229, 215, 179, 123, 246, 241, 255, 227, 219, 171, 75, 150, 49, 98, 196, 149, 55, 110, 220, 165, 87, 174, 65, 130, 25, 50, 100, 200, 141, 7, 14, 28, 56, 112, 224, 221, 167, 83, 166, 81, 162, 89, 178, 121, 242, 249, 239, 195, 155, 43, 86, 172, 69, 138, 9, 18, 36, 72, 144, 61, 122, 244, 245, 247, 243, 251, 235, 203, 139, 11, 22, 44, 88, 176, 125, 250, 233, 207, 131, 27, 54, 108, 216, 173, 71, 142, 1))
LOG_TABLE = bytes((0, 1, 25, 2, 50, 26, 198, 3, 223, 51, 238, 27, 104, 199, 75, 4, 100, 224, 14, 52, 141, 239, 129, 28, 193, 105, 248, 200, 8, 76, 113, 5, 138, 101, 47, 225, 36, 15, 33, 53, 147, 142, 218, 240, 18, 130, 69, 29, 181, 194, 125, 106, 39, 249, 185, 201, 154, 9, 120, 77, 228, 114, 166, 6, 191, 139, 98, 102, 221, 48, 253, 226, 152, 37, 179, 16, 145, 34, 136, 54, 208, 148, 206, 143, 150, 219, 189, 241, 210, 19, 92, 131, 56, 70, 64, 30, 66, 182, 163, 195, 72, 126, 110, 107, 58, 40, 84, 250, 133, 186, 61, 202, 94, 155, 159, 10, 21, 121, 43, 78, 212, 229, 172, 115, 243, 167, 87, 7, 112, 192, 247, 140, 128, 99, 13, 103, 74, 222, 237, 49, 197, 254, 24, 227, 165, 153, 119, 38, 184, 180, 124, 17, 68, 146, 217, 35, 32, 137, 46, 55, 63, 209, 91, 149, 188, 207, 205, 144, 135, 151, 178, 220, 252, 190, 97, 242, 86, 211, 171, 20, 42, 93, 158, 132, 60, 57, 83, 71, 109, 65, 162, 31, 45, 67, 216, 183, 123, 164, 118, 196, 23, 73, 236, 127, 12, 111, 246, 108, 161, 59, 82, 41, 157, 85, 170, 251, 96, 134, 177, 187, 204, 62, 90, 203, 89, 95, 176, 156, 169, 160, 81, 11, 245, 22, 235, 122, 117, 44, 215, 79, 174, 213, 233, 230, 231, 173, 232, 116, 214, 244, 234, 168, 80, 88, 175))
# fmt: on


def glog(n: int):
    return LOG_TABLE[n - 1]


def gexp(n: int):
    return EXP_TABLE[n % 255]


# On a class level, this represents the Correction level regardless of version
# Once instantiated, it represents correction for the concrete version
class Corr:
    # for each version: (BlockSpec, ...).
    # version[0] is empty
    _blockspec_by_version: ClassVar[tuple[tuple[BlockSpec, ...], ...]]
    code: ClassVar[int]

    __slots__ = "version"

    def __init_subclass__(cls):
        assert len(cls._blockspec_by_version) == 41

    def __init__(self, version: int):
        self.version = version

    def iter_blocks(self):
        for count, total_count, data_count in self._blockspec_by_version[self.version]:
            for _ in range(count):
                yield total_count, data_count

    def get_bit_capacity(self):
        return self.get_bit_capacity_for_version(self.version)

    def apply_to(self, src: bytearray):
        offset = 0

        max_dc_count = 0
        max_ec_count = 0

        dc_data: list[bytearray] = []
        ec_data: list[bytearray] = []

        for total_count, data_count in self.iter_blocks():
            dc_count = data_count
            ec_count = total_count - dc_count

            max_dc_count = max(max_dc_count, dc_count)
            max_ec_count = max(max_ec_count, ec_count)

            current_dc = src[offset : dc_count + offset]
            offset += dc_count

            # Get error correction polynomial.
            if ec_count in RS_POLY_LUT:
                poly = Polynomial(RS_POLY_LUT[ec_count], 0)
            else:
                poly = Polynomial([1], 0)
                for i in range(ec_count):
                    poly = poly * Polynomial([1, gexp(i)], 0)

            raw_poly = Polynomial(current_dc, len(poly) - 1)

            mod_poly = raw_poly % poly
            current_ec = bytearray()
            mod_offset = len(mod_poly) - ec_count
            for i in range(ec_count):
                mod_index = i + mod_offset
                current_ec.append(mod_poly[mod_index] if (mod_index >= 0) else 0)

            dc_data.append(current_dc)
            ec_data.append(current_ec)

        data = bytearray()

        # NOTE: this is likely could be optimized with slices/zips
        data.extend(dc[i] for i in range(max_dc_count) for dc in dc_data if len(dc) > i)
        data.extend(ec[i] for i in range(max_ec_count) for ec in ec_data if len(ec) > i)

        return data

    @classmethod
    def get_bit_capacity_for_version(cls, version: int):
        byte_capacity = 0
        for count, _, data_count in cls._blockspec_by_version[version]:
            byte_capacity += count * data_count
        return byte_capacity * 8


class CorrL(Corr):

    code = 1

    _blockspec_by_version = (
        (),
        ((1, 26, 19),),
        ((1, 44, 34),),
        ((1, 70, 55),),
        ((1, 100, 80),),
        ((1, 134, 108),),
        ((2, 86, 68),),
        ((2, 98, 78),),
        ((2, 121, 97),),
        ((2, 146, 116),),
        ((2, 86, 68), (2, 87, 69)),
        ((4, 101, 81),),
        ((2, 116, 92), (2, 117, 93)),
        ((4, 133, 107),),
        ((3, 145, 115), (1, 146, 116)),
        ((5, 109, 87), (1, 110, 88)),
        ((5, 122, 98), (1, 123, 99)),
        ((1, 135, 107), (5, 136, 108)),
        ((5, 150, 120), (1, 151, 121)),
        ((3, 141, 113), (4, 142, 114)),
        ((3, 135, 107), (5, 136, 108)),
        ((4, 144, 116), (4, 145, 117)),
        ((2, 139, 111), (7, 140, 112)),
        ((4, 151, 121), (5, 152, 122)),
        ((6, 147, 117), (4, 148, 118)),
        ((8, 132, 106), (4, 133, 107)),
        ((10, 142, 114), (2, 143, 115)),
        ((8, 152, 122), (4, 153, 123)),
        ((3, 147, 117), (10, 148, 118)),
        ((7, 146, 116), (7, 147, 117)),
        ((5, 145, 115), (10, 146, 116)),
        ((13, 145, 115), (3, 146, 116)),
        ((17, 145, 115),),
        ((17, 145, 115), (1, 146, 116)),
        ((13, 145, 115), (6, 146, 116)),
        ((12, 151, 121), (7, 152, 122)),
        ((6, 151, 121), (14, 152, 122)),
        ((17, 152, 122), (4, 153, 123)),
        ((4, 152, 122), (18, 153, 123)),
        ((20, 147, 117), (4, 148, 118)),
        ((19, 148, 118), (6, 149, 119)),
    )


class CorrM(Corr):

    code = 0

    _blockspec_by_version = (
        (),
        ((1, 26, 16),),
        ((1, 44, 28),),
        ((1, 70, 44),),
        ((2, 50, 32),),
        ((2, 67, 43),),
        ((4, 43, 27),),
        ((4, 49, 31),),
        ((2, 60, 38), (2, 61, 39)),
        ((3, 58, 36), (2, 59, 37)),
        ((4, 69, 43), (1, 70, 44)),
        ((1, 80, 50), (4, 81, 51)),
        ((6, 58, 36), (2, 59, 37)),
        ((8, 59, 37), (1, 60, 38)),
        ((4, 64, 40), (5, 65, 41)),
        ((5, 65, 41), (5, 66, 42)),
        ((7, 73, 45), (3, 74, 46)),
        ((10, 74, 46), (1, 75, 47)),
        ((9, 69, 43), (4, 70, 44)),
        ((3, 70, 44), (11, 71, 45)),
        ((3, 67, 41), (13, 68, 42)),
        ((17, 68, 42),),
        ((17, 74, 46),),
        ((4, 75, 47), (14, 76, 48)),
        ((6, 73, 45), (14, 74, 46)),
        ((8, 75, 47), (13, 76, 48)),
        ((19, 74, 46), (4, 75, 47)),
        ((22, 73, 45), (3, 74, 46)),
        ((3, 73, 45), (23, 74, 46)),
        ((21, 73, 45), (7, 74, 46)),
        ((19, 75, 47), (10, 76, 48)),
        ((2, 74, 46), (29, 75, 47)),
        ((10, 74, 46), (23, 75, 47)),
        ((14, 74, 46), (21, 75, 47)),
        ((14, 74, 46), (23, 75, 47)),
        ((12, 75, 47), (26, 76, 48)),
        ((6, 75, 47), (34, 76, 48)),
        ((29, 74, 46), (14, 75, 47)),
        ((13, 74, 46), (32, 75, 47)),
        ((40, 75, 47), (7, 76, 48)),
        ((18, 75, 47), (31, 76, 48)),
    )


class CorrQ(Corr):
    code = 3

    _blockspec_by_version = (
        (),
        ((1, 26, 13),),
        ((1, 44, 22),),
        ((2, 35, 17),),
        ((2, 50, 24),),
        ((2, 33, 15), (2, 34, 16)),
        ((4, 43, 19),),
        ((2, 32, 14), (4, 33, 15)),
        ((4, 40, 18), (2, 41, 19)),
        ((4, 36, 16), (4, 37, 17)),
        ((6, 43, 19), (2, 44, 20)),
        ((4, 50, 22), (4, 51, 23)),
        ((4, 46, 20), (6, 47, 21)),
        ((8, 44, 20), (4, 45, 21)),
        ((11, 36, 16), (5, 37, 17)),
        ((5, 54, 24), (7, 55, 25)),
        ((15, 43, 19), (2, 44, 20)),
        ((1, 50, 22), (15, 51, 23)),
        ((17, 50, 22), (1, 51, 23)),
        ((17, 47, 21), (4, 48, 22)),
        ((15, 54, 24), (5, 55, 25)),
        ((17, 50, 22), (6, 51, 23)),
        ((7, 54, 24), (16, 55, 25)),
        ((11, 54, 24), (14, 55, 25)),
        ((11, 54, 24), (16, 55, 25)),
        ((7, 54, 24), (22, 55, 25)),
        ((28, 50, 22), (6, 51, 23)),
        ((8, 53, 23), (26, 54, 24)),
        ((4, 54, 24), (31, 55, 25)),
        ((1, 53, 23), (37, 54, 24)),
        ((15, 54, 24), (25, 55, 25)),
        ((42, 54, 24), (1, 55, 25)),
        ((10, 54, 24), (35, 55, 25)),
        ((29, 54, 24), (19, 55, 25)),
        ((44, 54, 24), (7, 55, 25)),
        ((39, 54, 24), (14, 55, 25)),
        ((46, 54, 24), (10, 55, 25)),
        ((49, 54, 24), (10, 55, 25)),
        ((48, 54, 24), (14, 55, 25)),
        ((43, 54, 24), (22, 55, 25)),
        ((34, 54, 24), (34, 55, 25)),
    )


class CorrH(Corr):

    code = 2

    _blockspec_by_version = (
        (),
        ((1, 26, 9),),
        ((1, 44, 16),),
        ((2, 35, 13),),
        ((4, 25, 9),),
        ((2, 33, 11), (2, 34, 12)),
        ((4, 43, 15),),
        ((4, 39, 13), (1, 40, 14)),
        ((4, 40, 14), (2, 41, 15)),
        ((4, 36, 12), (4, 37, 13)),
        ((6, 43, 15), (2, 44, 16)),
        ((3, 36, 12), (8, 37, 13)),
        ((7, 42, 14), (4, 43, 15)),
        ((12, 33, 11), (4, 34, 12)),
        ((11, 36, 12), (5, 37, 13)),
        ((11, 36, 12), (7, 37, 13)),
        ((3, 45, 15), (13, 46, 16)),
        ((2, 42, 14), (17, 43, 15)),
        ((2, 42, 14), (19, 43, 15)),
        ((9, 39, 13), (16, 40, 14)),
        ((15, 43, 15), (10, 44, 16)),
        ((19, 46, 16), (6, 47, 17)),
        ((34, 37, 13),),
        ((16, 45, 15), (14, 46, 16)),
        ((30, 46, 16), (2, 47, 17)),
        ((22, 45, 15), (13, 46, 16)),
        ((33, 46, 16), (4, 47, 17)),
        ((12, 45, 15), (28, 46, 16)),
        ((11, 45, 15), (31, 46, 16)),
        ((19, 45, 15), (26, 46, 16)),
        ((23, 45, 15), (25, 46, 16)),
        ((23, 45, 15), (28, 46, 16)),
        ((19, 45, 15), (35, 46, 16)),
        ((11, 45, 15), (46, 46, 16)),
        ((59, 46, 16), (1, 47, 17)),
        ((22, 45, 15), (41, 46, 16)),
        ((2, 45, 15), (64, 46, 16)),
        ((24, 45, 15), (46, 46, 16)),
        ((42, 45, 15), (32, 46, 16)),
        ((10, 45, 15), (67, 46, 16)),
        ((20, 45, 15), (61, 46, 16)),
    )


class Polynomial:
    __slots__ = ("num",)

    def __init__(self, num: Iterable[int], shift: int):
        assert num

        num = list(num)

        offset = 0
        for offset in range(len(num)):
            if num[offset] != 0:
                break

        self.num = num[offset:] + [0] * shift

    @overload
    def __getitem__(self, index: int) -> int: ...

    @overload
    def __getitem__(self, index: slice) -> list[int]: ...

    def __getitem__(self, index: int | slice):
        return self.num[index]

    def __iter__(self):
        return iter(self.num)

    def __len__(self):
        return len(self.num)

    def __mul__(self, other: Polynomial):
        num = [0] * (len(self) + len(other) - 1)

        for i, item in enumerate(self):
            for j, other_item in enumerate(other):
                num[i + j] ^= gexp(glog(item) + glog(other_item))

        return Polynomial(num, 0)

    def __mod__(self, other: Polynomial) -> Polynomial:
        difference = len(self) - len(other)
        if difference < 0:
            return self

        ratio = glog(self[0]) - glog(other[0])

        num = [item ^ gexp(glog(other_item) + ratio) for item, other_item in zip(self, other, strict=False)]
        if difference:
            num.extend(self[-difference:])

        # recursive call
        return Polynomial(num, 0) % other

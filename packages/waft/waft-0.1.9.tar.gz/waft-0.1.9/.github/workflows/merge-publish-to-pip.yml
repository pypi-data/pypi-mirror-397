name: Publish New Version of Package to PyPI

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build:
    runs-on: ubuntu-latest
    # Only run if the commit has a tag
    if: startsWith(github.ref, 'refs/tags/')
    defaults:
      run:
        shell: bash -l {0}

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: pip install hatch hatchling

      - name: Get version from tag
        id: version
        run: |
          echo "current=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: Check if version exists on PyPI
        id: check
        run: |
          if pip index versions waft | grep -q "${{ steps.version.outputs.current }}"; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true
      
      - name: Build package
        if: steps.check.outputs.exists == 'false'
        run: hatch build
      
      - name: Publish to PyPI
        if: steps.check.outputs.exists == 'false'
        env:
          HATCH_INDEX_USER: __token__
          HATCH_INDEX_AUTH: ${{ secrets.PYPI_API_TOKEN }}
        run: hatch publish

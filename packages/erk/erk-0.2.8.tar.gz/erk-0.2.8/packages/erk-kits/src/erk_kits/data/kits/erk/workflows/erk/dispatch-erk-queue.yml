---
erk:
  kit: erk
---
# REQUIRED REPOSITORY SETTING:
# Settings > Actions > General > Workflow permissions
# âœ“ Enable "Allow GitHub Actions to create and approve pull requests"
#
# Without this setting, PR creation will fail with:
# "GitHub Actions is not permitted to create or approve pull requests"
#
# REQUIRED SECRETS:
# - ANTHROPIC_API_KEY: Claude API key for implementation
# - ERK_QUEUE_GH_PAT: GitHub PAT with repo/workflow permissions for CI triggers

name: Dispatch Erk Queue
run-name: "${{ inputs.issue_number }}:${{ inputs.distinct_id }}"

on:
  workflow_dispatch:
    inputs:
      # Standard erk inputs (always required)
      issue_number:
        description: "GitHub issue number to implement"
        required: true
        type: string
      submitted_by:
        description: "GitHub username of the person who submitted the issue"
        required: true
        type: string
      distinct_id:
        description: "Unique identifier for run discovery (base36)"
        required: true
        type: string
      issue_title:
        description: "Issue title for workflow run display"
        required: true
        type: string
      branch_name:
        description: "Branch name for implementation (created by submit command)"
        required: true
        type: string
      pr_number:
        description: "PR number for implementation (created by submit command)"
        required: true
        type: string

      # Parameterized inputs for repo customization
      kit_names:
        description: "Kits to install (comma-separated, e.g., 'erk,gt,devrun')"
        required: true
        type: string
      package_install_script:
        description: "Shell script for package installation (optional)"
        default: ""
        type: string
      model_name:
        description: "Claude model to use"
        default: "claude-sonnet-4-5-20250929"
        type: string

concurrency:
  group: implement-issue-${{ github.event.inputs.issue_number }}
  cancel-in-progress: true

jobs:
  implement:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      # =================================================================
      # PHASE 1: CHECKOUT AND SETUP
      # =================================================================
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.ERK_QUEUE_GH_PAT }}
          fetch-depth: 0

      - name: Setup base tools
        run: |
          # Install uv
          curl -LsSf https://astral.sh/uv/install.sh | sh
          source $HOME/.cargo/env

          # Install Claude Code
          curl -fsSL https://claude.ai/install.sh | bash

          # Install Prettier via npm
          npm install -g prettier

          # Install erk-kits for kit management
          cd $GITHUB_WORKSPACE
          uv tool install erk-kits

      - name: Run custom package installation
        if: inputs.package_install_script != ''
        env:
          PACKAGE_INSTALL_SCRIPT: ${{ inputs.package_install_script }}
        run: |
          source $HOME/.cargo/env
          cd $GITHUB_WORKSPACE
          eval "$PACKAGE_INSTALL_SCRIPT"

      - name: Install kits
        env:
          KIT_NAMES: ${{ inputs.kit_names }}
        run: |
          source $HOME/.cargo/env
          cd $GITHUB_WORKSPACE

          # Install each kit specified
          for kit in $(echo "$KIT_NAMES" | tr ',' '\n' | tr -d ' '); do
            echo "Installing kit: $kit"
            erk kit install "$kit"
          done

      - name: Configure git
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          source $HOME/.cargo/env
          erk kit exec erk configure-git-user

      - name: Detect trunk branch
        id: trunk
        run: |
          if git ls-remote --heads origin main | grep -q main; then
            echo "trunk_branch=main" >> $GITHUB_OUTPUT
            echo "Detected trunk branch: main"
          elif git ls-remote --heads origin master | grep -q master; then
            echo "trunk_branch=master" >> $GITHUB_OUTPUT
            echo "Detected trunk branch: master"
          else
            echo "âŒ Could not detect trunk branch (main or master)"
            exit 1
          fi

      # =================================================================
      # PHASE 2: BRANCH SETUP
      # =================================================================
      - name: Set branch and PR from inputs
        id: find_pr
        run: |
          echo "branch_name=${{ inputs.branch_name }}" >> $GITHUB_OUTPUT
          echo "pr_number=${{ inputs.pr_number }}" >> $GITHUB_OUTPUT
          echo "pr_exists=true" >> $GITHUB_OUTPUT
          echo "Using branch: ${{ inputs.branch_name }}"
          echo "Using PR: #${{ inputs.pr_number }}"

      - name: Checkout implementation branch
        env:
          BRANCH_NAME: ${{ steps.find_pr.outputs.branch_name }}
          ISSUE_NUMBER: ${{ inputs.issue_number }}
          GH_TOKEN: ${{ github.token }}
        run: |
          source $HOME/.cargo/env

          git fetch origin "$BRANCH_NAME"
          git checkout "$BRANCH_NAME"

          # Update .worker-impl/ with fresh plan
          rm -rf .worker-impl
          erk kit exec erk create-worker-impl-from-issue "$ISSUE_NUMBER"

          if [ $? -ne 0 ]; then
            gh issue comment "$ISSUE_NUMBER" --body "âŒ **Plan Update Failed**

          Could not fetch plan content for issue #$ISSUE_NUMBER."
            exit 1
          fi

          # Commit if changed (git already configured by configure-git-user step)
          git add .worker-impl
          if [[ -n $(git status --porcelain) ]]; then
            git commit -m "Update plan for issue #$ISSUE_NUMBER (rerun)"
            git push origin "$BRANCH_NAME"
          fi

          echo "Checked out branch: $BRANCH_NAME"

      # =================================================================
      # PHASE 3: PR SETUP
      # =================================================================
      - name: Post workflow started comment
        env:
          ISSUE_NUMBER: ${{ inputs.issue_number }}
          BRANCH_NAME: ${{ steps.find_pr.outputs.branch_name }}
          PR_NUMBER: ${{ inputs.pr_number }}
          GH_TOKEN: ${{ github.token }}
        run: |
          STARTED_AT=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          WORKFLOW_RUN_ID="${{ github.run_id }}"
          WORKFLOW_RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          cat > comment_body.md <<EOF
          âš™ï¸ GitHub Action Started

          <details>
          <summary>ðŸ“‹ Metadata</summary>

          <!-- erk:metadata-block:workflow-started -->
          \`\`\`yaml
          schema: workflow-started
          status: started
          started_at: $STARTED_AT
          workflow_run_id: "$WORKFLOW_RUN_ID"
          workflow_run_url: $WORKFLOW_RUN_URL
          branch_name: $BRANCH_NAME
          issue_number: $ISSUE_NUMBER
          \`\`\`
          <!-- /erk:metadata-block:workflow-started -->

          </details>

          ---

          Setup completed successfully.

          **Branch:** \`$BRANCH_NAME\`
          **PR:** [#$PR_NUMBER](https://github.com/${{ github.repository }}/pull/$PR_NUMBER)
          **Status:** Ready for implementation

          [View workflow run]($WORKFLOW_RUN_URL)
          EOF

          gh issue comment "$ISSUE_NUMBER" --body-file comment_body.md
          rm -f comment_body.md

      - name: Add remote execution note to PR
        env:
          PR_NUMBER: ${{ inputs.pr_number }}
          GH_TOKEN: ${{ github.token }}
          WORKFLOW_RUN_ID: ${{ github.run_id }}
          WORKFLOW_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          source $HOME/.cargo/env
          erk kit exec erk add-remote-execution-note \
            --pr-number "$PR_NUMBER" \
            --run-id "$WORKFLOW_RUN_ID" \
            --run-url "$WORKFLOW_RUN_URL"

      # =================================================================
      # PHASE 4: IMPLEMENTATION
      # =================================================================
      - name: Set up implementation folder
        env:
          RUN_ID: ${{ github.run_id }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          source $HOME/.cargo/env
          cp -r .worker-impl .impl
          echo "âœ“ Copied .worker-impl/ to .impl/"

          erk kit exec erk create-impl-run-info --run-id "$RUN_ID" --run-url "$RUN_URL"
          echo "âœ“ Created .impl/run-info.json"

      - name: Run implementation
        id: implement
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ github.token }}
          MODEL_NAME: ${{ inputs.model_name }}
        run: |
          set +e

          claude --print \
            --model "$MODEL_NAME" \
            --output-format stream-json \
            --dangerously-skip-permissions \
            --verbose \
            "/erk:plan-implement"

          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT

          if [ $EXIT_CODE -eq 0 ]; then
            echo "implementation_success=true" >> $GITHUB_OUTPUT
          else
            echo "implementation_success=false" >> $GITHUB_OUTPUT
          fi

          # Delete .worker-impl/ now - it's no longer needed (.impl/ has the copy)
          # This prevents it from appearing in the submission diff
          if [ -d .worker-impl/ ]; then
            rm -rf .worker-impl/
            echo "âœ“ Removed .worker-impl/ before submission"
          fi

          exit 0

      # =================================================================
      # PHASE 5: SUBMISSION (Pure Git - no Graphite)
      # =================================================================
      - name: Submit branch with proper commit message
        id: submit
        if: steps.implement.outputs.implementation_success == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ github.token }}
          ISSUE_NUMBER: ${{ inputs.issue_number }}
          BRANCH_NAME: ${{ steps.find_pr.outputs.branch_name }}
          MODEL_NAME: ${{ inputs.model_name }}
        run: |
          # Submit with pure git - .worker-impl/ was already deleted, so agent sees only impl changes
          # Git already configured by configure-git-user step
          claude --print \
            --model "$MODEL_NAME" \
            --output-format stream-json \
            --dangerously-skip-permissions \
            --verbose \
            "/git:pr-push Implement issue #$ISSUE_NUMBER"

          # Capture implementation commit SHA
          echo "impl_sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Mark PR ready for review
        if: steps.implement.outputs.implementation_success == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          BRANCH_NAME: ${{ steps.find_pr.outputs.branch_name }}
        run: |
          gh pr ready "$BRANCH_NAME"
          echo "âœ… PR marked ready for review"

      - name: Update PR body with implementation summary
        if: steps.implement.outputs.implementation_success == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          ISSUE_NUMBER: ${{ inputs.issue_number }}
          RUN_ID: ${{ github.run_id }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          # Get the implementation commit message using the captured SHA
          commit_body=$(git log "$IMPL_SHA" -1 --pretty=%B)

          # Get PR number for checkout instructions
          PR_NUMBER=$(gh pr view "$BRANCH_NAME" --json number -q .number)

          # Get standardized body footer from get-pr-body-footer
          pr_metadata=$(erk kit exec erk get-pr-body-footer --pr-number "$PR_NUMBER" --issue-number "$ISSUE_NUMBER" 2>/dev/null || echo "")

          # Build PR body: summary + footer
          cat > pr_body.md <<BODY_EOF
          ## Summary

          $commit_body
          $pr_metadata
          BODY_EOF

          gh pr edit "$BRANCH_NAME" --body-file pr_body.md
          rm -f pr_body.md
          echo "âœ… PR body updated with implementation summary"

      - name: Trigger CI workflows
        if: steps.implement.outputs.implementation_success == 'true'
        env:
          BRANCH_NAME: ${{ steps.find_pr.outputs.branch_name }}
        run: |
          # Push empty commit to trigger CI via push event
          # Using PAT from checkout step allows triggering other workflows
          # Git already configured by configure-git-user step
          git commit --allow-empty -m "Trigger CI workflows"
          git push origin "$BRANCH_NAME"
          echo "âœ… CI workflows triggered via push event"

# AWBM Integration Examples

This directory contains examples demonstrating the AWBM (Australian Water Balance Model) integration in HydroSim.

## Files

### `awbm_example.yaml`
Complete YAML configuration example showing how to set up an AWBM rainfall-runoff model in a HydroSim network. This example includes:

- **AWBM Source Node**: Configured with typical Australian catchment parameters
- **Storage Reservoir**: Receives inflow from the AWBM catchment
- **Municipal Demand**: Represents water demand from a city
- **Network Links**: Connect the components with capacity and cost constraints

**Key AWBM Parameters:**
- `area`: Catchment area in square meters (5.0e7 = 50 km²)
- `A1, A2, A3`: Surface store capacities in millimeters
- `f1, f2, f3`: Partial area fractions (must sum to 1.0)
- `BFI`: Baseflow Index (0.0 to 1.0)
- `K_base`: Baseflow recession constant (0.0 to 1.0)
- `initial_storage`: Initial saturation fraction (optional, default 0.5)

### `awbm_integration_demo.py`
Comprehensive demonstration script showing multiple ways to use AWBM in HydroSim:

1. **Programmatic Usage**: Create and use AWBM strategy directly in Python code
2. **YAML Configuration**: Load and run networks from YAML files
3. **Parameter Sensitivity**: Explore how different parameters affect model behavior
4. **Mass Balance Verification**: Demonstrate conservation properties and numerical stability

**Usage:**
```bash
cd examples
python awbm_integration_demo.py
```

The script will:
- Generate sample climate data (`climate_data.csv`)
- Run multiple demonstrations
- Show detailed output and analysis
- Verify mass balance conservation

### `climate_data.csv`
Sample climate data file generated by the demonstration script. Contains columns:
- `date`: Daily timestamps
- `precip`: Precipitation in mm/day
- `t_max`: Maximum temperature in °C
- `t_min`: Minimum temperature in °C
- `solar`: Solar radiation in MJ/m²/day

## AWBM Model Overview

The Australian Water Balance Model (AWBM) is a conceptual rainfall-runoff model that:

1. **Uses Three Surface Stores**: Each with different capacities (A1, A2, A3) representing spatial variability
2. **Applies Partial Area Concept**: Each store represents a fraction of the catchment (f1, f2, f3)
3. **Partitions Excess Flow**: Between surface runoff and baseflow using the Baseflow Index (BFI)
4. **Manages Baseflow**: Through exponential recession with constant K_base

### Mathematical Formulation

For each surface store i:
```
Store_i(t+1) = min(Ai, max(0, Store_i(t) + Precip - ET0))
Excess_i = max(0, Store_i(t) + Precip - ET0 - Ai) * fi
```

Flow partitioning:
```
Surface_Runoff = Total_Excess * (1 - BFI)
Baseflow_Input = Total_Excess * BFI
```

Baseflow recession:
```
Baseflow_Output = Baseflow_Store * (1 - K_base)
Baseflow_Store = Baseflow_Store * K_base + Baseflow_Input
```

## Requirements

- HydroSim with AWBM integration
- Python 3.8+
- pandas, numpy (for demonstrations)
- matplotlib (optional, for plotting)
- PyYAML (for YAML configuration)

## Parameter Guidelines

### Typical Australian Catchment Parameters
- **A1**: 50-200 mm (small store, quick response)
- **A2**: 200-600 mm (medium store)
- **A3**: 200-800 mm (large store, slow response)
- **f1, f2, f3**: Usually 0.2-0.4 each, must sum to 1.0
- **BFI**: 0.1-0.7 (higher for groundwater-dominated catchments)
- **K_base**: 0.9-0.99 (higher values = slower recession)

### Calibration Tips
1. Start with literature values for similar catchments
2. Adjust store capacities to match runoff volume
3. Tune BFI to match baseflow characteristics
4. Adjust K_base to match recession behavior
5. Use partial area fractions to fine-tune hydrograph shape

## Integration with HydroSim

The AWBM strategy integrates seamlessly with HydroSim's architecture:

- **Inherits from GeneratorStrategy**: Standard interface for all inflow generators
- **Uses ClimateEngine**: Automatically receives precipitation and ET0 data
- **Supports SourceNodes**: Can be assigned to any source node in the network
- **Maintains State**: Preserves store levels across timesteps
- **Provides Reset**: Can restore initial conditions for scenario analysis

## Troubleshooting

### Common Issues

1. **Parameter validation errors**: Ensure f1 + f2 + f3 = 1.0 and all parameters are in valid ranges
2. **Missing climate data**: Ensure climate CSV has required columns (date, precip, t_max, t_min, solar)
3. **Unit conversion**: Remember catchment area must be in square meters
4. **Numerical stability**: Very small or large parameter values may cause instability

### Debugging Tools

The AWBM strategy provides several debugging methods:
- `get_state_summary()`: Current store levels and statistics
- `get_mass_balance_summary()`: Cumulative mass balance verification
- `check_numerical_stability()`: Stability diagnostics

## References

- eWater AWBM Documentation
- Boughton, W. (2004). The Australian water balance model. Environmental Modelling & Software, 19(10), 943-956.
- HydroSim Documentation: https://hydrosim.readthedocs.io/
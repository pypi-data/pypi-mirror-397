# ============================================================================
# QLC MARS RETRIEVAL WORKFLOW
# ============================================================================
# Part of QLC (Quick Look Content) v1.0.1-beta
# An Automated Model-Observation Comparison Suite Optimized for CAMS
#
# Documentation:
#   - Online Docs:   https://docs.researchconcepts.io/qlc/latest/
#   - Workflows:     https://docs.researchconcepts.io/qlc/latest/user-guide/workflows/
#   - Variables:     https://docs.researchconcepts.io/qlc/latest/user-guide/variable-system/
#   - Configuration: https://docs.researchconcepts.io/qlc/latest/user-guide/configuration/
#
# Workflow Description:
#   MARS data retrieval only - no processing or analysis. Use this workflow
#   when you want to fetch data for later processing or testing.
#
# Usage:
#   qlc <exp1> [exp2 ...] <start_date> <end_date> mars
#   Example: qlc b2ro b2rn 2018-12-01 2018-12-21 mars
#
# Validation:
#   qlc-vars validate ~/qlc/config/workflows/mars/qlc_mars.conf
#
# Copyright (c) 2018-2025 ResearchConcepts io GmbH. All Rights Reserved.
# Questions/Comments: qlc Team @ ResearchConcepts io GmbH <qlc@researchconcepts.io>
# ============================================================================
#----------------------- MARS TASK CONFIGURATION -------------
#----------------------------------------------------------------------
# ECMWF: MARS Archive (or Historical) Data
#
# References:
#   - https://confluence.ecmwf.int/display/DAC/MARS+Archive+Data
#   - https://confluence.ecmwf.int/display/UDOC/MARS+keywords
#
# This configuration is loaded when running: qlc ... mars
#----------------------------------------------------------------------
# Workflow:
#   1. Run A1-MARS script to retrieve grib data (mars task)
#----------------------------------------------------------------------
# VARIABLE SPECIFICATION:
#   Variables are defined in MARS_RETRIEVALS below
#   Uses table-driven system with 7,000+ IFS parameters
#   No need for manual parameter mapping
#
# DATA RETRIEVAL BEHAVIOR:
#   - Auto-generates MARS request files from MARS_RETRIEVALS
#   - Checks data_retrieved_*.flag files; only retrieves if missing
#   - Creates .flag after successful MARS submission
#
# TO FORCE RE-RETRIEVAL:
#   rm ~/qlc/Results/<exp>/data_retrieved_<exp>_<dates>_<var>.flag
#----------------------------------------------------------------------
# Usage Examples:
#   cd ~/qlc/run
#   qlc b2ro b2rn 2018-12-01 2018-12-21 mars  # bash  processing (interactive)
#  sqlc b2ro b2rn 2018-12-01 2018-12-21 mars  # batch processing (automatic)
# Note: Use command line override if needed to match exp class (default=rd)
#  sqlc b2ro b2rn 2018-12-01 2018-12-21 mars -class=nl,nl
#  sqlc b2ro b2rn 2018-12-01 2018-12-21 mars -class=nl,nl -obs-only
#  sqlc b2ro b2rn 2018-12-01 2018-12-21 mars -class=nl,nl -mod-only
#----------------------------------------------------------------------

#----------------------------------------------------------------------
# Source qlc.conf base configuration and common functions
#----------------------------------------------------------------------
[ -f "$HOME/qlc/config/qlc.conf" ] && source "$HOME/qlc/config/qlc.conf" || {
    echo "[$(date +"%Y-%m-%d %H:%M:%S")] [ERROR] Base config not found: $HOME/qlc/config/qlc.conf" >&2
    exit 1
}
#----------------------------------------------------------------------
# Run-time definitions - Control which scripts to execute
#----------------------------------------------------------------------
# Workflow: MARS retrieval 
SUBSCRIPT_NAMES=("A1-MARS")
#----------------------------------------------------------------------
# Global MARS Retrievals - NEW v1.0.1 SIMPLIFIED SYNTAX
#----------------------------------------------------------------------
#MARS_RETRIEVALS=("@MARS_VARS_AEROSOL" "@MARS_VARS_GASES")
#MARS_RETRIEVALS=("@MARS_VARS_SFC" "@MARS_VARS_PL")
MARS_RETRIEVALS=("@MARS_VARS_VARS")

# Global MARS retrievals (default for all regions unless overridden)
# Defines which model variables should be retrieved
#
# SYNTAX OPTIONS:
#
# 1. Simple variable name (auto-resolves to sfc by default):
#    MARS_RETRIEVALS=("go3")
#
# 2. With explicit level type:
#    MARS_RETRIEVALS=("pl:NH3" "sfc:NH4_as")
#
# 3. With underscore notation (levtype_varname):
#    MARS_RETRIEVALS=("sfc_go3" "pl_NH3")
#
# 4. Using variable groups:
#    MARS_RETRIEVALS=("@MARS_Test")
#    Define groups in [VARIABLE_GROUPS] section below
#
# 5. Rename syntax (display_name,lookup_name) - retrieves lookup_name, displays as display_name (different variants):
#    MARS_RETRIEVALS=("O3,go3")               # Retrieve go3, display as O3 (sfc level, default)
#    MARS_RETRIEVALS=("sfc:O3,go3")           # Retrieve go3, display as O3 (sfc level, explicit)
#    MARS_RETRIEVALS=( "pl:O3,go3")           # Retrieve go3, display as O3 (pl  level)
#    MARS_RETRIEVALS=( "ml:O3,go3")           # Retrieve go3, display as O3 (ml  level)
#    MARS_RETRIEVALS=( "ml_O3,210203")        # Retrieve GRIB 210203, display as O3 (ml level)
#
# 6. Legacy format (still supported - backward compatible):
#    MARS_RETRIEVALS=("sfc_O3,210203,Ozone")
#
# NOTE: For groups with multiple renamed variables, use semicolons to separate:
#    [VARIABLE_GROUPS]
#    MARS_Test=O3,210203;NH3,19.217   # Explicit: semicolon separates variables
#
# EXAMPLES:
#
# Example 1: Single surface variable (using IFS name)
# MARS_RETRIEVALS=("go3")
#
# Example 2: Same variable but with cleaner display name for plots
# MARS_RETRIEVALS=("O3,go3")
#
# Example 3: Multiple variables with different levels
# MARS_RETRIEVALS=("pl:NH3" "sfc:NH4_as")
#
# Example 4: Multiple variables with rename for better plot labels
# MARS_RETRIEVALS=("pl:O3,go3" "sfc:NH4_as,NH4_as")
#
# Example 5: Using a custom group (define in workflow config or qlc.conf)
  MARS_RETRIEVALS=("@MARS_VARS")
#
# To define custom groups, add to qlc.conf or this config:
# [VARIABLE_GROUPS]
# MARS_Test = sfc:NH4_as,pl:NH3
#
# COMMAND LINE OVERRIDES:
#
# Override variables at runtime (comma-separated for multiple variables):
#
#   # Single variable (IFS name)
#   qlc b2ro b2rn 2018-12-01 2018-12-21 mars -vars=go3
#
#   # Single variable with rename (retrieve go3, display as O3)
#   qlc b2ro b2rn 2018-12-01 2018-12-21 mars -vars="O3,go3"
#
#   # Single variable with rename and level type
#   qlc b2ro b2rn 2018-12-01 2018-12-21 mars -vars="pl:O3,go3"
#
#   # Single variable using GRIB parameter ID with rename
#   qlc b2ro b2rn 2018-12-01 2018-12-21 mars -vars="O3,210203"
#
#   # Multiple variables (comma-separated)
#   qlc b2ro b2rn 2018-12-01 2018-12-21 mars -vars="O3,NH3"
#
#   # Multiple variables with mixed syntax
#   qlc b2ro b2rn 2018-12-01 2018-12-21 mars -vars="pl:O3,go3,NH3,sfc:PM2.5"
#
#   # Variable group
#   qlc b2ro b2rn 2018-12-01 2018-12-21 mars -vars=@MARS_Test
#
# Note: The parser intelligently distinguishes between:
#   - "O3,NH3" = two variables (both are standalone variable names)
#   - "O3,go3" = one variable with rename (go3 is IFS lookup name)
#   - "O3,210203" = one variable with rename (210203 is GRIB param ID)
#
# VARIABLE DISCOVERY:
#
# Search for available variables:
#   qlc-vars search o3
#   qlc-vars info  go3
#   qlc-vars list --source ifs
#   qlc-vars list --source airnow
#   qlc-vars validate ~/qlc/config/workflows/mars/qlc_mars.conf
#
# For documentation, see:
#   Quick Start:  ~/qlc/doc/QuickStart.md
#   Online Docs:  https://docs.researchconcepts.io/qlc/latest/
#----------------------------------------------------------------------

#----------------------------------------------------------------------
# Stop bash sourcing here - Python INI sections follow
#----------------------------------------------------------------------
return 0

# ============================================================================
# Python INI Sections (parsed by VariableRegistry, not bash)
# ============================================================================
# These sections override the global qlc.conf to ensure ONLY MARS_RETRIEVALS
# is used for this workflow. Do not inherit predefined variables from global config.

#======================================================================
# VARIABLE REGISTRY (Optional)
#======================================================================
# NEW v1.0.1: Most variables auto-resolve from tables, so registry is OPTIONAL
#
# BEST PRACTICE: Keep this section EMPTY to use automatic table lookup
# 
# Only define explicit mappings here when you need to:
# 1. Override default table resolution (e.g., O3 → go3 instead of O3 → o3)
# 2. Specify exact GRIB parameter ID (e.g., O3,210203)
# 3. Add custom description (e.g., O3,210203,Custom description)
#
# Format: display_name,lookup_name[,description]
# Examples:
#   O3,go3                           # Force O3 to use go3 (full chemistry) instead of o3
#   O3,210203                        # Force O3 to use GRIB param 210203 explicitly
#   pl:O3,210203,Full chem ozone     # Pressure level with custom description
#
# WARNING: Explicit entries here override automatic table resolution!
# If you define "O3,go3" here, then MARS_RETRIEVALS=("O3") will always use go3.
# If you want automatic resolution, keep this section empty.
#----------------------------------------------------------------------

[VARIABLE_REGISTRY]

# Examples (commented out - use automatic table lookup instead):
# sfc_O3,gtco3,Total column ozone - [kg m-2]
# pl_O3,go3,Ozone mass mixing ratio (full chemistry scheme) - [kg kg-1]
# pl_NO2,no2,Nitrogen dioxide mass mixing ratio - [kg kg-1]

#----------------------------------------------------------------------
# END OF VARIABLE REGISTRY
#----------------------------------------------------------------------

#----------------------------------------------------------------------
# VARIABLE GROUPS
#----------------------------------------------------------------------
# NEW v1.0.1: Define reusable groups with SIMPLE SYNTAX
#
# Format: GROUP_NAME=var1,var2,var3
#
# Use simple variable names - they auto-resolve from IFS tables
# Prefix with @ to use groups: MARS_RETRIEVALS=("@TEST_SFC" "@TEST_PL")
#
# TWO SYNTAX OPTIONS:
#
# 1. EXPLICIT SEPARATOR (semicolons):
#    Use semicolons (;) to explicitly separate variables, commas for rename syntax
#    MARS_Test=O3,210203;NH3,19.217    # Two variables with GRIB param rename
#    MARS_Test=O3,go3;pl:NH3;NH4_as     # Three variables (first with rename)
#
# 2. SMART COMMA PARSING (no semicolons):
#    Parser intelligently detects rename syntax vs separators:
#    MARS_Test=O3,NH3                   # Two simple variables (comma = separator)
#    MARS_Test=O3,go3                   # One variable with rename (comma = rename)
#    MARS_Test=O3,go3,NH3               # Mixed: first renamed, second simple
#----------------------------------------------------------------------

# RECOMMENDATION: Use semicolons for clarity when using rename syntax with GRIB params
# Examples:
#   MARS_Test=O3,go3;NH3,nh3           # Clear: O3→go3, NH3→nh3 (IFS names)
#   MARS_Test=O3,210203;NH3,217019     # Clear: both have GRIB param rename
#   MARS_Test=sfc:O3,go3;pl:NH3        # Clear: different levels with rename
#
# NOTE: To find correct GRIB parameters, use:
#   qlc-vars info go3    # Shows: GRIB Parameter: 210203
#   qlc-vars search nh3  # Lists all NH3-related variables with GRIB params
#
# Found 18 variables matching 'nh3':
# 
# Variable ID               Source               Param/GRIB      Unit            Description
# ==============================================================================================================
# nh3fire                   ifs                  210116          kg m-2 s-1      Wildfire Flux of Ammonia (NH3)
# nh3                       ifs                  217019          kg kg-1         Ammonia mass mixing ratio
#
# Correct GRIB parameters from IFS table:
# go3  = 210203 (ozone, full chemistry)
# nh3  = 217019 (ammonia)
# Use IFS native names or correct GRIB params:
# MARS_VARS=pl:O3,210203;NH3,217019   # Alternative: GRIB parameter IDs
#----------------------------------------------------------------------

[VARIABLE_GROUPS]

# Example Groups
#MARS_SFC=O3,go3;NO2;SO2;CO;PM2.5;PM10;AOD
#MARS_PL=pl:NH3,nh3;pl:HNO3,hno3;pl:CO;pl:NO2;pl:SO2

# Aerosol Core Groups (sfc default)
#MARS_AEROSOL=PM1;PM2.5;PM10;AOD;dust_025;dust_05;dust_2;sea_salt;organic_matter;black_carbon

# Gas Phase Chemistry (sfc default)
#MARS_GASES=O3,go3;NO;NO2;CO;SO2;HNO3;NH3;PAN

# Quick Test Set (sfc is default; pl and ml must be provided, either by ':' or '_')
#MARS_VARS=NH4_as,nh4;pl:NH3,nh3
MARS_VARS=NH4_as,210249;pl:NH3,nh3

#----------------------------------------------------------------------
# END OF VARIABLE GROUPS
#----------------------------------------------------------------------

#----------------------------------------------------------------------
# MARS DEFAULTS (Override global settings from qlc.conf)
#----------------------------------------------------------------------
# These parameters control MARS retrievals in A1-MARS script
# See: https://confluence.ecmwf.int/display/UDOC/MARS+keywords
#----------------------------------------------------------------------

[MARS_DEFAULTS]
# If empty - inherit from global qlc.conf

# Basic MARS parameters
CLASS=rd            # Model class (rd=default)
TYPE=fc             # Type (fc=forecast)
STREAM=oper         # Stream (oper=operational)
GRID=0.50/0.50      # Grid resolution (0.50 degrees)

# Timing
TIME=00             # Initialization time (00 UTC)

# Vertical levels
PL_LEVELIST=10/50/100/150/200/400/700/850/925/1000
#PL_LEVELIST=1000    # Pressure level (1000 hPa = surface)
#ML_LEVELIST=137     # Model level (137 = surface in ECMWF L137)

# Forecast steps (Caution with step > 21/by/3, grib recommended for timeseries analysis)
#STEP_SFC=0/to/21/by/3 
#STEP_PL=0/to/21/by/3
#STEP_ML=0/to/21/by/3 

STEP_SFC=12/24
STEP_PL=12

#----------------------------------------------------------------------
# END OF MARS DEFAULTS
#----------------------------------------------------------------------

#======================================================================
# END OF CONFIGURATION
#======================================================================

# ============================================================================
# QLC AIFS WORKFLOW
# ============================================================================
# Part of QLC (Quick Look Content) v1.0.1-beta
# An Automated Model-Observation Comparison Suite Optimized for CAMS
#
# Documentation:
#   - Online Docs:   https://docs.researchconcepts.io/qlc/latest/
#   - Workflows:     https://docs.researchconcepts.io/qlc/latest/user-guide/workflows/
#   - Variables:     https://docs.researchconcepts.io/qlc/latest/user-guide/variable-system/
#   - Configuration: https://docs.researchconcepts.io/qlc/latest/user-guide/configuration/
#
# Workflow Description:
#   Production-ready configuration for AIFS (AI-Integrated Forecasting System)
#   global 3D and station analysis. Includes PyFerret 3D visualization,
#   qlc-py station analysis, and evaltools statistical evaluation.
#
# New in v1.0.1-beta:
#   - Table-driven variable mapping (7,855 variables available)
#   - Simplified variable syntax (O3 instead of sfc_O3,203.210,...)
#   - GHOST network integration (7 networks, 282 variables)
#   - CSV observation support (AMoN, CastNet, NNDMN)
#   - Native GRIB support with forecast step preservation
#   - Enhanced CLI with named arguments and mode flags
#
# Usage:
#   qlc <exp1> [exp2 ...] <start_date> <end_date> aifs
#   Example: qlc 9191 0001 2025-11-01 2025-11-03 aifs
#
# Validation:
#   qlc-vars validate ~/qlc/config/workflows/aifs/qlc_aifs.conf
#
# Copyright (c) 2018-2025 ResearchConcepts io GmbH. All Rights Reserved.
# Questions/Comments: qlc Team @ ResearchConcepts io GmbH <qlc@researchconcepts.io>
# ============================================================================
#----------------------- FULL TASK CONFIGURATION -------------
#----------------------------------------------------------------------
# AIFS     : AI-Integrated Forecasting System
# QLC-PY   : The qlc-python package developed by ResearchConcepts Io GmbH
# Evaltools: The evaltools package from CNRS and Météo-France
# PyFerret : The PyFerret program and Python module from NOAA/PMEL
#
# References:
#   - AIFS             : https://www.ecmwf.int/en/newsletter/178/news/aifs-new-ecmwf-forecasting-system
#   - Evaltools        : https://redmine.umr-cnrm.fr/projects/evaltools/wiki
#   - PyFerret Website : https://ferret.pmel.noaa.gov/Ferret/
#   - QLC Documentation: https://docs.researchconcepts.io/qlc/latest/advanced/test/
#
# This configuration is loaded when running: qlc ... aifs
#----------------------------------------------------------------------
# Workflow:
#   1. Run A1-MARS script to retrieve grib data (mars task)
#   2. Run B1-CONV script to convert grib to netcdf data (cdo task)
#   3. Run B2-PREP script to rename and time average netcdf variables (cdo task)
#   4. Run C1-GLOB script to plot 3D analysis, surface, burden, zonal, meridional, UTLS (pyFerrert task)
#   5. Run D1-ANAL script to create and plot collocated station data (qlc-py task)
#   6. Run E1-ECOL script to create evaluators from qlc-py collocation (evaltools task)
#   7. Run E2-EVAL script to generate evaltools plots from evaluators  (evaltools task)
#   8. Run Z1-XPDF script to generate final presentation(s) PDF (tex task)
#----------------------------------------------------------------------
# VARIABLE SPECIFICATION:
#   Variables are defined in MARS_RETRIEVALS below
#   Uses table-driven system with 7,000+ IFS parameters
#   No need for manual parameter mapping
#
# DATA RETRIEVAL BEHAVIOR:
#   - Auto-generates MARS request files from MARS_RETRIEVALS
#   - Checks data_retrieved_*.flag files; only retrieves if missing
#   - Creates .flag after successful MARS submission
#
# TO FORCE RE-RETRIEVAL:
#   rm ~/qlc/Results/<exp>/data_retrieved_<exp>_<dates>_<var>.flag
#----------------------------------------------------------------------
# Usage Examples:
#   cd ~/qlc/run
#   qlc 9191 0001 2025-11-01 2025-11-07 aifs  # bash  processing (interactive)
#  sqlc 9191 0001 2025-11-01 2025-11-07 aifs  # batch processing (automatic)
# Note: Use command line override if needed to match exp class (default=rd)
#  sqlc 9191 0001 2025-11-01 2025-11-07 aifs -class=nl,nl
#  sqlc 9191 0001 2025-11-01 2025-11-07 aifs -class=nl,nl -obs-only
#  sqlc 9191 0001 2025-11-01 2025-11-07 aifs -class=nl,nl -mod-only
#----------------------------------------------------------------------

#----------------------------------------------------------------------
# Source qlc.conf base configuration and common functions
#----------------------------------------------------------------------
[ -f "$HOME/qlc/config/qlc.conf" ] && source "$HOME/qlc/config/qlc.conf" || {
    echo "[$(date +"%Y-%m-%d %H:%M:%S")] [ERROR] Base config not found: $HOME/qlc/config/qlc.conf" >&2
    exit 1
}
#----------------------------------------------------------------------
# Run-time definitions - Control which scripts to execute
#----------------------------------------------------------------------
# Full workflow: MARS retrieval → Conversion → Global plots → Analysis → Evaluation → PDF
SUBSCRIPT_NAMES=("A1-MARS" "B1-CONV" "B2-PREP" "C1-GLOB" "D1-ANAL" "E1-ECOL" "E2-EVAL" "Z1-XPDF")

# Common workflows (comment out full workflow above, uncomment one below):
#SUBSCRIPT_NAMES=("A1-MARS" "B1-CONV" "B2-PREP" "C1-GLOB" "D1-ANAL" "Z1-XPDF")  # Without evaltools
#SUBSCRIPT_NAMES=("D1-ANAL" "E1-ECOL" "E2-EVAL" "Z1-XPDF")  # Analysis with evaltools (requires data)
#SUBSCRIPT_NAMES=("D1-ANAL" "Z1-XPDF")  # Quick analysis only
#SUBSCRIPT_NAMES=("D1-ANAL")  # Analysis only (no PDF)

# Individual scripts (for debugging or selective processing):
#SUBSCRIPT_NAMES=("A1-MARS")  # Data retrieval only
#SUBSCRIPT_NAMES=("B1-CONV")  # GRIB to NetCDF conversion only
#SUBSCRIPT_NAMES=("B2-PREP")  # NetCDF preparation only
#SUBSCRIPT_NAMES=("C1-GLOB")  # Global plots only
#SUBSCRIPT_NAMES=("E1-ECOL")  # Create evaltools evaluators
#SUBSCRIPT_NAMES=("E2-EVAL")  # Run evaltools plots

#----------------------------------------------------------------------
# Global MARS Retrievals - NEW v1.0.1 SIMPLIFIED SYNTAX
#----------------------------------------------------------------------
# Defines which model variables should be retrieved from MARS
#
# SYNTAX OPTIONS:
#
# 1. Simple variable name (auto-resolves to sfc by default):
#    MARS_RETRIEVALS=("go3" "NH3" "PM2.5")
#
# 2. With explicit level type:
#    MARS_RETRIEVALS=("pl:NH3" "sfc:NH4_as")
#
# 3. With underscore notation (levtype_varname):
#    MARS_RETRIEVALS=("sfc_go3" "pl_NH3")
#
# 4. Using variable groups (RECOMMENDED):
#    MARS_RETRIEVALS=("@AIFS_SFC" "@AIFS_PL")
#    Define groups in [VARIABLE_GROUPS] section below
#
# 5. Rename syntax (display_name,lookup_name):
#    Retrieves lookup_name, displays as display_name in plots
#    MARS_RETRIEVALS=("O3,go3")               # Retrieve go3, display as O3 (sfc default)
#    MARS_RETRIEVALS=("pl:O3,go3")            # Retrieve go3, display as O3 (pl level)
#    MARS_RETRIEVALS=("O3,210203")            # Retrieve GRIB 210203, display as O3
#
# 6. Legacy format (still supported - backward compatible):
#    MARS_RETRIEVALS=("sfc_O3,210203,Ozone mass mixing ratio")
#
# NOTE: For groups with multiple renamed variables, use semicolons to separate:
#    [VARIABLE_GROUPS]
#    AIFS_Test=O3,210203;NH3,217019   # Semicolon separates variables
#
# VARIABLE DISCOVERY TOOLS:
#   qlc-vars search ozone              # Find all ozone-related variables
#   qlc-vars info go3                  # Get detailed variable information
#   qlc-vars list --source ifs         # List all IFS variables
#   qlc-vars list --source airnow      # List AirNow variables
#   qlc-vars validate <this_config>    # Validate configuration
#
# EXAMPLES:
#MARS_RETRIEVALS=("O3,go3" "PM2.5" "NO2")  # Simple syntax with rename
#MARS_RETRIEVALS=("pl:O3,210203")          # With GRIB parameter ID
#MARS_RETRIEVALS=("@AIFS_SFC")             # Use variable group (recommended)
MARS_RETRIEVALS=("@AIFS_VARS") 
#----------------------------------------------------------------------
# Command Examples (AIFS data available from June 2025 onwards)
#----------------------------------------------------------------------
# Terminal execution (interactive):
#   qlc 9191 0001 2025-11-01 2025-11-07 aifs
#   qlc 9191 0001 2025-11-01 2025-11-07 aifs --station_selection=<csv>
#
# Batch job with SLURM:
#   sqlc 9191 0001 2025-11-01 2025-11-07 aifs
#
# Single experiment (comparison with observations):
#   sqlc 9191 None 2025-11-01 2025-11-07 aifs
#
# Observation-only analysis (no model):
#   sqlc None None 2025-11-01 2025-11-07 aifs --obs-only
#   sqlc 9191 0001 2025-11-01 2025-11-07 aifs --obs-only
#
# Model-only analysis (no observations):
#   sqlc 9191 0001 2025-11-01 2025-11-07 aifs --mod-only
#
# With command-line variable override:
#   sqlc 9191 0001 2025-11-01 2025-11-07 aifs -vars="O3,go3,PM2.5"
#   sqlc 9191 0001 2025-11-01 2025-11-07 aifs -vars=@AIFS_Test

#----------------------------------------------------------------------
# Override global defaults from qlc.conf
#----------------------------------------------------------------------
# Vertical range definitions (override defaults from qlc.conf if needed)
# Default: PL_VRANGE="100,300,UTLS" and ML_VRANGE="35,55,UTLS"
# Uncomment to override: PL_VRANGE="100,300,UTLS" or ML_VRANGE="35,55,UTLS"
PL_VRANGE="100,300,UTLS"         # For C1-GLOB: Vertical range definitions 
#----------------------------------------------------------------------
PFILL="shaded"                   # For C1-GLOB: fill or shaded (C1-GLOB plots only)
MODEL_RESOLUTION="O1280L137"     # For Z1-XPDF: pdf only (final PDF report)
PLOTEXTENSION="png"              # For C1-GLOB/D1-ANAL: png (smaller) or pdf (higher quality)
#----------------------------------------------------------------------
# For D1-ANAL: Common settings (apply to all regions)
#----------------------------------------------------------------------
# Model information
MODEL="AIFS-COMPO"
EXP_LABELS="AIFS-COMPO,o-Suite"  # Comma-separated labels for plot legends for the experiments, in the same order (leave empty to use exp IDs)

# Analysis parameters
MODEL_LEVEL=""                   # Leave empty for automatic surface level detection
STATION_RADIUS_DEG=0.5           # Search radius for model points around stations
USE_UNIFORM_TIME_GRID=false      # Preserve actual timestamps (not gap-filled grid)

# Plot types to generate
PLOT_TYPE="map"
#PLOT_TYPE="map,burden,zonal,meridional,scatter,taylor"  # All plot types

# Time averaging
TIME_AVERAGE="3hourly"
#TIME_AVERAGE="raw,3hourly,daily"  # Multiple time averages

# Unit conversion for collocation
# NEW v1.0.1: Converts both obs and model to specified unit
UNIT_TO="ug/m3"
#UNIT_TO="ppb"  # Alternative: parts per billion

# Interpolation methods
# NOTE: Non-default spatial methods currently under development
SPATIAL_INTERP_METHOD="nearest"   # nearest (default), linear, cubic
#TEMPORAL_INTERP_METHOD="linear"  # UNDER DEVELOPMENT - leave commented

# Processing options
MULTIPROCESSING=false             # Set to true for parallel processing (requires plugin)
N_THREADS=1                       # Number of threads if multiprocessing enabled (in case of run-time errors set to 1)
DEBUG=false                       # Enable debug output
DEBUG_EXTENDED=false              # Enable extended diagnostics
#----------------------------------------------------------------------
# GRIB File Source Control
#----------------------------------------------------------------------
# Use GRIB files directly from Results directory instead of NetCDF from Analysis
# 
# If true:  reads .grb files from ~/qlc/Results/exp/ (preserves forecast step dimension)
# If false: reads .nc files from ~/qlc/Analysis/exp/ (default, requires B1-CONV conversion)
#
# Note: cfgrib and eccodes are automatically installed
USE_GRIB_SOURCE=true
#----------------------------------------------------------------------
# Data Processing Control Flags
#----------------------------------------------------------------------
# These flags control what data is loaded and processed (independent of visualization)
#
# Modes:
#   Obs-only:     use_obs=true,  use_mod=false, use_com=false
#   Mod-only:     use_obs=false, use_mod=true,  use_com=false  
#   Collocation:  use_obs=true,  use_mod=true,  use_com=true
#
# Visualization flags (default: false for all)
SHOW_STATION_TIMESERIES_OBS=true   # Plot observation time series
SHOW_STATION_TIMESERIES_MOD=true   # Plot model time series
SHOW_STATION_TIMESERIES_COM=true   # Plot collocation comparison time series

# Note: Data files are generated even if all show_* flags are false
# This allows downstream processing in E1-ECOL/E2-EVAL

#----------------------------------------------------------------------
# Plot settings
#----------------------------------------------------------------------
# Station settings
STATION_NETWORK=""               # Filter by network (empty = all)
STATION_SUFFIX=""                # Suffix for station names
STATION_TYPE="concentration"     # Type of data (concentration, deposition)
SHOW_STATIONS=true               # Show individual station plots
PLOT_MODE="grouped"              # grouped or individual
STATION_PLOT_GROUP_SIZE=5        # Stations per grouped plot
SHOW_MIN_MAX=true                # Show min/max values on time series
LOG_Y_AXIS=false                 # Use logarithmic y-axis
FIX_Y_AXIS=true                  # Fix y-axis range across plots
FORCE_FULL_YEAR=false            # Force full year display
SHOW_STATION_MAP=true            # Show station location map

# Output formats
SAVE_PLOT_FORMAT=$PLOTEXTENSION  # Plot format (png, pdf, or both)
SAVE_DATA_FORMAT="nc"            # Collocation files Data format (nc or csv)
READ_DATA_FORMAT=$SAVE_DATA_FORMAT # Data format (nc or csv)
LAZY_LOAD_NC=true                # Memory-efficient NetCDF loading

# Map settings
MAP_COLORMAP="turbo"             # turbo, viridis, plasma
MAP_COLORMAP_DIFF="RdBu_r"       # Difference plot colormap
ENABLE_DIFF_PLOTS=false          # Enable difference plots
USE_LOG_SCALE=false              # Use logarithmic color scale
USE_NORMALIZED_SCALE=false       # Normalize color scale
MAP_SHOW_STATS=true              # Show statistics on maps
MAP_PROJECTION="Robinson"        # Global map projection (Robinson, PlateCarree, EqualEarth)
PUBLICATION_STYLE=true           # Use publication-ready styling (higher quality, slower)
PLOT_DPI=""                      # DPI for plots (empty=auto, 100=fast, 150=balanced, 300+=publication)

#======================================================================
# MULTI-REGION CONFIGURATION
#======================================================================
# Enable multi-region mode for processing multiple regions in one execution
#
# v1.0.1: Supports 16 observation networks:
#   Standard: airnow, ebas_hourly, ebas_daily, airbase, castnet, amon
#   GHOST: ghost_harmonized, ghost-aqs, ghost-ebas, ghost-airbase, 
#          ghost-castnet, ghost-naps, ghost-uk_air
#   CSV: AMoN, CastNet, NNDMN
#----------------------------------------------------------------------
TEX_FILE_MODE="per_region"         # TeX file generation mode: "combined" or "per_region"
#----------------------------------------------------------------------
MULTI_REGION_MODE=true

# Define which regions to process (GHOST data sets require testing)
#ACTIVE_REGIONS=("US_AIRNOW" "EU_EBAS_HOURLY" "EU_EBAS_Daily" "GLOBE_GHOST_HARMONIZED")
#ACTIVE_REGIONS=("EU_EBAS_Daily" "US_CASTNET" "US_AMON" "US_AIRNOW" "China_AQ")

# Currently only AirNow has near real-time data (dates for e.g: 2025-11)
#ACTIVE_REGIONS=("US_AIRNOW_URBAN" "US_AIRNOW_RURAL" "GLOBE_AIRNOW")
ACTIVE_REGIONS=("US_AIRNOW")

#----------------------------------------------------------------------
# REGION: United States - AirNow (Real-time air quality)
#----------------------------------------------------------------------
REGION_US_AIRNOW_NAME="US_AIRNOW"
REGION_US_AIRNOW_OBS_PATH="${QLC_HOME}/obs/data/ver0d"
REGION_US_AIRNOW_OBS_DATASET_TYPE="airnow"
REGION_US_AIRNOW_OBS_DATASET_VERSION="latest"
REGION_US_AIRNOW_STATION_FILE="${QLC_HOME}/config/station_locations/AirNow_stations-all.csv"
REGION_US_AIRNOW_PLOT_REGION="US"
REGION_US_AIRNOW_STATION_RADIUS_DEG=0.5
#REGION_US_AIRNOW_VARIABLES="O3,PM2.5,PM10,NO2,SO2"  # Optional: Override global MARS_RETRIEVALS

#----------------------------------------------------------------------
# REGION: United States - AirNow Urban Stations
#----------------------------------------------------------------------
REGION_US_AIRNOW_URBAN_NAME="US_AIRNOW_URBAN"
REGION_US_AIRNOW_URBAN_OBS_PATH="${QLC_HOME}/obs/data/ver0d"
REGION_US_AIRNOW_URBAN_OBS_DATASET_TYPE="airnow"
REGION_US_AIRNOW_URBAN_OBS_DATASET_VERSION="latest"
REGION_US_AIRNOW_URBAN_STATION_FILE="${QLC_HOME}/config/station_locations/AirNow_stations-urban.csv"
REGION_US_AIRNOW_URBAN_PLOT_REGION="US"
REGION_US_AIRNOW_URBAN_STATION_RADIUS_DEG=0.5

#----------------------------------------------------------------------
# REGION: United States - AirNow Rural Stations
#----------------------------------------------------------------------
REGION_US_AIRNOW_RURAL_NAME="US_AIRNOW_RURAL"
REGION_US_AIRNOW_RURAL_OBS_PATH="${QLC_HOME}/obs/data/ver0d"
REGION_US_AIRNOW_RURAL_OBS_DATASET_TYPE="airnow"
REGION_US_AIRNOW_RURAL_OBS_DATASET_VERSION="latest"
REGION_US_AIRNOW_RURAL_STATION_FILE="${QLC_HOME}/config/station_locations/AirNow_stations-rural.csv"
REGION_US_AIRNOW_RURAL_PLOT_REGION="US"
REGION_US_AIRNOW_RURAL_STATION_RADIUS_DEG=0.5

#----------------------------------------------------------------------
# REGION: Globe - AirNow (Real-time air quality)
#----------------------------------------------------------------------
REGION_GLOBE_AIRNOW_NAME="GLOBE_AIRNOW"
REGION_GLOBE_AIRNOW_OBS_PATH="${QLC_HOME}/obs/data/ver0d"
REGION_GLOBE_AIRNOW_OBS_DATASET_TYPE="airnow"
REGION_GLOBE_AIRNOW_OBS_DATASET_VERSION="latest"
REGION_GLOBE_AIRNOW_STATION_FILE="${QLC_HOME}/config/station_locations/AirNow_stations-test.csv"
REGION_GLOBE_AIRNOW_PLOT_REGION="Globe"
REGION_GLOBE_AIRNOW_STATION_RADIUS_DEG=0.5

#----------------------------------------------------------------------
# REGION: Europe - EBAS Hourly
#----------------------------------------------------------------------
# European monitoring network with comprehensive species coverage
REGION_EU_EBAS_HOURLY_NAME="EU_EBAS_HOURLY"
REGION_EU_EBAS_HOURLY_OBS_PATH="${QLC_HOME}/obs/data/ver0d"
REGION_EU_EBAS_HOURLY_OBS_DATASET_TYPE="ebas_hourly"
REGION_EU_EBAS_HOURLY_OBS_DATASET_VERSION="latest"
REGION_EU_EBAS_HOURLY_STATION_FILE="${QLC_HOME}/config/station_locations/Ebas_hourly_stations-all.csv"
#REGION_EU_EBAS_HOURLY_STATION_FILE="${QLC_HOME}/config/station_locations/Ebas_hourly_stations-rural.csv"
#REGION_EU_EBAS_HOURLY_STATION_FILE="${QLC_HOME}/config/station_locations/Ebas_hourly_stations-urban.csv"
#REGION_EU_EBAS_HOURLY_STATION_FILE="${QLC_HOME}/config/station_locations/Ebas_hourly_stations-test.csv"
REGION_EU_EBAS_HOURLY_PLOT_REGION="EU"
REGION_EU_EBAS_HOURLY_STATION_RADIUS_DEG=0.5

#----------------------------------------------------------------------
# REGION: Europe - EBAS Daily
#----------------------------------------------------------------------
# European monitoring network with comprehensive species coverage
REGION_EU_EBAS_Daily_NAME="EU_EBAS_Daily"
REGION_EU_EBAS_Daily_OBS_PATH="${QLC_HOME}/obs/data/ver0d"
REGION_EU_EBAS_Daily_OBS_DATASET_TYPE="ebas_daily"
REGION_EU_EBAS_Daily_OBS_DATASET_VERSION="latest"
REGION_EU_EBAS_Daily_STATION_FILE="${QLC_HOME}/config/station_locations/Ebas_daily_stations-all.csv"
#REGION_EU_EBAS_Daily_STATION_FILE="${QLC_HOME}/config/station_locations/Ebas_daily_stations-rural.csv"
#REGION_EU_EBAS_Daily_STATION_FILE="${QLC_HOME}/config/station_locations/Ebas_daily_stations-urban.csv"
#REGION_EU_EBAS_Daily_STATION_FILE="${QLC_HOME}/config/station_locations/Ebas_daily_stations-test.csv"
REGION_EU_EBAS_Daily_PLOT_REGION="EU"
REGION_EU_EBAS_Daily_STATION_RADIUS_DEG=0.5

#----------------------------------------------------------------------
# REGION: Global - GHOST Harmonized Network (NEW v1.0.1)
#----------------------------------------------------------------------
# Main GHOST network with 200+ aerosol optical property variables
# Includes: absorption/scattering coefficients, PM1/PM2.5/PM10 properties,
#           precipitation chemistry, wet deposition, Angstrom exponents
#
# Reference: Bowdalo et al. (2024), https://doi.org/10.5194/essd-16-4417-2024
#
# BEFORE USING: Extract GHOST data first:
#   bash ~/qlc/bin/tools/qlc_extract_all_ghost_networks.sh
#   qlc-extract-stations --obs-type ghost_harmonized --output ghost_harmonized_stations-all.csv
#
REGION_GLOBE_GHOST_HARMONIZED_NAME="GLOBE_GHOST_HARMONIZED"
REGION_GLOBE_GHOST_HARMONIZED_OBS_PATH="${QLC_HOME}/obs/data/ghost"
REGION_GLOBE_GHOST_HARMONIZED_OBS_DATASET_TYPE="ghost_harmonized"
REGION_GLOBE_GHOST_HARMONIZED_OBS_DATASET_VERSION="latest"
REGION_GLOBE_GHOST_HARMONIZED_STATION_FILE="${QLC_HOME}/config/station_locations/ghost_harmonized_stations-all.csv"
REGION_GLOBE_GHOST_HARMONIZED_PLOT_REGION="Globe"
REGION_GLOBE_GHOST_HARMONIZED_STATION_RADIUS_DEG=0.5
#REGION_GLOBE_GHOST_HARMONIZED_VARIABLES="absco550,sca550aero,od550aero"  # Optional override

#----------------------------------------------------------------------
# REGION: United States - GHOST AQS (NEW v1.0.1)
#----------------------------------------------------------------------
# GHOST-standardized US EPA Air Quality System data (43 variables)
REGION_US_GHOST_AQS_NAME="US_GHOST_AQS"
REGION_US_GHOST_AQS_OBS_PATH="${QLC_HOME}/obs/data/ghost"
REGION_US_GHOST_AQS_OBS_DATASET_TYPE="ghost-aqs"
REGION_US_GHOST_AQS_OBS_DATASET_VERSION="latest"
REGION_US_GHOST_AQS_STATION_FILE="${QLC_HOME}/config/station_locations/ghost-aqs_stations-all.csv"
REGION_US_GHOST_AQS_PLOT_REGION="US"
REGION_US_GHOST_AQS_STATION_RADIUS_DEG=0.5

#----------------------------------------------------------------------
# REGION: Europe - GHOST EBAS (NEW v1.0.1)
#----------------------------------------------------------------------
# GHOST-standardized European EBAS data (89 variables, combines 12 sub-networks)
REGION_EU_GHOST_EBAS_NAME="EU_GHOST_EBAS"
REGION_EU_GHOST_EBAS_OBS_PATH="${QLC_HOME}/obs/data/ghost"
REGION_EU_GHOST_EBAS_OBS_DATASET_TYPE="ghost-ebas"
REGION_EU_GHOST_EBAS_OBS_DATASET_VERSION="latest"
REGION_EU_GHOST_EBAS_STATION_FILE="${QLC_HOME}/config/station_locations/ghost-ebas_stations-all.csv"
REGION_EU_GHOST_EBAS_PLOT_REGION="EU"
REGION_EU_GHOST_EBAS_STATION_RADIUS_DEG=0.5

#----------------------------------------------------------------------
# REGION: United States - AMoN (Ammonia Monitoring Network) (NEW v1.0.1)
#----------------------------------------------------------------------
# CSV-based observation network
REGION_US_AMON_NAME="US_AMON"
REGION_US_AMON_OBS_PATH="${QLC_HOME}/obs/data"
REGION_US_AMON_OBS_DATASET_TYPE="AMoN"
REGION_US_AMON_OBS_DATASET_VERSION="latest"
REGION_US_AMON_STATION_FILE="${QLC_HOME}/config/station_locations/AMoN_stations-all.csv"
REGION_US_AMON_PLOT_REGION="US"
REGION_US_AMON_STATION_RADIUS_DEG=0.5
#REGION_US_AMON_VARIABLES="NH3"  # AMoN focuses on ammonia

#----------------------------------------------------------------------
# REGION: United States - CastNet (Clean Air Status and Trends) (NEW v1.0.1)
#----------------------------------------------------------------------
# CSV-based observation network
REGION_US_CASTNET_CSV_NAME="US_CASTNET_CSV"
REGION_US_CASTNET_CSV_OBS_PATH="${QLC_HOME}/obs/data"
REGION_US_CASTNET_CSV_OBS_DATASET_TYPE="CastNet"
REGION_US_CASTNET_CSV_OBS_DATASET_VERSION="latest"
REGION_US_CASTNET_CSV_STATION_FILE="${QLC_HOME}/config/station_locations/CastNet_stations-all.csv"
REGION_US_CASTNET_CSV_PLOT_REGION="US"
REGION_US_CASTNET_CSV_STATION_RADIUS_DEG=0.5
#REGION_US_CASTNET_CSV_VARIABLES="SO2,SO4,NO3,HNO3,NH4"

#----------------------------------------------------------------------
# Additional GHOST Networks Available (uncomment to use)
#----------------------------------------------------------------------
# See docs.researchconcepts.io/qlc/latest/advanced/ghost-integration/ for complete list
#
# REGION_CANADA_GHOST_NAPS_NAME="CANADA_GHOST_NAPS"
# REGION_CANADA_GHOST_NAPS_OBS_PATH="${QLC_HOME}/obs/data/ghost"
# REGION_CANADA_GHOST_NAPS_OBS_DATASET_TYPE="ghost-naps"
# REGION_CANADA_GHOST_NAPS_OBS_DATASET_VERSION="v_20251206"
# REGION_CANADA_GHOST_NAPS_STATION_FILE="${QLC_HOME}/config/station_locations/ghost-naps_stations-all.csv"
# REGION_CANADA_GHOST_NAPS_PLOT_REGION="Canada"
# REGION_CANADA_GHOST_NAPS_STATION_RADIUS_DEG=0.5
#
# REGION_UK_GHOST_AIR_NAME="UK_GHOST_AIR"
# REGION_UK_GHOST_AIR_OBS_PATH="${QLC_HOME}/obs/data/ghost"
# REGION_UK_GHOST_AIR_OBS_DATASET_TYPE="ghost-uk_air"
# REGION_UK_GHOST_AIR_OBS_DATASET_VERSION="v_20251206"
# REGION_UK_GHOST_AIR_STATION_FILE="${QLC_HOME}/config/station_locations/ghost-uk_air_stations-all.csv"
# REGION_UK_GHOST_AIR_PLOT_REGION="UK"
# REGION_UK_GHOST_AIR_STATION_RADIUS_DEG=0.5

#----------------------------------------------------------------------
# Stop bash sourcing here - Python INI sections follow
#----------------------------------------------------------------------
return 0

# ============================================================================
# Python INI Sections (parsed by VariableRegistry, not bash)
# ============================================================================
# These sections override the global qlc.conf to ensure ONLY MARS_RETRIEVALS
# is used for this workflow. Do not inherit predefined variables from global config.

#======================================================================
# VARIABLE REGISTRY (Optional)
#======================================================================
# NEW v1.0.1: Most variables auto-resolve from tables, so registry is OPTIONAL
#
# BEST PRACTICE: Keep this section EMPTY to use automatic table lookup
# 
# Only define explicit mappings here when you need to:
# 1. Override default table resolution (e.g., O3 → go3 instead of O3 → o3)
# 2. Specify exact GRIB parameter ID (e.g., O3,210203)
# 3. Add custom description (e.g., O3,210203,Custom description)
#
# Format: display_name,lookup_name[,description]
# Examples:
#   O3,go3                           # Force O3 to use go3 (full chemistry) instead of o3
#   O3,210203                        # Force O3 to use GRIB param 210203 explicitly
#   pl:O3,210203,Full chem ozone     # Pressure level with custom description
#
# WARNING: Explicit entries here override automatic table resolution!
# If you define "O3,go3" here, then MARS_RETRIEVALS=("O3") will always use go3.
# If you want automatic resolution, keep this section empty.
#----------------------------------------------------------------------

[VARIABLE_REGISTRY]

# Examples (commented out - use automatic table lookup instead):
# sfc_O3,gtco3,Total column ozone - [kg m-2]
# pl_O3,go3,Ozone mass mixing ratio (full chemistry scheme) - [kg kg-1]
# pl_NO2,no2,Nitrogen dioxide mass mixing ratio - [kg kg-1]

#----------------------------------------------------------------------
# END OF VARIABLE REGISTRY
#----------------------------------------------------------------------

#----------------------------------------------------------------------
# VARIABLE GROUPS
#----------------------------------------------------------------------
# NEW v1.0.1: Define reusable groups with SIMPLE SYNTAX
#
# Format: GROUP_NAME=var1,var2,var3
#
# Use simple variable names - they auto-resolve from IFS tables
# Prefix with @ to use groups: MARS_RETRIEVALS=("@AIFS_SFC" "@AIFS_PL")
#
# TWO SYNTAX OPTIONS:
#
# 1. EXPLICIT SEPARATOR (semicolons - recommended for GRIB param rename):
#    Use semicolons (;) to explicitly separate variables, commas for rename syntax
#    AIFS_Test=O3,210203;NH3,217019     # Two variables with GRIB param rename
#    AIFS_Test=O3,go3;pl:NH3;NH4_as     # Three variables (first with rename)
#
# 2. SMART COMMA PARSING (no semicolons):
#    Parser intelligently detects rename syntax vs separators:
#    AIFS_Test=O3,NH3                   # Two simple variables (comma = separator)
#    AIFS_Test=O3,go3                   # One variable with rename (comma = rename)
#    AIFS_Test=O3,go3,NH3               # Mixed: first renamed, second simple
#
# NOTE: To find correct GRIB parameters, use:
#   qlc-vars info go3    # Shows: GRIB Parameter: 210203
#   qlc-vars search nh3  # Lists all NH3-related variables with GRIB params
#
# Found 18 variables matching 'nh3':
# 
# Variable ID               Source               Param/GRIB      Unit            Description
# ==============================================================================================================
# nh3fire                   ifs                  210116          kg m-2 s-1      Wildfire Flux of Ammonia (NH3)
# nh3                       ifs                  217019          kg kg-1         Ammonia mass mixing ratio
#
#----------------------------------------------------------------------

# RECOMMENDATION: Use semicolons for clarity when using rename syntax with GRIB params
# Examples:
#   MARS_Test=O3,go3;NH3,nh3           # Clear: O3→go3, NH3→nh3 (IFS names)
#   MARS_Test=O3,210203;NH3,217019     # Clear: both have GRIB param rename
#   MARS_Test=sfc:O3,go3;pl:NH3        # Clear: different levels with rename
#----------------------------------------------------------------------

[VARIABLE_GROUPS]

# AIFS Core Groups
AIFS_SFC=O3,go3;NO2;SO2;CO;PM2.5;PM10;AOD
AIFS_PL=pl:O3,go3;pl:CO;pl:NO2;pl:SO2

# Aerosol Package
AIFS_AEROSOL=PM1;PM2.5;PM10;AOD;dust_025;dust_05;dust_2;sea_salt;organic_matter;black_carbon

# Gas Phase Chemistry
AIFS_GASES=O3,go3;NO;NO2;CO;SO2;HNO3;NH3;PAN

# Quick Test Set
AIFS_Test=O3,go3;PM2.5

# GHOST Aerosol Optical Properties (when using GHOST harmonized network)
GHOST_OPTICAL=absco550;absco670;sca550aero;lsco550;od550aero;asy550

# GHOST PM Properties
GHOST_PM=pm2p5absco550;pm2p5lsco550;pm10absco550;pm1absco550

# Nitrogen Species
NITROGEN=NO;NO2;HNO3;NH3;NH4;pNO3

# Sulfur Species  
SULFUR=SO2;SO4;SO4_as

# Quick Test Set (sfc is default; pl and ml must be provided, either by ':' or '_')
#AIFS_VARS=NH4_as,nh4;pl:NH3,nh3
#AIFS_VARS=NH4_as,210249;pl:NH3,nh3
AIFS_VARS=pl:O3,go3

#----------------------------------------------------------------------
# END OF VARIABLE GROUPS
#----------------------------------------------------------------------

#----------------------------------------------------------------------
# MARS DEFAULTS (Override global settings from qlc.conf)
#----------------------------------------------------------------------
# These parameters control MARS retrievals in A1-MARS script
# See: https://confluence.ecmwf.int/display/UDOC/MARS+keywords
#----------------------------------------------------------------------

[MARS_DEFAULTS]
# If empty - inherit from global qlc.conf

# Basic MARS parameters
TYPE=fc             # Type (fc=forecast)
STREAM=oper         # Stream (oper=operational)
GRID=0.25/0.25      # Grid resolution (0.25 degrees)

# Model class
CLASS=mc            # Model class (mc=AIFS, rd=default)
# If needed, use command line override:
# -class=<xx>               Override MARS class for all experiments
# -class=<xx,yy,zz>         Override MARS class per experiment (must match count)

# Timing
TIME=00             # Initialization time (00 UTC)
#TIME=00/12         # Both 00 and 12 UTC cycles

# Vertical levels
#PL_LEVELIST=10/50/100/150/200/400/700/850/925/1000
PL_LEVELIST=1000    # Pressure level (1000 hPa = surface)
#ML_LEVELIST=137     # Model level (137 = surface in ECMWF L137)

# Forecast steps
# RECOMMENDED: 0/to/21/by/3 (avoids duplicate timestamps at midnight)
# Creates: 0,3,6,9,12,15,18,21 hour forecasts (8 timesteps per day)
#
# OPTION 1 (RECOMMENDED):
STEP_SFC=0/to/21/by/3 
STEP_PL=0/to/21/by/3
STEP_ML=0/to/21/by/3 
#
# OPTION 2 (if 24h or longer forecast needed use data in grib format):
#STEP_SFC=0/to/24/by/3
#STEP_PL=0/to/24/by/3
#STEP_ML=0/to/24/by/3
# Note: With DATE range, step 24 of day N = step 0 of day N+1 (duplicate!)
#       QLC handles this automatically, but 0/to/21/by/3 is cleaner
#
# WARNING: step > 21 can cause issues with GRIB to NetCDF conversion
# References:
#   https://confluence.ecmwf.int/display/OIFS/How+to+convert+GRIB+to+netCDF
#   https://confluence.ecmwf.int/display/ECC/grib_to_netcdf

#----------------------------------------------------------------------
# END OF MARS DEFAULTS
#----------------------------------------------------------------------

#======================================================================
# v1.0.1 BETA NEW FEATURES - QUICK REFERENCE
#======================================================================
#
# VARIABLE SYSTEM (7,855 total variables):
#   - 7398 IFS parameter database variables
#   - 282 GHOST-standardized variables (7 networks)
#   - 102 original observation network variables
#   - 73 other model/observation variables
#
# GHOST NETWORKS (7 available, 282 variables):
#   - ghost_harmonized  # Main network with 200+ aerosol optical properties
#   - ghost-aqs         # US EPA Air Quality (43 vars)
#   - ghost-ebas        # European EBAS (89 vars)
#   - ghost-airbase     # European Airbase (57 vars)
#   - ghost-castnet     # US CASTNET (10 vars)
#   - ghost-naps        # Canadian NAPS (42 vars)
#   - ghost-uk_air      # UK AIR (31 vars)
#
# CSV OBSERVATIONS (3 networks):
#   - AMoN     # Ammonia Monitoring Network
#   - CastNet  # Clean Air Status and Trends
#   - NNDMN    # National Nitrogen Deposition Monitoring
#
# VARIABLE TOOLS:
#   qlc-vars search <keyword>      # Find variables
#   qlc-vars list --source ifs     # List IFS variables
#   qlc-vars list --sources        # List all sources
#   qlc-vars info <variable>       # Get variable details
#   qlc-vars validate <config>     # Validate configuration
#
# DOCUMENTATION:
#   - Online:    https://docs.researchconcepts.io/qlc/latest/
#   - Variables: https://docs.researchconcepts.io/qlc/latest/user-guide/variable-system/
#   - GHOST:     https://docs.researchconcepts.io/qlc/latest/advanced/ghost-integration/
#   - GRIB:      https://docs.researchconcepts.io/qlc/latest/advanced/grib-support/
#
#======================================================================
#======================================================================
# USAGE NOTES
#======================================================================
#
# ENABLING MULTI-REGION MODE:
# ---------------------------
# 1. Set MULTI_REGION_MODE=true above
# 2. Configure the regions you want to process
# 3. Set ACTIVE_REGIONS to list specific regions, or leave empty for all
# 4. Run qlc normally: qlc exp1 expN 2018-01-01 2018-12-31 eac5
#
# VARIABLE FILTERING:
# -------------------
# Variables are automatically filtered based on:
# 1. MARS_RETRIEVALS (or region-specific override)
# 2. Region dataset capabilities
# 3. Actual file existence
# 
# Example: If you request NH3 for CASTNET, it will be automatically
# skipped (with a log warning) because CASTNET doesn't have NH3 data.
#
# OUTPUT STRUCTURE:
# -----------------
# Plots/exp1-exp2_DATE/
#   ├── EU/
#   │   ├── qlc_D1_config.json
#   │   ├── plots/
#   │   └── texPlotfiles_qlc_D1.tex
#   ├── US_CASTNET/
#   │   └── ...
#   ├── US_AMON/
#   │   └── ...
#   └── texPlotfiles_qlc_D1_all_regions.tex (if TEX_FILE_MODE=combined)
#
# REGION NAMING:
# --------------
# Region codes (REGION_*_NAME) can be anything, but PLOT_REGION must
# match qlc-py region definitions. List available regions with:
#
# qlc-extract-stations --list-regions
#
# Terminal output:
#Available Region Codes:
#================================================================================
#
#Global/Continental:
#  Globe        - Global                         [lat:  -90.0 to   90.0, lon:  -180.0 to   180.0]
#  ASIA         - Asia                           [lat:    0.0 to   50.0, lon:    60.0 to   150.0]
#  AFRICA       - Africa                         [lat:  -35.0 to   35.0, lon:   -20.0 to    55.0]
#  EU           - Europe                         [lat:   35.0 to   70.0, lon:   -10.0 to    40.0]
#  NA           - North America                  [lat:   15.0 to   70.0, lon:  -170.0 to   -50.0]
#  ....
# 
#   - "EU" or "Europe" for Europe
#   - "US" for United States
#   - "Asia" for Asia
#   - Other values use default PlateCarree projection
#
# MARS_RETRIEVALS OVERRIDES:
# ---------------------------
# You can override MARS_RETRIEVALS per region for optimization:
#   REGION_US_AMON_MARS_RETRIEVALS=("B1_pl")  # Only NH3 for AMoN
#
# This avoids retrieving unnecessary variables for each region.
#
# STATION_RADIUS_DEG OVERRIDES:
# -----------------------------
# You can override STATION_RADIUS_DEG per region:
#   REGION_EU_urban_STATION_RADIUS_DEG=0.25   # Dense urban network
#   REGION_US_AMON_STATION_RADIUS_DEG=2.0     # Sparse biweekly network
#
# Different observation networks have different station densities:
# - Dense hourly networks (AirNow, urban EBAS): 0.25-0.5 degrees
# - Moderate networks (EBAS, CASTNET): 0.5-1.0 degrees
# - Sparse networks (AMoN biweekly): 1.0-2.0 degrees
#
# TESTING:
# --------
# Test single region first:
#   ACTIVE_REGIONS=("US_AIRNOW") 
#   qlc exp1 expN 2025-11-01 2025-11-07 aifs
#
# Then test multiple regions:
#   ACTIVE_REGIONS=("EU_EBAS_Daily" "US_AIRNOW") 
#   qlc exp1 expN 2024-12-01 2024-12-31 eac5
#
#======================================================================
# END OF CONFIGURATION
#======================================================================

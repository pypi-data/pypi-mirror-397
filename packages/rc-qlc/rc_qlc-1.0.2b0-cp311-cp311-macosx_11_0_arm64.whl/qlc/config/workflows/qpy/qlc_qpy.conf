# ============================================================================
# QLC QPY WORKFLOW
# ============================================================================
# Part of QLC (Quick Look Content) v1.0.1-beta
# An Automated Model-Observation Comparison Suite Optimized for CAMS
#
# Documentation:
#   - Online Docs:   https://docs.researchconcepts.io/qlc/latest/
#   - Workflows:     https://docs.researchconcepts.io/qlc/latest/user-guide/workflows/
#   - Variables:     https://docs.researchconcepts.io/qlc/latest/user-guide/variable-system/
#   - Configuration: https://docs.researchconcepts.io/qlc/latest/user-guide/configuration/
#
# Workflow Description:
#   Multi-region station analysis using qlc-py. Performs model-observation
#   collocation at station locations and generates comprehensive maps,
#   time series, and statistical plots for multiple regions.
#
# Usage:
#   qlc <exp1> [exp2 ...] <start_date> <end_date> qpy
#   Example: qlc b2ro b2rn 2018-12-01 2018-12-21 qpy
#
# Validation:
#   qlc-vars validate ~/qlc/config/workflows/qpy/qlc_qpy.conf
#
# Copyright (c) 2018-2025 ResearchConcepts io GmbH. All Rights Reserved.
# Questions/Comments: qlc Team @ ResearchConcepts io GmbH <qlc@researchconcepts.io>
# ============================================================================
#----------------------- QLC-PY TASK CONFIGURATION -------------
#----------------------------------------------------------------------
# QLC-PY: The qlc-python package developed by ResearchConcepts Io GmbH
#
# References:
#   - QLC Documentation: https://docs.researchconcepts.io/qlc/latest/advanced/qpy/
#
# This configuration is loaded when running: qlc ... qpy
#----------------------------------------------------------------------
# Workflow:
#   1. Run A1-MARS script to retrieve grib data (mars task)
#   2. Run D1-ANAL script to create and plot collocated station data (qlc-py task)
#   3. Run Z1-XPDF script to generate final presentation(s) PDF (tex task)
#----------------------------------------------------------------------
# VARIABLE SPECIFICATION:
#   Variables are defined in MARS_RETRIEVALS below
#   Uses table-driven system with 7,000+ IFS parameters
#   No need for manual parameter mapping
#
# DATA RETRIEVAL BEHAVIOR:
#   - Auto-generates MARS request files from MARS_RETRIEVALS
#   - Checks data_retrieved_*.flag files; only retrieves if missing
#   - Creates .flag after successful MARS submission
#
# TO FORCE RE-RETRIEVAL:
#   rm ~/qlc/Results/<exp>/data_retrieved_<exp>_<dates>_<var>.flag
#----------------------------------------------------------------------
# Usage Examples:
#   cd ~/qlc/run
#   qlc b2ro b2rn 2018-12-01 2018-12-21 qpy  # bash  processing (interactive)
#  sqlc b2ro b2rn 2018-12-01 2018-12-21 qpy  # batch processing (automatic)
# Note: Use command line override if needed to match exp class (default=rd)
#  sqlc b2ro b2rn 2018-12-01 2018-12-21 qpy -class=nl,nl
#  sqlc b2ro b2rn 2018-12-01 2018-12-21 qpy -class=nl,nl -obs-only
#  sqlc b2ro b2rn 2018-12-01 2018-12-21 qpy -class=nl,nl -mod-only
#----------------------------------------------------------------------

#----------------------------------------------------------------------
# Source qlc.conf base configuration and common functions
#----------------------------------------------------------------------
[ -f "$HOME/qlc/config/qlc.conf" ] && source "$HOME/qlc/config/qlc.conf" || {
    echo "[$(date +"%Y-%m-%d %H:%M:%S")] [ERROR] Base config not found: $HOME/qlc/config/qlc.conf" >&2
    exit 1
}
#----------------------------------------------------------------------
# Run-time definitions - Control which scripts to execute
#----------------------------------------------------------------------
# Workflow: MARS retrieval → Analysis → PDF
SUBSCRIPT_NAMES=("A1-MARS" "D1-ANAL" "Z1-XPDF")
#----------------------------------------------------------------------
# Global MARS Retrievals - NEW v1.0.1 SIMPLIFIED SYNTAX
#----------------------------------------------------------------------
#MARS_RETRIEVALS=("@QPY_AEROSOL" "@QPY_GASES")
#MARS_RETRIEVALS=("@QPY_SFC" "@QPY_PL")
MARS_RETRIEVALS=("@QPY_VARS")

#----------------------------------------------------------------------
# Override global defaults from qlc.conf
#----------------------------------------------------------------------
#PL_VRANGE="100,300,UTLS"          # For C1-GLOB: Vertical range definitions 
#PFILL="shaded"                    # For C1-GLOB: fill or shaded (C1-GLOB plots only)
MODEL_RESOLUTION="T511L137"        # For Z1-XPDF: pdf only (final PDF report)
PLOTEXTENSION="pdf"                # For C1-GLOB/D1-ANAL: png (smaller) or pdf (higher quality)
#----------------------------------------------------------------------
# For D1-ANAL: Common settings (apply to all regions)
#----------------------------------------------------------------------
MODEL="IFS-COMPO"                  # Model information
EXP_LABELS=""                      # Comma-separated labels for plot legends for the experiments, in the same order (leave empty to use exp IDs)
MODEL_LEVEL=""                     # Leave empty for automatic surface level detection
STATION_RADIUS_DEG=0.5             # Search radius for model points around stations
USE_UNIFORM_TIME_GRID=false        # Preserve actual timestamps (not gap-filled grid)
PLOT_TYPE="map,burden,zonal,meridional,scatter,taylor" # Plot types to generate
TIME_AVERAGE="daily"               # Time averaging
UNIT_TO="ug/m3"                    # Unit conversion for obs and model to specified unit
SPATIAL_INTERP_METHOD="nearest"    # nearest (default), linear, cubic
MULTIPROCESSING=false              # Set to true for parallel processing (requires plugin)
N_THREADS=1                        # Number of threads if multiprocessing enabled (in case of run-time errors set to 1)
DEBUG=false                        # Enable debug output
DEBUG_EXTENDED=false               # Enable extended diagnostics
SHOW_STATION_TIMESERIES_OBS=true   # Plot observation time series
SHOW_STATION_TIMESERIES_MOD=true   # Plot model time series
SHOW_STATION_TIMESERIES_COM=true   # Plot collocation comparison time series
#----------------------------------------------------------------------
USE_GRIB_SOURCE=true               # Use GRIB files directly from Results
#----------------------------------------------------------------------
# Plot settings
#----------------------------------------------------------------------
# Station settings
STATION_NETWORK=""                 # Filter by network (empty = all)
STATION_SUFFIX=""                  # Suffix for station names
STATION_TYPE="concentration"       # Type of data (concentration, deposition)
SHOW_STATIONS=false                # Show individual station plots
PLOT_MODE="grouped"                # grouped or individual
STATION_PLOT_GROUP_SIZE=5          # Stations per grouped plot
SHOW_MIN_MAX=true                  # Show min/max values on time series
LOG_Y_AXIS=false                   # Use logarithmic y-axis
FIX_Y_AXIS=true                    # Fix y-axis range across plots
FORCE_FULL_YEAR=false              # Force full year display
SHOW_STATION_MAP=false             # Show station location map
# Output formats
SAVE_PLOT_FORMAT=$PLOTEXTENSION    # Plot format (png, pdf, or both)
SAVE_DATA_FORMAT="nc"              # Collocation files Data format (nc or csv)
READ_DATA_FORMAT=$SAVE_DATA_FORMAT # Data format (nc or csv)
LAZY_LOAD_NC=true                  # Memory-efficient NetCDF loading
# Map settings
MAP_COLORMAP="turbo"               # turbo, viridis, plasma
MAP_COLORMAP_DIFF="RdBu_r"         # Difference plot colormap
ENABLE_DIFF_PLOTS=true             # Enable difference plots
USE_LOG_SCALE=true                 # Use logarithmic color scale
USE_NORMALIZED_SCALE=false         # Normalize color scale
MAP_SHOW_STATS=true                # Show statistics on maps
MAP_PROJECTION="Robinson"          # Global map projection (Robinson, PlateCarree, EqualEarth)
PUBLICATION_STYLE=true             # Use publication-ready styling (higher quality, slower)
PLOT_DPI=""                        # DPI for plots (empty=auto, 100=fast, 150=balanced, 300+=publication)
#----------------------------------------------------------------------
TEX_FILE_MODE="per_region"         # TeX file generation mode: "combined" or "per_region"
#----------------------------------------------------------------------
MULTI_REGION_MODE=true
#----------------------------------------------------------------------
#ACTIVE_REGIONS=("EU_EBAS_Daily" "US_CASTNET" "US_AMON" "US_AIRNOW" "China_AQ")
ACTIVE_REGIONS=("EU_EBAS_Daily")
#----------------------------------------------------------------------
# REGION: Europe - EBAS Daily
#----------------------------------------------------------------------
# European monitoring network with comprehensive species coverage
REGION_EU_EBAS_Daily_NAME="EU_EBAS_Daily"
REGION_EU_EBAS_Daily_OBS_PATH="${QLC_HOME}/obs/data/ver0d"
REGION_EU_EBAS_Daily_OBS_DATASET_TYPE="ebas_daily"
REGION_EU_EBAS_Daily_OBS_DATASET_VERSION="latest"
REGION_EU_EBAS_Daily_STATION_FILE="${QLC_HOME}/config/station_locations/Ebas_daily_stations-all.csv"
#REGION_EU_EBAS_Daily_STATION_FILE="${QLC_HOME}/config/station_locations/Ebas_daily_stations-rural.csv"
#REGION_EU_EBAS_Daily_STATION_FILE="${QLC_HOME}/config/station_locations/Ebas_daily_stations-urban.csv"
#REGION_EU_EBAS_Daily_STATION_FILE="${QLC_HOME}/config/station_locations/Ebas_daily_stations-test.csv"
#REGION_EU_EBAS_VARIABLES="NH4_as,NO3_as,SO4_as,NH3,HNO3,NO2,SO2,O3,PM25,PM10,AOD"
REGION_EU_EBAS_Daily_PLOT_REGION="EU"
REGION_EU_EBAS_Daily_STATION_RADIUS_DEG=0.5

#----------------------------------------------------------------------
# REGION: UNITED STATES - CASTNET
#----------------------------------------------------------------------
# CASTNET provides weekly measurements of aerosols and select gases
# Note: NO NH3 data available in CASTNET
REGION_US_CASTNET_NAME="US_CASTNET"
REGION_US_CASTNET_OBS_PATH="${QLC_HOME}/obs/data"
REGION_US_CASTNET_OBS_DATASET_TYPE="castnet"
REGION_US_CASTNET_OBS_DATASET_VERSION="latest"
REGION_US_CASTNET_STATION_FILE="${QLC_HOME}/config/station_locations/CastNet_stations-all.csv"
REGION_US_CASTNET_PLOT_REGION="US"  # Matches style.py
REGION_US_CASTNET_VARIABLES="NH4_as,SO4_as,NO3_as"
REGION_US_CASTNET_STATION_RADIUS_DEG=1.0  # Optional: Larger radius for sparse CASTNET network

#----------------------------------------------------------------------
# REGION 3: UNITED STATES - AMoN
#----------------------------------------------------------------------
# Ammonia Monitoring Network - NH3 only
REGION_US_AMON_NAME="US_AMON"
REGION_US_AMON_OBS_PATH="${QLC_HOME}/obs/data"
REGION_US_AMON_OBS_DATASET_TYPE="AMoN"
REGION_US_AMON_OBS_DATASET_VERSION="latest"
REGION_US_AMON_STATION_FILE="${QLC_HOME}/config/station_locations/AMoN_stations-all.csv"
REGION_US_AMON_PLOT_REGION="US"
REGION_US_AMON_VARIABLES="NH3"
REGION_US_AMON_STATION_RADIUS_DEG=20.0  # Optional: Very sparse biweekly network

#----------------------------------------------------------------------
# United States - AirNow (Real-time air quality)
#----------------------------------------------------------------------
REGION_US_AIRNOW_NAME="US_AIRNOW"
REGION_US_AIRNOW_OBS_PATH="${QLC_HOME}/obs/data/ver0d"
REGION_US_AIRNOW_OBS_DATASET_TYPE="airnow"
REGION_US_AIRNOW_OBS_DATASET_VERSION="latest"
REGION_US_AIRNOW_STATION_FILE="${QLC_HOME}/config/station_locations/AirNow_stations-all.csv"
REGION_US_AIRNOW_PLOT_REGION="US"
REGION_US_AIRNOW_VARIABLES="O3,NO2,SO2,PM25,PM10"
REGION_US_AIRNOW_STATION_RADIUS_DEG=0.5  # Optional: Dense hourly network

#----------------------------------------------------------------------
# Asia - China AQ (Chinese monitoring network)
#----------------------------------------------------------------------
REGION_China_AQ_NAME="China_AQ"
REGION_China_AQ_OBS_PATH="${QLC_HOME}/obs/data/ver0d"
REGION_China_AQ_OBS_DATASET_TYPE="china_aq"
REGION_China_AQ_OBS_DATASET_VERSION="latest"
REGION_China_AQ_STATION_FILE="${QLC_HOME}/config/station_locations/China_AQ_stations-all.csv"
REGION_China_AQ_PLOT_REGION="China_AQ"  # Matches style.py
REGION_China_AQ_VARIABLES="SO2,NO2,O3,PM25,PM10"
REGION_China_AQ_STATION_RADIUS_DEG=0.5  # Optional: Urban Chinese network

#----------------------------------------------------------------------
# Stop bash sourcing here - Python INI sections follow
#----------------------------------------------------------------------
return 0

# ============================================================================
# Python INI Sections (parsed by VariableRegistry, not bash)
# ============================================================================
# These sections override the global qlc.conf to ensure ONLY MARS_RETRIEVALS
# is used for this workflow. Do not inherit predefined variables from global config.

#======================================================================
# VARIABLE REGISTRY (Optional)
#======================================================================
# NEW v1.0.1: Most variables auto-resolve from tables, so registry is OPTIONAL
#
# BEST PRACTICE: Keep this section EMPTY to use automatic table lookup
# 
# Only define explicit mappings here when you need to:
# 1. Override default table resolution (e.g., O3 → go3 instead of O3 → o3)
# 2. Specify exact GRIB parameter ID (e.g., O3,210203)
# 3. Add custom description (e.g., O3,210203,Custom description)
#
# Format: display_name,lookup_name[,description]
# Examples:
#   O3,go3                           # Force O3 to use go3 (full chemistry) instead of o3
#   O3,210203                        # Force O3 to use GRIB param 210203 explicitly
#   pl:O3,210203,Full chem ozone     # Pressure level with custom description
#
# WARNING: Explicit entries here override automatic table resolution!
# If you define "O3,go3" here, then MARS_RETRIEVALS=("O3") will always use go3.
# If you want automatic resolution, keep this section empty.
#----------------------------------------------------------------------

[VARIABLE_REGISTRY]

# Examples (commented out - use automatic table lookup instead):
# sfc_O3,gtco3,Total column ozone - [kg m-2]
# pl_O3,go3,Ozone mass mixing ratio (full chemistry scheme) - [kg kg-1]
# pl_NO2,no2,Nitrogen dioxide mass mixing ratio - [kg kg-1]

#----------------------------------------------------------------------
# END OF VARIABLE REGISTRY
#----------------------------------------------------------------------

#----------------------------------------------------------------------
# VARIABLE GROUPS
#----------------------------------------------------------------------
# NEW v1.0.1: Define reusable groups with SIMPLE SYNTAX
#
# Format: GROUP_NAME=var1,var2,var3
#
# Use simple variable names - they auto-resolve from IFS tables
# Prefix with @ to use groups: MARS_RETRIEVALS=("@QPY_SFC" "@QPY_PL")
#
# NOTE: To find correct GRIB parameters, use:
#   qlc-vars info go3    # Shows: GRIB Parameter: 210203
#   qlc-vars search nh3  # Lists all NH3-related variables with GRIB params
#
# Found 18 variables matching 'nh3':
# 
# Variable ID               Source               Param/GRIB      Unit            Description
# ==============================================================================================================
# nh3fire                   ifs                  210116          kg m-2 s-1      Wildfire Flux of Ammonia (NH3)
# nh3                       ifs                  217019          kg kg-1         Ammonia mass mixing ratio
#
#----------------------------------------------------------------------

# RECOMMENDATION: Use semicolons for clarity when using rename syntax with GRIB params
# Examples:
#   MARS_Test=O3,go3;NH3,nh3           # Clear: O3→go3, NH3→nh3 (IFS names)
#   MARS_Test=O3,210203;NH3,217019     # Clear: both have GRIB param rename
#   MARS_Test=sfc:O3,go3;pl:NH3        # Clear: different levels with rename
#----------------------------------------------------------------------

[VARIABLE_GROUPS]

# QPY Groups
#QPY_SFC=O3,go3;NO2;SO2;CO;PM2.5;PM10;AOD
#QPY_PL=pl:NH3,nh3;pl:HNO3,hno3;pl:CO;pl:NO2;pl:SO2

# Aerosol Core Groups (sfc default)
#QPY_AEROSOL=PM1;PM2.5;PM10;AOD;dust_025;dust_05;dust_2;sea_salt;organic_matter;black_carbon

# Gas Phase Chemistry (sfc default)
#QPY_GASES=O3,go3;NO;NO2;CO;SO2;HNO3;NH3;PAN

# Quick Test Set (sfc is default; pl and ml must be provided, either by ':' or '_')
#QPY_VARS=NH4_as,nh4;pl:NH3,nh3
QPY_VARS=NH4_as,210249;pl:NH3,nh3

#----------------------------------------------------------------------
# END OF VARIABLE GROUPS
#----------------------------------------------------------------------

#----------------------------------------------------------------------
# MARS DEFAULTS (Override global settings from qlc.conf)
#----------------------------------------------------------------------
# These parameters control MARS retrievals in A1-MARS script
# See: https://confluence.ecmwf.int/display/UDOC/MARS+keywords
#----------------------------------------------------------------------

[MARS_DEFAULTS]
# If empty - inherit from global qlc.conf

# Basic MARS parameters
CLASS=rd            # Model class (rd=default)
TYPE=fc             # Type (fc=forecast)
STREAM=oper         # Stream (oper=operational)
GRID=0.50/0.50      # Grid resolution (0.50 degrees)

# Timing
TIME=00             # Initialization time (00 UTC)

# Vertical levels
PL_LEVELIST=10/50/100/150/200/400/700/850/925/1000
#PL_LEVELIST=1000    # Pressure level (1000 hPa = surface)
#ML_LEVELIST=137     # Model level (137 = surface in ECMWF L137)

# Forecast steps (Caution with step > 21/by/3, grib recommended for timeseries analysis)
#STEP_SFC=0/to/21/by/3 
#STEP_PL=0/to/21/by/3
#STEP_ML=0/to/21/by/3 

STEP_SFC=12/24
STEP_PL=12

#----------------------------------------------------------------------
# END OF MARS DEFAULTS
#----------------------------------------------------------------------

#======================================================================
# END OF CONFIGURATION
#======================================================================

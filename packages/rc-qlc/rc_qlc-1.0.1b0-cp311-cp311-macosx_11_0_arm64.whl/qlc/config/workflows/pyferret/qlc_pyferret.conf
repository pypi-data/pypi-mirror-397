# ============================================================================
# QLC PYFERRET WORKFLOW
# ============================================================================
# Part of QLC (Quick Look Content) v1.0.1-beta
# An Automated Model-Observation Comparison Suite Optimized for CAMS
#
# Documentation:
#   - Online Docs:   https://docs.researchconcepts.io/qlc/latest/
#   - Workflows:     https://docs.researchconcepts.io/qlc/latest/user-guide/workflows/
#   - Variables:     https://docs.researchconcepts.io/qlc/latest/user-guide/variable-system/
#   - Configuration: https://docs.researchconcepts.io/qlc/latest/user-guide/configuration/
#   - PyFerret:      https://docs.researchconcepts.io/qlc/latest/advanced/pyferret/
#
# Workflow Description:
#   Quick look 3D global analysis using PyFerret for visualization of
#   time-averaged fields. Generates surface, burden, zonal, meridional,
#   and vertical range plots from time-averaged NetCDF data.
#
# Attribution:
#   PyFerret (NOAA/PMEL)
#   GitHub: https://github.com/NOAA-PMEL/PyFerret
#   Website: https://ferret.pmel.noaa.gov/Ferret/
#
# Usage:
#   qlc <exp1> [exp2 ...] <start_date> <end_date> pyferret
#   Example: qlc b2ro b2rn 2018-12-01 2018-12-21 pyferret
#
# Validation:
#   qlc-vars validate ~/qlc/config/workflows/pyferret/qlc_pyferret.conf
#
# Copyright (c) 2018-2025 ResearchConcepts io GmbH. All Rights Reserved.
# Questions/Comments: qlc Team @ ResearchConcepts io GmbH <qlc@researchconcepts.io>
# ============================================================================
#----------------------- PYFERRET TASK CONFIGURATION -------------
#----------------------------------------------------------------------
# QLC-PY   : The qlc-python package developed by ResearchConcepts Io GmbH
# PyFerret : The PyFerret program and Python module from NOAA/PMEL
#
# References:
#   - PyFerret GitHub:   https://github.com/NOAA-PMEL/PyFerret/blob/master/README.md
#   - PyFerret Website:  https://ferret.pmel.noaa.gov/Ferret/
#   - QLC Documentation: https://docs.researchconcepts.io/qlc/latest/advanced/pyferret/
#
# This configuration is loaded when running: qlc ... pyferret
#----------------------------------------------------------------------
# Workflow:
#   1. Run A1-MARS script to retrieve grib data (mars task)
#   2. Run B1-CONV script to convert grib to netcdf data (cdo task)
#   3. Run B2-PREP script to rename and time average netcdf variables (cdo task)
#   4. Run C1-GLOB script to plot 3D analysis, surface, burden, zonal, meridional, UTLS (pyFerrert task)
#   5. Run Z1-XPDF script to generate final presentation(s) PDF (tex task)
#----------------------------------------------------------------------
# VARIABLE SPECIFICATION:
#   Variables are defined in MARS_RETRIEVALS below
#   Uses table-driven system with 7,000+ IFS parameters
#   No need for manual parameter mapping
#
# DATA RETRIEVAL BEHAVIOR:
#   - Auto-generates MARS request files from MARS_RETRIEVALS
#   - Checks data_retrieved_*.flag files; only retrieves if missing
#   - Creates .flag after successful MARS submission
#
# TO FORCE RE-RETRIEVAL:
#   rm ~/qlc/Results/<exp>/data_retrieved_<exp>_<dates>_<var>.flag
#----------------------------------------------------------------------
# Usage Examples:
#   cd ~/qlc/run
#   qlc b2ro b2rn 2018-12-01 2018-12-21 pyferret  # bash  processing (interactive)
#  sqlc b2ro b2rn 2018-12-01 2018-12-21 pyferret  # batch processing (automatic)
# Note: Use command line override if needed to match exp class (default=rd)
#  sqlc b2ro b2rn 2018-12-01 2018-12-21 pyferret -class=nl,nl
#  sqlc b2ro b2rn 2018-12-01 2018-12-21 pyferret -class=nl,nl -obs-only
#  sqlc b2ro b2rn 2018-12-01 2018-12-21 pyferret -class=nl,nl -mod-only
#----------------------------------------------------------------------

#----------------------------------------------------------------------
# Source qlc.conf base configuration and common functions
#----------------------------------------------------------------------
[ -f "$HOME/qlc/config/qlc.conf" ] && source "$HOME/qlc/config/qlc.conf" || {
    echo "[$(date +"%Y-%m-%d %H:%M:%S")] [ERROR] Base config not found: $HOME/qlc/config/qlc.conf" >&2
    exit 1
}
#----------------------------------------------------------------------
# Run-time definitions - Control which scripts to execute
#----------------------------------------------------------------------
# Workflow: MARS retrieval → Conversion → Global plots → PDF
SUBSCRIPT_NAMES=("A1-MARS" "B1-CONV" "B2-PREP" "C1-GLOB" "Z1-XPDF")
#----------------------------------------------------------------------
# Global MARS Retrievals - NEW v1.0.1 SIMPLIFIED SYNTAX
#----------------------------------------------------------------------
#MARS_RETRIEVALS=("@GLOB_VARS_AEROSOL" "@GLOB_VARS_GASES")
#MARS_RETRIEVALS=("@GLOB_VARS_SFC" "@GLOB_VARS_PL")
MARS_RETRIEVALS=("@GLOB_VARS_VARS")

#----------------------------------------------------------------------
# Override global defaults from qlc.conf
#----------------------------------------------------------------------
PL_VRANGE="100,300,UTLS"           # For C1-GLOB: Vertical range definitions 
PFILL="shaded"                     # For C1-GLOB: fill or shaded (C1-GLOB plots only)
MODEL_RESOLUTION="T511L137"        # For Z1-XPDF: pdf only (final PDF report)
PLOTEXTENSION="png"                # For C1-GLOB/D1-ANAL: png (smaller) or pdf (higher quality)
#----------------------------------------------------------------------
TEX_FILE_MODE="per_region"         # TeX file generation mode: "combined" or "per_region"

#----------------------------------------------------------------------
# Stop bash sourcing here - Python INI sections follow
#----------------------------------------------------------------------
return 0

# ============================================================================
# Python INI Sections (parsed by VariableRegistry, not bash)
# ============================================================================
# These sections override the global qlc.conf to ensure ONLY MARS_RETRIEVALS
# is used for this workflow. Do not inherit predefined variables from global config.

#======================================================================
# VARIABLE REGISTRY (Optional)
#======================================================================
# NEW v1.0.1: Most variables auto-resolve from tables, so registry is OPTIONAL
#
# BEST PRACTICE: Keep this section EMPTY to use automatic table lookup
# 
# Only define explicit mappings here when you need to:
# 1. Override default table resolution (e.g., O3 → go3 instead of O3 → o3)
# 2. Specify exact GRIB parameter ID (e.g., O3,210203)
# 3. Add custom description (e.g., O3,210203,Custom description)
#
# Format: display_name,lookup_name[,description]
# Examples:
#   O3,go3                           # Force O3 to use go3 (full chemistry) instead of o3
#   O3,210203                        # Force O3 to use GRIB param 210203 explicitly
#   pl:O3,210203,Full chem ozone     # Pressure level with custom description
#
# WARNING: Explicit entries here override automatic table resolution!
# If you define "O3,go3" here, then MARS_RETRIEVALS=("O3") will always use go3.
# If you want automatic resolution, keep this section empty.
#----------------------------------------------------------------------

[VARIABLE_REGISTRY]

# Examples (commented out - use automatic table lookup instead):
# sfc_O3,gtco3,Total column ozone - [kg m-2]
# pl_O3,go3,Ozone mass mixing ratio (full chemistry scheme) - [kg kg-1]
# pl_NO2,no2,Nitrogen dioxide mass mixing ratio - [kg kg-1]

#----------------------------------------------------------------------
# END OF VARIABLE REGISTRY
#----------------------------------------------------------------------

#----------------------------------------------------------------------
# VARIABLE GROUPS
#----------------------------------------------------------------------
# NEW v1.0.1: Define reusable groups with SIMPLE SYNTAX
#
# Format: GROUP_NAME=var1,var2,var3
#
# Use simple variable names - they auto-resolve from IFS tables
# Prefix with @ to use groups: MARS_RETRIEVALS=("@GLOB_SFC" "@GLOB_PL")
#
# NOTE: To find correct GRIB parameters, use:
#   qlc-vars info go3    # Shows: GRIB Parameter: 210203
#   qlc-vars search nh3  # Lists all NH3-related variables with GRIB params
#
# Found 18 variables matching 'nh3':
# 
# Variable ID               Source               Param/GRIB      Unit            Description
# ==============================================================================================================
# nh3fire                   ifs                  210116          kg m-2 s-1      Wildfire Flux of Ammonia (NH3)
# nh3                       ifs                  217019          kg kg-1         Ammonia mass mixing ratio
#
#----------------------------------------------------------------------

# RECOMMENDATION: Use semicolons for clarity when using rename syntax with GRIB params
# Examples:
#   MARS_Test=O3,go3;NH3,nh3           # Clear: O3→go3, NH3→nh3 (IFS names)
#   MARS_Test=O3,210203;NH3,217019     # Clear: both have GRIB param rename
#   MARS_Test=sfc:O3,go3;pl:NH3        # Clear: different levels with rename
#----------------------------------------------------------------------

[VARIABLE_GROUPS]

# PyFERRET Groups
#GLOB_SFC=O3,go3;NO2;SO2;CO;PM2.5;PM10;AOD
#GLOB_PL=pl:NH3,nh3;pl:HNO3,hno3;pl:CO;pl:NO2;pl:SO2

# Aerosol Core Groups (sfc default)
#GLOB_AEROSOL=PM1;PM2.5;PM10;AOD;dust_025;dust_05;dust_2;sea_salt;organic_matter;black_carbon

# Gas Phase Chemistry (sfc default)
#GLOB_GASES=O3,go3;NO;NO2;CO;SO2;HNO3;NH3;PAN

# Quick Test Set (sfc is default; pl and ml must be provided, either by ':' or '_')
#GLOB_VARS=NH4_as,nh4;pl:NH3,nh3
GLOB_VARS=NH4_as,210249;pl:NH3,nh3

#----------------------------------------------------------------------
# END OF VARIABLE GROUPS
#----------------------------------------------------------------------

#----------------------------------------------------------------------
# MARS DEFAULTS (Override global settings from qlc.conf)
#----------------------------------------------------------------------
# These parameters control MARS retrievals in A1-MARS script
# See: https://confluence.ecmwf.int/display/UDOC/MARS+keywords
#----------------------------------------------------------------------

[MARS_DEFAULTS]
# If empty - inherit from global qlc.conf

# Basic MARS parameters
CLASS=rd            # Model class (rd=default)
TYPE=fc             # Type (fc=forecast)
STREAM=oper         # Stream (oper=operational)
GRID=0.50/0.50      # Grid resolution (0.50 degrees)

# Timing
TIME=00             # Initialization time (00 UTC)

# Vertical levels
PL_LEVELIST=10/50/100/150/200/400/700/850/925/1000
#PL_LEVELIST=1000    # Pressure level (1000 hPa = surface)
#ML_LEVELIST=137     # Model level (137 = surface in ECMWF L137)

# Forecast steps (Caution with step > 21/by/3, grib recommended for timeseries analysis)
#STEP_SFC=0/to/21/by/3 
#STEP_PL=0/to/21/by/3
#STEP_ML=0/to/21/by/3 

STEP_SFC=12/24
STEP_PL=12

#----------------------------------------------------------------------
# END OF MARS DEFAULTS
#----------------------------------------------------------------------

#======================================================================
# END OF CONFIGURATION
#======================================================================

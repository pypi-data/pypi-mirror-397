specificationVersion: 'jobtemplate-2023-09'
name: Adaptor Cinema4D Job Template
description: Adaptor Cinema4D Job Description
parameterDefinitions:
- name: Cinema4DFile
  type: PATH
  objectType: FILE
  dataFlow: IN
  userInterface:
    control: CHOOSE_INPUT_FILE
    label: Cinema4D Document File
    groupLabel: Cinema4D Settings
    fileFilters:
    - label: Cinema4D document files
      patterns:
      - '*.c4d'
    - label: All Files
      patterns:
      - '*'
  description: The Cinema4D document file to render.
- name: SubmitterIntegrationVersion
  type: STRING
  userInterface:
    control: HIDDEN
    label: Submitter Integration Version
    groupLabel: Cinema4D Settings
  description: The Cinema 4D submitter integration version.
- name: Frames
  type: STRING
  userInterface:
    control: LINE_EDIT
    label: Frames
    groupLabel: Cinema4D Settings
  description: The frames to render. E.g. 1-3,8,11-15
  minLength: 1
- name: OutputPath
  type: PATH
  objectType: FILE
  dataFlow: OUT
  userInterface:
    control: CHOOSE_OUTPUT_FILE
    label: Default image output
    groupLabel: Cinema4D Settings
  description: Image output path
- name: MultiPassPath
  type: PATH
  objectType: FILE
  dataFlow: OUT
  userInterface:
    control: CHOOSE_OUTPUT_FILE
    label: Multi-pass output path
    groupLabel: Cinema4D Settings
  description: Multi-pass image output
- name: ActivateErrorChecking
  type: STRING
  userInterface:
    control: CHECK_BOX
    label: Activate automatic error checking
    groupLabel: Cinema4D Settings
  description: Fail when errors occur.
  default: '1'
  allowedValues:
  - '1'
  - '0'
- name: DetailedLogging
  type: STRING
  userInterface:
    control: CHECK_BOX
    label: Enable Detailed Logging
    groupLabel: Cinema4D Settings
  description: Enable detailed Cinema 4D + Redshift renderer logging for debugging.
  default: '0'
  allowedValues:
  - '1'
  - '0'
- name: UseCachedText
  type: STRING
  userInterface:
    control: CHECK_BOX
    label: Use cached text during render
    groupLabel: Cinema4D Settings
  description: Prevents incorrect or missing text by using cached fonts. If there are no fonts in the scene, this is ignored. If there are fonts in the scene, this will increase rendering time.
  default: '0'
  allowedValues:
  - '1'
  - '0'
steps:
- name: Render
  parameterSpace:
    taskParameterDefinitions:
    - name: Frame
      type: INT
      range: '{{Param.Frames}}'
  stepEnvironments:
  - name: Cinema4D
    description: Runs Cinema4D in the background.
    variables:
      # Turn off buffering in Python
      PYTHONUNBUFFERED: "1"
      SUBMITTER_INTEGRATION_VERSION: "{{Param.SubmitterIntegrationVersion}}"
    script:
      embeddedFiles:
      - name: initData
        filename: init-data.yaml
        type: TEXT
        data: |
          scene_file: '{{Param.Cinema4DFile}}'
          take: 'Main'
          output_path: '{{Param.OutputPath}}'
          multi_pass_path: '{{Param.MultiPassPath}}'
          activate_error_checking: '{{Param.ActivateErrorChecking}}'
          use_cached_text: '{{Param.UseCachedText}}'
      actions:
        onEnter:
          command: cinema4d-openjd
          args:
          - daemon
          - start
          - --path-mapping-rules
          - file://{{Session.PathMappingRulesFile}}
          - --connection-file
          - '{{Session.WorkingDirectory}}/connection.json'
          - --init-data
          - file://{{Env.File.initData}}
          cancelation:
            mode: NOTIFY_THEN_TERMINATE
        onExit:
          command: cinema4d-openjd
          args:
          - daemon
          - stop
          - --connection-file
          - '{{ Session.WorkingDirectory }}/connection.json'
          cancelation:
            mode: NOTIFY_THEN_TERMINATE
  script:
    embeddedFiles:
    - name: runData
      filename: run-data.yaml
      type: TEXT
      data: |
        frame: {{Task.Param.Frame}}
    actions:
      onRun:
        command: cinema4d-openjd
        args:
        - daemon
        - run
        - --connection-file
        - '{{ Session.WorkingDirectory }}/connection.json'
        - --run-data
        - file://{{ Task.File.runData }}
        cancelation:
          mode: NOTIFY_THEN_TERMINATE

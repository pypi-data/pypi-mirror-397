"""Factory function for creating paginated file browser views"""

# AUTOGENERATED! DO NOT EDIT! File to edit: ../../nbs/patterns/browser_pagination.ipynb.

# %% auto 0
__all__ = ['create_browser_pagination']

# %% ../../nbs/patterns/browser_pagination.ipynb 3
from typing import List, Any, Optional
from fasthtml.common import *

from cjm_fasthtml_interactions.patterns.pagination import Pagination

from ..core.types import FileType
from ..core.models import FileEntry
from ..components.browser import grid_view_content, list_view_content, empty_browser_content
from ..discovery.scanner import FileScanner
from ..serving.mounter import DirectoryMounter

# %% ../../nbs/patterns/browser_pagination.ipynb 5
def create_browser_pagination(
    pagination_id: str,  # Unique identifier for this pagination instance
    scanner: FileScanner,  # FileScanner instance for loading files
    mounter: DirectoryMounter,  # DirectoryMounter instance for URL generation
    items_per_page: int = 30,  # Number of items per page
    content_id: Optional[str] = None,  # HTML ID for content area
    preview_route_func = None,  # Function to generate preview route URL
    modal_id: str = "fb-preview-modal"  # ID for the preview modal
) -> Pagination:  # Configured Pagination instance
    """Create a Pagination instance for file browsing."""

    def load_files(request) -> List[FileEntry]:
        """Load files from scanner with optional filtering."""
        files = scanner.scan()

        # Filter by file type if specified
        file_type = request.query_params.get("file_type")
        if file_type and file_type != "all":
            try:
                target_type = FileType(file_type)
                files = [f for f in files if f.file_type == target_type]
            except ValueError:
                pass  # Invalid type, return all files

        return files

    def render_file_items(items: List[FileEntry], page: int, request) -> Any:
        """Render file items for the current page."""
        view_mode = request.query_params.get("view", "grid")
        file_type = request.query_params.get("file_type")
        start_idx = (page - 1) * items_per_page

        if items:
            if view_mode == "grid":
                return grid_view_content(
                    files=items,
                    mounter=mounter,
                    start_idx=start_idx,
                    file_type_filter=file_type,
                    preview_route_func=preview_route_func,
                    modal_id=modal_id
                )
            else:
                return list_view_content(
                    files=items,
                    mounter=mounter,
                    start_idx=start_idx,
                    file_type_filter=file_type,
                    preview_route_func=preview_route_func,
                    modal_id=modal_id
                )
        else:
            return empty_browser_content(
                message="No files found. Configure directories in settings.",
            )

    return Pagination(
        pagination_id=pagination_id,
        data_loader=load_files,
        render_items=render_file_items,
        items_per_page=items_per_page,
        content_id=content_id,
        preserve_params=["view", "file_type"],
        show_endpoints=True,
        push_url=False
    )

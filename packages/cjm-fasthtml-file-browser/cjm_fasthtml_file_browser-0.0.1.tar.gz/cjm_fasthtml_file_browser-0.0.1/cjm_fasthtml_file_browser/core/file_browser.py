"""Unified facade for file discovery, mounting, and access"""

# AUTOGENERATED! DO NOT EDIT! File to edit: ../../nbs/core/file_browser.ipynb.

# %% auto 0
__all__ = ['FileBrowser']

# %% ../../nbs/core/file_browser.ipynb 3
from typing import List, Optional
from fasthtml.common import APIRouter
from fastcore.basics import patch

from .types import FileType
from .config import BrowserConfig
from .models import FileEntry
from ..discovery.scanner import FileScanner
from ..serving.mounter import DirectoryMounter
from ..patterns.browser_pagination import create_browser_pagination
from ..patterns.selection_pagination import create_selection_pagination

# %% ../../nbs/core/file_browser.ipynb 5
class FileBrowser:
    """Unified interface for file scanning, mounting, and browsing."""

    def __init__(
        self,
        config: BrowserConfig  # Browser configuration with directories and settings
    ):
        """Initialize the file browser."""
        self.config = config
        self.scanner = FileScanner(config)
        self.mounter = DirectoryMounter()
        self._pagination = None
        self._pagination_router = None

    @property
    def pagination(self):
        """Access to the pagination instance."""
        return self._pagination

    @property
    def pagination_router(self) -> Optional[APIRouter]:
        """Access to the pagination router."""
        return self._pagination_router

    @property
    def file_selection_pagination(self):
        """Access to the file selection pagination instance."""
        return getattr(self, '_file_selection_pagination', None)

    @property
    def file_selection_router(self) -> Optional[APIRouter]:
        """Access to the file selection pagination router."""
        return getattr(self, '_file_selection_router', None)

# %% ../../nbs/core/file_browser.ipynb 7
@patch
def mount(
    self: FileBrowser,
    app  # FastHTML/Starlette application instance
) -> None:
    """Mount directories to app for static file serving."""
    self.mounter.mount(app, self.config.directories)

# %% ../../nbs/core/file_browser.ipynb 8
@patch
def scan(
    self: FileBrowser,
    force_refresh: bool = False  # Force a fresh scan, ignoring cache
) -> List[FileEntry]:  # List of FileEntry objects
    """Scan for files."""
    return self.scanner.scan(force_refresh)

# %% ../../nbs/core/file_browser.ipynb 9
@patch
def get_files_by_type(
    self: FileBrowser,
    file_types: List[FileType]  # List of FileType values to filter by
) -> List[FileEntry]:  # List of FileEntry objects matching the types
    """Get files filtered by specific file types."""
    files = self.scan()
    return [f for f in files if f.file_type in file_types]

# %% ../../nbs/core/file_browser.ipynb 10
@patch
def get_url(
    self: FileBrowser,
    file_path: str  # Full path to the file
) -> Optional[str]:  # URL path to access the file, or None if not in a mounted directory
    """Get URL for a file."""
    return self.mounter.get_url(file_path)

# %% ../../nbs/core/file_browser.ipynb 11
@patch
def clear_cache(
    self: FileBrowser
) -> None:
    """Clear the scan cache."""
    self.scanner.clear_cache()

# %% ../../nbs/core/file_browser.ipynb 12
@patch
def get_summary(
    self: FileBrowser
) -> dict:  # Dictionary with file counts, sizes, and breakdowns
    """Get summary statistics for scanned files."""
    return self.scanner.get_summary()

# %% ../../nbs/core/file_browser.ipynb 13
@patch
def create_pagination(
    self: FileBrowser,
    pagination_id: str,  # Unique identifier for this pagination instance
    content_id: str,  # HTML ID for the content area
    preview_route_func = None,  # Optional function to generate preview route URL
    modal_id: str = "fb-preview-modal"  # ID for the preview modal
):  # Configured Pagination instance
    """Create a pagination instance for browsing files."""
    self._pagination = create_browser_pagination(
        pagination_id=pagination_id,
        scanner=self.scanner,
        mounter=self.mounter,
        items_per_page=self.config.items_per_page,
        content_id=content_id,
        preview_route_func=preview_route_func,
        modal_id=modal_id
    )
    return self._pagination

# %% ../../nbs/core/file_browser.ipynb 14
@patch
def get_pagination_router(
    self: FileBrowser,
    prefix: str  # URL prefix for pagination routes
) -> Optional[APIRouter]:  # APIRouter for pagination, or None if pagination not created
    """Get the pagination router for registration with the app."""
    if self._pagination:
        self._pagination_router = self._pagination.create_router(prefix=prefix)
        return self._pagination_router
    return None

# %% ../../nbs/core/file_browser.ipynb 15
@patch
def create_file_selection_pagination(
    self: FileBrowser,
    pagination_id: str,  # Unique identifier for this pagination instance
    content_id: str,  # HTML ID for the content area
    preview_url_func = None,  # Function that takes file index and returns preview URL
    preview_target_id: str = None,  # HTML ID to target for preview modal
    file_type_filter: Optional[List[FileType]] = None  # Optional filter to only show certain file types
):  # Configured Pagination instance for file selection
    """Create a pagination instance for file selection table with radio buttons."""
    self._file_selection_pagination = create_selection_pagination(
        pagination_id=pagination_id,
        scanner=self.scanner,
        items_per_page=self.config.items_per_page,
        content_id=content_id,
        preview_url_func=preview_url_func,
        preview_target_id=preview_target_id,
        file_type_filter=file_type_filter
    )
    return self._file_selection_pagination

# %% ../../nbs/core/file_browser.ipynb 16
@patch
def get_file_selection_router(
    self: FileBrowser,
    prefix: str  # URL prefix for pagination routes
) -> Optional[APIRouter]:  # APIRouter for file selection pagination, or None if not created
    """Get the file selection pagination router."""
    if self._file_selection_pagination:
        self._file_selection_router = self._file_selection_pagination.create_router(prefix=prefix)
        return self._file_selection_router
    return None

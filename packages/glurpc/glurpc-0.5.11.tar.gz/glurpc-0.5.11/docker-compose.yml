services:
  glurpc:
    image: glucosedao/glurpc:latest
    #image: ghcr.io/glucosedao/glurpc:latest-gpu
    container_name: glurpc-service
    restart: unless-stopped
    
    ports:
      # gRPC on localhost only
      - "127.0.0.1:7003:7003"
      # REST on all interfaces
      - "8000:8000"
      # SNET daemon prod (optional, uncomment if needed)
      - "127.0.0.1:7001:7001"
      # SNET daemon (optional, uncomment if needed)
      - "127.0.0.1:7002:7002"
      # HTTP for Let's Encrypt certificate challenges (uncomment if needed)
      # - "127.0.0.1:80:80"
      # ETCD client port (for cluster configuration or external access)
      # - "127.0.0.1:2379:2379"
      # ETCD peer port (for multi-node ETCD cluster configuration)
      # - "127.0.0.1:2380:2380"
    
    volumes:
      # Cache persistence using named volume
      - glurpc-cache:/app/cache_storage:z
      # Logs to host directory for easy access
      - ./logs:/app/logs:z
      # API keys file (create api-keys.txt with one key per line)
      - ./api_keys_list:/app/api-keys.txt:ro,Z
      # SNET daemon ETCD data persistence
      - glurpc-etcd:/app/etcd:z
      # SNET daemon configuration files (editable)
      - ./snetd_configs:/app/snetd_configs:z
      # SSL certificates (mount your Let's Encrypt certs here)
      # Example: - /etc/letsencrypt:/app/.certs:ro,Z
      - ./certs:/app/.certs:z
    
    environment:
      # SSL configuration for SNET daemon (set to true if using SSL)
      REQUIRE_SSL: "False"
      
      # --- Cache Configuration ---
      MAX_CACHE_SIZE: 128
      ENABLE_CACHE_PERSISTENCE: "True"
      
      # --- Data Processing Configuration ---
      # Note: These use model defaults if not set (MINIMUM_DURATION_MINUTES=540, MAXIMUM_WANTED_DURATION=1080)
      # Uncomment to override:
      MINIMUM_DURATION_MINUTES: 540
      MAXIMUM_WANTED_DURATION: 1080
      
      # --- API Configuration ---
      ENABLE_API_KEYS: "False"
      
      # --- Model and Inference Configuration ---
      NUM_COPIES_PER_DEVICE: 2
      BACKGROUND_WORKERS_COUNT: 4
      BATCH_SIZE: 32
      NUM_SAMPLES: 10
      
      # --- Timeout Configuration ---
      INFERENCE_TIMEOUT_GPU: 600.0
      INFERENCE_TIMEOUT_CPU: 7200.0
      
      # --- Queue Configuration ---
      MAX_INFERENCE_QUEUE_SIZE: 64
      MAX_CALC_QUEUE_SIZE: 8192
      
      # --- Logging Configuration ---
      LOG_LEVEL_ROOT: INFO
      LOG_LEVEL_LOGIC: INFO
      LOG_LEVEL_ENGINE: INFO
      LOG_LEVEL_CORE: INFO
      LOG_LEVEL_APP: INFO
      LOG_LEVEL_STATE: INFO
      LOG_LEVEL_CACHE: INFO
      LOG_LEVEL_LOCKS: ERROR
      VERBOSE: "False"
    
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    # Override command for different modes:
    # Default (combined service, no daemon):
    #   command: ["glurpc-combined", "--combined"]
    #
    # With SNET daemon:
    command: ["glurpc-combined", "--combined", "--daemon", "--daemon-config", "/app/snetd_configs/snetd.sepolia.json"]
    #
    # With SSL:
    #   command: ["glurpc-combined", "--combined", "--daemon", "--daemon-config", "/app/snetd_configs/snetd.sepolia.json", "--ssl"]
    #
    # REST only:
    #   command: ["glurpc-combined", "--rest"]
    #
    # gRPC only:
    #   command: ["glurpc-combined", "--grpc"]
    
    # Resource limits (optional, adjust based on your needs)
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '4.0'
    #       memory: 8G
    #     reservations:
    #       cpus: '2.0'
    #       memory: 4G

volumes:
  glurpc-cache:
    name: glurpc-cache
  glurpc-etcd:
    name: glurpc-etcd
    driver: local

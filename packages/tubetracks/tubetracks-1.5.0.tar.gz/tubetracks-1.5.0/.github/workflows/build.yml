name: Build and Test

on:
  workflow_dispatch:  # Manual trigger only
  schedule:
    - cron: '0 0 * * 0'  # Weekly run every Sunday at midnight UTC

permissions:
  contents: read
  pull-requests: write
  checks: write

env:
  PYTHON_VERSION_DEFAULT: '3.12'
  CACHE_VERSION: v1

jobs:
  lint:
    name: Code Quality & Style Checks
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better analysis

    - name: Set up Python ${{ env.PYTHON_VERSION_DEFAULT }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION_DEFAULT }}
        cache: 'pip'
        cache-dependency-path: requirements.txt

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install flake8 black isort pylint mypy

    - name: Code formatting check (Black)
      run: |
        black --check --diff . || {
          echo "Code formatting issues detected"
          echo "Fix with: black ."
          exit 1
        }

    - name: Import sorting check (isort)
      run: |
        isort --check-only --diff . || {
          echo "Import sorting issues detected"
          echo "Fix with: isort ."
          exit 1
        }

    - name: Lint with Flake8 (Critical errors)
      run: |
        # Stop on critical errors
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        
    - name: Lint with Flake8 (Style guide)
      run: |
        # Check style but don't fail the build
        flake8 . --count --max-complexity=10 --max-line-length=127 \
          --statistics --exit-zero

    - name: Lint with Pylint
      run: |
        pylint downloader.py plugins/ tests/ --exit-zero \
          --output-format=colorized \
          --reports=y
      continue-on-error: true

    - name: Type checking with mypy
      run: |
        mypy downloader.py plugins/ --ignore-missing-imports --no-strict-optional
      continue-on-error: true

  security:
    name: Security Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION_DEFAULT }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION_DEFAULT }}
        cache: 'pip'
        cache-dependency-path: requirements.txt

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Install security tools
      run: pip install bandit safety pip-audit

    - name: Run Bandit security scanner
      run: |
        echo "Running Bandit security analysis..."
        bandit -r . -f json -o bandit-report.json --exit-zero
        bandit -r . -f screen --exit-zero
      continue-on-error: true

    - name: Check dependencies with Safety
      run: |
        echo "Checking dependencies for known vulnerabilities..."
        safety check --json || echo "Vulnerabilities detected"
      continue-on-error: true

    - name: Audit dependencies with pip-audit
      run: |
        echo "Auditing Python packages..."
        pip-audit --desc --format json || echo "Issues found"
      continue-on-error: true

    - name: Upload security reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: |
          bandit-report.json
        retention-days: 30

  build:
    name: Test on ${{ matrix.os }} with Python ${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']
        exclude:
          # Optimize CI time by skipping some combinations
          - os: windows-latest
            python-version: '3.8'
          - os: windows-latest
            python-version: '3.9'
          - os: macos-latest
            python-version: '3.8'
          - os: macos-latest
            python-version: '3.9'
    
    env:
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: 1
      FORCE_COLOR: 1

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
        cache-dependency-path: |
          requirements.txt
          pyproject.toml

    - name: Display Python version
      run: python -c "import sys; print(f'Python {sys.version}')"

    - name: Upgrade pip and install build tools
      shell: bash
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip --version

    - name: Install project dependencies
      shell: bash
      run: |
        echo "Installing dependencies..."
        pip install -r requirements.txt || {
          echo "Dependency installation failed"
          echo ""
          echo "Diagnostic information:"
          cat requirements.txt
          exit 1
        }
        echo ""
        echo "ðŸ“‹ Installed packages:"
        pip list

    - name: Install test dependencies
      shell: bash
      run: |
        echo "Installing test dependencies..."
        pip install pytest pytest-cov pytest-xdist pytest-timeout pytest-mock

    - name: Run test suite
      shell: bash
      run: |
        echo "Running tests with coverage..."
        pytest tests/ -v \
          --cov=. \
          --cov-report=xml \
          --cov-report=html \
          --cov-report=term-missing \
          -n auto \
          --timeout=300 \
          --tb=short || {
          echo "Tests failed"
          echo ""
          echo "Test environment:"
          echo "Python: $(python --version)"
          echo "pytest: $(pytest --version)"
          echo ""
          echo "Installed packages:"
          pip list
          echo ""
          echo "Test directory structure:"
          ls -la tests/
          exit 1
        }
        echo "All tests passed"
      timeout-minutes: 10
      env:
        COVERAGE_CORE: sysmon

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.12'
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-${{ matrix.os }}-py${{ matrix.python-version }}
        fail_ci_if_error: false
        verbose: true
      continue-on-error: true

    - name: Compile Python files
      shell: bash
      run: |
        echo "Compiling Python files..."
        python -m py_compile downloader.py
        python -m compileall plugins/ -q
        python -m compileall tests/ -q
        echo "Compilation successful"

    - name: Verify imports
      shell: bash
      run: |
        echo "Verifying imports..."
        python -c "import downloader; print('OK: downloader imported')" || {
          echo "Failed to import downloader"
          echo ""
          echo "Python environment:"
          python -c "import sys; print('Python path:'); print('\n'.join(sys.path))"
          echo ""
          echo "Current directory:"
          ls -la
          exit 1
        }
        
        python -c "from plugins import get_global_registry; print('OK: plugins imported')" || {
          echo "Failed to import plugins"
          echo ""
          echo "Plugins directory:"
          ls -la plugins/
          exit 1
        }
        
        echo "All imports successful"

    - name: Test CLI interface
      shell: bash
      run: |
        echo "Testing CLI..."
        python downloader.py --help
        python downloader.py --version
        python downloader.py --show-config
        python downloader.py --list-plugins
        echo "CLI tests passed"

    - name: Test GUI module imports
      shell: bash
      run: |
        echo "Testing GUI module..."
        python -c "import tubetracks_gui; print('OK: GUI module imports successfully')"
        echo "GUI module test passed"
      continue-on-error: true  # tkinter may not be available in all CI environments

    - name: Archive test artifacts
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-artifacts-${{ matrix.os }}-py${{ matrix.python-version }}
        path: |
          htmlcov/
          .coverage
          coverage.xml
          *.log
        retention-days: 14

  build-package:
    name: Build Distribution Packages
    runs-on: ubuntu-latest
    needs: [build]
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Required for version detection

    - name: Set up Python ${{ env.PYTHON_VERSION_DEFAULT }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION_DEFAULT }}
        cache: 'pip'

    - name: Install build tools
      run: |
        echo "Installing build tools..."
        python -m pip install --upgrade pip setuptools wheel
        pip install build twine check-wheel-contents
        pip list | grep -E "(build|twine|setuptools|wheel)"

    - name: Validate package configuration
      run: |
        echo "Validating pyproject.toml..."
        if [ ! -f pyproject.toml ]; then
          echo "ERROR: pyproject.toml not found"
          exit 1
        fi
        
        echo "pyproject.toml found"
        echo "Configuration:"
        python -c "import tomllib; f=open('pyproject.toml','rb'); print(tomllib.load(f))" || \
        python -c "import tomli; f=open('pyproject.toml','rb'); print(tomli.load(f))" || \
        echo "Cannot parse TOML (Python < 3.11 without tomli)"
        
        echo ""
        echo "Project structure:"
        ls -la
        echo ""
        echo "Plugins directory:"
        ls -la plugins/ || echo "plugins/ directory not found"

    - name: Pre-build validation
      run: |
        echo "Pre-build validation..."
        
        # Check required files exist
        echo "Checking required files..."
        test -f downloader.py || (echo "downloader.py missing" && exit 1)
        test -f tubetracks_gui.py || (echo "tubetracks_gui.py missing" && exit 1)
        test -d plugins || (echo "plugins/ directory missing" && exit 1)
        test -f plugins/__init__.py || (echo "plugins/__init__.py missing" && exit 1)
        
        # Verify Python syntax is valid (without importing dependencies)
        echo "Verifying Python syntax..."
        python -m py_compile downloader.py || (echo "downloader.py has syntax errors" && exit 1)
        python -m py_compile tubetracks_gui.py || (echo "tubetracks_gui.py has syntax errors" && exit 1)
        python -m compileall plugins/ -q || (echo "plugins/ has syntax errors" && exit 1)
        
        echo "Pre-build validation passed"

    - name: Build source and wheel distributions
      run: |
        echo "Building distributions..."
        python -m build --verbose || {
          echo "Build failed!"
          echo ""
          echo "Diagnostic information:"
          echo "Python version: $(python --version)"
          echo "pip version: $(pip --version)"
          echo ""
          echo "Installed packages:"
          pip list
          echo ""
          echo "Current directory contents:"
          ls -la
          echo ""
          echo "pyproject.toml content:"
          cat pyproject.toml
          exit 1
        }
        
        echo ""
        echo "Build completed successfully"
        echo ""
        echo "Generated distributions:"
        ls -lh dist/
        echo ""
        echo "Distribution details:"
        du -h dist/*

    - name: Verify distributions exist
      run: |
        echo "Verifying generated distributions..."
        
        # Check for expected files
        WHEEL_COUNT=$(ls -1 dist/*.whl 2>/dev/null | wc -l)
        TARBALL_COUNT=$(ls -1 dist/*.tar.gz 2>/dev/null | wc -l)
        
        echo "Found $WHEEL_COUNT wheel(s) and $TARBALL_COUNT source distribution(s)"
        
        if [ "$WHEEL_COUNT" -eq 0 ]; then
          echo "ERROR: No wheel (.whl) file generated"
          echo "dist/ directory contents:"
          ls -la dist/ || echo "dist/ directory does not exist"
          exit 1
        fi
        
        if [ "$TARBALL_COUNT" -eq 0 ]; then
          echo "ERROR: No source distribution (.tar.gz) file generated"
          echo "dist/ directory contents:"
          ls -la dist/
          exit 1
        fi
        
        echo "All expected distributions generated"

    - name: Check distribution packages
      run: |
        echo "Checking distribution quality..."
        
        echo "Running twine check..."
        twine check dist/* --strict || {
          echo "Twine check failed"
          echo ""
          echo "Distribution contents:"
          for file in dist/*; do
            echo "--- $file ---"
            if [[ $file == *.whl ]]; then
              python -m zipfile -l "$file" || echo "Cannot list wheel contents"
            elif [[ $file == *.tar.gz ]]; then
              tar -tzf "$file" 2>/dev/null | head -30 || echo "Cannot list tarball contents"
            fi
          done
          exit 1
        }
        
        echo "Twine check passed"
        
        echo ""
        echo "Running wheel contents check..."
        check-wheel-contents dist/*.whl || {
          echo "Wheel contents check found issues (non-critical)"
        }

    - name: Display package info
      run: |
        echo "Package information:"
        echo ""
        
        for file in dist/*; do
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "$(basename $file)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [[ $file == *.whl ]]; then
            echo "Type: Wheel Distribution"
            echo "Size: $(du -h $file | cut -f1)"
            echo ""
            echo "Contents (first 30 files):"
            python -m zipfile -l "$file" | head -30
          elif [[ $file == *.tar.gz ]]; then
            echo "Type: Source Distribution"
            echo "Size: $(du -h $file | cut -f1)"
            echo ""
            echo "Contents (first 30 files):"
            tar -tzf "$file" 2>/dev/null | head -30
          fi
          echo ""
        done

    - name: Test wheel installation in isolated environment
      run: |
        echo "Testing wheel installation in isolated environment..."
        
        # Create a temporary virtual environment
        python -m venv test_env
        source test_env/bin/activate
        
        echo "Installing wheel..."
        pip install --upgrade pip
        pip install dist/*.whl || {
          echo "Wheel installation failed"
          deactivate
          exit 1
        }
        
        echo "Testing imports..."
        python -c "import downloader; print('OK: downloader')" || {
          echo "Cannot import downloader"
          deactivate
          exit 1
        }
        
        python -c "from plugins import get_global_registry; print('OK: plugins')" || {
          echo "Cannot import plugins"
          deactivate
          exit 1
        }
        
        echo "Testing CLI..."
        tubetracks --version || {
          echo "CLI command failed"
          deactivate
          exit 1
        }
        
        deactivate
        rm -rf test_env
        
        echo "Wheel installation test passed"

    - name: Upload distribution artifacts
      uses: actions/upload-artifact@v4
      with:
        name: python-package-distributions
        path: dist/
        retention-days: 30
        if-no-files-found: error
      
    - name: Upload build logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-package-debug-logs
        path: |
          pyproject.toml
          setup.py
          build/
          *.egg-info/
        retention-days: 7
        if-no-files-found: ignore

  test-gui:
    name: Test GUI Components on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    needs: [build]
    timeout-minutes: 10
    
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION_DEFAULT }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION_DEFAULT }}
        cache: 'pip'

    - name: Install dependencies
      shell: bash
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Install tkinter (Ubuntu only)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-tk

    - name: Test GUI module import
      shell: bash
      run: |
        echo "Testing GUI module import..."
        python -c "import tubetracks_gui; print('OK: GUI module loaded')" || echo "GUI module import failed (tkinter may not be available)"
      continue-on-error: true

    - name: Test GUI help/version
      shell: bash
      run: |
        echo "Testing GUI help..."
        python tubetracks_gui.py --help || echo "GUI help not available"
      continue-on-error: true

    - name: Validate GUI file structure
      shell: bash
      run: |
        echo "Validating GUI components..."
        test -f tubetracks_gui.py || (echo "tubetracks_gui.py not found" && exit 1)
        grep -q "class App" tubetracks_gui.py || (echo "App class not found" && exit 1)
        grep -q "def main" tubetracks_gui.py || (echo "main function not found" && exit 1)
        echo "GUI structure validated"

  test-install:
    name: Test Package Installation
    runs-on: ${{ matrix.os }}
    needs: [build-package]
    timeout-minutes: 10
    
    env:
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: 1
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    
    steps:
    - name: Checkout code (for verification)
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION_DEFAULT }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION_DEFAULT }}

    - name: Download distribution artifacts
      uses: actions/download-artifact@v4
      with:
        name: python-package-distributions
        path: dist/

    - name: Display downloaded files
      shell: bash
      run: |
        echo "Downloaded distributions:"
        ls -lh dist/
        echo ""
        echo "File details:"
        for file in dist/*; do
          echo "  - $(basename $file): $(du -h $file | cut -f1)"
        done

    - name: Verify distributions downloaded
      shell: bash
      run: |
        if [ ! -d dist ] || [ -z "$(ls -A dist)" ]; then
          echo "ERROR: No distribution files found"
          echo "The dist/ directory is empty or does not exist"
          exit 1
        fi
        
        WHEEL_COUNT=$(ls -1 dist/*.whl 2>/dev/null | wc -l)
        if [ "$WHEEL_COUNT" -eq 0 ]; then
          echo "ERROR: No wheel file found"
          exit 1
        fi
        
        echo "Distribution files verified"

    - name: Install from wheel
      shell: bash
      run: |
        echo "Installing from wheel..."
        pip install --upgrade pip setuptools wheel
        
        echo "Installing package..."
        pip install dist/*.whl --verbose || {
          echo "Installation failed"
          echo ""
          echo "Diagnostic information:"
          echo "Python: $(python --version)"
          echo "pip: $(pip --version)"
          echo ""
          echo "Available wheels:"
          ls -la dist/*.whl
          exit 1
        }
        
        echo ""
        echo "Installation successful"
        echo ""
        echo "ðŸ“‹ Installed packages:"
        pip list | grep -i "tubetracks\|yt-dlp\|rich" || pip list

    - name: Verify package files installed
      shell: bash
      run: |
        echo "Verifying installed files..."
        
        # Check if module can be found
        python -c "import sys; import downloader; print(f'downloader location: {downloader.__file__}')" || {
          echo "downloader module not found in installation"
          echo ""
          echo "Python path:"
          python -c "import sys; print('\n'.join(sys.path))"
          exit 1
        }
        
        python -c "import sys; import plugins; print(f'plugins location: {plugins.__file__}')" || {
          echo "plugins module not found in installation"
          exit 1
        }
        
        echo "Package files verified"

    - name: Test installed CLI commands
      shell: bash
      run: |
        echo "Testing tubetracks command..."
        tubetracks --help || {
          echo "tubetracks command failed"
          echo ""
          echo "Checking if command exists:"
          which tubetracks || echo "Command not found in PATH"
          exit 1
        }
        
        tubetracks --version || {
          echo "tubetracks --version failed"
          exit 1
        }
        
        echo "tubetracks command working"
        echo ""

        echo "Testing audiodownload command..."
        audiodownload --help || {
          echo "audiodownload command failed"
          echo ""
          echo "Checking if command exists:"
          which audiodownload || echo "Command not found in PATH"
          exit 1
        }

        audiodownload --version || {
          echo "audiodownload --version failed"
          exit 1
        }

        echo "audiodownload command working"
        echo ""
        
        echo "Testing ytdl alias..."
        ytdl --help || {
          echo "ytdl command failed"
          which ytdl || echo "Command not found in PATH"
          exit 1
        }
        
        ytdl --version || {
          echo "ytdl --version failed"
          exit 1
        }
        
        echo "ytdl alias working"
        echo ""
        
        echo "Testing GUI command..."
        tubetracks-gui --help 2>&1 || {
          RESULT=$?
          if [ $RESULT -ne 0 ]; then
            echo "GUI command failed (may be expected without tkinter)"
            echo "GUI requires tkinter which may not be available in CI"
          fi
        }
        
        echo ""
        echo "All critical CLI commands working"

    - name: Test package imports
      shell: bash
      run: |
        echo "Testing Python imports..."
        
        python -c "import downloader; print('OK: downloader module')" || {
          echo "Cannot import downloader"
          exit 1
        }
        
        python -c "from plugins import get_global_registry; print('OK: plugins module')" || {
          echo "Cannot import plugins.get_global_registry"
          exit 1
        }
        
        python -c "import downloader; print(f'Version: {downloader.__version__}')" || {
          echo "Cannot access version information"
          exit 1
        }
        
        echo ""
        echo "Testing plugin system..."
        python -c "from plugins import get_global_registry; r=get_global_registry(); print(f'Loaded {len(r.list_plugins())} plugins')" || {
          echo "Plugin system not working"
          exit 1
        }
        
        echo ""
        echo "Package installation fully verified"

    - name: Test functional CLI operations
      shell: bash
      run: |
        echo "Testing CLI functionality..."
        
        # Test config display
        tubetracks --show-config || {
          echo "--show-config failed"
          exit 1
        }
        
        # Test plugin listing
        tubetracks --list-plugins || {
          echo "--list-plugins failed"
          exit 1
        }
        
        echo "Functional tests passed"
      continue-on-error: false

    - name: Upload installation logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: install-failure-logs-${{ matrix.os }}
        path: |
          ~/.cache/pip/
          pip-log.txt
        retention-days: 7
        if-no-files-found: ignore

  status-check:
    name: âœ… All Tests Passed
    if: always()
    needs: [lint, security, build, test-gui, build-package, test-install]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: Check all job statuses
      run: |
        echo "================================================"
        echo "           CI/CD Pipeline Status Report         "
        echo "================================================"
        echo ""
        echo "Job Results:"
        echo "  Lint:          ${{ needs.lint.result }}"
        echo "  Security:      ${{ needs.security.result }}"
        echo "  Build:         ${{ needs.build.result }}"
        echo "  GUI Tests:     ${{ needs.test-gui.result }}"
        echo "  Build Package: ${{ needs.build-package.result }}"
        echo "  Test Install:  ${{ needs.test-install.result }}"
        echo ""
        echo "================================================"
        
        # Check if any job was cancelled
        if [ "${{ needs.lint.result }}" == "cancelled" ] || \
           [ "${{ needs.security.result }}" == "cancelled" ] || \
           [ "${{ needs.build.result }}" == "cancelled" ] || \
           [ "${{ needs.test-gui.result }}" == "cancelled" ] || \
           [ "${{ needs.build-package.result }}" == "cancelled" ] || \
           [ "${{ needs.test-install.result }}" == "cancelled" ]; then
          echo "CANCELLED: One or more jobs were cancelled"
          echo ""
          echo "The workflow was stopped before completion."
          exit 1
        fi
        
        # Check required jobs
        if [ "${{ needs.build.result }}" != "success" ]; then
          echo "CRITICAL: Build job failed"
          echo "    The main build and test suite did not pass."
          echo "    Check the Build job logs for details."
          echo ""
        fi
        
        if [ "${{ needs.build-package.result }}" != "success" ]; then
          echo "CRITICAL: Build Package job failed"
          echo "    Unable to create distribution packages."
          echo "    Common causes:"
          echo "    â€¢ Missing or invalid pyproject.toml"
          echo "    â€¢ Missing required files (downloader.py, plugins/)"
          echo "    â€¢ Package structure issues"
          echo "    Check the Build Package job logs for details."
          echo ""
        fi
        
        if [ "${{ needs.test-install.result }}" != "success" ] && \
           [ "${{ needs.test-install.result }}" != "skipped" ]; then
          echo "CRITICAL: Test Install job failed"
          echo "    The package was built but cannot be installed or used."
          echo "    Common causes:"
          echo "    â€¢ Missing dependencies in package"
          echo "    â€¢ Incorrect entry points in pyproject.toml"
          echo "    â€¢ Module import errors"
          echo "    Check the Test Install job logs for details."
          echo ""
        fi
        
        # Check if required jobs failed
        if [ "${{ needs.build.result }}" != "success" ] || \
           [ "${{ needs.build-package.result }}" != "success" ] || \
           ([ "${{ needs.test-install.result }}" != "success" ] && \
            [ "${{ needs.test-install.result }}" != "skipped" ]); then
          echo "FAILED: One or more required jobs failed"
          echo ""
          echo "ðŸ“– Troubleshooting tips:"
          echo "  1. Check the failed job logs above"
          echo "  2. Run tests locally: make test"
          echo "  3. Verify package build: python -m build"
          echo "  4. Check imports: python -c 'import downloader'"
          echo ""
          echo "For detailed error messages, click on the failed jobs above."
          exit 1
        fi
        
        # Warn on optional job failures
        if [ "${{ needs.lint.result }}" == "failure" ]; then
          echo "WARNING: Linting issues detected"
          echo "    Run 'make format' to auto-fix style issues"
          echo "    Or run: black . && isort ."
          echo ""
        fi
        
        if [ "${{ needs.security.result }}" == "failure" ]; then
          echo "WARNING: Security scan detected potential issues"
          echo "    Review security reports for details"
          echo "    Run: bandit -r . && safety check"
          echo ""
        fi
        
        if [ "${{ needs.test-gui.result }}" == "failure" ]; then
          echo "WARNING: GUI tests had issues"
          echo "    This is often due to missing tkinter in CI"
          echo "    Test GUI locally if making GUI changes"
          echo ""
        fi
        
        echo ""
        echo "================================================"
        echo "SUCCESS: All required jobs passed!"
        echo "================================================"
        echo ""
        echo "ðŸŽ‰ The CI/CD pipeline completed successfully!"
        echo ""
        echo "Next steps:"
        echo "  â€¢ Package distributions are ready in artifacts"
        echo "  â€¢ Can be installed with: pip install dist/*.whl"
        echo "  â€¢ Ready for release or deployment"

    - name: Summary
      run: |
        echo "### ðŸŽ‰ CI/CD Pipeline Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Security | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| GUI Tests | ${{ needs.test-gui.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Package | ${{ needs.build-package.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Install | ${{ needs.test-install.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Add troubleshooting section if any job failed
        if [ "${{ needs.build.result }}" != "success" ] || \
           [ "${{ needs.build-package.result }}" != "success" ] || \
           ([ "${{ needs.test-install.result }}" != "success" ] && \
            [ "${{ needs.test-install.result }}" != "skipped" ]); then
          echo "## Failed Jobs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.build.result }}" != "success" ]; then
            echo "### Build" >> $GITHUB_STEP_SUMMARY
            echo "The main build and test suite failed. Check the Build job logs." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.build-package.result }}" != "success" ]; then
            echo "### Build Package" >> $GITHUB_STEP_SUMMARY
            echo "Package creation failed. Verify pyproject.toml and file structure." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.test-install.result }}" != "success" ] && \
             [ "${{ needs.test-install.result }}" != "skipped" ]; then
            echo "### Test Install" >> $GITHUB_STEP_SUMMARY
            echo "Package installation testing failed. Check entry points and imports." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "## ðŸ“– Troubleshooting" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the failed job logs for specific error messages" >> $GITHUB_STEP_SUMMARY
          echo "2. Run tests locally: \`make test\` or \`pytest tests/\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Build package locally: \`python -m build\`" >> $GITHUB_STEP_SUMMARY
          echo "4. Verify imports: \`python -c 'import downloader'\`" >> $GITHUB_STEP_SUMMARY
        else
          echo "## âœ… All Jobs Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The package is ready for use!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Distribution artifacts are available for download" >> $GITHUB_STEP_SUMMARY
          echo "- All tests passed across multiple platforms" >> $GITHUB_STEP_SUMMARY
          echo "- Package installation verified" >> $GITHUB_STEP_SUMMARY
        fi


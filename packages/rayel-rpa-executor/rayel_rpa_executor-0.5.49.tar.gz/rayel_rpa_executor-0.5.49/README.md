<p align="center">
  <a href="https://snailjob.opensnail.com">
   <img alt="snail-job-Logo" src="doc/images/favicon.svg" width="200px">
  </a>
</p>

<p align="center">
    ğŸ”¥ğŸ”¥ğŸ”¥ çµæ´»ï¼Œå¯é å’Œå¿«é€Ÿçš„åˆ†å¸ƒå¼ä»»åŠ¡é‡è¯•å’Œåˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦å¹³å° <br/>
</p>

<p align="center">

> âœ…ï¸ å¯é‡æ”¾ï¼Œå¯ç®¡æ§ã€ä¸ºæé«˜åˆ†å¸ƒå¼ä¸šåŠ¡ç³»ç»Ÿä¸€è‡´æ€§çš„åˆ†å¸ƒå¼ä»»åŠ¡é‡è¯•å¹³å° <br/>
> âœ…ï¸ æ”¯æŒç§’çº§ã€å¯ä¸­æ–­ã€å¯ç¼–æ’çš„é«˜æ€§èƒ½åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦å¹³å°
</p>

# ç®€ä»‹

> SnailJob æ˜¯ä¸€ä¸ªçµæ´»ã€å¯é ä¸”é«˜æ•ˆçš„åˆ†å¸ƒå¼ä»»åŠ¡é‡è¯•å’Œä»»åŠ¡è°ƒåº¦å¹³å°ã€‚å…¶æ ¸å¿ƒé‡‡ç”¨åˆ†åŒºæ¨¡å¼å®ç°ï¼Œå…·å¤‡é«˜åº¦å¯ä¼¸ç¼©æ€§å’Œå®¹é”™æ€§çš„åˆ†å¸ƒå¼ç³»ç»Ÿã€‚æ‹¥æœ‰å®Œå–„çš„æƒé™ç®¡ç†ã€å¼ºå¤§çš„å‘Šè­¦ç›‘æ§åŠŸèƒ½å’Œå‹å¥½çš„ç•Œé¢äº¤äº’ã€‚æ¬¢è¿å¤§å®¶æ¥å…¥å¹¶ä½¿ç”¨ã€‚

## snail-job-python

snail-job é¡¹ç›®çš„ python å®¢æˆ·ç«¯ã€‚[snail-jobé¡¹ç›® java åç«¯](https://gitee.com/aizuda/snail-job)

Snail Job Pythonå®¢æˆ·ç«¯ä¸»æ‰“çš„æ˜¯â€œåŸæ±åŸæ˜§â€, æ— éœ€åµŒå¥—åœ¨å…¶ä»–è¯­è¨€ç¯å¢ƒä¸­; å…·å¤‡ä¸SnailJobçš„Javaå®¢æˆ·ç«¯Jobæ¨¡å—ä¸€æ ·çš„èƒ½åŠ›åŒ…æ‹¬(é›†ç¾¤ã€å¹¿æ’­ã€é™æ€åˆ†ç‰‡ã€Mapã€MapReuceã€DAGå·¥ä½œæµã€å®æ—¶æ—¥å¿—ç­‰åŠŸèƒ½)ï¼Œè€Œ `xxl-job`ã€`PowerJob` ç­‰å…¶ä»–çš„ä»»åŠ¡è°ƒåº¦ç³»ç»Ÿéƒ½æ˜¯é€šè¿‡ Java å®¢æˆ·ç«¯ä½¿ç”¨ `Runtime` æ‰§è¡Œ `Python` è„šæœ¬, é‚£ä¹ˆä¼šæœ‰å¦‚ä¸‹å‡ ä¸ªé—®é¢˜ï¼š

1. éœ€è¦è¿è¡Œåœ¨Javaç¯å¢ƒä¸­,å³è€—å†…å­˜å’Œåˆæ˜¾å¾—ç¬¨é‡
2. ä¸æ–¹ä¾¿ç¼–å†™å¤æ‚çš„ Python è„šæœ¬
3. Java å®¢æˆ·ç«¯é€šè¿‡ Python å‘½ä»¤æ‰§è¡Œè„šæœ¬ï¼Œéœ€è¦ç³»ç»Ÿå…¨å±€å®‰è£…è„šæœ¬çš„ç¬¬ä¸‰æ–¹ä¾èµ–
4. ä»£ç å¯ç»´æŠ¤æ€§å’Œå¯è°ƒè¯•æ¯”è¾ƒå·®

Snail Job Python å®¢æˆ·ç«¯å¯ä»¥ç›´æ¥å¯¹æ¥ SnailJob æœåŠ¡å™¨ï¼Œå®ç°å®šæ—¶ä»»åŠ¡è°ƒåº¦ï¼Œå¹¶ä¸ŠæŠ¥æ—¥å¿—ã€‚Python å®¢æˆ·ç«¯å½“å‰ä»ä¸æ”¯æŒ`é‡è¯•ä»»åŠ¡`ï¼Œä¹Ÿæ²¡æœ‰æ”¯æŒè®¡åˆ’ã€‚

## å¼€å§‹ä½¿ç”¨

### åŸºäºæºç å¼€å‘

```shell
git clone https://gitee.com/opensnail/snail-job-python.git && cd snail-job-python
# å‚è€ƒé¡¹ç›®çš„ .env.example æ–‡ä»¶åˆ›å»º .env
cp .env.example .env
# å®‰è£…ä¾èµ–
pip install -e .
# å‚è€ƒ example ç›®å½•ç¤ºä¾‹ç¨‹åºç¼–å†™å®¢æˆ·ç«¯ä¸šåŠ¡ä»£ç 
cd example/
# å¯åŠ¨ç¨‹åº
python main.py
```

### Prometheus ç›‘æ§é›†æˆ

Snail Job Python å®¢æˆ·ç«¯ç°å·²é›†æˆ Prometheus ç›‘æ§åŸºç¡€åŠŸèƒ½ã€‚

#### åŠŸèƒ½ç‰¹æ€§

- **åŸºç¡€ç›‘æ§**: æä¾› `/actuator/prometheus` ç«¯ç‚¹ç”¨äº Prometheus æŠ“å–
- **å¥åº·æ£€æŸ¥**: æä¾› `/health` ç«¯ç‚¹ç”¨äºå¥åº·æ£€æŸ¥
- **å¯é…ç½®**: æ”¯æŒé€šè¿‡ç¯å¢ƒå˜é‡é…ç½®ç›‘æ§å‚æ•°
- **ä¸šåŠ¡ç›‘æ§**: å®ç°äº†å®Œæ•´çš„ä¸šåŠ¡æŒ‡æ ‡ç›‘æ§
  - æ‰§è¡Œçº¿ç¨‹æ± ç¼“å­˜ç›‘æ§ (`job_thread_pool_cache`)
  - ä»»åŠ¡æ‰§è¡Œæ—¶é•¿ç›‘æ§ (`job_task_client_execution_duration`)
  - ä»»åŠ¡è°ƒåº¦ç»“æœé”™è¯¯ç›‘æ§ (`job_dispatch_result_error`)
  - RPCè¯·æ±‚æ€»æ•°ç›‘æ§ (`rpc_request_total`)
  - gRPCæœåŠ¡å™¨çº¿ç¨‹æ± ç›‘æ§ (`grpc_server_pool_*`)

#### å¿«é€Ÿå¼€å§‹

1. **å¯ç”¨ç›‘æ§**ï¼ˆé»˜è®¤å·²å¯ç”¨ï¼‰:
```bash
# ç¯å¢ƒå˜é‡é…ç½®
SNAIL_PROMETHEUS_ENABLED=true
SNAIL_PROMETHEUS_PORT=9090
SNAIL_PROMETHEUS_HOST=0.0.0.0
```

2. **è®¿é—®æŒ‡æ ‡**:
   - Metrics ç«¯ç‚¹: `http://localhost:8020/actuator/prometheus`
   - å¥åº·æ£€æŸ¥: `http://localhost:8020/health`

3. **Prometheus é…ç½®**:
```yaml
scrape_configs:
  - job_name: 'snail-job'
    static_configs:
      - targets: ['localhost:8020']
    metrics_path: '/actuator/prometheus'
    scrape_interval: 15s
```

> tip: å¯ä»¥ä½¿ç”¨ uv run --with çš„æ–¹å¼è¿è¡Œ:
>
> `uv run --with=snail-job-python main.py`

ç™»å½•åå°ï¼Œèƒ½çœ‹åˆ°å¯¹åº”host-id ä¸º `py-xxxxxx` çš„å®¢æˆ·ç«¯

**æ³¨æ„: snail-job-python æ”¯æŒ `pip` åŒ…å®‰è£…ï¼ŒåŒ…åä¸º`snail-job-python`**

### ç¤ºä¾‹

#### å®šæ—¶ä»»åŠ¡

```python
import snailjob as sj

@sj.job("testJobExecutor")                                      # 1. testJobExecutor ä¸ºæ‰§è¡Œå™¨åç§°
def test_job_executor(args: sj.JobArgs) -> sj.ExecuteResult:
    sj.SnailLog.REMOTE.info(f"job_params: {args.job_params}")
    return sj.ExecuteResult.success()                           # 2. è¿”å›æ‰§è¡Œç»“æœ

if __name__ == "__main__":
    sj.ExecutorManager.register(test_job_executor)              # 3. æ³¨å†Œæ‰§è¡Œå™¨
    sj.client_main()                                            # 4. æ‰§è¡Œå®¢æˆ·ç«¯ä¸»å‡½æ•°
```

æ–°å»ºå®šæ—¶ä»»åŠ¡, æ‰§è¡Œå™¨ç±»å‹é€‰æ‹©ã€Pythonã€‘ï¼Œæ‰§è¡Œå™¨åç§°å¡«å…¥ã€testJobExecutorã€‘

#### åŠ¨æ€åˆ†ç‰‡

```python
import snailjob as sj

testMyMapExecutor = sj.MapExecutor("testMyMapExecutor")         # 1. å®šä¹‰ MapExecutor å˜é‡

@testMyMapExecutor.map()                                        # 2. å®šä¹‰ ROOT_MAP é˜¶æ®µä»»åŠ¡
def testMyMapExecutor_rootMap(args: sj.MapArgs):
    assert args.task_name == sj.ROOT_MAP
    return sj.ExecuteResult.success("TWO_MAP")


@testMyMapExecutor.map("TWO_MAP")                               # 3. å®šä¹‰ TWO_MAP é˜¶æ®µä»»åŠ¡
def testMyMapExecutor_twoMap(args: sj.MapArgs):
    return sj.ExecuteResult.success(args.map_result)


if __name__ == "__main__":
    sj.ExecutorManager.register(testMyMapExecutor)              # 4. æ³¨å†Œæ‰§è¡Œå™¨
    sj.client_main()     
```

#### MapReduce

```python
import snailjob as sj

testMapReduceJobExecutor = sj.MapReduceExecutor("testMapReduceJobExecutor")     # 1. å®šä¹‰ MapReduceExecutor å˜é‡


@testMapReduceJobExecutor.map()                                                 # 2. å®šä¹‰ ROOT_MAP é˜¶æ®µä»»åŠ¡
def testMapReduceJobExecutor_rootMap(args: sj.MapArgs):
    return sj.ExecuteResult.success("MONTH_MAP")                                # 3. ä¸ŠæŠ¥åˆ†ç‰‡ä¿¡æ¯


@testMapReduceJobExecutor.map("MONTH_MAP")                                      # 4. å®šä¹‰ ROOT_MAP é˜¶æ®µä»»åŠ¡
def testMapReduceJobExecutor_monthMap(args: sj.MapArgs):
    return sj.ExecuteResult.success(int(args.map_result) * 2)


@testMapReduceJobExecutor.reduce()                                              # 5. å®šä¹‰ reduce é˜¶æ®µä»»åŠ¡
def testMapReduceJobExecutor_reduce(args: sj.ReduceArgs):
    return sj.ExecuteResult.success(sum([int(x) for x in args.map_result]))


@testMapReduceJobExecutor.merge()                                               # 6. å®šä¹‰ merge é˜¶æ®µä»»åŠ¡
def testMapReduceJobExecutor_merge(args: sj.MergeReduceArgs):
    return sj.ExecuteResult.success(sum([int(x) for x in args.reduces]))


if __name__ == "__main__":
    sj.ExecutorManager.register(testMapReduceJobExecutor)                       # 7. æ³¨å†Œæ‰§è¡Œå™¨
    sj.client_main()   
```

#### å“åº”åœæ­¢äº‹ä»¶

```python
@sj.job("testJobExecutor")
def test_job_executor(args: sj.JobArgs) -> sj.ExecuteResult:
    for i in range(40):
        if sj.ThreadPoolCache.event_is_set(args.task_batch_id):     # 1. åˆ¤æ–­å½“å‰ä»»åŠ¡æ‰¹æ¬¡æ˜¯å¦è¢«ç»ˆæ­¢
            sj.SnailLog.REMOTE.info("ä»»åŠ¡å·²ç»è¢«ä¸­æ–­ï¼Œç«‹å³è¿”å›")
            return sj.ExecuteResult.failure()
        time.sleep(1)

    return sj.ExecuteResult.success()
```

#### å·¥ä½œæµã€é™æ€åˆ†ç‰‡ä¸æ™®é€šå®šæ—¶ä»»åŠ¡ç±»ä¼¼ï¼Œä¸åšèµ˜è¿°

### gRPC

å¼€å‘è€…å·¥å…·

```shell
python -m grpc_tools.protoc \
    --python_out=. \
    --grpc_python_out=. \
    --proto_path=. \
    snailjob/grpc/snailjob.proto
```

### å¼€å‘ç¯å¢ƒ

#### pre-commit

é¡¹ç›®ä½¿ç”¨ [ruff-pre-commit](https://github.com/astral-sh/ruff-pre-commit)

é€šè¿‡å¦‚ä¸‹å‘½ä»¤å®‰è£…hookï¼š

```shell
uv sync
uv run pre-commit install
```

#### æœ¬åœ°å¼€å‘éªŒè¯

```shell
cd example && uv run --with=.. main.py
```

#### åŸºäº Docker å¼€å‘ç¯å¢ƒ

è¯¦è§ `Dockerfile.dev` æ–‡ä»¶

## é…ç½®

è¯¦è§ [CONFIGURATION.md](CONFIGURATION.md)

## Change Log

è¯¦è§ [CHANGELOG.md](CHANGELOG.md)
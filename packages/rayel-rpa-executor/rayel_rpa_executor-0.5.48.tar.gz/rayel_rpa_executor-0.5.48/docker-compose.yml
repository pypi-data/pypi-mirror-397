
services:
  snail-job-executor:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: snail-job-executor
    working_dir: /app
    ports:
      - "${SNAIL_HOST_PORT}:${SNAIL_HOST_PORT}"
      - "${SNAIL_PROMETHEUS_PORT}:${SNAIL_PROMETHEUS_PORT}"  # 客户端监控端口
      - "${SNAIL_FASTAPI_PORT}:8000"  # FastAPI 服务端口（客户端文件下载服务使用）

    # 环境变量配置
    environment:
      # Git 配置（必需）
      - GIT_REPO_URL=${GIT_REPO_URL}
      - GIT_TOKEN=${GIT_TOKEN}

      # 服务端
      - SNAIL_SERVER_HOST=${SNAIL_SERVER_HOST}
      - SNAIL_SERVER_PORT=${SNAIL_SERVER_PORT}

      # 当前客户端配置信息
      # 版本号
      - SNAIL_VERSION=${SNAIL_VERSION}
      - SNAIL_NAMESPACE=${SNAIL_NAMESPACE}
      - SNAIL_GROUP_NAME=${SNAIL_GROUP_NAME}
      - SNAIL_TOKEN=${SNAIL_TOKEN}
      - SNAIL_HOST_IP=${SNAIL_HOST_IP}
      - SNAIL_HOST_PORT=${SNAIL_HOST_PORT}

      # 日志配置
      - LOG_ENV=${LOG_ENV:-remote}
      - SNAIL_LOG_LEVEL=${SNAIL_LOG_LEVEL:-INFO}
      - SNAIL_LOG_FORMAT=${SNAIL_LOG_FORMAT:-"%(asctime)s | %(name)-22s | %(levelname)-8s | %(message)s"}
      - SNAIL_LOG_LOCAL_FILENAME=${SNAIL_LOG_LOCAL_FILENAME:-log/snailjob.log}
      - SNAIL_LOG_LOCAL_BACKUP_COUNT=${SNAIL_LOG_LOCAL_BACKUP_COUNT:-60}
      - SNAIL_LOG_REMOTE_INTERVAL=${SNAIL_LOG_REMOTE_INTERVAL:-10}
      - SNAIL_LOG_REMOTE_BUFFER_SIZE=${SNAIL_LOG_REMOTE_BUFFER_SIZE:-1000}
      - SNAIL_LOG_REMOTE_BATCH_SIZE=${SNAIL_LOG_REMOTE_BATCH_SIZE:-20}

      # 使用 gRPC 通讯
      - SNAIL_USE_GRPC=${SNAIL_USE_GRPC}

      # 业务配置
      - SNAIL_LABELS=${SNAIL_LABELS:-env:dev,app:demo}

      # Prometheus 监控配置
      - SNAIL_PROMETHEUS_ENABLED=${SNAIL_PROMETHEUS_ENABLED}
      - SNAIL_PROMETHEUS_PORT=${SNAIL_PROMETHEUS_PORT}
      - SNAIL_PROMETHEUS_HOST=${SNAIL_PROMETHEUS_HOST}

      # API 鉴权配置
      - API_KEY=${API_KEY}
      - EXTRA_API_KEYS=${EXTRA_API_KEYS}

    # 挂载卷（持久化工作目录）
    volumes:
      - ./workspace:/app/workspace  # 改为宿主机目录，方便查看和备份
      - ./logs:/app/logs  # 可选：挂载日志目录
      - ./data:/app/data
      
      # uv 缓存挂载（大幅提升安装速度）
      - ~/.cache/uv:/root/.cache/uv
      
      # 项目文件挂载（开发模式）
      # 挂载后可以直接修改宿主机文件，重启容器即可生效，无需重新构建镜像
      - ./executor:/app/executor          # 执行器核心模块
      - ./snailjob:/app/snailjob          # SnailJob 客户端模块
      - ./main.py:/app/main.py            # 启动文件
      - ./setup.py:/app/setup.py          # 安装配置文件
      
      # SSH key 挂载（用于 SSH 方式访问 Git 仓库）
      # 注意：确保宿主机存在 ~/.ssh/id_rsa 文件，且已添加到 GitHub/GitLab
      - ~/.ssh/id_rsa:/root/.ssh/id_rsa:ro  # 只读挂载私钥
      - ~/.ssh/id_rsa.pub:/root/.ssh/id_rsa.pub:ro  # 可选：只读挂载公钥

    restart: unless-stopped

    # 网络配置
    networks:
      - snail-job-network
    
    # DNS 配置（解决 GitHub 访问问题）
    dns:
      - 8.8.8.8         # Google DNS
      - 223.5.5.5       # 阿里云 DNS
      - 114.114.114.114 # 114 DNS

    # 资源限制（可选）
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '2'
    #       memory: 2G
    #     reservations:
    #       cpus: '0.5'
    #       memory: 512M

    # 日志配置
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# 定义网络（不再需要定义 volumes，因为使用宿主机目录映射）
# volumes:
#   rpa-workspace:
#     driver: local

# 定义网络
networks:
  snail-job-network:
    external: true

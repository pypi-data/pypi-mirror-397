# TUI å¸ƒå±€æ¶æ„

## 1. Identity

- **What it is:** MiniCC ç»ˆç«¯ç”¨æˆ·ç•Œé¢çš„æ•´ä½“å¸ƒå±€å’Œç»„ä»¶ç»„ç»‡
- **Purpose:** ä¸ºç”¨æˆ·æä¾›æ¸…æ™°ã€é«˜æ•ˆçš„èŠå¤©äº¤äº’ç•Œé¢

## 2. æ•´ä½“å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Header (MiniCC æ—¶é’Ÿ)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     chat_container (VerticalScroll)  â”‚
â”‚  â”œâ”€ MessagePanel (ç”¨æˆ·/åŠ©æ‰‹æ¶ˆæ¯)    â”‚
â”‚  â”œâ”€ ToolCallLine (å·¥å…·è°ƒç”¨å•è¡Œ)     â”‚
â”‚  â”œâ”€ SubAgentLine (SubAgent å•è¡Œ)   â”‚
â”‚  â””â”€ (æµå¼åŠ©æ‰‹è¾“å‡ºé¢æ¿)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     TodoDisplay (ä»»åŠ¡åˆ—è¡¨ï¼Œå¯éšè—)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ask_user_container (é—®ç­”é¢æ¿å®¹å™¨)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     Input (ç”¨æˆ·è¾“å…¥æ¡†ï¼Œç„¦ç‚¹)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“¦ Model â”‚ ğŸ“ CWD â”‚ ğŸŒ¿ Branch â”‚ Tokenâ”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Footer (å¿«æ·é”®: Ctrl+Cé€€å‡º, Ctrl+Læ¸…å±)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 3. æ ¸å¿ƒç»„ä»¶

### Header
æ˜¾ç¤ºåº”ç”¨æ ‡é¢˜å’Œå®æ—¶æ—¶é’Ÿã€‚Textual å†…ç½®ç»„ä»¶ï¼Œæ— éœ€è‡ªå®šä¹‰ã€‚

### chat_container (VerticalScroll)
**æ–‡ä»¶:** `minicc/tui/app.py` (`VerticalScroll`)

ä¸»æ¶ˆæ¯åŒºåŸŸï¼ŒåŒ…å«ï¼š
- `MessagePanel`: ç”¨æˆ·/åŠ©æ‰‹æ¶ˆæ¯ï¼ˆæ”¯æŒ Markdownï¼‰
- `ToolCallLine`: å·¥å…·è°ƒç”¨å•è¡Œæ˜¾ç¤ºï¼ˆ`ğŸ”§ name (param) ğŸ”„/âœ…/âŒ`ï¼‰
- `SubAgentLine`: SubAgent ä»»åŠ¡å•è¡Œæ˜¾ç¤ºï¼ˆ`ğŸ¤– prompt â³/ğŸ”„/âœ…/âŒ`ï¼‰

æ¶ˆæ¯è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°ã€‚æ»šåŠ¨ä½¿ç”¨ `call_after_refresh(scroll_end)`ï¼Œé¿å…â€œå…ˆæ»šåŠ¨åå¸ƒå±€â€å¯¼è‡´çœ‹ä¸åˆ°æœ€åä¸€è¡Œã€‚

### Input
ç”¨æˆ·è¾“å…¥æ¡†ï¼Œæäº¤æ—¶è§¦å‘ `on_input_submitted` äº‹ä»¶ã€‚

### BottomBar
**æ–‡ä»¶:** `minicc/tui/widgets.py` (BottomBar ç»„ä»¶)

åˆ†åŒºå—æ˜¾ç¤ºï¼š
- `ğŸ“¦ æ¨¡å‹`: provider:model
- `ğŸ“ ç›®å½•`: å½“å‰ cwd
- `ğŸŒ¿ åˆ†æ”¯`: git åˆ†æ”¯å
- `â†‘â†“ Token`: è¾“å…¥/è¾“å‡º token æ•°ï¼ˆä½¿ç”¨é€šç”¨å­—ç¬¦ï¼Œé¿å…ç»ˆç«¯ emoji å®½åº¦é—®é¢˜ï¼‰

å®æ—¶æ›´æ–°ï¼Œä¸å¯æŠ˜å ã€‚

### Footer
æ˜¾ç¤ºå¿«æ·é”®åˆ—è¡¨ã€‚Textual å†…ç½®ç»„ä»¶ã€‚

## 4. æ¶ˆæ¯æµå¤„ç†

æ¶ˆæ¯å¤„ç†é“¾ï¼š
```
Input.Submitted
  â†’ _process_message(user_input)
    â†’ agent.run_stream_events() [å¼‚æ­¥æµå¤„ç†]
      â†’ PartStartEvent â†’ å¼€å§‹æµå¼è¾“å‡º
      â†’ PartDeltaEvent â†’ ç´¯ç§¯ text delta
      â†’ Function/Builtin ToolCallEvent â†’ ç”Ÿæˆ ToolCallLine(running)
      â†’ Function/Builtin ToolResultEvent â†’ æ›´æ–° ToolCallLine(completed/failed)
      â†’ æœ€ç»ˆäº‹ä»¶ (AgentRunResultEvent)
         â†’ _update_tokens() [æ›´æ–° BottomBar token]
         â†’ ç»“æŸæµå¼è¾“å‡ºå¹¶å›ºåŒ– MessagePanel
  â†’ å¸ƒå±€åˆ·æ–°åæ»šåŠ¨åˆ°åº•éƒ¨
```

å…³é”®æ–¹æ³•ï¼š
- `_process_message()` (`minicc/tui/app.py`): æ¶ˆæ¯å¤„ç†å…¥å£ï¼ˆå«å·¥å…·äº‹ä»¶é‡‡é›†ï¼‰
- `_consume_events()` (`minicc/tui/app.py`): æ¶ˆè´¹äº‹ä»¶æ€»çº¿ï¼ˆtodo/ask_user/subagentï¼‰
- `_scroll_chat_end()` (`minicc/tui/app.py`): å¸ƒå±€åæ»šåŠ¨åˆ°åº•éƒ¨

## 5. å¿«æ·é”®

| å¿«æ·é”® | åŠŸèƒ½ |
|--------|------|
| Ctrl+C | é€€å‡ºåº”ç”¨ |
| Ctrl+L | æ¸…å±å¹¶é‡ç½® |
| Escape | å–æ¶ˆå½“å‰æ“ä½œ |

## 6. è®¾è®¡æ¼”è¿›

### v0.x (åˆç‰ˆ)
- æ°´å¹³å¸ƒå±€: chat_container + side_panel
- ä¾§è¾¹æ æ˜¾ç¤º: StatusBar + info_card + TabbedContent
- å¯æŠ˜å é¢æ¿: CollapsibleToolPanel / SubAgentPanel

### v0.3.0 (å½“å‰)
- çºµå‘å¸ƒå±€: Header â†’ chat_container â†’ TodoDisplay â†’ ask_user_container â†’ Input â†’ BottomBar â†’ Footer
- **äº‹ä»¶é©±åŠ¨**ï¼šå·¥å…·è°ƒç”¨è¡Œç”± stream events ç›´æ¥é©±åŠ¨ï¼Œä¸å†ä¾èµ– tools å†…éƒ¨å›è°ƒ
- **æµå¼åŠ©æ‰‹è¾“å‡º**ï¼šè¾¹ç”Ÿæˆè¾¹æ›´æ–° MessagePanelï¼Œå¹¶ä¿æŒæ»šåŠ¨åœ¨åº•éƒ¨
- **å­ä»»åŠ¡è¯­ä¹‰**ï¼š`task(wait=True)` é»˜è®¤ç­‰å¾…å¹¶è¿”å›ç»“æœï¼›å¯å¹¶è¡Œå¯åŠ¨å `wait_subagents` æ±‡æ€»ç­‰å¾…

### è®¾è®¡ä¼˜åŠ¿
- **è§†è§‰æ¸…æ´:** ç§»é™¤å†—ä½™ä¿¡æ¯å’Œå¯æŠ˜å äº¤äº’
- **ä¿¡æ¯å¯†åº¦é«˜:** BottomBar åœ¨ä¸€è¡Œå†…æ˜¾ç¤º 4 é¡¹å…³é”®ä¿¡æ¯
- **ç©ºé—´åˆ©ç”¨ç‡:** èŠå¤©åŒºåŸŸå®½åº¦å¢åŠ  ~30-40%
- **äº¤äº’ç®€åŒ–:** æ¶ˆæ¯ä¸å·¥å…·è°ƒç”¨å†…è”ï¼Œæ— éœ€åˆ‡æ¢ Tab

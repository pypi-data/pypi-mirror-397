"use strict";(self.webpackChunk_jupytergis_jupytergis_core=self.webpackChunk_jupytergis_jupytergis_core||[]).push([[211],{11211(e,t,n){function r(e,t){for(let n=0;n<t.length;n+=1e4)e.push(...t.slice(n,n+1e4))}function o(e,t){return e===t||(e instanceof Uint8Array&&t instanceof Uint8Array?o(Array.from(e),Array.from(t)):!(!e||!t||typeof e!=typeof t)&&(Array.isArray(e)&&Array.isArray(t)?e.length===t.length&&e.every((e,n)=>o(e,t[n])):"object"==typeof e&&Object.keys(e).length===Object.keys(t).length&&Object.keys(e).every(n=>o(e[n],t[n]))))}async function i({url:e,byteLength:t,requestInit:n,fetch:r}){if(!e)throw new Error("missing url");const o=r??globalThis.fetch;let i;t||=await async function(e,t,n){const r=n??globalThis.fetch;return await r(e,{...t,method:"HEAD"}).then(e=>{if(!e.ok)throw new Error(`fetch head failed ${e.status}`);const t=e.headers.get("Content-Length");if(!t)throw new Error("missing content length");return parseInt(t)})}(e,n,o);const f=n||{};return{byteLength:t,async slice(t,n){if(i)return i.then(e=>e.slice(t,n));const r=new Headers(f.headers),s=void 0===n?"":n-1;r.set("Range",`bytes=${t}-${s}`);const a=await o(e,{...f,headers:r});if(!a.ok||!a.body)throw new Error(`fetch failed ${a.status}`);if(200===a.status)return i=a.arrayBuffer(),i.then(e=>e.slice(t,n));if(206===a.status)return a.arrayBuffer();throw new Error(`fetch received unexpected status code ${a.status}`)}}}function f(e){if(!e)return[];if(1===e.length)return e[0];const t=[];for(const n of e)r(t,n);return t}n.d(t,{asyncBufferFromUrl:()=>i,toGeoJson:()=>ue});const s=["BOOLEAN","INT32","INT64","INT96","FLOAT","DOUBLE","BYTE_ARRAY","FIXED_LEN_BYTE_ARRAY"],a=["PLAIN","GROUP_VAR_INT","PLAIN_DICTIONARY","RLE","BIT_PACKED","DELTA_BINARY_PACKED","DELTA_LENGTH_BYTE_ARRAY","DELTA_BYTE_ARRAY","RLE_DICTIONARY","BYTE_STREAM_SPLIT"],l=["REQUIRED","OPTIONAL","REPEATED"],c=["UTF8","MAP","MAP_KEY_VALUE","LIST","ENUM","DECIMAL","DATE","TIME_MILLIS","TIME_MICROS","TIMESTAMP_MILLIS","TIMESTAMP_MICROS","UINT_8","UINT_16","UINT_32","UINT_64","INT_8","INT_16","INT_32","INT_64","JSON","BSON","INTERVAL"],u=["UNCOMPRESSED","SNAPPY","GZIP","LZO","BROTLI","LZ4","ZSTD","LZ4_RAW"],d=["DATA_PAGE","INDEX_PAGE","DICTIONARY_PAGE","DATA_PAGE_V2"],_={timestampFromMilliseconds:e=>new Date(Number(e)),timestampFromMicroseconds:e=>new Date(Number(e/1000n)),timestampFromNanoseconds:e=>new Date(Number(e/1000000n)),dateFromDays:e=>new Date(864e5*e)};function p(e,t,n,r){if(t&&n.endsWith("_DICTIONARY")){let n=e;e instanceof Uint8Array&&!(t instanceof Uint8Array)&&(n=new t.constructor(e.length));for(let r=0;r<e.length;r++)n[r]=t[e[r]];return n}return h(e,r)}function h(e,t){const{element:n,parsers:r,utf8:o=!0}=t,{type:i,converted_type:f,logical_type:s}=n;if("DECIMAL"===f){const t=10**-(n.scale||0),r=new Array(e.length);for(let n=0;n<r.length;n++)e[0]instanceof Uint8Array?r[n]=y(e[n])*t:r[n]=Number(e[n])*t;return r}if(!f&&"INT96"===i){const t=new Array(e.length);for(let n=0;n<t.length;n++)t[n]=r.timestampFromNanoseconds(w(e[n]));return t}if("DATE"===f){const t=new Array(e.length);for(let n=0;n<t.length;n++)t[n]=r.dateFromDays(e[n]);return t}if("TIMESTAMP_MILLIS"===f){const t=new Array(e.length);for(let n=0;n<t.length;n++)t[n]=r.timestampFromMilliseconds(e[n]);return t}if("TIMESTAMP_MICROS"===f){const t=new Array(e.length);for(let n=0;n<t.length;n++)t[n]=r.timestampFromMicroseconds(e[n]);return t}if("JSON"===f){const t=new TextDecoder;return e.map(e=>JSON.parse(t.decode(e)))}if("BSON"===f)throw new Error("parquet bson not supported");if("INTERVAL"===f)throw new Error("parquet interval not supported");if("UTF8"===f||"STRING"===s?.type||o&&"BYTE_ARRAY"===i){const t=new TextDecoder,n=new Array(e.length);for(let r=0;r<n.length;r++)n[r]=e[r]&&t.decode(e[r]);return n}if("UINT_64"===f||"INTEGER"===s?.type&&64===s.bitWidth&&!s.isSigned){if(e instanceof BigInt64Array)return new BigUint64Array(e.buffer,e.byteOffset,e.length);const t=new BigUint64Array(e.length);for(let n=0;n<t.length;n++)t[n]=BigInt(e[n]);return t}if("UINT_32"===f||"INTEGER"===s?.type&&32===s.bitWidth&&!s.isSigned){if(e instanceof Int32Array)return new Uint32Array(e.buffer,e.byteOffset,e.length);const t=new Uint32Array(e.length);for(let n=0;n<t.length;n++)t[n]=e[n];return t}if("FLOAT16"===s?.type)return Array.from(e).map(g);if("TIMESTAMP"===s?.type){const{unit:t}=s;let n=r.timestampFromMilliseconds;"MICROS"===t&&(n=r.timestampFromMicroseconds),"NANOS"===t&&(n=r.timestampFromNanoseconds);const o=new Array(e.length);for(let t=0;t<o.length;t++)o[t]=n(e[t]);return o}return e}function y(e){let t=0;for(const n of e)t=256*t+n;const n=8*e.length;return t>=2**(n-1)&&(t-=2**n),t}function w(e){return 86400000000000n*((e>>64n)-2440588n)+(0xffffffffffffffffn&e)}function g(e){if(!e)return;const t=e[1]<<8|e[0],n=t>>15?-1:1,r=t>>10&31,o=1023&t;return 0===r?n*2**-14*(o/1024):31===r?o?NaN:n*(1/0):n*2**(r-15)*(1+o/1024)}function m(e,t,n){const r=e[t],o=[];let i=1;if(r.num_children)for(;o.length<r.num_children;){const r=e[t+i],f=m(e,t+i,[...n,r.name]);i+=f.count,o.push(f)}return{count:i,element:r,children:o,path:n}}function A(e,t){let n=m(e,0,[]);const r=[n];for(const e of t){const o=n.children.find(t=>t.element.name===e);if(!o)throw new Error(`parquet schema element not found: ${t}`);r.push(o),n=o}return r}function E(e){let t=0;for(const{element:n}of e)"REPEATED"===n.repetition_type&&t++;return t}function I(e){let t=0;for(const{element:n}of e.slice(1))"REQUIRED"!==n.repetition_type&&t++;return t}function b(e){let t=0;const n={};for(;e.offset<e.view.byteLength;){const[r,o,i]=R(e,t);if(t=i,0===r)break;n[`field_${o}`]=v(e,r)}return n}function v(e,t){switch(t){case 1:return!0;case 2:return!1;case 3:return e.view.getInt8(e.offset++);case 4:case 5:return function(e){const t=T(e);return t>>>1^-(1&t)}(e);case 6:return N(e);case 7:{const t=e.view.getFloat64(e.offset,!0);return e.offset+=8,t}case 8:{const t=T(e),n=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,t);return e.offset+=t,n}case 9:{const[t,n]=function(e){const t=e.view.getUint8(e.offset++),n=t>>4,r=L(t);return 15===n?[r,T(e)]:[r,n]}(e),r=1===t||2===t,o=new Array(n);for(let i=0;i<n;i++)o[i]=r?1===v(e,3):v(e,t);return o}case 12:{const t={};let n=0;for(;;){let r,o;if([r,o,n]=R(e,n),0===r)break;t[`field_${o}`]=v(e,r)}return t}default:throw new Error(`thrift unhandled type: ${t}`)}}function T(e){let t=0,n=0;for(;;){const r=e.view.getUint8(e.offset++);if(t|=(127&r)<<n,!(128&r))return t;n+=7}}function N(e){const t=function(e){let t=0n,n=0n;for(;;){const r=e.view.getUint8(e.offset++);if(t|=BigInt(127&r)<<n,!(128&r))return t;n+=7n}}(e);return t>>1n^-(1n&t)}function L(e){return 15&e}function R(e,t){const n=e.view.getUint8(e.offset++);if(!(15&n))return[0,0,t];const r=n>>4;let o;if(!r)throw new Error("non-delta field id not supported");return o=t+r,[L(n),o,o]}async function O(e,{parsers:t,initialFetchSize:n=524288}={}){if(!(e&&e.byteLength>=0))throw new Error("parquet expected AsyncBuffer");const r=Math.max(0,e.byteLength-n),o=await e.slice(r,e.byteLength),i=new DataView(o);if(827474256!==i.getUint32(o.byteLength-4,!0))throw new Error("parquet file invalid (footer != PAR1)");const f=i.getUint32(o.byteLength-8,!0);if(f>e.byteLength-8)throw new Error(`parquet metadata length ${f} exceeds available buffer ${e.byteLength-8}`);if(f+8>n){const n=e.byteLength-f-8,i=await e.slice(n,r),s=new ArrayBuffer(f+8),a=new Uint8Array(s);return a.set(new Uint8Array(i)),a.set(new Uint8Array(o),r-n),U(s,{parsers:t})}return U(o,{parsers:t})}function U(e,{parsers:t}={}){if(!(e instanceof ArrayBuffer))throw new Error("parquet expected ArrayBuffer");const n=new DataView(e);if(t={..._,...t},n.byteLength<8)throw new Error("parquet file is too short");if(827474256!==n.getUint32(n.byteLength-4,!0))throw new Error("parquet file invalid (footer != PAR1)");const r=n.byteLength-8,o=n.getUint32(r,!0);if(o>n.byteLength-8)throw new Error(`parquet metadata length ${o} exceeds available buffer ${n.byteLength-8}`);const i=b({view:n,offset:r-o}),f=new TextDecoder;function p(e){return e&&f.decode(e)}const h=i.field_1,y=i.field_2.map(e=>({type:s[e.field_1],type_length:e.field_2,repetition_type:l[e.field_3],name:p(e.field_4),num_children:e.field_5,converted_type:c[e.field_6],scale:e.field_7,precision:e.field_8,field_id:e.field_9,logical_type:S(e.field_10)})),w=y.filter(e=>e.type),g=i.field_3,m=i.field_4.map(e=>({columns:e.field_1.map((e,n)=>({file_path:p(e.field_1),file_offset:e.field_2,meta_data:e.field_3&&{type:s[e.field_3.field_1],encodings:e.field_3.field_2?.map(e=>a[e]),path_in_schema:e.field_3.field_3.map(p),codec:u[e.field_3.field_4],num_values:e.field_3.field_5,total_uncompressed_size:e.field_3.field_6,total_compressed_size:e.field_3.field_7,key_value_metadata:e.field_3.field_8,data_page_offset:e.field_3.field_9,index_page_offset:e.field_3.field_10,dictionary_page_offset:e.field_3.field_11,statistics:P(e.field_3.field_12,w[n],t),encoding_stats:e.field_3.field_13?.map(e=>({page_type:d[e.field_1],encoding:a[e.field_2],count:e.field_3})),bloom_filter_offset:e.field_3.field_14,bloom_filter_length:e.field_3.field_15,size_statistics:e.field_3.field_16&&{unencoded_byte_array_data_bytes:e.field_3.field_16.field_1,repetition_level_histogram:e.field_3.field_16.field_2,definition_level_histogram:e.field_3.field_16.field_3}},offset_index_offset:e.field_4,offset_index_length:e.field_5,column_index_offset:e.field_6,column_index_length:e.field_7,crypto_metadata:e.field_8,encrypted_column_metadata:e.field_9})),total_byte_size:e.field_2,num_rows:e.field_3,sorting_columns:e.field_4?.map(e=>({column_idx:e.field_1,descending:e.field_2,nulls_first:e.field_3})),file_offset:e.field_5,total_compressed_size:e.field_6,ordinal:e.field_7})),A=i.field_5?.map(e=>({key:p(e.field_1),value:p(e.field_2)}));return{version:h,schema:y,num_rows:g,row_groups:m,key_value_metadata:A,created_by:p(i.field_6),metadata_length:o}}function D({schema:e}){return A(e,[])[0]}function S(e){return e?.field_1?{type:"STRING"}:e?.field_2?{type:"MAP"}:e?.field_3?{type:"LIST"}:e?.field_4?{type:"ENUM"}:e?.field_5?{type:"DECIMAL",scale:e.field_5.field_1,precision:e.field_5.field_2}:e?.field_6?{type:"DATE"}:e?.field_7?{type:"TIME",isAdjustedToUTC:e.field_7.field_1,unit:B(e.field_7.field_2)}:e?.field_8?{type:"TIMESTAMP",isAdjustedToUTC:e.field_8.field_1,unit:B(e.field_8.field_2)}:e?.field_10?{type:"INTEGER",bitWidth:e.field_10.field_1,isSigned:e.field_10.field_2}:e?.field_11?{type:"NULL"}:e?.field_12?{type:"JSON"}:e?.field_13?{type:"BSON"}:e?.field_14?{type:"UUID"}:e?.field_15?{type:"FLOAT16"}:e}function B(e){if(e.field_1)return"MILLIS";if(e.field_2)return"MICROS";if(e.field_3)return"NANOS";throw new Error("parquet time unit required")}function P(e,t,n){return e&&{max:M(e.field_1,t,n),min:M(e.field_2,t,n),null_count:e.field_3,distinct_count:e.field_4,max_value:M(e.field_5,t,n),min_value:M(e.field_6,t,n),is_max_value_exact:e.field_7,is_min_value_exact:e.field_8}}function M(e,t,n){const{type:r,converted_type:o,logical_type:i}=t;if(void 0===e)return e;if("BOOLEAN"===r)return 1===e[0];if("BYTE_ARRAY"===r)return(new TextDecoder).decode(e);const f=new DataView(e.buffer,e.byteOffset,e.byteLength);return"FLOAT"===r&&4===f.byteLength?f.getFloat32(0,!0):"DOUBLE"===r&&8===f.byteLength?f.getFloat64(0,!0):"INT32"===r&&"DATE"===o?n.dateFromDays(f.getInt32(0,!0)):"INT64"===r&&"TIMESTAMP_MILLIS"===o?n.timestampFromMilliseconds(f.getBigInt64(0,!0)):"INT64"===r&&"TIMESTAMP_MICROS"===o?n.timestampFromMicroseconds(f.getBigInt64(0,!0)):"INT64"===r&&"TIMESTAMP"===i?.type&&"NANOS"===i?.unit?n.timestampFromNanoseconds(f.getBigInt64(0,!0)):"INT64"===r&&"TIMESTAMP"===i?.type&&"MICROS"===i?.unit?n.timestampFromMicroseconds(f.getBigInt64(0,!0)):"INT64"===r&&"TIMESTAMP"===i?.type?n.timestampFromMilliseconds(f.getBigInt64(0,!0)):"INT32"===r&&4===f.byteLength?f.getInt32(0,!0):"INT64"===r&&8===f.byteLength?f.getBigInt64(0,!0):"DECIMAL"===o?y(e)*10**-(t.scale||0):"FLOAT16"===i?.type?g(e):e}function $({dictionary_page_offset:e,data_page_offset:t,total_compressed_size:n}){const r=e||t;return{startByte:Number(r),endByte:Number(r+n)}}function F(e,t,n,r,o){const i=t?.length||n.length;if(!i)return r;const f=I(o),s=o.map(({element:e})=>e.repetition_type);let a=0;const l=[e];let c=e,u=0,d=0,_=0;if(n[0])for(;u<s.length-2&&_<n[0];)u++,"REQUIRED"!==s[u]&&(c=c.at(-1),l.push(c),d++),"REPEATED"===s[u]&&_++;for(let e=0;e<i;e++){const o=t?.length?t[e]:f,i=n[e];for(;u&&(i<_||"REPEATED"!==s[u]);)"REQUIRED"!==s[u]&&(l.pop(),d--),"REPEATED"===s[u]&&_--,u--;for(c=l.at(-1);(u<s.length-2||"REPEATED"===s[u+1])&&(d<o||"REQUIRED"===s[u+1]);){if(u++,"REQUIRED"!==s[u]){const e=[];c.push(e),c=e,l.push(e),d++}"REPEATED"===s[u]&&_++}o===f?c.push(r[a++]):u===s.length-2?c.push(null):c.push([])}if(!e.length)for(let e=0;e<f;e++){const e=[];c.push(e),c=e}return e}function q(e,t,n=0){const r=t.path.join("."),o="OPTIONAL"===t.element.repetition_type,i=o?n+1:n;if(function(e){if(!e)return!1;if("LIST"!==e.element.converted_type)return!1;if(e.children.length>1)return!1;const t=e.children[0];return!(t.children.length>1)&&"REPEATED"===t.element.repetition_type}(t)){let f=t.children[0],s=i;1===f.children.length&&(f=f.children[0],s++),q(e,f,s);const a=f.path.join("."),l=e.get(a);if(!l)throw new Error("parquet list column missing values");return o&&C(l,n),e.set(r,l),void e.delete(a)}if(function(e){if(!e)return!1;if("MAP"!==e.element.converted_type)return!1;if(e.children.length>1)return!1;const t=e.children[0];if(2!==t.children.length)return!1;if("REPEATED"!==t.element.repetition_type)return!1;const n=t.children.find(e=>"key"===e.element.name);if("REPEATED"===n?.element.repetition_type)return!1;const r=t.children.find(e=>"value"===e.element.name);return"REPEATED"!==r?.element.repetition_type}(t)){const f=t.children[0].element.name;q(e,t.children[0].children[0],i+1),q(e,t.children[0].children[1],i+1);const s=e.get(`${r}.${f}.key`),a=e.get(`${r}.${f}.value`);if(!s)throw new Error("parquet map column missing keys");if(!a)throw new Error("parquet map column missing values");if(s.length!==a.length)throw new Error("parquet map column key/value length mismatch");const l=Y(s,a,i);return o&&C(l,n),e.delete(`${r}.${f}.key`),e.delete(`${r}.${f}.value`),void e.set(r,l)}if(t.children.length){const i="REQUIRED"===t.element.repetition_type?n:n+1,f={};for(const n of t.children){q(e,n,i);const t=e.get(n.path.join("."));if(!t)throw new Error("parquet struct missing child data");f[n.element.name]=t}for(const n of t.children)e.delete(n.path.join("."));const s=x(f,i);o&&C(s,n),e.set(r,s)}}function C(e,t){for(let n=0;n<e.length;n++)t?C(e[n],t-1):e[n]=e[n][0]}function Y(e,t,n){const r=[];for(let o=0;o<e.length;o++)if(n)r.push(Y(e[o],t[o],n-1));else if(e[o]){const n={};for(let r=0;r<e[o].length;r++){const i=t[o][r];n[e[o][r]]=void 0===i?null:i}r.push(n)}else r.push(void 0);return r}function x(e,t){const n=Object.keys(e),r=e[n[0]]?.length,o=[];for(let i=0;i<r;i++){const f={};for(const t of n){if(e[t].length!==r)throw new Error("parquet struct parsing error");f[t]=e[t][i]}t?o.push(x(f,t-1)):o.push(f)}return o}function k(e,t,n){const r=n instanceof Int32Array,o=T(e),i=T(e);T(e);let f=N(e),s=0;n[s++]=r?Number(f):f;const a=o/i;for(;s<t;){const o=N(e),l=new Uint8Array(i);for(let t=0;t<i;t++)l[t]=e.view.getUint8(e.offset++);for(let c=0;c<i&&s<t;c++){const i=BigInt(l[c]);if(i){let l=0n,c=a;const u=(1n<<i)-1n;for(;c&&s<t;){let t=BigInt(e.view.getUint8(e.offset))>>l&u;for(l+=i;l>=8;)l-=8n,e.offset++,l&&(t|=BigInt(e.view.getUint8(e.offset))<<i-l&u);f+=o+t,n[s++]=r?Number(f):f,c--}c&&(e.offset+=Math.ceil((c*Number(i)+Number(l))/8))}else for(let e=0;e<a&&s<t;e++)f+=o,n[s++]=r?Number(f):f}}}function j(e,t,n){const r=new Int32Array(t);k(e,t,r);for(let o=0;o<t;o++)n[o]=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,r[o]),e.offset+=r[o]}function G(e){return 32-Math.clz32(e)}function z(e,t,n,r){void 0===r&&(r=e.view.getUint32(e.offset,!0),e.offset+=4);const o=e.offset;let i=0;for(;i<n.length;){const r=T(e);if(1&r)i=Q(e,r,t,n,i);else{const o=r>>>1;V(e,o,t,n,i),i+=o}}e.offset=o+r}function V(e,t,n,r,o){const i=n+7>>3;let f=0;for(let t=0;t<i;t++)f|=e.view.getUint8(e.offset++)<<(t<<3);for(let e=0;e<t;e++)r[o+e]=f}function Q(e,t,n,r,o){let i=t>>1<<3;const f=(1<<n)-1;let s=0;if(e.offset<e.view.byteLength)s=e.view.getUint8(e.offset++);else if(f)throw new Error(`parquet bitpack offset ${e.offset} out of range`);let a=8,l=0;for(;i;)l>8?(l-=8,a-=8,s>>>=8):a-l<n?(s|=e.view.getUint8(e.offset)<<a,e.offset++,a+=8):(o<r.length&&(r[o++]=s>>l&f),i--,l+=n);return o}function J(e,t,n,r){const o=function(e,t){switch(e){case"INT32":case"FLOAT":return 4;case"INT64":case"DOUBLE":return 8;case"FIXED_LEN_BYTE_ARRAY":if(!t)throw new Error("parquet byteWidth missing type_length");return t;default:throw new Error(`parquet unsupported type: ${e}`)}}(n,r),i=new Uint8Array(t*o);for(let n=0;n<o;n++)for(let r=0;r<t;r++)i[r*o+n]=e.view.getUint8(e.offset++);if("FLOAT"===n)return new Float32Array(i.buffer);if("DOUBLE"===n)return new Float64Array(i.buffer);if("INT32"===n)return new Int32Array(i.buffer);if("INT64"===n)return new BigInt64Array(i.buffer);if("FIXED_LEN_BYTE_ARRAY"===n){const e=new Array(t);for(let n=0;n<t;n++)e[n]=i.subarray(n*o,(n+1)*o);return e}throw new Error(`parquet byte_stream_split unsupported type: ${n}`)}function W(e,t,n,r){if(0===n)return[];if("BOOLEAN"===t)return function(e,t){const n=new Array(t);for(let r=0;r<t;r++){const t=e.offset+(r/8|0),o=r%8,i=e.view.getUint8(t);n[r]=!!(i&1<<o)}return e.offset+=Math.ceil(t/8),n}(e,n);if("INT32"===t)return function(e,t){const n=(e.view.byteOffset+e.offset)%4?new Int32Array(H(e.view.buffer,e.view.byteOffset+e.offset,4*t)):new Int32Array(e.view.buffer,e.view.byteOffset+e.offset,t);return e.offset+=4*t,n}(e,n);if("INT64"===t)return function(e,t){const n=(e.view.byteOffset+e.offset)%8?new BigInt64Array(H(e.view.buffer,e.view.byteOffset+e.offset,8*t)):new BigInt64Array(e.view.buffer,e.view.byteOffset+e.offset,t);return e.offset+=8*t,n}(e,n);if("INT96"===t)return function(e,t){const n=new Array(t);for(let r=0;r<t;r++){const t=e.view.getBigInt64(e.offset+12*r,!0),o=e.view.getInt32(e.offset+12*r+8,!0);n[r]=BigInt(o)<<64n|t}return e.offset+=12*t,n}(e,n);if("FLOAT"===t)return function(e,t){const n=(e.view.byteOffset+e.offset)%4?new Float32Array(H(e.view.buffer,e.view.byteOffset+e.offset,4*t)):new Float32Array(e.view.buffer,e.view.byteOffset+e.offset,t);return e.offset+=4*t,n}(e,n);if("DOUBLE"===t)return function(e,t){const n=(e.view.byteOffset+e.offset)%8?new Float64Array(H(e.view.buffer,e.view.byteOffset+e.offset,8*t)):new Float64Array(e.view.buffer,e.view.byteOffset+e.offset,t);return e.offset+=8*t,n}(e,n);if("BYTE_ARRAY"===t)return function(e,t){const n=new Array(t);for(let r=0;r<t;r++){const t=e.view.getUint32(e.offset,!0);e.offset+=4,n[r]=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,t),e.offset+=t}return n}(e,n);if("FIXED_LEN_BYTE_ARRAY"===t){if(!r)throw new Error("parquet missing fixed length");return function(e,t,n){const r=new Array(t);for(let o=0;o<t;o++)r[o]=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,n),e.offset+=n;return r}(e,n,r)}throw new Error(`parquet unhandled type: ${t}`)}function H(e,t,n){const r=new ArrayBuffer(n);return new Uint8Array(r).set(new Uint8Array(e,t,n)),r}const K=[0,255,65535,16777215,4294967295];function X(e,t,n,r,o){for(let i=0;i<o;i++)n[r+i]=e[t+i]}function Z(e,t,n,r){let o;const i=r?.[n];if("UNCOMPRESSED"===n)o=e;else if(i)o=i(e,t);else{if("SNAPPY"!==n)throw new Error(`parquet unsupported compression codec: ${n}`);o=new Uint8Array(t),function(e,t){const n=e.byteLength,r=t.byteLength;let o=0,i=0;for(;o<n;){const t=e[o];if(o++,t<128)break}if(r&&o>=n)throw new Error("invalid snappy length header");for(;o<n;){const r=e[o];let f=0;if(o++,o>=n)throw new Error("missing eof marker");if(3&r){let s=0;switch(3&r){case 1:f=4+(r>>>2&7),s=e[o]+(r>>>5<<8),o++;break;case 2:if(n<=o+1)throw new Error("snappy error end of input");f=(r>>>2)+1,s=e[o]+(e[o+1]<<8),o+=2;break;case 3:if(n<=o+3)throw new Error("snappy error end of input");f=(r>>>2)+1,s=e[o]+(e[o+1]<<8)+(e[o+2]<<16)+(e[o+3]<<24),o+=4}if(0===s||isNaN(s))throw new Error(`invalid offset ${s} pos ${o} inputLength ${n}`);if(s>i)throw new Error("cannot copy from before start of buffer");X(t,i-s,t,i,f),i+=f}else{let f=(r>>>2)+1;if(f>60){if(o+3>=n)throw new Error("snappy error literal pos + 3 >= inputLength");const t=f-60;f=e[o]+(e[o+1]<<8)+(e[o+2]<<16)+(e[o+3]<<24),f=1+(f&K[t]),o+=t}if(o+f>n)throw new Error("snappy error literal exceeds input length");X(e,o,t,i,f),o+=f,i+=f}}if(i!==r)throw new Error("premature end of input")}(e,o)}if(o?.length!==t)throw new Error(`parquet decompressed page length ${o?.length} does not match header ${t}`);return o}function ee(e,{groupStart:t,selectStart:n,selectEnd:r},o,i){const{columnName:f}=o,s=[];let a,l,c=0;const u=i&&(()=>{l&&i({columnName:f,columnData:l,rowStart:t+c-l.length,rowEnd:t+c})});for(;c<r&&!(e.offset>=e.view.byteLength-1);){const t=ne(e);if("DICTIONARY_PAGE"===t.type)a=te(e,t,o,a,void 0,0),a=h(a,o);else{const r=l?.length||0,i=te(e,t,o,a,l,n-c);l===i?c+=i.length-r:(u?.(),s.push(i),c+=i.length,l=i)}}return u?.(),c>r&&l&&(s[s.length-1]=l.slice(0,r-(c-l.length))),s}function te(e,t,n,r,o,i){const{type:f,element:s,schemaPath:a,codec:l,compressors:c}=n,u=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,t.compressed_page_size);if(e.offset+=t.compressed_page_size,"DATA_PAGE"===t.type){const e=t.data_page_header;if(!e)throw new Error("parquet data page header is undefined");if(i>e.num_values&&function(e){if(2!==e.length)return!1;const[,t]=e;return"REPEATED"!==t.element.repetition_type&&!t.children.length}(a))return new Array(e.num_values);const f=Z(u,Number(t.uncompressed_page_size),l,c),{definitionLevels:s,repetitionLevels:d,dataPage:_}=function(e,t,{type:n,element:r,schemaPath:o}){const i=new DataView(e.buffer,e.byteOffset,e.byteLength),f={view:i,offset:0};let s;const a=function(e,t,n){if(n.length>1){const r=E(n);if(r){const n=new Array(t.num_values);return z(e,G(r),n),n}}return[]}(f,t,o),{definitionLevels:l,numNulls:c}=function(e,t,n){const r=I(n);if(!r)return{definitionLevels:[],numNulls:0};const o=new Array(t.num_values);z(e,G(r),o);let i=t.num_values;for(const e of o)e===r&&i--;return 0===i&&(o.length=0),{definitionLevels:o,numNulls:i}}(f,t,o),u=t.num_values-c;if("PLAIN"===t.encoding)s=W(f,n,u,r.type_length);else if("PLAIN_DICTIONARY"===t.encoding||"RLE_DICTIONARY"===t.encoding||"RLE"===t.encoding){const e="BOOLEAN"===n?1:i.getUint8(f.offset++);e?(s=new Array(u),"BOOLEAN"===n?(z(f,e,s),s=s.map(e=>!!e)):z(f,e,s,i.byteLength-f.offset)):s=new Uint8Array(u)}else if("BYTE_STREAM_SPLIT"===t.encoding)s=J(f,u,n,r.type_length);else if("DELTA_BINARY_PACKED"===t.encoding)s="INT32"===n?new Int32Array(u):new BigInt64Array(u),k(f,u,s);else{if("DELTA_LENGTH_BYTE_ARRAY"!==t.encoding)throw new Error(`parquet unsupported encoding: ${t.encoding}`);s=new Array(u),j(f,u,s)}return{definitionLevels:l,repetitionLevels:a,dataPage:s}}(f,e,n);let h=p(_,r,e.encoding,n);if(d.length||s?.length)return F(Array.isArray(o)?o:[],s,d,h,a);for(let e=2;e<a.length;e++)"REQUIRED"!==a[e].element.repetition_type&&(h=Array.from(h,e=>[e]));return h}if("DATA_PAGE_V2"===t.type){const e=t.data_page_header_v2;if(!e)throw new Error("parquet data page header v2 is undefined");if(i>e.num_rows)return new Array(e.num_values);const{definitionLevels:f,repetitionLevels:s,dataPage:l}=function(e,t,n){const r={view:new DataView(e.buffer,e.byteOffset,e.byteLength),offset:0},{type:o,element:i,schemaPath:f,codec:s,compressors:a}=n,l=t.data_page_header_v2;if(!l)throw new Error("parquet data page header v2 is undefined");const c=function(e,t,n){const r=E(n);if(!r)return[];const o=new Array(t.num_values);return z(e,G(r),o,t.repetition_levels_byte_length),o}(r,l,f);r.offset=l.repetition_levels_byte_length;const u=function(e,t,n){const r=I(n);if(r){const n=new Array(t.num_values);return z(e,G(r),n,t.definition_levels_byte_length),n}}(r,l,f),d=t.uncompressed_page_size-l.definition_levels_byte_length-l.repetition_levels_byte_length;let _=e.subarray(r.offset);!1!==l.is_compressed&&(_=Z(_,d,s,a));const p=new DataView(_.buffer,_.byteOffset,_.byteLength),h={view:p,offset:0};let y;const w=l.num_values-l.num_nulls;if("PLAIN"===l.encoding)y=W(h,o,w,i.type_length);else if("RLE"===l.encoding)y=new Array(w),z(h,1,y),y=y.map(e=>!!e);else if("PLAIN_DICTIONARY"===l.encoding||"RLE_DICTIONARY"===l.encoding){const e=p.getUint8(h.offset++);y=new Array(w),z(h,e,y,d-1)}else if("DELTA_BINARY_PACKED"===l.encoding)y="INT32"===o?new Int32Array(w):new BigInt64Array(w),k(h,w,y);else if("DELTA_LENGTH_BYTE_ARRAY"===l.encoding)y=new Array(w),j(h,w,y);else if("DELTA_BYTE_ARRAY"===l.encoding)y=new Array(w),function(e,t,n){const r=new Int32Array(t);k(e,t,r);const o=new Int32Array(t);k(e,t,o);for(let i=0;i<t;i++){const t=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,o[i]);r[i]?(n[i]=new Uint8Array(r[i]+o[i]),n[i].set(n[i-1].subarray(0,r[i])),n[i].set(t,r[i])):n[i]=t,e.offset+=o[i]}}(h,w,y);else{if("BYTE_STREAM_SPLIT"!==l.encoding)throw new Error(`parquet unsupported encoding: ${l.encoding}`);y=J(r,w,o,i.type_length)}return{definitionLevels:u,repetitionLevels:c,dataPage:y}}(u,t,n),c=p(l,r,e.encoding,n);return F(Array.isArray(o)?o:[],f,s,c,a)}if("DICTIONARY_PAGE"===t.type){const e=t.dictionary_page_header;if(!e)throw new Error("parquet dictionary page header is undefined");const n=Z(u,Number(t.uncompressed_page_size),l,c);return W({view:new DataView(n.buffer,n.byteOffset,n.byteLength),offset:0},f,e.num_values,s.type_length)}throw new Error(`parquet unsupported page type: ${t.type}`)}function ne(e){const t=b(e);return{type:d[t.field_1],uncompressed_page_size:t.field_2,compressed_page_size:t.field_3,crc:t.field_4,data_page_header:t.field_5&&{num_values:t.field_5.field_1,encoding:a[t.field_5.field_2],definition_level_encoding:a[t.field_5.field_3],repetition_level_encoding:a[t.field_5.field_4],statistics:t.field_5.field_5&&{max:t.field_5.field_5.field_1,min:t.field_5.field_5.field_2,null_count:t.field_5.field_5.field_3,distinct_count:t.field_5.field_5.field_4,max_value:t.field_5.field_5.field_5,min_value:t.field_5.field_5.field_6}},index_page_header:t.field_6,dictionary_page_header:t.field_7&&{num_values:t.field_7.field_1,encoding:a[t.field_7.field_2],is_sorted:t.field_7.field_3},data_page_header_v2:t.field_8&&{num_values:t.field_8.field_1,num_nulls:t.field_8.field_2,num_rows:t.field_8.field_3,encoding:a[t.field_8.field_4],definition_levels_byte_length:t.field_8.field_5,repetition_levels_byte_length:t.field_8.field_6,is_compressed:void 0===t.field_8.field_7||t.field_8.field_7,statistics:t.field_8.field_8}}}async function re({asyncColumns:e},t,n,r,o){const i=new Array(n),s=await Promise.all(e.map(({data:e})=>e.then(f))),a=e.map(e=>e.pathInSchema[0]).filter(e=>!r||r.includes(e)),l=r??a,c=l.map(t=>e.findIndex(e=>e.pathInSchema[0]===t));for(let r=t;r<n;r++)if("object"===o){const t={};for(let n=0;n<e.length;n++)t[e[n].pathInSchema[0]]=s[n][r];i[r]=t}else{const t=new Array(e.length);for(let e=0;e<l.length;e++)c[e]>=0&&(t[e]=s[c[e]][r]);i[r]=t}return i}function oe(e,t){const{asyncColumns:n}=e,r=[];for(const e of t.children)if(e.children.length){const t=n.filter(t=>t.pathInSchema[0]===e.element.name);if(!t.length)continue;const o=new Map,i=Promise.all(t.map(e=>e.data.then(t=>{o.set(e.pathInSchema.join("."),f(t))}))).then(()=>{q(o,e);const t=o.get(e.path.join("."));if(!t)throw new Error("parquet column data not assembled");return[t]});r.push({pathInSchema:e.path,data:i})}else{const t=n.find(t=>t.pathInSchema[0]===e.element.name);t&&r.push(t)}return{...e,asyncColumns:r}}function ie(e){if(!e.metadata)throw new Error("parquet requires metadata");const t=function({metadata:e,rowStart:t=0,rowEnd:n=1/0,columns:o}){if(!e)throw new Error("parquetPlan requires metadata");const i=[],f=[];let s=0;for(const a of e.row_groups){const e=Number(a.num_rows),l=s+e;if(e>0&&l>=t&&s<n){const l=[];for(const{file_path:e,meta_data:t}of a.columns){if(e)throw new Error("parquet file_path not supported");if(!t)throw new Error("parquet column metadata is undefined");o&&!o.includes(t.path_in_schema[0])||l.push($(t))}const c=Math.max(t-s,0),u=Math.min(n-s,e);i.push({ranges:l,rowGroup:a,groupStart:s,groupRows:e,selectStart:c,selectEnd:u});const d=l[l.length-1]?.endByte-l[0]?.startByte;if(!o&&d<33554432)f.push({startByte:l[0].startByte,endByte:l[l.length-1].endByte});else if(l.length)r(f,l);else if(o?.length)throw new Error(`parquet columns not found: ${o.join(", ")}`)}s=l}return isFinite(n)||(n=s),{metadata:e,rowStart:t,rowEnd:n,columns:o,fetches:f,groups:i}}(e);return e.file=function(e,{fetches:t}){const n=t.map(({startByte:t,endByte:n})=>e.slice(t,n));return{byteLength:e.byteLength,slice(r,o=e.byteLength){const i=t.findIndex(({startByte:e,endByte:t})=>e<=r&&o<=t);if(i<0)throw new Error(`no prefetch for range [${r}, ${o}]`);if(t[i].startByte!==r||t[i].endByte!==o){const e=r-t[i].startByte,f=o-t[i].startByte;return n[i]instanceof Promise?n[i].then(t=>t.slice(e,f)):n[i].slice(e,f)}return n[i]}}}(e.file,t),t.groups.map(n=>function(e,{metadata:t,columns:n},r){const{file:o,compressors:i,utf8:f}=e,s=[],a={..._,...e.parsers};for(const{file_path:l,meta_data:c}of r.rowGroup.columns){if(l)throw new Error("parquet file_path not supported");if(!c)throw new Error("parquet column metadata is undefined");const u=c.path_in_schema[0];if(n&&!n.includes(u))continue;const{startByte:d,endByte:_}=$(c),p=_-d;if(p>1<<30){console.warn(`parquet skipping huge column "${c.path_in_schema}" ${p} bytes`);continue}const h=Promise.resolve(o.slice(d,_));s.push({pathInSchema:c.path_in_schema,data:h.then(n=>{const o=A(t.schema,c.path_in_schema),s={view:new DataView(n),offset:0},l={columnName:c.path_in_schema.join("."),type:c.type,element:o[o.length-1].element,schemaPath:o,codec:c.codec,parsers:a,compressors:i,utf8:f};return ee(s,r,l,e.onPage)})})}return{groupStart:r.groupStart,groupRows:r.groupRows,asyncColumns:s}}(e,t,n))}function fe(e){return new Promise((t,n)=>{(async function(e){e.metadata??=await O(e.file);const t=await ie(e),{rowStart:n=0,rowEnd:o,columns:i,onChunk:f,onComplete:s,rowFormat:a}=e;if(!s&&!f){for(const{asyncColumns:e}of t)for(const{data:t}of e)await t;return}const l=D(e.metadata),c=t.map(e=>oe(e,l));if(f)for(const e of c)for(const t of e.asyncColumns)t.data.then(n=>{let r=e.groupStart;for(const e of n)f({columnName:t.pathInSchema[0],columnData:e,rowStart:r,rowEnd:r+e.length}),r+=e.length});if(s){const e=[];for(const t of c){const f=Math.max(n-t.groupStart,0),s=Math.min((o??1/0)-t.groupStart,t.groupRows);r(e,(await re(t,f,s,i,a)).slice(f,s))}s(e)}else for(const{asyncColumns:e}of c)for(const{data:t}of e)await t})({rowFormat:"object",...e,onComplete:t}).catch(n)})}function se(e,t){return e<t?-1:e>t?1:0}function ae(e,t={}){return"$and"in t&&Array.isArray(t.$and)?t.$and.every(t=>ae(e,t)):"$or"in t&&Array.isArray(t.$or)?t.$or.some(t=>ae(e,t)):"$nor"in t&&Array.isArray(t.$nor)?!t.$nor.some(t=>ae(e,t)):Object.entries(t).every(([t,n])=>{const r=e[t];return"object"!=typeof n||null===n||Array.isArray(n)?o(r,n):Object.entries(n||{}).every(([e,n])=>{switch(e){case"$gt":return r>n;case"$gte":return r>=n;case"$lt":return r<n;case"$lte":return r<=n;case"$eq":return o(r,n);case"$ne":return!o(r,n);case"$in":return Array.isArray(n)&&n.includes(r);case"$nin":return Array.isArray(n)&&!n.includes(r);case"$not":return!ae({[t]:r},{[t]:n});default:return!0}})})}function le(e){if(!e)return[];const t=[];return"$and"in e&&Array.isArray(e.$and)?t.push(...e.$and.flatMap(le)):"$or"in e&&Array.isArray(e.$or)?t.push(...e.$or.flatMap(le)):"$nor"in e&&Array.isArray(e.$nor)?t.push(...e.$nor.flatMap(le)):t.push(...Object.keys(e)),t}function ce(e){const t=new DataView(e.buffer,e.byteOffset,e.byteLength);let n=0;const r=e[n];n+=1;const o=1===r,i=t.getUint32(n,o);if(n+=4,1===i){const e=t.getFloat64(n,o);n+=8;const r=t.getFloat64(n,o);return n+=8,{type:"Point",coordinates:[e,r]}}if(2===i){const e=t.getUint32(n,o);n+=4;const r=[];for(let i=0;i<e;i++){const e=t.getFloat64(n,o);n+=8;const i=t.getFloat64(n,o);n+=8,r.push([e,i])}return{type:"LineString",coordinates:r}}if(3===i){const e=t.getUint32(n,o);n+=4;const r=[];for(let i=0;i<e;i++){const e=t.getUint32(n,o);n+=4;const i=[];for(let r=0;r<e;r++){const e=t.getFloat64(n,o);n+=8;const r=t.getFloat64(n,o);n+=8,i.push([e,r])}r.push(i)}return{type:"Polygon",coordinates:r}}if(6===i){const r=t.getUint32(n,o);n+=4;const i=[];for(let o=0;o<r;o++){const r=1===e[n];n+=1;const o=t.getUint32(n,r);if(n+=4,3!==o)throw new Error(`Expected Polygon in MultiPolygon, got ${o}`);const f=t.getUint32(n,r);n+=4;const s=[];for(let e=0;e<f;e++){const e=t.getUint32(n,r);n+=4;const o=[];for(let i=0;i<e;i++){const e=t.getFloat64(n,r);n+=8;const i=t.getFloat64(n,r);n+=8,o.push([e,i])}s.push(o)}i.push(s)}return{type:"MultiPolygon",coordinates:i}}if(4===i){const r=t.getUint32(n,o);n+=4;const i=[];for(let o=0;o<r;o++){const r=1===e[n];n+=1;const o=t.getUint32(n,r);if(n+=4,1!==o)throw new Error(`Expected Point in MultiPoint, got ${o}`);const f=t.getFloat64(n,r);n+=8;const s=t.getFloat64(n,r);n+=8,i.push([f,s])}return{type:"MultiPoint",coordinates:i}}if(5===i){const r=t.getUint32(n,o);n+=4;const i=[];for(let f=0;f<r;f++){const r=1===e[n];n+=1;const f=t.getUint32(n,r);if(n+=4,2!==f)throw new Error(`Expected LineString in MultiLineString, got ${f}`);const s=t.getUint32(n,o);n+=4;const a=[];for(let e=0;e<s;e++){const e=t.getFloat64(n,r);n+=8;const o=t.getFloat64(n,r);n+=8,a.push([e,o])}i.push(a)}return{type:"MultiLineString",coordinates:i}}throw new Error(`Unsupported geometry type: ${i}`)}async function ue({file:e,compressors:t}){const n=await O(e),r=n.key_value_metadata?.find(e=>"geo"===e.key);if(!r)throw new Error('Invalid GeoParquet file: missing "geo" metadata');const o=JSON.parse(r.value||"{}"),i=await async function(e){if(!(e.file&&e.file.byteLength>=0))throw new Error("parquet expected AsyncBuffer");e.metadata??=await O(e.file);const{metadata:t,rowStart:n=0,columns:r,orderBy:o,filter:i}=e;if(n<0)throw new Error("parquet rowStart must be positive");const s=e.rowEnd??Number(t.num_rows),a=le(i),l=D(e.metadata).children.map(e=>e.element.name),c=a.filter(e=>!l.includes(e));if(c.length)throw new Error(`parquet filter columns not found: ${c.join(", ")}`);if(o&&!l.includes(o))throw new Error(`parquet orderBy column not found: ${o}`);const u=r?l.filter(e=>r.includes(e)||a.includes(e)||e===o):void 0,d=!(!r||!u)&&r.length<u.length;if(i&&!o&&s<t.num_rows){const o=new Array;let f=0;for(const n of t.row_groups){const t=f+Number(n.num_rows),a=await fe({...e,rowStart:f,rowEnd:t,columns:u});for(const e of a)if(ae(e,i)){if(d&&u)for(const t of u)r&&!r.includes(t)&&delete e[t];o.push(e)}if(o.length>=s)break;f=t}return o.slice(n,s)}if(i){const t=await fe({...e,rowStart:void 0,rowEnd:void 0,columns:u});o&&t.sort((e,t)=>se(e[o],t[o]));const f=new Array;for(const e of t)if(ae(e,i)){if(d&&u)for(const t of u)r&&!r.includes(t)&&delete e[t];f.push(e)}return f.slice(n,s)}if("string"==typeof o){const t=await async function(e){if(1!==e.columns?.length)throw new Error("parquetReadColumn expected columns: [columnName]");e.metadata??=await O(e.file);const t=ie(e),n=D(e.metadata),r=t.map(e=>oe(e,n)),o=[];for(const e of r)o.push(f(await e.asyncColumns[0].data));return f(o)}({...e,rowStart:void 0,rowEnd:void 0,columns:[o]}),r=Array.from(t,(e,t)=>t).sort((e,n)=>se(t[e],t[n])).slice(n,s),i=await async function(e){const{file:t,rows:n}=e;e.metadata||=await O(t);const{row_groups:r}=e.metadata,o=Array(r.length).fill(!1);let i=0;const f=r.map(e=>i+=Number(e.num_rows));for(const e of n)o[f.findIndex(t=>e<t)]=!0;const s=[];let a;i=0;for(let e=0;e<o.length;e++){const t=i+Number(r[e].num_rows);o[e]?void 0===a&&(a=i):void 0!==a&&(s.push([a,t]),a=void 0),i=t}void 0!==a&&s.push([a,i]);const l=new Array(Number(e.metadata.num_rows));for(const[t,n]of s){const r=await fe({...e,rowStart:t,rowEnd:n});for(let e=t;e<n;e++)l[e]=r[e-t],l[e].__index__=e}return l}({...e,rows:r});return r.map(e=>i[e])}return await fe(e)}({file:e,utf8:!1,compressors:t}),s=[],a=o.primary_column||"geometry";for(const e of i){const t=e[a];if(!t)continue;const n=ce(t),r={};for(const t of Object.keys(e)){let n=e[t];if(t!==a&&null!==n){try{n=JSON.parse(n)}catch(e){}r[t]=n}}const o={type:"Feature",geometry:n,properties:r};s.push(o)}return{type:"FeatureCollection",features:s}}}}]);
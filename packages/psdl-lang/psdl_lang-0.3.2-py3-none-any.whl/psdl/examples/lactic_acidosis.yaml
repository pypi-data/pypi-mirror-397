# PSDL Example: Lactic Acidosis Detection
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#
# Detects lactic acidosis - a critical metabolic emergency
# indicating tissue hypoxia or metabolic dysfunction.
#
# Clinical Significance:
# - Lactate > 2 mmol/L with pH < 7.35 = lactic acidosis
# - Type A: Tissue hypoxia (shock, sepsis, hypoperfusion)
# - Type B: Metabolic (metformin, liver failure, malignancy)
#
# Mortality increases significantly with higher lactate levels:
# - Lactate 2-4: ~15% mortality
# - Lactate 4-10: ~25% mortality
# - Lactate > 10: ~50% mortality
#
# Reference: Rhodes et al. Surviving Sepsis Campaign Guidelines

scenario: Lactic_Acidosis_Detection
version: "0.3.0"
description: "Detect lactic acidosis through lactate and pH patterns"

# ── Audit Block ──────────────────────────────────
audit:
  intent: "Detect lactic acidosis indicating tissue hypoxia or metabolic dysfunction"
  rationale: "Lactic acidosis is a critical metabolic emergency with high mortality if untreated"
  provenance: "Rhodes et al. Surviving Sepsis Campaign Guidelines"

# ── Population ───────────────────────────────────
population:
  include:
    - age >= 18
  exclude:
    - status == "comfort_care_only"

# ── Signal Bindings ──────────────────────────────
signals:
  Lact:
    ref: lactate
    concept_id: 3047181
    unit: mmol/L
    domain: measurement

  pH:
    ref: blood_ph
    concept_id: 3019977
    unit: pH
    domain: measurement

  HCO3:
    ref: bicarbonate
    concept_id: 3015632
    unit: mEq/L
    domain: measurement

  Cr:
    ref: creatinine
    concept_id: 3016723
    unit: mg/dL
    domain: measurement

  Glucose:
    ref: glucose
    concept_id: 3004501
    unit: mg/dL
    domain: measurement

# ── Trend Computations (v0.3: NUMERIC VALUES ONLY) ─────
trends:
  # Lactate values
  lact_current:
    expr: last(Lact)
    type: float
    unit: mmol/L
    description: "Current lactate level"

  lact_slope_6h:
    expr: slope(Lact, 6h)
    type: float
    description: "Lactate trajectory over 6 hours"

  lact_delta_6h:
    expr: delta(Lact, 6h)
    type: float
    unit: mmol/L
    description: "Lactate change over 6 hours"

  # pH values
  ph_current:
    expr: last(pH)
    type: float
    unit: pH
    description: "Current blood pH"

  ph_slope_6h:
    expr: slope(pH, 6h)
    type: float
    description: "pH trend over 6 hours"

  # Bicarbonate values
  hco3_current:
    expr: last(HCO3)
    type: float
    unit: mEq/L
    description: "Current bicarbonate level"

  # Creatinine for AKI detection
  cr_delta_48h:
    expr: delta(Cr, 48h)
    type: float
    unit: mg/dL
    description: "Creatinine change over 48 hours"

  # Glucose value
  glucose_current:
    expr: last(Glucose)
    type: float
    unit: mg/dL
    description: "Current glucose level"

# ── Logic Layer (v0.3: ALL COMPARISONS HERE) ─────
logic:
  # Lactate thresholds
  lactate_elevated:
    when: lact_current > 2.0
    description: "Lactate > 2.0 mmol/L (elevated)"

  lactate_high:
    when: lact_current > 4.0
    description: "Lactate > 4.0 mmol/L (high - significant hypoperfusion)"

  lactate_severe:
    when: lact_current > 6.0
    description: "Lactate > 6.0 mmol/L (severe)"

  lactate_critical:
    when: lact_current > 10.0
    description: "Lactate > 10.0 mmol/L (critical - high mortality)"

  # Lactate trajectory
  lactate_rising:
    when: lact_slope_6h > 0
    description: "Lactate trending upward"

  lactate_rising_fast:
    when: lact_delta_6h > 2.0
    description: "Rapid lactate rise (>2 mmol/L in 6h)"

  lactate_falling:
    when: lact_slope_6h < 0
    description: "Lactate falling (treatment response)"

  lactate_clearing:
    when: lact_delta_6h < -1.0
    description: "Lactate clearance > 1 mmol/L in 6h (good response)"

  # pH and acid-base status
  acidosis:
    when: ph_current < 7.35
    description: "Acidemia (pH < 7.35)"

  severe_acidosis:
    when: ph_current < 7.20
    description: "Severe acidemia (pH < 7.20)"

  critical_acidosis:
    when: ph_current < 7.10
    description: "Critical acidemia (pH < 7.10)"

  ph_falling:
    when: ph_slope_6h < 0
    description: "pH trending down"

  # Bicarbonate (metabolic component)
  bicarb_low:
    when: hco3_current < 22
    description: "Low bicarbonate (metabolic acidosis)"

  bicarb_very_low:
    when: hco3_current < 18
    description: "Very low bicarbonate (severe metabolic acidosis)"

  # Contributing factors
  aki_present:
    when: cr_delta_48h >= 0.3
    description: "AKI present (reduced lactate clearance)"

  hypoglycemia:
    when: glucose_current < 70
    description: "Hypoglycemia (altered metabolism)"

  # Core lactic acidosis definition
  lactic_acidosis_mild:
    when: lactate_elevated AND acidosis AND NOT lactate_high
    severity: medium
    description: "Mild lactic acidosis (lactate 2-4, pH < 7.35)"

  lactic_acidosis_moderate:
    when: lactate_high AND acidosis AND NOT lactate_severe
    severity: high
    description: "Moderate lactic acidosis (lactate 4-6)"

  lactic_acidosis_severe:
    when: lactate_severe AND acidosis
    severity: critical
    description: "Severe lactic acidosis (lactate > 6)"

  lactic_acidosis_critical:
    when: lactate_critical OR (lactate_severe AND severe_acidosis)
    severity: critical
    description: "Critical lactic acidosis - high mortality risk"

  # Trajectory-based alerts
  acidosis_worsening:
    when: lactate_elevated AND lactate_rising AND ph_falling
    severity: high
    description: "Acidosis worsening - lactate rising, pH falling"

  acidosis_rapid_onset:
    when: lactate_rising_fast
    severity: critical
    description: "Rapid lactate rise - acute decompensation"

  # Isolated hyperlactatemia (without acidosis)
  hyperlactatemia_isolated:
    when: lactate_high AND NOT acidosis
    severity: medium
    description: "Isolated hyperlactatemia - lactate high but pH normal"

  # Recovery indicators
  lactic_acidosis_responding:
    when: lactate_elevated AND lactate_clearing
    severity: low
    description: "Lactic acidosis responding to treatment"

  lactate_normalized:
    when: NOT lactate_elevated AND lactate_falling
    severity: low
    description: "Lactate normalizing"

  # Multi-factor severe patterns
  metabolic_crisis:
    when: severe_acidosis AND bicarb_very_low AND lactate_high
    severity: critical
    description: "Metabolic crisis - severe acidosis with high lactate"

  lactic_acidosis_with_aki:
    when: lactic_acidosis_moderate AND aki_present
    severity: critical
    description: "Lactic acidosis with AKI - impaired clearance"

  # Shock indicator
  tissue_hypoxia_likely:
    when: lactate_high AND lactate_rising
    severity: high
    description: "Rising high lactate - tissue hypoxia/shock likely"

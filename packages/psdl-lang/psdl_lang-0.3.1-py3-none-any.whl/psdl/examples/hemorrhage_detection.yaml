# PSDL Example: Hemorrhage / Acute Blood Loss Detection
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#
# Detects acute blood loss through laboratory patterns.
# Critical for post-operative patients, trauma, GI bleeding.
#
# Clinical Significance:
# - Falling hemoglobin is the hallmark of bleeding
# - Platelet consumption suggests ongoing hemorrhage
# - Rising lactate indicates tissue hypoperfusion
# - These patterns together suggest clinically significant bleeding
#
# Thresholds based on transfusion guidelines and clinical practice.
#
# Reference: AABB Transfusion Guidelines, Trauma Resuscitation Protocols

scenario: Hemorrhage_Detection
version: "0.3.0"
description: "Detect acute blood loss through hemoglobin, platelet, and lactate patterns"

# ── Audit Block ──────────────────────────────────
audit:
  intent: "Detect acute blood loss through laboratory patterns"
  rationale: "Early hemorrhage detection enables timely transfusion and surgical intervention"
  provenance: "AABB Transfusion Guidelines and Trauma Resuscitation Protocols"

# ── Population ───────────────────────────────────
population:
  include:
    - age >= 18
  exclude:
    - status == "comfort_care_only"

# ── Signal Bindings ──────────────────────────────
signals:
  Hgb:
    ref: hemoglobin
    concept_id: 3000963
    unit: g/dL
    domain: measurement

  Plt:
    ref: platelet_count
    concept_id: 3024929
    unit: "10^9/L"
    domain: measurement

  Lact:
    ref: lactate
    concept_id: 3047181
    unit: mmol/L
    domain: measurement

  Cr:
    ref: creatinine
    concept_id: 3016723
    unit: mg/dL
    domain: measurement

# ── Trend Computations (v0.3: NUMERIC VALUES ONLY) ─────
trends:
  # Hemoglobin values
  hgb_current:
    expr: last(Hgb)
    type: float
    unit: g/dL
    description: "Current hemoglobin level"

  hgb_slope_24h:
    expr: slope(Hgb, 24h)
    type: float
    unit: g/dL/day
    description: "Hemoglobin trend over 24 hours"

  hgb_delta_24h:
    expr: delta(Hgb, 24h)
    type: float
    unit: g/dL
    description: "Hemoglobin change over 24 hours"

  hgb_delta_12h:
    expr: delta(Hgb, 12h)
    type: float
    unit: g/dL
    description: "Hemoglobin change over 12 hours"

  hgb_delta_6h:
    expr: delta(Hgb, 6h)
    type: float
    unit: g/dL
    description: "Hemoglobin change over 6 hours"

  # Platelet values
  plt_current:
    expr: last(Plt)
    type: float
    unit: "10^9/L"
    description: "Current platelet count"

  plt_slope_24h:
    expr: slope(Plt, 24h)
    type: float
    description: "Platelet trend over 24 hours"

  plt_delta_24h:
    expr: delta(Plt, 24h)
    type: float
    unit: "10^9/L"
    description: "Platelet change over 24 hours"

  # Tissue perfusion markers
  lact_current:
    expr: last(Lact)
    type: float
    unit: mmol/L
    description: "Current lactate level"

  lact_slope_6h:
    expr: slope(Lact, 6h)
    type: float
    description: "Lactate trend over 6 hours"

  # Renal function
  cr_delta_24h:
    expr: delta(Cr, 24h)
    type: float
    unit: mg/dL
    description: "Creatinine change over 24 hours"

# ── Logic Layer (v0.3: ALL COMPARISONS HERE) ─────
logic:
  # Hemoglobin levels
  hgb_low:
    when: hgb_current < 10.0
    description: "Hemoglobin < 10 g/dL (anemia)"

  hgb_very_low:
    when: hgb_current < 8.0
    description: "Hemoglobin < 8 g/dL (moderate anemia)"

  hgb_critical:
    when: hgb_current < 7.0
    description: "Hemoglobin < 7 g/dL (severe - transfusion threshold)"

  hgb_life_threatening:
    when: hgb_current < 5.0
    description: "Hemoglobin < 5 g/dL (life-threatening)"

  # Hemoglobin trajectory
  hgb_falling:
    when: hgb_slope_24h < 0
    description: "Hemoglobin trending downward"

  hgb_drop_mild:
    when: hgb_delta_24h < -1.0
    description: "Hemoglobin drop > 1 g/dL in 24h"

  hgb_drop_moderate:
    when: hgb_delta_24h < -2.0
    description: "Hemoglobin drop > 2 g/dL in 24h (significant bleeding)"

  hgb_drop_severe:
    when: hgb_delta_12h < -2.0
    description: "Hemoglobin drop > 2 g/dL in 12h (rapid bleeding)"

  hgb_drop_acute:
    when: hgb_delta_6h < -1.5
    description: "Hemoglobin drop > 1.5 g/dL in 6h (acute hemorrhage)"

  # Platelet patterns
  plt_low:
    when: plt_current < 100
    description: "Platelets < 100 (thrombocytopenia)"

  plt_critical:
    when: plt_current < 50
    description: "Platelets < 50 (severe - bleeding risk)"

  plt_falling:
    when: plt_slope_24h < 0
    description: "Platelet count falling"

  plt_consumption:
    when: plt_delta_24h < -30
    description: "Platelet drop > 30 in 24h (consumption)"

  # Tissue perfusion markers
  lactate_elevated:
    when: lact_current > 2.0
    description: "Lactate > 2.0 mmol/L (hypoperfusion)"

  lactate_high:
    when: lact_current > 4.0
    description: "Lactate > 4.0 mmol/L (severe hypoperfusion)"

  lactate_rising:
    when: lact_slope_6h > 0
    description: "Lactate trending up (worsening perfusion)"

  # Renal impact
  aki_developing:
    when: cr_delta_24h >= 0.3
    description: "AKI developing (possible hypovolemia)"

  # Severity staging
  anemia_mild:
    when: hgb_low AND NOT hgb_very_low
    severity: low
    description: "Mild anemia (Hgb 8-10) - monitor"

  anemia_moderate:
    when: hgb_very_low AND NOT hgb_critical
    severity: medium
    description: "Moderate anemia (Hgb 7-8) - evaluate for transfusion"

  anemia_severe:
    when: hgb_critical AND NOT hgb_life_threatening
    severity: high
    description: "Severe anemia (Hgb < 7) - transfusion likely needed"

  anemia_critical:
    when: hgb_life_threatening
    severity: critical
    description: "Life-threatening anemia (Hgb < 5) - emergent transfusion"

  # Active bleeding detection
  bleeding_likely:
    when: hgb_drop_mild AND hgb_falling
    severity: medium
    description: "Likely bleeding - Hgb falling > 1 g/dL/day"

  bleeding_significant:
    when: hgb_drop_moderate
    severity: high
    description: "Significant bleeding - Hgb drop > 2 g/dL in 24h"

  bleeding_rapid:
    when: hgb_drop_severe
    severity: high
    description: "Rapid bleeding - Hgb drop > 2 g/dL in 12h"

  bleeding_acute:
    when: hgb_drop_acute
    severity: critical
    description: "Acute hemorrhage - Hgb drop > 1.5 g/dL in 6h"

  # Multi-signal hemorrhage patterns
  hemorrhagic_shock_developing:
    when: hgb_drop_moderate AND lactate_elevated
    severity: critical
    description: "Hemorrhage with hypoperfusion - shock developing"

  hemorrhage_with_coagulopathy:
    when: hgb_drop_mild AND plt_consumption
    severity: high
    description: "Bleeding with platelet consumption - coagulopathy risk"

  massive_hemorrhage:
    when: hgb_drop_severe AND plt_falling AND lactate_rising
    severity: critical
    description: "Massive hemorrhage - Hgb falling, platelets consumed, lactate rising"

  # Combined patterns
  bleeding_with_aki:
    when: bleeding_likely AND aki_developing
    severity: high
    description: "Bleeding with AKI - hypovolemia affecting kidneys"

  # Transfusion decision support
  transfusion_indicated:
    when: hgb_critical OR (hgb_very_low AND bleeding_likely)
    severity: high
    description: "Transfusion likely indicated - Hgb < 7 or actively bleeding"

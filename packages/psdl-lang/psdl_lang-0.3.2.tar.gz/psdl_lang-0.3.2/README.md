<p align="center">
  <img src="docs/assets/logo.jpeg" alt="PSDL Logo" width="400"/>
</p>

<h1 align="center">PSDL</h1>
<h3 align="center">Patient Scenario Definition Language</h3>

<p align="center">
  <em>An Open Standard for Clinical Logic, Real-Time Monitoring & AI Integration</em>
</p>

<p align="center">
  <a href="https://github.com/Chesterguan/PSDL/actions/workflows/ci.yml"><img src="https://github.com/Chesterguan/PSDL/actions/workflows/ci.yml/badge.svg" alt="Tests"></a>
  <a href="#specification"><img src="https://img.shields.io/badge/Spec-0.3.0-blue?style=flat-square" alt="Spec Version"></a>
  <a href="#license"><img src="https://img.shields.io/badge/License-Apache%202.0-green?style=flat-square" alt="License"></a>
  <a href="#contributing"><img src="https://img.shields.io/badge/PRs-Welcome-brightgreen?style=flat-square" alt="PRs Welcome"></a>
  <img src="https://img.shields.io/badge/Python-3.8%20%7C%203.9%20%7C%203.10%20%7C%203.11%20%7C%203.12-blue?style=flat-square&logo=python&logoColor=white" alt="Python 3.8-3.12">
  <a href="https://zread.ai/Chesterguan/PSDL" target="_blank"><img src="https://img.shields.io/badge/Ask_Zread-_.svg?style=flat&color=00b0aa&labelColor=000000&logo=data%3Aimage%2Fsvg%2Bxml%3Bbase64%2CPHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTQuOTYxNTYgMS42MDAxSDIuMjQxNTZDMS44ODgxIDEuNjAwMSAxLjYwMTU2IDEuODg2NjQgMS42MDE1NiAyLjI0MDFWNC45NjAxQzEuNjAxNTYgNS4zMTM1NiAxLjg4ODEgNS42MDAxIDIuMjQxNTYgNS42MDAxSDQuOTYxNTZDNS4zMTUwMiA1LjYwMDEgNS42MDE1NiA1LjMxMzU2IDUuNjAxNTYgNC45NjAxVjIuMjQwMUM1LjYwMTU2IDEuODg2NjQgNS4zMTUwMiAxLjYwMDEgNC45NjE1NiAxLjYwMDFaIiBmaWxsPSIjZmZmIi8%2BCjxwYXRoIGQ9Ik00Ljk2MTU2IDEwLjM5OTlIMi4yNDE1NkMxLjg4ODEgMTAuMzk5OSAxLjYwMTU2IDEwLjY4NjQgMS42MDE1NiAxMS4wMzk5VjEzLjc1OTlDMS42MDE1NiAxNC4xMTM0IDEuODg4MSAxNC4zOTk5IDIuMjQxNTYgMTQuMzk5OUg0Ljk2MTU2QzUuMzE1MDIgMTQuMzk5OSA1LjYwMTU2IDE0LjExMzQgNS42MDE1NiAxMy43NTk5VjExLjAzOTlDNS42MDE1NiAxMC42ODY0IDUuMzE1MDIgMTAuMzk5OSA0Ljk2MTU2IDEwLjM5OTlaIiBmaWxsPSIjZmZmIi8%2BCjxwYXRoIGQ9Ik0xMy43NTg0IDEuNjAwMUgxMS4wMzg0QzEwLjY4NSAxLjYwMDEgMTAuMzk4NCAxLjg4NjY0IDEwLjM5ODQgMi4yNDAxVjQuOTYwMUMxMC4zOTg0IDUuMzEzNTYgMTAuNjg1IDUuNjAwMSAxMS4wMzg0IDUuNjAwMUgxMy43NTg0QzE0LjExMTkgNS42MDAxIDE0LjM5ODQgNS4zMTM1NiAxNC4zOTg0IDQuOTYwMVYyLjI0MDFDMTQuMzk4NCAxLjg4NjY0IDE0LjExMTkgMS42MDAxIDEzLjc1ODQgMS42MDAxWiIgZmlsbD0iI2ZmZiIvPgo8cGF0aCBkPSJNNCAxMkwxMiA0TDQgMTJaIiBmaWxsPSIjZmZmIi8%2BCjxwYXRoIGQ9Ik00IDEyTDEyIDQiIHN0cm9rZT0iI2ZmZiIgc3Ryb2tlLXdpZHRoPSIxLjUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPgo8L3N2Zz4K&logoColor=ffffff" alt="zread"/></a>

</p>

<p align="center">
  <strong>What SQL became for data queries, ONNX for ML models, and GraphQL for APIs ‚Äî<br/>
  PSDL is becoming the <em>semantic layer</em> for clinical AI.</strong>
</p>


<p align="center">
  üìÑ <strong>Read the Whitepaper:</strong>
  <a href="docs/WHITEPAPER_EN.md">English</a> ¬∑
  <a href="docs/WHITEPAPER_ZH.md">ÁÆÄ‰Ωì‰∏≠Êñá</a> ¬∑
  <a href="docs/WHITEPAPER_ES.md">Espa√±ol</a> ¬∑
  <a href="docs/WHITEPAPER_FR.md">Fran√ßais</a> ¬∑
  <a href="docs/WHITEPAPER_JA.md">Êó•Êú¨Ë™û</a>
</p>

---

<h2 align="center">Accountable Clinical AI ‚Äî Traceable by Design</h2>

<p align="center">
  <strong>Clinical AI doesn't fail because models are weak.<br/>
  It fails because decisions cannot be traced.</strong>
</p>

<p align="center">
  PSDL makes every clinical decision <strong>accountable</strong>:
</p>

<table align="center">
  <tr>
    <td align="center"><strong>WHO</strong><br/>wrote this logic?</td>
    <td align="center"><strong>WHY</strong><br/>does it matter?</td>
    <td align="center"><strong>WHAT</strong><br/>evidence supports it?</td>
  </tr>
  <tr>
    <td align="center"><code>audit.intent</code></td>
    <td align="center"><code>audit.rationale</code></td>
    <td align="center"><code>audit.provenance</code></td>
  </tr>
</table>

<p align="center">
  <em>This is not optional. This is what makes PSDL regulatory-ready (FDA, EU MDR).</em>
</p>

---

## Try It Now (No Setup Required)

Run PSDL in your browser with Google Colab - zero installation, real clinical data:

| Notebook | Data | Description |
|----------|------|-------------|
| [![Open In Colab](https://colab.research.google.com/assets/colab-badge.svg)](https://colab.research.google.com/github/Chesterguan/PSDL/blob/main/examples/notebooks/PSDL_Colab_Synthea.ipynb) | **Synthetic** | Quick demo with generated patient data (2 min) |
| [![Open In Colab](https://colab.research.google.com/assets/colab-badge.svg)](https://colab.research.google.com/github/Chesterguan/PSDL/blob/main/examples/notebooks/PSDL_Colab_MIMIC_Demo.ipynb) | **MIMIC-IV Demo** | 100 real ICU patients, ICD diagnoses |
| [![Open In Colab](https://colab.research.google.com/assets/colab-badge.svg)](https://colab.research.google.com/github/Chesterguan/PSDL/blob/main/examples/notebooks/PSDL_PhysioNet_Demo.ipynb) | **PhysioNet Sepsis** | 40,000+ patients with labeled sepsis |

---

## The Problem

Despite significant advances in clinical AI and machine learning, **real-time decision support in healthcare remains fragmented, non-portable, non-reproducible, and exceptionally difficult to audit or regulate**.

<p align="center">
  <img src="docs/assets/psdl-value-proposition.jpeg" alt="PSDL Value Proposition - Before and After" width="900"/>
  <br/>
  <em>PSDL bridges the determination, audit, and portability gaps in clinical research</em>
</p>

## What is PSDL?

PSDL (Patient Scenario Definition Language) is a declarative, vendor-neutral language for expressing clinical scenarios. It provides a structured way to define:

| Component | Description |
|-----------|-------------|
| **Signals** | Time-series clinical data bindings (labs, vitals, etc.) |
| **Trends** | Temporal computations over signals (deltas, slopes, averages) |
| **Logic** | Boolean algebra combining trends into clinical states |
| **Audit** | Required traceability (intent, rationale, provenance) |
| **Population** | Criteria for which patients a scenario applies to |
| **State** | Optional state machine for tracking clinical progression |

<p align="center">
  <img src="docs/assets/semantic langauge.jpeg" alt="How PSDL Works" width="800"/>
  <br/>
  <em>Syntax vs Semantics vs Runtime - How PSDL Works</em>
</p>

## Quick Example

```yaml
# Detect early kidney injury (v0.3 syntax)
scenario: AKI_Early_Detection
version: "0.3.0"

audit:
  intent: "Detect early acute kidney injury using creatinine trends"
  rationale: "Early AKI detection enables timely intervention"
  provenance: "KDIGO Clinical Practice Guideline for AKI (2012)"

signals:
  Cr:
    ref: creatinine        # v0.3: 'ref' instead of 'source'
    concept_id: 3016723    # OMOP concept
    unit: mg/dL

trends:
  # v0.3: Trends produce numeric values only
  cr_delta_6h:
    expr: delta(Cr, 6h)
    description: "Creatinine change over 6 hours"

  cr_current:
    expr: last(Cr)
    description: "Current creatinine value"

logic:
  # v0.3: Comparisons belong in logic layer
  cr_rising:
    when: cr_delta_6h > 0.3
    description: "Rising creatinine (> 0.3 mg/dL in 6h)"

  cr_high:
    when: cr_current > 1.5
    description: "Elevated creatinine"

  aki_risk:
    when: cr_rising AND cr_high
    severity: high
    description: "Early AKI - rising and elevated creatinine"
```

## Why PSDL?

| Challenge | Without PSDL | With PSDL |
|-----------|--------------|-----------|
| **Portability** | Logic tied to specific hospital systems | Same scenario runs anywhere with mapping |
| **Auditability** | Scattered across Python, SQL, configs | Single structured, version-controlled file |
| **Reproducibility** | Hidden state, implicit dependencies | Deterministic execution, explicit semantics |
| **Regulatory Compliance** | Manual documentation | Built-in audit primitives |
| **Research Sharing** | Cannot validate published scenarios | Portable, executable definitions |

## Installation

```bash
# Install from PyPI
pip install psdl-lang

# With OMOP adapter support
pip install psdl-lang[omop]

# With FHIR adapter support
pip install psdl-lang[fhir]

# Full installation (all adapters)
pip install psdl-lang[full]
```

## Usage

### Parse a Scenario

```python
from psdl.core import parse_scenario

# Use bundled scenarios (included with pip install)
from psdl.examples import get_scenario, list_scenarios

# List available scenarios
print(list_scenarios())  # ['aki_detection', 'sepsis_screening', ...]

# Load a bundled scenario
scenario = get_scenario("aki_detection")

print(f"Scenario: {scenario.name}")
print(f"Signals: {list(scenario.signals.keys())}")
print(f"Logic rules: {list(scenario.logic.keys())}")
```

### Evaluate Against Patient Data

```python
from psdl.examples import get_scenario
from psdl.runtimes.single import SinglePatientEvaluator, InMemoryBackend
from datetime import datetime, timedelta

# Load bundled scenario
scenario = get_scenario("aki_detection")

# Set up data backend
backend = InMemoryBackend()
now = datetime.now()

# Add patient data (using convenience method)
backend.add_observation(123, "Cr", 1.0, now - timedelta(hours=6))
backend.add_observation(123, "Cr", 1.3, now - timedelta(hours=3))
backend.add_observation(123, "Cr", 1.8, now)

# Evaluate
evaluator = SinglePatientEvaluator(scenario, backend)
result = evaluator.evaluate(patient_id=123, reference_time=now)

if result.is_triggered:
    print(f"Patient triggered: {result.triggered_logic}")
    print(f"Trend values: {result.trend_values}")
```

### Compile for Production (v0.3)

For production deployments requiring audit trails, use `compile_scenario` to get a compiled IR with cryptographic hashes:

```python
from psdl.core.compile import compile_scenario
from psdl.runtimes.single import SinglePatientEvaluator

# Compile scenario to IR with audit hashes
ir = compile_scenario("scenario.yaml")

print(f"Spec Hash: {ir.spec_hash}")       # Hash of input YAML
print(f"IR Hash: {ir.ir_hash}")           # Hash of compiled IR
print(f"Toolchain: {ir.toolchain_hash}")  # Hash of compiler version

# Create evaluator from compiled IR
evaluator = SinglePatientEvaluator.from_ir(ir, backend)
result = evaluator.evaluate(patient_id=123, reference_time=now)

# Results include compilation hashes for audit
print(f"Compilation Hashes: {result.compilation_hashes}")
```

The compiled IR includes:
- **DAG-ordered evaluation** - Dependencies computed once, evaluated in correct order
- **Canonical hashing** - Reproducible SHA-256 hashes per `spec/hashing.yaml`
- **Compilation diagnostics** - Warnings for unused signals/trends
- **Audit trail** - Full traceability from YAML to evaluation

### Dataset Specifications (RFC-0004)

Dataset Specs enable portable scenarios by mapping semantic signal references to physical data locations:

```python
from psdl import load_dataset_spec

# Load institution-specific binding
spec = load_dataset_spec("dataset_specs/my_hospital_omop.yaml")

# Resolve a signal reference to physical binding
binding = spec.resolve("creatinine")
print(binding.table)        # "measurement"
print(binding.filter_expr)  # "concept_id = 3016723"
```

This separates **clinical logic** (portable scenarios) from **local terminology** (institution-specific mappings).

## Temporal Operators

| Operator | Syntax | Description |
|----------|--------|-------------|
| `delta` | `delta(signal, window)` | Absolute change over window |
| `slope` | `slope(signal, window)` | Linear regression slope |
| `ema` | `ema(signal, window)` | Exponential moving average |
| `sma` | `sma(signal, window)` | Simple moving average |
| `min` | `min(signal, window)` | Minimum value in window |
| `max` | `max(signal, window)` | Maximum value in window |
| `count` | `count(signal, window)` | Observation count |
| `last` | `last(signal)` | Most recent value |

### Window Formats

- `30s` - 30 seconds
- `5m` - 5 minutes
- `6h` - 6 hours
- `1d` - 1 day
- `7d` - 7 days

## Project Structure

PSDL follows industry-standard patterns (like GraphQL, CQL, ONNX):
 - **Specification** defines WHAT
 - **Reference Implementation** shows HOW.

```
psdl/
‚îú‚îÄ‚îÄ README.md              # This file
‚îú‚îÄ‚îÄ PRINCIPLES.md          # Core laws defining PSDL scope
‚îú‚îÄ‚îÄ spec/                  # SPECIFICATION (Source of Truth)
‚îÇ   ‚îú‚îÄ‚îÄ schema.json        # JSON Schema for scenarios
‚îÇ   ‚îú‚îÄ‚îÄ operators.yaml     # Operator definitions
‚îÇ   ‚îî‚îÄ‚îÄ grammar/           # Lark/EBNF grammars
‚îú‚îÄ‚îÄ src/psdl/              # REFERENCE IMPLEMENTATION (Python)
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py        # Package entry point
‚îÇ   ‚îú‚îÄ‚îÄ operators.py       # Temporal operators (shared)
‚îÇ   ‚îú‚îÄ‚îÄ core/              # Core module (parsing, IR) - v0.3 strict mode
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ parser.py      # YAML parser
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ir.py          # Intermediate representation
‚îÇ   ‚îú‚îÄ‚îÄ runtimes/          # Execution runtimes
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ single/        # Single patient evaluation
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ cohort/        # Cohort SQL compilation
‚îÇ   ‚îú‚îÄ‚îÄ adapters/          # Data adapters (OMOP, FHIR, PhysioNet)
‚îÇ   ‚îî‚îÄ‚îÄ examples/          # Bundled scenarios (7 scenarios)
‚îú‚îÄ‚îÄ examples/              # Demo content (not in package)
‚îÇ   ‚îú‚îÄ‚îÄ notebooks/         # Jupyter demos (5 notebooks, Colab-ready)
‚îÇ   ‚îî‚îÄ‚îÄ data/              # Sample data (compressed archives)
‚îú‚îÄ‚îÄ docs/                  # Documentation + Whitepapers
‚îú‚îÄ‚îÄ rfcs/                  # Design proposals (5 RFCs)
‚îî‚îÄ‚îÄ tests/                 # 369 tests (all passing)
```

| Component | Description |
|-----------|-------------|
| **Specification** | PSDL language definition (see [WHITEPAPER.md](docs/WHITEPAPER.md)) |
| **Reference Implementation** | Python implementation demonstrating the spec |
| **Core** | Parser, IR types, expression parsing |
| **Runtimes** | Single patient, cohort SQL, streaming execution |
| **Adapters** | Data sources (OMOP, FHIR, PhysioNet) |

## Spec-Driven Code Generation

PSDL follows a **spec-driven architecture** where specification files are the single source of truth. Code is auto-generated from specs to eliminate redundancy and ensure consistency.

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   SPEC FILES (Source of Truth)                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ spec/schema.json        ‚Üí Scenario YAML structure               ‚îÇ
‚îÇ spec/ast-nodes.yaml     ‚Üí Expression AST types + grammar mappings‚îÇ
‚îÇ spec/operators.yaml     ‚Üí Operator metadata + SQL templates     ‚îÇ
‚îÇ spec/grammar/*.lark     ‚Üí Expression grammar (Lark)             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº python tools/codegen.py --all
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    AUTO-GENERATED CODE                          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ _generated/schema_types.py   ‚Üê schema.json (datamodel-codegen)  ‚îÇ
‚îÇ _generated/ast_types.py      ‚Üê ast-nodes.yaml (Jinja2)          ‚îÇ
‚îÇ _generated/transformer.py    ‚Üê ast-nodes.yaml grammar_mappings  ‚îÇ
‚îÇ _generated/operators_meta.py ‚Üê operators.yaml (Jinja2)          ‚îÇ
‚îÇ _generated/sql_templates.py  ‚Üê operators.yaml (Jinja2)          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    MANUAL CODE (Algorithms Only)                ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ operators.py          ‚Üí Temporal operator implementations       ‚îÇ
‚îÇ runtimes/             ‚Üí Execution engines (single, cohort)      ‚îÇ
‚îÇ adapters/             ‚Üí Data source adapters (OMOP, FHIR)       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Regenerating Code

```bash
# Regenerate all code from specs
python tools/codegen.py --all

# Regenerate specific components
python tools/codegen.py --types        # Python types from schema.json
python tools/codegen.py --ast          # AST types from ast-nodes.yaml
python tools/codegen.py --transformer  # Lark transformer from grammar_mappings
python tools/codegen.py --operators    # Operator metadata
python tools/codegen.py --sql          # SQL templates

# Validate implementations against spec
python tools/codegen.py --validate
```

### Why Spec-Driven?

| Benefit | Description |
|---------|-------------|
| **Single Source of Truth** | Specs define types once; code is generated |
| **Consistency** | No manual type mismatches or drift |
| **Maintainability** | Change spec ‚Üí regenerate ‚Üí done |
| **Auditability** | Clear traceability from spec to implementation |

## Running Tests

```bash
# Run all tests
pytest tests/ -v

# Run with verbose output
pytest tests/ -v -s
```

### Test Coverage: 424 Tests (All Passing)

- **Unit Tests**: Parser, evaluator, operators, scenarios
- **Integration Tests**: FHIR adapter, OMOP backend, PhysioNet adapter
- **Validation**: SQL equivalence (100% match), KDIGO clinical guidelines
- **Streaming Tests**: Window functions, logic evaluation, Flink compiler
- **Cohort Tests**: SQL compilation, batch evaluation
- **Compiler Tests**: ScenarioIR, DAG ordering, canonical hashing

See [tests/TEST_VALIDATION.md](tests/TEST_VALIDATION.md) for detailed methodology.

## Example Scenarios

| Scenario | Description | Clinical Use |
|----------|-------------|--------------|
| **ICU Deterioration** | Monitors for early signs of clinical deterioration | Kidney function, lactate trends, hemodynamics |
| **AKI Detection** | KDIGO criteria for Acute Kidney Injury staging | Creatinine-based staging |
| **Sepsis Screening** | qSOFA + lactate-based sepsis screening | Early sepsis identification |
| **PhysioNet Sepsis** | Sepsis-3 criteria for PhysioNet Challenge 2019 | SIRS + organ dysfunction |

## Design Principles

> **The Core Law**: PSDL defines WHAT to detect, not HOW to collect or execute.
>
> For the full set of laws governing PSDL's scope, see [PRINCIPLES.md](PRINCIPLES.md)

| Principle | Description |
|-----------|-------------|
| **Declarative** | Define *what* to detect, not *how* to compute it |
| **Portable** | Same scenario runs on any OMOP/FHIR backend with mapping |
| **Auditable** | Structured format enables static analysis and version control |
| **Deterministic** | Predictable execution with no hidden state |
| **Open** | Vendor-neutral, community-governed |

## Roadmap

| Phase | Status | Focus |
|-------|--------|-------|
| **Phase 1: Semantic Foundation** | ‚úÖ Complete | Spec, parser, operators, OMOP/FHIR adapters |
| **Phase 2: v0.3 Architecture** | ‚úÖ Complete | Signal/Trend/Logic/Output separation, PyPI publication |
| **Phase 3: Production Readiness** | üöß Current | Output profiles, streaming, performance |
| **Phase 4: Adoption & Scale** | üîÆ Future | Hospital pilots, standards engagement |

üìç **[View Full Roadmap ‚Üí](docs/ROADMAP.md)**

## Related Standards

| Standard | Relationship |
|----------|--------------|
| **OMOP CDM** | Data model for signals (concept_id references) |
| **FHIR R4** | EHR integration (implemented adapter) |
| **CQL** | Similar domain, different scope (quality measures) |
| **ONNX** | Inspiration for portable format approach |

## Documentation

| Document | Description |
|----------|-------------|
| [API Reference](wiki/API.md) | Developer API documentation |
| [Principles](PRINCIPLES.md) | The laws defining PSDL's scope and boundaries |
| [Whitepaper](docs/WHITEPAPER.md) | Full project vision and specification (5 languages) |
| [Getting Started](docs/getting-started.md) | Quick start guide |
| [Roadmap](docs/ROADMAP.md) | Development phases and timeline |
| [Changelog](CHANGELOG.md) | Version history |

## Contributing

We welcome contributions! See [CONTRIBUTING.md](CONTRIBUTING.md) for guidelines.

### Ways to Contribute

- **Specification**: Propose language features, operators, semantics
- **Implementation**: Build runtimes, backends, tooling
- **Documentation**: Improve guides, tutorials, examples
- **Testing**: Add conformance tests, find edge cases
- **Adoption**: Share use cases, pilot experiences

## License

Apache 2.0 - See [LICENSE](LICENSE) for details.

---

<p align="center">
  <strong>Clinical AI doesn't fail because models are weak.<br/>
  It fails because there's no semantic layer to express clinical logic portably.</strong>
</p>

<p align="center">
  <em>PSDL is the semantic layer for clinical AI ‚Äî like SQL for databases.</em>
</p>

<p align="center">
  <sub>An open standard built by the community, for the community.</sub>
</p>

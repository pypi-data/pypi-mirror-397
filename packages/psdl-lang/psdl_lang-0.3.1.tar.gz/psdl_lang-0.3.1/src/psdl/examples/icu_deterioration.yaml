# PSDL Example: ICU Patient Deterioration Detection
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#
# This scenario detects early signs of clinical deterioration
# in ICU patients by monitoring kidney function, lactate trends,
# and hemodynamic stability.
#
# Clinical rationale:
# - Rising creatinine indicates acute kidney injury
# - Rising lactate indicates tissue hypoperfusion
# - Low MAP indicates shock/hypotension
# - Combination of these predicts poor outcomes

scenario: ICU_Deterioration_v1
version: "0.3.0"
description: "Detect early signs of clinical deterioration in ICU patients"

# ── Audit Block ──────────────────────────────────
audit:
  intent: "Detect early signs of clinical deterioration in ICU patients"
  rationale: "Early warning of deterioration enables proactive intervention before organ failure"
  provenance: "Multi-parameter early warning systems literature and clinical practice guidelines"

# ── Population Scope ─────────────────────────────
population:
  include:
    - age >= 18
    - unit == "ICU"
  exclude:
    - status == "comfort_care_only"
    - status == "DNR"

# ── Signals (v0.3: 'ref' required) ───────────────
signals:
  Cr:
    ref: creatinine
    concept_id: 3016723
    unit: mg/dL
    domain: measurement

  Lact:
    ref: lactate
    concept_id: 3047181
    unit: mmol/L
    domain: measurement

  MAP:
    ref: mean_arterial_pressure
    concept_id: 3027598
    unit: mmHg
    domain: measurement

  HR:
    ref: heart_rate
    concept_id: 3027018
    unit: beats/min
    domain: measurement

  SpO2:
    ref: oxygen_saturation
    concept_id: 3016502
    unit: percent
    domain: measurement

# ── Trends (v0.3: numeric values only) ───────────
trends:
  cr_delta_6h:
    expr: delta(Cr, 6h)
    description: "Creatinine change over 6 hours"

  cr_delta_24h:
    expr: delta(Cr, 24h)
    description: "Creatinine change over 24 hours"

  lact_current:
    expr: last(Lact)
    description: "Current lactate level"

  lact_slope_3h:
    expr: slope(Lact, 3h)
    description: "Lactate trajectory over 3 hours"

  map_ema_30m:
    expr: ema(MAP, 30m)
    description: "30-minute EMA of MAP"

  hr_ema_15m:
    expr: ema(HR, 15m)
    description: "15-minute EMA of heart rate"

  spo2_current:
    expr: last(SpO2)
    description: "Current oxygen saturation"

# ── Logic (v0.3: 'when' with comparisons) ────────
logic:
  # Threshold comparisons
  renal_rise:
    when: cr_delta_6h > 0.3
    description: "Creatinine increase > 0.3 mg/dL over 6 hours (KDIGO Stage 1)"

  renal_rise_severe:
    when: cr_delta_24h > 1.0
    description: "Creatinine increase > 1.0 mg/dL over 24 hours"

  lactate_elevated:
    when: lact_current > 2.0
    description: "Current lactate > 2.0 mmol/L"

  lactate_rising:
    when: lact_slope_3h > 0
    description: "Positive lactate trajectory over 3 hours"

  lactate_critical:
    when: lact_current > 4.0
    description: "Critical lactate > 4.0 mmol/L"

  hypotension:
    when: map_ema_30m < 65
    description: "Sustained MAP below 65 mmHg (30-min EMA)"

  tachycardia:
    when: hr_ema_15m > 110
    description: "Sustained tachycardia > 110 bpm"

  hypoxemia:
    when: spo2_current < 92
    description: "Oxygen saturation below 92%"

  # Stage 1: Early warning
  early_deterioration:
    when: renal_rise AND lactate_rising
    severity: medium
    description: "Early signs of deterioration - kidney stress + lactate trend"

  # Stage 2: Significant concern
  deterioration:
    when: (renal_rise AND lactate_elevated) OR (lactate_rising AND hypotension)
    severity: high
    description: "Significant deterioration - multiple organ stress"

  # Stage 3: Critical - immediate attention
  shock_risk:
    when: deterioration AND hypotension
    severity: critical
    description: "Shock risk - multi-organ dysfunction with hypotension"

  # Sepsis screening
  sepsis_screen_positive:
    when: lactate_elevated AND (tachycardia OR hypotension)
    severity: high
    description: "Positive sepsis screening - lactate + hemodynamic instability"

  # Critical combination
  critical_state:
    when: (shock_risk OR lactate_critical) AND hypoxemia
    severity: critical
    description: "Critical state requiring immediate intervention"

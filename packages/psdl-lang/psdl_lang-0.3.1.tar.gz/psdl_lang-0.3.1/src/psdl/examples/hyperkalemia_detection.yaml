# PSDL Example: Hyperkalemia Detection
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#
# Detects dangerous potassium elevations that can cause
# life-threatening cardiac arrhythmias.
#
# Clinical Significance:
# - K > 5.5 mEq/L: Mild hyperkalemia
# - K > 6.0 mEq/L: Moderate hyperkalemia (ECG changes)
# - K > 6.5 mEq/L: Severe hyperkalemia (cardiac arrest risk)
#
# Risk factors: AKI, ACE inhibitors, potassium supplements,
# tissue breakdown, metabolic acidosis
#
# Reference: AHA/ACC Guidelines for Hyperkalemia Management

scenario: Hyperkalemia_Detection
version: "0.3.0"
description: "Detect and stage hyperkalemia with trajectory analysis"

# ── Audit Block ──────────────────────────────────
audit:
  intent: "Detect dangerous potassium elevations that can cause cardiac arrhythmias"
  rationale: "Hyperkalemia can cause life-threatening cardiac arrest; early detection enables timely treatment"
  provenance: "AHA/ACC Guidelines for Hyperkalemia Management"

# ── Population ───────────────────────────────────
population:
  include:
    - age >= 18
  exclude:
    - dialysis_status == "chronic_hemodialysis"

# ── Signal Bindings ──────────────────────────────
signals:
  K:
    ref: potassium
    concept_id: 3023103
    unit: mEq/L
    domain: measurement

  Cr:
    ref: creatinine
    concept_id: 3016723
    unit: mg/dL
    domain: measurement

  pH:
    ref: blood_ph
    concept_id: 3019977
    unit: pH
    domain: measurement

  Glucose:
    ref: glucose
    concept_id: 3004501
    unit: mg/dL
    domain: measurement

# ── Trend Computations (v0.3: NUMERIC VALUES ONLY) ─────
trends:
  # Potassium values
  k_current:
    expr: last(K)
    type: float
    unit: mEq/L
    description: "Current potassium level"

  k_slope_24h:
    expr: slope(K, 24h)
    type: float
    description: "Potassium trend over 24 hours"

  k_slope_12h:
    expr: slope(K, 12h)
    type: float
    description: "Potassium trend over 12 hours"

  k_delta_12h:
    expr: delta(K, 12h)
    type: float
    unit: mEq/L
    description: "Potassium change over 12 hours"

  k_delta_6h:
    expr: delta(K, 6h)
    type: float
    unit: mEq/L
    description: "Potassium change over 6 hours"

  # Creatinine for AKI detection
  cr_delta_48h:
    expr: delta(Cr, 48h)
    type: float
    unit: mg/dL
    description: "Creatinine change over 48 hours"

  # pH value
  ph_current:
    expr: last(pH)
    type: float
    unit: pH
    description: "Current blood pH"

  # Glucose value
  glucose_current:
    expr: last(Glucose)
    type: float
    unit: mg/dL
    description: "Current glucose level"

# ── Logic Layer (v0.3: ALL COMPARISONS HERE) ─────
logic:
  # Absolute potassium levels
  k_elevated_mild:
    when: k_current > 5.5
    description: "Potassium > 5.5 mEq/L (mild hyperkalemia)"

  k_elevated_moderate:
    when: k_current > 6.0
    description: "Potassium > 6.0 mEq/L (moderate - ECG changes likely)"

  k_elevated_severe:
    when: k_current > 6.5
    description: "Potassium > 6.5 mEq/L (severe - cardiac arrest risk)"

  k_critical:
    when: k_current > 7.0
    description: "Potassium > 7.0 mEq/L (critical emergency)"

  # Potassium trajectory
  k_rising:
    when: k_slope_24h > 0
    description: "Potassium trending upward"

  k_rising_fast:
    when: k_delta_12h > 0.5
    description: "Rapid potassium rise (>0.5 mEq/L in 12h)"

  k_rising_very_fast:
    when: k_delta_6h > 0.5
    description: "Very rapid potassium rise (>0.5 mEq/L in 6h)"

  # Recovery pattern
  k_falling:
    when: k_slope_12h < 0
    description: "Potassium trending downward (treatment response)"

  # Contributing factors
  aki_present:
    when: cr_delta_48h >= 0.3
    description: "AKI present (impaired K excretion)"

  acidosis_present:
    when: ph_current < 7.35
    description: "Acidosis (shifts K extracellular)"

  hyperglycemia:
    when: glucose_current > 250
    description: "Severe hyperglycemia (osmotic K shift)"

  # Staging
  hyperkalemia_mild:
    when: k_elevated_mild AND NOT k_elevated_moderate
    severity: low
    description: "Mild hyperkalemia (5.5-6.0) - monitor and investigate cause"

  hyperkalemia_moderate:
    when: k_elevated_moderate AND NOT k_elevated_severe
    severity: medium
    description: "Moderate hyperkalemia (6.0-6.5) - ECG, prepare treatment"

  hyperkalemia_severe:
    when: k_elevated_severe AND NOT k_critical
    severity: high
    description: "Severe hyperkalemia (6.5-7.0) - urgent treatment required"

  hyperkalemia_critical:
    when: k_critical
    severity: critical
    description: "Critical hyperkalemia (>7.0) - immediate intervention"

  # Trajectory-based alerts
  hyperkalemia_worsening:
    when: k_elevated_mild AND k_rising_fast
    severity: high
    description: "Hyperkalemia with rapid rise - escalating risk"

  hyperkalemia_rapid_onset:
    when: k_rising_very_fast
    severity: high
    description: "Very rapid K rise - investigate tissue breakdown, transfusion"

  # Context-aware alerts
  hyperkalemia_with_aki:
    when: k_elevated_moderate AND aki_present
    severity: high
    description: "Hyperkalemia with AKI - impaired excretion, monitor closely"

  hyperkalemia_with_acidosis:
    when: k_elevated_moderate AND acidosis_present
    severity: high
    description: "Hyperkalemia with acidosis - pH correction may help"

  # Recovery indicator
  hyperkalemia_responding:
    when: k_elevated_mild AND k_falling
    severity: low
    description: "Hyperkalemia responding to treatment"

  # Any hyperkalemia
  hyperkalemia_present:
    when: k_elevated_mild OR k_elevated_moderate OR k_elevated_severe OR k_critical
    severity: medium
    description: "Hyperkalemia present at any level"

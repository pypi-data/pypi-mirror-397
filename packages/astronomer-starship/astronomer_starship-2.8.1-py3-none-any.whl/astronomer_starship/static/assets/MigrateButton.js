import{r}from"./react-core.js";import{a as D}from"./http.js";import{f as q,c as O,l as z,a as B,b as P,o as H,G as K}from"./index.js";import{G,P as l,j as w,d as W}from"./chakra.js";import{M as Y,a as J}from"./PageLoading.js";function F({route:n,idField:a,itemName:b}){const{targetUrl:i,token:c}=q(),p=O(),u=G(),[k,m]=r.useState(!0),[h,x]=r.useState(null),[t,y]=r.useState([]),[C,M]=r.useState(!1),$=r.useCallback((e,s)=>e.map(o=>({...o,exists:s.some(d=>d[a]===o[a])})),[a]),S=r.useCallback(async()=>{m(!0),x(null);try{const[e,s]=await Promise.all([D.get(z(n)),D.get(B(i+n),{headers:P(c)})]);if(e.status===200&&s.status===200)y($(e.data,s.data));else throw new Error("Invalid response from server")}catch(e){x(e),e.response?.status===401&&p({type:"invalidate-token"})}finally{m(!1)}},[i,c,p,n,$]);r.useEffect(()=>{S()},[S]);const E=r.useCallback((e,s)=>{y(o=>o.map(d=>d[a]===e?{...d,exists:s}:d))},[a]),f=r.useCallback(async()=>{const e=t.filter(g=>!g.exists);if(e.length===0)return;M(!0);let s=0,o=0;(await Promise.allSettled(e.map(async g=>{const A=await D.post(B(i+n),H(g,"exists"),{headers:P(c)});return{item:g,response:A}}))).forEach(g=>{if(g.status==="fulfilled"){s+=1;const{item:A}=g.value;y(U=>U.map(R=>R[a]===A[a]?{...R,exists:!0}:R))}else o+=1}),M(!1);const T=`${b}${s!==1?"s":""}`;let I="success";s===0?I="error":o>0&&(I="warning");const L=()=>s===0?`All ${e.length} items failed to migrate. Check your connection and permissions.`:o>0?`${o} item${o!==1?"s":""} failed to migrate. You can retry individual items.`:`Successfully copied ${s} ${T} to target Airflow instance`;u({title:s>0?`Migrated ${s} ${T} to remote`:"Migration failed",description:L(),status:I,duration:5e3,isClosable:!0,variant:"outline"})},[t,i,c,u,n,a,b]),j=t.length,v=t.filter(e=>e.exists).length;return{loading:k,error:h,data:t,isMigratingAll:C,totalItems:j,migratedItems:v,fetchData:S,handleItemStatusChange:E,handleMigrateAll:f,targetUrl:i,token:c}}function Q({route:n,headers:a={},existsInRemote:b=!1,sendData:i,isDisabled:c=!1,onStatusChange:p=null,itemName:u="item"}){const[k,m]=r.useState(!1),[h,x]=r.useState(null),[t,y]=r.useState(b),C=G(),M=r.useCallback(async()=>{m(!0),x(null);try{const f=await D({method:t?"delete":"post",url:n,headers:a,data:i}),v=[200,201,204].includes(f.status)?!t:t;y(v),p?.(v),C({title:t?`Deleted ${u} from remote`:`Migrated ${u} to remote`,description:t?"Successfully removed from target Airflow instance":"Successfully copied to target Airflow instance",status:"success",duration:4e3,isClosable:!0,variant:"outline"})}catch(f){x(f),C({title:`Failed to ${t?"delete":"migrate"} ${u}`,description:f.response?.data?.error||f.message,status:"error",duration:6e3,isClosable:!0,variant:"outline"})}finally{m(!1)}},[t,n,a,i,p,C,u]),$=()=>h?"Error!":t?"Delete":"Migrate",S=()=>h?w.jsx(Y,{}):t?w.jsx(J,{}):w.jsx(K,{}),E=()=>h||t?"red":"green";return w.jsx(W,{size:"sm",variant:"outline",isDisabled:c,isLoading:k,loadingText:t?"Deleting...":"Migrating...",onClick:M,colorScheme:E(),leftIcon:S(),children:$()})}Q.propTypes={route:l.string.isRequired,headers:l.objectOf(l.string),existsInRemote:l.bool,sendData:l.object.isRequired,isDisabled:l.bool,onStatusChange:l.func,itemName:l.string};export{Q as M,F as u};

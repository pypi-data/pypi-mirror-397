import{P as _,j as e,T as N,$ as xe,Q as _e,G as ue,d as z,a as U,a0 as we,b as B,B as V,K as je,H as be,p as Y,w as Q,a1 as Z,a2 as J,a3 as X,a4 as ee,a5 as re,a6 as ae,R as ve,V as Se,a7 as te,a8 as se,L as ne,E as ie,a9 as ye}from"./chakra.js";import{c as De,g as Ae,r as b}from"./react-core.js";import{a as D}from"./http.js";import{M as Re,a as Ce,b as Te,c as oe,d as le,P as Ee,D as ke}from"./PageLoading.js";import{G as Ge,a as O,e as A,b as H,l as $,f as Pe,k as Ie,c as Fe,m as Me}from"./index.js";import{c as $e}from"./table.js";import"./icons.js";import"./router.js";var de={exports:{}};(function(d,h){(function(o,g){d.exports=g()})(De,function(){function o(a,r){var t,s,i;for(t=1,s=arguments.length;t<s;++t)if(r=arguments[t],r!=null)for(i in r)j(r,i)&&(a[i]=r[i]);return a}function g(a,r){return r.length-a.length}function R(a,r){return a.factor-r.factor}function S(a){return a.replace(/([.*+?=^!:${}()|[\]/\\])/g,"\\$1")}function w(a,r){var t,s;for(t=0,s=a.length;t<s;++t)r(a[t],t)}function y(a,r){var t;for(t in a)j(a,t)&&r(a[t],t)}var j=function(a){return function(t,s){return t!=null&&a.call(t,s)}}(Object.prototype.hasOwnProperty);function c(a,r){for(;typeof r=="string";)r=a[r];return r}function n(a){this._prefixes=a;var r=[],t=[];y(a,function(i,l){r.push(S(l)),t.push({factor:i,prefix:l})});var s=this._lcPrefixes={};y(a,function(i,l){var u=l.toLowerCase();j(a,u)||(s[u]=l)}),t.sort(R),this._list=t,r.sort(g),this._regexp=new RegExp("^\\s*(-)?\\s*(\\d+(?:\\.\\d+)?)\\s*("+r.join("|")+")\\s*(.*)\\s*?$","i")}n.create=function(r,t,s){var i={};return s===void 0&&(s=0),w(r,function(l,u){i[l]=Math.pow(t,u+s)}),new n(i)},n.prototype.findPrefix=function(r){for(var t=this._list,s=0,i=t.length-1,l,u;s!==i;)l=s+i+1>>1,u=t[l].factor,u>r?i=l-1:s=l;return t[s]},n.prototype.parse=function(r,t){var s=r.match(this._regexp);if(s!==null){var i=s[3],l;if(j(this._prefixes,i))l=this._prefixes[i];else if(!t&&(i=i.toLowerCase(),j(this._lcPrefixes,i)))i=this._lcPrefixes[i],l=this._prefixes[i];else return;var u=+s[2];return s[1]!==void 0&&(u=-u),{factor:l,prefix:i,unit:s[4],value:u}}};var p={binary:n.create(",Ki,Mi,Gi,Ti,Pi,Ei,Zi,Yi".split(","),1024),SI:n.create("y,z,a,f,p,n,Âµ,m,,k,M,G,T,P,E,Z,Y".split(","),1e3,-8)},G={maxDecimals:2,separator:" ",unit:""},P={scale:"SI",strict:!1};function x(a,r){r=o({},G,r);var t=r.decimals;t!==void 0&&delete r.maxDecimals;var s=f(a,r);a=t!==void 0?s.value.toFixed(t):String(s.value);var i=s.prefix+r.unit;return i===""?a:a+r.separator+i}var C={scale:"binary",unit:"B"};function I(a,r){return x(a,r===void 0?C:o({},C,r))}function v(a,r){var t=T(a,r);return t.value*t.factor}function T(a,r){if(typeof a!="string")throw new TypeError("str must be a string");r=o({},P,r);var t=c(p,r.scale);if(t===void 0)throw new Error("missing scale");var s=t.parse(a,r.strict);if(s===void 0)throw new Error("cannot parse str");return s}function f(a,r){if(a===0)return{value:0,prefix:""};if(a<0){var t=f(-a,r);return t.value=-t.value,t}if(typeof a!="number"||Number.isNaN(a))throw new TypeError("value must be a number");r=o({},P,r);var s=c(p,r.scale);if(s===void 0)throw new Error("missing scale");var i,l=r.maxDecimals,u=l==="auto";u?i=10:l!==void 0&&(i=Math.pow(10,l));var m=r.prefix,k;if(m!==void 0){if(!j(s._prefixes,m))throw new Error("invalid prefix");k=s._prefixes[m]}else{var F=s.findPrefix(a);if(i!==void 0)do{k=F.factor;var M=k/i;a=Math.round(a/M)*M}while((F=s.findPrefix(a)).factor!==k);else k=F.factor;m=F.prefix}return a=i===void 0?a/k:Math.round(a*i/k)/i,u&&Math.abs(a)>=10&&(a=Math.round(a)),{prefix:m,value:a}}return x.bytes=I,x.parse=v,v.raw=T,x.raw=f,x.Scale=n,x})})(de);var Ne=de.exports;const ce=Ae(Ne);function W({tooltip:d}){return e.jsx(N,{hasArrow:!0,label:d,children:e.jsx(xe,{variant:"ghost","aria-label":"Info",icon:e.jsx(_e,{})})})}W.propTypes={tooltip:_.string.isRequired};function fe({isDisabled:d=!1,children:h}){return d?e.jsx(N,{hasArrow:!0,label:d,children:h}):h}fe.propTypes={isDisabled:_.oneOfType([_.bool,_.string]),children:_.node.isRequired};function he({url:d,token:h,dagId:o,limit:g=1e3,batchSize:R=100,existsInRemote:S=!1,isDisabled:w=!1,onMigrate:y=null,onDelete:j=null}){const[c,n]=b.useState(0),[p,G]=b.useState(null),P=ue(),[x,C]=b.useState(S),[I,v]=b.useState(!1),T=c>0&&c<100,f=(u,m="migrate")=>{C(!1),n(0),v(!1),P({title:`Failed to ${m} DAG history for "${o}"`,description:u.response?.data?.error||u.response?.data||u.message,status:"error",isClosable:!0,variant:"outline",duration:6e3}),G(u)},a=async()=>{if(x){v(!0),n(50);try{await D({method:"delete",url:O(d+A.DAG_RUNS_ROUTE),headers:H(h),params:{dag_id:o}}),C(!1),j?.(o),n(100),setTimeout(()=>{n(0),v(!1)},500)}catch(m){f(m,"delete"),v(!1)}return}n(1);const u=async(m=0,k=null)=>{const F=Math.min(g-m,R);try{const[M,me,ge]=await Promise.all([D.get($(A.DAG_RUNS_ROUTE),{params:{dag_id:o,limit:F,offset:m}}),D.get($(A.TASK_INSTANCE_ROUTE),{params:{dag_id:o,limit:F,offset:m}}),D.get($(A.TASK_INSTANCE_HISTORY_ROUTE),{params:{dag_id:o,limit:F,offset:m}})]),L=k||Math.min(M.data.dag_run_count,g);if(M.data.dag_runs.length===0){n(100),C(m>0),y?.(o,L),setTimeout(()=>n(0),500);return}const K=await D.post(O(d+A.DAG_RUNS_ROUTE),{dag_runs:M.data.dag_runs},{params:{dag_id:o},headers:H(h)});if(K.status!==200)throw new Error("Failed to create DAG runs");if((await D.post(O(d+A.TASK_INSTANCE_ROUTE),{task_instances:me.data.task_instances},{params:{dag_id:o},headers:H(h)})).status!==200)throw new Error("Failed to create task instances");if((await D.post(O(d+A.TASK_INSTANCE_HISTORY_ROUTE),{task_instances:ge.data.task_instances},{params:{dag_id:o},headers:H(h)})).status!==200)throw new Error("Failed to create task instance history");const q=K.data.dag_run_count;if(q<L){const pe=Math.min(99,Math.round(q/L*100));n(pe),await u(m+R,L)}else n(100),C(!0),y?.(o,L),setTimeout(()=>n(0),500)}catch(M){f(M)}};await u(0)},r=()=>T?e.jsxs(U,{spacing:2,children:[e.jsx(we,{value:c,size:"20px",thickness:"10px",color:I?"red.400":"green.400",trackColor:"gray.200",isIndeterminate:c<2}),e.jsxs(B,{fontSize:"xs",children:[I?"Deleting":"Migrating"," ",Math.round(c),"%"]})]}):x?"Delete":w?"Not Found":p?"Error!":"Migrate",t=x||I,s=t||p?"error.600":"success.600",i=t||p?"error.500":"success.500",l=t||p?"error.50":"success.50";return e.jsx(fe,{isDisabled:w,children:e.jsx(z,{size:"sm",variant:"outline",isDisabled:w||T,leftIcon:T?null:p?e.jsx(Re,{}):x?e.jsx(Ce,{}):w?e.jsx(Te,{}):e.jsx(Ge,{}),colorScheme:void 0,color:s,borderColor:i,_hover:{bg:l},_disabled:T?{color:s,borderColor:i,opacity:.8,cursor:"progress"}:{color:"gray.600",borderColor:"gray.500",opacity:1},onClick:a,minW:T?"130px":void 0,children:r()})})}he.propTypes={url:_.string.isRequired,token:_.string.isRequired,dagId:_.string.isRequired,limit:_.number,batchSize:_.number,existsInRemote:_.bool,isDisabled:_.oneOfType([_.bool,_.string]),onMigrate:_.func,onDelete:_.func};function ze(d,h){const o={};return d.forEach(g=>{o[g.dag_id]={local:g,remote:null}}),h.forEach(g=>{o[g.dag_id]&&(o[g.dag_id].remote=g)}),Object.values(o)}const E=$e();function Ue(d){const{row:h,getValue:o}=d;return e.jsx(N,{hasArrow:!0,label:`File: ${h.original.local.fileloc}`,children:e.jsx(B,{fontWeight:"semibold",children:o()})})}function Oe(d){const h=d.getValue();return!h||h.length===0?null:e.jsx(U,{spacing:1,flexWrap:"wrap",children:h.map(o=>e.jsx(ye,{size:"sm",colorScheme:"amethyst",variant:"solid",children:o},o))})}function He(d){return d.getValue()||"None"}function Le(d){const{targetUrl:h,token:o,limit:g,batchSize:R,handleMigrate:S,handleDelete:w,localAirflowVersion:y,handlePausedClick:j}=d;return[E.accessor(c=>c.local.dag_id,{id:"dagId",header:"ID",cell:Ue}),E.accessor(c=>c.local.tags,{id:"tags",header:"Tags",cell:Oe}),E.accessor(c=>c.local.schedule_interval,{id:"schedule",header:"Schedule",cell:He}),E.accessor(c=>c.local.description,{id:"description",header:"Description"}),E.accessor(c=>c.local.owners,{id:"owners",header:"Owners"}),E.display({id:"local_is_paused",header:()=>e.jsxs(e.Fragment,{children:["Local",e.jsx(W,{tooltip:"Toggle to pause/unpause DAG in local"})]}),cell:c=>{const{original:n}=c.row;return e.jsxs(e.Fragment,{children:[e.jsx(te,{colorScheme:"success",isChecked:!n.local.is_paused,onChange:()=>j(!n.local.is_paused,n.local.dag_id,!0)}),e.jsx(N,{hasArrow:!0,label:"DAG Run Count",children:e.jsx(se,{mx:1,fontSize:"sm",variant:"outline",colorScheme:n.local.dag_run_count>0?"teal":"red",children:ce(n.local.dag_run_count)})})]})}}),E.display({id:"local_url",header:"Local URL",cell:c=>{const{original:n}=c.row;return e.jsxs(ne,{isExternal:!0,href:$(Me(n.local.dag_id,y)),color:"brand.700",children:["View DAG"," ",e.jsx(ie,{mx:"2px"})]})}}),E.display({id:"remote_is_paused",header:()=>e.jsxs(e.Fragment,{children:["Remote",e.jsx(W,{tooltip:"Toggle to pause/unpause DAG in remote"})]}),cell:c=>{const{original:n}=c.row;return n.remote?e.jsxs(e.Fragment,{children:[e.jsx(te,{colorScheme:"success",isChecked:!n.remote?.is_paused,onChange:()=>j(!n.remote?.is_paused,n.local.dag_id,!1)}),e.jsx(N,{hasArrow:!0,label:"DAG Run Count",children:e.jsx(se,{mx:1,fontSize:"sm",variant:"outline",colorScheme:n.remote?.dag_run_count>0?"teal":"red",children:ce(n.remote?.dag_run_count||0)})})]}):null}}),E.display({id:"remote_url",header:"Remote URL",cell:c=>{const{original:n}=c.row;return n.remote?e.jsxs(ne,{isExternal:!0,href:`${h}/dags/${n.remote.dag_id}`,color:"brand.700",children:["View DAG"," ",e.jsx(ie,{mx:"2px"})]}):null}}),E.display({id:"migrate",header:"Migrate",meta:{align:"right"},cell:c=>{const{original:n}=c.row;let p=!1;return n.remote?.dag_id?!n.local.dag_run_count&&!n.remote?.dag_run_count&&(p="No DAG Runs to migrate"):p="DAG not found in remote",e.jsx(he,{url:h,token:o,dagId:n.local.dag_id,limit:Number(g),batchSize:Number(R),existsInRemote:!!n.remote?.dag_run_count,isDisabled:p,onMigrate:S,onDelete:w})}})]}function er(){const{targetUrl:d,token:h,localAirflowVersion:o}=Pe(),{limit:g,batchSize:R}=Ie(),S=Fe(),w=ue(),[y,j]=b.useState(!0),[c,n]=b.useState(null),[p,G]=b.useState([]),P=b.useCallback(async()=>{j(!0),n(null);try{if(!o){const r=await D.get($("/api/starship/info"));r.status===200&&r.data?.airflow_version&&S({type:"set-local-airflow-version",version:r.data.airflow_version})}const[f,a]=await Promise.all([D.get($(A.DAGS_ROUTE)),D.get(O(d+A.DAGS_ROUTE),{headers:H(h)})]);if(f.status===200&&a.status===200)G(ze(f.data,a.data));else throw new Error("Invalid response from server")}catch(f){n(f),f.response?.status===401&&S({type:"invalidate-token"})}finally{j(!1)}},[d,h,S,o]);b.useEffect(()=>{P()},[P]);const x=b.useCallback(async(f,a,r)=>{const t=r?$(A.DAGS_ROUTE):O(d+A.DAGS_ROUTE);try{const s=await D.patch(t,{dag_id:a,is_paused:f},{headers:H(h)});G(i=>i.map(l=>{if(l.local.dag_id!==a)return l;const u=r?"local":"remote";return{...l,[u]:{...l[u],is_paused:s.data.is_paused}}}))}catch(s){w({title:"Failed to update DAG pause state",description:s.message,status:"error",isClosable:!0,variant:"outline",duration:6e3})}},[d,h,w]),C=b.useCallback((f,a)=>{G(r=>r.map(t=>t.local.dag_id!==f?t:{...t,remote:{...t.remote,dag_run_count:a}}))},[]),I=b.useCallback(f=>{G(a=>a.map(r=>r.local.dag_id!==f?r:{...r,remote:{...r.remote,dag_run_count:0}}))},[]),v=b.useCallback(async(f,a)=>{const r=p.filter(u=>{const m=f?u.local:u.remote;return m&&m.is_paused!==a});if(r.length===0){w({title:"No changes needed",description:`All ${f?"local":"remote"} DAGs are already ${a?"paused":"active"}`,status:"info",duration:4e3,variant:"outline"});return}let t=0;for(const u of r)try{await x(a,u.local.dag_id,f),t+=1}catch{}const s=t!==1?"DAGs":"DAG",i=f?"local":"remote",l=r.length-t;w({title:`${a?"Paused":"Activated"} ${t} ${i} ${s}`,description:l>0?`${l} ${l!==1?"DAGs":"DAG"} failed to update`:`Successfully updated ${i} Airflow instance`,status:l>0?"warning":"success",duration:4e3,variant:"outline"})},[p,w,x]),T=b.useMemo(()=>Le({targetUrl:d,token:h,limit:g,batchSize:R,handleMigrate:C,handleDelete:I,localAirflowVersion:o,handlePausedClick:x}),[d,h,g,R,C,I,o,x]);return e.jsxs(V,{children:[e.jsxs(je,{direction:{base:"column",md:"row"},justify:"space-between",align:{base:"flex-start",md:"center"},mb:3,children:[e.jsxs(V,{children:[e.jsx(be,{size:"md",mb:.5,children:"DAG History"}),e.jsx(B,{fontSize:"xs",color:"gray.600",children:"Migrate DAGs and task history to prevent rescheduling."})]}),e.jsxs(U,{spacing:2,children:[e.jsx(N,{hasArrow:!0,label:"Total DAG Runs to migrate",children:e.jsx(Y,{minW:"40",children:e.jsxs(Q,{size:"sm",children:[e.jsx(Z,{children:"# DAG Runs"}),e.jsxs(J,{value:g,onChange:f=>S({type:"set-limit",limit:Number(f)}),children:[e.jsx(X,{}),e.jsxs(ee,{children:[e.jsx(re,{}),e.jsx(ae,{})]})]})]})})}),e.jsx(N,{hasArrow:!0,label:"DAG Runs per batch",children:e.jsx(Y,{minW:"40",children:e.jsxs(Q,{size:"sm",children:[e.jsx(Z,{children:"Batch Size"}),e.jsxs(J,{value:R,onChange:f=>S({type:"set-batch-size",batchSize:Number(f)}),children:[e.jsx(X,{}),e.jsxs(ee,{children:[e.jsx(re,{}),e.jsx(ae,{})]})]})]})})}),e.jsx(z,{size:"sm",leftIcon:e.jsx(ve,{}),onClick:P,variant:"outline",isLoading:y,flexShrink:0,children:"Refresh"})]})]}),e.jsxs(U,{spacing:2,mb:3,justify:"space-between",children:[e.jsxs(U,{spacing:2,children:[e.jsx(B,{fontSize:"sm",fontWeight:"semibold",color:"gray.600",children:"Local:"}),e.jsx(z,{size:"sm",leftIcon:e.jsx(oe,{}),onClick:()=>v(!0,!0),colorScheme:"orange",variant:"outline",children:"Pause All"}),e.jsx(z,{size:"sm",leftIcon:e.jsx(le,{}),onClick:()=>v(!0,!1),colorScheme:"green",variant:"outline",children:"Unpause All"})]}),e.jsxs(U,{spacing:2,children:[e.jsx(B,{fontSize:"sm",fontWeight:"semibold",color:"gray.600",children:"Remote:"}),e.jsx(z,{size:"sm",leftIcon:e.jsx(oe,{}),onClick:()=>v(!1,!0),colorScheme:"orange",variant:"outline",children:"Pause All"}),e.jsx(z,{size:"sm",leftIcon:e.jsx(le,{}),onClick:()=>v(!1,!1),colorScheme:"green",variant:"outline",children:"Unpause All"})]})]}),e.jsx(Se,{spacing:3,align:"stretch",w:"100%",children:e.jsx(V,{children:y||c?e.jsx(Ee,{loading:y,error:c}):e.jsx(ke,{data:p,columns:T,searchPlaceholder:"Search DAGs by ID, tags, owners..."})})})]})}export{er as default};

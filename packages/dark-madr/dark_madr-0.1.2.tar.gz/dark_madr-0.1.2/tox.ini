[tox]
min_version = 4.0
env_list = py311, py312, py313, lint, type

[testenv]
description = Run tests with pytest
deps =
    pytest>=7.4.0
    pytest-cov>=4.1.0
commands =
    pytest {posargs:tests}

[testenv:lint]
description = Run linting with ruff
skip_install = true
deps =
    ruff>=0.1.0
commands =
    ruff check src tests
    ruff format --check src tests

[testenv:type]
description = Run type checking with mypy
deps =
    mypy>=1.8.0
    pydantic>=2.0.0
    click
    rich
commands =
    mypy src --strict --ignore-missing-imports

[testenv:format]
description = Format code with ruff
skip_install = true
deps =
    ruff>=0.1.0
commands =
    ruff check --fix src tests
    ruff format src tests

[testenv:security]
description = Run security checks with bandit
skip_install = true
deps =
    bandit[toml]
commands =
    bandit -r src --skip B101,B404,B603,B607 -c pyproject.toml

# Release automation
[testenv:prepare-release]
description = Prepare a release (update CHANGELOG.md)
skip_install = true
allowlist_externals =
    python
    git-cliff
commands =
    python scripts/prepare_release.py {posargs}

[testenv:release]
description = Complete the release (commit, tag, push)
skip_install = true
allowlist_externals =
    python
    git
    tox
commands =
    python scripts/release.py --yes {posargs}

# Build and publish
[testenv:build]
description = Build distribution packages
skip_install = true
allowlist_externals =
    uv
    python
commands_pre =
    python -c "import shutil; shutil.rmtree('dist', ignore_errors=True)"
commands =
    uv build

[testenv:publish]
description = Publish to PyPI (set UV_PUBLISH_TOKEN env var)
skip_install = true
allowlist_externals =
    uv
    python
passenv =
    UV_PUBLISH_TOKEN
commands_pre =
    python -c "import shutil; shutil.rmtree('dist', ignore_errors=True)"
commands =
    uv build
    uv publish

[testenv:publish-test]
description = Publish to TestPyPI (set UV_PUBLISH_TOKEN env var)
skip_install = true
allowlist_externals =
    uv
    python
passenv =
    UV_PUBLISH_TOKEN
commands_pre =
    python -c "import shutil; shutil.rmtree('dist', ignore_errors=True)"
commands =
    uv build
    uv publish --publish-url https://test.pypi.org/legacy/

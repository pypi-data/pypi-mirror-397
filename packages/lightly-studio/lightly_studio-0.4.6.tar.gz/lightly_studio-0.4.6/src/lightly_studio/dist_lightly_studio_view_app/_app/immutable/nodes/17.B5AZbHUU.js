import"../chunks/CWj6FrbW.js";import{x as ve,i as re,p as he,d as B,e as Oe,c as S,h as D,g as e,s as ne,r as I,t as pe,a as ye,u as je,b as u,n as Ke,f as q}from"../chunks/DkbXUtyG.js";import{d as xe}from"../chunks/D9SC3jBb.js";import{f as z,a as h,c as Y}from"../chunks/CmLg0ys7.js";import{i as M,s as _,a as Qe}from"../chunks/B_1cpokE.js";import{d as be,k as fe,a as Re,s as H}from"../chunks/C8mfFM-u.js";import{t as Ue,q as Ye,l as Ze,x as ge,G as Je,L as Xe,z as $e}from"../chunks/CGY1p9L4.js";import{b as et}from"../chunks/DuUalyFS.js";import"../chunks/CvGjimpO.js";import{u as _e}from"../chunks/KNLP4aJU.js";import"../chunks/D_FFv0Oe.js";import{l as tt,u as at,f as it,e as st}from"../chunks/VYb2dkNs.js";import"../chunks/69_IOA4Y.js";import"../chunks/C80h3dJx.js";import{p as dt}from"../chunks/DwIonDAZ.js";import{u as ot}from"../chunks/da7Oy_lO.js";import"../chunks/DtWZc_tl.js";import{g as rt}from"../chunks/xGHZQ1pe.js";import{e as nt}from"../chunks/BpLiSKgx.js";import{r as lt}from"../chunks/BRmB-kJ9.js";import{V as ut}from"../chunks/BiqpDEr0.js";import{V as ct}from"../chunks/DiZ5o5vz.js";const mt=(r,t,a)=>{const c=tt({path:{dataset_id:r},query:{limit:30},body:{filter:t,text_embedding:a}}),m=Ue({...c,getNextPageParam:g=>g.nextCursor||void 0}),x=at(),F=()=>{x.invalidateQueries({queryKey:c.queryKey})},b=ve([]),p=ve(0);return m.subscribe(g=>{if(g.isSuccess){const v=g.data.pages.flatMap(C=>C.data);b.set(v),p.set(g.data.pages[0].total_count)}}),{data:b,loadMore:()=>{re(m).hasNextPage&&!re(m).isFetchingNextPage&&re(m).fetchNextPage()},query:m,refresh:F,totalCount:p}};function vt(r,t){rt(lt.toVideosDetails(t.video.sample.dataset_id,t.video.sample_id,t.index))}var ft=z('<div class="video-frame-container relative overflow-hidden rounded-lg svelte-1s2jysz" role="img"><!> <!></div>');function gt(r,t){he(t,!0);let a=B(null),c=B(null),m=0,x=!1,F=!1;const b=25;let p=null;const L=200;let g=!1,v=B(Oe(t.video.frame==null?[]:[t.video.frame]));async function C(){g=!0,p=setTimeout(async()=>{await W(),e(a)&&(e(a).readyState<2&&await new Promise(i=>{var s;return(s=e(a))==null?void 0:s.addEventListener("loadeddata",i,{once:!0})}),g&&e(a).play())},L)}function n(){var i;g=!1,p&&(clearTimeout(p),p=null),e(a)&&((i=e(a))==null||i.pause(),e(a).currentTime=0)}function Z(i,s){D(c,i,!0),s!=null&&s%b==0&&s!=0&&W()}async function W(){var O,j,K;if(x||F)return;x=!0;const i=await nt({path:{video_frame_dataset_id:(O=t.video.frame)==null?void 0:O.sample.dataset_id},query:{cursor:m,limit:b},body:{filter:{video_id:t.video.sample_id}}}),s=((j=i==null?void 0:i.data)==null?void 0:j.data)??[];if(s.length===0){F=!0,x=!1;return}D(v,[...e(v),...s],!0),m=((K=i==null?void 0:i.data)==null?void 0:K.nextCursor)??m+b,x=!1}var w=ft();w.__dblclick=[vt,t];var G=S(w);ct(G,{get video(){return t.video},get frames(){return e(v)},update:Z,muted:!0,playsinline:!0,preload:"metadata",handleMouseEnter:C,handleMouseLeave:n,className:"h-full w-full cursor-pointer rounded-lg shadow-md",get videoEl(){return e(a)},set videoEl(i){D(a,i,!0)}});var J=ne(G,2);{var X=i=>{ut(i,{get width(){return t.size},get height(){return t.size},get sampleWidth(){return t.video.width},get sampleHeight(){return t.video.height},get sample(){return e(c)}})};M(J,i=>{e(c)&&i(X)})}I(w),pe(()=>be(w,`width: var(${t.video.width}); height: var(${t.video.height});`)),h(r,w),ye()}xe(["dblclick"]);function _t(r,t,a){const c=r.currentTarget.dataset.sampleId;t(c,a().params.dataset_id)}function ht(r,t,a){if(r.key==="Enter"||r.key===" "){r.preventDefault();const c=r.currentTarget.dataset.sampleId;t(c,a().params.dataset_id)}}var pt=z('<div class="flex h-full w-full items-center justify-center"><!> <div>Loading videos...</div></div>'),yt=z(`<div class="flex h-full w-full items-center justify-center"><div class="text-center text-muted-foreground"><div class="mb-2 text-lg font-medium">No videos found</div> <div class="text-sm">This dataset doesn't contain any videos.</div></div></div>`),xt=z('<div data-testid="video-grid-item" role="button" tabindex="0"><div class="absolute right-7 top-1 z-10"><!></div> <div class="relative overflow-hidden rounded-lg" style="width: var(--sample-width); height: var(--sample-height);"><!></div></div>'),bt=z('<div class="flex justify-center p-4"><!></div>'),wt=z("<!> <!>",1),St=z('<div class="flex flex-1 flex-col space-y-4"><div class="h-full w-full flex-1 overflow-hidden"><!></div></div>');function Qt(r,t){he(t,!0);const a=()=>_(dt,"$page",n),c=()=>_(w,"$metadataValues",n),m=()=>_(W,"$tagsSelected",n),x=()=>_(e(G),"$selectedAnnotationsFilterIds",n),F=()=>_(J,"$videoBoundsValues",n),b=()=>_(i,"$textEmbedding",n),p=()=>_(e(O),"$data",n),L=()=>_(Se,"$sampleSize",n),g=()=>_(e(we),"$totalCount",n),v=()=>_(e(j),"$query",n),C=()=>_(ke,"$selectedSampleIds",n),[n,Z]=Qe(),{tagsSelected:W}=ot({dataset_id:a().params.dataset_id,kind:["sample"]}),{metadataValues:w}=it(),G=u(()=>t.data.selectedAnnotationFilterIds),{videoBoundsValues:J}=Ze(),X=u(()=>({sample_filter:{metadata_filters:w?st(c()):void 0,tag_ids:m().size>0?Array.from(m()):void 0},annotation_frames_label_ids:x(),...F()})),{textEmbedding:i}=_e(),s=u(()=>{var l;return mt(a().params.dataset_id,e(X),(l=b())==null?void 0:l.embedding)}),O=u(()=>e(s).data),j=u(()=>e(s).query),K=u(()=>e(s).loadMore),we=u(()=>e(s).totalCount),{sampleSize:Se,getSelectedSampleIds:Ie,setfilteredSampleCount:Ve,toggleSampleSelection:le}=_e(),ke=Ie(a().params.dataset_id),ze=16;let E=B(null),Fe=B(0),d=u(p);const $=u(()=>e(E)==null||e(E).clientWidth===0?0:e(E).clientWidth/L().width),ee=u(()=>e($)-ze);je(()=>{Ve(g())});var te=St(),Q=S(te),Ce=S(Q);{var Ee=l=>{var A=pt(),ae=S(A);ge(ae,{}),Ke(2),I(A),h(l,A)},Ae=l=>{var A=Y(),ae=q(A);{var Pe=P=>{var R=yt();h(P,R)},Te=P=>{var R=Y(),Me=q(R);{var Ne=ie=>{{const qe=(T,y)=>{let o=()=>y==null?void 0:y().index,se=()=>y==null?void 0:y().style;var U=Y(),V=q(U);{var k=N=>{var ue=Y(),De=q(ue);fe(De,()=>e(d)[o()].sample_id,Le=>{var f=xt();let ce;f.__click=[_t,le,a],f.__keydown=[ht,le,a];var de=S(f),We=S(de);{let oe=u(()=>C().has(e(d)[o()].sample_id));$e(We,{onSelect:()=>{},get isSelected(){return e(oe)}})}I(de);var me=ne(de,2),Ge=S(me);gt(Ge,{get video(){return e(d)[o()]},get size(){return e(ee)},get index(){return o()}}),I(me),I(f),pe(oe=>{ce=Re(f,1,"relative svelte-hobydo",null,ce,oe),be(f,se()),H(f,"data-sample-id",e(d)[o()].sample_id),H(f,"data-dataset-id",e(d)[o()].sample.dataset_id),H(f,"data-video-name",e(d)[o()].file_name),H(f,"data-index",o()),H(f,"aria-label",`View video: ${e(d)[o()].file_name}`)},[()=>({"video-selected":C().has(e(d)[o()].sample_id)})]),h(Le,f)}),h(N,ue)};M(V,N=>{e(d)[o()]&&N(k)})}h(T,U)},He=T=>{var y=wt(),o=q(y);fe(o,()=>e(d).length,V=>{{let k=u(()=>!v().hasNextPage||v().isFetchingNextPage);Xe(V,{get onIntersect(){return e(K)},get disabled(){return e(k)}})}});var se=ne(o,2);{var U=V=>{var k=bt(),N=S(k);ge(N,{}),I(k),h(V,k)};M(se,V=>{v().isFetchingNextPage&&V(U)})}h(T,y)};let Be=u(()=>{var T;return(T=e(E))==null?void 0:T.clientHeight});Je(ie,{get itemCount(){return e(d).length},get itemHeight(){return e($)},get itemWidth(){return e($)},get height(){return e(Be)},class:"overflow-none overflow-y-auto dark:[color-scheme:dark]",get style(){return`--sample-width: ${e(ee)??""}px; --sample-height: ${e(ee)??""}px;`},overScan:20,item:qe,footer:He,$$slots:{item:!0,footer:!0}})}};M(Me,ie=>{v().isSuccess&&e(d).length>0&&ie(Ne)},!0)}h(P,R)};M(ae,P=>{v().isSuccess&&e(d).length==0?P(Pe):P(Te,!1)},!0)}h(l,A)};M(Ce,l=>{v().isPending&&e(d).length===0?l(Ee):l(Ae,!1)})}I(Q),et(Q,l=>D(E,l),()=>e(E)),I(te),Ye(Q,"clientWidth",l=>D(Fe,l)),h(r,te),ye(),Z()}xe(["click","keydown"]);export{Qt as component};

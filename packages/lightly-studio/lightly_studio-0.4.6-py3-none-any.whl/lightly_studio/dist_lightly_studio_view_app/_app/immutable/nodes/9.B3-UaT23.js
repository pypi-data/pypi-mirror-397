import{x as Ut,i as st,p as j,$ as ht,f as M,a as O,g as a,b as d,c as I,r as A,s as S,t as G,n as pt,u as la,d as Ft,h as nt}from"../chunks/DkbXUtyG.js";import{F as da}from"../chunks/BpLiSKgx.js";import{u as Y}from"../chunks/KNLP4aJU.js";import"../chunks/CWj6FrbW.js";import{c as V,a as m,f as B,t as bt,b as ua}from"../chunks/CmLg0ys7.js";import{i as T,s as R,a as X,b as Rt,m as Tt}from"../chunks/B_1cpokE.js";import{S as jt}from"../chunks/DL9a7v5o.js";import{b as ca,a as ma}from"../chunks/DtWZc_tl.js";import{D as va,O as ga,a6 as Ht,F as fa,a7 as _a,H as ha,J as pa,a8 as ba,K as Kt,a9 as Ot,b as Aa,c as xa,C as qt,n as zt,o as Ia,u as Sa,z as ya,x as Da,d as wa,B as Pa,aa as Ca}from"../chunks/CGY1p9L4.js";import{r as K}from"../chunks/BRmB-kJ9.js";import{e as At}from"../chunks/D9SC3jBb.js";import{s as It}from"../chunks/VqWvU2yF.js";import{s as St,e as ka,u as Ma,k as Ba,d as Ea,a as Na,t as xt}from"../chunks/C8mfFM-u.js";import{g as it,c as La,a as Fa}from"../chunks/xGHZQ1pe.js";import"../chunks/CvGjimpO.js";import"../chunks/D_FFv0Oe.js";import"../chunks/69_IOA4Y.js";import{p as q}from"../chunks/C80h3dJx.js";import{S as Ra}from"../chunks/D4y7iiT3.js";import{u as Ta}from"../chunks/VRI4prUD.js";import{I as ja}from"../chunks/dHC3otuL.js";import{Z as Oa,a as Ua}from"../chunks/BscxbINH.js";import{S as Ha}from"../chunks/erjNR5MX.js";import{s as Z}from"../chunks/eAy8rZzC.js";import{o as Ka,p as qa,u as za,c as Va,q as Qa,s as Wa}from"../chunks/VYb2dkNs.js";import{B as Ga,a as Za,b as ot,c as ft,H as Ja,d as _t,D as Ya,e as Xa}from"../chunks/DSKECuqX.js";import{C as $a}from"../chunks/rsLi1iKv.js";import{S as te}from"../chunks/DCuAdx1Q.js";import{F as ae}from"../chunks/rwuuBP9f.js";const ee=({annotationIndex:s,...t})=>{const e=Ut({isLoading:!1});return(async()=>{e.update(n=>({...n,isLoading:!0}));try{const{data:n}=await da({path:{dataset_id:t.dataset_id},query:{cursor:s>0?s-1:0,limit:3,annotation_label_ids:t.annotation_label_ids,tag_ids:t.tag_ids}});if(!n){e.update(l=>({...l,isLoading:!1,error:"No annotations data received",data:void 0}));return}const{setfilteredAnnotationCount:o}=Y();o(n.total_count);let r;const u=s>0?n.data[0]:void 0;n.data.length>1&&(r=s===0?n.data[1]:n.data[2]),e.update(l=>({...l,isLoading:!1,error:void 0,data:{annotationNext:r,annotationPrevious:u}}))}catch(n){e.update(o=>({...o,isLoading:!1,error:String(n)}))}})(),e},ne=async({parent:s,params:{dataset_id:t,annotationId:e,annotationIndex:i}})=>{const{annotationsSelectedTagsIds:n,annotationsSelectedAnnotationLabelsIds:o,dataset:r}=await s(),u=parseInt(i,10),l=Ut();if(!r)throw new Error("Dataset data not found");return ee({annotationIndex:u,dataset_id:t,currentAnnotationId:e,annotation_label_ids:Array.from(st(o)),tag_ids:Array.from(st(n))}).subscribe(({data:v})=>{l.set(v)}),{annotationAdjacents:l,annotationIndex:u,annotationId:e,dataset:r}},ln=Object.freeze(Object.defineProperty({__proto__:null,load:ne},Symbol.toStringTag,{value:"Module"}));var oe=B('<div data-testid="annotation-navigation"><!></div>');function se(s,t){j(t,!0);const e=()=>R(a(r),"$annotationAdjacents",i),[i,n]=X(),o=d(()=>q.data.annotationIndex),r=d(()=>q.data.annotationAdjacents),u=q.data.datasetId,l=()=>{e().annotationNext&&it(K.toSampleWithAnnotation({datasetId:u,sampleId:e().annotationNext.parent_sample_id,annotationId:e().annotationNext.sample_id,annotationIndex:a(o)+1}),{invalidateAll:!0})},v=()=>{e().annotationPrevious&&it(K.toSampleWithAnnotation({datasetId:u,sampleId:e().annotationPrevious.parent_sample_id,annotationId:e().annotationPrevious.sample_id,annotationIndex:a(o)-1}),{invalidateAll:!0})},x=h=>{switch(h.key){case"ArrowRight":l();break;case"ArrowLeft":v();break}};var g=V();At("keydown",ht,x);var D=M(g);{var w=h=>{var P=oe(),L=I(P);{let N=d(()=>!!e().annotationPrevious),y=d(()=>!!e().annotationNext);Ha(L,{get hasPrevious(){return a(N)},get hasNext(){return a(y)},onPrevious:v,onNext:l})}A(P),m(h,P)};T(D,h=>{e()&&h(w)})}m(s,g),O(),n()}const ie={object_detection:"Object Detection",instance_segmentation:"Instance Segmentation",semantic_segmentation:"Semantic Segmentation",classification:"Classification"};var re=B('<span class="text-sm"> </span> <span class="break-all text-sm"> </span>',1);function le(s,t){var e=re(),i=M(e),n=I(i,!0);A(i);var o=S(i,2),r=I(o,!0);A(o),G(()=>{Z(n,t.label),St(o,"data-testid",`annotation-metadata-${t.id}`),Z(r,t.value)}),m(s,e)}var de=B('<span class="break-all text-sm"> </span>'),ue=B('<span class="text-sm"> </span> <!>',1);function ce(s,t){j(t,!0);const e=()=>R(r,"$result",n),i=()=>R(t.isEditingMode,"$isEditingMode",n),[n,o]=X(),r=va(),{addReversibleAction:u}=Y(),{updateAnnotation:l,refetch:v}=ga({datasetId:t.datasetId,annotationId:t.annotationId,onUpdate:t.onUpdate}),{updateAnnotations:x}=Ht({datasetId:t.datasetId}),g=d(()=>pa(e().data||[])),D=d(()=>{const p=a(g).find(b=>b.value===t.value);return p||{value:t.value,label:t.value}});var w=ue(),h=M(w),P=I(h,!0);A(h);var L=S(h,2);{var N=p=>{{const b=(c,f)=>{let E=()=>f==null?void 0:f().inputValue;ha(c,{get label(){return E()}})};let k=d(()=>a(g).find(c=>{var f;return c.value===((f=a(D))==null?void 0:f.value)}));fa(p,{get items(){return a(g)},get selectedItem(){return a(k)},name:"annotation-label",placeholder:"Select or create a label",onSelect:c=>{_a({annotations:[{sample_id:t.annotationId,annotation_label:{annotation_label_name:t.value}}],datasetId:t.datasetId,addReversibleAction:u,updateAnnotations:x,refresh:v}),l({annotation_id:t.annotationId,dataset_id:t.datasetId,label_name:c.value})},notFound:b,$$slots:{notFound:!0}})}},y=p=>{var b=de();St(b,"data-testid","annotation-metadata-label");var k=I(b,!0);A(b),G(()=>Z(k,t.value)),m(p,b)};T(L,p=>{i()?p(N):p(y,!1)})}G(()=>Z(P,t.label)),m(s,w),O(),o()}var me=B('<div class="flex flex-col gap-4"><div class="grid grid-cols-[6rem_1fr] gap-y-3 text-diffuse-foreground"></div></div>');function ve(s,t){j(t,!0);const{datasetId:e}=q.data,i=d(()=>{var v,x;if(!t.annotation)return[];let l=[{id:"label",label:"Label:",value:(x=(v=t.annotation)==null?void 0:v.annotation_label)==null?void 0:x.annotation_label_name},{id:"type",label:"Type:",value:ie[t.annotation.annotation_type]||"Unknown"}];if(t.annotation&&!ba(t.annotation)){const{height:g,width:D}=Kt(t.annotation);l=[{id:"height",label:"Height:",value:Ot(Math.round(g))+"px"},{id:"width",label:"Width:",value:Ot(Math.round(D))+"px"},...l]}return l}),{isEditingMode:n}=q.data.globalStorage;var o=V(),r=M(o);{var u=l=>{Aa(l,{title:"Annotation details",children:(v,x)=>{var g=me(),D=I(g);ka(D,21,()=>a(i),({label:w,value:h,id:P})=>w,(w,h)=>{let P=()=>a(h).label,L=()=>a(h).value,N=()=>a(h).id;var y=V(),p=M(y);{var b=c=>{ce(c,{get onUpdate(){return t.onUpdate},get annotationId(){return t.annotation.sample_id},get datasetId(){return e},get label(){return P()},get value(){return L()},get isEditingMode(){return n}})},k=c=>{le(c,{get label(){return P()},get id(){return N()},get value(){return L()}})};T(p,c=>{N()==="label"&&n?c(b):c(k,!1)})}m(w,y)}),A(D),A(g),m(v,g)}})};T(r,l=>{a(i).length>0&&l(u)})}m(s,o),O()}const ge=()=>{const s=xa(Ka());return s.subscribe(()=>{}),{removeTagFromAnnotation:(e,i)=>new Promise((n,o)=>{st(s).mutate({path:{annotation_id:e,tag_id:i}},{onSuccess:()=>n(),onError:r=>o(r)})})}};var fe=B('<div class="flex h-full min-h-0 flex-col space-y-4 overflow-hidden dark:[color-scheme:dark]"><!> <!> <!></div>');function _e(s,t){j(t,!0);const{removeTagFromAnnotation:e}=ge(),i=d(()=>{var o;return((o=t.annotation.tags)==null?void 0:o.map(r=>({tagId:r.tag_id,name:r.name})))??[]}),n=async o=>{await e(t.annotation.sample_id,o)};qt(s,{className:"h-full",children:(o,r)=>{zt(o,{className:"h-full flex flex-col",children:(u,l)=>{var v=fe(),x=I(v);Ia(x,{get tags(){return a(i)},onClick:n});var g=S(x,2);ve(g,{get annotation(){return t.annotation},get onUpdate(){return t.onUpdate}});var D=S(g,2);It(D,()=>t.sampleDetails),A(v),m(u,v)},$$slots:{default:!0}})},$$slots:{default:!0}}),O()}var he=B('<!> <span class="hidden sm:inline">Home</span>',1),pe=B('<!> <span class="max-w-[150px] truncate"> </span>',1),be=B('<!> <span class="hidden sm:inline">Annotations</span>',1),Ae=B('<!> <span class="max-w-[200px] truncate"><!></span>',1),xe=B("<!> <!> <!> <!> <!> <!> <!>",1);function Ie(s,t){j(t,!0);const e=()=>R(o,"$filteredAnnotationCount",i),[i,n]=X(),{filteredAnnotationCount:o}=Y();Ga(s,{class:"mb-2",children:(r,u)=>{Za(r,{children:(l,v)=>{var x=xe(),g=M(x);ot(g,{children:(y,p)=>{{let b=d(()=>K.toDatasetHome(t.rootDataset.dataset_id));ft(y,{get href(){return a(b)},class:"flex items-center gap-2",children:(k,c)=>{var f=he(),E=M(f);Ja(E,{class:"h-4 w-4"}),pt(2),m(k,f)},$$slots:{default:!0}})}},$$slots:{default:!0}});var D=S(g,2);_t(D,{});var w=S(D,2);ot(w,{children:(y,p)=>{{let b=d(()=>K.toDatasetHome(t.rootDataset.dataset_id));ft(y,{get href(){return a(b)},class:"flex items-center gap-2",children:(k,c)=>{var f=pe(),E=M(f);Ya(E,{class:"h-4 w-4"});var C=S(E,2),F=I(C,!0);A(C),G(()=>Z(F,t.rootDataset.name)),m(k,f)},$$slots:{default:!0}})}},$$slots:{default:!0}});var h=S(w,2);_t(h,{});var P=S(h,2);ot(P,{children:(y,p)=>{{let b=d(()=>K.toAnnotations(q.params.dataset_id));ft(y,{get href(){return a(b)},class:"flex items-center gap-2",children:(k,c)=>{var f=be(),E=M(f);$a(E,{class:"h-4 w-4"}),pt(2),m(k,f)},$$slots:{default:!0}})}},$$slots:{default:!0}});var L=S(P,2);_t(L,{});var N=S(L,2);ot(N,{children:(y,p)=>{Xa(y,{class:"flex items-center gap-2",children:(b,k)=>{var c=Ae(),f=M(c);te(f,{class:"h-4 w-4"});var E=S(f,2),C=I(E);{var F=U=>{var Q=bt();G(()=>Z(Q,`Annotation ${t.annotationIndex+1} of ${e()??""}`)),m(U,Q)},$=U=>{var Q=bt("Annotation");m(U,Q)};T(C,U=>{t.annotationIndex!==void 0?U(F):U($,!1)})}A(E),m(b,c)},$$slots:{default:!0}})},$$slots:{default:!0}}),m(l,x)},$$slots:{default:!0}})},$$slots:{default:!0}}),O(),n()}var Se=ua("<image></image><g><!></g>",1),ye=B('<div class="h-full w-full overflow-hidden"><div class="sample relative h-full w-full"><div class="absolute right-4 top-2 z-30"><!></div> <!> <!></div></div>'),De=B('<div class="flex h-full w-full items-center justify-center"><!></div>'),we=B('<div class="flex h-full w-full flex-col space-y-4"><div class="flex w-full items-center justify-between"><!> <!></div> <!> <div class="flex min-h-0 flex-1 gap-4"><div class="flex-1"><!></div> <div class="relative w-[375px]"><!></div></div></div>');function Vt(s,t){j(t,!0);const e=()=>R(U,"$isEditingMode",l),i=()=>R(f,"$rootDataset",l),n=()=>R(yt,"$imageBrightness",l),o=()=>R(Dt,"$imageContrast",l),r=()=>R(g,"$selectedSampleAnnotationCropIds",l),u=()=>R(h,"$isHidden",l),[l,v]=X(),{toggleSampleAnnotationCropSelection:x,selectedSampleAnnotationCropIds:g,clearReversibleActions:D,addReversibleAction:w}=Y(),{isHidden:h,handleKeyEvent:P}=Sa(),{settingsStore:L}=Ma(),N=" ",y=st(L).key_go_back;let p=Ft(!1);const b=()=>{var _;(_=t.annotationDetails.parent_sample_data)!=null&&_.sample.dataset_id?it(K.toAnnotations(t.annotationDetails.parent_sample_data.sample.dataset_id)):it("/")},k=_=>{switch(_.key){case y:b();break;case" ":_.preventDefault(),e()?nt(p,!0):x(a(F));break;case N:_.preventDefault(),x(a(F));break}P(_)},c=_=>{_.key===" "&&nt(p,!1),P(_)},{rootDataset:f}=Ta({datasetId:t.datasetId});La(()=>{D()});const E=_=>{if(a(C)){const H={annotation_id:a(C).sample_id,dataset_id:t.datasetId,bounding_box:_};(async()=>{try{await t.updateAnnotation(H),Ua({annotation:a(C),dataset_id:t.datasetId,addReversibleAction:w,updateAnnotation:t.updateAnnotation})}catch(at){xt.error("Failed to update annotations:"+at.message)}})()}};let C=d(()=>t.annotationDetails.annotation),F=d(()=>a(C).sample_id),$=d(()=>a(C)?Kt(a(C)):void 0);const{isEditingMode:U}=q.data.globalStorage,Q=d(()=>a(p)?"grab":"auto"),Wt=d(()=>e()&&!a(p));let tt=Ft(void 0);la(()=>{!a(tt)&&a($)&&nt(tt,a($),!0)}),Fa(()=>{nt(tt,void 0)});const{imageBrightness:yt,imageContrast:Dt}=Y();var rt=we();At("keydown",ht,k),At("keyup",ht,c);var lt=I(rt),wt=I(lt);{var Gt=_=>{Ie(_,{get rootDataset(){return i().data},get annotationIndex(){return t.annotationIndex}})};T(wt,_=>{i().data&&_(Gt)})}var Zt=S(wt,2);{var Jt=_=>{ja(_,{get brightness(){return Tt(),n()},set brightness(H){Rt(yt,H)},get contrast(){return Tt(),o()},set contrast(H){Rt(Dt,H)}})};T(Zt,_=>{e()&&_(Jt)})}A(lt);var Pt=S(lt,2);Ra(Pt,{class:"bg-border-hard"});var Ct=S(Pt,2),dt=I(Ct),Yt=I(dt);qt(Yt,{className:"h-full",children:(_,H)=>{zt(_,{className:"h-full",children:(J,at)=>{var Mt=V(),$t=M(Mt);{var ta=W=>{var z=ye(),et=I(z),ut=I(et),ea=I(ut);{let Et=d(()=>r().has(a(F)));ya(ea,{onSelect:()=>x(a(F)),get isSelected(){return a(Et)}})}A(ut);var Bt=S(ut,2);se(Bt,{});var na=S(Bt,2);Oa(na,{get width(){return t.parentSample.width},get height(){return t.parentSample.height},get cursor(){return a(Q)},get boundingBox(){return a(tt)},zoomableContent:(oa,ct)=>{let sa=()=>ct==null?void 0:ct().scale;var Nt=Se(),mt=M(Nt),vt=S(mt);let Lt;var ia=I(vt);Ba(ia,()=>a(C).sample_id,gt=>{{let ra=d(()=>({x:0,y:0,width:t.parentSample.width,height:t.parentSample.height}));wa(gt,{get annotation(){return a(C)},showLabel:!0,get scale(){return sa()},get imageWidth(){return t.parentSample.width},get isResizable(){return a(Wt)},onBoundingBoxChanged:E,get constraintBox(){return a(ra)}})}}),A(vt),G(gt=>{St(mt,"href",t.parentSample.url),Ea(mt,`filter: brightness(${n()}) contrast(${o()})`),Lt=Na(vt,0,"",null,Lt,gt)},[()=>({invisible:u()})]),m(oa,Nt)},$$slots:{zoomableContent:!0}}),A(et),A(z),m(W,z)},aa=W=>{var z=De(),et=I(z);Da(et,{size:"large",align:"center"}),A(z),m(W,z)};T($t,W=>{a(C)?W(ta):W(aa,!1)})}m(J,Mt)},$$slots:{default:!0}})},$$slots:{default:!0}}),A(dt);var kt=S(dt,2),Xt=I(kt);_e(Xt,{get annotation(){return a(C)},get onUpdate(){return t.refetch},sampleDetails:H=>{var J=V(),at=M(J);It(at,()=>t.parentSampleDetails),m(H,J)},$$slots:{sampleDetails:!0}}),A(kt),A(Ct),A(rt),m(s,rt),O(),v()}var Pe=B("<!> <!>",1);function Qt(s,t){var e=Pe(),i=M(e);It(i,()=>t.children);var n=S(i,2);Pa(n,{variant:"secondary",get href(){return t.href},children:(o,r)=>{pt();var u=bt("View sample");m(o,u)},$$slots:{default:!0}}),m(s,e)}function Ce(s,t){j(t,!0);const e=d(()=>t.annotationDetails.parent_sample_data);{const i=o=>{{let r=d(()=>K.toSample({sampleId:a(e).sample_id,datasetId:a(e).sample.dataset_id}));Qt(o,{get href(){return a(r)},children:(u,l)=>{Ca(u,{get sample(){return a(e)},showCustomMetadata:!1})}})}};let n=d(()=>({width:a(e).width,height:a(e).height,url:`${ca}/sample/${a(e).sample.sample_id}`}));Vt(s,{get annotationDetails(){return t.annotationDetails},get updateAnnotation(){return t.updateAnnotation},get refetch(){return t.refetch},get annotationIndex(){return t.annotationIndex},get dataset(){return t.dataset},get datasetId(){return t.dataset.dataset_id},get parentSample(){return a(n)},parentSampleDetails:i,$$slots:{parentSampleDetails:!0}})}O()}function ke(s,t){j(t,!0);const e=d(()=>t.annotationDetails.parent_sample_data);{const i=o=>{{let r=d(()=>K.toFramesDetails(a(e).sample.dataset_id,a(e).sample_id));Qt(o,{get href(){return a(r)},children:(u,l)=>{ae(u,{get sample(){return a(e)}})}})}};let n=d(()=>({width:a(e).video.width,height:a(e).video.height,url:`${ma}/${a(e).sample_id}`}));Vt(s,{get annotationDetails(){return t.annotationDetails},get updateAnnotation(){return t.updateAnnotation},get refetch(){return t.refetch},get annotationIndex(){return t.annotationIndex},get dataset(){return t.dataset},get datasetId(){return t.dataset.dataset_id},get parentSample(){return a(n)},parentSampleDetails:i,$$slots:{parentSampleDetails:!0}})}O()}const Me=({datasetId:s,annotationId:t,onUpdate:e})=>{const i=qa({path:{sample_id:t}}),n=za(),{updateAnnotations:o}=Ht({datasetId:s}),r=Va(i),u=()=>{n.invalidateQueries({queryKey:i.queryKey}),n.invalidateQueries({queryKey:Qa().queryKey}),n.invalidateQueries({queryKey:Wa({path:{dataset_id:s}}).queryKey})};return{updateAnnotation:async v=>{try{await o([v]),u(),xt.success("Annotation updated successfully"),e==null||e()}catch(x){xt.error("Failed to update annotation:"+x.message)}},annotation:r,refetch:u}};var Be=B('<div class="flex h-full w-full space-x-4 px-4 pb-4" data-testid="annotation-details"><div class="h-full w-full space-y-6 rounded-[1vw] bg-card p-4"><!></div></div>');function dn(s,t){j(t,!0);const e=()=>R(a(x),"$annotationDetailsResponse",i),[i,n]=X(),o=d(()=>t.data.annotationId),r=d(()=>t.data.dataset),u=d(()=>t.data.annotationIndex),l=q.params.dataset_id,v=d(()=>Me({datasetId:l,annotationId:a(o)})),x=d(()=>a(v).annotation),g=d(()=>a(v).updateAnnotation),D=d(()=>a(v).refetch);var w=Be(),h=I(w),P=I(h);{var L=N=>{var y=V(),p=M(y);{var b=c=>{ke(c,{get annotationDetails(){return e().data},get annotationIndex(){return a(u)},get updateAnnotation(){return a(g)},get refetch(){return a(D)},get dataset(){return a(r)}})},k=c=>{var f=V(),E=M(f);{var C=F=>{Ce(F,{get annotationDetails(){return e().data},get annotationIndex(){return a(u)},get updateAnnotation(){return a(g)},get refetch(){return a(D)},get dataset(){return a(r)}})};T(E,F=>{e().data.parent_sample_type==jt.IMAGE&&F(C)},!0)}m(c,f)};T(p,c=>{e().data.parent_sample_type==jt.VIDEO_FRAME?c(b):c(k,!1)})}m(N,y)};T(P,N=>{e().data&&a(o)&&a(r)&&N(L)})}A(h),A(w),m(s,w),O(),n()}export{dn as component,ln as universal};

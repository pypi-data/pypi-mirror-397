import{x as It,i as me,p as _e,a as pe,c as z,s as A,g as e,b as s,r as M,n as kt,f as de,d as K,e as He,u as Dt,h as l,$ as Ue,t as Se}from"../chunks/DkbXUtyG.js";import{e as Pt}from"../chunks/BpLiSKgx.js";import{u as be}from"../chunks/KNLP4aJU.js";import{f as Et,e as Mt,m as Ct,u as Rt,c as Lt}from"../chunks/VYb2dkNs.js";import{u as Tt}from"../chunks/da7Oy_lO.js";import{y as Bt,D as Ye,b as Nt,E as jt,M as $t,B as zt,F as Ht,H as Ut,J as Ot,K as Xt,N as Vt,d as Yt,O as Kt,u as Qt,_ as qt,P as Zt,Q as Gt,R as Wt,C as Oe,n as Xe,T as Jt,o as ea,U as ta,x as aa}from"../chunks/CGY1p9L4.js";import"../chunks/CWj6FrbW.js";import{e as Ve}from"../chunks/D9SC3jBb.js";import{f as te,a as S,t as na,c as Ie,b as De}from"../chunks/CmLg0ys7.js";import{i as Q,s as q,a as Pe}from"../chunks/B_1cpokE.js";import{e as Ke,i as oa,u as Qe,k as sa,t as ve,s as $,a as ia}from"../chunks/C8mfFM-u.js";import{p as ke,b as ra}from"../chunks/DuUalyFS.js";import"../chunks/CvGjimpO.js";import{a as la}from"../chunks/DtWZc_tl.js";import"../chunks/D_FFv0Oe.js";import"../chunks/69_IOA4Y.js";import{p as qe}from"../chunks/C80h3dJx.js";import{a as da,g as Fe}from"../chunks/xGHZQ1pe.js";import{S as ca}from"../chunks/D4y7iiT3.js";import{r as he}from"../chunks/BRmB-kJ9.js";import{u as ua}from"../chunks/VRI4prUD.js";import{u as ma,a as ga,b as fa,c as va,d as ha}from"../chunks/DDBy-_jD.js";import{u as _a}from"../chunks/DmK2hulV.js";import{a as pa,Z as ba}from"../chunks/BscxbINH.js";import{S as xa}from"../chunks/erjNR5MX.js";import{D as ya}from"../chunks/BK4An2kI.js";import{F as wa}from"../chunks/rwuuBP9f.js";const Aa=({video_frame_dataset_id:m,sampleIndex:a,filter:b})=>{const d=It({isLoading:!1});return(async()=>{d.update(r=>({...r,isLoading:!0,error:void 0}));try{const{data:r}=await Pt({path:{video_frame_dataset_id:m},query:{cursor:a<1?0:a-1,limit:3},body:{filter:b},throwOnError:!0}),{setfilteredSampleCount:x}=be();x(r==null?void 0:r.total_count);let C;const F=a>0?r.data[0]:void 0;r.data.length>2&&(C=a==0?r.data[1]:r.data[2]),d.update(H=>({...H,isLoading:!1,sampleNext:C,samplePrevious:F,error:void 0}))}catch(r){d.update(x=>({...x,isLoading:!1,error:r.message||"Failed to load adjacent frames"}))}})(),d};function Sa({tagIds:m,metadata:a,annotationIds:b,bounds:d}){return{sample_filter:{tag_ids:m.size>0?[...m]:void 0,metadata_filters:a?Mt(a):void 0,annotation_label_ids:[...b]},...d}}const Fa=async({params:m,url:a})=>{const b=m.dataset_id,d=a.searchParams.get("index"),_=d!==null?parseInt(d):null;let r=null;if(_!==null){const{selectedAnnotationFilterIds:x}=be(),{videoFramesBoundsValues:C}=Bt(),{metadataValues:F}=Et(),{tagsSelected:H}=Tt({dataset_id:b,kind:["sample"]}),k=me(H),R=me(F),g=me(x),L=me(C),U=Sa({tagIds:k,metadata:R,annotationIds:g,bounds:L});r=Aa({video_frame_dataset_id:b,sampleIndex:_,filter:U})}return{frameAdjacents:r,frameIndex:_,dataset_id:m.dataset_id,sampleId:m.sample_id}},vn=Object.freeze(Object.defineProperty({__proto__:null,load:Fa},Symbol.toStringTag,{value:"Module"}));function Ia(m,a){_e(a,!0),ya(m,{get rootDataset(){return a.rootDataset},get index(){return a.frameIndex},section:"Frames",subsection:"Frame",get navigateTo(){return he.toFrames}}),pe()}var ka=te('<label class="flex w-full flex-col gap-3 text-muted-foreground"><div class="text-sm">Select or create a label for a new annotation.</div> <!></label>'),Da=te('<div class="items-left mb-2 flex flex-col justify-between space-y-2 bg-muted p-2"><div class="mb-2 w-full"><!></div> <!></div>'),Pa=te('<div class="flex flex-col gap-3 space-y-4"><!> <div class="flex flex-col gap-2"></div> <div class="flex flex-col gap-2"><!></div></div>');function Ea(m,a){_e(a,!0);const b=()=>q(H,"$annotationLabels",_),d=()=>q(F,"$isEditingMode",_),[_,r]=Pe();let x=ke(a,"addAnnotationEnabled",15,!1),C=ke(a,"addAnnotationLabel",15,void 0);const{isEditingMode:F}=qe.data.globalStorage,H=Ye(),k=s(()=>Ot(b().data||[])),R=s(()=>a.sample.sample.annotations?[...a.sample.sample.annotations].sort((g,L)=>g.annotation_label.annotation_label_name.localeCompare(L.annotation_label.annotation_label_name)):[]);Nt(m,{title:"Annotations",children:(g,L)=>{var U=Pa(),D=z(U);{var se=T=>{var I=Da(),Z=z(I),B=z(Z);{let y=s(()=>x()?"default":"outline");zt(B,{title:"Add annotation",get variant(){return e(y)},"data-testid":"create-rectangle",class:"w-full",onclick:()=>{x(!x())},children:(P,N)=>{kt();var W=na("Add annotation");S(P,W)},$$slots:{default:!0}})}M(Z);var c=A(Z,2);{var X=y=>{var P=ka(),N=A(z(P),2);{const W=(ne,E)=>{let xe=()=>E==null?void 0:E().inputValue;Ut(ne,{get label(){return xe()}})};let ie=s(()=>e(k).find(ne=>{var E;return ne.value===((E=C())==null?void 0:E.value)}));Ht(N,{get items(){return e(k)},get selectedItem(){return e(ie)},name:"annotation-label",label:"Choose or create a label",className:"w-full",contentClassName:"w-full",placeholder:"Select or create a label",onSelect:ne=>{C(ne)},notFound:W,$$slots:{notFound:!0}})}M(P),S(y,P)};Q(c,y=>{x()&&y(X)})}M(I),S(T,I)};Q(D,T=>{d()&&T(se)})}var o=A(D,2);Ke(o,21,()=>e(R),oa,(T,I)=>{{let Z=s(()=>a.selectedAnnotationId===e(I).sample_id),B=s(()=>a.annotationsIdsToHide.has(e(I).sample_id));jt(T,{get annotation(){return e(I)},get isSelected(){return e(Z)},onClick:()=>a.onAnnotationClick(e(I).sample_id),onDeleteAnnotation:()=>a.onDeleteAnnotation(e(I).sample_id),get isHidden(){return e(B)},onToggleShowAnnotation:c=>{c.stopPropagation(),a.onToggleShowAnnotation(e(I).sample_id)},get onUpdate(){return a.onUpdate}})}}),M(o);var O=A(o,2),ae=z(O);$t(ae,{get metadata_dict(){return a.sample.sample.metadata_dict}}),M(O),M(U),S(g,U)}}),pe(),r()}const Ma=m=>{const a=Ct({path:{sample_id:m}}),b=Rt(),d=Lt(a);return{refetch:()=>{b.invalidateQueries({queryKey:a.queryKey})},videoFrame:d}};function Ca(m,a){_e(a,!0);const b=()=>q(e(k),"$annotationResp",_),d=()=>q(F,"$showAnnotationTextLabelsStore",_),[_,r]=Pe(),x=ke(a,"isResizable",3,!1),{addReversibleAction:C}=be(),{showAnnotationTextLabelsStore:F}=Qe(),H=s(()=>Kt({datasetId:a.datasetId,annotationId:a.annotationId})),k=s(()=>e(H).annotation),R=s(()=>e(H).updateAnnotation);let g=s(()=>b().data),L=s(()=>e(g)?Xt(e(g)):void 0);const U=O=>{(async()=>{try{await e(R)({annotation_id:a.annotationId,dataset_id:a.datasetId,bounding_box:O}),e(g)&&pa({annotation:e(g),dataset_id:a.datasetId,addReversibleAction:C,updateAnnotation:e(R)})}catch(T){console.error("Failed to update annotation:",T.message)}})()};var D=Ie(),se=de(D);{var o=O=>{var ae=Ie(),T=de(ae);sa(T,()=>e(L),I=>{Vt(I,{get groupId(){return e(g).sample_id},get onSelect(){return a.toggleAnnotationSelection},get box(){return e(L)},get isSelected(){return a.isSelected},children:(Z,B)=>{{let c=s(()=>({x:0,y:0,width:a.sample.video.width,height:a.sample.video.height}));Yt(Z,{get annotation(){return e(g)},get showLabel(){return d()},get imageWidth(){return a.sample.video.width},get constraintBox(){return e(c)},get isResizable(){return x()},onBoundingBoxChanged:U})}},$$slots:{default:!0}})}),S(O,ae)};Q(se,O=>{e(g)&&e(L)&&O(o)})}S(m,D),pe(),r()}var Ra=De('<line x1="0" stroke-width="1" vector-effect="non-scaling-stroke" stroke-dasharray="5,5" opacity="0.6"></line><line y1="0" vector-effect="non-scaling-stroke" stroke-width="1" stroke-dasharray="5,5" opacity="0.6"></line>',1),La=De('<rect class="select-none" fill="transparent" role="button" style="outline: 0;cursor: crosshair;" tabindex="0"></rect>'),Ta=De('<image width="100%" height="100%"></image><g><!><!><!></g><!>',1),Ba=te('<div class="relative h-full w-full overflow-hidden"><!> <!></div>'),Na=te("<!> <!> <!>",1),ja=te('<div class="flex min-h-0 flex-1 gap-4"><!> <!></div>'),$a=te('<div class="flex h-screen items-center justify-center"><!></div>'),za=te('<div class="flex h-full w-full flex-col space-y-4"><div class="flex w-full items-center"><!></div> <!> <!></div>');function hn(m,a){_e(a,!0);const b=()=>q(e(se),"$videoFrame",F),d=()=>q(ne,"$isEditingMode",F),_=()=>q(e(R),"$frameAdjacents",F),r=()=>q(Je,"$labels",F),x=()=>q(Ge,"$rootDataset",F),C=()=>q(at,"$isHidden",F),[F,H]=Pe(),k=s(()=>a.data.frameIndex),R=s(()=>a.data.frameAdjacents),g=s(()=>a.data.datasetId),L=s(()=>a.data.sampleId),U=s(()=>Ma(e(L))),D=s(()=>e(U).refetch),se=s(()=>e(U).videoFrame),o=s(()=>b().data),O=s(()=>_a({datasetId:e(g)})),ae=s(()=>e(O).removeTagFromSample),T=s(()=>{var t,n,f;return((f=(n=(t=e(o))==null?void 0:t.sample)==null?void 0:n.tags)==null?void 0:f.map(u=>({tagId:u.tag_id,name:u.name})))??[]}),I=async t=>{var n;if((n=e(o))!=null&&n.sample_id)try{await e(ae)(e(o).sample_id,t),e(D)()}catch(f){console.error("Error removing tag from frame:",f)}};let Z,B=K(!1),c=K(null),X=K(null),y=K(null),P=K(!1),N=K(void 0),W=K(He([])),ie=K(He(new Set));const{isEditingMode:ne}=qe.data.globalStorage;let E=K(!1);const xe=s(()=>d()&&!e(E));let J=K(void 0);const{createAnnotation:Ee}=ma({datasetId:a.data.dataset.dataset_id}),{settingsStore:Ze}=Qe(),{rootDataset:Ge,refetch:We}=ua({datasetId:a.data.dataset.dataset_id}),Je=Ye(),{createLabel:et}=ga(),tt=s(()=>e(W).filter(t=>!e(ie).has(t.sample_id))),{isHidden:at,handleKeyEvent:Me}=Qt(),{deleteAnnotation:Ce}=fa({datasetId:a.data.dataset.dataset_id}),{addReversibleAction:Re,clearReversibleActions:nt}=be();da(()=>{nt()});const ye=s(()=>e(N)?ta(e(N).label,1).color:"blue"),Le=s(()=>e(P)&&!e(E)&&e(N)!==void 0),ot=t=>{if(!e(X)||e(B)||!e(o))return;const n=e(X).getBoundingClientRect(),f=t.clientX,u=t.clientY,i=(f-n.left)/n.width*e(o).video.width,w=(u-n.top)/n.height*e(o).video.height;l(y,{x:i,y:w},!0),t.stopPropagation(),t.preventDefault()},st=qt.throttle(ot,50),Te=10;function it(){var n;if(e(k)==null||!e(o)||!e(R))return null;const t=(n=_())==null?void 0:n.sampleNext;if(!t)return null;Fe(he.toFramesDetails(e(o).sample.dataset_id,t.sample_id,e(k)+1))}function rt(){var n;if(e(k)==null||!e(o)||!e(R))return null;const t=(n=_())==null?void 0:n.samplePrevious;if(!t)return null;Fe(he.toFramesDetails(e(o).sample.dataset_id,t.sample_id,e(k)-1))}const lt=()=>{l(B,!1),l(c,null),l(y,null)};Dt(()=>{dt(),e(se).subscribe(t=>{if(t.isSuccess&&t.data){let n=Zt(t.data.sample.annotations);l(W,n,!0)}else l(W,[],!0)})});const dt=()=>{if(!e(X))return;const t=Gt(e(X));let n=null;const f=Wt().on("start",u=>{if(!e(P)||!e(o))return;l(B,!0);const i=e(X).getBoundingClientRect(),w=u.sourceEvent.clientX,v=u.sourceEvent.clientY,j=(w-i.left)/i.width*e(o).video.width,p=(v-i.top)/i.height*e(o).video.height;n={x:j,y:p},l(c,{x:j,y:p,width:0,height:0},!0),l(y,{x:j,y:p},!0)}).on("drag",u=>{if(!e(c)||!e(B)||!n||!e(o))return;const i=e(X).getBoundingClientRect(),w=u.sourceEvent.clientX,v=u.sourceEvent.clientY;let j=(w-i.left)/i.width*e(o).video.width,p=(v-i.top)/i.height*e(o).video.height;const oe=e(o).video.width,re=e(o).video.height;j=Math.max(0,Math.min(j,oe)),p=Math.max(0,Math.min(p,re));const ce=Math.min(n.x,j),V=Math.min(n.y,p),ue=Math.abs(j-n.x),le=Math.abs(p-n.y);l(c,{x:ce,y:V,width:ue,height:le},!0),l(y,{x:j,y:p},!0)}).on("end",()=>{!e(c)||!e(B)||(e(c).width>Te&&e(c).height>Te&&e(N)&&mt({x:e(c).x,y:e(c).y,width:e(c).width,height:e(c).height,labelName:e(N).label}),lt(),n=null)});return t.call(f),t.on("mousemove",st),()=>{f.on("start",null).on("drag",null).on("end",null)}},Be=t=>{e(E)||(e(J)===t?l(J,void 0):l(J,t,!0))},ct=t=>{const n=new Set(e(ie));n.has(t)?n.delete(t):n.add(t),l(ie,n,!0)},ut=async t=>{var u;if(!e(o)||!r().data)return;const n=(u=e(o).sample.annotations)==null?void 0:u.find(i=>i.sample_id===t);if(!n)return;(async()=>{try{ha({annotation:n,labels:r().data,addReversibleAction:Re,createAnnotation:Ee,refetch:e(D)}),await Ce(t),ve.success("Annotation deleted successfully"),e(D)(),e(J)===t&&l(J,void 0)}catch(i){ve.error("Failed to delete annotation. Please try again."),console.error("Error deleting annotation:",i)}})()},mt=async({x:t,y:n,width:f,height:u,labelName:i})=>{if(!r().data)return;let w=r().data.find(v=>v.annotation_label_name===i);w||(w=await et({annotation_label_name:i}));try{const v=await Ee({parent_sample_id:e(L),annotation_type:"object_detection",x:Math.round(t),y:Math.round(n),width:Math.round(f),height:Math.round(u),annotation_label_id:w.annotation_label_id});return e(W).length==0&&We(),va({annotation:v,addReversibleAction:Re,deleteAnnotation:Ce,refetch:e(D)}),e(D)(),l(J,v.sample_id,!0),ve.success("Annotation created successfully"),v}catch(v){ve.error("Failed to create annotation. Please try again."),console.error("Error creating annotation:",v);return}},gt=()=>{Fe(he.toFrames(e(g)))},ft=t=>{switch(t.key){case me(Ze).key_go_back:d()?e(P)&&l(P,!1):gt();break;case" ":t.preventDefault(),t.stopPropagation(),console.log("space pressed in sample details"),l(E,d(),!0);break}Me(t)},vt=t=>{t.key===" "&&l(E,!1),Me(t)};var we=za();Ve("keydown",Ue,ft),Ve("keyup",Ue,vt);var Ae=z(we),ht=z(Ae);{var _t=t=>{Ia(t,{get rootDataset(){return x().data},get frameIndex(){return e(k)}})};Q(ht,t=>{x().data&&t(_t)})}M(Ae);var Ne=A(Ae,2);ca(Ne,{class:"mb-4 bg-border-hard"});var pt=A(Ne,2);{var bt=t=>{var n=ja(),f=z(n);Oe(f,{className:"flex flex-col w-[60vw]",children:(i,w)=>{Xe(i,{className:"flex flex-col gap-4 overflow-hidden h-full",children:(v,j)=>{var p=Ba(),oe=z(p);{var re=V=>{{let ue=s(()=>{var ee;return!!((ee=_())!=null&&ee.samplePrevious)}),le=s(()=>{var ee;return!!((ee=_())!=null&&ee.sampleNext)});xa(V,{get hasPrevious(){return e(ue)},get hasNext(){return e(le)},onPrevious:rt,onNext:it})}};Q(oe,V=>{e(R)&&V(re)})}var ce=A(oe,2);ba(ce,{boundingBox:Z,get width(){return e(o).video.width},get height(){return e(o).video.height},zoomableContent:ue=>{var le=Ta(),ee=de(le),ge=A(ee);let je;var $e=z(ge);Ke($e,17,()=>e(tt),h=>h.sample_id,(h,Y)=>{{let G=s(()=>e(J)===e(Y).sample_id);Ca(h,{get annotationId(){return e(Y).sample_id},get sample(){return e(o)},get datasetId(){return e(g)},get isResizable(){return e(xe)},get isSelected(){return e(G)},toggleAnnotationSelection:Be})}});var ze=A($e);{var yt=h=>{Jt(h,{get bbox(){return e(c)},get colorStroke(){return e(ye)},colorFill:"rgba(0, 123, 255, 0.1)",style:"outline: 0;",opacity:.8,scale:1})};Q(ze,h=>{e(c)&&e(B)&&e(N)&&h(yt)})}var wt=A(ze);{var At=h=>{var Y=Ra(),G=de(Y),fe=A(G);Se(()=>{$(G,"y1",e(y).y),$(G,"x2",e(o).video.width),$(G,"y2",e(y).y),$(G,"stroke",e(ye)),$(fe,"x1",e(y).x),$(fe,"x2",e(y).x),$(fe,"y2",e(o).video.height),$(fe,"stroke",e(ye))}),S(h,Y)};Q(wt,h=>{e(y)&&e(Le)&&h(At)})}M(ge);var St=A(ge);{var Ft=h=>{var Y=La();ra(Y,G=>l(X,G),()=>e(X)),Se(()=>{$(Y,"width",e(o).video.width),$(Y,"height",e(o).video.height)}),S(h,Y)};Q(St,h=>{e(Le)&&h(Ft)})}Se(h=>{$(ee,"href",`${la}/${e(o).sample_id}`),je=ia(ge,0,"",null,je,h)},[()=>({invisible:C()})]),S(ue,le)},$$slots:{zoomableContent:!0}}),M(p),S(v,p)},$$slots:{default:!0}})},$$slots:{default:!0}});var u=A(f,2);Oe(u,{className:"flex flex-col flex-1 overflow-hidden",children:(i,w)=>{Xe(i,{className:"h-full overflow-y-auto",children:(v,j)=>{var p=Na(),oe=de(p);ea(oe,{get tags(){return e(T)},onClick:I});var re=A(oe,2);wa(re,{get sample(){return e(o)}});var ce=A(re,2);Ea(ce,{get annotationsIdsToHide(){return e(ie)},get selectedAnnotationId(){return e(J)},onAnnotationClick:Be,onToggleShowAnnotation:ct,onDeleteAnnotation:ut,get onUpdate(){return e(D)},get sample(){return e(o)},get addAnnotationEnabled(){return e(P)},set addAnnotationEnabled(V){l(P,V,!0)},get addAnnotationLabel(){return e(N)},set addAnnotationLabel(V){l(N,V,!0)}}),S(v,p)},$$slots:{default:!0}})},$$slots:{default:!0}}),M(n),S(t,n)},xt=t=>{var n=Ie(),f=de(n);{var u=i=>{var w=$a(),v=z(w);aa(v,{}),M(w),S(i,w)};Q(f,i=>{b().isLoading&&i(u)},!0)}S(t,n)};Q(pt,t=>{e(o)?t(bt):t(xt,!1)})}M(we),S(m,we),pe(),H()}export{hn as component,vn as universal};

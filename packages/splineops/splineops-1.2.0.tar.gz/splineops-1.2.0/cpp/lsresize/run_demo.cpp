// splineops/cpp/lsresize/src/run_demo.cpp
#include <iostream>
#include <vector>
#include <cstdint>
#include <cmath>
#include <string>
#include <algorithm>
#include <chrono>
#include <iomanip>

#include "resize1d.h"
#include "resizend.h"

using namespace lsresize;

static int64_t prod(const std::vector<int64_t>& s){ int64_t p=1; for(auto x:s)p*=x; return p; }

static std::vector<double> resize_nd(const std::vector<double>& data,
                                     const std::vector<int64_t>& in_shape,
                                     const std::vector<double>& zoom,
                                     const std::string& algo,
                                     int degree,
                                     bool inversable=false)
{
  const int D = (int)in_shape.size();
  std::vector<int64_t> out_shape = in_shape;
  for (int i=0;i<D;++i) out_shape[i] = (int64_t)std::llround((double)in_shape[i]*zoom[i]);

  std::vector<double> tmp_in = data;
  std::vector<int64_t> cur_shape = in_shape;

  for (int ax=0; ax<D; ++ax) {
    std::vector<int64_t> next_shape = cur_shape; next_shape[ax] = out_shape[ax];
    std::vector<double> tmp_out((size_t)prod(next_shape), 0.0);

    int interp_degree = degree, synthe_degree = degree, analy_degree = degree;
    if (algo == "interpolation") analy_degree = -1;
    else if (algo == "oblique") analy_degree = (degree==1 ? 0 : 1);

    LSParams p{interp_degree, analy_degree, synthe_degree, zoom[ax], 0.0, inversable};

    // Match Python/native binding policy:
    const double eps = 1e-12;
    if (std::abs(p.zoom - 1.0) <= eps) {
      // identity safety: never project at unity zoom
      p.analy_degree = -1;
    } else if (p.zoom > 1.0 + eps && p.analy_degree >= 0) {
      // magnification -> Standard interpolation
      p.analy_degree = -1;
    }

    resize_along_axis(tmp_in.data(), tmp_out.data(), cur_shape, next_shape, ax, p);
    tmp_in.swap(tmp_out);
    cur_shape.swap(next_shape);
  }
  return tmp_in;
}

static double mse(const std::vector<double>& a, const std::vector<double>& b) {
  if (a.size() != b.size()) return INFINITY;
  double acc=0; for (size_t i=0;i<a.size();++i){ double d=a[i]-b[i]; acc+=d*d; } return acc/a.size();
}

template<int H, int W>
static std::vector<double> flat(const double (&M)[H][W]) {
  std::vector<double> v; v.reserve(H*W);
  for (int i=0;i<H;++i) for (int j=0;j<W;++j) v.push_back(M[i][j]);
  return v;
}

// ----------------------- Reference matrices (from Python) -----------------------

static const double DOWNSCALED_0_5_JAVA_SQUARE_LS_3_3_3[5][5] = {
  { 0.0018689470814154346, -0.008251404860385576, -0.04985014714990277, -0.03066989849060565, 0.0013938326549015785},
  {-0.008251404860385763,  0.036429967893169046,  0.22008849291341548,  0.1354076592052344, -0.006153773778607437},
  {-0.04985014714990389,   0.2200884929134171,    1.3296455504694955,   0.8180536346012451, -0.03717749081293505},
  {-0.030669898490606213,  0.13540765920523523,   0.8180536346012426,   0.5033008600284541, -0.022873149520289068},
  { 0.0013938326549015941, -0.006153773778607329, -0.037177490812933506,-0.022873149520288183,0.0010394994535632193}
};
static const double REVERTED_0_5_JAVA_SQUARE_LS_3_3_3[10][10] = {
  { 0.0018781323400760897,  0.0010571984329069463, -0.008262973560162083, -0.031004085484624598, -0.04994430169807815, -0.048221066443239174, -0.03064737786618124, -0.00944189116442014,  0.0017383923557298085, -0.009896553700642022},
  { 0.0010571984329074248,  5.950957249894561E-4, -0.004651217868177059, -0.01745216238958293,  -0.028113587291633116, -0.02714358024147593,  -0.017251372100620554, -0.005314829168172281, 9.785389639727809E-4,  -0.005570758162376665},
  {-0.008262973560158452,  -0.004651217868181094,  0.03635352557381595,   0.13640462556876864,   0.21973342112605143,   0.2121519280410835,    0.13483526564821757,   0.04154025538284788,  -0.007648177801984145,  0.04354057476150174},
  {-0.031004085484616906,  -0.017452162389586988,  0.13640462556877103,   0.5118134096450134,    0.8244772566221064,     0.7960302020605083,     0.5059249036758746,     0.15586612005549,     -0.028697266988463928,  0.1633716593823823},
  {-0.04994430169808113,   -0.02811358729163959,   0.21973342112606764,   0.8244772566220873,    1.3281456364312492,     1.2823204410339848,     0.8149914964688332,     0.2510838298527845,    -0.04622826114622253,   0.2631744596742541},
  {-0.04822106644322524,   -0.027143580241484618,  0.21215192804110306,   0.7960302020604646,    1.2823204410340732,     1.238076358788619,       0.7868717304218792,     0.24242064921323506,   -0.044633240960376956,  0.25409411433617746},
  {-0.030647377866186362,  -0.017251372100625433,  0.1348352656482193,    0.5059249036758733,    0.8149914964688023,      0.7868717304218127,      0.5001041460341442,      0.15407285211640753,   -0.02836709973464651,   0.16149203885400695},
  {-0.00944189116442196,   -0.005314829168163082,  0.04154025538285008,   0.15586612005550343,   0.2510838298528118,      0.24242064921333514,     0.15407285211635763,     0.04746700051885365,   -0.008739379581333187,  0.049752714944766116},
  { 0.001738392355726042,   9.785389639690011E-4, -0.007648177801995245, -0.02869726698848693,  -0.04622826114624887,    -0.0446332409604733,     -0.028367099734603184,   -0.008739379581321288,  0.001609049542452153,  -0.00916021354522421},
  {-0.009896553700638518,  -0.005570758162372193,  0.0435405747615197,    0.1633716593823974,    0.26317445967427133,     0.2540941143362428,      0.16149203885396476,     0.049752714944765124,  -0.00916021354522903,   0.05214849510856498}
};

static const double DOWNSCALED_0_5_JAVA_SQUARE_LS_1_1_1[5][5] = {
  {0.006151480199923101, -0.012302960399846182, -0.09419454056132263, -0.061899269511726245, 0.00845828527489427},
  {-0.012302960399846198, 0.024605920799692396, 0.1883890811226452, 0.12379853902345257, -0.016916570549788554},
  {-0.0941945405613226, 0.18838908112264505, 1.4423539023452514, 0.947832564398308, -0.1295174932718186},
  {-0.061899269511726224, 0.12379853902345248, 0.9478325643983084, 0.622861399461745, -0.08511149557862364},
  {0.008458285274894286, -0.016916570549788523, -0.1295174932718186, -0.08511149557862356, 0.011630142252979614}
};
static const double REVERTED_0_5_JAVA_SQUARE_LS_1_1_1[10][10] = {
  {0.0061514801955339276, -0.0030757400992221192, -0.012302960391831071, -0.05324875047573376, -0.09419454047476042, -0.07804690520636601, -0.061899268751859485, -0.026720494862330697, 0.008458295547883918, -0.026720530459464452},
  {-0.0030757400992220715, 0.0015378700503386135, 0.006151480198825903, 0.026624375250462698, 0.047097270259662136, 0.039023452621644875, 0.030949634390572044, 0.013360247437485854, -0.004229147775942612, 0.013360265236052804},
  {-0.012302960391831144, 0.0061514801988258394, 0.024605920785188546, 0.1064975009580736, 0.18838908096120768, 0.1560938104224148, 0.12379853751140003, 0.053440989727977124, -0.016916591096816872, 0.05344106092224331},
  {-0.0532487504757338, 0.026624375250463118, 0.10649750095807335, 0.4609344965924599, 0.8153714914921407, 0.6755935236131048, 0.5358155454667874, 0.23129928379601553, -0.07321712088194109, 0.23129959193370198},
  {-0.0941945404747611, 0.0470972702596626, 0.18838908096120655, 0.8153714914921434, 1.4423539007234187, 1.195093235726933, 0.9478325525681137, 0.4091575774953761, -0.12951765055036116, 0.40915812257648065},
  {-0.07804690520636626, 0.03902345262164537, 0.15609381042241488, 0.6755935236131031, 1.195093235726931, 0.9902201126671685, 0.7853469745586089, 0.33901627954546415, -0.10731462507387966, 0.33901673118409614},
  {-0.06189926875186017, 0.030949634390572398, 0.12379853751140012, 0.5358155454667877, 0.9478325525681169, 0.7853469745586079, 0.6228613846138586, 0.26887497644338093, -0.08511159796649252, 0.2688753346395321},
  {-0.026720494862330812, 0.013360247437486171, 0.053440989727977194, 0.23129928379601525, 0.4091575774953742, 0.3390162795454647, 0.26887497644338176, 0.11606716155994631, -0.03674072508522311, 0.11606731618501084},
  {0.008458295547883894, -0.004229147775942776, -0.016916591096817438, -0.07321712088194123, -0.12951765055035866, -0.10731462507387982, -0.0851115979664932, -0.036740725085223705, 0.0116301705120165, -0.036740774031340545},
  {-0.02672053045946421, 0.013360265236052908, 0.05344106092224384, 0.23129959193370056, 0.40915812257647916, 0.33901673118409564, 0.2688753346395318, 0.11606731618501057, -0.03674077403134107, 0.1160674708102806}
};

static const double DOWNSCALED_0_5_JAVA_SQUARE_OBLIQUE_0_1_1[5][5] = {
  {0.00237473057492863, -0.007124191724785899, -0.057091995031688554, -0.04017349730698399, 0.005745734457166682},
  {-0.007124191724785898, 0.02137257517435772, 0.17127598509506584, 0.1205204919209521, -0.017237203371500063},
  {-0.0570919950316885, 0.17127598509506567, 1.372575032768215, 0.9658296115233252, -0.1381358569874059},
  {-0.040173497306983975, 0.12052049192095204, 0.9658296115233252, 0.6796181019073095, -0.09720102574102238},
  {0.005745734457166682, -0.017237203371500063, -0.13813585698740585, -0.09720102574102243, 0.013901983155821643}
};
static const double REVERTED_0_5_JAVA_SQUARE_OBLIQUE_0_1_1[10][10] = {
  {0.002374730662670633, -0.002374730626326804, -0.007124191855106919, -0.03210809397163005, -0.0570919960863553, -0.04863274706789715, -0.040173498048520155, -0.017213881746601774, 0.005745734584774475, -0.017213881868000734},
  {-0.002374730626326799, 0.0023747305899829625, 0.007124191746075418, 0.03210809348023489, 0.05709199521259638, 0.04863274632360189, 0.04017349743368869, 0.017213881483153576, -0.005745734496839451, 0.01721388160455255},
  {-0.007124191855106922, 0.00712419174607541, 0.021372575166605758, 0.09632428011791752, 0.1712759850638347, 0.14589823848189484, 0.12052049189719695, 0.05164164427640752, -0.017237203432755782, 0.05164164464060419},
  {-0.03210809397162994, 0.03210809348023471, 0.09632428011791747, 0.43412489453925407, 0.7719255089362791, 0.6575502803330462, 0.5431750517173841, 0.23274426082275865, -0.07768653047015936, 0.2327442624641612},
  {-0.057091996086354804, 0.05709199521259587, 0.17127598506383457, 0.7719255089362784, 1.3725750327654929, 1.1692023221473729, 0.9658296115071527, 0.41384687735607584, -0.13813585750321233, 0.41384688027468397},
  {-0.048632747067897115, 0.04863274632360191, 0.14589823848189484, 0.6575502803330461, 1.1692023221473737, 0.9959630894352507, 0.8227238567043007, 0.35252770775179426, -0.11766844180398894, 0.352527710237956},
  {-0.04017349804852011, 0.04017349743368862, 0.12052049189719698, 0.5431750517173842, 0.9658296115071524, 0.822723856704301, 0.6796181018858971, 0.2912085381408489, -0.09720102610254121, 0.29120854019456416},
  {-0.017213881746601756, 0.017213881483153542, 0.051641644276407474, 0.23274426082275865, 0.41384687735607567, 0.3525277077517944, 0.29120853814084885, 0.12477950844865505, -0.04164952145707245, 0.12477950932864841},
  {0.005745734584774481, -0.0057457344968394565, -0.01723720343275575, -0.07768653047015933, -0.13813585750321208, -0.1176684418039889, -0.09720102610254133, -0.041649521457072416, 0.013901983259670646, -0.041649521750800986},
  {-0.017213881868000706, 0.017213881604552506, 0.05164164464060429, 0.232744262464161, 0.4138468802746841, 0.35252771023795654, 0.2912085401945637, 0.12477950932864847, -0.04164952175080101, 0.12477951020864177}
};

static const double DOWNSCALED_0_5_JAVA_SQUARE_OBLIQUE_1_3_3[5][5] = {
  {1.9242517527402107E-4,-0.0024771894877257863,-0.015585724846922215,-0.010499710858914244,7.223942884156233E-4},
  {-0.0024771894877257984,0.03189015028496488,0.20064315230272206,0.1351682456665242,-0.00929975786540415},
  {-0.01558572484692251,0.20064315230272262,1.262385852880526,0.8504376009336858,-0.058511255578699815},
  {-0.010499710858914206,0.13516824566652422,0.8504376009336854,0.572918423817517,-0.039417561364795024},
  {7.223942884156168E-4,-0.00929975786540405,-0.05851125557869874,-0.03941756136479481,0.002711981460806121}
};
static const double REVERTED_0_5_JAVA_SQUARE_OBLIQUE_1_3_3[10][10] = {
  {1.924258896093449E-4,1.1838126995673103E-4,-0.00247719308782535,-0.009418489140666645,-0.01558574856632144,-0.015663834512104766,-0.010499702278610332,-0.00314140526926539,7.22547025360742E-4,-0.0031416916944942527},
  {1.1838126995678406E-4,7.282868799529316E-5,-0.0015239802931936073,-0.005794296743591918,-0.009588422390841803,-0.009636461214756867,-0.006459463913266857,-0.001932606604960775,4.445141692696517E-4,-0.0019327828150457176},
  {-0.00247719308782537,-0.0015239802931934926,0.03189012459200791,0.12124884153782754,0.20064300440787308,0.20164824318080174,0.13516782986739806,0.04044085457981142,-0.009301703115346047,0.04044454187260983},
  {-0.009418489140667112,-0.0057942967435913395,0.12124884153782738,0.46099793470075234,0.7628609846579554,0.7666829840463508,0.5139190578362157,0.15375941083123695,-0.035365830064744565,0.1537734302176773},
  {-0.015585748566321691,-0.009588422390841927,0.20064300440787403,0.7628609846579568,1.2623850089286681,1.2687096668009112,0.8504350431632981,0.25444160747333044,-0.05852349851404435,0.254464806802739},
  {-0.01566383451210468,-0.00963646121475712,0.20164824318080246,0.7666829840463514,1.2687096668009108,1.2750660117550807,0.8546957961447809,0.25571638189187196,-0.05881670629373936,0.2557396974519237},
  {-0.010499702278609963,-0.006459463913267309,0.13516782986739873,0.513919057836214,0.850435043163298,0.8546957961447799,0.5729153606267401,0.1714105109801318,-0.039425716903194935,0.17142613974834994},
  {-0.0031414052692650936,-0.001932606604961154,0.04044085457981171,0.1537594108312383,0.2544416074733325,0.25571638189187396,0.17141051098013166,0.051284300079383435,-0.011795777779010402,0.051288976049570764},
  {7.225470253607561E-4,4.445141692696569E-4,-0.009301703115345868,-0.03536583006474561,-0.05852349851404309,-0.05881670629374104,-0.0394257169031955,-0.011795777779010527,0.002713118307092479,-0.011796853287600113},
  {-0.0031416916944939227,-0.0019327828150460184,0.04044454187261078,0.15377343021767814,0.2544648068027411,0.25573969745192426,0.17142613974834986,0.05128897604957082,-0.011796853287599753,0.0512936524461013}
};

static const double UPSCALED_2_0_JAVA_SINUSOID_LS_3_3_3[10][10] = {
  {0.5001015318158614,0.6926982768677825,0.9755970609218887,0.9990887172816743,0.7942536867569232,0.48415220602153575,0.2075109962547133,0.05784041492164786,0.029614379902187273,0.051029936755073474},
  {0.2748221162155283,0.632625969182312,1.156740509776654,1.218536938253553,0.9752351681447231,0.7039082115012342,0.38791469643188825,-7.617221792181467E-4,-0.19845878465237388,-0.003797876659059899},
  {-0.15447186382930933,0.4445477453882408,1.3208568245670205,1.438581322331116,1.1391149974235053,0.9244019861852949,0.5509509186950238,-0.18669337749821538,-0.6318318641917327,-0.18421871373804682},
  {-0.45088514909310534,0.18643923209340185,1.1186763805282849,1.2452821884542176,0.9368969997762097,0.7311742150078879,0.3485989572813214,-0.4444610182996858,-0.928892905656842,-0.4411112432286517},
  {-0.4043332706894877,0.1945243710262496,1.0705969646813318,1.1882839088345971,0.8888552963332644,0.6741042709446032,0.30069178406119246,-0.43671819321005456,-0.881690532211872,-0.43424722975898095},
  {0.03362209616296785,0.6712542623062079,1.6039408014206984,1.7306179720351684,1.4221611189145236,1.216510571999039,0.8338619999992725,0.040356750905478654,-0.44439086497337077,0.04371355763044552},
  {0.4051781216062879,1.0034579827377574,1.8786869694781967,1.9962399498491075,1.6969458675727607,1.4820592355406494,1.108784375981438,0.372210276904278,-0.07216936888918142,0.3746680403644698},
  {0.3133625735430068,0.6726365974225411,1.1988977065848263,1.261035007567336,1.0173909236004521,0.7464090197460873,0.4300653102034544,0.03926198901082309,-0.1599431887824548,0.03625942207321789},
  {0.15700059767372204,0.3468035940420653,0.6256232789748344,0.64846717929539,0.44428264368366494,0.13352546295227158,-0.1424502765053143,-0.2880791296972365,-0.31343931073572157,-0.2949534338840083},
  {0.31013294239240996,0.6731812899602811,1.2049532173628057,1.267965629656222,1.0234427340694454,0.7533466734890251,0.4361039206816073,0.03984026909106219,-0.16323664595137108,0.03692393040050076}
};
static const double REVERTED_2_0_JAVA_SINUSOID_LS_3_3_3[5][5] = {
  {0.5166311857592519,1.0128734849854766,0.8445655264102155,0.23434710768495345,0.0640558580964043},
  {-0.13676024128150815,1.2309090556695121,1.1493971018212703,0.39508489271686237,-0.46201742158574405},
  {-0.34613123662714673,1.1083340650326852,1.0354671801073558,0.2668029193337853,-0.6587072554729654},
  {0.3959316811426067,1.7063031935718946,1.619084256996972,0.8742464559608476,0.062303119730540174},
  {0.22525092633342433,0.8488113740282278,0.6931845769485014,0.06191361451245153,-0.20872283129261193}
};

static const double UPSCALED_2_0_JAVA_SINUSOID_LS_1_1_1[10][10] = {
  {0.4999999990472729,0.7377641285113451,0.9755282570917958,0.8847104412534983,0.7938926252432822,0.49999999971194525,0.2061073726573895,0.11528956128397547,0.024471728757442485,0.11528960686185044},
  {0.17274575121729493,0.6605098807548098,1.1482740097747768,1.0574561939445397,0.9666383772843176,0.6727457534078158,0.37885311842908964,0.03803533504990127,-0.3027826029304066,0.038035668168619495},
  {-0.15450849721217924,0.583255631867273,1.3210197607952507,1.230201945117347,1.1393841279513894,0.8454915061965963,0.5515988637605717,-0.03921889132632109,-0.630036934462335,-0.03921827066675994},
  {-0.27950849722839693,0.4582556318671145,1.1960197610097254,1.1052019453124065,1.0143841281412938,0.720491506359257,0.4265988638970119,-0.16421889134938916,-0.7550369346448393,-0.16421827068981465},
  {-0.40450849645400266,0.3332556319350583,1.0710197605697918,0.9802019448634179,0.8893841276975069,0.5954915059217459,0.3015988634668015,-0.2892188912333585,-0.8800369339824958,-0.28921827057377175},
  {-2.1300176916920793E-9,0.7377641287925372,1.4755282593181684,1.3847104436475963,1.2938926264713475,1.000000004696302,0.7061073622387581,0.11528960551304096,-0.47552843926189287,0.11529022617259348},
  {0.40450850386202925,1.1422726277344462,1.8800367505673437,1.7892189349333116,1.6984011177474734,1.4045084959755474,1.110615853517814,0.5197981043489667,-0.07101993286933209,0.5197987250084726},
  {0.27950846969939036,0.7672726215234696,1.255036772660403,1.1642189568638066,1.0734011402250463,0.7795085164270182,0.4856158815258888,0.14479807595505623,-0.196019884216972,0.14479840907379277},
  {0.15450859809898473,0.39227264442639126,0.6300366904190214,0.5392188744599082,0.4484010583682862,0.15450843254432467,-0.1393841948000211,-0.23020192332460374,-0.3210196730020577,-0.23020187774679332},
  {0.27950811942589915,0.767272558790768,1.2550369974684923,1.1642191816719036,1.0734013650331509,0.779508741235152,0.4856161063340407,0.1447980132224368,-0.1960202344905171,0.1447983463415033}
};
static const double REVERTED_2_0_JAVA_SINUSOID_LS_1_1_1[5][5] = {
  {0.5007079557988916,0.9769718213177843,0.7980313316344365,0.20036389114742528,0.053927882912957525},
  {-0.1534000505792018,1.313083915656007,1.1487772310625053,0.4974525047626714,-0.4440862027990193},
  {-0.3996995570945281,1.0814182139986668,0.9173277927611085,0.26521010117264193,-0.6880789009873955},
  {0.39574896098439755,1.8232094471880191,1.6583260604310897,1.009115908574282,0.09891132008339422},
  {0.19468838329771726,0.8270461701272535,0.6504124887803894,0.044286750605873074,-0.22748573393296448}
};

static const double UPSCALED_2_0_JAVA_SINUSOID_OBLIQUE_0_1_1[10][10] = {
  {0.49999999968142395,0.7377641288666829,0.975528257242422,0.8847104413334552,0.7938926254004706,0.4999999994866077,0.2061073735656922,0.11528955806070623,0.024471742339949545,0.11528955894988037},
  {0.1727457506342713,0.6605098806574163,1.1482740096847985,1.0574561936969504,0.9666383776795041,0.6727457514958234,0.37885312530154214,0.038035309269712866,-0.30278250709292126,0.03803531063295907},
  {-0.1545084980406295,0.583255632024996,1.321019760908614,1.2302019449398,1.1393841289358047,0.8454915027991597,0.5515988766483666,-0.039218939273327584,-0.6300367556408603,-0.039218937436009293},
  {-0.2795084979518507,0.45825563201874475,1.1960197609420997,1.1052019449674388,1.014384128961564,0.7204915028168583,0.42659887665812096,-0.16421893927959566,-0.7550367556631473,-0.16421893744227686},
  {-0.40450849785175697,0.33325563200029445,1.0710197609398715,0.9802019449622462,0.8893841289573748,0.595491502813935,0.30159887665658114,-0.2892189392783074,-0.8800367556590275,-0.2892189374409882},
  {-9.840652392415014E-10,0.7377641292413151,1.4755282581181088,1.3847104421513694,1.293892626144545,1.0000000000011935,0.7061073738435502,0.11528955790770415,-0.4755282584739851,0.11528955974502195},
  {0.4045084958960764,1.1422726264907104,1.8800367553006456,1.7892189393448772,1.6984011233361853,1.4045084971931963,1.1106158710355374,0.5197980551026721,-0.07101976127604734,0.5197980569399888},
  {0.279508496326655,0.7672726263630026,1.2550367552884838,1.1642189393157667,1.073401123310063,0.779508497166073,0.48561587101138315,0.14479805504479792,-0.19601976125259524,0.14479805640804388},
  {0.15450849716922727,0.39227262653223915,0.6300367554582158,0.5392189394685543,0.4484011234658408,0.15450849732085783,-0.1393841288308554,-0.23020194471611488,-0.32101976081713585,-0.23020194382693968},
  {0.2795084946287366,0.7672726251391543,1.2550367545387053,1.164218938565989,1.0734011225602862,0.7795084964162965,0.4856158702616079,0.14479805382095182,-0.1960197629505121,0.14479805518419783}
};
static const double REVERTED_2_0_JAVA_SINUSOID_OBLIQUE_0_1_1[5][5] = {
  {0.500109811959033,0.9757066439213337,0.7949964179093935,0.20184381109927668,0.051233247278887215},
  {-0.15439945508488,1.3191691652185247,1.143526897220236,0.5209801327202968,-0.45731882470455715},
  {-0.40312733110050236,1.0755092470290355,0.8998927154844044,0.2771966799475273,-0.7053054925092404},
  {0.39851134471940414,1.8477537659976213,1.6719879632350823,1.0501577001575013,0.09203417560881968},
  {0.19125547514571636,0.8128095027822513,0.6328404849949566,0.0353888698293681,-0.23627429111086287}
};

static const double UPSCALED_2_0_JAVA_SINUSOID_OBLIQUE_1_3_3[10][10] = {
  {0.5000000233154933,0.6927865924516642,0.9755281586920201,0.9993887103379059,0.7938922588066969,0.48500819804194584,0.2061055527052281,0.0605856550071718,0.0244621600695617,0.06060386967877854},
  {0.2748305322337796,0.6326563225803186,1.1566088031060962,1.2185556142762666,0.9749725099711987,0.704176020202439,0.3871836695326497,4.614259705818455E-4,-0.20072143368033415,5.063847302508757E-4},
  {-0.15450847389014088,0.4445282308300502,1.3210193670894124,1.438630652536415,1.1393824991737544,0.9242524003880297,0.5515905392198068,-0.1876578369834383,-0.6300810514388464,-0.18757379075178862},
  {-0.4507427147809278,0.186380249511777,1.1185358600625661,1.244936348186211,0.9368989013893636,0.730558307918318,0.3491064488712232,-0.44580442426550415,-0.9263185467870629,-0.44571420627497793},
  {-0.4045079324040347,0.1945283790774398,1.0710189405601074,1.188630135249993,0.8893820726446463,0.674251883098557,0.3015901126947732,-0.4376576887415553,-0.8800805098728941,-0.4375736425736382},
  {0.03402663324877345,0.6711505156153781,1.603307468049985,1.7297081680558881,1.4216705093754407,1.215330127793106,0.8338780568454692,0.038965841852413585,-0.4415491989270246,0.03905605999171972},
  {0.4045120011763734,1.0035461781135833,1.8800336200227346,1.9976443221509337,1.6983967521137475,1.4832660699875588,1.1106047921914792,0.37136011018419146,-0.07106057626236988,0.3714441560062341},
  {0.31462067433658825,0.6724525054015384,1.1964138146672,1.2583620198620136,1.0147775215252215,0.7439824258423089,0.42698868103199594,0.04025760903653407,-0.16093129208223295,0.04030256877508131},
  {0.15452793953796876,0.34730040590799627,0.6300213603743201,0.6538786575027613,0.448385460556196,0.13949814522518567,-0.13940124525225275,-0.28490053191991094,-0.32100992234833614,-0.2848823195336212},
  {0.3145838483415956,0.6724424234946162,1.196442820232262,1.258397197185955,1.014806527026554,0.7440176033150323,0.4270176861874519,0.040247528108495134,-0.1609681203625289,0.04029249218083959}
};
static const double REVERTED_2_0_JAVA_SINUSOID_OBLIQUE_1_3_3[5][5] = {
  {0.5050024278694903,0.9887572531426561,0.8099408657877899,0.21577230037472048,0.04201789162935318},
  {-0.1501864012237338,1.2873719499833836,1.1485529330802435,0.4663176876726579,-0.4805924263834389},
  {-0.381770464212302,1.0957852574357265,0.9586435143141194,0.27271522781928237,-0.7066168623234513},
  {0.3869707471443186,1.776459788376413,1.6356250041350884,0.9578280989425275,0.04988309680027503},
  {0.2155802426140947,0.8319135785391285,0.6586568182113128,0.0522470010139697,-0.22897590531973058}
};

// ----------------------- Helpers to run the tests -----------------------

static bool resize_and_compare_square(const double (&java_down)[5][5],
                                      const double (&java_reverted)[10][10],
                                      int degree,
                                      const std::string& method,
                                      double tolerance)
{
  using clock = std::chrono::steady_clock;

  // Input: 10x10 with a 4x4 ones block at [3:7,3:7] (already normalized to 1.0)
  const int H=10, W=10;
  std::vector<double> img(H*W, 0.0);
  for (int y=3; y<7; ++y) for (int x=3; x<7; ++x) img[y*W+x] = 1.0;

  std::vector<int64_t> in_shape = {H, W};

  // Compute once for correctness (MSE)
  auto down0 = resize_nd(img, in_shape, {0.5, 0.5}, method, degree);
  auto up0   = resize_nd(down0, {5,5},   {2.0, 2.0}, method, degree);

  const auto ref_down = flat(java_down);
  const auto ref_up   = flat(java_reverted);

  double m1 = mse(down0, ref_down);
  double m2 = mse(up0,   ref_up);

  std::cout << method << " deg=" << degree
            << "  square:  MSE down=" << m1
            << "  MSE revert=" << m2
            << "  tol=" << tolerance
            << ( (m1<tolerance && m2<tolerance) ? "  OK\n" : "  FAIL\n" );

  // --- timing: average over 5 runs (1 warmup) ---
  constexpr int WARMUP = 1, RUNS = 5;

  // warmup
  for (int w=0; w<WARMUP; ++w) {
    auto tmp_down = resize_nd(img, in_shape, {0.5, 0.5}, method, degree);
    auto tmp_up   = resize_nd(tmp_down, {5,5}, {2.0, 2.0}, method, degree);
    volatile double sink = tmp_up[0]; (void)sink;
  }

  std::vector<double> t_down, t_up, t_total;
  t_down.reserve(RUNS); t_up.reserve(RUNS); t_total.reserve(RUNS);

  for (int r=0; r<RUNS; ++r) {
    auto t0 = clock::now();
    auto tmp_down = resize_nd(img, in_shape, {0.5, 0.5}, method, degree);
    auto t1 = clock::now();
    auto tmp_up   = resize_nd(tmp_down, {5,5}, {2.0, 2.0}, method, degree);
    auto t2 = clock::now();

    t_down .push_back(std::chrono::duration<double,std::milli>(t1-t0).count());
    t_up   .push_back(std::chrono::duration<double,std::milli>(t2-t1).count());
    t_total.push_back(std::chrono::duration<double,std::milli>(t2-t0).count());

    volatile double sink = tmp_up[0]; (void)sink;
  }

  auto mean_sd = [](const std::vector<double>& v){
    double sum = 0.0; for (double x : v) sum += x;
    const double m = sum / (v.empty() ? 1.0 : (double)v.size());
    double s2 = 0.0; for (double x : v) { double d = x - m; s2 += d*d; }
    double sd = std::sqrt(s2 / (v.size() > 1 ? (v.size()-1) : 1));
    return std::pair<double,double>(m, sd);
  };
  auto [md, sdd] = mean_sd(t_down);
  auto [mu, sdu] = mean_sd(t_up);
  auto [mt, sdt] = mean_sd(t_total);

  std::cout << std::fixed << std::setprecision(3)
            << "[Timing avg/5] " << method << " deg=" << degree
            << " square: down x0.5 " << md << " +- " << sdd
            << " ms; up x2.0 " << mu << " +- " << sdu
            << " ms; total " << mt << " +- " << sdt << " ms\n\n";

  return (m1 < tolerance && m2 < tolerance);
}

static bool resize_and_compare_sinusoid(const double (&java_upscaled)[10][10],
                                        const double (&java_reverted)[5][5],
                                        int degree,
                                        const std::string& method,
                                        double tolerance)
{
  using clock = std::chrono::steady_clock;

  // Build 5x5 sinusoid like Python
  const int N=5;
  std::vector<double> img(N*N, 0.0);

  // use a portable Ï€
  const double pi = std::acos(-1.0);
  const double freq_x = 2.0 * pi / 5.0;
  const double freq_y = 3.0 * pi / 5.0;

  double maxval = -1e300;
  for (int x=0; x<N; ++x) {
    for (int y=0; y<N; ++y) {
      double sinusoid = 0.5 * (std::sin(freq_x * x) + std::cos(freq_y * y));
      double val = ((1 <= x && x < 4) && (1 <= y && y < 4)) ? (1.0 + sinusoid) : sinusoid;
      img[x*N + y] = val;
      maxval = std::max(maxval, val);
    }
  }
  // Normalize by (1.0 + max(img))
  const double norm = 1.0 + maxval;
  for (double& v : img) v /= norm;

  std::vector<int64_t> in_shape = {N, N};

  // Compute once for correctness (MSE)
  auto up0   = resize_nd(img, in_shape, {2.0, 2.0}, method, degree);
  auto back0 = resize_nd(up0, {10,10}, {0.5, 0.5}, method, degree);

  const auto ref_up   = flat(java_upscaled);
  const auto ref_back = flat(java_reverted);

  double m1 = mse(up0,   ref_up);
  double m2 = mse(back0, ref_back);

  std::cout << method << " deg=" << degree
            << "  sinusoid: MSE up=" << m1
            << "  MSE revert=" << m2
            << "  tol=" << tolerance
            << ( (m1<tolerance && m2<tolerance) ? "  OK\n" : "  FAIL\n" );

  // --- timing: average over 10 runs (1 warmup) ---
  constexpr int WARMUP = 1, RUNS = 10;

  // warmup
  for (int w=0; w<WARMUP; ++w) {
    auto tmp_up   = resize_nd(img, in_shape, {2.0, 2.0}, method, degree);
    auto tmp_down = resize_nd(tmp_up, {10,10}, {0.5, 0.5}, method, degree);
    volatile double sink = tmp_down[0]; (void)sink;
  }

  std::vector<double> t_up, t_down, t_total;
  t_up.reserve(RUNS); t_down.reserve(RUNS); t_total.reserve(RUNS);

  for (int r=0; r<RUNS; ++r) {
    auto t0 = clock::now();
    auto tmp_up   = resize_nd(img, in_shape, {2.0, 2.0}, method, degree);
    auto t1 = clock::now();
    auto tmp_down = resize_nd(tmp_up, {10,10}, {0.5, 0.5}, method, degree);
    auto t2 = clock::now();

    t_up   .push_back(std::chrono::duration<double,std::milli>(t1-t0).count());
    t_down .push_back(std::chrono::duration<double,std::milli>(t2-t1).count());
    t_total.push_back(std::chrono::duration<double,std::milli>(t2-t0).count());

    volatile double sink = tmp_down[0]; (void)sink;
  }

  auto mean_sd = [](const std::vector<double>& v){
    double sum = 0.0; for (double x : v) sum += x;
    const double m = sum / (v.empty() ? 1.0 : (double)v.size());
    double s2 = 0.0; for (double x : v) { double d = x - m; s2 += d*d; }
    double sd = std::sqrt(s2 / (v.size() > 1 ? (v.size()-1) : 1));
    return std::pair<double,double>(m, sd);
  };
  auto [mu, sdu] = mean_sd(t_up);
  auto [md, sdd] = mean_sd(t_down);
  auto [mt, sdt] = mean_sd(t_total);

  std::cout << std::fixed << std::setprecision(3)
            << "[Timing avg] " << method << " deg=" << degree
            << " sinusoid: up x2.0 " << mu << " +- " << sdu
            << " ms; down x0.5 " << md << " +- " << sdd
            << " ms; total " << mt << " +- " << sdt << " ms\n\n";

  return (m1 < tolerance && m2 < tolerance);
}

// ----------------------------------- main -----------------------------------

int main() {
  bool ok = true;

  // Square tests
  ok &= resize_and_compare_square(DOWNSCALED_0_5_JAVA_SQUARE_LS_3_3_3,
                                  REVERTED_0_5_JAVA_SQUARE_LS_3_3_3,
                                  /*degree=*/3, /*method=*/"least-squares",
                                  /*tol=*/4e-2);

  ok &= resize_and_compare_square(DOWNSCALED_0_5_JAVA_SQUARE_LS_1_1_1,
                                  REVERTED_0_5_JAVA_SQUARE_LS_1_1_1,
                                  /*degree=*/1, /*method=*/"least-squares",
                                  /*tol=*/3e-4);

  ok &= resize_and_compare_square(DOWNSCALED_0_5_JAVA_SQUARE_OBLIQUE_0_1_1,
                                  REVERTED_0_5_JAVA_SQUARE_OBLIQUE_0_1_1,
                                  /*degree=*/1, /*method=*/"oblique",
                                  /*tol=*/2e-4);

  ok &= resize_and_compare_square(DOWNSCALED_0_5_JAVA_SQUARE_OBLIQUE_1_3_3,
                                  REVERTED_0_5_JAVA_SQUARE_OBLIQUE_1_3_3,
                                  /*degree=*/3, /*method=*/"oblique",
                                  /*tol=*/13e-3);

  // Sinusoid tests
  ok &= resize_and_compare_sinusoid(UPSCALED_2_0_JAVA_SINUSOID_LS_3_3_3,
                                    REVERTED_2_0_JAVA_SINUSOID_LS_3_3_3,
                                    /*degree=*/3, /*method=*/"least-squares",
                                    /*tol=*/2.2);

  ok &= resize_and_compare_sinusoid(UPSCALED_2_0_JAVA_SINUSOID_LS_1_1_1,
                                    REVERTED_2_0_JAVA_SINUSOID_LS_1_1_1,
                                    /*degree=*/1, /*method=*/"least-squares",
                                    /*tol=*/0.6);

  ok &= resize_and_compare_sinusoid(UPSCALED_2_0_JAVA_SINUSOID_OBLIQUE_0_1_1,
                                    REVERTED_2_0_JAVA_SINUSOID_OBLIQUE_0_1_1,
                                    /*degree=*/1, /*method=*/"oblique",
                                    /*tol=*/0.6);

  ok &= resize_and_compare_sinusoid(UPSCALED_2_0_JAVA_SINUSOID_OBLIQUE_1_3_3,
                                    REVERTED_2_0_JAVA_SINUSOID_OBLIQUE_1_3_3,
                                    /*degree=*/3, /*method=*/"oblique",
                                    /*tol=*/0.6);

  if (ok) {
    std::cout << "ALL TESTS PASSED\n";
    return 0;
  } else {
    std::cout << "SOME TESTS FAILED\n";
    return 1;
  }
}

"use strict";(self.webpackChunk_jupytergis_jupytergis_lab=self.webpackChunk_jupytergis_jupytergis_lab||[]).push([[484],{3484(e,t,n){n.r(t),n.d(t,{default:()=>v});var o=n(640),a=n(7906),r=n(5875),s=n(2684),d=n(6707),i=n(4591),m=n(1247),l=n(9827),c=n(1805),u=n(7292),g=n(8389),p=n(1907),y=n(223),I=n(6230),h=n(9173);class M extends h.JupyterYModel{}class b extends m.Panel{constructor(e){super(),this._buildWidget=e=>{const{commands:t,model:n,externalCommands:a,tracker:r,formSchemaRegistry:s,state:d,annotationModel:i}=e,m=new o.JupyterGISPanel({model:n,commandRegistry:t,formSchemaRegistry:s,state:d,annotationModel:i});let l;n.filePath&&(l=new o.ToolbarWidget({commands:t,model:n,externalCommands:(null==a?void 0:a.getCommands())||[]})),this._jgisWidget=new o.JupyterGISOutputWidget({model:n,content:m,toolbar:l}),this.addWidget(this._jgisWidget),null==r||r.add(this._jgisWidget)};const{model:t}=e;this.addClass("jupytergis-notebook-widget"),this._buildWidget(e),t.sharedModel.changed.connect((t,n)=>{n.stateChange&&n.stateChange.forEach(t=>{var n;"path"===t.name&&(null===(n=this.layout)||void 0===n||n.removeWidget(this._jgisWidget),this._jgisWidget.dispose(),this._buildWidget(e))})})}get jgisWidget(){return this._jgisWidget}}const j={id:"jupytergis:yjswidget-plugin",autoStart:!0,requires:[a.IJGISFormSchemaRegistryToken],optional:[a.IJGISExternalCommandRegistryToken,a.IJupyterGISDocTracker,h.IJupyterYWidgetManager,p.IDefaultDrive,d.IStateDB,a.IAnnotationToken,y.ISettingRegistry],activate:(e,t,n,o,r,s,d,i,p)=>{r?r.registerWidget("@jupytergis:widget",class extends M{async initialize(t){const{path:n,format:o,contentType:r}=t,d=o;if(!s)throw(0,l.showErrorMessage)("Error using the JupyterGIS Python API","You cannot use the JupyterGIS Python API without a collaborative drive. You need to install a package providing collaboration features (e.g. jupyter-collaboration)."),new Error("Failed to create the YDoc without a collaborative drive");let i="";const m=e.shell.currentWidget;(m instanceof g.NotebookPanel||m instanceof c.ConsolePanel)&&(i=m.sessionContext.path);let y="";if(n){y=u.PathExt.join(u.PathExt.dirname(i),n);try{await e.serviceManager.contents.get(y)}catch(t){await e.serviceManager.contents.save(y,{content:btoa("{}"),format:"base64"})}}else y=u.PathExt.join(u.PathExt.dirname(i),"unsaved_project");const I=e.serviceManager.contents.getSharedModelFactory(y,{contentProviderId:"rtc"});if(!I)throw new Error("Cannot initialize JupyterGIS notebook renderer without a sharedModelFactory");const M=I.createNew({path:y,format:d,contentType:r,collaborative:!0});this.jupyterGISModel=new a.JupyterGISModel({sharedModel:M,settingRegistry:p}),this.jupyterGISModel.contentsManager=e.serviceManager.contents,this.jupyterGISModel.filePath=y,this.ydoc=this.jupyterGISModel.sharedModel.ydoc,this.sharedModel=new h.JupyterYDoc(t,this.ydoc)}},class{constructor(a,r){this.yModel=a,this.node=r;const s=new b({commands:e.commands,model:a.jupyterGISModel,externalCommands:n,tracker:o,annotationModel:i,state:d,formSchemaRegistry:t});this._jgisWidget=s.jgisWidget,I.MessageLoop.sendMessage(s,m.Widget.Msg.BeforeAttach),r.appendChild(s.node),I.MessageLoop.sendMessage(s,m.Widget.Msg.AfterAttach)}dispose(){this._jgisWidget.dispose()}}):console.error("Missing IJupyterYWidgetManager token!")}},v=[{id:"jupytergis:lab:main-menu",autoStart:!0,requires:[a.IJupyterGISDocTracker,a.IJGISFormSchemaRegistryToken,a.IJGISLayerBrowserRegistryToken,d.IStateDB],optional:[s.IMainMenu,i.ITranslator,r.ICompletionProviderManager],activate:(e,t,n,r,s,d,l,c)=>{console.debug("jupytergis:lab:main-menu is activated!"),l=null!=l?l:i.nullTranslator;(0,o.createDefaultLayerRegistry)(r),o.GlobalStateDbManager.getInstance().initialize(s),(0,o.addCommands)(e,t,l,n,r,s,c),e.contextMenu.addItem({selector:".jp-gis-source.jp-gis-sourceUnused",rank:1,command:o.CommandIDs.removeSource}),e.contextMenu.addItem({selector:".jp-gis-source",rank:1,command:o.CommandIDs.renameSource}),e.contextMenu.addItem({command:o.CommandIDs.symbology,selector:".jp-gis-layerItem",rank:1}),e.contextMenu.addItem({type:"separator",selector:".jp-gis-layerPanel",rank:1}),e.contextMenu.addItem({command:o.CommandIDs.removeLayer,selector:".jp-gis-layerItem",rank:2}),e.contextMenu.addItem({command:o.CommandIDs.renameLayer,selector:".jp-gis-layerItem",rank:2}),e.contextMenu.addItem({command:o.CommandIDs.zoomToLayer,selector:".jp-gis-layerItem",rank:2});const u=new m.Menu({commands:e.commands});u.title.label=l.load("jupyterlab").__("Download"),u.id="jp-gis-contextmenu-download",u.addItem({command:o.CommandIDs.downloadGeoJSON}),e.contextMenu.addItem({type:"submenu",selector:".jp-gis-layerItem",rank:2,submenu:u});const g=new m.Menu({commands:e.commands});g.title.label=l.load("jupyterlab").__("Processing"),g.id="jp-gis-contextmenu-processing";for(const e of a.ProcessingMerge)g.addItem({command:e.name});e.contextMenu.addItem({type:"submenu",selector:".jp-gis-layerItem",rank:2,submenu:g});const p=new m.Menu({commands:e.commands});p.title.label=l.load("jupyterlab").__("Move Selected Layers to Group"),p.id="jp-gis-contextmenu-movelayer",e.contextMenu.addItem({type:"submenu",selector:".jp-gis-layerItem",rank:2,submenu:p}),e.contextMenu.opened.connect(()=>function(e,t){var n,a,r,s;if(!(null===(n=t.currentWidget)||void 0===n?void 0:n.model))return;const d=null===(a=t.currentWidget)||void 0===a?void 0:a.model,i=null!==(s=null===(r=e.menu.items.find(e=>{var t;return"submenu"===e.type&&"jp-gis-contextmenu-movelayer"===(null===(t=e.submenu)||void 0===t?void 0:t.id)}))||void 0===r?void 0:r.submenu)&&void 0!==s?s:null;if(!i)return;i.clearItems();const m=function e(t){const n=[];for(const o of t)if("string"!=typeof o&&o.layers){n.push(o.name);const t=e(o.layers);n.push(...t)}return n}(d.getLayerTree());i.addItem({command:o.CommandIDs.moveLayersToGroup,args:{label:""}}),m.forEach(e=>{i.addItem({command:o.CommandIDs.moveLayersToGroup,args:{label:e}})}),i.addItem({command:o.CommandIDs.moveLayerToNewGroup})}(e.contextMenu,t)),e.contextMenu.addItem({command:o.CommandIDs.removeGroup,selector:".jp-gis-layerGroupHeader",rank:2}),e.contextMenu.addItem({command:o.CommandIDs.renameGroup,selector:".jp-gis-layerGroupHeader",rank:2}),e.contextMenu.addItem({type:"separator",selector:".jp-gis-layerPanel",rank:2});const y=new m.Menu({commands:e.commands});y.title.label=l.load("jupyterlab").__("Add Layer"),y.id="jp-gis-contextmenu-addLayer",y.addItem({type:"submenu",submenu:(0,o.rasterSubMenu)(e.commands)}),y.addItem({type:"submenu",submenu:(0,o.vectorSubMenu)(e.commands)}),e.contextMenu.addItem({type:"submenu",selector:".jp-gis-layerPanel",rank:3,submenu:y}),e.contextMenu.addItem({selector:".jp-gis-layerPanel",command:o.CommandIDs.addStorySegment,rank:4}),d&&function(e,t){e.editMenu.undoers.redo.add({id:o.CommandIDs.redo,isEnabled:t}),e.editMenu.undoers.undo.add({id:o.CommandIDs.undo,isEnabled:t})}(d,()=>null!==t.currentWidget&&t.currentWidget===e.shell.currentWidget)}},j]}}]);
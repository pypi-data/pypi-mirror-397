var at=Object.defineProperty;var u=(n,e)=>at(n,"name",{value:e,configurable:!0});import{w as g,cD as N,cE as Ie,cF as C,ak as k,an as B,cG as rt,aJ as re,cH as lt,cI as dt,bi as Je,a6 as ct,x as ut,h as S,a1 as pt,t as x,G as ee,cJ as ht,cK as gt,cL as R,cM as L,aW as mt,cN as Ce,cO as ft,cP as yt,cQ as wt,cR as Re,ac as de,cS as U,cT as $,aB as ce,cU as Ze,cV as te,cW as bt,cX as vt,cY as Ct,cZ as F,F as _t,c_ as kt,C as Nt,a as A,c$ as Qe,av as It,d0 as xt,aC as Dt,g as Q,d1 as V,aw as Tt,u as et,cA as Et,cB as ue,cC as ne,d2 as xe,d3 as De,d4 as St,d5 as Mt,d6 as At,U as We,d7 as Ot,b$ as Pt,d8 as Lt,d9 as Rt,da as Wt,db as Ft}from"./index-DkaQAqNW.js";import{cr as Fe,cA as q,n as Te,eu as Bt}from"./vendor-other-BuYjBaXg.js";import{l as Ut}from"./mathUtil-CL7lMSDB.js";import{_ as Ee}from"./Load3D.vue_vue_type_script_setup_true_lang-GG0K2VyX.js";import{g as pe,s as tt}from"./audioUtils-QoxrmmY1.js";import{u as Z}from"./audioService-Bv7REBx_.js";import"./vendor-primevue-D1bWBpUY.js";import"./vendor-vue-C5v91m9x.js";import"./vendor-xterm-DV1MVhAx.js";import"./vendor-three-zdhtZbSm.js";import"./vendor-tiptap-wbntxnQl.js";class M extends Ie{static{u(this,"ClipspaceDialog")}static items=[];static instance=null;static registerButton(e,t,o){const i=C("button",{type:"button",textContent:e,contextPredicate:t,onclick:o});M.items.push(i)}static invalidatePreview(){if(N.clipspace&&N.clipspace.imgs&&N.clipspace.imgs.length>0){const e=document.getElementById("clipspace_preview");e&&(e.src=N.clipspace.imgs[N.clipspace.selectedIndex].src,e.style.maxHeight="100%",e.style.maxWidth="100%")}}static invalidate(){if(M.instance){const e=M.instance,t=C("div.comfy-modal-content",[e.createImgSettings(),...e.createButtons()]);e.element?(e.element.firstChild&&e.element.removeChild(e.element.firstChild),e.element.appendChild(t)):e.element=C("div.comfy-modal",{parent:document.body},[t]),e.element.children[0].children.length<=1&&e.element.children[0].appendChild(C("p",{},["Unable to find the features to edit content of a format stored in the current Clipspace."])),M.invalidatePreview()}}constructor(){super()}createButtons(){const e=[];for(let t in M.items){const o=M.items[t];(!o.contextPredicate||o.contextPredicate())&&e.push(M.items[t])}return e.push(C("button",{type:"button",textContent:"Close",onclick:u(()=>{this.close()},"onclick")})),e}createImgSettings(){if(N.clipspace?.imgs){const e=[],t=N.clipspace.imgs;for(let d=0;d<t.length;d++)e.push(C("option",{value:d},[`${d}`]));const o=C("select",{id:"clipspace_img_selector",onchange:u(d=>{d.target&&N.clipspace&&(N.clipspace.selectedIndex=d.target.selectedIndex,M.invalidatePreview())},"onchange")},e),i=C("tr",{},[C("td",{},[C("font",{color:"white"},["Select Image"])]),C("td",{},[o])]),s=C("select",{id:"clipspace_img_paste_mode",onchange:u(d=>{d.target&&N.clipspace&&(N.clipspace.img_paste_mode=d.target.value)},"onchange")},[C("option",{value:"selected"},"selected"),C("option",{value:"all"},"all")]);s.value=N.clipspace.img_paste_mode;const a=C("tr",{},[C("td",{},[C("font",{color:"white"},["Paste Mode"])]),C("td",{},[s])]),r=C("td",{align:"center",width:"100px",height:"100px",colSpan:"2"},[C("img",{id:"clipspace_preview",ondragstart:u(()=>!1,"ondragstart")},[])]),l=C("tr",{},[r]);return C("table",{},[i,a,l])}else return[]}createImgPreview(){return N.clipspace?.imgs?C("img",{id:"clipspace_preview",ondragstart:u(()=>!1,"ondragstart")}):[]}show(){M.invalidate(),this.element.style.display="block"}}g.registerExtension({name:"Comfy.Clipspace",init(n){n.openClipspace=function(){M.instance||(M.instance=new M,N.clipspace_invalidate_handler=M.invalidate),N.clipspace?M.instance.show():n.ui.dialog.show("Clipspace is Empty!")}}});window.comfyAPI=window.comfyAPI||{};window.comfyAPI.clipspace=window.comfyAPI.clipspace||{};window.comfyAPI.clipspace.ClipspaceDialog=M;const Gt={name:"Comfy.ContextMenuFilter",init(){const n=k.ContextMenu;k.ContextMenu=function(e,t){const o=new n(e,t);if(t?.className==="dark"&&e?.length>4){const i=document.createElement("input");i.classList.add("comfy-context-menu-filter"),i.placeholder="Filter list",o.root.prepend(i);const s=Array.from(o.root.querySelectorAll(".litemenu-entry"));let a=[...s],r=a.length;requestAnimationFrame(()=>{const d=B.active_canvas.current_node?.widgets?.filter(m=>rt(m)&&m.options.values?.length===e.length).find(m=>m.options.values?.every((f,y)=>f===e[y]))?.value;let c=d?e.findIndex(m=>m===d):0;c<0&&(c=0);let h=a[c];w();function w(){h?.style.setProperty("background-color",""),h?.style.setProperty("color",""),h=a[c],h?.style.setProperty("background-color","#ccc","important"),h?.style.setProperty("color","#000","important")}u(w,"updateSelected");const p=u(()=>{if(o.root.getBoundingClientRect().top<0){const f=1-o.root.getBoundingClientRect().height/o.root.clientHeight,y=o.root.clientHeight*f/2;o.root.style.top=-y+"px"}},"positionList");i.addEventListener("keydown",m=>{switch(m.key){case"ArrowUp":m.preventDefault(),c===0?c=r-1:c--,w();break;case"ArrowRight":m.preventDefault(),c=r-1,w();break;case"ArrowDown":m.preventDefault(),c===r-1?c=0:c++,w();break;case"ArrowLeft":m.preventDefault(),c=0,w();break;case"Enter":h?.click();break;case"Escape":o.close();break}}),i.addEventListener("input",()=>{const m=i.value.toLocaleLowerCase();if(a=s.filter(f=>{const y=!m||f.textContent?.toLocaleLowerCase().includes(m);return f.style.display=y?"block":"none",y}),c=0,a.includes(h)&&(c=a.findIndex(f=>f===h)),r=a.length,w(),t.event){let f=t.event.clientY-10;const y=document.body.getBoundingClientRect(),b=o.root.getBoundingClientRect();y.height&&f>y.height-b.height-10&&(f=Math.max(0,y.height-b.height-10)),o.root.style.top=f+"px",p()}}),requestAnimationFrame(()=>{i.focus(),p()})})}return o},k.ContextMenu.prototype=n.prototype}};g.registerExtension(Gt);re().registerExtension({name:"Comfy.DynamicPrompts",nodeCreated(n){if(n.widgets){const e=n.widgets.filter(t=>t.dynamicPrompts);for(const t of e)t.serializeValue=(o,i)=>{if(typeof t.value!="string")return t.value;const s=lt(t.value);return o?.widgets_values&&(o.widgets_values[i]=s),s}}}});g.registerExtension({name:"Comfy.EditAttention",init(){const n=g.ui.settings.addSetting({id:"Comfy.EditAttention.Delta",category:["Comfy","EditTokenWeight","Delta"],name:"Ctrl+up/down precision",type:"slider",attrs:{min:.01,max:.5,step:.01},defaultValue:.05});function e(s,a){const r=parseFloat(s);if(isNaN(r))return s;const l=r+a;return String(Number(l.toFixed(10)))}u(e,"incrementWeight");function t(s,a){let r=a,l=a,d=0,c=0;for(;r>=0&&(r--,!(s[r]==="("&&d===c));)s[r]==="("&&d++,s[r]===")"&&c++;if(r<0)return null;for(d=0,c=0;l<s.length&&!(s[l]===")"&&d===c);)s[l]==="("&&d++,s[l]===")"&&c++,l++;return l===s.length?null:{start:r+1,end:l}}u(t,"findNearestEnclosure");function o(s){const a=/^\((.*)\)$/,r=s.match(a),l=/:([+-]?(\d*\.)?\d+([eE][+-]?\d+)?)/,d=s.match(l);return r&&!d?`(${r[1]}:1.0)`:s}u(o,"addWeightToParentheses");function i(s){const a=s.composedPath()[0],r=parseFloat(n.value);if(a.tagName!=="TEXTAREA"||!(s.key==="ArrowUp"||s.key==="ArrowDown")||!s.ctrlKey&&!s.metaKey)return;s.preventDefault();let l=a.selectionStart,d=a.selectionEnd,c=a.value.substring(l,d);if(!c){const p=t(a.value,l);if(p)l=p.start,d=p.end,c=a.value.substring(l,d);else{const m=" .,\\/!?%^*;:{}=-_`~()\r\n	";for(;!m.includes(a.value[l-1])&&l>0;)l--;for(;!m.includes(a.value[d])&&d<a.value.length;)d++;if(c=a.value.substring(l,d),!c)return}}c[c.length-1]===" "&&(c=c.substring(0,c.length-1),d-=1),a.value[l-1]==="("&&a.value[d]===")"&&(l-=1,d+=1,c=a.value.substring(l,d)),(c[0]!=="("||c[c.length-1]!==")")&&(c=`(${c})`),c=o(c);const h=s.key==="ArrowUp"?r:-r,w=c.replace(/\((.*):([+-]?\d+(?:\.\d+)?)\)/,(p,m,f)=>(f=e(f,h),f==1?m:`(${m}:${f})`));a.setSelectionRange(l,d),document.execCommand("insertText",!1,w),a.setSelectionRange(l,l+w.length)}u(i,"editAttention"),window.addEventListener("keydown",i)}});const zt={settingId:"Comfy-Desktop.UV.PythonInstallMirror",mirror:"https://github.com/astral-sh/python-build-standalone/releases/download",fallbackMirror:"https://python-standalone.org/mirror/astral-sh/python-build-standalone",validationPathSuffix:"/20250115/cpython-3.10.16+20250115-aarch64-apple-darwin-debug-full.tar.zst.sha256"},ye=u(async n=>dt(n)&&await Je().NetWork.canAccessUrl(n),"checkMirrorReachable");(async()=>{if(!ct())return;const n=Je(),e=await n.getElectronVersion(),t=ut(),o=S(),{staticUrls:i,buildDocsUrl:s}=pt(),a=u((r,l)=>{l!==void 0&&r!==l&&n.restartApp("Restart ComfyUI to apply changes.",1500)},"onChangeRestartApp");g.registerExtension({name:"Comfy.ElectronAdapter",settings:[{id:"Comfy-Desktop.AutoUpdate",category:["Comfy-Desktop","General","AutoUpdate"],name:"Automatically check for updates",type:"boolean",defaultValue:!0,onChange:a},{id:"Comfy-Desktop.SendStatistics",category:["Comfy-Desktop","General","Send Statistics"],name:"Send anonymous usage metrics",type:"boolean",defaultValue:!0,onChange:a},{id:"Comfy-Desktop.WindowStyle",category:["Comfy-Desktop","General","Window Style"],name:"Window Style",tooltip:"Custom: Replace the system title bar with ComfyUI's Top menu",type:"combo",experimental:!0,defaultValue:"default",options:["default","custom"],onChange:u((r,l)=>{l&&n.Config.setWindowStyle(r)},"onChange")},{id:"Comfy-Desktop.UV.PythonInstallMirror",name:"Python Install Mirror",tooltip:"Managed Python installations are downloaded from the Astral python-build-standalone project. This variable can be set to a mirror URL to use a different source for Python installations. The provided URL will replace https://github.com/astral-sh/python-build-standalone/releases/download in, e.g., https://github.com/astral-sh/python-build-standalone/releases/download/20240713/cpython-3.12.4%2B20240713-aarch64-apple-darwin-install_only.tar.gz. Distributions can be read from a local directory by using the file:// URL scheme.",type:"url",defaultValue:"",attrs:{validateUrlFn(r){return ye(r+zt.validationPathSuffix)}}},{id:"Comfy-Desktop.UV.PypiInstallMirror",name:"Pypi Install Mirror",tooltip:"Default pip install mirror",type:"url",defaultValue:"",attrs:{validateUrlFn:ye}},{id:"Comfy-Desktop.UV.TorchInstallMirror",name:"Torch Install Mirror",tooltip:"Pip install mirror for pytorch",type:"url",defaultValue:"",attrs:{validateUrlFn:ye}}],commands:[{id:"Comfy-Desktop.Folders.OpenLogsFolder",label:"Open Logs Folder",icon:"pi pi-folder-open",function(){n.openLogsFolder()}},{id:"Comfy-Desktop.Folders.OpenModelsFolder",label:"Open Models Folder",icon:"pi pi-folder-open",function(){n.openModelsFolder()}},{id:"Comfy-Desktop.Folders.OpenOutputsFolder",label:"Open Outputs Folder",icon:"pi pi-folder-open",function(){n.openOutputsFolder()}},{id:"Comfy-Desktop.Folders.OpenInputsFolder",label:"Open Inputs Folder",icon:"pi pi-folder-open",function(){n.openInputsFolder()}},{id:"Comfy-Desktop.Folders.OpenCustomNodesFolder",label:"Open Custom Nodes Folder",icon:"pi pi-folder-open",function(){n.openCustomNodesFolder()}},{id:"Comfy-Desktop.Folders.OpenModelConfig",label:"Open extra_model_paths.yaml",icon:"pi pi-file",function(){n.openModelConfig()}},{id:"Comfy-Desktop.OpenDevTools",label:"Open DevTools",icon:"pi pi-code",function(){n.openDevTools()}},{id:"Comfy-Desktop.OpenUserGuide",label:"Desktop User Guide",icon:"pi pi-book",function(){window.open(s("/installation/desktop",{includeLocale:!0,platform:!0}),"_blank")}},{id:"Comfy-Desktop.CheckForUpdates",label:"Check for Updates",icon:"pi pi-sync",async function(){try{const r=await n.checkForUpdates({disableUpdateReadyAction:!0});if(!r.isUpdateAvailable){o.add({severity:"info",summary:x("desktopUpdate.noUpdateFound"),life:5e3});return}if(await ee().confirm({title:x("desktopUpdate.updateFoundTitle",{version:r.version}),message:x("desktopUpdate.updateAvailableMessage"),type:"default"}))try{n.restartAndInstall()}catch(d){Fe.error("Error installing update:",d),o.add({severity:"error",summary:x("g.error"),detail:x("desktopUpdate.errorInstallingUpdate"),life:1e4})}}catch(r){Fe.error("Error checking for updates:",r),o.add({severity:"error",summary:x("g.error"),detail:x("desktopUpdate.errorCheckingUpdate"),life:1e4})}}},{id:"Comfy-Desktop.Reinstall",label:"Reinstall",icon:"pi pi-refresh",async function(){await ee().confirm({message:x("desktopMenu.confirmReinstall"),title:x("desktopMenu.reinstall"),type:"reinstall"})&&n.reinstall()}},{id:"Comfy-Desktop.Restart",label:"Restart",icon:"pi pi-refresh",function(){n.restartApp()}},{id:"Comfy-Desktop.Quit",label:"Quit",icon:"pi pi-sign-out",async function(){t.modifiedWorkflows.length>0&&!await ee().confirm({message:x("desktopMenu.confirmQuit"),title:x("desktopMenu.quit"),type:"default"})||n.quit()}}],menuCommands:[{path:["Help"],commands:["Comfy-Desktop.OpenUserGuide"]},{path:["Help"],commands:["Comfy-Desktop.OpenDevTools"]},{path:["Help","Open Folder"],commands:["Comfy-Desktop.Folders.OpenLogsFolder","Comfy-Desktop.Folders.OpenModelsFolder","Comfy-Desktop.Folders.OpenOutputsFolder","Comfy-Desktop.Folders.OpenInputsFolder","Comfy-Desktop.Folders.OpenCustomNodesFolder","Comfy-Desktop.Folders.OpenModelConfig"]},{path:["Help"],commands:["Comfy-Desktop.CheckForUpdates","Comfy-Desktop.Reinstall"]}],keybindings:[{commandId:"Workspace.CloseWorkflow",combo:{key:"w",ctrl:!0}}],aboutPageBadges:[{label:"ComfyUI_desktop v"+e,url:i.githubElectron,icon:"pi pi-github"}]})})();class Vt extends ht{static{u(this,"ExecutableGroupNodeChildDTO")}groupNodeHandler;constructor(e,t,o,i,s){super(e,t,o,i),this.groupNodeHandler=s}resolveInput(e){if(this.id.split(":").length>2)throw new Error("Group nodes inside subgraphs are not supported. Please convert the group node to a subgraph instead.");const t=this.node.getInputNode(e);if(!t)return;const o=this.node.getInputLink(e);if(!o)throw new Error("Failed to get input link");const i=String(t.id);let s=this.nodesByExecutionId?.get(i);if(!s){const a=i.split(":").at(-1);a!==void 0&&(s=this.nodesByExecutionId?.get(a))}if(!s)throw new Error(`Failed to get input node ${i} for group node child ${this.id} with slot ${e}`);return{node:s,origin_id:i,origin_slot:o.origin_slot}}}const we=Symbol();function ot(n,e){if(typeof n=="object"&&typeof e=="object")for(const t in e){const o=e[t];if(typeof o=="object"){let i=n[t];i||(i=n[t]={}),ot(i,e[t])}else n[t]=o}return n}u(ot,"merge");class it extends gt{static{u(this,"ManageGroupDialog")}tabs;selectedNodeIndex;selectedTab="Inputs";selectedGroup;modifications={};nodeItems;app;groupNodeType;groupNodeDef;groupData;innerNodesList;widgetsPage;inputsPage;outputsPage;draggable;get selectedNodeInnerIndex(){return+this.nodeItems[this.selectedNodeIndex].dataset.nodeindex}constructor(e){super(),this.app=e,this.element=C("dialog.comfy-group-manage",{parent:document.body})}changeTab(e){this.tabs[this.selectedTab].tab.classList.remove("active"),this.tabs[this.selectedTab].page.classList.remove("active"),this.tabs[e].tab.classList.add("active"),this.tabs[e].page.classList.add("active"),this.selectedTab=e}changeNode(e,t){!t&&this.selectedNodeIndex===e||(this.selectedNodeIndex!=null&&this.nodeItems[this.selectedNodeIndex].classList.remove("selected"),this.nodeItems[e].classList.add("selected"),this.selectedNodeIndex=e,!this.buildInputsPage()&&this.selectedTab==="Inputs"&&this.changeTab("Widgets"),!this.buildWidgetsPage()&&this.selectedTab==="Widgets"&&this.changeTab("Outputs"),!this.buildOutputsPage()&&this.selectedTab==="Outputs"&&this.changeTab("Inputs"),this.changeTab(this.selectedTab))}getGroupData(){this.groupNodeType=k.registered_node_types[`${R}${L}`+this.selectedGroup],this.groupNodeDef=this.groupNodeType.nodeData,this.groupData=G.getGroupData(this.groupNodeType)}changeGroup(e,t=!0){this.selectedGroup=e,this.getGroupData();const o=this.groupData.nodeData.nodes;if(this.nodeItems=o.map((s,a)=>C("li.draggable-item",{dataset:{nodeindex:s.index+""},onclick:u(()=>{this.changeNode(a)},"onclick")},[C("span.drag-handle"),C("div",{textContent:s.title??s.type},s.title?C("span",{textContent:s.type}):[])])),this.innerNodesList.replaceChildren(...this.nodeItems),t)this.selectedNodeIndex=null,this.changeNode(0);else{let a=this.draggable.getAllItems().findIndex(r=>r.classList.contains("selected"));a===-1&&(a=this.selectedNodeIndex),this.changeNode(a,!0)}const i=[...o];this.draggable?.dispose(),this.draggable=new mt(this.innerNodesList,"li"),this.draggable.addEventListener("dragend",({detail:{oldPosition:s,newPosition:a}})=>{if(s!==a){i.splice(a,0,i.splice(s,1)[0]);for(let r=0;r<i.length;r++)this.storeModification({nodeIndex:i[r].index,section:we,prop:"order",value:r})}})}storeModification(e){const{nodeIndex:t,section:o,prop:i,value:s}=e,a=this.modifications[this.selectedGroup]??={},r=a.nodes??={},l=r[t??this.selectedNodeInnerIndex]??={},d=l[o]??={};if(typeof s=="object"){const c=d[i]??={};Object.assign(c,s)}else d[i]=s}getEditElement(e,t,o,i,s,a=!0){o===i&&(o="");const r=this.modifications[this.selectedGroup]?.nodes?.[this.selectedNodeInnerIndex]?.[e]?.[t];return r&&(r.name!=null&&(o=r.name),r.visible!=null&&(s=r.visible)),C("div",[C("input",{value:o,placeholder:i,type:"text",onchange:u(l=>{this.storeModification({section:e,prop:t,value:{name:l.target.value}})},"onchange")}),C("label",{textContent:"Visible"},[C("input",{type:"checkbox",checked:s,disabled:!a,onchange:u(l=>{this.storeModification({section:e,prop:t,value:{visible:!!l.target.checked}})},"onchange")})])])}buildWidgetsPage(){const e=this.groupData.oldToNewWidgetMap[this.selectedNodeInnerIndex],t=Object.keys(e??{}),i=g.graph.extra.groupNodes[this.selectedGroup].config?.[this.selectedNodeInnerIndex]?.input;return this.widgetsPage.replaceChildren(...t.map(s=>this.getEditElement("input",s,e[s],s,i?.[s]?.visible!==!1))),!!t.length}buildInputsPage(){const e=this.groupData.nodeInputs[this.selectedNodeInnerIndex],t=Object.keys(e??{}),i=g.graph.extra.groupNodes[this.selectedGroup].config?.[this.selectedNodeInnerIndex]?.input;return this.inputsPage.replaceChildren(...t.map(s=>{let a=e[s];if(a)return this.getEditElement("input",s,a,s,i?.[s]?.visible!==!1)}).filter(Boolean)),!!t.length}buildOutputsPage(){const e=this.groupData.nodeData.nodes,t=this.groupData.getNodeDef(e[this.selectedNodeInnerIndex]),o=t?.output??[],i=this.groupData.oldToNewOutputMap[this.selectedNodeInnerIndex],a=g.graph.extra.groupNodes[this.selectedGroup].config?.[this.selectedNodeInnerIndex]?.output,l=this.groupData.nodeData.nodes[this.selectedNodeInnerIndex].type!=="PrimitiveNode";return this.outputsPage.replaceChildren(...o.map((d,c)=>{const h=i?.[c],w=t.output_name?.[c]??d;let p=a?.[c]?.name;const m=a?.[c]?.visible||h!=null;return(!p||p===w)&&(p=""),this.getEditElement("output",c,p,w,m,l)}).filter(Boolean)),!!o.length}show(e){const t=Object.keys(g.graph.extra?.groupNodes??{}).sort((s,a)=>s.localeCompare(a));this.innerNodesList=C("ul.comfy-group-manage-list-items"),this.widgetsPage=C("section.comfy-group-manage-node-page"),this.inputsPage=C("section.comfy-group-manage-node-page"),this.outputsPage=C("section.comfy-group-manage-node-page");const o=C("div",[this.widgetsPage,this.inputsPage,this.outputsPage]);this.tabs=[["Inputs",this.inputsPage],["Widgets",this.widgetsPage],["Outputs",this.outputsPage]].reduce((s,[a,r])=>(s[a]={tab:C("a",{onclick:u(()=>{this.changeTab(a)},"onclick"),textContent:a}),page:r},s),{});const i=C("div.comfy-group-manage-outer",[C("header",[C("h2","Group Nodes"),C("select",{onchange:u(s=>{this.changeGroup(s.target.value)},"onchange")},t.map(s=>C("option",{textContent:s,selected:`${R}${L}${s}`===e,value:s})))]),C("main",[C("section.comfy-group-manage-list",this.innerNodesList),C("section.comfy-group-manage-node",[C("header",Object.values(this.tabs).map(s=>s.tab)),o])]),C("footer",[C("button.comfy-btn",{onclick:u(()=>{if(g.graph.nodes.find(a=>a.type===`${R}${L}`+this.selectedGroup)){S().addAlert("This group node is in use in the current workflow, please first remove these.");return}confirm(`Are you sure you want to remove the node: "${this.selectedGroup}"`)&&(delete g.graph.extra.groupNodes[this.selectedGroup],k.unregisterNodeType(`${R}${L}`+this.selectedGroup)),this.show()},"onclick")},"Delete Group Node"),C("button.comfy-btn",{onclick:u(async()=>{let s,a=[];const r={};for(const l in this.modifications){const d=g.graph.extra.groupNodes[l];let c=d.config??={},h=this.modifications[l]?.nodes;if(h){const p=Object.keys(h);if(h[p[0]][we]){const m=[],f={},y={};for(const b of p){const v=h[b][we].order;m[v]=d.nodes[+b],f[v]=h[b],m[v].index=v}for(const b of d.links)b[0]!=null&&(b[0]=d.nodes[b[0]].index),b[2]!=null&&(b[2]=d.nodes[b[2]].index);if(d.external)for(const b of d.external)b[0]=d.nodes[b[0]];for(const b of p)c[b]&&(y[d.nodes[b].index]=c[b]),delete c[b];d.nodes=m,h=f,d.config=c=y}ot(c,h)}r[l]=d,s||(s=g.graph.nodes.reduce((p,m)=>(p[m.type]??=[],p[m.type].push(m),p),{}));const w=s[`${R}${L}`+l];w&&a.push(...w)}await H.registerFromWorkflow(r,{});for(const l of a)l.recreate();this.modifications={},this.app.graph.setDirtyCanvas(!0,!0),this.changeGroup(this.selectedGroup,!1)},"onclick")},"Save"),C("button.comfy-btn",{onclick:u(()=>this.element.close(),"onclick")},"Close")])]);this.element.replaceChildren(i),this.changeGroup(e?t.find(s=>`${R}${L}${s}`===e)??t[0]:t[0]),this.element.showModal(),this.element.addEventListener("close",()=>{this.draggable?.dispose(),this.element.remove()})}}window.comfyAPI=window.comfyAPI||{};window.comfyAPI.groupNodeManage=window.comfyAPI.groupNodeManage||{};window.comfyAPI.groupNodeManage.ManageGroupDialog=it;const $t=new Set(["default","forceInput","defaultInput","control_after_generate","multiline","tooltip","dynamicPrompts"]),Be=u(n=>{const e=n.min??-1/0,t=n.max??1/0;return{min:e,max:t}},"getRange"),jt=u((n,e)=>{const t=n[0],o=n[1]??{},i=e[1]??{},s=Be(o),a=Be(i);if(s.min>a.max||s.max<a.min)return null;const r=o.step??1,l=i.step??1,d={min:Math.max(s.min,a.min),max:Math.min(s.max,a.max),step:Ut(r,l)};return Se([t,{...o,...d}],[t,{...i,...d}])},"mergeNumericInputSpec"),Yt=u((n,e)=>{const t=n[1]??{},o=e[1]??{},i=Re(n),s=Re(e),a=q.intersection(i,s);return a.length===0?null:Se(["COMBO",{...t,options:a}],["COMBO",{...o,options:a}])},"mergeComboInputSpec"),Se=u((n,e)=>{const t=Ce(n),o=n[1]??{},i=e[1]??{};return q.union(q.keys(o),q.keys(i)).filter(r=>!$t.has(r)).every(r=>{const l=o[r],d=i[r];return l===d||q.isNil(l)&&q.isNil(d)})?[t,{...o,...i}]:null},"mergeCommonInputSpec"),qt=u((n,e)=>{const t=Ce(n),o=Ce(e);return t!==o?null:ft(n)||yt(n)?jt(n,e):wt(n)?Yt(n,e):Se(n,e)},"mergeInputSpec"),Xt=u(n=>n.type==="PrimitiveNode","isPrimitiveNode"),be="Run widget replace on values";class _e extends ce{static{u(this,"PrimitiveNode")}controlValues;lastType;static category;constructor(e){super(e),this.addOutput("connect to widget input","*"),this.serialize_widgets=!0,this.isVirtualNode=!0,(!this.properties||!(be in this.properties))&&this.addProperty(be,!1,"boolean")}applyToGraph(e=[]){if(!this.outputs[0].links?.length||!this.graph)return;const t=[...this.outputs[0].links.map(i=>this.graph.links[i]),...e];let o=this.widgets?.[0].value;o&&this.properties[be]&&(o=Ze(this.graph,o));for(const i of t){const s=this.graph?.getNodeById(i.target_id),a=s?.inputs[i.target_slot];if(!a){console.warn("Unable to resolve node or input for link",i);continue}const r=a.widget?.name;if(!r){console.warn("Invalid widget or widget name",a.widget);continue}const l=s.widgets?.find(d=>d.name===r);if(!l){console.warn(`Unable to find widget "${r}" on node [${s.id}]`);continue}l.value=o,l.callback?.(l.value,g.canvas,s,g.canvas.graph_mouse,{})}}refreshComboInNode(){const e=this.widgets?.[0];e?.type==="combo"&&(e.options.values=this.outputs[0].widget[U]()[0],e.options.values.includes(e.value)||(e.value=e.options.values[0],e.callback(e.value)))}onAfterGraphConfigured(){if(this.outputs[0].links?.length&&!this.widgets?.length){if(this.#e(),this.widgets&&this.widgets_values)for(let e=0;e<this.widgets_values.length;e++){const t=this.widgets[e];t&&(t.value=this.widgets_values[e])}this.#t()}}onConnectionsChange(e,t,o){if(g.configuringGraph)return;const i=this.outputs[0].links;o?i?.length&&!this.widgets?.length&&this.#e():(this.#t(),i?.length||this.onLastDisconnect())}onConnectOutput(e,t,o,i,s){if(!o.widget&&!(o.type in $))return!1;if(this.outputs[e].links?.length){const a=this.#o(o);return a&&this.applyToGraph([{target_id:i.id,target_slot:s}]),a}return!0}#e(e){if(!this.outputs[0].links||!this.graph){this.onLastDisconnect();return}const t=this.outputs[0].links[0],o=this.graph.links[t];if(!o)return;const i=this.graph.getNodeById(o.target_id);if(!i||!i.inputs)return;const s=i.inputs[o.target_slot];if(!s)return;let a;if(s.widget)a=s.widget;else{if(!(s.type in $))return;a={name:s.name,[U]:()=>[s.type,{}]}}const r=a[U]?.();if(!r)return;const{type:l}=Kt(r);this.outputs[0].type=l,this.outputs[0].name=l,this.outputs[0].widget=a,this.#s(a[te]??r,i,a.name,e)}#s(e,t,o,i){let s=e[0];s instanceof Array&&(s="COMBO");const[a,r]=this.size;let l;if(bt(s)?l=($[s](this,"value",e,g)||{}).widget:l=this.addWidget(s,"value",null,()=>{},{}),t?.widgets&&l){const c=t.widgets.find(h=>h.name===o);c&&(l.value=c.value)}if(!e?.[1]?.control_after_generate&&(l.type==="number"||l.type==="combo")){let c=this.widgets_values?.[1];c||(c="fixed"),vt(this,l,c,void 0,e);let h=this.widgets_values?.[2];h&&this.widgets&&this.widgets.length===3&&(this.widgets[2].value=h)}const d=this.controlValues;if(this.widgets&&this.lastType===this.widgets[0]?.type&&d?.length===this.widgets.length-1)for(let c=0;c<d.length;c++)this.widgets[c+1].value=d[c];if(l.callback=de(l.callback,()=>{this.applyToGraph()}),this.setSize([Math.max(this.size[0],a),Math.max(this.size[1],r)]),!i){const c=this.computeSize();this.size[0]<c[0]&&(this.size[0]=c[0]),this.size[1]<c[1]&&(this.size[1]=c[1]),requestAnimationFrame(()=>{this.onResize?.(this.size)})}}recreateWidget(){const e=this.widgets?.map(t=>t.value);if(this.#i(),this.#e(!0),e?.length&&this.widgets)for(let t=0;t<this.widgets.length;t++)this.widgets[t].value=e[t];return this.widgets?.[0]}#t(){const e=this.outputs[0],t=e.links??[],o=!!e.widget?.[te];if(o&&delete e.widget?.[te],t?.length<2&&o){t.length&&this.recreateWidget();return}const i=e.widget?.[U]?.();if(!(!i||!(i[0]==="INT"||i[0]==="FLOAT")||!this.graph))for(const a of t){const r=this.graph.links[a];if(!r)continue;const l=this.graph.getNodeById(r.target_id);if(!l)continue;const d=l.inputs[r.target_slot];this.#o(d,o)}}#o(e,t){const o=this.outputs?.[0],i=e.widget?.[U]?.();return i?!!ae.call(this,o,i,t,this.recreateWidget):!1}#i(){if(this.widgets){for(const e of this.widgets)e.onRemove&&e.onRemove();this.controlValues=[],this.lastType=this.widgets[0]?.type;for(let e=1;e<this.widgets.length;e++)this.controlValues.push(this.widgets[e].value);setTimeout(()=>{delete this.lastType,delete this.controlValues},15),this.widgets.length=0}}onLastDisconnect(){this.outputs[0].type="*",this.outputs[0].name="connect to widget input",delete this.outputs[0].widget,this.#i()}}function Me(n){return n.widget?.[te]??n.widget?.[U]?.()??["*",{}]}u(Me,"getWidgetConfig");function Ue(n){const{nodeData:e}=this.constructor;return e?.input?.required?.[n]??e?.input?.optional?.[n]}u(Ue,"getConfig");function Ht(n,e){return console.warn("Please remove call to convertToInput. Widget to socket conversion is no longer necessary, as they co-exist now."),n.inputs.find(t=>t.widget?.name===e.name)}u(Ht,"convertToInput");function Kt(n){let e=n[0];return e instanceof Array&&(e="COMBO"),{type:e}}u(Kt,"getWidgetType");function ke(n,e){if(!n.widget||(e?n.widget[U]=()=>e:delete n.widget,!(n instanceof Ct)))return;const t=n.node.graph;if(!t)return;const o=t.links[n.link??-1];if(!o)return;const i=t.getNodeById(o.origin_id);!i||!Xt(i)||(e?i.recreateWidget():g.configuringGraph||(i.disconnectOutput(0),i.onLastDisconnect()))}u(ke,"setWidgetConfig");function ae(n,e,t,o,i){i||(i=Me(n));const s=qt(i,e);if(s||t){s&&(n.widget[te]=s);const a=o?.call(this);if(a){const r=a.options.min,l=a.options.max;r!=null&&a.value<r&&(a.value=r),l!=null&&a.value>l&&(a.value=l),a.callback(a.value)}}return{customConfig:s?.[1]??{}}}u(ae,"mergeIfValid");g.registerExtension({name:"Comfy.WidgetInputs",async beforeRegisterNodeDef(n,e,t){n.prototype.convertWidgetToInput=function(){return console.warn("Please remove call to convertWidgetToInput. Widget to socket conversion is no longer necessary, as they co-exist now."),!1},n.prototype.onGraphConfigured=de(n.prototype.onGraphConfigured,function(){if(this.inputs){this.widgets??=[];for(const i of this.inputs)if(i.widget){const s=i.widget.name;i.widget[U]||(i.widget[U]=()=>Ue.call(this,s)),this.widgets?.find(r=>r.name===s)||this.removeInput(this.inputs.findIndex(r=>r===i))}}}),n.prototype.onConfigure=de(n.prototype.onConfigure,function(){if(!t.configuringGraph&&this.inputs){for(const i of this.inputs)if(i.widget&&!i.widget[U]){const s=i.widget.name;i.widget[U]=()=>Ue.call(this,s)}}});const o=n.prototype.onInputDblClick;n.prototype.onInputDblClick=function(...[i,...s]){const a=o?.apply(this,[i,...s]),r=this.inputs[i];if(!r.widget&&!(r.type in $)&&!(r.widget?.[U]?.()?.[0]instanceof Array))return a;const l=k.createNode("PrimitiveNode"),d=t.canvas.graph;if(!l||!d)return a;d?.add(l);const c=[this.pos[0]-l.size[0]-30,this.pos[1]];for(;d.getNodeOnPos(c[0],c[1],d.nodes);)c[1]+=k.NODE_TITLE_HEIGHT;return l.pos=c,l.connect(0,this,i),l.title=r.name,a}},registerCustomNodes(){k.registerNodeType("PrimitiveNode",Object.assign(_e,{title:"Primitive"})),_e.category="utils"}});window.comfyAPI=window.comfyAPI||{};window.comfyAPI.widgetInputs=window.comfyAPI.widgetInputs||{};window.comfyAPI.widgetInputs.PrimitiveNode=_e;window.comfyAPI.widgetInputs.getWidgetConfig=Me;window.comfyAPI.widgetInputs.convertToInput=Ht;window.comfyAPI.widgetInputs.setWidgetConfig=ke;window.comfyAPI.widgetInputs.mergeIfValid=ae;const X={InUse:{Free:0,Registered:1,InWorkflow:2},isInUseGroupNode(n){const e=`${R}${L}${n}`;return g.graph.extra?.groupNodes?.[n]?g.graph.nodes.find(t=>t.type===e)?X.InUse.InWorkflow:X.InUse.Registered:X.InUse.Free},storeGroupNode(n,e){let t=g.graph.extra;t||(g.graph.extra=t={});let o=t.groupNodes;o||(t.groupNodes=o={}),o[n]=e}};class Ge{static{u(this,"GroupNodeBuilder")}nodes;nodeData;constructor(e){this.nodes=e}async build(){const e=await this.getName();if(e)return this.sortNodes(),this.nodeData=this.getNodeData(),X.storeGroupNode(e,this.nodeData),{name:e,nodeData:this.nodeData}}async getName(){const e=await ee().prompt({title:x("groupNode.create"),message:x("groupNode.enterName"),defaultValue:""});if(!e)return;switch(X.isInUseGroupNode(e)){case X.InUse.InWorkflow:S().addAlert("An in use group node with this name already exists embedded in this workflow, please remove any instances or use a new name.");return;case X.InUse.Registered:if(!confirm("A group node with this name already exists embedded in this workflow, are you sure you want to overwrite it?"))return;break}return e}sortNodes(){const e=g.graph.computeExecutionOrder(!1);this.nodes=this.nodes.map(t=>({index:e.indexOf(t),node:t})).sort((t,o)=>t.index-o.index||t.node.id-o.node.id).map(({node:t})=>t)}getNodeData(){const e=u(o=>{for(const i of o.links){const a=g.graph.getNodeById(i[4]).outputs[i[1]].type;i.push(a)}},"storeLinkTypes"),t=u(o=>{o.external=[];for(let i=0;i<this.nodes.length;i++){const s=this.nodes[i];if(s.outputs?.length)for(let a=0;a<s.outputs.length;a++){let r=!1;const l=s.outputs[a];let d=l.type;if(l.links?.length){for(const c of l.links){const h=g.graph.links[c];if(h&&(d==="*"&&(d=h.type),!g.canvas.selected_nodes[h.target_id])){r=!0;break}}r&&o.external.push([i,a,d])}}}},"storeExternalLinks");try{const o=xt(this.nodes,g.canvas?.graph),i=JSON.parse(o);return e(i),t(i),i}finally{}}}class H{static{u(this,"GroupNodeConfig")}name;nodeData;inputCount;oldToNewOutputMap;newToOldOutputMap;oldToNewInputMap;oldToNewWidgetMap;newToOldWidgetMap;primitiveDefs;widgetToPrimitive;primitiveToWidget;nodeInputs;outputVisibility;nodeDef;inputs;linksFrom;linksTo;externalFrom;constructor(e,t){this.name=e,this.nodeData=t,this.getLinks(),this.inputCount=0,this.oldToNewOutputMap={},this.newToOldOutputMap={},this.oldToNewInputMap={},this.oldToNewWidgetMap={},this.newToOldWidgetMap={},this.primitiveDefs={},this.widgetToPrimitive={},this.primitiveToWidget={},this.nodeInputs={},this.outputVisibility=[]}async registerType(e=R){this.nodeDef={output:[],output_name:[],output_is_list:[],output_is_hidden:[],name:e+L+this.name,display_name:this.name,category:"group nodes"+(L+e),input:{required:{}},description:`Group node combining ${this.nodeData.nodes.map(i=>i.type).join(", ")}`,python_module:"custom_nodes."+this.name,[F]:this},this.inputs=[];const t={},o={};for(let i=0;i<this.nodeData.nodes.length;i++){const s=this.nodeData.nodes[i];s.index=i,this.processNode(s,t,o)}for(const i of this.#e)i();this.#e=null,await g.registerNodeDef(`${R}${L}`+this.name,this.nodeDef),_t().addNodeDef(this.nodeDef)}getLinks(){this.linksFrom={},this.linksTo={},this.externalFrom={};for(const e of this.nodeData.links){const[t,o,i,s]=e;t!=null&&(this.linksFrom[t]||(this.linksFrom[t]={}),this.linksFrom[t][o]||(this.linksFrom[t][o]=[]),this.linksFrom[t][o].push(e),this.linksTo[i]||(this.linksTo[i]={}),this.linksTo[i][s]=e)}if(this.nodeData.external)for(const e of this.nodeData.external)this.externalFrom[e[0]]?this.externalFrom[e[0]][e[1]]=e[2]:this.externalFrom[e[0]]={[e[1]]:e[2]}}processNode(e,t,o){const i=this.getNodeDef(e);if(!i)return;const s={...i.input?.required,...i.input?.optional};this.inputs.push(this.processNodeInputs(e,t,s)),i.output?.length&&this.processNodeOutputs(e,o,i)}getNodeDef(e){const t=oe[e.type];if(t)return t;const o=this.linksFrom[e.index];if(e.type==="PrimitiveNode"){if(!o)return;let i=o[0][0][5];if(i==="COMBO"){const a=e.outputs[0].widget.name,r=this.nodeData.nodes[o[0][0][2]].type,l=oe[r];i=(l.input.required[a]??l.input.optional[a])[0]}return this.primitiveDefs[e.index]={input:{required:{value:[i,{}]}},output:[i],output_name:[],output_is_list:[]}}else if(e.type==="Reroute"){const i=this.linksTo[e.index];if(i&&o&&!this.externalFrom[e.index]?.[0])return null;let s={},a="*";if(o)for(const[,,r,l]of o[0]){const d=this.nodeData.nodes[r],c=d.inputs[l];if(a==="*"&&(a=c.type),c.widget){const h=oe[d.type],w=h.input.required[c.widget.name]??h.input.optional[c.widget.name],p=[w[0],s];s=ae({widget:p},w,!1,null,p)?.customConfig??s}}else if(i){const[r,l]=i[0];a=this.nodeData.nodes[r].outputs[l].type}else{for(const r of this.nodeData.links)if(r[2]===e.index){a=r[5];break}if(a==="*"){const r=this.externalFrom[e.index]?.[0];r&&(a=r)}}return s.forceInput=!0,{input:{required:{[a]:[a,s]}},output:[a],output_name:[],output_is_list:[]}}console.warn("Skipping virtual node "+e.type+" when building group node "+this.name)}getInputConfig(e,t,o,i,s){const a=this.nodeData.config?.[e.index]?.input?.[t];let r=a?.name??e.inputs?.find(c=>c.name===t)?.label??t,l=r,d="";return(e.type==="PrimitiveNode"&&e.title||r in o)&&(d=`${e.title??e.type} `,l=r=`${d}${t}`,r in o&&(r=`${d}${o[r]} ${t}`)),o[l]=(o[l]??1)+1,(t==="seed"||t==="noise_seed")&&(s||(s={}),s.control_after_generate=`${d}control_after_generate`),i[0]==="IMAGEUPLOAD"&&(s||(s={}),s.widget=this.oldToNewWidgetMap[e.index]?.[i[1]?.widget??"image"]??"image"),s&&(i=[i[0],{...i[1],...s}]),{name:r,config:i,customConfig:a}}processWidgetInputs(e,t,o,i){const s=[],a=new Map,r=this.oldToNewWidgetMap[t.index]={};for(const l of o)if(kt().inputIsWidget(e[l])){const d=t.inputs?.findIndex(c=>c.name===l&&c.widget?.name===l);if(d>-1)a.set(d,l),r[l]=null;else{const{name:c,config:h}=this.getInputConfig(t,l,i,e[l]);this.nodeDef.input.required[c]=h,r[l]=c,this.newToOldWidgetMap[c]={node:t,inputName:l}}}else s.push(l);return{converted:a,slots:s}}checkPrimitiveConnection(e,t,o){if(this.nodeData.nodes[e[0]].type==="PrimitiveNode"){const[s,a,r,l]=e,d=this.primitiveDefs[s],c=o[t],h=d.input.required.value,p=ae({widget:h},c,!1,null,h);h[1]=p?.customConfig??o[t][1]?{...o[t][1]}:{};let m=this.oldToNewWidgetMap[s].value;m=m.substr(0,m.length-6),h[1].control_after_generate=!0,h[1].control_prefix=m;let f=this.widgetToPrimitive[r];f||(f=this.widgetToPrimitive[r]={}),f[t]&&f[t].push(s),f[t]=s;let y=this.primitiveToWidget[s];y||(y=this.primitiveToWidget[s]=[]),y.push({nodeId:r,inputName:t})}}processInputSlots(e,t,o,i,s,a){this.nodeInputs[t.index]={};for(let r=0;r<o.length;r++){const l=o[r];if(i[r]){this.checkPrimitiveConnection(i[r],l,e);continue}const{name:d,config:c,customConfig:h}=this.getInputConfig(t,l,a,e[l]);this.nodeInputs[t.index][l]=d,h?.visible!==!1&&(this.nodeDef.input.required[d]=c,s[r]=this.inputCount++)}}processConvertedWidgets(e,t,o,i,s,a,r){const l=[...i.keys()].sort().map(d=>i.get(d));for(let d=0;d<l.length;d++){const c=l[d];if(s[o.length+d]){this.checkPrimitiveConnection(s[o.length+d],c,e);continue}const{name:h,config:w}=this.getInputConfig(t,c,r,e[c],{defaultInput:!0});this.nodeDef.input.required[h]=w,this.newToOldWidgetMap[h]={node:t,inputName:c},this.oldToNewWidgetMap[t.index]||(this.oldToNewWidgetMap[t.index]={}),this.oldToNewWidgetMap[t.index][c]=h,a[o.length+d]=this.inputCount++}}#e=[];processNodeInputs(e,t,o){const i=[],s=Object.keys(o);if(!s.length)return;const{converted:a,slots:r}=this.processWidgetInputs(o,e,s,t),l=this.linksTo[e.index]??{},d=this.oldToNewInputMap[e.index]={};return this.processInputSlots(o,e,r,l,d,t),this.#e.push(()=>this.processConvertedWidgets(o,e,r,a,l,d,t)),i}processNodeOutputs(e,t,o){const i=this.oldToNewOutputMap[e.index]={};for(let s=0;s<o.output.length;s++){const r=this.linksFrom[e.index]?.[s]&&!this.externalFrom[e.index]?.[s],l=this.nodeData.config?.[e.index]?.output?.[s],d=l?.visible??!r;if(this.outputVisibility.push(d),!d)continue;i[s]=this.nodeDef.output.length,this.newToOldOutputMap[this.nodeDef.output.length]={node:e,slot:s},this.nodeDef.output.push(o.output[s]),this.nodeDef.output_is_list.push(o.output_is_list[s]);let c=l?.name;if(!c){c=o.output_name?.[s]??o.output[s];const w=e.outputs.find(p=>p.name===c);w?.label&&(c=w.label)}let h=c;if(h in t){const w=`${e.title??e.type} `;h=`${w}${c}`,h in t&&(h=`${w}${e.index} ${c}`)}t[h]=1,this.nodeDef.output_name.push(h)}}static async registerFromWorkflow(e,t){for(const o in e){const i=e[o];let s=!1;for(const r of i.nodes)r.type in k.registered_node_types||(t.push({type:r.type,hint:` (In group node '${R}${L}${o}')`}),t.push({type:`${R}${L}`+o,action:{text:"Remove from workflow",callback:u(l=>{delete e[o],l.target.textContent="Removed",l.target.style.pointerEvents="none",l.target.style.opacity=.7},"callback")}}),s=!0);if(s)continue;await new H(o,i).registerType()}}}class G{static{u(this,"GroupNodeHandler")}node;groupData;innerNodes;constructor(e){this.node=e,this.groupData=e.constructor?.nodeData?.[F],this.node.setInnerNodes=p=>{this.innerNodes=p;for(let m=0;m<this.innerNodes.length;m++){const f=this.innerNodes[m];f.graph??=this.node.graph;for(const y of f.widgets??[])y.type==="converted-widget"&&(y.serializeValue=y.origSerializeValue);f.index=m,f.getInputNode=y=>{const b=this.groupData.oldToNewInputMap[f.index]?.[y];if(b!=null)return this.node.getInputNode(b);const v=this.groupData.linksTo[f.index]?.[y];if(!v)return null;const _=p[v[0]];return _.type==="PrimitiveNode"?null:_},f.getInputLink=y=>{const b=this.groupData.oldToNewInputMap[f.index]?.[y];if(b!=null){const _=this.node.inputs[b].link;let I=g.graph.links[_];return I={...I,target_id:f.id,target_slot:+y},I}let v=this.groupData.linksTo[f.index]?.[y];return v?(v={origin_id:p[v[0]].id,origin_slot:v[1],target_id:f.id,target_slot:+y},v):null}}},this.node.updateLink=p=>{p={...p};const m=this.groupData.newToOldOutputMap[p.origin_slot];let f=this.innerNodes[m.node.index],y;for(;f?.type==="Reroute";)y=f.getInputLink(0),f=f.getInputNode(0);return f?y&&G.isGroupNode(f)?f.updateLink(y):(p.origin_id=f.id,p.origin_slot=y?.origin_slot??m.slot,p):null},this.node.getInnerNodes=(p,m=[],f=[],y=new Set)=>{if(y.has(this.node))throw new Error("RecursionError: while flattening subgraph");y.add(this.node),this.innerNodes||this.node.setInnerNodes(this.groupData.nodeData.nodes.map((_,I)=>{const D=k.createNode(_.type);return D.configure(_),D.id=`${this.node.id}:${I}`,D.graph=this.node.graph,D})),this.updateInnerWidgets();const b=[...m,this.node.id],v=this.node.graph?.getNodeById(m.at(-1))??void 0;for(const _ of this.innerNodes){_.graph??=this.node.graph;const I=String(_.id);_.id=I.split(":").at(-1);const D=new Vt(_,b,p,v);_.id=I,D.groupNodeHandler=this,f.push(D)}return f},this.node.recreate=async()=>{const p=this.node.id,m=this.node.size,f=this.node.convertToNodes(),y=k.createNode(this.node.type);y.id=p,y.setInnerNodes(f),y[F].populateWidgets(),g.graph.add(y),y.setSize([Math.max(y.size[0],m[0]),Math.max(y.size[1],m[1])]);const v=new Ge(f).getNodeData();return y[F].groupData.nodeData.links=v.links,y[F].replaceNodes(f),y},this.node.convertToNodes=()=>{const p=u(()=>{const y={...this.groupData.nodeData};y.nodes=[...y.nodes];const b=this.node.getInnerNodes();let v=[];for(let P=0;P<y.nodes.length;P++){let K=b?.[P]?.id;K==null||isNaN(K)?K=void 0:v.push(K),y.nodes[P]={...y.nodes[P],id:K}}Qe(JSON.stringify(y),g.canvas);const[_,I]=this.node.pos;let D,E;const O=v.length?v:Object.keys(g.canvas.selected_nodes),Y=[];for(let P=0;P<O.length;P++){const K=O[P],j=g.graph.getNodeById(K),Oe=b[P];if(Y.push(j),(E==null||j.pos[0]<E)&&(E=j.pos[0]),(D==null||j.pos[1]<D)&&(D=j.pos[1]),!j.widgets)continue;const ge=this.groupData.oldToNewWidgetMap[Oe.index];if(ge){const nt=Object.keys(ge);for(const Pe of nt){const Le=ge[Pe];if(!Le)continue;const me=this.node.widgets.findIndex(z=>z.name===Le);if(me!==-1)if(Oe.type==="PrimitiveNode")for(let z=0;z<j.widgets.length;z++)j.widgets[z].value=this.node.widgets[me+z].value;else{const z=this.node.widgets[me],fe=j.widgets.find(J=>J.name===Pe);if(!fe)continue;fe.value=z.value;for(let J=0;J<z.linkedWidgets?.length;J++)fe.linkedWidgets[J].value=z.linkedWidgets[J].value}}}}for(const P of Y)P.pos[0]-=E-_,P.pos[1]-=D-I;return{newNodes:Y,selectedIds:O}},"addInnerNodes"),m=u(y=>{for(const b in this.groupData.oldToNewInputMap){const v=y[b],_=g.graph.getNodeById(v),I=this.groupData.oldToNewInputMap[b];for(const D in I){const E=I[D];if(E==null)continue;const O=e.inputs[E];if(O.link==null)continue;const Y=g.graph.links[O.link];if(!Y)continue;g.graph.getNodeById(Y.origin_id).connect(Y.origin_slot,_,+D)}}},"reconnectInputs"),f=u(y=>{for(let b=0;b<e.outputs?.length;b++){const v=e.outputs[b];if(!v.links)continue;const _=[...v.links];for(const I of _){const D=this.groupData.newToOldOutputMap[b],E=g.graph.links[I],O=g.graph.getNodeById(E.target_id);g.graph.getNodeById(y[D.node.index]).connect(D.slot,O,E.target_slot)}}},"reconnectOutputs");g.canvas.emitBeforeChange();try{const{newNodes:y,selectedIds:b}=p();return m(b),f(b),g.graph.remove(this.node),y}finally{g.canvas.emitAfterChange()}};const t=this.node.getExtraMenuOptions;this.node.getExtraMenuOptions=function(p,m){t?.apply(this,arguments);let f=m.findIndex(y=>y?.content==="Outputs");f===-1?f=m.length:f++,m.splice(f,0,null,{content:"Convert to nodes",callback:u(()=>this.convertToNodes(),"callback")},{content:"Manage Group Node",callback:u(()=>Ne(this.type),"callback")})};const o=this.node.onDrawTitleBox;this.node.onDrawTitleBox=function(p,m){o?.apply(this,arguments);const f=p.fillStyle;p.beginPath(),p.rect(11,-m+11,2,2),p.rect(14,-m+11,2,2),p.rect(17,-m+11,2,2),p.rect(11,-m+14,2,2),p.rect(14,-m+14,2,2),p.rect(17,-m+14,2,2),p.rect(11,-m+17,2,2),p.rect(14,-m+17,2,2),p.rect(17,-m+17,2,2),p.fillStyle=this.boxcolor||k.NODE_DEFAULT_BOXCOLOR,p.fill(),p.fillStyle=f};const i=e.onDrawForeground,s=this.groupData.nodeData;e.onDrawForeground=function(p){i?.apply?.(this,arguments);const m=Nt().nodeProgressStates[this.id];if(m&&m.state==="running"&&this.runningInternalNodeId!==null){const f=s.nodes[this.runningInternalNodeId];if(!f)return;const y=`Running ${f.title||f.type} (${this.runningInternalNodeId}/${s.nodes.length})`;p.save(),p.font="12px sans-serif";const b=p.measureText(y);p.fillStyle=e.boxcolor||k.NODE_DEFAULT_BOXCOLOR,p.beginPath(),p.roundRect(0,-k.NODE_TITLE_HEIGHT-20,b.width+12,20,5),p.fill(),p.fillStyle="#fff",p.fillText(y,6,-k.NODE_TITLE_HEIGHT-6),p.restore()}};const a=this.node.onExecutionStart;this.node.onExecutionStart=function(){return this.resetExecution=!0,a?.apply(this,arguments)};const r=this,l=this.node.onNodeCreated;this.node.onNodeCreated=function(){if(!this.widgets)return;const p=r.groupData.nodeData.config;if(p)for(const m in p){const f=p[m]?.input;for(const y in f){if(f[y].visible!==!1)continue;const b=r.groupData.oldToNewWidgetMap[m][y],v=this.widgets.find(_=>_.name===b);v&&(v.type="hidden",v.computeSize=()=>[0,-4])}}return l?.apply(this,arguments)};function d(p,m,f){const y=u(({detail:b})=>{const v=m(b);if(!v||g.graph.getNodeById(v))return;const I=this.innerNodes?.findIndex(D=>D.id==v);I>-1&&(this.node.runningInternalNodeId=I,A.dispatchCustomEvent(p,f(b,`${this.node.id}`,this.node)))},"handler");return A.addEventListener(p,y),y}u(d,"handleEvent");const c=d.call(this,"executing",p=>p,(p,m)=>m),h=d.call(this,"executed",p=>p?.display_node||p?.node,(p,m,f)=>({...p,node:m,display_node:m,merge:!f.resetExecution})),w=e.onRemoved;this.node.onRemoved=function(){w?.apply(this,arguments),A.removeEventListener("executing",c),A.removeEventListener("executed",h)},this.node.refreshComboInNode=p=>{for(const m in this.groupData.newToOldWidgetMap){const f=this.node.widgets.find(y=>y.name===m);if(f?.type==="combo"){const y=this.groupData.newToOldWidgetMap[m],b=p[y.node.type],v=b?.input?.required?.[y.inputName]??b?.input?.optional?.[y.inputName];if(!v)continue;f.options.values=v[0],y.inputName!=="image"&&!f.options.values.includes(f.value)&&(f.value=f.options.values[0],f.callback(f.value))}}}}updateInnerWidgets(){for(const e in this.groupData.newToOldWidgetMap){const t=this.node.widgets.find(r=>r.name===e);if(!t)continue;const o=t.value,i=this.groupData.newToOldWidgetMap[e];let s=this.innerNodes[i.node.index];if(s.type==="PrimitiveNode"){s.primitiveValue=o;const r=this.groupData.primitiveToWidget[i.node.index];for(const l of r??[]){const c=this.innerNodes[l.nodeId].widgets.find(h=>h.name===l.inputName);c&&(c.value=o)}continue}else if(s.type==="Reroute"){const r=this.groupData.linksFrom[i.node.index];if(r)for(const[l,,d,c]of r[0]){const h=this.innerNodes[d],w=h.inputs[c];if(w.widget){const p=h.widgets?.find(m=>m.name===w.widget.name);p&&(p.value=o)}}}const a=s.widgets?.find(r=>r.name===i.inputName);a&&(a.value=o)}}populatePrimitive(e,t,o){const i=this.groupData.widgetToPrimitive[t]?.[o];if(i==null)return;const s=this.groupData.oldToNewWidgetMap[i].value,a=this.node.widgets.findIndex(r=>r.name===s);if(a>-1){const r=this.innerNodes[i];let l=r.widgets.length;l-1!==this.node.widgets[a].linkedWidgets?.length&&(l=1);for(let d=0;d<l;d++)this.node.widgets[a+d].value=r.widgets[d].value}return!0}populateReroute(e,t,o){if(e.type!=="Reroute")return;const i=this.groupData.linksFrom[t]?.[0]?.[0];if(!i)return;const[,,s,a]=i,r=this.groupData.nodeData.nodes[s],l=r.inputs;if(!l?.[a]?.widget)return;const c=l.length-(r.widgets_values?.length??0),h=r.widgets_values?.[a-c];if(h==null)return;const w=Object.values(o)[0],p=this.node.widgets.find(m=>m.name===w);p&&(p.value=h)}populateWidgets(){if(this.node.widgets)for(let e=0;e<this.groupData.nodeData.nodes.length;e++){const t=this.groupData.nodeData.nodes[e],o=this.groupData.oldToNewWidgetMap[e]??{},i=Object.keys(o);if(!t.widgets_values?.length){this.populateReroute(t,e,o);continue}let s=0;for(let a=0;a<i.length;a++){const r=i[a],l=o[r],d=this.node.widgets.findIndex(h=>h.name===l),c=this.node.widgets[d];if(this.populatePrimitive(t,e,r)||d===-1){const h=this.innerNodes[e].widgets?.find(w=>w.name===r);s+=h?.linkedWidgets?.length??0}if(d!==-1){c.value=t.widgets_values[a+s];for(let h=0;h<c.linkedWidgets?.length;h++)this.node.widgets[d+h+1].value=t.widgets_values[a+ ++s]}}}}replaceNodes(e){let t,o;for(let i=0;i<e.length;i++){const s=e[i];(o==null||s.pos[0]<o)&&(o=s.pos[0]),(t==null||s.pos[1]<t)&&(t=s.pos[1]),this.linkOutputs(s,i),g.graph.remove(s),s.id=`${this.node.id}:${i}`}this.linkInputs(),this.node.pos=[o,t]}linkOutputs(e,t){if(e.outputs)for(const o of e.outputs){if(!o.links)continue;const i=[...o.links];for(const s of i){const a=g.graph.links[s];if(!a)continue;const r=g.graph.getNodeById(a.target_id),l=this.groupData.oldToNewOutputMap[t]?.[a.origin_slot];l!=null&&this.node.connect(l,r,a.target_slot)}}}linkInputs(){for(const e of this.groupData.nodeData.links??[]){const[,t,o,i,s]=e,a=g.graph.getNodeById(s);a&&a.connect(t,this.node.id,this.groupData.oldToNewInputMap[o][i])}}static getGroupData(e){return(e.nodeData??e.constructor?.nodeData)?.[F]}static isGroupNode(e){return!!e.constructor?.nodeData?.[F]}static async fromNodes(e){const t=new Ge(e),o=await t.build();if(!o)return;const{name:i,nodeData:s}=o;await new H(i,s).registerType();const r=k.createNode(`${R}${L}${i}`);return r.setInnerNodes(t.nodes),r[F].populateWidgets(),g.graph.add(r),r[F].replaceNodes(t.nodes),r}}const Jt=u(n=>{for(const e of n)typeof e.type=="string"&&e.type.startsWith("workflow/")&&(e.type=e.type.replace(/^workflow\//,`${R}${L}`))},"replaceLegacySeparators");async function ve(){const n=Object.values(g.canvas.selected_nodes??{});if(n.length===0)throw new Error("No nodes selected");if(n.length===1)throw new Error("Please select multiple nodes to convert to group node");for(const e of n){if(e instanceof It)throw new Error("Selected nodes contain a subgraph node");if(G.isGroupNode(e))throw new Error("Selected nodes contain a group node")}return await G.fromNodes(n)}u(ve,"convertSelectedNodesToGroupNode");const ze=u(n=>n.length<2||!!n.find(e=>G.isGroupNode(e)),"convertDisabled");function Zt(){const n=Object.values(g.canvas.selected_nodes??{});for(const e of n)G.isGroupNode(e)&&e.convertToNodes?.()}u(Zt,"ungroupSelectedGroupNodes");function Ne(n){new it(g).show(n)}u(Ne,"manageGroupNodes");const Qt="Comfy.GroupNode";let oe;const eo={name:Qt,commands:[{id:"Comfy.GroupNode.ConvertSelectedNodesToGroupNode",label:"Convert selected nodes to group node",icon:"pi pi-sitemap",versionAdded:"1.3.17",function:u(()=>ve(),"function")},{id:"Comfy.GroupNode.UngroupSelectedGroupNodes",label:"Ungroup selected group nodes",icon:"pi pi-sitemap",versionAdded:"1.3.17",function:u(()=>Zt(),"function")},{id:"Comfy.GroupNode.ManageGroupNodes",label:"Manage group nodes",icon:"pi pi-cog",versionAdded:"1.3.17",function:u((...n)=>Ne(n[0]),"function")}],keybindings:[{commandId:"Comfy.GroupNode.ConvertSelectedNodesToGroupNode",combo:{alt:!0,key:"g"}},{commandId:"Comfy.GroupNode.UngroupSelectedGroupNodes",combo:{alt:!0,shift:!0,key:"G"}}],getCanvasMenuItems(n){const e=[],t=Object.values(n.selected_nodes??{}),o=!ze(t);e.push({content:"Convert to Group Node (Deprecated)",disabled:!o,callback:u(()=>ve(),"callback")});const i=n.graph?.extra?.groupNodes,s=!i||!Object.keys(i).length;return e.push({content:"Manage Group Nodes",disabled:s,callback:u(()=>Ne(),"callback")}),e},getNodeMenuItems(n){if(G.isGroupNode(n))return[];const e=Object.values(g.canvas.selected_nodes??{});return[{content:"Convert to Group Node (Deprecated)",disabled:!!ze(e),callback:u(()=>ve(),"callback")}]},async beforeConfigureGraph(n,e){const t=n?.extra?.groupNodes;t&&(Jt(n.nodes),await H.registerFromWorkflow(t,e))},addCustomNodeDefs(n){oe=n},nodeCreated(n){G.isGroupNode(n)&&(n[F]=new G(n),n.title&&n[F]?.groupData?.nodeData&&X.storeGroupNode(n.title,n[F].groupData.nodeData))},async refreshComboInNodes(n){Object.assign(oe,n);const e=g.graph.extra?.groupNodes;e&&await H.registerFromWorkflow(e,{})}};g.registerExtension(eo);window.comfyAPI=window.comfyAPI||{};window.comfyAPI.groupNode=window.comfyAPI.groupNode||{};window.comfyAPI.groupNode.GroupNodeConfig=H;window.comfyAPI.groupNode.GroupNodeHandler=G;function W(n,e){n.mode=e,n.graph?.change()}u(W,"setNodeMode");function Ve(n,e){const t=Q().get("Comfy.GroupSelectedNodes.Padding");n.resizeTo([...n.children,...e],t)}u(Ve,"addNodesToGroup");const to={name:"Comfy.GroupOptions",getCanvasMenuItems(n){const e=[],t=n.graph.getGroupOnPos(n.graph_mouse[0],n.graph_mouse[1]);if(!t)return n.selectedItems.size>0&&e.push({content:"Add Group For Selected Nodes",callback:u(()=>{const s=new Dt;Ve(s,n.selectedItems),n.graph.add(s),n.graph.change(),s.recomputeInsideNodes()},"callback")}),e;t.recomputeInsideNodes();const o=t.nodes;if(e.push({content:"Add Selected Nodes To Group",disabled:!n.selectedItems?.size,callback:u(()=>{Ve(t,n.selectedItems),n.graph.change()},"callback")}),o.length===0)return e;e.push(null);let i=!0;for(let s=1;s<o.length;s++)if(o[s].mode!==o[0].mode){i=!1;break}if(e.push({content:"Fit Group To Nodes",callback:u(()=>{t.recomputeInsideNodes();const s=Q().get("Comfy.GroupSelectedNodes.Padding");t.resizeTo(t.children,s),n.graph.change()},"callback")}),e.push({content:"Select Nodes",callback:u(()=>{n.selectNodes(o),n.graph.change(),n.canvas.focus()},"callback")}),i)switch(o[0].mode){case 0:e.push({content:"Set Group Nodes to Never",callback:u(()=>{for(const a of o)W(a,2)},"callback")}),e.push({content:"Bypass Group Nodes",callback:u(()=>{for(const a of o)W(a,4)},"callback")});break;case 2:e.push({content:"Set Group Nodes to Always",callback:u(()=>{for(const a of o)W(a,0)},"callback")}),e.push({content:"Bypass Group Nodes",callback:u(()=>{for(const a of o)W(a,4)},"callback")});break;case 4:e.push({content:"Set Group Nodes to Always",callback:u(()=>{for(const a of o)W(a,0)},"callback")}),e.push({content:"Set Group Nodes to Never",callback:u(()=>{for(const a of o)W(a,2)},"callback")});break;default:e.push({content:"Set Group Nodes to Always",callback:u(()=>{for(const a of o)W(a,0)},"callback")}),e.push({content:"Set Group Nodes to Never",callback:u(()=>{for(const a of o)W(a,2)},"callback")}),e.push({content:"Bypass Group Nodes",callback:u(()=>{for(const a of o)W(a,4)},"callback")});break}else e.push({content:"Set Group Nodes to Always",callback:u(()=>{for(const s of o)W(s,0)},"callback")}),e.push({content:"Set Group Nodes to Never",callback:u(()=>{for(const s of o)W(s,2)},"callback")}),e.push({content:"Bypass Group Nodes",callback:u(()=>{for(const s of o)W(s,4)},"callback")});return e}};g.registerExtension(to);const oo=[{label:"GLB",value:"glb"},{label:"OBJ",value:"obj"},{label:"STL",value:"stl"}];function he(n){return[null,{content:"Save",has_submenu:!0,callback:u((e,t,o,i)=>{const s=oo.map(a=>({content:a.label,callback:u(()=>{(async()=>{try{await n.exportModel(a.value),S().add({severity:"success",summary:x("toastMessages.exportSuccess",{format:a.label})})}catch(r){console.error("Export failed:",r),S().addAlert(x("toastMessages.failedToExportModel",{format:a.label}))}})()},"callback")}));new k.ContextMenu(s,{event:o,parentMenu:i})},"callback")}]}u(he,"createExportMenuItems");window.comfyAPI=window.comfyAPI||{};window.comfyAPI.exportMenuHelper=window.comfyAPI.exportMenuHelper||{};window.comfyAPI.exportMenuHelper.createExportMenuItems=he;class Ae{static{u(this,"Load3DConfiguration")}constructor(e,t){this.load3d=e,this.properties=t}configureForSaveMesh(e,t){this.setupModelHandlingForSaveMesh(t,e),this.setupDefaultProperties()}configure(e){this.setupModelHandling(e.modelWidget,e.loadFolder,e.cameraState),this.setupTargetSize(e.width,e.height),this.setupDefaultProperties(e.bgImagePath)}setupTargetSize(e,t){e&&t&&(this.load3d.setTargetSize(e.value,t.value),e.callback=o=>{this.load3d.setTargetSize(o,t.value)},t.callback=o=>{this.load3d.setTargetSize(e.value,o)})}setupModelHandlingForSaveMesh(e,t){const o=this.createModelUpdateHandler(t);e&&o(e)}setupModelHandling(e,t,o){const i=this.createModelUpdateHandler(t,o);e.value&&i(e.value);const s=e.callback;let a=e.value;Object.defineProperty(e,"value",{get(){return a},set(r){a=r,e.callback&&r!==void 0&&r!==""&&e.callback(r)},enumerable:!0,configurable:!0}),e.callback=r=>{i(r),s&&s(r)}}setupDefaultProperties(e){const t=this.loadSceneConfig();this.applySceneConfig(t,e);const o=this.loadCameraConfig();this.applyCameraConfig(o);const i=this.loadLightConfig();this.applyLightConfig(i)}loadSceneConfig(){return this.properties&&"Scene Config"in this.properties?this.properties["Scene Config"]:{showGrid:Q().get("Comfy.Load3D.ShowGrid"),backgroundColor:"#"+Q().get("Comfy.Load3D.BackgroundColor"),backgroundImage:""}}loadCameraConfig(){return this.properties&&"Camera Config"in this.properties?this.properties["Camera Config"]:{cameraType:Q().get("Comfy.Load3D.CameraType"),fov:35}}loadLightConfig(){return this.properties&&"Light Config"in this.properties?this.properties["Light Config"]:{intensity:Q().get("Comfy.Load3D.LightIntensity")}}loadModelConfig(){return this.properties&&"Model Config"in this.properties?this.properties["Model Config"]:{upDirection:"original",materialMode:"original"}}applySceneConfig(e,t){if(this.load3d.toggleGrid(e.showGrid),this.load3d.setBackgroundColor(e.backgroundColor),e.backgroundImage){if(t&&t!=e.backgroundImage)return;this.load3d.setBackgroundImage(e.backgroundImage),e.backgroundRenderMode&&this.load3d.setBackgroundRenderMode(e.backgroundRenderMode)}}applyCameraConfig(e){this.load3d.toggleCamera(e.cameraType),this.load3d.setFOV(e.fov),e.state&&this.load3d.setCameraState(e.state)}applyLightConfig(e){this.load3d.setLightIntensity(e.intensity)}applyModelConfig(e){this.load3d.setUpDirection(e.upDirection),this.load3d.setMaterialMode(e.materialMode)}createModelUpdateHandler(e,t){let o=!0;return async i=>{if(!i)return;const s=i;this.setResourceFolder(s);const a=A.apiURL(V.getResourceURL(...V.splitFilePath(s),e));await this.load3d.loadModel(a,s);const r=this.loadModelConfig();if(this.applyModelConfig(r),o&&t){try{this.load3d.setCameraState(t)}catch(l){console.warn("Failed to restore camera state:",l)}o=!1}}}setResourceFolder(e){const t=e.split("/").filter(s=>s.trim());if(t.length<=2)return;const i=t.slice(1,-1).join("/");i&&this.properties&&(this.properties["Resource Folder"]=i)}}const io={name:"image",type:"Load3D",isPreview:!1},$e={name:"image",type:"Preview3D",isPreview:!0};async function so(n,e){if(!n?.length)return;const t=e.widgets?.find(o=>o.name==="model_file");try{const o=e.properties["Resource Folder"]||"",i=o.trim()?`3d/${o.trim()}`:"3d",s=await V.uploadFile(n[0],i);if(!s){S().addAlert(x("toastMessages.fileUploadFailed"));return}const a=A.apiURL(V.getResourceURL(...V.splitFilePath(s),"input"));ne(e).waitForLoad3d(r=>{try{r.loadModel(a)}catch{S().addAlert(x("toastMessages.failedToLoadModel"))}}),s&&t&&(t.options?.values?.includes(s)||t.options?.values?.push(s),t.value=s)}catch(o){console.error("Model upload failed:",o),S().addAlert(x("toastMessages.fileUploadFailed"))}}u(so,"handleModelUpload");async function no(n,e){if(n?.length)try{const t=e.properties["Resource Folder"]||"",o=t.trim()?`3d/${t.trim()}`:"3d";await V.uploadMultipleFiles(n,o)}catch(t){console.error("Extra resources upload failed:",t),S().addAlert(x("toastMessages.extraResourcesUploadFailed"))}}u(no,"handleResourcesUpload");function je(n,e=!1){const t=document.createElement("input");return t.type="file",t.accept=n,t.multiple=e,t.style.display="none",t}u(je,"createFileInput");re().registerExtension({name:"Comfy.Load3D",settings:[{id:"Comfy.Load3D.ShowGrid",category:["3D","Scene","Initial Grid Visibility"],name:"Initial Grid Visibility",tooltip:"Controls whether the grid is visible by default when a new 3D widget is created. This default can still be toggled individually for each widget after creation.",type:"boolean",defaultValue:!0,experimental:!0},{id:"Comfy.Load3D.BackgroundColor",category:["3D","Scene","Initial Background Color"],name:"Initial Background Color",tooltip:"Controls the default background color of the 3D scene. This setting determines the background appearance when a new 3D widget is created, but can be adjusted individually for each widget after creation.",type:"color",defaultValue:"282828",experimental:!0},{id:"Comfy.Load3D.CameraType",category:["3D","Camera","Initial Camera Type"],name:"Initial Camera Type",tooltip:"Controls whether the camera is perspective or orthographic by default when a new 3D widget is created. This default can still be toggled individually for each widget after creation.",type:"combo",options:["perspective","orthographic"],defaultValue:"perspective",experimental:!0},{id:"Comfy.Load3D.LightIntensity",category:["3D","Light","Initial Light Intensity"],name:"Initial Light Intensity",tooltip:"Sets the default brightness level of lighting in the 3D scene. This value determines how intensely lights illuminate objects when a new 3D widget is created, but can be adjusted individually for each widget after creation.",type:"number",defaultValue:3,experimental:!0},{id:"Comfy.Load3D.LightIntensityMaximum",category:["3D","Light","Light Intensity Maximum"],name:"Light Intensity Maximum",tooltip:"Sets the maximum allowable light intensity value for 3D scenes. This defines the upper brightness limit that can be set when adjusting lighting in any 3D widget.",type:"number",defaultValue:10,experimental:!0},{id:"Comfy.Load3D.LightIntensityMinimum",category:["3D","Light","Light Intensity Minimum"],name:"Light Intensity Minimum",tooltip:"Sets the minimum allowable light intensity value for 3D scenes. This defines the lower brightness limit that can be set when adjusting lighting in any 3D widget.",type:"number",defaultValue:1,experimental:!0},{id:"Comfy.Load3D.LightAdjustmentIncrement",category:["3D","Light","Light Adjustment Increment"],name:"Light Adjustment Increment",tooltip:"Controls the increment size when adjusting light intensity in 3D scenes. A smaller step value allows for finer control over lighting adjustments, while a larger value results in more noticeable changes per adjustment.",type:"slider",attrs:{min:.1,max:1,step:.1},defaultValue:.5,experimental:!0},{id:"Comfy.Load3D.3DViewerEnable",category:["3D","3DViewer","Enable"],name:"Enable 3D Viewer (Beta)",tooltip:"Enables the 3D Viewer (Beta) for selected nodes. This feature allows you to visualize and interact with 3D models directly within the full size 3d viewer.",type:"boolean",defaultValue:!1,experimental:!0}],commands:[{id:"Comfy.3DViewer.Open3DViewer",icon:"pi pi-pencil",label:"Open 3D Viewer (Beta) for Selected Node",function:u(()=>{const n=g.canvas.selected_nodes;if(!n||Object.keys(n).length!==1)return;const e=n[Object.keys(n)[0]];if(!Tt(e))return;N.copyToClipspace(e),N.clipspace_return_node=e;const t={node:e};et().showDialog({key:"global-load3d-viewer",title:x("load3d.viewer.title"),component:Et,props:t,dialogComponentProps:{style:"width: 80vw; height: 80vh;",maximizable:!0,onClose:u(async()=>{await ue().handleViewerClose(t.node)},"onClose")}})},"function")}],getCustomWidgets(){return{LOAD_3D(n){const e=je(".gltf,.glb,.obj,.fbx,.stl",!1);n.properties["Resource Folder"]="",e.onchange=async()=>{await so(e.files,n)},n.addWidget("button","upload 3d model","upload3dmodel",()=>{e.click()});const t=je("*",!0);t.onchange=async()=>{await no(t.files,n),t.value=""},n.addWidget("button","upload extra resources","uploadExtraResources",()=>{t.click()}),n.addWidget("button","clear","clear",()=>{ne(n).waitForLoad3d(s=>{s.clearModel()});const i=n.widgets?.find(s=>s.name==="model_file");i&&(i.value="")});const o=new xe({node:n,name:"image",component:Ee,inputSpec:io,options:{}});return o.type="load3D",De(n,o),{widget:o}}}},getNodeMenuItems(n){if(n.constructor.comfyClass!=="Load3D")return[];const e=ue().getLoad3d(n);return e?he(e):[]},async nodeCreated(n){if(n.constructor.comfyClass!=="Load3D")return;const[e,t]=n.size;n.setSize([Math.max(e,300),Math.max(t,600)]),await Te(),ne(n).waitForLoad3d(o=>{const s=n.properties["Camera Config"]?.state,a=new Ae(o,n.properties),r=n.widgets?.find(h=>h.name==="model_file"),l=n.widgets?.find(h=>h.name==="width"),d=n.widgets?.find(h=>h.name==="height"),c=n.widgets?.find(h=>h.name==="image");if(r&&l&&d&&c){const h={loadFolder:"input",modelWidget:r,cameraState:s,width:l,height:d};a.configure(h),c.serializeValue=async()=>{const w=St.get(n);if(!w)return console.error("No load3d instance found for node"),null;const p=n.properties["Camera Config"]||{cameraType:w.getCurrentCameraType(),fov:w.cameraManager.perspectiveCamera.fov};p.state=w.getCameraState(),n.properties["Camera Config"]=p,w.stopRecording();const{scene:m,mask:f,normal:y}=await w.captureScene(l.value,d.value),[b,v,_]=await Promise.all([V.uploadTempImage(m,"scene"),V.uploadTempImage(f,"scene_mask"),V.uploadTempImage(y,"scene_normal")]);w.handleResize();const I={image:`threed/${b.name} [temp]`,mask:`threed/${v.name} [temp]`,normal:`threed/${_.name} [temp]`,camera_info:n.properties["Camera Config"]?.state||null,recording:""},D=w.getRecordingData();if(D){const[E]=await Promise.all([V.uploadTempImage(D,"recording","mp4")]);I.recording=`threed/${E.name} [temp]`}return I}}})}});re().registerExtension({name:"Comfy.Preview3D",async beforeRegisterNodeDef(n,e){e.name==="Preview3D"&&(e.input.required.image=["PREVIEW_3D"])},getNodeMenuItems(n){if(n.constructor.comfyClass!=="Preview3D")return[];const e=ue().getLoad3d(n);return e?he(e):[]},getCustomWidgets(){return{PREVIEW_3D(n){const e=new xe({node:n,name:$e.name,component:Ee,inputSpec:$e,options:{}});return e.type="load3D",De(n,e),{widget:e}}}},async nodeCreated(n){if(n.constructor.comfyClass!=="Preview3D")return;const[e,t]=n.size;n.setSize([Math.max(e,400),Math.max(t,550)]),await Te();const o=n.onExecuted;ne(n).waitForLoad3d(i=>{const s=new Ae(i,n.properties),a=n.widgets?.find(r=>r.name==="model_file");if(a){const r=n.properties["Last Time Model File"];if(r){a.value=r;const d=n.properties["Camera Config"]?.state,c={loadFolder:"output",modelWidget:a,cameraState:d};s.configure(c)}n.onExecuted=function(l){o?.apply(this,arguments);let d=l.result[0];if(!d){const p=x("toastMessages.unableToGetModelFilePath");console.error(p),S().addAlert(p)}let c=l.result[1],h=l.result[2];a.value=d.replaceAll("\\","/"),n.properties["Last Time Model File"]=a.value;const w={loadFolder:"output",modelWidget:a,cameraState:c,bgImagePath:h};s.configure(w),h&&i.setBackgroundImage(h)}}})}});function ao(n){const e=n.split(";base64,"),t=e[0].split(":")[1],o=atob(e[1]),i=new ArrayBuffer(o.length),s=new Uint8Array(i);for(let a=0;a<o.length;a++)s[a]=o.charCodeAt(a);return new Blob([i],{type:t})}u(ao,"dataURLToBlob");function ro(n){return new Promise(e=>{const t=new Image;t.onload=function(){e(t)},t.src=n})}u(ro,"loadImage");async function lo(n,e){await A.fetchApi("/upload/mask",{method:"POST",body:e}).catch(t=>{console.error("Error:",t)}),N.clipspace.imgs[N.clipspace.selectedIndex]=new Image,N.clipspace.imgs[N.clipspace.selectedIndex].src=A.apiURL("/view?"+new URLSearchParams(n).toString()+g.getPreviewFormatParam()+g.getRandParam()),N.clipspace.images&&(N.clipspace.images[N.clipspace.selectedIndex]=n),M.invalidatePreview()}u(lo,"uploadMask");function co(n,e,t,o){t.drawImage(n,0,0,e.width,e.height);const i=t.getImageData(0,0,e.width,e.height);for(let s=0;s<i.data.length;s+=4)i.data[s+3]==255?i.data[s+3]=0:i.data[s+3]=255,i.data[s]=o.r,i.data[s+1]=o.g,i.data[s+2]=o.b;t.globalCompositeOperation="source-over",t.putImageData(i,0,0)}u(co,"prepare_mask");class T extends Ie{static{u(this,"MaskEditorDialogOld")}static instance=null;static mousedown_x=null;static mousedown_y=null;brush;maskCtx;maskCanvas;brush_size_slider;brush_opacity_slider;colorButton;saveButton;zoom_ratio;pan_x;pan_y;imgCanvas;last_display_style;is_visible;image;handler_registered;brush_slider_input;cursorX;cursorY;mousedown_pan_x;mousedown_pan_y;last_pressure;pointer_type;brush_pointer_type_select;static getInstance(){return T.instance||(T.instance=new T),T.instance}is_layout_created=!1;constructor(){super(),this.element=C("div.comfy-modal",{parent:document.body},[C("div.comfy-modal-content",[...this.createButtons()])])}createButtons(){return[]}createButton(e,t){var o=document.createElement("button");return o.style.pointerEvents="auto",o.innerText=e,o.addEventListener("click",t),o}createLeftButton(e,t){var o=this.createButton(e,t);return o.style.cssFloat="left",o.style.marginRight="4px",o}createRightButton(e,t){var o=this.createButton(e,t);return o.style.cssFloat="right",o.style.marginLeft="4px",o}createLeftSlider(e,t,o){const i=document.createElement("div");i.id="maskeditor-slider",i.style.cssFloat="left",i.style.fontFamily="sans-serif",i.style.marginRight="4px",i.style.color="var(--input-text)",i.style.backgroundColor="var(--comfy-input-bg)",i.style.borderRadius="8px",i.style.borderColor="var(--border-color)",i.style.borderStyle="solid",i.style.fontSize="15px",i.style.height="25px",i.style.padding="1px 6px",i.style.display="flex",i.style.position="relative",i.style.top="2px",i.style.pointerEvents="auto",e.brush_slider_input=document.createElement("input"),e.brush_slider_input.setAttribute("type","range"),e.brush_slider_input.setAttribute("min","1"),e.brush_slider_input.setAttribute("max","100"),e.brush_slider_input.setAttribute("value","10");const s=document.createElement("label");return s.textContent=t,i.appendChild(s),i.appendChild(e.brush_slider_input),e.brush_slider_input.addEventListener("change",o),i}createOpacitySlider(e,t,o){const i=document.createElement("div");i.id="maskeditor-opacity-slider",i.style.cssFloat="left",i.style.fontFamily="sans-serif",i.style.marginRight="4px",i.style.color="var(--input-text)",i.style.backgroundColor="var(--comfy-input-bg)",i.style.borderRadius="8px",i.style.borderColor="var(--border-color)",i.style.borderStyle="solid",i.style.fontSize="15px",i.style.height="25px",i.style.padding="1px 6px",i.style.display="flex",i.style.position="relative",i.style.top="2px",i.style.pointerEvents="auto",e.opacity_slider_input=document.createElement("input"),e.opacity_slider_input.setAttribute("type","range"),e.opacity_slider_input.setAttribute("min","0.1"),e.opacity_slider_input.setAttribute("max","1.0"),e.opacity_slider_input.setAttribute("step","0.01"),e.opacity_slider_input.setAttribute("value","0.7");const s=document.createElement("label");return s.textContent=t,i.appendChild(s),i.appendChild(e.opacity_slider_input),e.opacity_slider_input.addEventListener("input",o),i}createPointerTypeSelect(e){const t=document.createElement("div");t.id="maskeditor-pointer-type",t.style.cssFloat="left",t.style.fontFamily="sans-serif",t.style.marginRight="4px",t.style.color="var(--input-text)",t.style.backgroundColor="var(--comfy-input-bg)",t.style.borderRadius="8px",t.style.borderColor="var(--border-color)",t.style.borderStyle="solid",t.style.fontSize="15px",t.style.height="25px",t.style.padding="1px 6px",t.style.display="flex",t.style.position="relative",t.style.top="2px",t.style.pointerEvents="auto";const o=document.createElement("label");o.textContent="Pointer Type:";const i=document.createElement("select");i.style.borderRadius="0",i.style.borderColor="transparent",i.style.borderStyle="unset",i.style.fontSize="0.9em";const s=document.createElement("option");s.value="arc",s.text="Circle",s.selected=!0;const a=document.createElement("option");return a.value="rect",a.text="Square",i.appendChild(s),i.appendChild(a),i.addEventListener("change",r=>{const l=r.target;e.pointer_type=l.value,this.setBrushBorderRadius(e)}),t.appendChild(o),t.appendChild(i),t}setBrushBorderRadius(e){e.pointer_type==="rect"?(this.brush.style.borderRadius="0%",this.brush.style.MozBorderRadius="0%",this.brush.style.WebkitBorderRadius="0%"):(this.brush.style.borderRadius="50%",this.brush.style.MozBorderRadius="50%",this.brush.style.WebkitBorderRadius="50%")}setlayout(e,t){const o=this;o.pointer_type="arc";var i=document.createElement("div");i.style.position="absolute",i.style.bottom="0px",i.style.left="20px",i.style.right="20px",i.style.height="50px",i.style.pointerEvents="none";var s=document.createElement("div");s.id="brush",s.style.backgroundColor="transparent",s.style.outline="1px dashed black",s.style.boxShadow="0 0 0 1px white",s.style.position="absolute",s.style.zIndex="8889",s.style.pointerEvents="none",this.brush=s,this.setBrushBorderRadius(o),this.element.appendChild(e),this.element.appendChild(t),this.element.appendChild(i),document.body.appendChild(s);var a=this.createLeftButton("Clear",()=>{o.maskCtx.clearRect(0,0,o.maskCanvas.width,o.maskCanvas.height)});this.brush_size_slider=this.createLeftSlider(o,"Thickness",d=>{o.brush_size=d.target.value,o.updateBrushPreview(o)}),this.brush_opacity_slider=this.createOpacitySlider(o,"Opacity",d=>{o.brush_opacity=d.target.value,o.brush_color_mode!=="negative"&&(o.maskCanvas.style.opacity=o.brush_opacity.toString())}),this.brush_pointer_type_select=this.createPointerTypeSelect(o),this.colorButton=this.createLeftButton(this.getColorButtonText(),()=>{o.brush_color_mode==="black"?o.brush_color_mode="white":o.brush_color_mode==="white"?o.brush_color_mode="negative":o.brush_color_mode="black",o.updateWhenBrushColorModeChanged()});var r=this.createRightButton("Cancel",()=>{document.removeEventListener("keydown",T.handleKeyDown),o.close()});this.saveButton=this.createRightButton("Save",()=>{document.removeEventListener("keydown",T.handleKeyDown),o.save()}),this.element.appendChild(e),this.element.appendChild(t),this.element.appendChild(i),i.appendChild(a),i.appendChild(this.saveButton),i.appendChild(r),i.appendChild(this.brush_size_slider),i.appendChild(this.brush_opacity_slider),i.appendChild(this.brush_pointer_type_select),i.appendChild(this.colorButton),e.style.position="absolute",t.style.position="absolute",e.style.top="200",e.style.left="0",t.style.top=e.style.top,t.style.left=e.style.left;const l=this.getMaskCanvasStyle();t.style.mixBlendMode=l.mixBlendMode,t.style.opacity=l.opacity.toString()}async show(){if(this.zoom_ratio=1,this.pan_x=0,this.pan_y=0,!this.is_layout_created){const e=document.createElement("canvas"),t=document.createElement("canvas");e.id="imageCanvas",t.id="maskCanvas",this.setlayout(e,t),this.imgCanvas=e,this.maskCanvas=t,this.maskCtx=t.getContext("2d",{willReadFrequently:!0}),this.setEventHandler(t),this.is_layout_created=!0;const o=this,i=new MutationObserver(function(a){a.forEach(function(r){r.type==="attributes"&&r.attributeName==="style"&&(o.last_display_style&&o.last_display_style!="none"&&o.element.style.display=="none"&&(o.brush.style.display="none",N.onClipspaceEditorClosed()),o.last_display_style=o.element.style.display)})}),s={attributes:!0};i.observe(this.element,s)}document.addEventListener("keydown",T.handleKeyDown),N.clipspace_return_node?this.saveButton.innerText="Save to node":this.saveButton.innerText="Save",this.saveButton.disabled=!1,this.element.style.display="block",this.element.style.width="85%",this.element.style.margin="0 7.5%",this.element.style.height="100vh",this.element.style.top="50%",this.element.style.left="42%",this.element.style.zIndex="8888",await this.setImages(this.imgCanvas),this.is_visible=!0}isOpened(){return this.element.style.display=="block"}invalidateCanvas(e,t){this.imgCanvas.width=e.width,this.imgCanvas.height=e.height,this.maskCanvas.width=e.width,this.maskCanvas.height=e.height;let o=this.imgCanvas.getContext("2d",{willReadFrequently:!0}),i=this.maskCanvas.getContext("2d",{willReadFrequently:!0});o.drawImage(e,0,0,e.width,e.height),co(t,this.maskCanvas,i,this.getMaskColor())}async setImages(e){let t=this;const o=e.getContext("2d",{willReadFrequently:!0}),i=this.maskCtx,s=this.maskCanvas;o.clearRect(0,0,this.imgCanvas.width,this.imgCanvas.height),i.clearRect(0,0,this.maskCanvas.width,this.maskCanvas.height);const a=new URL(N.clipspace.imgs[N.clipspace.selectedIndex].src);a.searchParams.delete("channel"),a.searchParams.delete("preview"),a.searchParams.set("channel","a");let r=await ro(a);const l=new URL(N.clipspace.imgs[N.clipspace.selectedIndex].src);l.searchParams.delete("channel"),l.searchParams.set("channel","rgb"),this.image=new Image,this.image.onload=function(){s.width=t.image.width,s.height=t.image.height,t.invalidateCanvas(t.image,r),t.initializeCanvasPanZoom()},this.image.src=l.toString()}initializeCanvasPanZoom(){let e=this.image.width,t=this.image.height,o=this.element.clientWidth,i=this.element.clientHeight;this.image.width>o&&(e=o,t=e/this.image.width*this.image.height),t>i&&(t=i,e=t/this.image.height*this.image.width),this.zoom_ratio=e/this.image.width;const s=(o-e)/2,a=(i-t)/2;this.pan_x=s,this.pan_y=a,this.invalidatePanZoom()}invalidatePanZoom(){let e=this.image.width*this.zoom_ratio,t=this.image.height*this.zoom_ratio;this.pan_x+e<10&&(this.pan_x=10-e),this.pan_y+t<10&&(this.pan_y=10-t);let o=`${e}px`,i=`${t}px`,s=`${this.pan_x}px`,a=`${this.pan_y}px`;this.maskCanvas.style.width=o,this.maskCanvas.style.height=i,this.maskCanvas.style.left=s,this.maskCanvas.style.top=a,this.imgCanvas.style.width=o,this.imgCanvas.style.height=i,this.imgCanvas.style.left=s,this.imgCanvas.style.top=a}setEventHandler(e){const t=this;this.handler_registered||(e.addEventListener("contextmenu",o=>{o.preventDefault()}),this.element.addEventListener("wheel",o=>this.handleWheelEvent(t,o)),this.element.addEventListener("pointermove",o=>this.pointMoveEvent(t,o)),this.element.addEventListener("touchmove",o=>this.pointMoveEvent(t,o)),this.element.addEventListener("dragstart",o=>{o.ctrlKey&&o.preventDefault()}),e.addEventListener("pointerdown",o=>this.handlePointerDown(t,o)),e.addEventListener("pointermove",o=>this.draw_move(t,o)),e.addEventListener("touchmove",o=>this.draw_move(t,o)),e.addEventListener("pointerover",()=>{this.brush.style.display="block"}),e.addEventListener("pointerleave",()=>{this.brush.style.display="none"}),document.addEventListener("pointerup",T.handlePointerUp),this.handler_registered=!0)}getMaskCanvasStyle(){return this.brush_color_mode==="negative"?{mixBlendMode:"difference",opacity:"1"}:{mixBlendMode:"initial",opacity:this.brush_opacity}}getMaskColor(){return this.brush_color_mode==="black"?{r:0,g:0,b:0}:this.brush_color_mode==="white"?{r:255,g:255,b:255}:this.brush_color_mode==="negative"?{r:255,g:255,b:255}:{r:0,g:0,b:0}}getMaskFillStyle(){const e=this.getMaskColor();return"rgb("+e.r+","+e.g+","+e.b+")"}getColorButtonText(){let e="unknown";return this.brush_color_mode==="black"?e="black":this.brush_color_mode==="white"?e="white":this.brush_color_mode==="negative"&&(e="negative"),"Color: "+e}updateWhenBrushColorModeChanged(){this.colorButton.innerText=this.getColorButtonText();const e=this.getMaskCanvasStyle();this.maskCanvas.style.mixBlendMode=e.mixBlendMode,this.maskCanvas.style.opacity=e.opacity.toString();const t=this.getMaskColor(),o=this.maskCtx.getImageData(0,0,this.maskCanvas.width,this.maskCanvas.height);for(let i=0;i<o.data.length;i+=4)o.data[i]=t.r,o.data[i+1]=t.g,o.data[i+2]=t.b;this.maskCtx.putImageData(o,0,0)}brush_opacity=.7;brush_size=10;brush_color_mode="black";drawing_mode=!1;lastx=-1;lasty=-1;lasttime=0;static handleKeyDown(e){const t=T.instance;e.key==="]"?(t.brush_size=Math.min(t.brush_size+2,100),t.brush_slider_input.value=t.brush_size):e.key==="["?(t.brush_size=Math.max(t.brush_size-2,1),t.brush_slider_input.value=t.brush_size):e.key==="Enter"&&t.save(),t.updateBrushPreview(t)}static handlePointerUp(e){e.preventDefault(),this.mousedown_x=null,this.mousedown_y=null,T.instance.drawing_mode=!1}updateBrushPreview(e){const t=e.brush;var o=e.cursorX,i=e.cursorY;t.style.width=e.brush_size*2*this.zoom_ratio+"px",t.style.height=e.brush_size*2*this.zoom_ratio+"px",t.style.left=o-e.brush_size*this.zoom_ratio+"px",t.style.top=i-e.brush_size*this.zoom_ratio+"px"}handleWheelEvent(e,t){t.preventDefault(),t.ctrlKey?(t.deltaY<0?this.zoom_ratio=Math.min(10,this.zoom_ratio+.2):this.zoom_ratio=Math.max(.2,this.zoom_ratio-.2),this.invalidatePanZoom()):(t.deltaY<0?this.brush_size=Math.min(this.brush_size+2,100):this.brush_size=Math.max(this.brush_size-2,1),this.brush_slider_input.value=this.brush_size.toString(),this.updateBrushPreview(this))}pointMoveEvent(e,t){this.cursorX=t.pageX,this.cursorY=t.pageY,e.updateBrushPreview(e),t.ctrlKey&&(t.preventDefault(),e.pan_move(e,t));let o=window.TouchEvent&&t instanceof TouchEvent||t.buttons==1;if(t.shiftKey&&o){e.drawing_mode=!1;const i=t.clientY;let s=(e.zoom_lasty-i)*.005;e.zoom_ratio=Math.max(Math.min(10,e.last_zoom_ratio-s),.2),this.invalidatePanZoom();return}}pan_move(e,t){if(t.buttons==1&&T.mousedown_x){let o=T.mousedown_x-t.clientX,i=T.mousedown_y-t.clientY;e.pan_x=this.mousedown_pan_x-o,e.pan_y=this.mousedown_pan_y-i,e.invalidatePanZoom()}}draw_move(e,t){if(t.ctrlKey||t.shiftKey)return;t.preventDefault(),this.cursorX=t.pageX,this.cursorY=t.pageY,e.updateBrushPreview(e);let o=window.TouchEvent&&t instanceof TouchEvent||t.buttons==1,i=[2,5,32].includes(t.buttons);if(!t.altKey&&o){var s=performance.now()-e.lasttime;const d=e.maskCanvas.getBoundingClientRect();var a=t.offsetX,r=t.offsetY;t.offsetX==null&&(a=t.targetTouches[0].clientX-d.left),t.offsetY==null&&(r=t.targetTouches[0].clientY-d.top),a/=e.zoom_ratio,r/=e.zoom_ratio;var l=this.brush_size;t instanceof PointerEvent&&t.pointerType=="pen"?(l*=t.pressure,this.last_pressure=t.pressure):window.TouchEvent&&t instanceof TouchEvent&&s<20?l*=this.last_pressure:l=this.brush_size,s>20&&!this.drawing_mode?requestAnimationFrame(()=>{e.init_shape(e,"source-over"),e.draw_shape(e,a,r,l),e.lastx=a,e.lasty=r}):requestAnimationFrame(()=>{e.init_shape(e,"source-over");for(var c=a-e.lastx,h=r-e.lasty,w=Math.sqrt(c*c+h*h),p=c/w,m=h/w,f=0;f<w;f+=5){var y=e.lastx+p*f,b=e.lasty+m*f;e.draw_shape(e,y,b,l)}e.lastx=a,e.lasty=r}),e.lasttime=performance.now()}else if(t.altKey&&o||i){const d=e.maskCanvas.getBoundingClientRect(),c=(t.offsetX||t.targetTouches[0].clientX-d.left)/e.zoom_ratio,h=(t.offsetY||t.targetTouches[0].clientY-d.top)/e.zoom_ratio;var l=this.brush_size;t instanceof PointerEvent&&t.pointerType=="pen"?(l*=t.pressure,this.last_pressure=t.pressure):window.TouchEvent&&t instanceof TouchEvent&&s<20?l*=this.last_pressure:l=this.brush_size,s>20&&!this.drawing_mode?requestAnimationFrame(()=>{e.init_shape(e,"destination-out"),e.draw_shape(e,c,h,l),e.lastx=c,e.lasty=h}):requestAnimationFrame(()=>{e.init_shape(e,"destination-out");for(var p=c-e.lastx,m=h-e.lasty,f=Math.sqrt(p*p+m*m),y=p/f,b=m/f,v=0;v<f;v+=5){var _=e.lastx+y*v,I=e.lasty+b*v;e.draw_shape(e,_,I,l)}e.lastx=c,e.lasty=h}),e.lasttime=performance.now()}}handlePointerDown(e,t){if(t.ctrlKey){t.buttons==1&&(T.mousedown_x=t.clientX,T.mousedown_y=t.clientY,this.mousedown_pan_x=this.pan_x,this.mousedown_pan_y=this.pan_y);return}var o=this.brush_size;if(t instanceof PointerEvent&&t.pointerType=="pen"&&(o*=t.pressure,this.last_pressure=t.pressure),[0,2,5].includes(t.button)){if(e.drawing_mode=!0,t.preventDefault(),t.shiftKey){e.zoom_lasty=t.clientY,e.last_zoom_ratio=e.zoom_ratio;return}const i=e.maskCanvas.getBoundingClientRect(),s=(t.offsetX||t.targetTouches[0].clientX-i.left)/e.zoom_ratio,a=(t.offsetY||t.targetTouches[0].clientY-i.top)/e.zoom_ratio;!t.altKey&&t.button==0?e.init_shape(e,"source-over"):e.init_shape(e,"destination-out"),e.draw_shape(e,s,a,o),e.lastx=s,e.lasty=a,e.lasttime=performance.now()}}init_shape(e,t){e.maskCtx.beginPath(),t=="source-over"?(e.maskCtx.fillStyle=this.getMaskFillStyle(),e.maskCtx.globalCompositeOperation="source-over"):t=="destination-out"&&(e.maskCtx.globalCompositeOperation="destination-out")}draw_shape(e,t,o,i){e.pointer_type==="rect"?e.maskCtx.rect(t-i,o-i,i*2,i*2):e.maskCtx.arc(t,o,i,0,Math.PI*2,!1),e.maskCtx.fill()}async save(){const e=document.createElement("canvas"),t=e.getContext("2d",{willReadFrequently:!0});e.width=this.image.width,e.height=this.image.height,t.clearRect(0,0,e.width,e.height),t.drawImage(this.maskCanvas,0,0,this.maskCanvas.width,this.maskCanvas.height,0,0,e.width,e.height);const o=t.getImageData(0,0,e.width,e.height);for(let p=0;p<o.data.length;p+=4)o.data[p+3]==255?o.data[p+3]=0:o.data[p+3]=255,o.data[p]=0,o.data[p+1]=0,o.data[p+2]=0;t.globalCompositeOperation="source-over",t.putImageData(o,0,0);const i=new FormData,s="clipspace-mask-"+performance.now()+".png",a={filename:s,subfolder:"clipspace",type:"input"};if(N.clipspace.images&&(N.clipspace.images[0]=a),N.clipspace.widgets){const p=N.clipspace.widgets.findIndex(m=>m.name==="image");p>=0&&(N.clipspace.widgets[p].value=a)}const r=e.toDataURL(),l=ao(r);let d=new URL(this.image.src);const c={filename:d.searchParams.get("filename")};let h=d.searchParams.get("subfolder");h&&(c.subfolder=h);let w=d.searchParams.get("type");w&&(c.type=w),i.append("image",l,s),i.append("original_ref",JSON.stringify(c)),i.append("type","input"),i.append("subfolder","clipspace"),this.saveButton.innerText="Saving...",this.saveButton.disabled=!0,await lo(a,i),N.onClipspaceEditorSave(),this.close()}}window.comfyAPI=window.comfyAPI||{};window.comfyAPI.maskEditorOld=window.comfyAPI.maskEditorOld||{};window.comfyAPI.maskEditorOld.MaskEditorDialogOld=T;const st=u(()=>{const n=x("toastMessages.legacyMaskEditorDeprecated");console.warn(`[Comfy.MaskEditor] ${n}`),S().add({severity:"warn",summary:"Alert",detail:n,life:4096})},"warnLegacyMaskEditorDeprecation");function uo(n){if(!n){console.error("[MaskEditor] No node provided");return}if(!n.imgs?.length&&n.previewMediaType!=="image"){console.error("[MaskEditor] Node has no images");return}if(g.extensionManager.setting.get("Comfy.MaskEditor.UseNewEditor"))At().openMaskEditor(n);else{st(),N.copyToClipspace(n),N.clipspace_return_node=n;const t=T.getInstance();t?.isOpened&&!t.isOpened()&&t.show()}}u(uo,"openMaskEditor");function po(){return g.extensionManager.setting.get("Comfy.MaskEditor.UseNewEditor")?et().isDialogOpen("global-mask-editor"):T.instance?.isOpened?.()??!1}u(po,"isOpened");g.registerExtension({name:"Comfy.MaskEditor",settings:[{id:"Comfy.MaskEditor.UseNewEditor",category:["Mask Editor","NewEditor"],name:"Use new mask editor",tooltip:"Switch to the new mask editor interface",type:"boolean",defaultValue:!0,experimental:!0},{id:"Comfy.MaskEditor.BrushAdjustmentSpeed",category:["Mask Editor","BrushAdjustment","Sensitivity"],name:"Brush adjustment speed multiplier",tooltip:"Controls how quickly the brush size and hardness change when adjusting. Higher values mean faster changes.",experimental:!0,type:"slider",attrs:{min:.1,max:2,step:.1},defaultValue:1,versionAdded:"1.0.0"},{id:"Comfy.MaskEditor.UseDominantAxis",category:["Mask Editor","BrushAdjustment","UseDominantAxis"],name:"Lock brush adjustment to dominant axis",tooltip:"When enabled, brush adjustments will only affect size OR hardness based on which direction you move more",type:"boolean",defaultValue:!0,experimental:!0}],commands:[{id:"Comfy.MaskEditor.OpenMaskEditor",icon:"pi pi-pencil",label:"Open Mask Editor for Selected Node",function:u(()=>{const n=g.canvas.selected_nodes;if(!n||Object.keys(n).length!==1)return;const e=n[Object.keys(n)[0]];uo(e)},"function")},{id:"Comfy.MaskEditor.BrushSize.Increase",icon:"pi pi-plus-circle",label:"Increase Brush Size in MaskEditor",function:u(()=>Ye(n=>q.clamp(n+4,1,100)),"function")},{id:"Comfy.MaskEditor.BrushSize.Decrease",icon:"pi pi-minus-circle",label:"Decrease Brush Size in MaskEditor",function:u(()=>Ye(n=>q.clamp(n-4,1,100)),"function")}],init(){const n=u(()=>{if(!g.extensionManager.setting.get("Comfy.MaskEditor.UseNewEditor")){st();const o=T.getInstance();o?.isOpened&&!o.isOpened()&&o.show()}},"openMaskEditorFromClipspace"),e=u(()=>!!(N.clipspace&&N.clipspace.imgs&&N.clipspace.imgs.length>0),"context_predicate");M.registerButton("MaskEditor",e,n)}});const Ye=u(async n=>{if(!po())return;const e=Mt(),t=e.brushSettings.size,o=n(t);e.setBrushSize(o)},"changeBrushSize"),ho="Comfy.NodeTemplates",qe="comfy.templates.json";class go extends Ie{static{u(this,"ManageTemplates")}templates;draggedEl;saveVisualCue;emptyImg;importInput;constructor(){super(),this.load().then(e=>{this.templates=e}),this.element.classList.add("comfy-manage-templates"),this.draggedEl=null,this.saveVisualCue=null,this.emptyImg=new Image,this.emptyImg.src="data:image/gif;base64,R0lGODlhAQABAIAAAAUEBAAAACwAAAAAAQABAAACAkQBADs=",this.importInput=C("input",{type:"file",accept:".json",multiple:!0,style:{display:"none"},parent:document.body,onchange:u(()=>this.importAll(),"onchange")})}createButtons(){const e=super.createButtons();return e[0].textContent="Close",e[0].onclick=()=>{clearTimeout(this.saveVisualCue),this.close()},e.unshift(C("button",{type:"button",textContent:"Export",onclick:u(()=>this.exportAll(),"onclick")})),e.unshift(C("button",{type:"button",textContent:"Import",onclick:u(()=>{this.importInput.click()},"onclick")})),e}async load(){let e=[];const t=await A.getUserData(qe);if(t.status===200)try{e=await t.json()}catch{}else t.status!==404&&console.error(t.status+" "+t.statusText);return e??[]}async store(){const e=JSON.stringify(this.templates,void 0,4);try{await A.storeUserData(qe,e,{stringify:!1})}catch(t){console.error(t),S().addAlert(t.message)}}async importAll(){for(const e of this.importInput.files)if(e.type==="application/json"||e.name.endsWith(".json")){const t=new FileReader;t.onload=async()=>{const o=JSON.parse(t.result);if(o?.templates){for(const i of o.templates)i?.name&&i?.data&&this.templates.push(i);await this.store()}},await t.readAsText(e)}this.importInput.value=null,this.close()}exportAll(){if(this.templates.length==0){S().addAlert(x("toastMessages.noTemplatesToExport"));return}const e=JSON.stringify({templates:this.templates},null,2),t=new Blob([e],{type:"application/json"});We("node_templates.json",t)}show(){super.show(C("div",{},this.templates.flatMap((e,t)=>{let o;return[C("div",{dataset:{id:t.toString()},className:"templateManagerRow",style:{display:"grid",gridTemplateColumns:"1fr auto",border:"1px dashed transparent",gap:"5px",backgroundColor:"var(--comfy-menu-bg)"},ondragstart:u(i=>{this.draggedEl=i.currentTarget,i.currentTarget.style.opacity="0.6",i.currentTarget.style.border="1px dashed yellow",i.dataTransfer.effectAllowed="move",i.dataTransfer.setDragImage(this.emptyImg,0,0)},"ondragstart"),ondragend:u(i=>{i.target.style.opacity="1",i.currentTarget.style.border="1px dashed transparent",i.currentTarget.removeAttribute("draggable"),this.element.querySelectorAll(".templateManagerRow").forEach((s,a)=>{var r=Number.parseInt(s.dataset.id);s==this.draggedEl&&r!=a&&this.templates.splice(a,0,this.templates.splice(r,1)[0]),s.dataset.id=a.toString()}),this.store()},"ondragend"),ondragover:u(i=>{if(i.preventDefault(),i.currentTarget==this.draggedEl)return;let s=i.currentTarget.getBoundingClientRect();i.clientY>s.top+s.height/2?i.currentTarget.parentNode.insertBefore(this.draggedEl,i.currentTarget.nextSibling):i.currentTarget.parentNode.insertBefore(this.draggedEl,i.currentTarget)},"ondragover")},[C("label",{textContent:"Name: ",style:{cursor:"grab"},onmousedown:u(i=>{i.target.localName=="label"&&(i.currentTarget.parentNode.draggable="true")},"onmousedown")},[C("input",{value:e.name,dataset:{name:e.name},style:{transitionProperty:"background-color",transitionDuration:"0s"},onchange:u(i=>{clearTimeout(this.saveVisualCue);var s=i.target,a=s.parentNode.parentNode;this.templates[a.dataset.id].name=s.value.trim()||"untitled",this.store(),s.style.backgroundColor="rgb(40, 95, 40)",s.style.transitionDuration="0s",this.saveVisualCue=setTimeout(function(){s.style.transitionDuration=".7s",s.style.backgroundColor="var(--comfy-input-bg)"},15)},"onchange"),onkeypress:u(i=>{var s=i.target;clearTimeout(this.saveVisualCue),s.style.transitionDuration="0s",s.style.backgroundColor="var(--comfy-input-bg)"},"onkeypress"),$:u(i=>o=i,"$")})]),C("div",{},[C("button",{textContent:"Export",style:{fontSize:"12px",fontWeight:"normal"},onclick:u(()=>{const i=JSON.stringify({templates:[e]},null,2),s=new Blob([i],{type:"application/json"}),a=(o.value||e.name)+".json";We(a,s)},"onclick")}),C("button",{textContent:"Delete",style:{fontSize:"12px",color:"red",fontWeight:"normal"},onclick:u(i=>{const s=i.target.parentNode.parentNode;s.parentNode.removeChild(s),this.templates.splice(s.dataset.id*1,1),this.store();var a=this;setTimeout(function(){a.element.querySelectorAll(".templateManagerRow").forEach((r,l)=>{r.dataset.id=l.toString()})},0)},"onclick")})])])]})))}}const le=new go,Xe=u(async n=>{const e=localStorage.getItem("litegrapheditor_clipboard");await n(),localStorage.setItem("litegrapheditor_clipboard",e)},"clipboardAction"),mo={name:ho,getCanvasMenuItems(n){const e=[];e.push(null),e.push({content:"Save Selected as Template",disabled:!Object.keys(g.canvas.selected_nodes||{}).length,callback:u(async()=>{const o=await ee().prompt({title:x("nodeTemplates.saveAsTemplate"),message:x("nodeTemplates.enterName"),defaultValue:""});o?.trim()&&Xe(()=>{g.canvas.copyToClipboard();let i=localStorage.getItem("litegrapheditor_clipboard");i=JSON.parse(i||"{}");const s=Object.keys(g.canvas.selected_nodes);for(let a=0;a<s.length;a++){const r=g.graph.getNodeById(s[a]),l=r?.constructor.nodeData;let d=G.getGroupData(r);if(d){if(d=d.nodeData,i.groupNodes||(i.groupNodes={}),l==null)throw new TypeError("nodeData is not set");i.groupNodes[l.name]=d,i.nodes[a].type=l.name}}le.templates.push({name:o,data:JSON.stringify(i)}),le.store()})},"callback")});const t=le.templates.map(o=>({content:o.name,callback:u(()=>{Xe(async()=>{const i=JSON.parse(o.data);await H.registerFromWorkflow(i.groupNodes,{}),i.reroutes?(localStorage.setItem("litegrapheditor_clipboard",o.data),g.canvas.pasteFromClipboard()):Qe(o.data,g.canvas)})},"callback")}));return t.push(null,{content:"Manage",callback:u(()=>le.show(),"callback")}),e.push({content:"Node Templates",submenu:{options:t}}),e}};g.registerExtension(mo);g.registerExtension({name:"Comfy.NoteNode",registerCustomNodes(){class n extends ce{static{u(this,"NoteNode")}static category;static collapsable;static title_mode;groupcolor=B.node_colors.yellow.groupcolor;isVirtualNode;constructor(o){super(o),this.color=B.node_colors.yellow.color,this.bgcolor=B.node_colors.yellow.bgcolor,this.properties||(this.properties={text:""}),$.STRING(this,"text",["STRING",{default:this.properties.text,multiline:!0}],g),this.serialize_widgets=!0,this.isVirtualNode=!0}}k.registerNodeType("Note",Object.assign(n,{title_mode:k.NORMAL_TITLE,title:"Note",collapsable:!0})),n.category="utils";class e extends ce{static{u(this,"MarkdownNoteNode")}static title="Markdown Note";groupcolor=B.node_colors.yellow.groupcolor;constructor(o){super(o),this.color=B.node_colors.yellow.color,this.bgcolor=B.node_colors.yellow.bgcolor,this.properties||(this.properties={text:""}),$.MARKDOWN(this,"text",["STRING",{default:this.properties.text}],g),this.serialize_widgets=!0,this.isVirtualNode=!0}}k.registerNodeType("MarkdownNote",e),e.category="utils"}});re().registerExtension({name:"Comfy.PreviewAny",async beforeRegisterNodeDef(n,e){if(e.name==="PreviewAny"){const t=n.prototype.onNodeCreated;n.prototype.onNodeCreated=function(){t&&t.apply(this,[]);const i=$.MARKDOWN(this,"preview",["MARKDOWN",{}],g).widget,s=$.STRING(this,"preview",["STRING",{multiline:!0}],g).widget,a=$.BOOLEAN(this,"previewMode",["BOOLEAN",{label_on:"Markdown",label_off:"Plaintext",default:!1}],g);a.widget.callback=r=>{i.hidden=!r,i.options.hidden=!r,s.hidden=r,s.options.hidden=r},i.hidden=!0,i.options.hidden=!0,i.options.read_only=!0,i.element.readOnly=!0,i.element.disabled=!0,i.serialize=!1,s.hidden=!1,s.options.hidden=!1,s.options.read_only=!0,s.element.readOnly=!0,s.element.disabled=!0,s.serialize=!1};const o=n.prototype.onExecuted;n.prototype.onExecuted=function(i){o?.apply(this,[i]);const s=this.widgets?.filter(a=>a.name==="preview")??[];for(const a of s)a.value=i.text[0]}}}});g.registerExtension({name:"Comfy.RerouteNode",registerCustomNodes(n){class e extends ce{static{u(this,"RerouteNode")}static category;static defaultVisibility=!1;constructor(o){super(o??""),this.properties||(this.properties={}),this.properties.showOutputText=e.defaultVisibility,this.properties.horizontal=!1,this.addInput("","*"),this.addOutput(this.properties.showOutputText?"*":"","*"),this.isVirtualNode=!0}onAfterGraphConfigured(){requestAnimationFrame(()=>{this.onConnectionsChange(k.INPUT,void 0,!0)})}clone(){const o=super.clone();return o&&(o.removeOutput(0),o.addOutput(this.properties.showOutputText?"*":"","*"),o.setSize(o.computeSize()),o)}onConnectionsChange(o,i,s){const{graph:a}=this;if(!a||n.configuringGraph)return;if(s&&o===k.OUTPUT&&new Set(this.outputs[0].links?.map(v=>a.links[v]?.type)?.filter(v=>v&&v!=="*")??[]).size>1){const v=[];for(const _ of this.outputs[0].links??[]){const I=a.links[_];v.push(I)}v.pop();for(const _ of v)a.getNodeById(_.target_id)?.disconnectInput(_.target_slot)}let r=this,l=[],d=null,c=null;for(;r;){l.unshift(r);const b=r.inputs[0].link;if(b!==null){const v=a.links[b];if(!v)return;const _=a.getNodeById(v.origin_id);if(!_)return;if(_ instanceof e)_===this?(r.disconnectInput(v.target_slot),r=null):r=_;else{c=r,d=_.outputs[v.origin_slot]?.type??null;break}}else{r=null;break}}const h=[this];let w=null;for(;h.length;){r=h.pop();const b=r.outputs?.[0]?.links??[];for(const v of b){const _=a.links[v];if(!_)continue;const I=a.getNodeById(_.target_id);if(I)if(I instanceof e)h.push(I),l.push(I);else{const D=I.inputs[_.target_slot],E=D.type,O=!d||!E||k.isValidConnection(d,E);if(!O){I.disconnectInput(_.target_slot);continue}I.onConnectionsChange?.(k.INPUT,_.target_slot,O,_,D),w=I.inputs[_.target_slot].type}}}const p=d||w||"*",m=B.link_type_colors[p];let f,y;for(const b of l){b.outputs[0].type=d||"*",b.__outputType=p,b.outputs[0].name=b.properties.showOutputText?`${p}`:"",b.setSize(b.computeSize());for(const v of b.outputs[0].links||[]){const _=a.links[v];if(!_||(_.color=m,n.configuringGraph))continue;const I=a.getNodeById(_.target_id);if(!I)continue;const D=I.inputs?.[_.target_slot];if(D?.widget){const E=Me(D);f||(f=E[1]??{},y=E[0]);const O=ae(D,[E[0],f]);O.customConfig&&(f=O.customConfig)}}}for(const b of l)f&&w?(b.inputs[0].widget={name:"value"},ke(b.inputs[0],[y??`${p}`,f])):ke(b.inputs[0],void 0);if(c?.inputs?.[0]?.link){const b=a.links[c.inputs[0].link];b&&(b.color=m)}}getExtraMenuOptions(o,i){return i.unshift({content:(this.properties.showOutputText?"Hide":"Show")+" Type",callback:u(()=>{this.properties.showOutputText=!this.properties.showOutputText,this.properties.showOutputText?this.outputs[0].name=`${this.__outputType||this.outputs[0].type}`:this.outputs[0].name="",this.setSize(this.computeSize()),n.canvas.setDirty(!0,!0)},"callback")},{content:(e.defaultVisibility?"Hide":"Show")+" Type By Default",callback:u(()=>{e.setDefaultTextVisibility(!e.defaultVisibility)},"callback")}),[]}computeSize(){return[this.properties.showOutputText&&this.outputs&&this.outputs.length?Math.max(75,k.NODE_TEXT_SIZE*this.outputs[0].name.length*.6+40):75,26]}static setDefaultTextVisibility(o){e.defaultVisibility=o,o?localStorage["Comfy.RerouteNode.DefaultVisibility"]="true":delete localStorage["Comfy.RerouteNode.DefaultVisibility"]}}e.setDefaultTextVisibility(!!localStorage["Comfy.RerouteNode.DefaultVisibility"]),k.registerNodeType("Reroute",Object.assign(e,{title_mode:k.NO_TITLE,title:"Reroute",collapsable:!1})),e.category="utils"}});const fo=new Set(["SaveImage","SaveVideo","SaveAnimatedWEBP","SaveWEBM","SaveAudio","SaveGLB","SaveAnimatedPNG","CLIPSave","VAESave","ModelSave","LoraSave","SaveLatent"]);g.registerExtension({name:"Comfy.SaveImageExtraOutput",async beforeRegisterNodeDef(n,e,t){if(fo.has(e.name)){const o=n.prototype.onNodeCreated;n.prototype.onNodeCreated=function(){const i=o?o.apply(this,arguments):void 0,s=this.widgets.find(a=>a.name==="filename_prefix");return s.serializeValue=()=>Ze(t.graph,s.value),i}}else{const o=n.prototype.onNodeCreated;n.prototype.onNodeCreated=function(){const i=o?o.apply(this,arguments):void 0;return(!this.properties||!("Node name for S&R"in this.properties))&&this.addProperty("Node name for S&R",this.constructor.type,"string"),i}}}});const He={name:"image",type:"Preview3D",isPreview:!0};re().registerExtension({name:"Comfy.SaveGLB",async beforeRegisterNodeDef(n,e){e.name==="SaveGLB"&&(e.input.required.image=["PREVIEW_3D"])},getCustomWidgets(){return{PREVIEW_3D(n){const e=new xe({node:n,name:He.name,component:Ee,inputSpec:He,options:{}});return e.type="load3D",De(n,e),{widget:e}}}},getNodeMenuItems(n){if(n.constructor.comfyClass!=="SaveGLB")return[];const e=ue().getLoad3d(n);return e?he(e):[]},async nodeCreated(n){if(n.constructor.comfyClass!=="SaveGLB")return;const[e,t]=n.size;n.setSize([Math.max(e,400),Math.max(t,550)]),await Te();const o=n.onExecuted;n.onExecuted=function(i){o?.apply(this,arguments);const s=i["3d"][0];ne(n).waitForLoad3d(a=>{const r=n.widgets?.find(l=>l.name==="image");if(a&&r){const l=s.subfolder+"/"+s.filename;r.value=l,new Ae(a,n.properties).configureForSaveMesh(s.type,l)}})}}});function yo(n,e){const t=e.selectedItems;if(t.size<=1)return;const o=Ot(t,10);if(!o)return;const[i,s,a,r]=o;n.save();const l=2/e.ds.scale;n.lineWidth=l,n.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue("--border-color").trim()||"#ffffff66";const d=5/e.ds.scale;n.setLineDash([d,d]),n.beginPath(),n.roundRect(i,s,a,r,8/e.ds.scale),n.stroke(),n.restore()}u(yo,"drawSelectionBorder");const wo={name:"Comfy.SelectionBorder",async init(){const n=g.canvas.onDrawForeground;g.canvas.onDrawForeground=function(e,t){n?.call(this,e,t),yo(e,g.canvas)}}};g.registerExtension(wo);let ie=!1,se=0;g.registerExtension({name:"Comfy.SimpleTouchSupport",setup(){let n=null,e=null,t=null,o=null;function i(r){return Math.hypot(r.touches[0].clientX-r.touches[1].clientX,r.touches[0].clientY-r.touches[1].clientY)}u(i,"getMultiTouchPos");function s(r){return{clientX:(r.touches[0].clientX+r.touches[1].clientX)/2,clientY:(r.touches[0].clientY+r.touches[1].clientY)/2}}u(s,"getMultiTouchCenter"),g.canvasEl.parentElement?.addEventListener("touchstart",r=>{se+=r.changedTouches.length,t=null,o=null,r.touches?.length===1?(e=new Date,t=r.touches[0]):(e=null,r.touches?.length===2&&(o=g.canvas.ds.scale,t=s(r),n=i(r),g.canvas.pointer.isDown=!1))},!0),g.canvasEl.parentElement?.addEventListener("touchend",r=>{if(se-=r.changedTouches.length,r.touches?.length!==1&&(ie=!1),e&&!r.touches?.length){if(new Date().getTime()-e.getTime()>600&&r.target===g.canvasEl){const l={button:2,clientX:r.changedTouches[0].clientX,clientY:r.changedTouches[0].clientY,pointerId:1,isPrimary:!0};g.canvasEl.dispatchEvent(new PointerEvent("pointerdown",l)),setTimeout(()=>{g.canvasEl.dispatchEvent(new PointerEvent("pointerup",l))}),r.preventDefault()}e=null}});const a=u(()=>{se=0,ie=!1,e=null,t=null,o=null,n=null},"resetTouchState");document.addEventListener("visibilitychange",()=>{document.hidden&&a()}),g.canvasEl.parentElement?.addEventListener("touchcancel",a),g.canvasEl.parentElement?.addEventListener("touchmove",r=>{if(e&&t&&r.touches?.length===1){const c=r.touches[0],h=c.clientX-t.clientX,w=c.clientY-t.clientY;h*h+w*w>30&&(e=null)}if(r.touches?.length===2&&t&&!r.ctrlKey&&!r.shiftKey){r.preventDefault(),g.canvas.pointer.isDown=!1,ie=!0,k.closeAllContextMenus(window),g.canvas.search_box?.close();const c=i(r),h=s(r);if(o===null||n===null)return;let w=o*c/n;const p=(h.clientX-t.clientX)/w,m=(h.clientY-t.clientY)/w;w<g.canvas.ds.min_scale?w=g.canvas.ds.min_scale:w>g.canvas.ds.max_scale&&(w=g.canvas.ds.max_scale);const f=g.canvas.ds.scale;g.canvas.ds.scale=w,Math.abs(g.canvas.ds.scale-1)<.01&&(g.canvas.ds.scale=1);const y=g.canvas.ds.scale,b=u(v=>[h.clientX/v-g.canvas.ds.offset[0],h.clientY/v-g.canvas.ds.offset[1]],"convertScaleToOffset");var l=b(f),d=b(y);g.canvas.ds.offset[0]+=p+d[0]-l[0],g.canvas.ds.offset[1]+=m+d[1]-l[1],t.clientX=h.clientX,t.clientY=h.clientY,g.canvas.setDirty(!0,!0)}},!0)}});const bo=B.prototype.processMouseDown;B.prototype.processMouseDown=function(n){if(!(ie||se))return g.canvas.pointer.isDown=!1,bo.apply(this,[n])};const vo=B.prototype.processMouseMove;B.prototype.processMouseMove=function(n){if(!(ie||se>1))return vo.apply(this,[n])};g.registerExtension({name:"Comfy.SlotDefaults",suggestionsNumber:null,init(){k.search_filter_enabled=!0,k.middle_click_slot_add_default_node=!0,this.suggestionsNumber=g.ui.settings.addSetting({id:"Comfy.NodeSuggestions.number",category:["Comfy","Node Search Box","NodeSuggestions"],name:"Number of nodes suggestions",tooltip:"Only for litegraph searchbox/context menu",type:"slider",attrs:{min:1,max:100,step:1},defaultValue:5,onChange:u(n=>{this.setDefaults(n)},"onChange")})},slot_types_default_out:{},slot_types_default_in:{},async beforeRegisterNodeDef(n,e){var t=e.name;const o=e.input?.required;for(const d in o){var i=o[d];if(typeof i[0]!="string")continue;var s=i[0];if(s in $){var a=i[1];if(!a?.forceInput)continue}if(s in this.slot_types_default_out||(this.slot_types_default_out[s]=["Reroute"]),this.slot_types_default_out[s].includes(t))continue;this.slot_types_default_out[s].push(t);const c=s.toLocaleLowerCase();c in k.registered_slot_in_types||(k.registered_slot_in_types[c]={nodes:[]}),k.registered_slot_in_types[c].nodes.push(n.comfyClass)}var r=e.output??[];for(const d of r){const c=d;c in this.slot_types_default_in||(this.slot_types_default_in[c]=["Reroute"]),!this.slot_types_default_in[c].includes(t)&&(this.slot_types_default_in[c].push(t),c in k.registered_slot_out_types||(k.registered_slot_out_types[c]={nodes:[]}),k.registered_slot_out_types[c].nodes.push(n.comfyClass),k.slot_types_out.includes(c)||k.slot_types_out.push(c))}var l=this.suggestionsNumber.value;this.setDefaults(l)},setDefaults(n){k.slot_types_default_out={},k.slot_types_default_in={};for(const e in this.slot_types_default_out)k.slot_types_default_out[e]=this.slot_types_default_out[e].slice(0,n);for(const e in this.slot_types_default_in)k.slot_types_default_in[e]=this.slot_types_default_in[e].slice(0,n)}});async function Co(n,e,t,o,i=!1){try{const s=new FormData;s.append("image",t),i&&s.append("subfolder","pasted");const a=await A.fetchApi("/upload/image",{method:"POST",body:s});if(a.status===200){const r=await a.json();let l=r.name;r.subfolder&&(l=r.subfolder+"/"+l),n.options.values.includes(l)||n.options.values.push(l),o&&(e.element.src=A.apiURL(pe(...tt(l))),n.value=l,n.callback?.(l))}else S().addAlert(a.status+" - "+a.statusText)}catch(s){S().addAlert(s)}}u(Co,"uploadFile");g.registerExtension({name:"Comfy.AudioWidget",async beforeRegisterNodeDef(n,e){["LoadAudio","SaveAudio","PreviewAudio","SaveAudioMP3","SaveAudioOpus"].includes(n.prototype.comfyClass)&&(e.input.required.audioUI=["AUDIO_UI",{}])},getCustomWidgets(){return{AUDIO_UI(n,e){const t=document.createElement("audio");t.controls=!0,t.classList.add("comfy-audio"),t.setAttribute("name","media");const o=n.addDOMWidget(e,"audioUI",t);o.serialize=!1;const{nodeData:i}=n.constructor;if(i==null)throw new TypeError("nodeData is null");if(i.output_node){o.element.classList.add("empty-audio-widget");const a=n.onExecuted;n.onExecuted=function(r){a?.apply(this,arguments);const l=r.audio;if(!l)return;const d=l[0];o.element.src=A.apiURL(pe(d.subfolder,d.filename,d.type)),o.element.classList.remove("empty-audio-widget")}}return o.onRemove=de(o.onRemove,()=>{o.element&&(o.element.pause(),o.element.src="",o.element.remove())}),{widget:o}}}},onNodeOutputsUpdated(n){for(const[e,t]of Object.entries(n))if("audio"in t){const o=Pt(g.graph,e);if(!o)continue;const i=o.widgets.find(a=>a.name==="audioUI"),s=t.audio[0];i.element.src=A.apiURL(pe(s.subfolder,s.filename,s.type)),i.element.classList.remove("empty-audio-widget")}}});g.registerExtension({name:"Comfy.UploadAudio",async beforeRegisterNodeDef(n,e){e?.input?.required?.audio?.[1]?.audio_upload===!0&&(e.input.required.upload=["AUDIOUPLOAD",{}])},getCustomWidgets(){return{AUDIOUPLOAD(n,e){const t=n.widgets.find(c=>c.name==="audio"),o=n.widgets.find(c=>c.name==="audioUI");o.options.canvasOnly=!0;const i=u(()=>{typeof t.value=="string"&&(o.element.src=A.apiURL(pe(...tt(t.value))))},"onAudioWidgetUpdate");t.value&&i(),t.callback=i;const s=n.onGraphConfigured;n.onGraphConfigured=function(){s?.apply(this,arguments),t.value&&i()};const a=u(async c=>(c?.length&&Co(t,o,c[0],!0),c),"handleUpload"),r=u(c=>c.type.startsWith("audio/"),"isAudioFile"),{openFileSelection:l}=Lt(n,{accept:"audio/*",onSelect:a}),d=n.addWidget("button",e,"",l,{serialize:!1,canvasOnly:!0});return d.label=x("g.choose_file_to_upload"),Rt(n,{fileFilter:r,onDrop:a}),Wt(n,{fileFilter:r,onPaste:a}),n.previewMediaType="audio",{widget:d}}}}});g.registerExtension({name:"Comfy.RecordAudio",getCustomWidgets(){return{AUDIO_RECORD(n,e){const t=document.createElement("audio");t.controls=!0,t.classList.add("comfy-audio"),t.setAttribute("name","media");const o=n.addDOMWidget(e,"audioUI",t);o.options.canvasOnly=!1;let i=null,s=!1,a=[],r=null,l=null,d=null,c=null;o.serializeValue=async()=>{s&&i&&(d=new Promise(m=>{c=m}),i.stop(),await d);const w=o.element.src;if(!w)return S().addAlert(x("g.noAudioRecorded")),"";const p=await fetch(w).then(m=>m.blob());return await Z().convertBlobToFileAndSubmit(p)},l=n.addWidget("button",e,"",async()=>{if(s)i&&s&&i.stop();else try{r=await navigator.mediaDevices.getUserMedia({audio:!0}),i=new Bt(r,{mimeType:"audio/wav"}),a=[],i.ondataavailable=w=>{a.push(w.data)},i.onstop=async()=>{const w=new Blob(a,{type:"audio/wav"});Z().stopAllTracks(r),o.element.src&&o.element.src.startsWith("blob:")&&URL.revokeObjectURL(o.element.src),o.element.src=URL.createObjectURL(w),s=!1,l&&(l.label=x("g.startRecording")),c&&(c(),c=null,d=null)},i.onerror=w=>{console.error("MediaRecorder error:",w),Z().stopAllTracks(r),s=!1,l&&(l.label=x("g.startRecording")),c&&(c(),c=null,d=null)},i.start(),s=!0,l&&(l.label=x("g.stopRecording"))}catch(w){if(console.error("Error accessing microphone:",w),S().addAlert(x("g.micPermissionDenied")),i)try{i.stop()}catch{}Z().stopAllTracks(r),r=null,s=!1,l&&(l.label=x("g.startRecording"))}},{serialize:!1,canvasOnly:!1}),l.label=x("g.startRecording"),l.type="audiorecord";const h=n.onRemoved;return n.onRemoved=function(){s&&i&&i.stop(),Z().stopAllTracks(r),o.element.src?.startsWith("blob:")&&URL.revokeObjectURL(o.element.src),h?.call(this)},{widget:l}}}},async nodeCreated(n){n.constructor.comfyClass==="RecordAudio"&&await Z().registerWavEncoder()}});const _o=u(n=>{const[e,t]=n;return t?(t.image_upload===!0||t.video_upload===!0||t.animated_image_upload===!0)&&(Ft(n)||e==="COMBO"):!1},"isMediaUploadComboInput"),ko=u((n,e)=>["IMAGEUPLOAD",{...e[1],imageInputName:n}],"createUploadInput");g.registerExtension({name:"Comfy.UploadImage",beforeRegisterNodeDef(n,e){const{input:t}=e??{},{required:o}=t??{};if(!o)return;const i=Object.entries(o).find(([s,a])=>_o(a));if(i){const[s,a]=i;o.upload=ko(s,a)}}});const Ke=Symbol();g.registerExtension({name:"Comfy.WebcamCapture",getCustomWidgets(){return{WEBCAM(n,e){let t;n[Ke]=new Promise(a=>t=a);const o=document.createElement("div");o.style.background="rgba(0,0,0,0.25)",o.style.textAlign="center";const i=document.createElement("video");return i.style.height=i.style.width="100%",u(async()=>{try{const a=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1});o.replaceChildren(i),setTimeout(()=>t(i),500),i.addEventListener("loadedmetadata",()=>t(i),!1),i.srcObject=a,i.play()}catch(a){const r=document.createElement("div");r.style.color="red",r.style.overflow="auto",r.style.maxHeight="100%",r.style.whiteSpace="pre-wrap",window.isSecureContext?r.textContent=`Unable to load webcam, please ensure access is granted:
`+a.message:r.textContent=`Unable to load webcam. A secure context is required, if you are not accessing ComfyUI on localhost (127.0.0.1) you will have to enable TLS (https)

`+a.message,o.replaceChildren(r)}},"loadVideo")(),{widget:n.addDOMWidget(e,"WEBCAM",o)}}}},nodeCreated(n){if(n.type,n.constructor.comfyClass!=="WebcamCapture")return;let e;const t=n.widgets.find(d=>d.name==="image"),o=n.widgets.find(d=>d.name==="width"),i=n.widgets.find(d=>d.name==="height"),s=n.widgets.find(d=>d.name==="capture_on_queue"),a=document.createElement("canvas"),r=u(()=>{a.width=o.value,a.height=i.value,a.getContext("2d").drawImage(e,0,0,o.value,i.value);const c=a.toDataURL("image/png"),h=new Image;h.onload=()=>{n.imgs=[h],g.graph.setDirtyCanvas(!0)},h.src=c},"capture"),l=n.addWidget("button","waiting for camera...","capture",r,{canvasOnly:!0});l.disabled=!0,l.serializeValue=()=>{},t.serializeValue=async()=>{if(s.value)r();else if(!n.imgs?.length){const m="No webcam image captured";throw S().addAlert(m),new Error(m)}const d=await new Promise(m=>a.toBlob(m)),c=`${+new Date}.png`,h=new File([d],c),w=new FormData;w.append("image",h),w.append("subfolder","webcam"),w.append("type","temp");const p=await A.fetchApi("/upload/image",{method:"POST",body:w});if(p.status!==200){const m=`Error uploading camera image: ${p.status} - ${p.statusText}`;throw S().addAlert(m),new Error(m)}return`webcam/${c} [temp]`},n[Ke].then(d=>{e=d,o.value||(o.value=e.videoWidth||640,i.value=e.videoHeight||480),l.disabled=!1,l.label=x("g.capture")})}});
//# sourceMappingURL=index-DzTokrN4.js.map

var Q=Object.defineProperty;var c=(o,t)=>Q(o,"name",{value:t,configurable:!0});import{c as K,a as X,_ as Y,j as H,e as T,Z as ee,o as te,s as Z,l as W,u as O,d as D,p as ae,g as se}from"./index-B9idOcBD.js";import{j as oe,z as le,f as re,b as ne}from"./vendor-primevue-DtyGeE5P.js";import{u as ie}from"./vendor-vue-BzxvP81x.js";import{bs as C,cB as N,cC as G,E as V,c as d,p as U,q as I,e as n,f as de,d as m,t as f,G as q,s as w,m as ce,bq as u,cU as ue,cl as pe,A as L,w as z,cT as me,es as fe,r as b,o as ve,bb as ge,d5 as he,b as be,bP as ye,u as P}from"./vendor-other-C52en72l.js";const we={class:"flex items-center gap-2 text-sm"},$e={key:0,class:"text-base-foreground"},Me={key:1,class:"text-base-foreground"},Ue={class:"truncate"},ke={key:0,class:"icon-[lucide--check] text-base-foreground"},Ce=C({inheritAttrs:!1,__name:"SingleSelect",props:N({label:{},options:{},listMaxHeight:{default:"28rem"},popoverMinWidth:{},popoverMaxWidth:{}},{modelValue:{required:!0},modelModifiers:{}}),emits:["update:modelValue"],setup(o){const t=G(o,"modelValue"),{t:l}=ie(),s=c(a=>{if(a==null||!o.options)return o.label??"";const r=o.options.find(i=>i.value===a);return r?r.name:o.label??""},"getLabel"),e=V(()=>{if(!o.popoverMinWidth&&!o.popoverMaxWidth)return;const a=[];return o.popoverMinWidth&&a.push(`min-width: ${o.popoverMinWidth}`),o.popoverMaxWidth&&a.push(`max-width: ${o.popoverMaxWidth}`),a.join("; ")});return(a,r)=>(d(),U(u(oe),ce({modelValue:t.value,"onUpdate:modelValue":r[0]||(r[0]=i=>t.value=i)},a.$attrs,{options:a.options,"option-label":"name","option-value":"value",unstyled:"",pt:{root:c(({props:i})=>({class:["h-10 relative inline-flex cursor-pointer select-none items-center","rounded-lg","bg-secondary-background text-base-foreground","border-[2.5px] border-solid border-transparent","transition-all duration-200 ease-in-out","focus-within:border-node-component-border",{"opacity-60 cursor-default":i.disabled}]}),"root"),label:{class:"flex-1 flex items-center whitespace-nowrap pl-4 py-2 outline-hidden"},dropdown:{class:"flex shrink-0 items-center justify-center px-3 py-2"},overlay:{class:u(K)("mt-2 p-2 rounded-lg","bg-base-background text-base-foreground","border border-solid border-border-default")},listContainer:c(()=>({style:`max-height: min(${a.listMaxHeight}, 50vh)`,class:"scrollbar-custom"}),"listContainer"),list:{class:"flex flex-col gap-0 p-0 m-0 list-none border-none text-sm"},option:c(({context:i})=>({class:u(K)("flex items-center justify-between gap-3 px-2 py-3 rounded","hover:bg-secondary-background-hover",i.focused&&"bg-secondary-background-hover",i.selected&&"bg-secondary-background-selected hover:bg-secondary-background-selected")}),"option"),optionLabel:{class:"truncate"},optionGroupLabel:{class:"px-3 py-2 text-xs uppercase tracking-wide text-muted-foreground"},emptyMessage:{class:"px-3 py-2 text-sm text-muted-foreground"}},"aria-label":a.label||u(l)("g.singleSelectDropdown"),role:"combobox","aria-expanded":!1,"aria-haspopup":"listbox",tabindex:0}),{value:I(i=>[n("div",we,[de(a.$slots,"icon"),i.value!==null&&i.value!==void 0?(d(),m("span",$e,f(s(i.value)),1)):(d(),m("span",Me,f(a.label),1))])]),dropdownicon:I(()=>r[1]||(r[1]=[n("i",{class:"icon-[lucide--chevron-down] text-muted-foreground"},null,-1)])),option:I(({option:i,selected:p})=>[n("div",{class:"flex w-full items-center justify-between gap-3",style:q(e.value)},[n("span",Ue,f(i.name),1),p?(d(),m("i",ke)):w("",!0)],4)]),_:3},16,["modelValue","options","pt","aria-label"]))}});function _e(o){const t={loras:"LoRA",ipadapter:"IP-Adapter",sams:"SAM",clip_vision:"CLIP Vision",animatediff_motion_lora:"AnimateDiff Motion LoRA",animatediff_models:"AnimateDiff Model",vae:"VAE",sam2:"SAM 2",controlnet:"ControlNet",gligen:"GLIGEN"};return t[o]?t[o]:o.split("_").map(l=>l.charAt(0).toUpperCase()+l.slice(1)).join(" ")}c(_e,"formatDisplayName");const J=ue(()=>{const{state:o,isLoading:t,error:l,execute:s}=pe(async()=>(await X.getModelFolders()).map(a=>({name:_e(a.name),value:a.name})),[],{immediate:!1,onError:c(e=>{console.error("Failed to fetch model types:",e)},"onError")});return{modelTypes:o,isLoading:t,error:l,fetchModelTypes:s}}),xe={class:"flex flex-col gap-4 text-sm text-muted-foreground"},Se={class:"flex flex-col gap-2"},Le={class:"m-0"},je={class:"flex items-center gap-3 bg-secondary-background p-3 rounded-lg"},Ie=["src","alt"],Be={class:"m-0 text-base-foreground"},Ve={class:"flex flex-col gap-2"},Fe={class:""},Ae={class:"flex items-center gap-2"},Re=C({__name:"UploadModelConfirmation",props:N({metadata:{},previewImage:{}},{modelValue:{},modelModifiers:{}}),emits:["update:modelValue"],setup(o){const t=G(o,"modelValue"),{modelTypes:l,isLoading:s}=J();return(e,a)=>(d(),m("div",xe,[n("div",Se,[n("p",Le,f(e.$t("assetBrowser.modelAssociatedWithLink")),1),n("div",je,[e.previewImage?(d(),m("img",{key:0,src:e.previewImage,alt:e.metadata?.filename||e.metadata?.name||"Model preview",class:"w-14 h-14 rounded object-cover flex-shrink-0"},null,8,Ie)):w("",!0),n("p",Be,f(e.metadata?.filename||e.metadata?.name),1)])]),n("div",Ve,[n("label",Fe,f(e.$t("assetBrowser.modelTypeSelectorLabel")),1),L(Ce,{modelValue:t.value,"onUpdate:modelValue":a[0]||(a[0]=r=>t.value=r),label:u(s)?e.$t("g.loading"):e.$t("assetBrowser.modelTypeSelectorPlaceholder"),options:u(l),disabled:u(s),"data-attr":"upload-model-step2-type-selector"},null,8,["modelValue","label","options","disabled"]),n("div",Ae,[a[1]||(a[1]=n("i",{class:"icon-[lucide--circle-question-mark]"},null,-1)),n("span",null,f(e.$t("assetBrowser.notSureLeaveAsIs")),1)])])]))}}),Te={class:"relative"},De=["aria-label","src"],ze=C({__name:"VideoHelpDialog",props:N({videoUrl:{},ariaLabel:{default:"Help video"}},{modelValue:{type:Boolean,required:!0},modelModifiers:{}}),emits:["update:modelValue"],setup(o){const t=G(o,"modelValue"),l=c(s=>{s.key==="Escape"&&(s.stopImmediatePropagation(),s.stopPropagation(),s.preventDefault(),t.value=!1)},"handleEscapeKey");return z(t,s=>{if(s){const e=me(document,"keydown",l,{capture:!0});fe(e)}},{immediate:!0}),(s,e)=>(d(),U(u(le),{visible:t.value,"onUpdate:visible":e[1]||(e[1]=a=>t.value=a),modal:"",closable:!1,"close-on-escape":!1,"dismissable-mask":!0,pt:{root:{class:"video-help-dialog"},header:{class:"!hidden"},content:{class:"!p-0"},mask:{class:"!bg-black/70"}},style:{width:"90vw",maxWidth:"800px"}},{default:I(()=>[n("div",Te,[L(Y,{class:"absolute top-4 right-6 z-10","aria-label":s.$t("g.close"),onClick:e[0]||(e[0]=a=>t.value=!1)},{default:I(()=>e[2]||(e[2]=[n("i",{class:"pi pi-times text-sm"},null,-1)])),_:1},8,["aria-label"]),n("video",{autoplay:"",muted:"",loop:"","aria-label":s.ariaLabel,class:"w-full rounded-lg",src:s.videoUrl},f(s.$t("g.videoFailedToLoad")),9,De)])]),_:1},8,["visible"]))}}),Ee={class:"flex justify-end gap-2 w-full"},He={key:3},We={key:0,class:"icon-[lucide--loader-circle] animate-spin"},Pe={key:0,class:"icon-[lucide--loader-circle] animate-spin"},qe=C({__name:"UploadModelFooter",props:{currentStep:{},isFetchingMetadata:{type:Boolean},isUploading:{type:Boolean},canFetchMetadata:{type:Boolean},canUploadModel:{type:Boolean},uploadStatus:{}},emits:["back","fetchMetadata","upload","close"],setup(o,{emit:t}){const l=b(!1),s=t;return(e,a)=>(d(),m("div",Ee,[e.currentStep===1?(d(),U(H,{key:0,label:e.$t("assetBrowser.uploadModelHowDoIFindThis"),type:"transparent",size:"md",class:"mr-auto underline text-muted-foreground","data-attr":"upload-model-step1-help-link",onClick:a[0]||(a[0]=r=>l.value=!0)},{icon:I(()=>a[7]||(a[7]=[n("i",{class:"icon-[lucide--circle-question-mark]"},null,-1)])),_:1},8,["label"])):w("",!0),e.currentStep===1?(d(),U(T,{key:1,label:e.$t("g.cancel"),type:"transparent",size:"md","data-attr":"upload-model-step1-cancel-button",disabled:e.isFetchingMetadata||e.isUploading,onClick:a[1]||(a[1]=r=>s("close"))},null,8,["label","disabled"])):w("",!0),e.currentStep!==1&&e.currentStep!==3?(d(),U(T,{key:2,label:e.$t("g.back"),type:"transparent",size:"md","data-attr":`upload-model-step${e.currentStep}-back-button`,disabled:e.isFetchingMetadata||e.isUploading,onClick:a[2]||(a[2]=r=>s("back"))},null,8,["label","data-attr","disabled"])):(d(),m("span",He)),e.currentStep===1?(d(),U(H,{key:4,label:e.$t("g.continue"),type:"secondary",size:"md","data-attr":"upload-model-step1-continue-button",disabled:!e.canFetchMetadata||e.isFetchingMetadata,onClick:a[3]||(a[3]=r=>s("fetchMetadata"))},{icon:I(()=>[e.isFetchingMetadata?(d(),m("i",We)):w("",!0)]),_:1},8,["label","disabled"])):e.currentStep===2?(d(),U(H,{key:5,label:e.$t("assetBrowser.upload"),type:"secondary",size:"md","data-attr":"upload-model-step2-confirm-button",disabled:!e.canUploadModel||e.isUploading,onClick:a[4]||(a[4]=r=>s("upload"))},{icon:I(()=>[e.isUploading?(d(),m("i",Pe)):w("",!0)]),_:1},8,["label","disabled"])):e.currentStep===3&&e.uploadStatus==="success"?(d(),U(T,{key:6,label:e.$t("assetBrowser.finish"),type:"secondary",size:"md","data-attr":"upload-model-step3-finish-button",onClick:a[5]||(a[5]=r=>s("close"))},null,8,["label"])):w("",!0),L(ze,{modelValue:l.value,"onUpdate:modelValue":a[6]||(a[6]=r=>l.value=r),"video-url":"https://media.comfy.org/compressed_768/civitai_howto.webm","aria-label":e.$t("assetBrowser.uploadModelHelpVideo")},null,8,["modelValue","aria-label"])]))}}),Oe={class:"flex flex-1 flex-col gap-6 text-sm text-muted-foreground"},Ne={key:0,class:"flex flex-1 flex-col items-center justify-center gap-2"},Ge={class:"text-center"},Ke={class:"m-0 font-bold"},Ze={key:1,class:"flex flex-col gap-2"},Je={class:"m-0 font-bold"},Qe={class:"m-0"},Xe={class:"flex flex-row items-center gap-3 p-4 bg-modal-card-background rounded-lg"},Ye=["src","alt"],et={class:"flex flex-col justify-center items-start gap-1 flex-1"},tt={class:"text-base-foreground m-0"},at={class:"text-sm text-muted m-0"},st={key:2,class:"flex flex-1 flex-col items-center justify-center gap-6"},ot={class:"text-center"},lt={class:"m-0 text-sm font-bold"},rt={key:0,class:"text-sm text-muted mb-0"},nt=C({__name:"UploadModelProgress",props:{status:{},error:{},metadata:{},modelType:{},previewImage:{}},setup(o){return(t,l)=>(d(),m("div",Oe,[t.status==="uploading"?(d(),m("div",Ne,[l[0]||(l[0]=n("i",{class:"icon-[lucide--loader-circle] animate-spin text-6xl text-muted-foreground"},null,-1)),n("div",Ge,[n("p",Ke,f(t.$t("assetBrowser.uploadingModel")),1)])])):t.status==="success"?(d(),m("div",Ze,[n("p",Je,f(t.$t("assetBrowser.modelUploaded")),1),n("p",Qe,f(t.$t("assetBrowser.findInLibrary",{type:t.modelType})),1),n("div",Xe,[t.previewImage?(d(),m("img",{key:0,src:t.previewImage,alt:t.metadata?.filename||t.metadata?.name||"Model preview",class:"w-14 h-14 rounded object-cover flex-shrink-0"},null,8,Ye)):w("",!0),n("div",et,[n("p",tt,f(t.metadata?.filename||t.metadata?.name),1),n("p",at,f(t.modelType),1)])])])):t.status==="error"?(d(),m("div",st,[l[1]||(l[1]=n("i",{class:"icon-[lucide--x-circle] text-6xl text-error"},null,-1)),n("div",ot,[n("p",lt,f(t.$t("assetBrowser.uploadFailed")),1),t.error?(d(),m("p",rt,f(t.error),1)):w("",!0)])])):w("",!0)]))}}),it={class:"flex flex-col gap-6 text-sm text-muted-foreground"},dt={class:"flex flex-col gap-2"},ct={class:"m-0"},ut={class:"list-disc space-y-1 pl-5 mt-0"},pt=["innerHTML"],mt=["innerHTML"],ft={class:"flex flex-col gap-2"},vt=["innerHTML"],gt={key:0,class:"text-xs text-error"},ht=["innerHTML"],bt=C({__name:"UploadModelUrlInput",props:{modelValue:{},error:{}},emits:["update:modelValue"],setup(o,{emit:t}){const l=o,s=t,e=V({get:c(()=>l.modelValue,"get"),set:c(a=>s("update:modelValue",a),"set")});return(a,r)=>(d(),m("div",it,[n("div",dt,[n("p",ct,f(a.$t("assetBrowser.uploadModelDescription1")),1),n("ul",ut,[n("li",{innerHTML:a.$t("assetBrowser.uploadModelDescription2")},null,8,pt),n("li",{innerHTML:a.$t("assetBrowser.uploadModelDescription3")},null,8,mt)])]),n("div",ft,[n("label",{class:"mb-0",innerHTML:a.$t("assetBrowser.civitaiLinkLabel")},null,8,vt),L(u(re),{modelValue:e.value,"onUpdate:modelValue":r[0]||(r[0]=i=>e.value=i),autofocus:"",placeholder:a.$t("assetBrowser.civitaiLinkPlaceholder"),class:"w-full bg-secondary-background border-0 p-4","data-attr":"upload-model-step1-url-input"},null,8,["modelValue","placeholder"]),a.error?(d(),m("p",gt,f(a.error),1)):(d(),m("p",{key:1,innerHTML:a.$t("assetBrowser.civitaiLinkExample")},null,8,ht))])]))}});function yt(o){const t=ee(),l=te(),s=b(1),e=b(!1),a=b(!1),r=b("idle"),i=b(""),p=b({url:"",name:"",tags:[]}),g=b();z(()=>p.value.url,()=>{i.value=""});const _=V(()=>p.value.url.trim().length>0),y=V(()=>!!g.value);function k($){try{const v=new URL($).hostname.toLowerCase();return v==="civitai.com"||v.endsWith(".civitai.com")}catch{return!1}}c(k,"isCivitaiUrl");async function h(){if(!_.value)return;let $=p.value.url.trim();try{$=new URL(encodeURI($)).toString()}catch{}if(p.value.url=$,!k(p.value.url)){i.value=Z("assetBrowser.onlyCivitaiUrlsSupported","Only Civitai URLs are supported");return}e.value=!0;try{const v=await W.getAssetMetadata(p.value.url);if(p.value.metadata=v,p.value.name=v.filename||v.name||"",p.value.previewImage=v.preview_image,v.tags&&v.tags.length>0){p.value.tags=v.tags;const B=v.tags.find(x=>o.value.some(j=>j.value===x));B&&(g.value=B)}s.value=2}catch(v){console.error("Failed to retrieve metadata:",v),i.value=v instanceof Error?v.message:Z("assetBrowser.uploadModelFailedToRetrieveMetadata","Failed to retrieve metadata. Please check the link and try again."),s.value=1}finally{e.value=!1}}c(h,"fetchMetadata");async function M(){if(y.value){a.value=!0,r.value="uploading";try{const $=g.value?["models",g.value]:["models"],v=p.value.metadata?.filename||p.value.metadata?.name||"model";let B;if(p.value.previewImage)try{const x=v.split(".")[0];let j="png";const A=p.value.previewImage.match(/^data:image\/([^;]+);/);A&&(j=A[1]==="jpeg"?"jpg":A[1]),B=(await W.uploadAssetFromBase64({data:p.value.previewImage,name:`${x}_preview.${j}`,tags:["preview"]})).id}catch(x){console.error("Failed to upload preview image:",x)}if(await W.uploadAssetFromUrl({url:p.value.url,name:v,tags:$,user_metadata:{source:"civitai",source_url:p.value.url,model_type:g.value},preview_id:B}),r.value="success",s.value=3,g.value){const x=l.getAllNodeProviders(g.value);await Promise.all(x.map(j=>t.updateModelsForNodeType(j.nodeDef.name)))}return!0}catch($){return console.error("Failed to upload asset:",$),r.value="error",i.value=$ instanceof Error?$.message:"Failed to upload model",s.value=3,!1}finally{a.value=!1}}}c(M,"uploadModel");function F(){s.value>1&&(s.value=s.value-1)}return c(F,"goToPreviousStep"),{currentStep:s,isFetchingMetadata:e,isUploading:a,uploadStatus:r,uploadError:i,wizardData:p,selectedModelType:g,canFetchMetadata:_,canUploadModel:y,fetchMetadata:h,uploadModel:M,goToPreviousStep:F}}c(yt,"useUploadModelWizard");const wt={class:"upload-model-dialog flex flex-col justify-between gap-6 p-4 pt-6 border-t border-border-default"},$t=C({__name:"UploadModelDialog",emits:["upload-success"],setup(o,{emit:t}){const l=O(),{modelTypes:s,fetchModelTypes:e}=J(),a=t,{currentStep:r,isFetchingMetadata:i,isUploading:p,uploadStatus:g,uploadError:_,wizardData:y,selectedModelType:k,canFetchMetadata:h,canUploadModel:M,fetchMetadata:F,uploadModel:$,goToPreviousStep:v}=yt(s);async function B(){await F()}c(B,"handleFetchMetadata");async function x(){await $()&&a("upload-success")}c(x,"handleUploadModel");function j(){l.closeDialog({key:"upload-model"})}return c(j,"handleClose"),ve(()=>{e()}),(A,R)=>(d(),m("div",wt,[u(r)===1?(d(),U(bt,{key:0,modelValue:u(y).url,"onUpdate:modelValue":R[0]||(R[0]=E=>u(y).url=E),error:u(_)},null,8,["modelValue","error"])):u(r)===2?(d(),U(Re,{key:1,modelValue:u(k),"onUpdate:modelValue":R[1]||(R[1]=E=>ge(k)?k.value=E:null),metadata:u(y).metadata,"preview-image":u(y).previewImage},null,8,["modelValue","metadata","preview-image"])):u(r)===3?(d(),U(nt,{key:2,status:u(g),error:u(_),metadata:u(y).metadata,"model-type":u(k),"preview-image":u(y).previewImage},null,8,["status","error","metadata","model-type","preview-image"])):w("",!0),L(qe,{"current-step":u(r),"is-fetching-metadata":u(i),"is-uploading":u(p),"can-fetch-metadata":u(h),"can-upload-model":u(M),"upload-status":u(g),onBack:u(v),onFetchMetadata:B,onUpload:x,onClose:j},null,8,["current-step","is-fetching-metadata","is-uploading","can-fetch-metadata","can-upload-model","upload-status","onBack"])]))}}),Mt=D($t,[["__scopeId","data-v-d6449e84"]]),Ut=""+new URL("images/civitai.svg",import.meta.url).href,kt={},Ct={class:"flex items-center gap-2 p-4 font-bold"},_t={class:"rounded-full bg-white px-1.5 py-0 text-xxs font-inter font-semibold uppercase text-black"};function xt(o,t){return d(),m("div",Ct,[t[0]||(t[0]=n("img",{src:Ut,class:"size-4"},null,-1)),n("span",null,f(o.$t("assetBrowser.uploadModelFromCivitai")),1),n("span",_t,f(o.$t("g.beta")),1)])}c(xt,"_sfc_render$2");const St=D(kt,[["render",xt]]),Lt={},jt={class:"flex flex-1 flex-col items-center justify-center text-base text-muted-foreground"},It={class:"m-0 max-w-md"};function Bt(o,t){return d(),m("div",jt,[n("p",It,f(o.$t("assetBrowser.upgradeFeatureDescription")),1)])}c(Bt,"_sfc_render$1");const Vt=D(Lt,[["render",Bt]]),Ft={class:"flex flex-wrap justify-end gap-2 w-full"},At={href:"https://blog.comfy.org/p/comfy-cloud-new-features-and-pricing",target:"_blank",rel:"noopener noreferrer",class:"text-muted-foreground mr-auto underline flex items-center gap-2"},Rt=C({__name:"UploadModelUpgradeModalFooter",emits:["close","subscribe"],setup(o,{emit:t}){const l=t;return(s,e)=>(d(),m("div",Ft,[n("a",At,[e[2]||(e[2]=n("i",{class:"icon-[lucide--external-link]"},null,-1)),n("span",null,f(s.$t("g.learnMore")),1)]),L(T,{label:s.$t("g.close"),type:"transparent",size:"md",onClick:e[0]||(e[0]=a=>l("close"))},null,8,["label"]),L(T,{label:s.$t("subscription.required.subscribe"),type:"secondary",size:"md",onClick:e[1]||(e[1]=a=>l("subscribe"))},null,8,["label"])]))}}),Tt={class:"flex flex-col justify-between gap-10 p-4 border-t border-border-default w-auto max-w-[min(500px,90vw)]"},Dt=C({__name:"UploadModelUpgradeModal",setup(o){const t=O(),{showSubscriptionDialog:l}=ae();function s(){t.closeDialog({key:"upload-model-upgrade"})}c(s,"handleClose");function e(){l()}return c(e,"handleSubscribe"),(a,r)=>(d(),m("div",Tt,[L(Vt),L(Rt,{onClose:s,onSubscribe:e})]))}}),zt={},Et={class:"flex items-center gap-2 p-4 font-bold"};function Ht(o,t){return d(),m("div",Et,[n("span",null,f(o.$t("assetBrowser.upgradeToUnlockFeature")),1)])}c(Ht,"_sfc_render");const Wt=D(zt,[["render",Ht]]);function ta(o){const t=O(),{flags:l}=se(),s=V(()=>l.modelUploadButtonEnabled);function e(){l.privateModelsEnabled?t.showDialog({key:"upload-model",headerComponent:St,component:Mt,props:{onUploadSuccess:c(async()=>{await o?.()},"onUploadSuccess")},dialogComponentProps:{pt:{header:"py-0! pl-0!",content:"p-0!"}}}):t.showDialog({key:"upload-model-upgrade",headerComponent:Wt,component:Dt,dialogComponentProps:{pt:{header:"py-0! pl-0!",content:"p-0!"}}})}return c(e,"showUploadDialog"),{isUploadButtonEnabled:s,showUploadDialog:e}}c(ta,"useModelUpload");const Pt=""+new URL("images/default-template.png",import.meta.url).href;function qt(o,t,l={}){const{immediate:s=!0,...e}=l,a=typeof window<"u"&&"IntersectionObserver"in window,r=b(!1);let i=null;const p=c(()=>{i&&(i.disconnect(),i=null)},"cleanup"),g=c(()=>{p(),!(!a||!o.value)&&(i=new IntersectionObserver(y=>{r.value=y.some(k=>k.isIntersecting),t(y,i)},e),i.observe(o.value))},"observe"),_=c(()=>{i&&o.value&&i.unobserve(o.value)},"unobserve");return s&&z(o,g,{immediate:!0,flush:"post"}),he(p),{isSupported:a,isIntersecting:r,observe:g,unobserve:_,cleanup:p}}c(qt,"useIntersectionObserver");class Ot{static{c(this,"MediaCacheService")}cache=be(new Map);maxSize;maxAge;cleanupInterval=null;urlRefCount=new Map;constructor(t={}){this.maxSize=t.maxSize??100,this.maxAge=t.maxAge??30*60*1e3,this.startCleanupInterval()}startCleanupInterval(){this.cleanupInterval=window.setInterval(()=>{this.cleanup()},5*60*1e3)}cleanup(){const t=Date.now(),l=[];for(const[s,e]of Array.from(this.cache.entries()))t-e.lastAccessed>this.maxAge&&(e.objectUrl?(this.urlRefCount.get(e.objectUrl)||0)===0&&(URL.revokeObjectURL(e.objectUrl),this.urlRefCount.delete(e.objectUrl),l.push(s)):l.push(s));if(l.forEach(s=>this.cache.delete(s)),this.cache.size>this.maxSize){const s=Array.from(this.cache.entries());s.sort((r,i)=>r[1].lastAccessed-i[1].lastAccessed);let e=0;const a=this.cache.size-this.maxSize;for(const[r,i]of s){if(e>=a)break;i.objectUrl?(this.urlRefCount.get(i.objectUrl)||0)===0&&(URL.revokeObjectURL(i.objectUrl),this.urlRefCount.delete(i.objectUrl),this.cache.delete(r),e++):(this.cache.delete(r),e++)}}}async getCachedMedia(t){let l=this.cache.get(t);if(l)return l.lastAccessed=Date.now(),l;l={src:t,isLoading:!0,lastAccessed:Date.now()},this.cache.set(t,l);try{const s=await fetch(t,{cache:"force-cache"});if(!s.ok)throw new Error(`Failed to fetch: ${s.status}`);const e=await s.blob(),a=URL.createObjectURL(e),r={src:t,blob:e,objectUrl:a,isLoading:!1,lastAccessed:Date.now()};return this.cache.set(t,r),r}catch(s){console.warn("Failed to cache media:",t,s);const e={src:t,error:!0,isLoading:!1,lastAccessed:Date.now()};return this.cache.set(t,e),e}}acquireUrl(t){const l=this.cache.get(t);if(l?.objectUrl){const s=this.urlRefCount.get(l.objectUrl)||0;return this.urlRefCount.set(l.objectUrl,s+1),l.objectUrl}}releaseUrl(t){const l=this.cache.get(t);if(l?.objectUrl){const s=(this.urlRefCount.get(l.objectUrl)||1)-1;s<=0?(URL.revokeObjectURL(l.objectUrl),this.urlRefCount.delete(l.objectUrl),this.cache.delete(t)):this.urlRefCount.set(l.objectUrl,s)}}clearCache(){for(const t of Array.from(this.cache.values()))t.objectUrl&&URL.revokeObjectURL(t.objectUrl);this.cache.clear(),this.urlRefCount.clear()}destroy(){this.cleanupInterval&&(clearInterval(this.cleanupInterval),this.cleanupInterval=null),this.clearCache()}}let S=null;function Nt(o){return S||(S=new Ot(o)),{getCachedMedia:c(a=>S.getCachedMedia(a),"getCachedMedia"),clearCache:c(()=>S.clearCache(),"clearCache"),acquireUrl:c(a=>S.acquireUrl(a),"acquireUrl"),releaseUrl:c(a=>S.releaseUrl(a),"releaseUrl"),cache:S.cache}}c(Nt,"useMediaCache");typeof window<"u"&&window.addEventListener("beforeunload",()=>{S&&S.destroy()});const Gt=["src","alt"],Kt={key:2,class:"absolute inset-0 flex items-center justify-center"},Zt=["alt"],aa=C({__name:"LazyImage",props:{src:{},alt:{default:""},containerClass:{type:[Array,Object,String,Number,null,Boolean],default:""},imageClass:{type:[Array,Object,String,Number,null,Boolean],default:""},imageStyle:{},rootMargin:{default:"300px"}},setup(o){const t=b(null),l=b(null),s=b(!1),e=b(!1),a=b(!1),r=b(void 0),{getCachedMedia:i,acquireUrl:p,releaseUrl:g}=Nt();qt(t,h=>{const M=h[0];s.value=M?.isIntersecting??!1},{rootMargin:o.rootMargin,threshold:.1});const _=V(()=>s.value);z(_,async h=>{if(h&&o.src&&!r.value&&!a.value)try{const M=await i(o.src);if(M.error)a.value=!0;else if(M.objectUrl){const F=p(o.src);r.value=F||M.objectUrl}else r.value=o.src}catch(M){console.warn("Failed to load cached media:",M),r.value=o.src}else h||(r.value?.startsWith("blob:")&&g(o.src),e.value=!1,r.value=void 0,a.value=!1)},{immediate:!0});const y=c(()=>{e.value=!0,a.value=!1},"onImageLoad"),k=c(()=>{a.value=!0,e.value=!1},"onImageError");return ye(()=>{r.value?.startsWith("blob:")&&g(o.src)}),(h,M)=>(d(),m("div",{ref_key:"containerRef",ref:t,class:P(["relative flex h-full w-full items-center justify-center overflow-hidden",h.containerClass])},[e.value?w("",!0):(d(),U(u(ne),{key:0,width:"100%",height:"100%",class:"absolute inset-0"})),r.value?(d(),m("img",{key:1,ref_key:"imageRef",ref:l,src:r.value,alt:h.alt,draggable:"false",class:P(h.imageClass),style:q(h.imageStyle),onLoad:y,onError:k},null,46,Gt)):w("",!0),a.value?(d(),m("div",Kt,[n("img",{src:Pt,alt:h.alt,draggable:"false",class:P(h.imageClass),style:q(h.imageStyle)},null,14,Zt)])):w("",!0)],2))}});export{Ce as _,Pt as a,aa as b,qt as c,ta as u};
//# sourceMappingURL=LazyImage.vue_vue_type_script_setup_true_lang-BscHn65F.js.map

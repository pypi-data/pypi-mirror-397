<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ 'Edit' if action == 'edit' else 'Add' }} Firewall - FireLens Admin</title>
    <link rel="stylesheet" href="/static/css/admin.css">
    <style>
        .rename-warning {
            background: var(--warning-bg);
            color: var(--warning-text);
            padding: 10px 12px;
            border-radius: 6px;
            margin-top: 8px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
    </style>
</head>
<body>
    <div class="header-simple">
        <h1><img src="/static/img/firelens-transparent-logo-darkmode.png" alt="FireLens" class="header-logo"><span>FireLens</span> Admin</h1>
        <div class="header-right">
            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark mode">
                <svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
                <svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="display: none;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                </svg>
            </button>
        </div>
    </div>

    <div class="admin-layout">
        <aside class="admin-sidebar">
            <nav>
                <div class="sidebar-section">Management</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item">
                        <a href="/admin" class="active">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z" />
                            </svg>
                            Firewalls
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="/admin/certificates">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z" />
                            </svg>
                            Certificates
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="/admin/ssl">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                            </svg>
                            SSL/TLS
                        </a>
                    </li>
                </ul>
                <div class="sidebar-divider"></div>
                <div class="sidebar-section">Authentication</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item">
                        <a href="/admin/saml">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                            </svg>
                            SAML/SSO
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="/admin/password">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                            </svg>
                            Password
                        </a>
                    </li>
                </ul>
                <div class="sidebar-divider"></div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item">
                        <a href="/">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                            </svg>
                            View Dashboard
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <main class="admin-main">
            <div class="breadcrumb">
                <a href="/admin">Admin</a>
                <span>&rsaquo;</span>
                <span>{{ 'Edit' if action == 'edit' else 'Add' }} Firewall</span>
            </div>

            <div class="card padded" style="max-width: 800px;">
            <h2>{{ 'Edit Firewall: ' + firewall.name if action == 'edit' else 'Add New Firewall' }}</h2>

            <div class="error-message" id="errorMessage"></div>

            <form id="firewallForm" onsubmit="submitForm(event)">
                <!-- Connection Settings -->
                <div class="form-section">
                    <h3>Connection Settings</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="name">Name <span class="required">*</span></label>
                            <input type="text" id="name" name="name"
                                   value="{{ firewall.name if firewall else '' }}"
                                   pattern="^[a-zA-Z0-9_]+$"
                                   required>
                            <small>Letters, numbers, and underscores only</small>
                            <div id="renameWarning" class="rename-warning" style="display: none;">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 16px; height: 16px; vertical-align: middle;">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                                Renaming will update all historical metrics to use the new name.
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="type">Vendor Type <span class="required">*</span></label>
                            <select id="type" name="type" required onchange="onVendorTypeChange()">
                                {% for vtype in vendor_types %}
                                <option value="{{ vtype }}" {{ 'selected' if firewall and firewall.type == vtype else '' }}>
                                    {{ vtype }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <label for="host">Host URL <span class="required">*</span></label>
                        <input type="url" id="host" name="host"
                               value="{{ firewall.host if firewall else 'https://' }}"
                               placeholder="https://192.168.1.1"
                               required>
                        <small>Full URL including https://</small>
                    </div>
                    <div class="form-row">
                        <div class="form-group" id="usernameGroup">
                            <label for="username">Username <span class="required" id="usernameRequired">*</span></label>
                            <input type="text" id="username" name="username"
                                   value="{{ firewall.username if firewall else '' }}"
                                   required>
                            <small id="usernameHelp"></small>
                        </div>
                        <div class="form-group">
                            <label for="password" id="passwordLabel">Password <span class="required">*</span></label>
                            <input type="password" id="password" name="password"
                                   value="{{ firewall.password if firewall else '' }}"
                                   required>
                            <small id="passwordHelp"></small>
                        </div>
                    </div>
                    <!-- Fortinet VDOM field -->
                    <div class="form-group" id="vdomGroup" style="display: none;">
                        <label for="vdom">VDOM (Virtual Domain)</label>
                        <input type="text" id="vdom" name="vdom"
                               value="{{ firewall.vdom if firewall and firewall.vdom else 'root' }}"
                               placeholder="root">
                        <small>FortiGate Virtual Domain name (default: root)</small>
                    </div>
                    <!-- Cisco Firepower fields -->
                    <div id="ciscoFirepowerGroup" style="display: none;">
                        <div class="form-group">
                            <label for="management_mode">Management Mode <span class="required">*</span></label>
                            <select id="management_mode" name="management_mode" onchange="onManagementModeChange()">
                                <option value="fdm" {{ 'selected' if not firewall or firewall.management_mode == 'fdm' else '' }}>FDM (Local Device Management)</option>
                                <option value="fmc" {{ 'selected' if firewall and firewall.management_mode == 'fmc' else '' }}>FMC (Firepower Management Center)</option>
                            </select>
                            <small>FDM: Direct device access | FMC: Centralized management for multiple devices</small>
                        </div>
                        <!-- FMC Device Selection (shown when FMC mode selected) -->
                        <div id="fmcDeviceSection" style="display: none;">
                            <div class="form-group">
                                <label>Select Device to Monitor</label>
                                <div class="fmc-device-controls">
                                    <button type="button" class="btn btn-discover" onclick="discoverFMCDevices()">
                                        <span id="discoverFMCBtnText">Discover Devices</span>
                                        <span id="discoverFMCSpinner" class="spinner" style="display: none;"></span>
                                    </button>
                                </div>
                                <div id="fmcDiscoverResult" class="discover-result"></div>
                                <div id="fmcDeviceList" class="fmc-device-list" style="display: none;">
                                    <table class="interface-table">
                                        <thead>
                                            <tr>
                                                <th style="width: 50px;">Select</th>
                                                <th>Device Name</th>
                                                <th>Model</th>
                                                <th>Status</th>
                                                <th>Version</th>
                                            </tr>
                                        </thead>
                                        <tbody id="fmcDeviceTableBody">
                                        </tbody>
                                    </table>
                                </div>
                                <input type="hidden" id="device_id" name="device_id"
                                       value="{{ firewall.device_id if firewall and firewall.device_id else '' }}">
                                <input type="hidden" id="device_name" name="device_name"
                                       value="{{ firewall.device_name if firewall and firewall.device_name else '' }}">
                                <div id="selectedDeviceInfo" class="selected-device-info" style="display: none;">
                                    <strong>Selected Device:</strong> <span id="selectedDeviceName"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="verify_ssl" name="verify_ssl"
                                       {{ 'checked' if not firewall or firewall.verify_ssl else '' }}>
                                <label for="verify_ssl">Verify SSL Certificate</label>
                            </div>
                            <small>Uncheck for self-signed certificates</small>
                        </div>
                        <div class="form-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="enabled" name="enabled"
                                       {{ 'checked' if not firewall or firewall.enabled else '' }}>
                                <label for="enabled">Enable Monitoring</label>
                            </div>
                        </div>
                    </div>

                    <!-- Test Connection Button -->
                    <div class="test-connection-section">
                        <button type="button" class="btn btn-test" onclick="testConnection()">
                            <span id="testBtnText">Test Connection</span>
                            <span id="testSpinner" class="spinner" style="display: none;"></span>
                        </button>
                        <div id="testResult" class="test-result"></div>
                    </div>
                </div>

                <!-- Collection Settings -->
                <div class="form-section">
                    <h3>Collection Settings</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="poll_interval">Poll Interval (seconds)</label>
                            <input type="number" id="poll_interval" name="poll_interval"
                                   value="{{ firewall.poll_interval if firewall else 60 }}"
                                   min="1" max="3600">
                            <small>Recommended: 30-60 seconds</small>
                        </div>
                        <!-- Palo Alto specific: DP CPU Aggregation -->
                        <div class="form-group" id="dpAggregationGroup">
                            <label for="dp_aggregation">DP CPU Aggregation</label>
                            <select id="dp_aggregation" name="dp_aggregation">
                                <option value="mean" {{ 'selected' if not firewall or firewall.dp_aggregation == 'mean' else '' }}>Mean</option>
                                <option value="max" {{ 'selected' if firewall and firewall.dp_aggregation == 'max' else '' }}>Max</option>
                                <option value="p95" {{ 'selected' if firewall and firewall.dp_aggregation == 'p95' else '' }}>P95</option>
                            </select>
                            <small>How to aggregate data plane CPU metrics (Palo Alto only)</small>
                        </div>
                    </div>
                </div>

                <!-- Interface Monitoring -->
                <div class="form-section">
                    <h3>Interface Monitoring</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="interface_monitoring" name="interface_monitoring"
                                       {{ 'checked' if not firewall or firewall.interface_monitoring else '' }}>
                                <label for="interface_monitoring">Enable Interface Monitoring</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="auto_discover_interfaces" name="auto_discover_interfaces"
                                       {{ 'checked' if not firewall or firewall.auto_discover_interfaces else '' }}
                                       onchange="toggleInterfaceConfig()">
                                <label for="auto_discover_interfaces">Auto-discover Interfaces</label>
                            </div>
                            <small>When enabled, all interfaces are discovered and monitored automatically</small>
                        </div>
                    </div>

                    <!-- Auto-discover exclusion settings (shown when auto-discover is ON) -->
                    <div class="form-group full-width" id="excludeSection">
                        <label for="exclude_interfaces">Exclude Interfaces</label>
                        <textarea id="exclude_interfaces" name="exclude_interfaces"
                                  placeholder="mgmt&#10;loopback&#10;tunnel&#10;ha1&#10;ha2">{% if firewall and firewall.exclude_interfaces %}{% for iface in firewall.exclude_interfaces %}{{ iface }}{% if not loop.last %}
{% endif %}{% endfor %}{% else %}mgmt
loopback
tunnel
ha1
ha2{% endif %}</textarea>
                        <small>One pattern per line. Interfaces matching these patterns will be excluded.</small>
                    </div>

                    <!-- Manual interface configuration (shown when auto-discover is OFF) -->
                    <div class="interface-section" id="interfaceConfigSection">
                        <div class="interface-header">
                            <div>
                                <button type="button" class="btn btn-discover" onclick="discoverInterfaces()">
                                    <span id="discoverBtnText">Discover Interfaces</span>
                                    <span id="discoverSpinner" class="spinner" style="display: none;"></span>
                                </button>
                            </div>
                            <div class="interface-count" id="interfaceCount"></div>
                        </div>
                        <div id="discoverResult" class="discover-result"></div>

                        <div class="interface-container" id="interfaceContainer">
                            <div class="interface-empty" id="interfaceEmpty">
                                <p>No interfaces configured.</p>
                                <p><small>Click "Discover Interfaces" to enumerate interfaces from the firewall,<br>or they will be discovered automatically when monitoring starts.</small></p>
                            </div>
                            <table class="interface-table" id="interfaceTable" style="display: none;">
                                <thead>
                                    <tr>
                                        <th style="width: 50px;">
                                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" title="Select/Deselect All">
                                        </th>
                                        <th style="width: 150px;">Interface</th>
                                        <th style="width: 200px;">Display Name</th>
                                        <th>Description</th>
                                    </tr>
                                </thead>
                                <tbody id="interfaceTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <a href="/admin" class="btn btn-secondary">Cancel</a>
                    <button type="submit" class="btn btn-primary">
                        {{ 'Save Changes' if action == 'edit' else 'Add Firewall' }}
                    </button>
                </div>
            </form>
            </div>
        </main>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script src="/static/js/admin-theme.js"></script>
    <script>
        // Pass template variables to JavaScript
        window.firewallFormConfig = {
            isEdit: {{ (action == 'edit') | tojson }},
            firewallName: {{ (firewall.name if firewall else '') | tojson }},
            originalName: {{ (firewall.name if firewall else '') | tojson }},
            csrfToken: {{ csrf_token | tojson }},
            interfaceConfigs: {{ firewall.interface_configs | tojson if firewall and firewall.interface_configs else '[]' }},
            vendorType: {{ (firewall.type if firewall else 'palo_alto') | tojson }},
            vdom: {{ (firewall.vdom if firewall and firewall.vdom else 'root') | tojson }},
            managementMode: {{ (firewall.management_mode if firewall and firewall.management_mode else 'fdm') | tojson }},
            deviceId: {{ (firewall.device_id if firewall and firewall.device_id else '') | tojson }},
            deviceName: {{ (firewall.device_name if firewall and firewall.device_name else '') | tojson }}
        };
    </script>
    <script src="/static/js/admin-firewall-form.js"></script>
</body>
</html>

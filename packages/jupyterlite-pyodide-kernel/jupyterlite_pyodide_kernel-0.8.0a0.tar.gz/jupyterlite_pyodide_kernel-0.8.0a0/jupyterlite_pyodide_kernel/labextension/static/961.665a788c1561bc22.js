"use strict";(self.webpackChunk_jupyterlite_pyodide_kernel_extension=self.webpackChunk_jupyterlite_pyodide_kernel_extension||[]).push([["961"],{320(e,t,a){a.r(t),a.d(t,{LiteTranslatorConnector:()=>g,IWorkspaceRouter:()=>k,LiteWorkspaceManager:()=>y,IServiceWorkerManager:()=>v,ServiceWorkerManager:()=>x,SERVICE_WORKER_BROADCAST_CHANNEL_ID:()=>L,LitePluginListModel:()=>c,LiteLicensesClient:()=>o,WORKER_NAME:()=>_,IndexedDBDataConnector:()=>p,THIRD_PARTY_LICENSES:()=>i});var s=a(206),r=a(846);let i="third-party-licenses.json",n=Object.freeze({packages:[]});class o extends s.Licenses.LicensesClient{async getBundles(){return{bundles:{...await this._getFederated(),[this.appName]:await this._getAppLicenses()}}}async download(e){let t=document.createElement("a");t.href=await this._getDownloadLink(e);let a="markdown"===e.format?"md":e.format;t.download=`jupyterlite-licenses.${a}`,document.body.appendChild(t),t.click(),document.body.removeChild(t)}get appName(){return r.PageConfig.getOption("appName")||"JupyterLite"}get appLicensesUrl(){return r.URLExt.join(r.PageConfig.getBaseUrl(),"build",i)}get labExtensionsUrl(){return r.PageConfig.getOption("fullLabextensionsUrl")}async _getDownloadLink(e){let t,a,s=await this.getBundles();switch(e.format){case"json":default:t=JSON.stringify(s,null,2),a="application/json";break;case"markdown":t=this._formatAsMarkdown(s),a="text/markdown";break;case"csv":t=this._formatAsCSV(s),a="text/csv"}let r=new Blob([t],{type:a});return URL.createObjectURL(r)}_formatAsMarkdown(e){let t="# Third-Party Licenses\n\n";for(let[a,s]of Object.entries(e.bundles))for(let e of(t+=`## ${a}

`,s.packages))t+=`### ${e.name}${e.versionInfo?` ${e.versionInfo}`:""}

`,e.licenseId&&(t+=`**License ID:** ${e.licenseId}

`),e.extractedText&&(t+=`\`\`\`
${e.extractedText}
\`\`\`

`);return t}_formatAsCSV(e){let t=`Bundle,Package,Version,License ID,License Text
`;for(let[a,s]of Object.entries(e.bundles))for(let e of s.packages){let s=[this._escapeCSVField(a),this._escapeCSVField(e.name),this._escapeCSVField(e.versionInfo||""),this._escapeCSVField(e.licenseId||""),this._escapeCSVField(e.extractedText||"")];t+=`${s.join(",")}
`}return t}_escapeCSVField(e){return e&&(e.includes(",")||e.includes('"')||e.includes("\n"))?`"${e.replace(/"/g,'""')}"`:e}async _getAppLicenses(){let e=n;try{e=(await fetch(this.appLicensesUrl)).json()}catch(e){console.warn("Could not resolve licenses for",this.appName)}return e}async _getFederated(){let e,t={};try{e=JSON.parse(r.PageConfig.getOption("federated_extensions"))}catch{return t}let a=[];for(let s of e)a.push(this._getOneFederated(s,t));try{await Promise.all(a)}catch(e){console.warn("Error resolving licenses",e)}return t}async _getOneFederated(e,t){try{let a=r.URLExt.join(this.labExtensionsUrl,e.name,"static",i),s=await fetch(a);t[e.name]=await s.json()}catch{console.warn("Could not resolve licenses for",e),t[e.name]=n}}}var l=a(342);class c extends l.PluginListModel{constructor(e){super(e),this._availablePlugins=e.pluginData.availablePlugins.map(e=>{let t=e.provides?e.provides.name.split(":")[1]:void 0;return e.provides&&!t&&(t=e.provides.name),{...e,tokenLabel:t,locked:!0,enabled:!0}})}get available(){return this._availablePlugins}async refresh(){}async enable(e){}async disable(e){}}var d=a(381);class g extends d.DataConnector{constructor(){super(...arguments),this._prevLocale=""}async fetch(e){var t;let a=null!=(t=null==e?void 0:e.language)?t:"",s=a;"default"===a?s="en":""===a&&(s="all");let i=r.URLExt.join(r.PageConfig.getBaseUrl(),`api/translations/${s}.json`);try{let e=await fetch(i),t=JSON.parse(await e.text());if("all"!==this._prevLocale&&"all"===s){let e=this._prevLocale;t.data[e].displayName=t.data[e].nativeName,"en"!==e&&(t.data.en.displayName=`${t.data.en.nativeName} (default)`)}return this._prevLocale=s,t}catch(e){if(s)return{data:{},message:`Language pack '${s}' not installed!`};return{data:{en:{displayName:"English",nativeName:"English"}},message:""}}}}var h=a(370);let u="JupyterLite Storage";class p{constructor(e){this._storageName=u,this._storageDrivers=null,this._localforage=e.localforage,this._storageName=e.storageName||u,this._storageDrivers=e.storageDrivers||null,this._ready=new h.PromiseDelegate,this.initialize().catch(console.warn)}async initialize(){await this.initStorage(),this._ready.resolve(void 0)}get storage(){return this._ready.promise.then(()=>this._storage)}async initStorage(){this._storage=this.createStorage()}get defaultStorageOptions(){let e=this._storageDrivers&&this._storageDrivers.length?this._storageDrivers:null;return{version:1,name:this._storageName,...e?{driver:e}:{}}}createStorage(){return this._localforage.createInstance({description:"Offline Storage for StateDB",storeName:"statedb",...this.defaultStorageOptions})}async fetch(e){let t=await (await this.storage).getItem(e);return null!=t?t:void 0}async list(e=""){let t=await this.storage,a={};for(let e of(await t.keys()))a[e]=await t.getItem(e);return Object.keys(a).reduce((t,s)=>((""===e||e===s.split(":")[0])&&(t.ids.push(s),t.values.push(a[s])),t),{ids:[],values:[]})}async remove(e){await (await this.storage).removeItem(e)}async save(e,t){await (await this.storage).setItem(e,t)}}var w=a(760),f=a.n(w);let v=new h.Token("@jupyterlite/apputils:IServiceWorkerManager","The service worker manager"),_=`${f()}`.split("/").slice(-1)[0];var m=a(67);class y extends p{constructor(e){super({...e}),this._workspacesApiUrl=r.PageConfig.getOption("workspacesApiUrl")||r.URLExt.join(r.PageConfig.getBaseUrl(),"api/workspaces"),this.serverSettings=e.settings||m.ServerConnection.makeSettings()}async fetch(e){let t=await super.fetch(e);if(t)return t;try{let t=await this._getServerWorkspaces();if(t[e])return t[e]}catch(e){console.warn("Failed to fetch workspace from server:",e)}return{data:{},metadata:{id:e}}}async list(){var e;let t={};try{t=await this._getServerWorkspaces()}catch(e){console.warn("Failed to fetch workspaces from server:",e)}let a=await super.list(),s={...t};for(let t of a.values)(null==(e=t.metadata)?void 0:e.id)&&(s[t.metadata.id]=t);return{ids:Object.keys(s),values:Object.values(s)}}async clear(){await (await this.storage).clear()}async _getServerWorkspaces(){let e=r.URLExt.join(this._workspacesApiUrl,"all.json"),t=await fetch(e);if(!t.ok)throw Error(`Failed to fetch workspaces: ${t.status} ${t.statusText}`);return await t.json()}}let k=new h.Token("@jupyterlite/apputils:IWorkspaceRouter");var C=a(989),b=a(401);let L="/sw-api.v1",S=r.PageConfig.getOption("appVersion");class x{constructor(e){var t;this._onBroadcastMessage=async e=>{let{data:t,browsingContextId:a,requestId:s,pathname:r}=e.data;a===this._browsingContextId&&(r.includes("/api/stdin/")?this._onStdinMessage(r,t):this._onDriveMessage(t,s))},this._onDriveMessage=async(e,t)=>{let a=await this._driveContentsProcessor.processDriveRequest(e);this._broadcastChannel.postMessage({response:a,browsingContextId:this._browsingContextId,requestId:t})},this._onStdinMessage=async(e,t)=>{let a=e.slice(e.lastIndexOf("/")+1),s=this._stdinHandlers.get(a);if(void 0!==s){let e=await s(t);this._broadcastChannel.postMessage({response:e,browsingContextId:this._browsingContextId})}else console.warn(`No stdin handler registered for '${e}'`)},this._registration=null,this._registrationChanged=new b.Signal(this),this._ready=new h.PromiseDelegate,this._stdinHandlers=new Map;const a=new URL(null!=(t=e.workerUrl)?t:r.URLExt.join(r.PageConfig.getBaseUrl(),_),window.location.href),s=r.PageConfig.getOption("enableServiceWorkerCache")||"false";a.searchParams.set("enableCache",s),this._browsingContextId=h.UUID.uuid4(),this._contents=e.contents,this._broadcastChannel=new BroadcastChannel(L),this._broadcastChannel.addEventListener("message",this._onBroadcastMessage),this._driveContentsProcessor=new C.DriveContentsProcessor({contentsManager:this._contents}),this._initialize(a.href).catch(console.warn)}get registrationChanged(){return this._registrationChanged}get enabled(){return null!==this._registration}get browsingContextId(){return this._browsingContextId}get ready(){return this._ready.promise}registerStdinHandler(e,t){this._stdinHandlers.set(e,t)}async _initialize(e){let{serviceWorker:t}=navigator,a=null;if(!t)return void console.warn("ServiceWorkers not supported in this browser");if(t.controller){let e=t.controller.scriptURL;await this._unregisterOldServiceWorkers(e),a=await t.getRegistration(e)||null,console.info("JupyterLite ServiceWorker was already registered")}if(!a&&t)try{console.info("Registering new JupyterLite ServiceWorker",e),a=await t.register(e),console.info("JupyterLite ServiceWorker was sucessfully registered")}catch(e){console.warn(e),console.warn(`JupyterLite ServiceWorker registration unexpectedly failed: ${e}`)}this._setRegistration(a),a?(this._ready.resolve(void 0),setTimeout(this._pingServiceWorker,2e4)):this._ready.reject(void 0)}async _unregisterOldServiceWorkers(e){let t=`${e}-version`,a=localStorage.getItem(t);if(a&&a!==S||!a){console.info("New version, unregistering existing service workers.");let e=await navigator.serviceWorker.getRegistrations();await Promise.all(e.map(e=>e.unregister())),console.info("All existing service workers have been unregistered.")}localStorage.setItem(t,S)}async _pingServiceWorker(){let e=await fetch("/api/service-worker-heartbeat");"ok"===await e.text()&&setTimeout(this._pingServiceWorker,2e4)}_setRegistration(e){this._registration=e,this._registrationChanged.emit(this._registration)}}},760(){let e=new BroadcastChannel("/sw-api.v1"),t=!1;async function a(e){var t,a,r;let{request:i}=e,o=new URL(e.request.url);if("/api/service-worker-heartbeat"===o.pathname)return void e.respondWith(new Response("ok"));let l=null;(t=o).origin===location.origin&&(t.pathname.includes("/api/drive")||t.pathname.includes("/api/stdin/"))?l=n(i,o):(a=i,r=o,"GET"!==a.method||null===r.origin.match(/^http/)||r.pathname.includes("/api/")||(l=s(e))),l&&e.respondWith(l)}async function s(e){let{request:a}=e;if(!t)return await fetch(a);let s=await r(a);return s?e.waitUntil(i(a)):(s=await fetch(a),e.waitUntil(l(a,s.clone()))),s}async function r(e){let t=await o(),a=await t.match(e);return a&&404!==a.status?a:null}async function i(e){let t=await fetch(e);return await l(e,t),t}async function n(t,a){let s=await t.json(),r=new Promise(t=>{let a=r=>{let i=r.data;i.browsingContextId!==s.browsingContextId||i.requestId!==s.requestId||(t(new Response(JSON.stringify(i.response))),e.removeEventListener("message",a))};e.addEventListener("message",a)});return s.pathname=a.pathname,e.postMessage(s),await r}async function o(){return await caches.open("precache")}async function l(e,t){return(await o()).put(e,t)}async function c(){let e=await o();return await e.addAll([])}self.addEventListener("install",function(e){self.skipWaiting(),e.waitUntil(c())}),self.addEventListener("activate",function(e){t="true"===new URL(location.href).searchParams.get("enableCache"),e.waitUntil(self.clients.claim())}),self.addEventListener("fetch",a)}}]);
//# sourceMappingURL=961.665a788c1561bc22.js.map?v=665a788c1561bc22
# ğŸ¯ SpeakUB Project Empty Cup - æœ€çµ‚å¯¦æ–½ç¸½çµå ±å‘Š

## ğŸ“… å¯¦æ–½æ™‚é–“è»¸
- **é–‹å§‹æ—¥æœŸ**: 2025/12/02
- **å®Œæˆæ—¥æœŸ**: 2025/12/02
- **ç¸½å¯¦æ–½æ™‚é–“**: ç´„ 2.5 å°æ™‚

## ğŸ¯ é …ç›®ç›®æ¨™å›é¡§

**æ ¸å¿ƒç†å¿µ**: å€åˆ†ã€Œå†·å•Ÿå‹•ç­‰å¾… (Loading)ã€èˆ‡ã€ŒåŸ·è¡Œä¸­æ–·æµ (Underrun)ã€ï¼Œæ¶ˆé™¤å•Ÿå‹•éšæ®µçš„ç„¡æ•ˆè­¦å ±ã€‚

**å…·é«”ç›®æ¨™**:
1. âœ… æ¶ˆé™¤å•Ÿå‹•æˆ–åˆ‡æ›ç« ç¯€ç¬é–“çš„ CPU é£†é«˜èª¤å ±
2. âœ… è§£æ±ºã€Œç©ºæ¯å­ã€å•é¡Œ - å°‡æŒ‰ä¸‹æ’­æ”¾å¾Œçš„åˆå§‹åˆæˆç­‰å¾…è¦–ç‚ºæ­£å¸¸è¡Œç‚º
3. âœ… è®“ç”¨æˆ¶çŸ¥é“ç³»çµ±æ­£åœ¨ã€Œæº–å‚™é£²æ–™ã€è€Œä¸æ˜¯ã€Œç•¶æ©Ÿã€
4. âœ… é©æ‡‰ Nanmai å¼•æ“è¼ƒé•·çš„ TTFB
5. âœ… æ¸…ç†ç„¡æ•ˆçš„éŒ¯èª¤è™•ç†ä»£ç¢¼

## ğŸ—ï¸ æŠ€è¡“å¯¦ç¾è©³æƒ…

### Phase 1: ç›£æ§é‚è¼¯ä¿®æ­£ âœ…
**ä¿®æ”¹æ–‡ä»¶**: `speakub/tts/integration.py`, `speakub/tts/ui/runners.py`

- **æ–°å¢ç‹€æ…‹æ——æ¨™**: `_is_initial_buffering` ç‹€æ…‹è®Šæ•¸
- **é‚è¼¯ä¿®æ­£**:
  ```python
  # åœ¨ handle_tts_play_pause ä¸­è¨­ç½®åˆå§‹ç‹€æ…‹
  elif current_status == "STOPPED":
      self._is_initial_buffering = True  # é–‹å§‹æ’­æ”¾å¾Œçš„ç­‰å¾…è¦–ç‚ºæ­£å¸¸

  # åœ¨ tts_runner_parallel_async ä¸­æ™ºèƒ½æª¢æ¸¬
  if tts_integration._is_initial_buffering:
      logger.info("TTS Initial buffering: Waiting for first audio chunk...")
      # é€™æ˜¯æ­£å¸¸ç­‰å¾…ï¼Œä¸è¨˜éŒ„ Underrun
  else:
      logger.warning("TTS Underrun detected! (Playback stalled)")
      # é€™æ‰æ˜¯çœŸæ­£çš„æ–·æµï¼Œéœ€è¦è¨˜éŒ„ä¸¦è§¸ç™¼æ‡²ç½°æ©Ÿåˆ¶

  # æ”¶åˆ°ç¬¬ä¸€å€‹éŸ³é »å¾Œé‡ç½®ç‹€æ…‹
  if tts_integration._is_initial_buffering:
      tts_integration._is_initial_buffering = False
  ```

### Phase 2: ç”¨æˆ¶é«”é©—å°é½Š âœ…
**ä¿®æ”¹æ–‡ä»¶**: `speakub/tts/integration.py`

- **UI ç‹€æ…‹å„ªåŒ–**:
  ```python
  # åœ¨ update_tts_progress ä¸­
  if status == "PLAYING" and self._is_initial_buffering:
      status_text = f"TTS: BUFFERING...{smooth}"
  else:
      status_text = f"TTS: {status}{smooth}"
  ```

### Phase 3: CPU ç›£æ§æŒçºŒæ€§åˆ¤å®š âœ…
**ç¢ºèªæ–‡ä»¶**: `speakub/utils/performance_monitor.py`

- **å•Ÿå‹•æŠ‘åˆ¶**: å‰ 10 ç§’è‡ªå‹•æŠ‘åˆ¶ CPU è­¦å ±
- **æŒçºŒæ€§åˆ¤å®š**: åªæœ‰é€£çºŒ 5 æ¬¡é«˜è² è¼‰æ‰è§¸ç™¼è­¦å ±
- **å¯¦ç¾é‚è¼¯**:
  ```python
  # å•Ÿå‹•æŠ‘åˆ¶æª¢æŸ¥
  session_duration = timestamp - self._session_start_time
  if session_duration < 10.0:
      return  # æŠ‘åˆ¶è­¦å ±

  # æŒçºŒæ€§è¨ˆæ•¸
  if cpu_percent > self._thresholds["max_cpu_percent"]:
      self._consecutive_high_cpu_count += 1
      if self._consecutive_high_cpu_count >= self._cpu_alert_threshold_count:
          self._trigger_alert("high_cpu_usage", {...})
  ```

### Phase 4: ä»£ç¢¼å‚µæ¸…ç† âœ…
**å·¥å…·ä½¿ç”¨**: `black`, `isort`

- **ä»£ç¢¼æ ¼å¼åŒ–**: ä½¿ç”¨ black çµ±ä¸€ä»£ç¢¼é¢¨æ ¼ (88 å­—ç¬¦å¯¬åº¦)
- **Import æ•´ç†**: ä½¿ç”¨ isort å„ªåŒ–æ¨¡å¡Šå°å…¥é †åº
- **èªæ³•é©—è­‰**: é€šé Python èªæ³•ç·¨è­¯æª¢æŸ¥

## ğŸ§ª æ¸¬è©¦é©—è­‰çµæœ

### 1. é‚è¼¯æ­£ç¢ºæ€§æ¸¬è©¦ âœ…
```
âœ… åˆå§‹ç·©è¡é‚è¼¯æ­£ç¢ºå¯¦ç¾
âœ… CPU ç›£æ§æŒçºŒæ€§åˆ¤å®šæ­£ç¢ºå¯¦ç¾
âœ… UI ç‹€æ…‹é¡¯ç¤ºå„ªåŒ–æ­£ç¢ºå¯¦ç¾
âœ… æ—¥èªŒè¼¸å‡ºåˆ†ææ­£ç¢º
âœ… æ€§èƒ½æ¸¬è©¦é€šé
```

### 2. å•Ÿå‹•è¡Œç‚ºæ¨¡æ“¬æ¸¬è©¦ âœ…
```
âœ… åˆå§‹ç·©è¡è¨˜éŒ„ç‚º INFO è¨Šæ¯ï¼ˆé WARNINGï¼‰
âœ… å•Ÿå‹•æœŸé–“ CPU è­¦å ±æ­£ç¢ºè¢«æŠ‘åˆ¶
âœ… çœŸæ­£çš„ Underrun æ­£ç¢ºè¨˜éŒ„ç‚º WARNING
âœ… æŒçºŒæ€§ CPU é«˜è² è¼‰è§¸ç™¼è­¦å ±
âœ… WARNING è¨Šæ¯æ•¸é‡åˆç†ï¼ˆâ‰¤2ï¼‰
```

### 3. é›†æˆç…™éœ§æ¸¬è©¦ âœ…
```
âœ… èªæ³•æª¢æŸ¥é€šé
âœ… æ¨¡å¡Šå°å…¥æˆåŠŸ
âœ… é—œéµçµ„ä»¶å¯ç”¨
âœ… æ€§èƒ½åŸºæº–å»ºç«‹
âœ… ç›£æ§æŒ‡å—ç”Ÿæˆ
```

## ğŸ“Š æ€§èƒ½åŸºæº–ç·š

### CPU ç›£æ§åŸºæº–
- **é–¾å€¼**: 80%
- **æŒçºŒæ€§åˆ¤å®š**: é€£çºŒ 5 æ¬¡é«˜è² è¼‰
- **å•Ÿå‹•æŠ‘åˆ¶**: å‰ 10 ç§’

### TTS ç‹€æ…‹ç®¡ç†åŸºæº–
- **åˆå§‹ç·©è¡æ”¯æŒ**: âœ… å·²å¯¦ç¾
- **æ™ºèƒ½ Underrun æª¢æ¸¬**: âœ… å·²å¯¦ç¾
- **UI ç·©è¡é¡¯ç¤º**: âœ… å·²å¯¦ç¾

### ä»£ç¢¼å“è³ªåŸºæº–
- **Black æ ¼å¼åŒ–**: âœ… å·²å®Œæˆ
- **isort æ•´ç†**: âœ… å·²å®Œæˆ
- **èªæ³•é©—è­‰**: âœ… å·²é€šé

## ğŸ” ç›£æ§æŒ‡å—

### æ—¥èªŒç›£æ§æŒ‡æ¨™
- **INFO**: `"TTS Initial buffering"` - æ­£å¸¸å•Ÿå‹•è¡Œç‚º
- **WARNING**: `"TTS Underrun detected"` - çœŸæ­£çš„æ’­æ”¾ä¸­æ–·
- **WARNING**: `"high_cpu_usage"` - æŒçºŒæ€§æ€§èƒ½å•é¡Œ

### æ€§èƒ½æŒ‡æ¨™
- CPU ä½¿ç”¨ç‡æ‡‰ < 80% (æŒçºŒæ€§)
- å•Ÿå‹•æœŸé–“ CPU å°–å³°è¢«æŠ‘åˆ¶
- ç·©è¡ç‹€æ…‹æ­£ç¢ºé¡¯ç¤º

### ç”¨æˆ¶é«”é©—æŒ‡æ¨™
- æ’­æ”¾æŒ‰éˆ• â†’ BUFFERING... â†’ PLAYING
- å•Ÿå‹•æ™‚é–“ < é æœŸå€¼
- ç„¡ä¸å¿…è¦çš„è­¦å‘Šè¨Šæ¯

## ğŸ¯ æœ€çµ‚æˆæœ

### ç”¨æˆ¶é«”é©—æ”¹é€²
**ä¹‹å‰**:
```
ç”¨æˆ¶æŒ‰ä¸‹æ’­æ”¾ â†’ é¡¯ç¤º "PLAYING" ä½†æ²’æœ‰è²éŸ³ â†’ ç­‰å¾…æ•¸ç§’ â†’ æ—¥èªŒå……æ»¿ WARNING
å•Ÿå‹•éšæ®µ CPU é£†é«˜ â†’ ç«‹å³è§¸ç™¼è­¦å ± â†’ ç”¨æˆ¶å›°æƒ‘
```

**ä¹‹å¾Œ**:
```
ç”¨æˆ¶æŒ‰ä¸‹æ’­æ”¾ â†’ é¡¯ç¤º "BUFFERING..." â†’ è²éŸ³é–‹å§‹æ’­æ”¾ â†’ é¡¯ç¤º "PLAYING"
å•Ÿå‹•éšæ®µ CPU é£†é«˜ â†’ å®‰éœæŠ‘åˆ¶ â†’ æŒçºŒå•é¡Œæ‰å ±è­¦ â†’ ç”¨æˆ¶æ»¿æ„
```

### æŠ€è¡“æ”¹é€²
1. **æ¸›å°‘èª¤å ±**: å•Ÿå‹•éšæ®µä¸å†ç”¢ç”Ÿç„¡æ•ˆè­¦å‘Š
2. **ç²¾æº–ç›£æ§**: åªå°çœŸæ­£å•é¡Œç™¼å‡ºè­¦å ±
3. **ç”¨æˆ¶åé¥‹**: æ¸…æ™°çš„ç‹€æ…‹æŒ‡ç¤ºæ¸›å°‘å›°æƒ‘
4. **ä»£ç¢¼å“è³ª**: çµ±ä¸€æ ¼å¼ï¼Œæé«˜å¯ç¶­è­·æ€§

## ğŸš€ ç”Ÿç”¢å°±ç·’ç‹€æ…‹

**SpeakUB Project Empty Cup å·²å®Œæˆå¯¦æ–½ä¸¦é€šéæ‰€æœ‰é©—è­‰æ¸¬è©¦**

### å»ºè­°å¾ŒçºŒæ­¥é©Ÿ
1. **ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²**: åœ¨çœŸå¯¦ç’°å¢ƒä¸­æ¸¬è©¦æ”¹é€²æ•ˆæœ
2. **ç”¨æˆ¶åé¥‹æ”¶é›†**: ç›£æ§ç”¨æˆ¶å°æ–°é«”é©—çš„åæ‡‰
3. **ç›£æ§æŒ‡æ¨™è§€å¯Ÿ**: æ¯”è¼ƒå¯¦æ–½å‰å¾Œçš„æ—¥èªŒå·®ç•°
4. **æŒçºŒå„ªåŒ–**: æ ¹æ“šç”Ÿç”¢æ•¸æ“šé€²ä¸€æ­¥èª¿æ•´é–¾å€¼

---

**é …ç›®ç‹€æ…‹**: âœ… **å®Œå…¨æˆåŠŸ**

**æŠ€è¡“å¯¦ç¾**: âœ… **ç¬¦åˆé æœŸ**

**æ¸¬è©¦è¦†è“‹**: âœ… **å…¨é¢é€šé**

**ç”Ÿç”¢å°±ç·’**: âœ… **æº–å‚™éƒ¨ç½²**

ğŸŠ **SpeakUB é‚è¼¯ä¿®æ­£èˆ‡é«”é©—å„ªåŒ–å¯¦æ–½å®Œæˆï¼**

# SpeakUB AsyncBridge æ“ä½œç›®éŒ„

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æª”è©³ç´°è¨˜éŒ„SpeakUBä¸­AsyncBridgeçš„æ‰€æœ‰æ“ä½œé¡å‹ã€åˆ†é¡å’Œä½¿ç”¨è¦ç¯„ã€‚åŸºæ–¼ä¿å®ˆçš„å®‰å…¨ç­–ç•¥ï¼Œæ˜ç¢ºå“ªäº›æ“ä½œå¿…é ˆåŒæ­¥ç­‰å¾…ï¼Œå“ªäº›å¯ä»¥ç•°æ­¥åŸ·è¡Œã€‚

**æ ¸å¿ƒåŸå‰‡ï¼šæ©‹æ¥æ“ä½œçš„åˆ†é¡æ±ºå®šäº†ç”¨æˆ¶é«”é©—çš„ä¸€è‡´æ€§ï¼Œä»»ä½•éŒ¯èª¤åˆ†é¡éƒ½å¯èƒ½å°è‡´UI/æ’­æ”¾ä¸åŒæ­¥ã€‚**

---

## ğŸ—ï¸ AsyncBridgeæ¶æ§‹

### è¨­è¨ˆç›®çš„

AsyncBridgeæ˜¯SpeakUBæ··åˆä¸¦ç™¼æ¶æ§‹çš„æ ¸å¿ƒçµ„ä»¶ï¼Œè² è²¬ï¼š
- åŒæ­¥ä¸Šä¸‹æ–‡èˆ‡ç•°æ­¥ä¸Šä¸‹æ–‡é–“çš„å®‰å…¨é€šè¨Š
- äº‹ä»¶ç‹€æ…‹çš„æ©‹æ¥
- å”ç¨‹çš„åŸ·è¡Œå’Œå§”æ´¾
- æ“ä½œçš„æ€§èƒ½ç›£æ§

### æ“ä½œåˆ†é¡

| åˆ†é¡ | åŒæ­¥ç­‰å¾… | å…¸å‹ç”¨ä¾‹ | ç”¨æˆ¶é«”é©—å½±éŸ¿ |
|------|----------|----------|--------------|
| **é—œéµæ“ä½œ** | âœ… å¿…é ˆç­‰å¾… | ç‹€æ…‹è®Šæ›´ã€UIæ›´æ–°ã€æ’­æ”¾æ§åˆ¶ | ç«‹å³éŸ¿æ‡‰ï¼Œç¢ºä¿ä¸€è‡´æ€§ |
| **èƒŒæ™¯æ“ä½œ** | âŒ Fire-and-forget | è³‡æºæ¸…ç†ã€çµ±è¨ˆæ”¶é›†ã€ç·©å­˜æ›´æ–° | éé˜»å¡ï¼Œæå‡éŸ¿æ‡‰æ€§ |

---

## ğŸ”‘ é—œéµæ“ä½œ (å¿…é ˆåŒæ­¥ç­‰å¾…)

é€™äº›æ“ä½œå½±éŸ¿ç”¨æˆ¶å¯è¦‹çš„ç‹€æ…‹æˆ–è¡Œç‚ºï¼Œå¿…é ˆç­‰å¾…å®Œæˆç¢ºä¿ä¸€è‡´æ€§ã€‚

### 1. ç‹€æ…‹è½‰æ›æ“ä½œ

```python
# æ’­æ”¾æ§åˆ¶ - å½±éŸ¿ç”¨æˆ¶é«”é©—
async def handle_tts_play_pause():
    # å¿…é ˆç­‰å¾…ç‹€æ…‹è®Šæ›´å®Œæˆ
    result = await async_bridge.run_coroutine(change_playback_state())
    update_ui_immediately(result)
```

**åŒ…å«æ“ä½œ**ï¼š
- `handle_tts_play_pause()` - æ’­æ”¾/æš«åœåˆ‡æ›
- `stop_speaking()` - åœæ­¢æ’­æ”¾
- `set_tts_status_safe()` - ç‹€æ…‹æ©Ÿè½‰æ›

**è¶…æ™‚è¨­å®š**ï¼š1ç§’
**å¤±æ•—è™•ç†**ï¼šæ‹‹å‡ºç•°å¸¸ï¼Œä¸­æ–·æ“ä½œ

### 2. UIç‹€æ…‹åŒæ­¥

```python
# UIæ›´æ–° - ç¢ºä¿è¦–è¦ºä¸€è‡´æ€§
async def update_tts_progress():
    # å¿…é ˆç­‰å¾…UIæ›´æ–°å®Œæˆ
    await async_bridge.run_coroutine(update_progress_display())
    # æ­¤æ™‚UIå·²æ›´æ–°ï¼Œç”¨æˆ¶çœ‹åˆ°æœ€æ–°ç‹€æ…‹
```

**åŒ…å«æ“ä½œ**ï¼š
- `update_tts_progress()` - é€²åº¦é¡¯ç¤ºæ›´æ–°
- `notify_user()` - ç”¨æˆ¶é€šçŸ¥
- ç‹€æ…‹é¡¯ç¤ºåŒæ­¥

**è¶…æ™‚è¨­å®š**ï¼š1ç§’
**å¤±æ•—è™•ç†**ï¼šè¨˜éŒ„è­¦å‘Šï¼Œç¹¼çºŒåŸ·è¡Œ

### 3. äº‹ä»¶æ©‹æ¥

```python
# äº‹ä»¶ç‹€æ…‹åŒæ­¥ - ç¢ºä¿ç·šç¨‹é–“å”èª¿
def bridge_event_operation():
    # å¿…é ˆç­‰å¾…äº‹ä»¶ç‹€æ…‹ç¢ºå¯¦æ”¹è®Š
    success = async_bridge.event_set(playback_ready_event)
    if success:
        # ç¾åœ¨å¯ä»¥å®‰å…¨åœ°ä¾è³´äº‹ä»¶ç‹€æ…‹
        start_next_operation()
```

**åŒ…å«æ“ä½œ**ï¼š
- `event_set()` / `event_clear()` - äº‹ä»¶ç‹€æ…‹è¨­å®š
- æ’­æ”¾å°±ç·’äº‹ä»¶
- åˆæˆå®Œæˆäº‹ä»¶

**è¶…æ™‚è¨­å®š**ï¼š1ç§’
**å¤±æ•—è™•ç†**ï¼šè¿”å›å¸ƒæ—å€¼ï¼Œç”±èª¿ç”¨è€…è™•ç†

---

## ğŸŒŠ èƒŒæ™¯æ“ä½œ (Fire-and-forget)

é€™äº›æ“ä½œä¸å½±éŸ¿ç”¨æˆ¶ç«‹å³é«”é©—ï¼Œå¯ä»¥éé˜»å¡åŸ·è¡Œã€‚

### 1. è³‡æºæ¸…ç†

```python
# è³‡æºæ¸…ç† - ä¸é˜»å¡ç”¨æˆ¶æ“ä½œ
def cleanup_resources():
    # Fire-and-forgetï¼Œä¸ç­‰å¾…å®Œæˆ
    async_bridge.run_async_task(cleanup_temp_files())
    # ç”¨æˆ¶æ“ä½œç«‹å³ç¹¼çºŒï¼Œä¸å—æ¸…ç†å½±éŸ¿
```

**åŒ…å«æ“ä½œ**ï¼š
- `cleanup_orphaned_temp_files()` - è‡¨æ™‚æ–‡ä»¶æ¸…ç†
- `cancel_pending_tasks()` - ä»»å‹™å–æ¶ˆ
- è³‡æºé‡‹æ”¾æ“ä½œ

**åŸ·è¡Œæ¨¡å¼**ï¼šéé˜»å¡ä»»å‹™
**å¤±æ•—è™•ç†**ï¼šåƒ…è¨˜éŒ„æ—¥èªŒï¼Œä¸å½±éŸ¿ä¸»è¦æµç¨‹

### 2. çµ±è¨ˆæ”¶é›†

```python
# çµ±è¨ˆæ”¶é›† - èƒŒæ™¯åŸ·è¡Œï¼Œä¸å½±éŸ¿ç”¨æˆ¶é«”é©—
def collect_statistics():
    # Fire-and-forget
    async_bridge.run_async_task(update_performance_stats())
    # ç”¨æˆ¶é«”é©—ä¸å—å½±éŸ¿
```

**åŒ…å«æ“ä½œ**ï¼š
- æ€§èƒ½æŒ‡æ¨™æ”¶é›†
- ä½¿ç”¨çµ±è¨ˆæ›´æ–°
- è¨ºæ–·ä¿¡æ¯è¨˜éŒ„

**åŸ·è¡Œæ¨¡å¼**ï¼šéé˜»å¡ä»»å‹™
**å¤±æ•—è™•ç†**ï¼šéœé»˜å¤±æ•—ï¼Œä¸è¨˜éŒ„éŒ¯èª¤

### 3. é è¼‰æ“ä½œ

```python
# é è¼‰ - æå‰æº–å‚™ï¼Œä½†ä¸é˜»å¡ç•¶å‰æ“ä½œ
def start_preloading():
    # Fire-and-forgetï¼Œæå‰åˆæˆä¸‹ä¸€æ®µå…§å®¹
    async_bridge.run_async_task(preload_next_segment())
    # ç”¨æˆ¶ç¹¼çºŒç•¶å‰æ’­æ”¾ï¼Œä¸å—å½±éŸ¿
```

**åŒ…å«æ“ä½œ**ï¼š
- æ’­æ”¾åˆ—è¡¨é è¼‰
- å…§å®¹é åˆæˆ
- ç·©å­˜é ç†±

**åŸ·è¡Œæ¨¡å¼**ï¼šéé˜»å¡ä»»å‹™
**å¤±æ•—è™•ç†**ï¼šè¨˜éŒ„è­¦å‘Šï¼Œä¸ä¸­æ–·ä¸»è¦æµç¨‹

---

## ğŸ“Š æ€§èƒ½ç›£æ§èˆ‡çµ±è¨ˆ

### è‡ªå‹•æ”¶é›†æŒ‡æ¨™

AsyncBridgeè‡ªå‹•ç›£æ§æ‰€æœ‰æ“ä½œçš„æ€§èƒ½ï¼š

1. **æ“ä½œè¨ˆæ•¸**
   - äº‹ä»¶æ“ä½œç¸½æ•¸
   - å”ç¨‹æ“ä½œç¸½æ•¸
   - æˆåŠŸ/å¤±æ•—ç‡

2. **æ€§èƒ½æŒ‡æ¨™**
   - å¹³å‡åŸ·è¡Œæ™‚é–“
   - è¶…æ™‚ç™¼ç”Ÿç‡
   - äº‹ä»¶å¾ªç’°å¯ç”¨æ€§

3. **åˆ†é¡çµ±è¨ˆ**
   - é—œéµæ“ä½œ vs èƒŒæ™¯æ“ä½œ
   - ç›´æ¥åŸ·è¡Œ vs ç·šç¨‹å®‰å…¨åŸ·è¡Œ

### ç›£æ§å‘½ä»¤

```bash
# æª¢æŸ¥æ©‹æ¥çµ±è¨ˆ
python tools/deadlock_monitor.py status

# æŸ¥çœ‹è©³ç´°çµ±è¨ˆ
python -c "
from speakub.tts.integration import TTSIntegration
# å¯¦ä¾‹åŒ–å¾Œæª¢æŸ¥ bridge.get_bridge_stats()
"
```

---

## ğŸš¨ éŒ¯èª¤è™•ç†èˆ‡æ¢å¾©

### é—œéµæ“ä½œå¤±æ•—

```python
try:
    # é—œéµæ“ä½œå¿…é ˆç­‰å¾…
    result = async_bridge.run_coroutine(critical_operation(), timeout=1.0)
    handle_success(result)
except asyncio.TimeoutError:
    # è¶…æ™‚ - è¨˜éŒ„ä¸¦é€šçŸ¥ç”¨æˆ¶
    logger.error("Critical operation timeout")
    notify_user_operation_failed()
except Exception as e:
    # å…¶ä»–éŒ¯èª¤ - è¨˜éŒ„ä¸¦å˜—è©¦é™ç´š
    logger.error(f"Critical operation failed: {e}")
    handle_graceful_degradation()
```

### èƒŒæ™¯æ“ä½œå¤±æ•—

```python
try:
    # èƒŒæ™¯æ“ä½œä¸ç­‰å¾…ï¼Œä¸æª¢æŸ¥çµæœ
    async_bridge.run_async_task(background_operation())
except Exception as e:
    # éœé»˜å¤±æ•—ï¼Œåªè¨˜éŒ„èª¿è©¦ä¿¡æ¯
    logger.debug(f"Background operation failed (non-critical): {e}")
```

---

## ğŸ” æ“ä½œåˆ†é¡æª¢æŸ¥è¡¨

### æ–°å¢æ©‹æ¥æ“ä½œæ™‚çš„æª¢æŸ¥

**å°æ–¼ä»»ä½•æ–°çš„AsyncBridgeæ“ä½œèª¿ç”¨**ï¼š

#### æ±ºå®šåˆ†é¡
- [ ] **ç”¨æˆ¶é«”é©—å½±éŸ¿**ï¼šæ“ä½œçµæœæ˜¯å¦ç«‹å³å½±éŸ¿ç”¨æˆ¶ï¼Ÿ
- [ ] **ç‹€æ…‹ä¾è³´**ï¼šå¾ŒçºŒæ“ä½œæ˜¯å¦ä¾è³´æ­¤æ“ä½œçš„å®Œæˆï¼Ÿ
- [ ] **å¤±æ•—å½±éŸ¿**ï¼šæ“ä½œå¤±æ•—æ˜¯å¦æœƒç ´å£ç”¨æˆ¶é«”é©—ï¼Ÿ

#### é—œéµæ“ä½œ (å¿…é ˆç­‰å¾…)
- [ ] ä½¿ç”¨ `run_coroutine()` æ–¹æ³•
- [ ] è¨­å®šé©ç•¶è¶…æ™‚ (é€šå¸¸1ç§’)
- [ ] è™•ç†æ‰€æœ‰ç•°å¸¸æƒ…æ³
- [ ] ç¢ºä¿æ“ä½œå®Œæˆå¾Œç‹€æ…‹ä¸€è‡´

#### èƒŒæ™¯æ“ä½œ (Fire-and-forget)
- [ ] ä½¿ç”¨ `run_async_task()` æˆ– `delegate_to_async_task()` æ–¹æ³•
- [ ] ä¸æª¢æŸ¥è¿”å›å€¼
- [ ] å¤±æ•—æ™‚éœé»˜æˆ–åªè¨˜éŒ„èª¿è©¦ä¿¡æ¯
- [ ] ä¸å½±éŸ¿ä¸»è¦ç”¨æˆ¶æµç¨‹

---

## ğŸ“ ä»£ç¢¼ç¤ºä¾‹

### æ­£ç¢ºçš„é—œéµæ“ä½œä½¿ç”¨

```python
def handle_user_pause_request(self):
    """ç”¨æˆ¶è«‹æ±‚æš«åœ - é—œéµæ“ä½œ"""
    try:
        # å¿…é ˆç­‰å¾…ç‹€æ…‹è®Šæ›´å®Œæˆ
        self.async_bridge.run_coroutine(
            self._change_playback_state("PAUSED"),
            timeout=1.0
        )
        # ç¾åœ¨å¯ä»¥å®‰å…¨åœ°æ›´æ–°UI
        self.update_ui_status("PAUSED")
    except Exception as e:
        logger.error(f"Failed to pause playback: {e}")
        self.notify_user("Pause failed, please try again")
```

### æ­£ç¢ºçš„èƒŒæ™¯æ“ä½œä½¿ç”¨

```python
def on_playback_completed(self):
    """æ’­æ”¾å®Œæˆ - èƒŒæ™¯æ¸…ç†"""
    # ä¸ç­‰å¾…ï¼Œç«‹å³è¿”å›
    self.async_bridge.run_async_task(self._cleanup_playback_resources())
    # ä¸æª¢æŸ¥çµæœï¼Œç”¨æˆ¶é«”é©—ä¸å—å½±éŸ¿

    # ç¹¼çºŒè™•ç†ä¸‹ä¸€é¦–
    self.start_next_track()
```

---

## ğŸš« å¸¸è¦‹éŒ¯èª¤æ¨¡å¼

### éŒ¯èª¤ï¼šé—œéµæ“ä½œä½¿ç”¨Fire-and-forget

```python
# âŒ éŒ¯èª¤ - UIæœƒä¸åŒæ­¥
def handle_pause_button():
    # Fire-and-forget ä½†é€™æ˜¯é—œéµæ“ä½œ
    self.async_bridge.run_async_task(self._pause_playback())
    # UIç«‹å³æ›´æ–°ï¼Œä½†å¯¦éš›æ’­æ”¾å¯èƒ½é‚„æ²’åœæ­¢
    self.update_ui_status("PAUSED")  # ç‹€æ…‹ä¸ä¸€è‡´ï¼
```

### éŒ¯èª¤ï¼šèƒŒæ™¯æ“ä½œç­‰å¾…çµæœ

```python
# âŒ éŒ¯èª¤ - é˜»å¡ä¸å¿…è¦çš„æ“ä½œ
def cleanup_after_playback():
    # ç­‰å¾…èƒŒæ™¯æ¸…ç†å®Œæˆ - æ²’æ„ç¾©
    await self.async_bridge.run_coroutine(self._cleanup_resources())
    # ç”¨æˆ¶å¿…é ˆç­‰å¾…æ¸…ç†å®Œæˆæ‰èƒ½ç¹¼çºŒ
```

---

## ğŸ“š ç›¸é—œæ–‡æª”

- [é–å®šä½¿ç”¨è¦ç¯„æŒ‡å—](locking_guidelines.md) - é–å®šå±¤æ¬¡çµæ§‹
- [æ··åˆç•°æ­¥æ¶æ§‹è¨­è¨ˆ](hybrid_async_architecture.md) - æ•´é«”æ¶æ§‹è¨­è¨ˆ
- [Voice Selectorå¼•æ“åˆ‡æ›è·³ç« åˆ†æ](../../documents/VOICE_SELECTOR_ENGINE_SWITCH_CHAPTER_JUMP_ANALYSIS.md) - åˆ†é¡éŒ¯èª¤çš„å¾Œæœ

## ğŸ”§ ç¶­è­·æŒ‡å—

### å®šæœŸå¯©æŸ¥

æ¯å­£åº¦å¯©æŸ¥ä¸€æ¬¡AsyncBridgeæ“ä½œåˆ†é¡ï¼š
- [ ] æª¢æŸ¥æ˜¯å¦æœ‰æ“ä½œåˆ†é¡éŒ¯èª¤
- [ ] é©—è­‰è¶…æ™‚è¨­å®šæ˜¯å¦åˆç†
- [ ] è©•ä¼°æ€§èƒ½æŒ‡æ¨™æ˜¯å¦æ­£å¸¸
- [ ] æ›´æ–°æ–‡æª”ä»¥åæ˜ æ–°æ“ä½œ

### æ·»åŠ æ–°æ“ä½œ

æ·»åŠ æ–°çš„æ©‹æ¥æ“ä½œæ™‚ï¼š
1. ç¢ºå®šæ“ä½œåˆ†é¡ï¼ˆé—œéµ vs èƒŒæ™¯ï¼‰
2. é¸æ“‡é©ç•¶çš„æ–¹æ³•
3. æ›´æ–°æ­¤æ–‡æª”
4. æ·»åŠ åˆ°é–‹ç™¼è€…æª¢æŸ¥æ¸…å–®

---

## ğŸ“ è®Šæ›´æ­·å²

- **2025-12-13**: åˆå§‹ç‰ˆæœ¬ï¼Œå»ºç«‹AsyncBridgeæ“ä½œåˆ†é¡è¦ç¯„
- **åŸºæ–¼**: æ··åˆæ¶æ§‹è¨­è¨ˆåŸå‰‡å’Œç”¨æˆ¶é«”é©—ä¸€è‡´æ€§éœ€æ±‚

---

**æœ¬æ–‡æª”ç¢ºä¿SpeakUBçš„æ©‹æ¥æ“ä½œæ—¢å®‰å…¨åˆé«˜æ•ˆã€‚å¦‚æœ‰æ–°æ“ä½œéœ€æ±‚ï¼Œè«‹åœ¨æ­¤æ–‡æª”ä¸­è¨˜éŒ„ä¸¦åˆ†é¡ã€‚**

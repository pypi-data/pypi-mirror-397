syntax = "proto3";

package pentest;

// Enums
enum Scope {
  SCOPE_UNSPECIFIED = 0;
  HOLISTIC = 1;
  TARGETED = 2;
}

enum Type {
  TYPE_UNSPECIFIED = 0;
  BLACK_BOX = 1;
  WHITE_BOX = 2;
}

enum Style {
  STYLE_UNSPECIFIED = 0;
  AGGRESSIVE = 1;
  SAFE = 2;
}

enum Status {
  STATUS_UNSPECIFIED = 0;
  PENDING = 1;
  IN_PROGRESS = 2;
  COMPLETED = 3;
  FAILED = 4;
}

enum Phase {
  PHASE_UNSPECIFIED = 0;
  RECON = 1;
  INITIAL_EXPLOIT = 2;
  DEEP_EXPLOIT = 3;
  LATERAL_MOVEMENT = 4;
  REPORT = 5;
  FINISHED = 6;
  GUIDED = 7;  // For user-guided pentests
}

enum Mode {
  MODE_UNSPECIFIED = 0;
  MODE_AUTONOMOUS = 1;  // Fully automated: Recon -> Exploit -> Analysis -> Report
  MODE_GUIDED = 2;      // User-driven: User instructs AI step by step
}

enum Severity {
  SEVERITY_UNSPECIFIED = 0;
  NONE = 1;
  LOW = 2;
  MEDIUM = 3;
  HIGH = 4;
  CRITICAL = 5;
}

enum UpdateType {
  UPDATE_TYPE_UNSPECIFIED = 0;
  INFO = 1;
  ERROR = 2;
  STATUS = 3;
  DEBUG = 4;
}

// Context injection priority levels
enum ContextPriority {
  CONTEXT_PRIORITY_UNSPECIFIED = 0;
  CONTEXT_PRIORITY_NORMAL = 1;      // Incorporate when convenient (next step)
  CONTEXT_PRIORITY_HIGH = 2;        // Prioritize in next LLM call
  CONTEXT_PRIORITY_IMMEDIATE = 3;   // Interrupt current phase if possible
}

// Request messages sent by client
message ClientRequest {
  oneof request_type {
    GetPentestRequest get_pentest = 1;
    SchedulePentestRequest schedule_pentest = 2;
    SubscribePentestRequest subscribe_pentest = 3;
    PingRequest ping = 4;
    // Custom task requests
    SubmitCustomTaskRequest submit_custom_task = 5;
    CloseCustomTaskRequest close_custom_task = 6;
    GetCustomTaskRequest get_custom_task = 7;
    ListCustomTasksRequest list_custom_tasks = 8;
    SubscribeCustomTaskRequest subscribe_custom_task = 9;
    // Context injection request
    InjectContextRequest inject_context = 10;
  }
}

// Subscribe to an existing/running pentest stream
message SubscribePentestRequest {
  string pentest_id = 1;
  bool include_history = 2;  // If true, replay historical events from memory
}

// Ping request for keepalive
message PingRequest {}

// Response messages sent by server
message ServerResponse {
  oneof response_type {
    PentestData pentest_data = 1;
    ScheduleResponse schedule_response = 2;
    StatusUpdate status_update = 3;
    ErrorResponse error = 5;
    SubscribeResponse subscribe_response = 6;
    PongResponse pong = 7;
    // Custom task responses
    CustomTaskResponse custom_task_response = 8;
    CloseCustomTaskResponse close_custom_task_response = 9;
    CustomTaskData custom_task_data = 10;
    CustomTaskListResponse custom_task_list = 11;
    SubscribeCustomTaskResponse subscribe_custom_task_response = 12;
    // Context injection response
    ContextAcknowledgement context_ack = 13;
  }
}

// Subscribe response
message SubscribeResponse {
  string pentest_id = 1;
  string message = 2;
  bool is_running = 3;  // True if pentest is still running
}

// Pong response for keepalive
message PongResponse {
  string message = 1;
}

// Get pentest by ID
message GetPentestRequest {
  string pentest_id = 1;
}

// Schedule a new pentest
message SchedulePentestRequest {
  optional string id = 1;
  Style style = 2;
  bool exploit = 3;
  repeated TargetRequest targets = 4;
}

message TargetRequest {
  optional string id = 1;
  string target = 2;
  Scope scope = 3;
  Type type = 4;
  optional string credentials = 5;
}

// Schedule response
message ScheduleResponse {
  string pentest_id = 1;
  string message = 2;
}

// Pentest data (full pentest object)
message PentestData {
  string id = 1;
  Status status = 2;
  optional string created_at = 3;
  optional string started_at = 4;
  optional string finished_at = 5;
  Style style = 6;
  bool exploit = 7;
  optional string summary = 8;
  repeated TargetData targets = 9;
  optional Severity severity = 10;
  optional int32 findings = 11;
  optional Mode mode = 12;           // AUTONOMOUS or GUIDED
  optional string description = 13;  // For guided pentests: user's task description
}

message TargetData {
  string id = 1;
  string pentest_id = 2;
  string target = 3;
  Scope scope = 4;
  Type type = 5;
  Status status = 6;
  optional Phase phase = 7;
  optional string created_at = 8;
  optional string started_at = 9;
  optional string finished_at = 10;
  optional string credentials = 11;
  optional Severity severity = 12;
  optional int32 findings = 13;
  optional string summary = 14;
}

// Status update (broadcasted when pentest/target status changes)
message StatusUpdate {
  UpdateType type = 1;
  string pentest_id = 2;
  optional string message = 3;
  optional PentestData data = 4;
  optional bool task_complete = 5;  // True when the current task is finished (for guided pentests)
}

// Error response
message ErrorResponse {
  string error = 1;
  string details = 2;
}

// ============================================
// Custom Task Messages
// ============================================

// Custom task target specification
message CustomTaskTarget {
  string description = 1;        // What to do (e.g., "port scan")
  string target = 2;             // Target (e.g., "192.168.1.1")
  repeated string parameters = 3; // Additional parameters
}

// Submit a custom task
message SubmitCustomTaskRequest {
  string task_id = 1;            // Optional: reuse existing task session
  CustomTaskTarget task = 2;     // Task details
}

// Custom task response
message CustomTaskResponse {
  string task_id = 1;
  string message = 2;
}

// Close a custom task session
message CloseCustomTaskRequest {
  string task_id = 1;
}

message CloseCustomTaskResponse {
  string task_id = 1;
  string message = 2;
}

// Get custom task by ID
message GetCustomTaskRequest {
  string task_id = 1;
}

// List custom tasks with pagination
message ListCustomTasksRequest {
  int32 page = 1;
  int32 page_size = 2;
}

// Custom task session data (mirrors PentestData structure)
message CustomTaskData {
  string id = 1;
  Status status = 2;             // PENDING, IN_PROGRESS, COMPLETED, FAILED
  string target = 3;             // Target being tested
  string description = 4;        // What the user wants to do
  optional string created_at = 5;
  optional string started_at = 6;
  optional string finished_at = 7;
  int32 request_count = 8;       // Number of requests in this session
  optional string summary = 9;
  optional Severity severity = 10;
  optional int32 findings = 11;
}

// Custom task list response
message CustomTaskListResponse {
  repeated CustomTaskData tasks = 1;
  int32 total = 2;
  int32 page = 3;
  int32 page_size = 4;
}

// Subscribe to a custom task stream (for late-join)
message SubscribeCustomTaskRequest {
  string task_id = 1;
  bool include_history = 2;      // Replay historical events
}

// Subscribe response for custom task
message SubscribeCustomTaskResponse {
  string task_id = 1;
  bool is_running = 2;
  string message = 3;
}

// ============================================
// Context Injection Messages
// ============================================

// Request to inject context/hints into a running pentest
message InjectContextRequest {
  string pentest_id = 1;           // ID of the pentest to inject context into
  string context = 2;              // Free-form context text from user (max 2000 chars)
  optional string target_id = 3;   // Optional: target-specific context
  ContextPriority priority = 4;    // How urgently to incorporate
}

// Acknowledgement of context injection
message ContextAcknowledgement {
  string pentest_id = 1;           // ID of the pentest
  string message = 2;              // Human-readable status message
  bool accepted = 3;               // Whether context was accepted
  optional string context_id = 4;  // Unique ID for tracking this context
}

// ============================================
// Service Definition
// ============================================

// Bidirectional streaming service
service PentestService {
  rpc PentestStream(stream ClientRequest) returns (stream ServerResponse);
}

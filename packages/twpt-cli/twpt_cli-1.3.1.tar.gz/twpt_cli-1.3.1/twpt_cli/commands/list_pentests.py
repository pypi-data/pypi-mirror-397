"""List pentests command for ThreatWinds Pentest CLI."""

import sys
from typing import Optional

import click
from rich.console import Console
from rich.table import Table

from twpt_cli.config import load_credentials, get_api_endpoint
from twpt_cli.sdk import HTTPClient

console = Console()


@click.command()
@click.option(
    '--page',
    type=int,
    default=1,
    help='Page number (default: 1)'
)
@click.option(
    '--page-size',
    type=int,
    default=5,
    help='Number of pentests to show (default: 5 - shows latest 5 pentests)'
)
@click.option(
    '--all',
    is_flag=True,
    help='Show all pentests (sets page size to 100)'
)
def list_pentests(page: int, page_size: int, all: bool):
    """List recent penetration tests.

    By default, shows the latest 5 pentests.
    Use --all to show more results or --page-size to customize.

    Examples:
        twpt-cli list-pentests              # Show latest 5 pentests
        twpt-cli list-pentests --all        # Show all pentests (up to 100)
        twpt-cli list-pentests --page-size 10  # Show 10 pentests
        twpt-cli list-pentests --page 2     # Show page 2 of results
    """
    # Load credentials
    creds = load_credentials()
    if not creds:
        console.print("✗ Not configured. Please run: twpt-cli configure", style="red")
        sys.exit(1)

    # Adjust page size if --all flag is used
    if all:
        page_size = 100

    # Get pentests from API
    try:
        client = HTTPClient(get_api_endpoint(), creds)
        response = client.list_pentests(page=page, page_size=page_size)

        # Display header
        console.print("\n╔══════════════════════════════════════════════╗", style="cyan")
        console.print("║              Recent Pentests                  ║", style="cyan")
        console.print("╚══════════════════════════════════════════════╝\n", style="cyan")

        if not response.pentests:
            console.print("[yellow]No pentests found[/yellow]")
            return

        # Create table
        table = Table(show_header=True, header_style="bold cyan")
        table.add_column("ID", style="white")
        table.add_column("Mode", style="magenta")
        table.add_column("Status", style="yellow")
        table.add_column("Targets", style="white", max_width=25)
        table.add_column("Findings", style="cyan")
        table.add_column("Severity", style="magenta")
        table.add_column("Created", style="dim")

        # Add rows
        for pentest in response.pentests:
            # Format status with color
            status_color = {
                "PENDING": "yellow",
                "IN_PROGRESS": "blue",
                "COMPLETED": "green",
                "FAILED": "red"
            }.get(pentest.status, "white")
            status = f"[{status_color}]{pentest.status}[/{status_color}]"

            # Format severity with color
            severity_color = {
                "CRITICAL": "red",
                "HIGH": "bright_red",
                "MEDIUM": "yellow",
                "LOW": "blue",
                "NONE": "dim"
            }.get(pentest.severity, "white")
            severity = f"[{severity_color}]{pentest.severity}[/{severity_color}]"

            # Format targets - show target names (up to 20 chars)
            if pentest.targets and len(pentest.targets) > 0:
                target_names = [t.target for t in pentest.targets]
                if len(target_names) == 1:
                    # Single target: show name up to 20 chars
                    target_display = target_names[0][:20]
                else:
                    # Multiple targets: show count and first target
                    target_display = f"{len(target_names)} ({target_names[0][:15]}...)"
            else:
                target_display = "0 targets"

            # Format date
            created = pentest.created_at.strftime("%Y-%m-%d %H:%M") if pentest.created_at else "N/A"

            # Format mode with color
            mode = pentest.mode if pentest.mode else "AUTONOMOUS"
            mode_color = "cyan" if mode == "GUIDED" else "dim"
            mode_display = f"[{mode_color}]{mode}[/{mode_color}]"

            table.add_row(
                pentest.id,  # Show full ID
                mode_display,
                status,
                target_display,
                str(pentest.findings),
                severity,
                created
            )

        console.print(table)

        # Show pagination info
        if response.total_pages > 1:
            console.print(
                f"\n[dim]Page {response.page} of {response.total_pages} "
                f"(Total: {response.total} pentests)[/dim]"
            )
            if response.page < response.total_pages:
                console.print("[dim]Use --page to view other pages[/dim]")

        # Show command to get details
        console.print("\n[dim]Use 'twpt-cli get-pentest <id>' to view pentest details[/dim]")

    except Exception as e:
        console.print(f"\n✗ Failed to list pentests: {e}", style="red")
        sys.exit(1)
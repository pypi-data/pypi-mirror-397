"""Get pentest command for ThreatWinds Pentest CLI."""

import sys
from datetime import datetime
from typing import Optional

import click
from rich.console import Console
from rich.table import Table
from rich.panel import Panel

from twpt_cli.config import load_credentials, get_api_endpoint
from twpt_cli.sdk import HTTPClient, HTTPPentestData

console = Console()


@click.command()
@click.argument('pentest_id')
def get_pentest(pentest_id: str):
    """Get details of a specific pentest by ID.

    PENTEST_ID: The unique identifier of the pentest to retrieve (e.g., swift-falcon-strikes).

    Example:
        twpt-cli get-pentest swift-falcon-strikes
    """
    # Load credentials
    creds = load_credentials()
    if not creds:
        console.print("✗ Not configured. Please run: twpt-cli configure", style="red")
        sys.exit(1)

    # Fetch pentest details
    try:
        client = HTTPClient(get_api_endpoint(), creds)
        pentest = client.get_pentest(pentest_id)

        # Display pentest details
        display_pentest_details(pentest)

    except Exception as e:
        console.print(f"✗ Failed to get pentest: {e}", style="red")
        sys.exit(1)


def display_pentest_details(pentest: HTTPPentestData):
    """Display detailed pentest information.

    Args:
        pentest: Pentest data object
    """
    # Header
    console.print("\n╔══════════════════════════════════════════════╗", style="cyan")
    console.print("║             Pentest Details                  ║", style="cyan")
    console.print("╚══════════════════════════════════════════════╝\n", style="cyan")

    # Basic information
    status_color = get_status_color(pentest.status)
    severity_color = get_severity_color(pentest.severity)

    info_lines = [
        f"[bold]ID:[/bold] {pentest.id}",
        f"[bold]Status:[/bold] [{status_color}]{pentest.status}[/{status_color}]",
        f"[bold]Style:[/bold] {pentest.style}",
        f"[bold]Exploit:[/bold] {'Enabled' if pentest.exploit else 'Disabled'}",
        f"[bold]Severity:[/bold] [{severity_color}]{pentest.severity}[/{severity_color}]",
        f"[bold]Findings:[/bold] {pentest.findings}",
    ]

    # Add timestamps if available
    if pentest.created_at:
        info_lines.append(f"[bold]Created:[/bold] {format_timestamp(pentest.created_at)}")
    if pentest.started_at:
        info_lines.append(f"[bold]Started:[/bold] {format_timestamp(pentest.started_at)}")
    if pentest.finished_at:
        info_lines.append(f"[bold]Finished:[/bold] {format_timestamp(pentest.finished_at)}")

        # Calculate duration
        if pentest.started_at:
            duration = calculate_duration(pentest.started_at, pentest.finished_at)
            info_lines.append(f"[bold]Duration:[/bold] {duration}")

    # Display basic info panel
    panel = Panel("\n".join(info_lines), title="Pentest Information", border_style="blue")
    console.print(panel)

    # Display targets table if available
    if pentest.targets:
        console.print("\n")
        display_targets_table(pentest.targets)


def display_targets_table(targets):
    """Display targets in a formatted table.

    Args:
        targets: List of target data objects
    """
    table = Table(title="Target Details", show_header=True, header_style="bold cyan")
    table.add_column("Target", style="white", no_wrap=True)
    table.add_column("Scope", style="yellow")
    table.add_column("Type", style="green")
    table.add_column("Status", style="white")
    table.add_column("Phase", style="cyan")
    table.add_column("Severity", style="white")
    table.add_column("Findings", style="magenta", justify="right")

    for target in targets:
        status_color = get_status_color(target.status)
        severity_color = get_severity_color(target.severity)

        table.add_row(
            target.target,
            target.scope,
            target.type,
            f"[{status_color}]{target.status}[/{status_color}]",
            target.phase or "N/A",
            f"[{severity_color}]{target.severity}[/{severity_color}]",
            str(target.findings)
        )

    console.print(table)


def get_status_color(status: str) -> str:
    """Get color for status display.

    Args:
        status: Status string

    Returns:
        Color name for rich console
    """
    status_colors = {
        "PENDING": "yellow",
        "IN_PROGRESS": "cyan",
        "COMPLETED": "green",
        "FAILED": "red",
    }
    return status_colors.get(status, "white")


def get_severity_color(severity: str) -> str:
    """Get color for severity display.

    Args:
        severity: Severity string

    Returns:
        Color name for rich console
    """
    severity_colors = {
        "NONE": "dim",
        "LOW": "blue",
        "MEDIUM": "yellow",
        "HIGH": "orange1",
        "CRITICAL": "red",
    }
    return severity_colors.get(severity, "white")


def format_timestamp(timestamp) -> str:
    """Format timestamp for display.

    Args:
        timestamp: Datetime object or string

    Returns:
        Formatted timestamp string
    """
    if isinstance(timestamp, str):
        try:
            # Parse ISO format
            dt = datetime.fromisoformat(timestamp.replace('Z', '+00:00'))
        except:
            return timestamp
    elif isinstance(timestamp, datetime):
        dt = timestamp
    else:
        return str(timestamp)

    return dt.strftime("%Y-%m-%d %H:%M:%S UTC")


def calculate_duration(start, end) -> str:
    """Calculate duration between two timestamps.

    Args:
        start: Start timestamp
        end: End timestamp

    Returns:
        Human-readable duration string
    """
    try:
        if isinstance(start, str):
            start_dt = datetime.fromisoformat(start.replace('Z', '+00:00'))
        else:
            start_dt = start

        if isinstance(end, str):
            end_dt = datetime.fromisoformat(end.replace('Z', '+00:00'))
        else:
            end_dt = end

        duration = end_dt - start_dt
        hours, remainder = divmod(duration.total_seconds(), 3600)
        minutes, seconds = divmod(remainder, 60)

        if hours > 0:
            return f"{int(hours)}h {int(minutes)}m {int(seconds)}s"
        elif minutes > 0:
            return f"{int(minutes)}m {int(seconds)}s"
        else:
            return f"{int(seconds)}s"

    except:
        return "N/A"